This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.firebaserc
.gitignore
.npmrc
.prettierignore
.prettierrc
eslint.config.js
firebase.json
firestore.indexes.json
firestore.rules
functions/.eslintrc.js
functions/.gitignore
functions/package.json
functions/src/index.ts
functions/src/telegramBot.ts
functions/tsconfig.dev.json
functions/tsconfig.json
package.json
postcss.config.cjs
README.md
src/app.css
src/app.d.ts
src/app.html
src/hooks.client.ts
src/hooks.server.ts
src/lib/client/artifacts.ts
src/lib/client/audioManager.ts
src/lib/client/mapLogic.ts
src/lib/client/soundGenerator.ts
src/lib/components/AvatarEditor.svelte
src/lib/components/casino/ArtifactSynthesis.svelte
src/lib/components/casino/GlitchOverlay.svelte
src/lib/components/ChatWidget.svelte
src/lib/components/CinematicLoader.svelte
src/lib/components/CookieBanner.svelte
src/lib/components/CyberTurnstile.svelte
src/lib/components/Footer.svelte
src/lib/components/Modal.svelte
src/lib/components/Navbar.svelte
src/lib/components/NeonButton.svelte
src/lib/components/SettingsModal.svelte
src/lib/components/Snowfall.svelte
src/lib/components/SplashModal.svelte
src/lib/components/WatermelonInteractive.svelte
src/lib/firebase.ts
src/lib/i18n/index.ts
src/lib/i18n/locales/en.json
src/lib/i18n/locales/ru.json
src/lib/index.ts
src/lib/seasonal/seasonalContent.ts
src/lib/server/firebase.admin.ts
src/lib/stores.ts
src/lib/stores/modalStore.ts
src/lib/stores/settingsStore.ts
src/lib/stores/usernameCache.ts
src/lib/transitions.ts
src/lib/transitions/index.ts
src/lib/utils/markdown.ts
src/routes/+error.svelte
src/routes/+layout.server.ts
src/routes/+layout.svelte
src/routes/+page.svelte
src/routes/about/+page.svelte
src/routes/about/+page.ts
src/routes/admin/+layout.server.ts
src/routes/admin/+layout.svelte
src/routes/admin/+page.server.ts
src/routes/admin/+page.svelte
src/routes/admin/news/+page.server.ts
src/routes/admin/news/+page.svelte
src/routes/admin/tracker/+page.server.ts
src/routes/admin/tracker/+page.svelte
src/routes/admin/users/+page.server.ts
src/routes/admin/users/+page.svelte
src/routes/ai-policy/+page.svelte
src/routes/api/auth/+server.ts
src/routes/app-privacy/+page.svelte
src/routes/app-terms/+page.svelte
src/routes/banned/+page.server.ts
src/routes/banned/+page.svelte
src/routes/casino/+page.svelte
src/routes/casino/coin-flip/+page.svelte
src/routes/casino/crash/+page.svelte
src/routes/casino/inventory/+page.server.ts
src/routes/casino/inventory/+page.svelte
src/routes/casino/shop/+page.server.ts
src/routes/casino/shop/+page.svelte
src/routes/casino/slot-machine/+page.svelte
src/routes/login/+page.svelte
src/routes/mobile-beta/+page.svelte
src/routes/news/+page.server.ts
src/routes/news/+page.svelte
src/routes/privacy-policy/+page.svelte
src/routes/profile/[username]/+page.server.ts
src/routes/profile/[username]/+page.svelte
src/routes/profile/edit/+page.server.ts
src/routes/profile/edit/+page.svelte
src/routes/register/+page.svelte
src/routes/reset-password/+page.svelte
src/routes/settings/security/+page.server.ts
src/routes/settings/security/+page.svelte
src/routes/terms-of-service/+page.svelte
src/routes/u/[uid]/+page.server.ts
src/routes/u/[uid]/+page.svelte
src/routes/verify-email/+page.svelte
src/styles/cosmetics.css
src/styles/halloween.css
src/styles/newyear.css
src/styles/profile-skins.css
src/styles/winter.css
static/casino/crash.png
static/casino/eye.gif
static/casino/glitch-6.svg
static/casino/heart.svg
static/casino/OaR.png
static/casino/orel.png
static/casino/orioncasino.png
static/casino/paw.svg
static/casino/protomap_logo.svg
static/casino/ram.svg
static/casino/reshka.png
static/casino/slots.png
static/favicon.png
static/halloween/bats.svg
static/halloween/candy1.svg
static/halloween/candy2.svg
static/halloween/ghost.svg
static/halloween/heart.svg
static/halloween/pumpkin.svg
static/halloween/spider.svg
static/halloween/web.svg
static/images/modmail_1.png
static/images/modmail_2.png
static/images/modmail_3.png
static/logo.svg
static/preview.png
static/protogen_pin_map.svg
static/protogen_pin.svg
static/sounds/alarm.mp3
static/sounds/ambient_casino.mp3
static/sounds/card_drop.mp3
static/sounds/click_for_other_buttons.mp3
static/sounds/click.mp3
static/sounds/coin_flip.mp3
static/sounds/coin_lose.mp3
static/sounds/coin_win.mp3
static/sounds/cursed_drop.mp3
static/sounds/equip.mp3
static/sounds/error.mp3
static/sounds/fail.mp3
static/sounds/glitch_jackpot.mp3
static/sounds/horror_ambient.mp3
static/sounds/ih.wav
static/sounds/inventory.mp3
static/sounds/isy.wav
static/sounds/lby.wav
static/sounds/legendary_drop.mp3
static/sounds/lets-go-gambling.mp3
static/sounds/long_maybe_for_loading_profile_anim.mp3
static/sounds/main_jackpot.mp3
static/sounds/message.mp3
static/sounds/ns.wav
static/sounds/popup_closed.mp3
static/sounds/popup_open.mp3
static/sounds/purchase.mp3
static/sounds/rare_drop.mp3
static/sounds/save.mp3
static/sounds/sucsess.mp3
static/sounds/suspense_music.mp3
static/sounds/synthesis_flash_hit.mp3
static/sounds/synthesis_fusion_loop.mp3
static/sounds/synthesis_implode.mp3
static/sounds/win1.mp3
static/sounds/win2.mp3
static/sounds/win3.mp3
svelte.config.js
tailwind.config.cjs
tsconfig.json
vite.config.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".firebaserc">
{
  "projects": {
    "default": "protomap-1e1db"
  }
}
</file>

<file path=".gitignore">
node_modules

# Output
.output
.vercel
.netlify
.wrangler
/.svelte-kit
/build

# OS
.DS_Store
Thumbs.db

# Env
.env
.env.*
!.env.example
!.env.test

# Vite
vite.config.js.timestamp-*
vite.config.ts.timestamp-*

.idea/
</file>

<file path=".npmrc">
engine-strict=true
</file>

<file path=".prettierignore">
# Package Managers
package-lock.json
pnpm-lock.yaml
yarn.lock
bun.lock
bun.lockb
</file>

<file path=".prettierrc">
{
	"useTabs": true,
	"singleQuote": true,
	"trailingComma": "none",
	"printWidth": 100,
	"plugins": ["prettier-plugin-svelte", "prettier-plugin-tailwindcss"],
	"overrides": [
		{
			"files": "*.svelte",
			"options": {
				"parser": "svelte"
			}
		}
	]
}
</file>

<file path="eslint.config.js">
import prettier from 'eslint-config-prettier';
import js from '@eslint/js';
import { includeIgnoreFile } from '@eslint/compat';
import svelte from 'eslint-plugin-svelte';
import globals from 'globals';
import { fileURLToPath } from 'node:url';
import ts from 'typescript-eslint';
import svelteConfig from './svelte.config.js';

const gitignorePath = fileURLToPath(new URL('./.gitignore', import.meta.url));

export default ts.config(
	includeIgnoreFile(gitignorePath),
	js.configs.recommended,
	...ts.configs.recommended,
	...svelte.configs.recommended,
	prettier,
	...svelte.configs.prettier,
	{
		languageOptions: {
			globals: { ...globals.browser, ...globals.node }
		},
		rules: { 'no-undef': 'off' }
	},
	{
		files: ['**/*.svelte', '**/*.svelte.ts', '**/*.svelte.js'],
		languageOptions: {
			parserOptions: {
				projectService: true,
				extraFileExtensions: ['.svelte'],
				parser: ts.parser,
				svelteConfig
			}
		}
	}
);
</file>

<file path="firebase.json">
{
  "firestore": {
    "database": "(default)",
    "location": "europe-central2",
    "rules": "firestore.rules",
    "indexes": "firestore.indexes.json"
  },
  "functions": [
    {
      "source": "functions",
      "codebase": "default",
      "ignore": [
        "node_modules",
        ".git",
        "firebase-debug.log",
        "firebase-debug.*.log",
        "*.local"
      ],
      "predeploy": [
        "npm --prefix \"$RESOURCE_DIR\" run build"
      ]
    }
  ]
}
</file>

<file path="firestore.indexes.json">
{
  "indexes": [],
  "fieldOverrides": []
}
</file>

<file path="firestore.rules">
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    match /users/{userId} {
      allow read: if true;

      allow create, update: if request.auth != null && request.auth.uid == userId;

      allow delete: if false;
    }
  }
}
</file>

<file path="functions/.eslintrc.js">
module.exports = {
  root: true,
  env: {
    es6: true,
    node: true,
  },
  extends: [
    "eslint:recommended",
    "plugin:import/errors",
    "plugin:import/warnings",
    "plugin:import/typescript",
    "google",
    "plugin:@typescript-eslint/recommended",
  ],
  parser: "@typescript-eslint/parser",
  parserOptions: {
    project: ["tsconfig.json", "tsconfig.dev.json"],
    sourceType: "module",
  },
  ignorePatterns: [
    "/lib/**/*",
    "/generated/**/*",
  ],
  plugins: [
    "@typescript-eslint",
    "import",
  ],
  rules: {
    "quotes": ["error", "double"],
    "import/no-unresolved": 0,
    "indent": ["error", 2],
  },
};
</file>

<file path="functions/.gitignore">
lib/**/*.js
lib/**/*.js.map

typings/

node_modules/
*.local
</file>

<file path="functions/tsconfig.dev.json">
{
  "include": [
    ".eslintrc.js"
  ]
}
</file>

<file path="functions/tsconfig.json">
{
  "compilerOptions": {
    "module": "NodeNext",
    "esModuleInterop": true,
    "moduleResolution": "nodenext",
    "noImplicitReturns": true,
    "noUnusedLocals": true,
    "outDir": "lib",
    "sourceMap": true,
    "strict": true,
    "target": "es2017",
    "skipLibCheck": true
  },
  "compileOnSave": true,
  "include": [
    "src"
  ]
}
</file>

<file path="postcss.config.cjs">
module.exports = {
	plugins: {
		tailwindcss: {},
		autoprefixer: {},
	},
}
</file>

<file path="README.md">
# ProtoMap

**Интерактивная карта для сообщества протогенов.**

[![Deployment](https://img.shields.io/badge/Deployment-Vercel-brightgreen?style=for-the-badge&logo=vercel)](https://proto-map.vercel.app)


**➡️ Перейти к карте: [proto-map.vercel.app](https://proto-map.vercel.app)**

---

<p align="center">
  <img src="https://sun9-33.userapi.com/s/v1/if2/ikLWu6HeFDgbSxLxshbmXC0AxdY06-ynrUqGUEGnA3kp6DaFBovTOGZQXYsa5OoGv7Y3zAXtRiyCwnhcKUj45a7b.jpg?quality=95&as=32x16,48x25,72x37,108x56,160x82,240x123,360x185,480x247,540x278,640x329,720x370,1080x555,1280x658,1440x740,1856x954&from=bu&cs=1856x0" alt="ProtoMap Preview" width="80%">
</p>

## //: О проекте

**ProtoMap** — это веб-приложение, созданное для объединения сообщества протогенов по всему миру. Оно позволяет пользователям регистрироваться, анонимно отмечать свое местоположение на глобальной карте, кастомизировать профили и общаться друг с другом. Проект выполнен в уникальной киберпанк-эстетике.

### Ключевые возможности

*   **Интерактивная карта:** Глобальная карта с кастомными, анимированными кластерами и персональными метками-аватарами.
*   **Регистрация и профили:** Полноценная система аутентификации (Email/Пароль, Google) и редактируемые профили с возможностью загрузки аватаров.
*   **Приватность:** Координаты меток привязываются к центру района/микрорайона, а не к точному местоположению.
*   **Социальные функции:** Пользователи могут оставлять комментарии на страницах профилей.
*   **Система модерации:** Реализована система жалоб на профили и комментарии с уведомлениями администратору в Telegram.
*   **Кастомный дизайн:** Уникальный киберпанк-стиль с анимированными элементами, неоновыми эффектами и стилизованными уведомлениями.
*   **Адаптивность:** Сайт полностью адаптирован для использования на мобильных устройствах.

## //: Технологический стек

Этот проект построен на современном и производительном стеке:

*   **Фронтенд:** [SvelteKit](https://kit.svelte.dev/)
*   **Стилизация:** [Tailwind CSS](https://tailwindcss.com/)
*   **Карта:** [Leaflet.js](https://leafletjs.com/) с плагином [Leaflet.markercluster](https://github.com/Leaflet/Leaflet.markercluster)
*   **Бэкенд и База данных:** [Firebase](https://firebase.google.com/) (Authentication, Firestore, Cloud Functions)
*   **Хостинг:**
    *   Фронтенд: [Vercel](https://vercel.com/)
    *   Бэкенд: [Firebase Hosting](https://firebase.google.com/docs/hosting)
*   **Хранение изображений:** [Cloudinary](https://cloudinary.com/) (для аватаров пользователей)

## //: Автор

*   **Orion_Z43**
*   **Telegram:** [https://t.me/Orion_Z43](https://t.me/Orion_Z43)

Спасибо за интерес к проекту!
</file>

<file path="src/hooks.client.ts">
if (typeof window !== 'undefined') {
    window.addEventListener('unhandledrejection', function (event) {
        console.error('CLIENT HOOK: Unhandled Promise Rejection:', event.reason);

        if (event.reason instanceof Error && event.reason.stack) {
            console.error('CLIENT HOOK: Stack trace for Unhandled Rejection:', event.reason.stack);
        } else {
             console.error('CLIENT HOOK: Rejection reason (raw):', event.reason);
        }
    });

    window.addEventListener('error', function (event) {
        console.error('CLIENT HOOK: Global window error:', event.error || event.message, event);
        if (event.error && event.error.stack) {
            console.error('CLIENT HOOK: Stack trace for global error:', event.error.stack);
        }
    });
}
</file>

<file path="src/lib/index.ts">
// place files you want to import through the `$lib` alias in this folder.
</file>

<file path="src/lib/server/firebase.admin.ts">
import admin from 'firebase-admin';
import { getApps } from 'firebase-admin/app';
import { PRIVATE_FIREBASE_SERVICE_ACCOUNT_KEY } from '$env/static/private';

const serviceAccount = JSON.parse(
    PRIVATE_FIREBASE_SERVICE_ACCOUNT_KEY
);

if (!getApps().length) {
    admin.initializeApp({
        credential: admin.credential.cert(serviceAccount)
    });
}

export const firestoreAdmin = admin.firestore();
export const authAdmin = admin.auth();
</file>

<file path="src/lib/stores/usernameCache.ts">
/**
 * [ЭТАП 6] usernameCache — глобальный in-memory кэш никнеймов по UID.
 *
 * Принцип работы:
 * - При первом обращении к uid делается запрос в Firestore
 * - Результат кэшируется на 5 минут в памяти (сбрасывается при перезагрузке)
 * - Пока данные грузятся — возвращается author_username как fallback
 * - Дедупликация запросов: если запрос уже летит — второй не отправляется
 */

import { writable, get } from 'svelte/store';
import { db } from '$lib/firebase';
import { doc, getDoc } from 'firebase/firestore';

type CacheEntry = {
    username: string;
    avatar_url: string;
    equipped_frame: string | null;
    fetchedAt: number;
};

type CacheState = Record<string, CacheEntry>;

const CACHE_TTL_MS = 5 * 60 * 1000; // 5 минут

// Основной стор: uid -> данные пользователя
const cache = writable<CacheState>({});

// Множество uid-ов за которыми уже летит запрос (дедупликация)
const pending = new Set<string>();

/**
 * Получить никнейм по uid.
 *
 * Принимает текущее состояние кэша (cacheState) как первый аргумент —
 * это позволяет использовать функцию реактивно в Svelte-шаблонах:
 *   {@const name = getUsername($usernameCache, uid, fallback)}
 *
 * Если данных нет — запускает фоновую загрузку и возвращает fallback.
 * Когда Firestore ответит, $usernameCache обновится и Svelte перерисует компонент.
 */
export function getUsername(cacheState: CacheState, uid: string, fallback: string): string {
    const entry = cacheState[uid];

    if (entry && Date.now() - entry.fetchedAt < CACHE_TTL_MS) {
        return entry.username;
    }

    // Запускаем загрузку в фоне если ещё не летит
    if (!pending.has(uid)) {
        fetchUser(uid);
    }

    return fallback;
}

/**
 * Получить аватар по uid — реактивная версия (принимает cacheState).
 */
export function getAvatarUrl(cacheState: CacheState, uid: string, fallback: string): string {
    const entry = cacheState[uid];
    if (entry && Date.now() - entry.fetchedAt < CACHE_TTL_MS) {
        return entry.avatar_url || fallback;
    }
    if (!pending.has(uid)) {
        fetchUser(uid);
    }
    return fallback;
}

/**
 * Получить рамку по uid — реактивная версия.
 */
export function getEquippedFrame(cacheState: CacheState, uid: string): string | null {
    const entry = cacheState[uid];
    if (entry && Date.now() - entry.fetchedAt < CACHE_TTL_MS) {
        return entry.equipped_frame;
    }
    return null;
}

/**
 * Загружает данные пользователя из Firestore и кладёт в кэш.
 * Вызывается один раз на uid (пока не завершится).
 */
async function fetchUser(uid: string): Promise<void> {
    pending.add(uid);
    try {
        const snap = await getDoc(doc(db, 'users', uid));
        if (snap.exists()) {
            const data = snap.data();
            cache.update(state => ({
                ...state,
                [uid]: {
                    username: data.username || 'Unknown',
                    avatar_url: data.avatar_url || '',
                    equipped_frame: data.equipped_frame || null,
                    fetchedAt: Date.now()
                }
            }));
        }
    } catch (e) {
        console.warn(`[usernameCache] Failed to fetch uid: ${uid}`, e);
    } finally {
        pending.delete(uid);
    }
}

/**
 * Принудительно обновить запись в кэше (вызывается после смены никнейма).
 * Например: usernameCache.invalidate(uid) после changeUsername.
 */
export function invalidate(uid: string): void {
    cache.update(state => {
        const next = { ...state };
        delete next[uid];
        return next;
    });
}

/**
 * Записать данные в кэш вручную (после успешного changeUsername на клиенте).
 * Позволяет не ждать следующего Firestore-запроса.
 */
export function set(uid: string, data: Partial<CacheEntry>): void {
    cache.update(state => ({
        ...state,
        [uid]: {
            username: data.username ?? state[uid]?.username ?? 'Unknown',
            avatar_url: data.avatar_url ?? state[uid]?.avatar_url ?? '',
            equipped_frame: data.equipped_frame ?? state[uid]?.equipped_frame ?? null,
            fetchedAt: Date.now()
        }
    }));
}

/**
 * Реактивный стор для подписки в компонентах через $usernameCache.
 * Используй когда нужно чтобы UI обновился автоматически при изменении кэша.
 *
 * Пример:
 *   $: displayName = $usernameCache[msg.author_uid]?.username ?? msg.author_username;
 */
export const usernameCache = cache;
</file>

<file path="src/lib/transitions/index.ts">
import { cubicOut } from 'svelte/easing';
import type { TransitionConfig } from 'svelte/transition';

export function glitch(node: Element, { duration = 400 }): TransitionConfig {
    return {
        duration,
        css: (t: number) => {
            return '';
        }
    };
}
</file>

<file path="src/routes/about/+page.ts">
export const prerender = true;
</file>

<file path="src/routes/api/auth/+server.ts">
import { authAdmin } from '$lib/server/firebase.admin';
import { json } from '@sveltejs/kit';
import type { RequestHandler } from './$types';

export const POST: RequestHandler = async ({ request, cookies }) => {
    const { idToken } = await request.json();

    const expiresIn = 60 * 60 * 24 * 5 * 1000;

    try {
        const sessionCookie = await authAdmin.createSessionCookie(idToken, { expiresIn });

        cookies.set('__session', sessionCookie, {
            path: '/',
            httpOnly: true,
            secure: process.env.NODE_ENV === 'production',
            maxAge: expiresIn / 1000,
        });

        return json({ status: 'success' });
    } catch (e) {
        console.error("Ошибка создания сессионной куки:", e);
        return json({ status: 'error', message: 'Не удалось создать сессию' }, { status: 401 });
    }
};

export const DELETE: RequestHandler = async ({ cookies }) => {
    cookies.delete('__session', { path: '/' });
    return json({ status: 'success' });
};
</file>

<file path="src/routes/u/[uid]/+page.server.ts">
import { firestoreAdmin } from '$lib/server/firebase.admin';
import { error } from '@sveltejs/kit';
import type { PageServerLoad } from './$types';
import { FieldPath } from 'firebase-admin/firestore';

export type Comment = {
    id: string;
    text: string;
    author_uid: string;
    author_username: string;
    author_avatar_url: string;
    author_equipped_frame: string | null;
    createdAt: Date;
    likes: string[];
    parentId: string | null;
    replies?: Comment[];
};

function isDomainInUrl(url: string, domain: string): boolean {
    try {
        const urlObj = new URL(url);
        return urlObj.hostname.endsWith(domain) || urlObj.hostname === domain;
    } catch {
        return false;
    }
}

function isSafeUrl(url: string): boolean {
    if (!url) return false;
    const lower = url.toLowerCase().trim();
    if (!lower.match(/^https?:\/\//)) return false;
    if (lower.includes('javascript:') || lower.includes('data:') ||
        lower.includes('vbscript:') || lower.includes('file:')) return false;
    return true;
}

function getAbsoluteImageUrl(avatarUrl: string | null | undefined, username: string): string {
    if (!avatarUrl) {
        return `https://api.dicebear.com/7.x/bottts-neutral/svg?seed=${encodeURIComponent(username)}`;
    }
    if (!isSafeUrl(avatarUrl)) {
        return `https://api.dicebear.com/7.x/bottts-neutral/svg?seed=${encodeURIComponent(username)}`;
    }
    if (isDomainInUrl(avatarUrl, 'cloudinary.com')) {
        const parts = avatarUrl.split('/upload/');
        if (parts.length === 2 && parts[0] && parts[1]) {
            return `${parts[0]}/upload/f_auto,q_auto,w_1200,h_1200,c_fill,g_face/${parts[1]}`;
        }
    }
    if (isDomainInUrl(avatarUrl, 'googleusercontent.com')) {
        const parts = avatarUrl.split('=');
        if (parts.length > 0) return parts[0] + '=s1200-c';
    }
    return avatarUrl;
}

export const load: PageServerLoad = async ({ params, setHeaders }) => {
    const uid = params.uid;

    // ✅ Прямой lookup по doc ID — O(1), без поиска по полю
    const userDoc = await firestoreAdmin.collection('users').doc(uid).get();

    if (!userDoc.exists) {
        throw error(404, 'Профиль не найден');
    }

    const userProfileData = userDoc.data()!;

    // Загружаем комментарии
    const commentsRef = userDoc.ref
        .collection('comments')
        .orderBy('createdAt', 'desc')
        .limit(50);
    const commentsSnapshot = await commentsRef.get();

    const rawComments: Comment[] = commentsSnapshot.docs.map(doc => {
        const data = doc.data();
        return {
            id: doc.id,
            text: data.text || '',
            author_uid: data.author_uid || '',
            author_username: data.author_username || 'Аноним',
            author_avatar_url: data.author_avatar_url || '',
            author_equipped_frame: data.author_equipped_frame || null,
            createdAt: data.createdAt?.toDate() || new Date(),
            likes: data.likes || [],
            parentId: data.parentId || null,
            replies: []
        };
    });

    // Подтягиваем актуальные данные авторов по uid (динамические никнеймы)
    const authorUids = [...new Set(rawComments.map(c => c.author_uid).filter(Boolean))];
    const authorsData = new Map<string, any>();

    if (authorUids.length > 0) {
        for (let i = 0; i < authorUids.length; i += 30) {
            const chunk = authorUids.slice(i, i + 30);
            const snaps = await firestoreAdmin.collection('users')
                .where(FieldPath.documentId(), 'in', chunk)
                .get();
            snaps.forEach(d => authorsData.set(d.id, d.data()));
        }
    }

    // Строим дерево комментариев
    const commentMap = new Map<string, Comment>();
    const rootComments: Comment[] = [];

    rawComments.forEach(c => {
        const freshAuthor = authorsData.get(c.author_uid);
        if (freshAuthor) {
            c.author_username = freshAuthor.username;
            c.author_avatar_url = freshAuthor.avatar_url;
            c.author_equipped_frame = freshAuthor.equipped_frame;
        }
        commentMap.set(c.id, c);
    });

    rawComments.forEach(c => {
        if (c.parentId && commentMap.has(c.parentId)) {
            commentMap.get(c.parentId)!.replies?.push(c);
        } else {
            rootComments.push(c);
        }
    });

    rootComments.forEach(root => {
        if (root.replies && root.replies.length > 0) {
            root.replies.sort((a, b) => a.createdAt.getTime() - b.createdAt.getTime());
        }
    });

    const seoData = {
        title: `${userProfileData.username} | ProtoMap`,
        description: userProfileData.status
            ? `${userProfileData.status}`
            : (userProfileData.about_me?.substring(0, 150) ||
               `Профиль пользователя ${userProfileData.username} на карте протогенов ProtoMap`),
        image: getAbsoluteImageUrl(userProfileData.avatar_url, userProfileData.username),
        url: `https://proto-map.vercel.app/u/${uid}`,
        type: 'profile'
    };

    setHeaders({ 'Cache-Control': 'public, max-age=60' });

    return {
        profile: {
            uid: userDoc.id,
            username: userProfileData.username,
            avatar_url: userProfileData.avatar_url,
            about_me: userProfileData.about_me,
            status: userProfileData.status || null,
            socials: userProfileData.socials || {},
            equipped_frame: userProfileData.equipped_frame || null,
            equipped_bg: userProfileData.equipped_bg || null
        },
        comments: rootComments,
        seoData
    };
};
</file>

<file path="src/routes/u/[uid]/+page.svelte">
<script lang="ts">
    import { userStore } from '$lib/stores';
    import type { ActionData, PageData } from './$types';
    import NeonButton from '$lib/components/NeonButton.svelte';
    import { onMount } from 'svelte';
    import { quintOut } from 'svelte/easing';
    import { tweened } from 'svelte/motion';
    import { modal } from '$lib/stores/modalStore';
    import { fade, slide } from 'svelte/transition';
    import { getFunctions, httpsCallable } from "firebase/functions";
    import { settingsStore } from '$lib/stores/settingsStore';
    import CinematicLoader from '$lib/components/CinematicLoader.svelte';
    import { browser } from '$app/environment';
    import { sendEmailVerification } from "firebase/auth";
    import { auth } from "$lib/firebase";
    import { invalidateAll } from '$app/navigation';
    import { t } from 'svelte-i18n';
    import { get } from 'svelte/store';
    import { renderMarkdown } from '$lib/utils/markdown';
    import { AudioManager } from '$lib/client/audioManager';
    import { page } from '$app/stores';
    import WatermelonInteractive from '$lib/components/WatermelonInteractive.svelte';
    // [ЭТАП 6] Кэш никнеймов
    import { usernameCache, getUsername, getAvatarUrl } from '$lib/stores/usernameCache';

    export let data: PageData;
    export let form: ActionData;

    let showCinematicIntro = true;
    let isProfileVisible = false;
    let isSubmitting = false;
    let verificationSent = false;

    const containerOpacity = tweened(0, { duration: 500, easing: quintOut });

    const translate = (key: string, vars = {}) => get(t)(key, vars);

    function getOptimizedAvatar(url: string | null | undefined, size: number = 100): string {
        if (!url) return '';

        if (url.includes('cloudinary.com')) {
            const parts = url.split('/upload/');
            return `${parts[0]}/upload/f_auto,q_auto,w_${size * 2},h_${size * 2},c_fill/${parts[1]}`;
        }

        // ФИКС ДЛЯ GOOGLE AVATARS
        if (url.includes('googleusercontent.com')) {
            // Заменяем параметр размера на наш (например, s200)
            return url.split('=')[0] + `=s${size * 2}-c`;
        }

        return url;
    }

    function getReportReasons() {
        return [
            { id: 'spam', label: translate('profile.reasons.spam'), text: 'Spam' },
            { id: 'inappropriate', label: translate('profile.reasons.inappropriate'), text: 'Inappropriate' },
            { id: 'impersonation', label: translate('profile.reasons.impersonation'), text: 'Impersonation' },
            { id: 'harassment', label: translate('profile.reasons.harassment'), text: 'Harassment' },
            { id: 'other', label: translate('profile.reasons.other'), text: 'Other' }
        ];
    }

    onMount(async () => {
        if (browser) {
            // --- ЛОГИКА СИНЕМАТИК-ЛОАДЕРА ---
            const cinematicEnabled = $settingsStore.cinematicLoadsEnabled;
            const sessionKey = `viewed_profile_${data.profile.username}`;
            const alreadyViewed = sessionStorage.getItem(sessionKey);

            if (cinematicEnabled && !alreadyViewed) {
                showCinematicIntro = true;
                sessionStorage.setItem(sessionKey, 'true');
            } else {
                showCinematicIntro = false;
                isProfileVisible = true;
                containerOpacity.set(1);
            }

            // --- ЛОГИКА МИГРАЦИИ АВАТАРКИ (UPLINK) ---
            // Проверяем: мой ли это профиль и не Google ли там в ссылке?
            // Используем $userStore напрямую для надежности
            const currentUser = $userStore.user;
            if (currentUser && currentUser.uid === data.profile.uid) {
                const avatarUrl = data.profile.avatar_url;

                if (avatarUrl && avatarUrl.includes('googleusercontent.com')) {
                    console.log("[System] External proxy avatar detected. Initializing migration protocol...");

                    try {
                        // Подгружаем функции только если они нужны
                        const { getFunctions, httpsCallable } = await import('firebase/functions');
                        const functions = getFunctions();
                        const migrateFunc = httpsCallable(functions, 'migrateExternalAvatar');

                        // Запускаем в фоне, не ждем ответа для отрисовки профиля
                        migrateFunc({ url: avatarUrl }).then((res: any) => {
                            if (res.data.status === 'success') {
                                console.log("[System] Avatar successfully migrated to Cloudinary storage.");
                                // Обновляем локальный стор, чтобы аватарка поменялась сразу
                                userStore.update(s => {
                                    if (s.user) s.user.avatar_url = res.data.newUrl;
                                    return s;
                                });
                            }
                        });
                    } catch (e) {
                        console.error("[System] Migration circuit failure:", e);
                    }
                }
            }
        }
    });

    function handleIntroFinished() {
        showCinematicIntro = false;
        setTimeout(() => {
            isProfileVisible = true;
            containerOpacity.set(1);
        }, 500);
    }

    $: isOwner = $userStore.user && $userStore.user.uid === data.profile.uid;
    $: socials = data.profile.socials || {};
    $: hasSocials = Object.values(socials).some(link => !!link);

    // Добавляем состояние для ответов
    let replyingToId: string | null = null;
    let replyingToName: string = '';

    // Функция начала ответа
    function startReply(commentId: string, username: string) {
        replyingToId = commentId;
        replyingToName = username;
        // Скролл к форме ввода или фокус на инпуте (если форма плавающая)
        // В нашем случае форма одна, сделаем её "умной"
        const input = document.querySelector('textarea[name="commentText"]') as HTMLElement;
        if (input) {
            input.focus();
            input.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    function cancelReply() {
        replyingToId = null;
        replyingToName = '';
    }

    // Обновляем отправку
    async function handleAddComment() {
        if (!commentText.trim() || isSubmitting) return;

        isSubmitting = true;
        try {
            const functions = getFunctions();
            const addCommentFunc = httpsCallable(functions, 'addComment');

            await addCommentFunc({
                profileUid: data.profile.uid,
                text: commentText,
                parentId: replyingToId // Отправляем ID родителя, если есть
            });

            commentText = '';
            cancelReply(); // Сброс режима ответа
            await invalidateAll();

        } catch (error: any) {
            modal.error(translate('ui.error'), error.message);
        } finally {
            isSubmitting = false;
        }
    }

    // Функция Лайка (Оптимистичная)
    async function handleLike(commentId: string) {
        if (!$userStore.user) return modal.warning(translate('ui.error'), translate('profile.login_req'));

        const uid = $userStore.user.uid;

        // 1. АНИМАЦИЯ И ЗВУК СРАЗУ
        AudioManager.play('click_alt');

        // 2. ОПТИМИСТИЧНОЕ ОБНОВЛЕНИЕ ЛОКАЛЬНЫХ ДАННЫХ
        // Нам нужно найти коммент (он может быть родительским или ответом) и обновить его
        data.comments = data.comments.map(c => {
            // Если это родитель
            if (c.id === commentId) {
                const hasLiked = c.likes.includes(uid);
                return {
                    ...c,
                    likes: hasLiked ? c.likes.filter(id => id !== uid) : [...c.likes, uid]
                };
            }

            // Если это ответ внутри родителя
            if (c.replies) {
                const updatedReplies = c.replies.map(r => {
                    if (r.id === commentId) {
                        const hasLiked = r.likes.includes(uid);
                        return {
                            ...r,
                            likes: hasLiked ? r.likes.filter(id => id !== uid) : [...r.likes, uid]
                        };
                    }
                    return r;
                });
                return { ...c, replies: updatedReplies };
            }

            return c;
        });

        // 3. ОТПРАВКА НА СЕРВЕР (В ФОНЕ)
        try {
            const functions = getFunctions();
            const likeFunc = httpsCallable(functions, 'toggleCommentLike');
            // Мы не ждем await invalidateAll(), интерфейс уже обновлен
            await likeFunc({ profileUid: data.profile.uid, commentId });
        } catch(e) {
            console.error("Like sync error:", e);
            // В идеале тут надо откатить лайк назад, но для пет-проекта можно забить,
            // при следующей перезагрузке данные синхронизируются.
        }
    }

    async function handleDeleteComment(commentId: string) {
        modal.confirm(
            translate('ui.delete'),
            translate('ui.confirm_delete'),
            async () => {
                try {
                    const functions = getFunctions();
                    const deleteCommentFunc = httpsCallable(functions, 'deleteComment');

                    await deleteCommentFunc({
                        profileUid: data.profile.uid,
                        commentId: commentId
                    });

                    modal.success(translate('ui.success'), "Deleted.");

                } catch (error: any) {
                    modal.error(translate('ui.error'), error.message);
                }
            }
        );
    }

    async function handleReportProfile() {
        if (!$userStore.user) {
            modal.warning(translate('ui.error'), translate('profile.login_req'));
            return;
        }
        const reasons = getReportReasons();

        const messageText = `${translate('profile.report_profile_text')} <strong>${data.profile.username}</strong>.`;

        modal.report(
            translate('profile.report_profile_title'),
            messageText,
            reasons,
            async (selectedReasonId) => {
                const reasonObject = reasons.find(r => r.id === selectedReasonId);
                if (!reasonObject) return;
                try {
                    const functions = getFunctions();
                    const reportContentFunc = httpsCallable(functions, 'reportContent');
                    modal.info(translate('ui.loading'), translate('profile.sending'));
                    await reportContentFunc({ type: 'profile', reportedContentId: data.profile.uid, profileOwnerUid: data.profile.uid, reason: reasonObject.text, reportedUsername: data.profile.username, reporterUsername: $userStore.user?.username || 'unknown'});
                    modal.success(translate('profile.report_success'), translate('profile.report_success_text'));
                } catch (error: any) { modal.error(translate('ui.error'), error.message); }
            }
        );
    }

    async function handleReportComment(commentId: string, commentAuthorUsername: string) {
        if (!$userStore.user) {
            modal.warning(translate('ui.error'), translate('profile.login_req'));
            return;
        }
        const reasons = getReportReasons();
        const messageText = `${translate('profile.report_comment_text')} <strong>${commentAuthorUsername}</strong>.`;

        modal.report(
            translate('profile.report_comment_title'),
            messageText,
            reasons,
            async (selectedReasonId) => {
                const reasonObject = reasons.find(r => r.id === selectedReasonId);
                if (!reasonObject) return;
                try {
                    const functions = getFunctions();
                    const reportContentFunc = httpsCallable(functions, 'reportContent');
                    modal.info(translate('ui.loading'), translate('profile.sending'));
                    await reportContentFunc({ type: 'comment', reportedContentId: commentId, profileOwnerUid: data.profile.uid, reason: reasonObject.text, profileOwnerUsername: data.profile.username, reportedUsername: commentAuthorUsername, reporterUsername: $userStore.user?.username || 'unknown' });
                    modal.success(translate('profile.report_success'), translate('profile.report_success_text'));
                } catch (error: any) { modal.error(translate('ui.error'), error.message); }
            }
        );
    }

    function copyDiscordTag() {
        const tag = socials.discord;
        if (tag) {
            navigator.clipboard.writeText(tag).then(() => {
                modal.success(translate('profile.copy_success'), translate('profile.copy_text', { tag }));
            }, () => {
                modal.error(translate('ui.error'), "Copy failed.");
            });
        }
    }

    let commentText = '';
    $: if (form?.addCommentSuccess) {
        commentText = '';
    }

    function formatTimeAgo(date: Date): string {
        if (!date || !(date instanceof Date)) return '';
        const seconds = Math.floor((new Date().getTime() - date.getTime()) / 1000);

        if (seconds < 60) return translate('profile.time.just_now');

        const intervals: {[key: string]: number} = {
            'y': 31536000,
            'm': 2592000,
            'd': 86400,
            'h': 3600,
            'min': 60
        };

        for (const [unit, secondsInUnit] of Object.entries(intervals)) {
            const interval = seconds / secondsInUnit;
            if (interval > 1) {
                const unitText = translate(`profile.time.${unit}`);
                return `${Math.floor(interval)} ${unitText} ${translate('profile.time.ago')}`;
            }
        }
        return translate('profile.time.just_now');
    }
    $: isWatermelonMode = data.profile.uid === 'zIgs2z54ThV9ee102lVlZKg6lTh2';
</script>

<svelte:head>
    <!-- Basic Meta Tags -->
    <title>{data.seoData.title}</title>
    <meta name="description" content={data.seoData.description} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="profile" />
    <meta property="og:url" content={data.seoData.url} />
    <meta property="og:title" content={data.seoData.title} />
    <meta property="og:description" content={data.seoData.description} />
    <meta property="og:image" content={data.seoData.image} />
    <meta property="og:image:secure_url" content={data.seoData.image} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="1200" />
    <meta property="og:image:alt" content={`Аватар ${data.profile.username}`} />
    <meta property="og:image:type" content="image/jpeg" />
    <meta property="og:site_name" content="ProtoMap" />
    <meta property="og:locale" content="ru_RU" />

    <!-- Profile specific -->
    <meta property="profile:username" content={data.profile.username} />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={data.seoData.url} />
    <meta name="twitter:title" content={data.seoData.title} />
    <meta name="twitter:description" content={data.seoData.description} />
    <meta name="twitter:image" content={data.seoData.image} />
    <meta name="twitter:image:alt" content={`Аватар ${data.profile.username}`} />

    <!-- Canonical URL -->
    <link rel="canonical" href={data.seoData.url} />
</svelte:head>

{#if showCinematicIntro}
    <CinematicLoader
        username={data.profile.username}
        on:finished={handleIntroFinished}
    />
{/if}

{#if isWatermelonMode}
    <WatermelonInteractive />
{/if}

{#if isProfileVisible}
    <div class="hidden neon-blue-frame glitch-frame high-roller-frame frame_biohazard frame_plasma frame_stealth frame_dev frame_beta"></div>

    <div class="container mx-auto px-4" transition:fade={{ duration: 300 }}>
        {#if data.profile.equipped_bg}
        <div class="profile-backdrop {data.profile.equipped_bg}"></div>
    {/if}

    <div class="profile-container cyber-panel pb-12 {data.profile.equipped_bg ? 'themed ' + data.profile.equipped_bg + '-theme' : ''}" style="opacity: {$containerOpacity}">

            {#if $userStore.user && !isOwner}
                <button on:click={handleReportProfile} class="report-icon-btn" title={$t('profile.report_btn')}>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
                </button>
            {/if}

            <div class="corner-bg top-left"></div>
            <div class="corner-bg top-right"></div>
            <div class="corner-bg bottom-left"></div>
            <div class="corner-bg bottom-right"></div>

            <div class="top-bar">
                <span class="pl-6">{$t('profile.user_id')}: {data.profile.uid.substring(0, 18).toUpperCase()}...</span>
            </div>

            <div class="profile-header">
                <div class="avatar-wrapper {data.profile.equipped_frame || ''}">
                    <img
                        src={data.profile.avatar_url || `https://api.dicebear.com/7.x/bottts-neutral/svg?seed=${data.profile.username}`}
                        alt="Avatar"
                        class="profile-avatar"
                    />
                </div>
                <h2 class="profile-username font-display">{data.profile.username}</h2>
            </div>

            <div class="profile-content">

                {#if hasSocials}
                    <div class="profile-section">
                        <h4 class="font-display">// {$t('profile.channels')}</h4>
                        <div class="text-center">
                            <div class="social-links-grid">
                                {#if socials.telegram}
                            <a href={`https://t.me/${socials.telegram}`} target="_blank" rel="noopener noreferrer" class="social-link-btn" title="Telegram">
                                <svg viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" preserveAspectRatio="xMidYMid"> <g fill-rule="evenodd"> <path d="M128,0 C57.307,0 0,57.307 0,128 C0,198.693 57.307,256 128,256 C198.693,256 256,198.693 256,128 C256,57.307 198.693,0 128,0 Z" fill="#40B3E0"></path> <path d="M190.2826,73.6308 L167.4206,188.8978 C167.4206,188.8978 164.2236,196.8918 155.4306,193.0548 L102.6726,152.6068 L83.4886,143.3348 L51.1946,132.4628 C51.1946,132.4628 46.2386,130.7048 45.7586,126.8678 C45.2796,123.0308 51.3546,120.9528 51.3546,120.9528 L179.7306,70.5928 C179.7306,70.5928 190.2826,65.9568 190.2826,73.6308" fill="#FFFFFF"></path> <path d="M98.6178,187.6035 C98.6178,187.6035 97.0778,187.4595 95.1588,181.3835 C93.2408,175.3085 83.4888,143.3345 83.4888,143.3345 L161.0258,94.0945 C161.0258,94.0945 165.5028,91.3765 165.3428,94.0945 C165.3428,94.0945 166.1418,94.5735 163.7438,96.8115 C161.3458,99.0505 102.8328,151.6475 102.8328,151.6475" fill="#D2E5F1"></path> <path d="M122.9015,168.1154 L102.0335,187.1414 C102.0335,187.1414 100.4025,188.3794 98.6175,187.6034 L102.6135,152.2624" fill="#B5CFE4"></path> </g> </svg>
                            </a>
                        {/if}
                        {#if socials.discord}
                            <button type="button" on:click={copyDiscordTag} class="social-link-btn" title={$t('profile.copy_text', {tag: ''})}>
                                <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"> <circle cx="512" cy="512" r="512" style="fill:#5865f2"/> <path d="M689.43 349a422.21 422.21 0 0 0-104.22-32.32 1.58 1.58 0 0 0-1.68.79 294.11 294.11 0 0 0-13 26.66 389.78 389.78 0 0 0-117.05 0 269.75 269.75 0 0 0-13.18-26.66 1.64 1.64 0 0 0-1.68-.79A421 421 0 0 0 334.44 349a1.49 1.49 0 0 0-.69.59c-66.37 99.17-84.55 195.9-75.63 291.41a1.76 1.76 0 0 0 .67 1.2 424.58 424.58 0 0 0 127.85 64.63 1.66 1.66 0 0 0 1.8-.59 303.45 303.45 0 0 0 26.15-42.54 1.62 1.62 0 0 0-.89-2.25 279.6 279.6 0 0 1-39.94-19 1.64 1.64 0 0 1-.16-2.72c2.68-2 5.37-4.1 7.93-6.22a1.58 1.58 0 0 1 1.65-.22c83.79 38.26 174.51 38.26 257.31 0a1.58 1.58 0 0 1 1.68.2c2.56 2.11 5.25 4.23 8 6.24a1.64 1.64 0 0 1-.14 2.72 262.37 262.37 0 0 1-40 19 1.63 1.63 0 0 0-.87 2.28 340.72 340.72 0 0 0 26.13 42.52 1.62 1.62 0 0 0 1.8.61 423.17 423.17 0 0 0 128-64.63 1.64 1.64 0 0 0 .67-1.18c10.68-110.44-17.88-206.38-75.7-291.42a1.3 1.3 0 0 0-.63-.63zM427.09 582.85c-25.23 0-46-23.16-46-51.6s20.38-51.6 46-51.6c25.83 0 46.42 23.36 46 51.6.02 28.44-20.37 51.6-46 51.6zm170.13 0c-25.23 0-46-23.16-46-51.6s20.38-51.6 46-51.6c25.83 0 46.42 23.36 46 51.6.01 28.44-20.17 51.6-46 51.6z" style="fill:#fff"/></svg>
                            </button>
                        {/if}
                        {#if socials.vk}
                            <a href={`https://vk.com/${socials.vk}`} target="_blank" rel="noopener noreferrer" class="social-link-btn" title="VK">
                                <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"> <circle cx="512" cy="512" r="512" style="fill:#2787f5"/> <path d="M585.83 271.5H438.17c-134.76 0-166.67 31.91-166.67 166.67v147.66c0 134.76 31.91 166.67 166.67 166.67h147.66c134.76 0 166.67-31.91 166.67-166.67V438.17c0-134.76-32.25-166.67-166.67-166.67zm74 343.18h-35c-13.24 0-17.31-10.52-41.07-34.62-20.71-20-29.87-22.74-35-22.74-7.13 0-9.17 2-9.17 11.88v31.57c0 8.49-2.72 13.58-25.12 13.58-37 0-78.07-22.4-106.93-64.16-43.45-61.1-55.33-106.93-55.33-116.43 0-5.09 2-9.84 11.88-9.84h35c8.83 0 12.22 4.07 15.61 13.58 17.31 49.9 46.17 93.69 58 93.69 4.41 0 6.45-2 6.45-13.24v-51.6c-1.36-23.76-13.92-25.8-13.92-34.28 0-4.07 3.39-8.15 8.83-8.15h55c7.47 0 10.18 4.07 10.18 12.9v69.58c0 7.47 3.39 10.18 5.43 10.18 4.41 0 8.15-2.72 16.29-10.86 25.12-28.17 43.11-71.62 43.11-71.62 2.38-5.09 6.45-9.84 15.28-9.84h35c10.52 0 12.9 5.43 10.52 12.9-4.41 20.37-47.18 80.79-47.18 80.79-3.73 6.11-5.09 8.83 0 15.61 3.73 5.09 16 15.61 24.1 25.12 14.94 17 26.48 31.23 29.53 41.07 3.45 9.84-1.65 14.93-11.49 14.93z" style="fill:#fff"/> </svg>
                            </a>
                        {/if}
                        {#if socials.twitter}
                            <a href={`https://x.com/${socials.twitter}`} target="_blank" rel="noopener noreferrer" class="social-link-btn" title="X (Twitter)">
                                <svg viewBox="0 0 201 201" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M200.448 100.651C200.448 151.17 163.011 192.936 114.377 199.713C109.83 200.344 105.177 200.674 100.455 200.674C95.0035 200.674 89.6504 200.239 84.4373 199.398C36.8266 191.73 0.461731 150.435 0.461731 100.651C0.461731 45.4078 45.2347 0.621582 100.462 0.621582C155.689 0.621582 200.462 45.4078 200.462 100.651H200.448Z" fill="#1C1C1B"/><path d="M41.0167 44.7349L87.1349 106.412L40.7294 156.56H51.1765L91.8085 112.657L124.635 156.56H160.18L111.469 91.4134L154.666 44.7349H144.219L106.803 85.1686L76.5688 44.7349H41.0236H41.0167ZM56.3754 52.4305H72.7011L144.807 148.864H128.482L56.3754 52.4305Z" fill="white"/></svg>
                            </a>
                        {/if}
                        {#if socials.website}
                            <a href={socials.website} target="_blank" rel="noopener noreferrer" class="social-link-btn" title="Site">
                                <svg version="1.0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1920.000000 1920.000000" preserveAspectRatio="xMidYMid meet"> <g transform="translate(0.000000,1920.000000) scale(0.100000,-0.100000)" fill="#ffffff" stroke="none"> <path d="M9200 19194 c-14 -2 -117 -8 -230 -13 -559 -26 -1261 -143 -1900 -315 -204 -55 -249 -69 -495 -151 -263 -87 -280 -93 -550 -200 -386 -153 -978 -441 -1215 -590 -22 -14 -42 -25 -45 -25 -10 0 -314 -189 -475 -295 -262 -173 -556 -389 -760 -559 -47 -38 -110 -90 -140 -115 -30 -24 -62 -51 -70 -60 -8 -9 -67 -62 -131 -118 -450 -394 -911 -899 -1300 -1424 -34 -46 -81 -109 -103 -139 -69 -94 -277 -409 -360 -545 -43 -72 -88 -146 -101 -165 -56 -89 -180 -317 -298 -550 -163 -324 -270 -567 -433 -985 -32 -83 -190 -559 -209 -630 -7 -27 -27 -102 -45 -165 -169 -613 -287 -1309 -323 -1910 -15 -250 -15 -1029 0 -1275 25 -402 110 -1015 184 -1329 11 -44 19 -88 19 -99 0 -10 8 -49 19 -85 10 -37 28 -110 41 -162 12 -52 30 -124 40 -160 10 -36 28 -101 40 -145 62 -226 163 -529 265 -800 15 -38 32 -83 37 -100 6 -16 14 -34 18 -40 3 -5 15 -32 25 -60 24 -65 192 -449 240 -545 86 -175 102 -208 130 -260 25 -49 193 -352 215 -390 217 -372 385 -624 663 -997 93 -125 375 -472 426 -524 9 -9 57 -61 106 -115 248 -272 308 -333 552 -559 271 -252 374 -341 568 -493 55 -43 109 -85 120 -95 53 -44 245 -185 360 -263 39 -27 72 -51 75 -54 19 -23 639 -411 685 -429 5 -2 64 -34 130 -71 241 -134 318 -173 690 -344 28 -13 70 -33 95 -44 25 -11 92 -39 150 -62 58 -23 119 -48 135 -55 321 -139 976 -342 1430 -444 363 -82 822 -158 1095 -181 63 -6 151 -15 195 -21 155 -20 815 -37 1100 -28 435 13 537 21 935 69 365 45 788 124 1130 212 63 17 138 36 167 43 28 7 73 19 100 28 26 8 84 25 128 37 145 41 649 211 710 240 11 5 56 23 100 40 44 17 89 35 100 40 11 5 61 26 110 46 50 20 122 51 160 69 39 18 143 67 232 109 90 41 232 112 315 157 84 45 180 96 213 114 84 44 343 199 510 305 430 274 954 674 1275 976 291 274 349 330 456 444 64 69 147 157 184 195 134 139 361 412 552 664 107 140 121 160 177 238 51 71 254 373 278 413 11 19 38 62 58 95 75 120 188 312 225 380 20 39 74 139 119 223 45 83 116 225 157 315 42 89 91 194 109 232 18 39 49 111 69 160 20 50 41 99 46 110 5 11 23 56 40 100 17 44 35 89 40 100 6 11 19 45 29 75 11 30 44 125 74 211 54 151 125 381 181 579 15 52 31 109 36 125 36 125 125 529 160 725 59 340 79 484 115 838 35 342 46 798 29 1262 -7 206 -18 411 -23 455 -6 44 -15 132 -21 195 -32 375 -158 1060 -257 1400 -9 30 -19 71 -23 90 -20 99 -159 538 -243 770 -56 153 -185 476 -228 568 -17 37 -56 123 -87 192 -70 156 -210 431 -295 581 -35 63 -66 119 -68 124 -22 59 -352 578 -488 770 -27 39 -66 93 -85 120 -66 92 -302 399 -333 432 -12 12 -58 67 -101 120 -44 54 -88 107 -98 118 -11 11 -89 96 -174 189 -237 259 -368 388 -710 698 -285 256 -645 534 -1035 795 -146 98 -382 245 -487 303 -15 8 -82 46 -150 84 -156 88 -300 165 -408 217 -47 23 -107 52 -135 66 -71 36 -396 179 -485 214 -41 17 -89 37 -107 45 -80 37 -521 191 -713 250 -212 65 -377 110 -520 144 -52 13 -125 31 -162 41 -36 11 -75 19 -85 19 -11 0 -55 8 -99 19 -306 72 -938 161 -1304 182 -160 10 -1016 20 -1060 13z m4960 -3476 c226 -41 413 -104 602 -206 170 -91 280 -173 433 -327 158 -158 246 -275 334 -445 132 -254 191 -469 212 -765 6 -100 9 -1587 6 -4495 l-3 -4345 -21 -110 c-41 -218 -80 -337 -168 -520 -268 -555 -772 -923 -1415 -1032 -99 -17 -337 -18 -4440 -21 -2929 -2 -4383 0 -4482 7 -182 13 -326 41 -482 92 -555 182 -1003 630 -1186 1187 -52 159 -78 295 -91 471 -7 98 -9 1576 -7 4496 l3 4350 24 125 c72 389 231 709 485 977 243 257 549 438 883 521 101 26 172 38 328 56 17 2 2024 3 4460 2 4110 -1 4437 -3 4525 -18z"/> <path d="M5055 15644 c-272 -41 -512 -134 -735 -282 -392 -262 -652 -653 -758 -1142 l-27 -125 0 -4490 0 -4490 23 -118 c150 -780 781 -1367 1567 -1457 60 -6 1535 -10 4480 -10 4781 0 4479 -3 4714 56 635 159 1140 667 1300 1309 54 217 51 -62 51 4703 0 4766 3 4485 -54 4709 -35 138 -69 230 -136 366 -256 513 -747 872 -1325 967 -118 20 -186 20 -4565 19 -3722 -1 -4460 -3 -4535 -15z m4885 -184 c0 -6 -372 -505 -826 -1110 l-826 -1100 -2277 2 -2276 3 -3 280 c-3 315 8 527 37 666 143 689 730 1205 1431 1258 163 13 4740 13 4740 1z m4037 0 c722 -56 1295 -555 1456 -1270 19 -87 21 -130 25 -517 l3 -423 -3451 0 c-2758 0 -3450 3 -3443 13 4 6 158 215 343 462 1052 1409 1294 1731 1304 1737 17 11 3620 9 3763 -2z m1483 -6349 c0 -3899 0 -3940 -20 -4056 -57 -333 -219 -636 -471 -880 -218 -212 -476 -348 -792 -417 l-102 -23 -4475 0 -4475 0 -109 23 c-148 32 -240 64 -383 132 -135 65 -212 114 -323 206 -293 243 -477 558 -552 948 l-22 111 -3 3935 c-2 2164 -1 3940 1 3947 4 11 1132 13 5866 13 l5860 0 0 -3939z"/> <path d="M5160 15383 c-19 -2 -79 -12 -134 -23 -536 -107 -985 -509 -1146 -1027 -58 -188 -63 -232 -68 -630 l-4 -373 2225 0 2225 0 762 1018 c420 559 767 1023 773 1030 7 9 -453 12 -2294 10 -1267 0 -2320 -3 -2339 -5z m512 -853 c58 -17 96 -54 113 -115 24 -82 -6 -165 -75 -204 -38 -21 -41 -21 -657 -19 l-618 3 -34 24 c-65 46 -87 140 -52 216 23 50 56 81 101 93 49 14 1173 15 1222 2z m1995 -12 c57 -32 78 -73 78 -155 0 -77 -13 -106 -69 -147 -27 -21 -39 -21 -642 -24 -603 -2 -615 -2 -654 18 -95 49 -120 187 -47 266 60 65 49 64 707 61 543 -2 598 -4 627 -19z"/> <path d="M4435 14434 c-36 -39 -35 -111 1 -145 l26 -24 605 0 605 0 24 28 c40 47 28 133 -23 156 -17 8 -204 11 -619 11 l-595 0 -24 -26z"/> <path d="M6395 14435 c-36 -35 -35 -112 1 -146 l26 -24 605 0 605 0 24 30 c35 44 33 98 -5 136 l-29 29 -602 0 -601 0 -24 -25z"/> <path d="M9505 14393 c-412 -549 -759 -1013 -773 -1030 l-24 -33 3342 0 3342 0 -5 368 c-4 323 -7 379 -26 466 -67 320 -215 584 -452 811 -198 188 -439 316 -724 383 l-110 26 -1911 3 -1911 3 -748 -997z m2505 790 c384 -76 660 -421 660 -826 0 -509 -473 -908 -980 -826 -315 50 -578 280 -668 584 -117 394 64 821 423 999 107 53 165 69 320 90 45 6 161 -4 245 -21z m2065 16 c611 -75 947 -739 639 -1264 -59 -100 -182 -224 -287 -289 -320 -199 -748 -156 -1020 103 -319 303 -350 802 -72 1148 93 116 232 214 371 261 63 22 162 40 264 50 8 1 56 -3 105 -9z"/> <path d="M11665 15114 c-374 -83 -622 -411 -602 -795 35 -665 843 -969 1309 -493 153 157 221 325 220 544 0 182 -54 334 -170 483 -84 107 -250 213 -397 253 -87 23 -273 27 -360 8z m270 -209 c108 -23 189 -68 275 -155 118 -117 170 -237 170 -390 0 -148 -55 -275 -165 -385 -258 -259 -660 -209 -863 109 -39 61 -67 148 -77 236 -22 211 114 443 316 540 123 58 220 71 344 45z"/> <path d="M11688 14821 c-77 -25 -143 -69 -210 -139 -98 -102 -133 -202 -126 -349 5 -83 10 -102 43 -171 88 -178 282 -295 461 -279 211 20 385 169 438 373 28 107 15 211 -40 320 -102 204 -354 312 -566 245z"/> <path d="M13825 15113 c-561 -119 -795 -798 -430 -1243 58 -70 72 -84 144 -135 210 -151 521 -182 757 -75 402 181 574 654 379 1041 -159 316 -509 485 -850 412z m270 -208 c107 -23 189 -68 276 -155 117 -115 161 -223 161 -390 0 -112 -23 -194 -77 -285 -45 -75 -74 -106 -150 -160 -226 -161 -514 -137 -711 60 -246 246 -207 651 83 845 132 88 269 116 418 85z"/> <path d="M13847 14820 c-122 -39 -237 -140 -295 -260 -37 -74 -37 -76 -37 -200 0 -123 1 -126 37 -203 103 -218 360 -326 585 -247 277 97 403 415 269 678 -100 195 -350 299 -559 232z"/> <path d="M3813 9043 l3 -3928 21 -95 c93 -413 309 -735 643 -958 219 -145 459 -230 716 -252 92 -8 1375 -10 4489 -8 4018 4 4366 5 4440 21 341 70 594 205 825 437 207 208 340 456 412 766 l23 99 2 3923 3 3922 -5790 0 -5790 0 3 -3927z m10287 3629 c134 -55 229 -157 270 -288 20 -65 20 -86 20 -1369 0 -1251 -1 -1306 -19 -1364 -46 -149 -168 -267 -316 -305 -53 -14 -515 -16 -4456 -16 -4279 0 -4399 1 -4458 19 -33 10 -80 30 -103 44 -61 36 -140 123 -180 198 l-33 64 -3 1339 c-2 1223 -1 1344 14 1390 25 76 58 127 122 188 64 61 100 83 182 109 52 17 264 18 4480 16 l4425 -2 55 -23z m-4240 -3802 c559 -70 1084 -352 1432 -772 220 -265 369 -556 453 -884 220 -858 -111 -1792 -820 -2314 -316 -232 -666 -374 -1049 -425 -173 -23 -489 -17 -656 13 -977 177 -1702 948 -1821 1937 -17 142 -14 387 6 540 40 312 151 621 317 885 218 345 527 623 893 805 215 106 415 169 648 205 141 21 461 26 597 10z"/> <path d="M5185 12616 c-116 -29 -207 -101 -258 -205 l-32 -66 0 -1330 0 -1330 27 -55 c36 -74 87 -132 149 -169 105 -66 -256 -61 4534 -61 3909 0 4367 2 4420 16 116 30 207 105 259 214 l31 65 0 1320 0 1320 -33 67 c-54 111 -141 182 -257 212 -53 14 -510 16 -4425 15 -3435 -1 -4376 -3 -4415 -13z m8848 -226 c21 -14 46 -43 57 -66 20 -40 20 -64 20 -1309 0 -1245 0 -1269 -20 -1309 -11 -23 -36 -52 -57 -66 l-37 -25 -4380 -3 -4380 -2 -43 21 c-23 11 -53 35 -65 52 l-23 32 -2 1290 -3 1290 23 40 c14 26 37 48 67 63 l44 22 4381 -2 4381 -3 37 -25z"/> <path d="M5248 12342 c-15 -2 -38 -17 -53 -33 l-25 -31 0 -1268 0 -1268 35 -31 36 -31 4369 2 4370 3 27 28 28 27 3 1259 c1 793 -1 1269 -7 1285 -6 14 -21 32 -34 40 -21 14 -459 16 -4373 19 -2392 1 -4361 1 -4376 -1z m1791 -700 c19 -9 47 -33 61 -52 15 -19 91 -190 170 -380 78 -190 145 -348 149 -352 3 -4 87 142 186 324 193 356 232 411 298 423 122 23 227 -58 227 -175 0 -49 -14 -78 -243 -505 -82 -154 -166 -311 -187 -350 -20 -38 -60 -114 -89 -167 -76 -142 -129 -179 -233 -165 -32 4 -51 16 -83 49 -36 37 -61 88 -175 358 -73 173 -136 319 -140 323 -7 8 -22 -26 -170 -393 -50 -124 -94 -235 -99 -246 -24 -56 -128 -101 -192 -84 -84 23 -95 37 -234 315 -355 708 -409 823 -408 874 0 26 8 61 16 77 35 68 144 110 220 85 20 -7 51 -29 69 -49 19 -22 98 -170 188 -354 85 -175 158 -314 161 -310 4 4 69 160 144 346 75 187 144 350 152 362 20 32 91 64 138 64 22 0 55 -8 74 -18z m2544 4 c18 -7 42 -25 55 -38 13 -14 86 -176 163 -359 78 -184 147 -350 155 -369 l15 -34 118 219 c65 121 148 276 185 345 95 178 139 212 250 196 60 -9 107 -42 134 -96 38 -75 31 -103 -62 -283 -342 -661 -469 -894 -505 -929 -69 -66 -151 -71 -227 -13 -43 33 -51 50 -181 358 -146 349 -145 347 -152 347 -3 0 -66 -150 -139 -334 -80 -200 -142 -342 -155 -354 -34 -32 -91 -52 -145 -52 -59 0 -120 39 -152 97 -12 21 -133 266 -270 545 -274 556 -275 558 -227 629 65 96 215 118 279 40 13 -15 97 -175 188 -354 91 -179 168 -322 171 -319 3 4 64 155 135 337 71 181 138 343 149 360 44 65 143 93 218 61z m2611 -38 c34 -38 66 -106 185 -394 79 -192 147 -352 150 -356 4 -4 71 110 151 255 234 427 239 436 276 463 89 68 234 23 276 -85 14 -38 12 -106 -5 -138 -8 -16 -30 -57 -50 -93 -19 -36 -139 -261 -267 -500 -127 -239 -245 -450 -263 -467 -38 -41 -85 -57 -149 -51 -83 8 -113 47 -204 267 -43 102 -105 252 -139 333 -34 81 -63 150 -66 152 -3 3 -65 -145 -138 -329 -118 -296 -138 -339 -171 -369 -50 -45 -98 -60 -146 -47 -48 13 -96 47 -122 85 -11 17 -134 261 -271 542 -220 447 -251 517 -251 558 0 54 16 90 57 127 56 52 142 63 208 26 38 -21 50 -41 208 -357 93 -184 172 -336 176 -338 4 -1 15 14 23 35 279 695 276 688 343 719 19 9 53 13 89 11 56 -3 62 -6 100 -49z"/> <path d="M6901 11563 c-24 -22 -64 -113 -191 -433 -88 -223 -164 -413 -168 -423 -5 -13 -60 90 -201 380 -197 404 -226 453 -276 453 -63 0 -115 -48 -115 -107 0 -14 116 -261 258 -548 274 -552 282 -565 349 -565 17 0 42 11 61 28 28 23 54 80 175 387 l143 360 35 3 35 3 158 -368 c87 -202 167 -378 178 -390 30 -32 71 -38 114 -16 27 13 46 36 74 88 20 39 146 272 279 519 133 247 245 461 248 476 10 52 -40 117 -98 126 -68 11 -91 -18 -232 -281 -294 -549 -310 -577 -317 -564 -4 8 -85 201 -180 429 -185 449 -197 470 -265 470 -24 0 -44 -9 -64 -27z"/> <path d="M9463 11580 c-12 -5 -26 -17 -32 -28 -5 -10 -83 -200 -171 -423 -89 -222 -166 -411 -170 -418 -5 -10 -71 111 -205 380 -108 216 -206 404 -217 416 -29 31 -70 38 -110 19 -34 -17 -68 -61 -68 -90 0 -8 119 -254 265 -546 292 -585 287 -577 370 -565 22 3 47 12 55 20 8 8 82 185 165 393 l150 377 33 0 33 0 103 -240 c56 -132 128 -302 160 -377 49 -115 64 -141 91 -158 39 -24 66 -25 104 -5 33 16 24 1 355 632 248 474 249 477 197 535 -25 28 -36 33 -75 33 -37 0 -51 -5 -75 -30 -16 -16 -120 -201 -232 -410 -111 -209 -208 -388 -214 -398 -11 -16 -25 11 -105 200 -243 571 -282 659 -294 671 -17 17 -84 25 -113 12z"/> <path d="M12028 11574 c-36 -19 -40 -28 -156 -325 -193 -495 -215 -550 -225 -546 -5 1 -96 180 -202 397 -124 254 -202 402 -219 417 -33 28 -71 29 -113 3 -40 -24 -57 -55 -50 -94 3 -17 120 -264 261 -548 222 -451 260 -520 288 -538 18 -11 45 -20 60 -20 59 0 78 34 221 400 75 190 141 357 146 373 8 21 17 27 40 27 15 0 33 -6 38 -12 6 -7 42 -89 81 -183 140 -335 219 -521 236 -552 24 -47 69 -68 116 -54 21 6 42 17 48 24 5 6 136 247 291 533 169 315 281 532 281 548 0 79 -81 133 -153 103 -32 -14 -52 -48 -256 -423 -123 -225 -226 -412 -230 -417 -4 -4 -39 70 -79 165 -39 95 -92 223 -117 283 -26 61 -73 175 -106 255 -78 192 -119 229 -201 184z"/> <path d="M9331 8794 c-364 -44 -709 -183 -1011 -408 -112 -83 -298 -261 -382 -365 -365 -453 -530 -1021 -463 -1593 112 -955 818 -1698 1778 -1870 166 -30 485 -32 662 -4 474 73 915 305 1243 651 507 535 700 1310 507 2029 -74 272 -207 541 -373 751 -74 93 -229 252 -322 329 -454 379 -1044 552 -1639 480z m376 -230 c130 -63 274 -284 371 -569 49 -146 127 -454 117 -464 -2 -2 -73 3 -157 10 -86 8 -278 14 -438 14 -160 0 -352 -6 -438 -14 -84 -7 -156 -11 -159 -7 -11 10 46 249 92 391 123 379 281 610 455 666 37 12 98 2 157 -27z m-621 -70 c17 -25 16 -28 -49 -157 -37 -73 -82 -172 -101 -222 -44 -115 -110 -358 -136 -500 -11 -60 -23 -112 -28 -116 -4 -5 -75 -21 -158 -38 -264 -52 -546 -147 -732 -247 -79 -43 -83 -44 -107 -28 -14 9 -25 23 -25 31 0 26 72 208 127 317 223 449 590 773 1083 957 93 35 105 35 126 3z m1172 -10 c478 -179 848 -511 1065 -954 57 -117 117 -277 117 -310 0 -10 -9 -26 -21 -34 -20 -13 -30 -10 -129 40 -223 111 -441 184 -704 235 -83 17 -155 34 -159 38 -5 5 -17 52 -27 104 -52 269 -144 549 -244 743 l-63 122 20 26 c10 14 25 26 33 26 8 0 59 -16 112 -36z m-428 -1144 c251 -12 397 -29 404 -46 3 -7 12 -104 22 -216 25 -305 9 -941 -25 -1024 -10 -24 -28 -27 -299 -45 -252 -17 -825 -2 -948 26 -19 4 -22 16 -34 127 -21 209 -25 715 -6 926 9 101 16 192 16 201 0 15 17 20 113 30 244 27 492 34 757 21z m-1084 -87 c-12 -41 -27 -241 -32 -448 -6 -210 6 -534 25 -670 5 -33 7 -61 6 -63 -2 -2 -20 1 -42 7 -21 6 -83 20 -138 32 -315 68 -645 220 -787 362 -139 138 -136 269 9 408 175 169 446 285 898 382 48 11 66 7 61 -10z m1847 -7 c371 -81 661 -210 820 -364 144 -140 147 -273 8 -410 -145 -143 -442 -281 -771 -357 -63 -14 -132 -31 -153 -36 -22 -6 -40 -9 -42 -7 -2 2 0 37 5 78 18 166 32 512 26 655 -8 181 -24 412 -31 443 -7 28 -2 28 138 -2z m-2672 -1131 c192 -98 421 -174 710 -235 79 -17 145 -32 146 -34 2 -2 10 -43 19 -92 52 -301 176 -658 294 -848 l20 -33 -28 -26 -27 -26 -105 39 c-230 86 -423 199 -611 358 -243 205 -452 512 -560 824 -34 96 -34 97 -14 112 11 9 26 16 34 16 8 0 63 -25 122 -55z m3506 40 l22 -16 -35 -102 c-190 -549 -604 -968 -1164 -1177 l-105 -39 -26 25 -25 24 65 133 c105 209 179 438 241 741 11 55 22 101 23 102 2 2 67 17 145 33 283 60 556 152 727 245 91 49 102 52 132 31z m-2265 -351 c191 -23 681 -23 881 1 82 9 150 15 153 12 3 -3 1 -22 -5 -44 -6 -21 -25 -99 -42 -173 -99 -422 -273 -740 -454 -829 -202 -100 -427 134 -588 609 -35 105 -90 317 -103 398 -8 50 -22 48 158 26z"/> <path d="M9525 8503 c-119 -62 -258 -287 -350 -566 -43 -130 -90 -315 -83 -322 2 -2 60 0 128 5 163 12 602 12 755 0 65 -5 121 -7 124 -4 8 8 -39 191 -85 333 -136 417 -331 637 -489 554z"/> <path d="M8882 8380 c-337 -140 -629 -383 -829 -687 -80 -122 -216 -403 -195 -403 4 0 53 21 110 46 181 81 464 168 693 214 l55 11 23 121 c43 226 122 470 207 640 24 48 44 90 44 93 0 9 -12 5 -108 -35z"/> <path d="M10210 8416 c0 -3 16 -36 34 -74 49 -97 99 -223 129 -327 27 -93 91 -352 103 -417 3 -21 9 -38 11 -38 19 0 259 -58 363 -87 125 -35 360 -122 438 -162 23 -12 46 -21 51 -21 23 0 -100 256 -186 390 -71 109 -115 163 -227 278 -189 195 -379 326 -610 421 -102 43 -106 44 -106 37z"/> <path d="M9183 7256 c-78 -7 -145 -15 -149 -18 -18 -19 -28 -210 -28 -563 0 -366 10 -546 31 -565 17 -16 306 -34 558 -35 256 0 539 18 561 36 20 16 39 295 39 564 0 255 -19 541 -36 559 -29 31 -685 45 -976 22z"/> <path d="M8515 7150 c-368 -96 -642 -241 -737 -389 -54 -85 -32 -159 75 -257 85 -77 197 -143 349 -204 116 -47 338 -113 421 -127 l37 -6 -7 59 c-10 76 -10 821 0 897 9 69 16 67 -138 27z"/> <path d="M10543 7113 c13 -89 13 -789 0 -876 l-10 -69 44 7 c126 19 415 116 556 186 188 95 317 219 317 306 0 135 -214 301 -535 413 -95 33 -339 100 -366 100 -13 0 -14 -9 -6 -67z"/> <path d="M7871 6008 c147 -378 421 -705 769 -921 122 -75 358 -181 347 -155 -3 7 -30 67 -60 133 -88 196 -163 442 -198 648 l-12 74 -131 28 c-269 58 -501 132 -656 210 -38 19 -72 35 -75 35 -2 0 5 -24 16 -52z"/> <path d="M11260 6021 c-150 -77 -368 -146 -646 -206 l-131 -28 -27 -126 c-62 -281 -136 -511 -218 -675 -16 -32 -28 -60 -26 -62 9 -8 239 100 334 157 243 146 495 395 629 620 83 141 185 360 167 359 -4 -1 -41 -18 -82 -39z"/> <path d="M9090 5730 c0 -22 59 -245 85 -323 87 -257 214 -475 321 -550 56 -39 117 -46 170 -19 102 52 213 209 297 422 62 156 150 462 136 473 -2 2 -35 0 -74 -4 -220 -24 -830 -19 -917 7 -10 3 -18 0 -18 -6z"/> </g> </svg>
                            </a>
                        {/if}
                            </div>
                        </div>
                    </div>
                {/if}

                {#if data.profile.about_me && data.profile.about_me.trim()}
                    <div class="profile-section">
                        <h4 class="font-display">// {$t('profile.info')}</h4>
                        <p class="about-me-text">{data.profile.about_me}</p>
                    </div>
                {/if}
            </div>

            {#if isOwner}
                <div class="profile-actions">
                    <NeonButton href="/profile/edit">{$t('profile.edit')}</NeonButton>
                </div>
            {/if}

            <div class="ticker-wrap">
            <div class="ticker">
                <span>STATUS: ONLINE // SECURITY LEVEL: 5 // BIOMETRICS: SYNCED // LAST UPDATE: {new Date().toLocaleDateString()} // WELCOME USER. </span>
                <span>STATUS: ONLINE // SECURITY LEVEL: 5 // BIOMETRICS: SYNCED // LAST UPDATE: {new Date().toLocaleDateString()} // WELCOME USER. </span>
            </div>
        </div>
            </div>
        </div>

        <div class="comments-container max-w-4xl mx-auto mt-12 pb-32">
    <h4 class="font-display text-2xl text-cyber-yellow mb-6 text-center tracking-widest">// КОММЕНТАРИИ</h4>

    {#if $userStore.user}
        <form on:submit|preventDefault={handleAddComment} class="comment-input-box cyber-panel p-4 mb-8">
            {#if replyingToId}
                <div class="reply-badge" transition:slide>
                    <span>Ответ для: <strong class="text-white">{replyingToName}</strong></span>
                    <button type="button" on:click={cancelReply} class="text-red-400 hover:text-white ml-2">✕</button>
                </div>
            {/if}

            <div class="flex gap-4">
                <div class="comment-avatar-wrapper {$userStore.user.equipped_frame || ''} hidden sm:block">
                     <img src={getOptimizedAvatar($userStore.user.avatar_url)} alt="Me" class="comment-avatar"/>
                </div>
                <div class="flex-grow">
                    <textarea
                        name="commentText"
                        bind:value={commentText}
                        placeholder={replyingToId ? `Ответ для @${replyingToName}...` : $t('profile.comment_placeholder')}
                        class="input-field w-full"
                        rows="2"
                    ></textarea>
                </div>
                <NeonButton type="submit" disabled={isSubmitting} extraClass="self-end h-full">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" /></svg>
                </NeonButton>
            </div>
        </form>
    {:else}
        <!-- Заглушка для гостей -->
    {/if}

    <div class="comments-tree space-y-4">
        {#each data.comments as comment (comment.id)}
            <!-- РОДИТЕЛЬСКИЙ КОММЕНТАРИЙ -->
            <div class="comment-node" transition:fade>
                <div class="comment-card">
                    <!-- Цветной индикатор слева -->
                    <div class="accent-line"></div>

                    <div class="card-content">
                        <!-- ШАПКА: Аватар + Имя + Дата -->
                        <div class="card-header">
                            <div class="author-info">
                                <a href={comment.author_uid ? `/u/${comment.author_uid}` : `/profile/${comment.author_username}`} class="comment-avatar-wrapper {comment.author_equipped_frame || ''}">
                                    <img src={comment.author_uid ? getAvatarUrl($usernameCache, comment.author_uid, comment.author_avatar_url) : getOptimizedAvatar(comment.author_avatar_url)} alt="" class="comment-avatar" />
                                </a>
                                <div class="name-date">
                                    <a href={comment.author_uid ? `/u/${comment.author_uid}` : `/profile/${comment.author_username}`} class="author-name">{comment.author_uid ? getUsername($usernameCache, comment.author_uid, comment.author_username) : comment.author_username}</a>
                                    <span class="time">{formatTimeAgo(comment.createdAt)}</span>
                                </div>
                            </div>

                            <!-- Кнопки управления -->
                            {#if $userStore.user}
                                <div class="controls">
                                    {#if comment.author_uid === $userStore.user.uid || isOwner}
                                         <button on:click={() => handleDeleteComment(comment.id)} class="icon-btn del">
                                            <i class="fas fa-trash"></i>
                                         </button>
                                    {/if}
                                    <button on:click={() => handleReportComment(comment.id, comment.author_username)} class="icon-btn warn">
                                        <i class="fas fa-exclamation-circle"></i>
                                    </button>
                                </div>
                            {/if}
                        </div>

                        <div class="card-body" style="white-space: pre-wrap;">
    {comment.text}
</div>

                        <!-- ПОДВАЛ -->
                        <div class="card-footer">
                            <button class="action-pill like" class:liked={comment.likes.includes($userStore.user?.uid || '')} on:click={() => handleLike(comment.id)}>
                                <i class="fas fa-heart"></i>
                                <span>{comment.likes.length || 0}</span>
                            </button>

                            <button class="action-pill reply" on:click={() => startReply(comment.id, comment.author_username)}>
                                <i class="fas fa-reply"></i>
                                <span>{$t('profile.reply')}</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ВЕТКА ОТВЕТОВ -->
                {#if comment.replies && comment.replies.length > 0}
                    <div class="replies-wrapper">
                        {#each comment.replies as reply (reply.id)}
                            <div class="comment-card reply">
                                <div class="accent-line reply-line"></div>
                                <div class="card-content">
                                    <div class="card-header">
                                        <div class="author-info">
                                            <a href={reply.author_uid ? `/u/${reply.author_uid}` : `/profile/${reply.author_username}`} class="comment-avatar-wrapper small {reply.author_equipped_frame || ''}">
                                                <img src={reply.author_uid ? getAvatarUrl($usernameCache, reply.author_uid, reply.author_avatar_url) : getOptimizedAvatar(reply.author_avatar_url)} alt="" class="comment-avatar" />
                                            </a>
                                            <div class="name-date">
                                                <a href={reply.author_uid ? `/u/${reply.author_uid}` : `/profile/${reply.author_username}`} class="author-name text-sm">{reply.author_uid ? getUsername($usernameCache, reply.author_uid, reply.author_username) : reply.author_username}</a>
                                                <span class="time">{formatTimeAgo(reply.createdAt)}</span>
                                            </div>
                                        </div>
                                        {#if $userStore.user && (reply.author_uid === $userStore.user.uid || isOwner)}
                                            <button on:click={() => handleDeleteComment(reply.id)} class="icon-btn del small">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        {/if}
                                    </div>
                                    <div class="card-body text-sm">
                                        {@html renderMarkdown(reply.text)}
                                    </div>
                                    <div class="card-footer">
                                         <button class="action-pill like small" class:liked={reply.likes.includes($userStore.user?.uid || '')} on:click={() => handleLike(reply.id)}>
                                            <i class="fas fa-heart"></i> {reply.likes.length || 0}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {/each}
                    </div>
                {/if}
            </div>
        {/each}
    </div>
</div>
{/if}


<style>
    @keyframes ticker-scroll {
        0% { transform: translateX(0); }
        100% { transform: translateX(-50%); }
    }
    @keyframes content-fade-in {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes report-pulse {
      0%, 100% {
        transform: scale(1);
        opacity: 0.7;
      }
      50% {
        transform: scale(1.1);
        opacity: 1;
      }
    }

    .profile-container {
        @apply max-w-2xl mx-auto my-10 p-1 sm:p-2 rounded-none shadow-2xl relative;
        padding-bottom: 2rem !important;
        background: #0a0a0a;
        border: 1px solid rgba(252, 238, 10, 0.3);
        clip-path: polygon(0 20px, 20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%);
        overflow: hidden;
        background-image:
            linear-gradient(rgba(10, 10, 10, 0.96), rgba(10, 10, 10, 0.96)),
            linear-gradient(rgba(252, 238, 10, 0.1) 1px, transparent 1px),
            linear-gradient(90deg, rgba(252, 238, 10, 0.1) 1px, transparent 1px);
        background-size: 100% 100%, 30px 30px, 30px 30px;
    }

    .corner-bg { @apply absolute w-16 h-16 opacity-15 blur-sm; background: radial-gradient(circle, var(--cyber-yellow, #fcee0a) 0%, rgba(252, 238, 10, 0) 60%); }
    .top-left { top: -30px; left: -30px; }
    .top-right { top: -30px; right: -30px; }
    .bottom-left { bottom: -30px; left: -30px; }
    .bottom-right { bottom: -30px; right: -30px; }

    .top-bar {
        @apply relative flex items-center justify-between p-2 text-xs uppercase tracking-widest text-cyber-yellow/70;
        border-bottom: 1px solid var(--border-color);
        padding-right: 3.5rem;
    }

    .profile-header, .profile-content, .profile-actions { animation: content-fade-in 0.5s ease-out both; }
    .profile-content { animation-delay: 0.2s; }
    .profile-actions { animation-delay: 0.4s; }

    .profile-header { @apply flex flex-col items-center text-center p-6; }
    .profile-avatar { @apply w-32 h-32 rounded-full object-cover mb-4; border: 4px solid var(--cyber-yellow); box-shadow: 0 0 20px var(--cyber-yellow); }
    .profile-username { @apply text-4xl font-bold text-white break-words; }

    .profile-content { @apply p-6 text-left; }
    .profile-section { @apply pb-6 mb-6; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    .profile-content > .profile-section:last-of-type { border-bottom: none; padding-bottom: 0; margin-bottom: 0; }
    .profile-section h4 { @apply mb-2 text-sm font-bold uppercase tracking-widest text-cyber-yellow; }
    .about-me-text { @apply whitespace-pre-wrap leading-relaxed text-gray-200; }

    .social-links-grid { @apply flex flex-wrap justify-center gap-4 mt-4 content-center; }
    .social-link-btn { @apply w-14 h-14 flex items-center justify-center rounded-full text-gray-400 bg-gray-900/50 border border-gray-700; transition: all 0.2s ease-in-out; }
    .social-link-btn:hover { @apply text-white border-cyber-yellow scale-110; box-shadow: 0 0 15px var(--cyber-yellow, #fcee0a); }

    .profile-actions { @apply p-6 text-center border-t border-gray-800; }

    .ticker-wrap { @apply absolute bottom-0 left-0 w-full p-2 overflow-hidden text-xs uppercase tracking-wider; background: var(--bg-color); border-top: 1px solid var(--border-color); }
    .ticker { @apply inline-block whitespace-nowrap; animation: ticker-scroll 30s linear infinite; }

    .comments-container {
        @apply mt-12 max-w-4xl mx-auto pb-32;
    }
    .comments-container h4 {
        @apply text-2xl text-center mb-6;
    }

    .add-comment-form { @apply flex items-start gap-4 mb-8; }
    .comment-avatar { @apply w-12 h-12 rounded-full object-cover border-2 border-gray-600 shrink-0; }
    .add-comment-form .comment-avatar { @apply border-cyber-yellow; }

    .input-field { @apply block w-full p-2 bg-transparent text-gray-200 resize-none rounded-none; border: none; border-bottom: 1px solid var(--border-color, #30363d); font-family: 'Inter', sans-serif; font-size: 1em; transition: border-color 0.3s, box-shadow 0.3s; }
    .input-field:focus { @apply outline-none border-cyber-yellow; box-shadow: 0 1px 0 var(--cyber-yellow, #fcee0a); }

    .error-message-small { @apply text-red-400 text-sm mt-1; }
    .comments-list { @apply mt-6 space-y-6; }
    .comment-card { @apply flex items-start gap-4; }
    .comment-header { @apply flex items-baseline gap-3 mb-1; }
    .comment-author { @apply font-bold text-white hover:text-cyber-yellow transition-colors; }
    .comment-time { @apply text-xs text-gray-500; }
    .comment-text { @apply whitespace-pre-wrap text-gray-300; }
    .comment-actions { @apply mt-2; }
    .action-btn { @apply text-xs text-gray-500 hover:text-red-400 transition-colors; }

    .report-icon-btn {
        @apply absolute top-1 right-2 z-20 p-2 rounded-full;
        color: var(--cyber-red, #ff003c);
        animation: report-pulse 2.5s infinite cubic-bezier(0.4, 0, 0.6, 1);
        transition: all 0.2s ease-in-out;
    }
    .report-icon-btn:hover {
        background-color: rgba(255, 0, 60, 0.25);
        color: #ff4d6d;
        transform: scale(1.2);
        animation-play-state: paused;
        box-shadow: 0 0 15px var(--cyber-red, #ff003c);
    }
    .report-icon-btn:focus-visible {
        @apply outline-none ring-2 ring-offset-2 ring-offset-black ring-red-500;
    }

    .top-bar::before {
        content: '';
        @apply absolute top-1/2 left-2 w-2 h-2 rounded-full bg-cyber-yellow;
        transform: translateY(-50%);
        box-shadow: 0 0 5px var(--cyber-yellow);
    }
 .avatar-wrapper {
    position: relative;
    display: inline-block;
    border-radius: 50%;
    line-height: 0;
}

.profile-avatar {
    @apply w-32 h-32 rounded-full object-cover;
    box-shadow: none;
    border: none;
}
.add-comment-form .comment-avatar { @apply border-cyber-yellow; }

.comment-avatar-wrapper {
        position: relative;
        flex-shrink: 0;
        width: 48px;
        height: 48px;
        border-radius: 50%;
    }
    .comment-avatar {
        @apply w-12 h-12 rounded-full object-cover;
        border: none;
    }
    .private-section {
        background: rgba(255, 255, 255, 0.02);
        border: 1px dashed rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 1rem !important; /* Перебиваем паддинг родителя если надо */
        margin-bottom: 1.5rem;
    }

    .email-control {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 0.5rem;
    }

    .verified-badge {
        display: inline-flex; align-items: center; gap: 4px;
        background: rgba(57, 255, 20, 0.1);
        border: 1px solid #39ff14;
        color: #39ff14;
        font-size: 0.7rem; font-weight: bold;
        padding: 4px 8px; border-radius: 4px;
        font-family: 'Chakra Petch', monospace;
        cursor: help;
        box-shadow: 0 0 10px rgba(57, 255, 20, 0.2);
    }

    .unverified-btn {
        background: rgba(255, 215, 0, 0.1);
        border: 1px solid var(--cyber-yellow);
        color: var(--cyber-yellow);
        font-size: 0.7rem; font-weight: bold;
        padding: 4px 10px; border-radius: 4px;
        font-family: 'Chakra Petch', monospace;
        cursor: pointer; transition: all 0.2s;
        animation: blink-border 2s infinite;
    }
    .unverified-btn:hover {
        background: var(--cyber-yellow);
        color: #000;
        box-shadow: 0 0 15px var(--cyber-yellow);
    }
    .unverified-btn:disabled {
        opacity: 0.5; cursor: not-allowed; animation: none; filter: grayscale(1);
    }

    @keyframes blink-border {
        0%, 100% { box-shadow: 0 0 2px var(--cyber-yellow); }
        50% { box-shadow: 0 0 8px var(--cyber-yellow); }
    }
    .verified-badge {
    position: relative;
    display: inline-flex; align-items: center; gap: 4px;
    background: rgba(57, 255, 20, 0.1);
    border: 1px solid #39ff14;
    color: #39ff14;
    font-size: 0.7rem; font-weight: bold;
    padding: 4px 8px; border-radius: 4px;
    font-family: 'Chakra Petch', monospace;
    cursor: help;
    box-shadow: 0 0 10px rgba(57, 255, 20, 0.2);
}

.verified-tooltip {
    position: absolute;
    bottom: 130%;
    left: 50%;
    transform: translateX(-50%) translateY(5px);
    width: 180px;
    background: rgba(5, 10, 5, 0.95);
    border: 1px solid #39ff14;
    color: #ccc;
    padding: 0.6rem;
    border-radius: 4px;
    font-size: 0.65rem;
    line-height: 1.3;
    font-family: 'Inter', sans-serif;
    font-weight: normal;
    text-align: center;
    text-transform: none;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);

    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 50;
}

.verified-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: #39ff14 transparent transparent transparent;
}

.verified-badge:hover .verified-tooltip {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
}
.profile-backdrop {
    position: fixed;
    top: 0; left: 0; width: 100vw; height: 100vh;
    z-index: -1;
    pointer-events: none;
}
.cyber-glass {
        background: rgba(20, 25, 30, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(5px);
        border-radius: 8px;
        transition: border-color 0.2s;
    }
    .cyber-glass:hover { border-color: rgba(255, 255, 255, 0.15); }

    .comment-card { padding: 1rem; position: relative; }
    .comment-card.reply {
        margin-top: 0.5rem;
        background: rgba(255, 255, 255, 0.03);
        border-left: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 0 8px 8px 0;
    }

    .replies-branch {
        margin-left: 2rem; /* Отступ ветки */
        border-left: 1px dashed rgba(255, 255, 255, 0.1); /* Линия ветки */
        padding-left: 1rem;
        margin-top: 0.5rem;
    }

    .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
    .author-name { font-weight: bold; color: #fff; font-family: 'Chakra Petch', sans-serif; }
    .group:hover .author-name { color: var(--cyber-yellow); }
    .time { color: #555; font-size: 0.75rem; margin-left: 0.5rem; }

    .card-body { color: #d1d5db; line-height: 1.5; word-wrap: break-word; }

    .card-footer {
        margin-top: 0.8rem; display: flex; gap: 1rem; align-items: center;
        border-top: 1px solid rgba(255,255,255,0.05); padding-top: 0.5rem;
    }

    /* Анимация удара сердца */
    @keyframes heart-pop {
        0% { transform: scale(1); }
        50% { transform: scale(1.3); }
        100% { transform: scale(1); }
    }

    /* === КНОПКА ЛАЙКА (CYBER HEARTBURST) === */
    .like-btn {
        position: relative; /* Для позиционирования волны */
        display: flex; align-items: center; gap: 6px;
        color: #64748b; font-size: 0.85rem; font-weight: bold;
        background: none; border: none; cursor: pointer;
        padding: 4px 8px; border-radius: 4px;
        transition: color 0.3s;
        overflow: visible; /* Чтобы волна выходила за пределы */
    }

    .like-btn:hover { background: rgba(255,255,255,0.08); color: #fff; }

    .like-btn svg {
        transition: fill 0.3s ease;
        transform-origin: center;
    }

    /* АКТИВНОЕ СОСТОЯНИЕ */
    .like-btn.liked {
        color: #ff003c;
        text-shadow: 0 0 12px rgba(255, 0, 60, 0.6);
    }

    .like-btn.liked svg {
        fill: currentColor;
        /* Запускаем анимацию сердца */
        animation: cyber-heart-bounce 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }

    /* ЭФФЕКТ УДАРНОЙ ВОЛНЫ (SHOCKWAVE) */
    .like-btn.liked::before {
        content: '';
        position: absolute;
        top: 50%; left: 16px; /* Центрируем относительно иконки */
        width: 10px; height: 10px;
        border-radius: 50%;
        border: 2px solid #ff003c;
        opacity: 0;
        transform: translate(-50%, -50%) scale(0);
        /* Запускаем анимацию волны */
        animation: ripple-blast 0.6s ease-out;
        pointer-events: none;
    }

    /* АНИМАЦИЯ 1: ПУЛЬСАЦИЯ СЕРДЦА */
    @keyframes cyber-heart-bounce {
        0% { transform: scale(1); }
        30% { transform: scale(0.6); } /* Сжатие */
        50% { transform: scale(1.4); filter: brightness(1.5) drop-shadow(0 0 5px #ff003c); } /* Взрыв */
        100% { transform: scale(1); }
    }

    /* АНИМАЦИЯ 2: РАСХОЖДЕНИЕ КОЛЬЦА */
    @keyframes ripple-blast {
        0% { transform: translate(-50%, -50%) scale(0); opacity: 1; border-width: 4px; }
        100% { transform: translate(-50%, -50%) scale(4); opacity: 0; border-width: 0px; }
    }

    .controls { display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0; }
    .icon-btn { color: #444; padding: 0 4px; font-weight: bold; transition: color 0.2s; }
    .icon-btn:hover { color: #fff; }
    .icon-btn.del:hover { color: #ff003c; }

    .reply-badge {
        background: rgba(0, 243, 255, 0.1); border: 1px solid var(--cyber-cyan);
        color: var(--cyber-cyan); padding: 0.3rem 0.8rem; border-radius: 4px;
        font-size: 0.8rem; margin-bottom: 0.5rem; display: inline-flex; align-items: center;
    }

    /* === ОСНОВНОЙ КОНТЕЙНЕР === */
    .comments-container {
        @apply mt-12 max-w-4xl mx-auto pb-32;
    }

    /* === КАРТОЧКА === */
    .comment-node { margin-bottom: 1.5rem; }

    .comment-card {
        position: relative;
        background: linear-gradient(180deg, rgba(30, 35, 45, 0.7) 0%, rgba(20, 25, 30, 0.9) 100%);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
        display: flex;
    }

    .comment-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        border-color: rgba(255, 255, 255, 0.15);
    }

    /* Цветная линия слева (Акцент) */
    .accent-line {
        width: 4px;
        background: var(--cyber-yellow);
        box-shadow: 2px 0 10px var(--cyber-yellow);
        flex-shrink: 0;
    }

    .reply-line {
        background: var(--cyber-cyan); /* Другой цвет для ответов */
        box-shadow: 2px 0 10px var(--cyber-cyan);
    }

    .card-content {
        padding: 1rem 1.5rem;
        flex-grow: 1;
        min-width: 0;
    }

    /* === ШАПКА === */
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.8rem;
    }

    .author-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .name-date {
        display: flex;
        flex-direction: column;
        line-height: 1.2;
    }

    .author-name {
        font-family: 'Chakra Petch', sans-serif;
        font-weight: 700;
        font-size: 1rem;
        color: #fff;
        text-decoration: none;
        transition: color 0.2s;
    }
    .author-name:hover { color: var(--cyber-yellow); }

    .time {
        font-size: 0.75rem;
        color: #64748b;
        font-family: monospace;
    }

    /* АВАТАР */
    .comment-avatar-wrapper {
        position: relative;
        width: 42px; height: 42px;
        flex-shrink: 0;
        border-radius: 50%;
    }
    .comment-avatar-wrapper.small {
        width: 32px; height: 32px;
    }

    .comment-avatar {
        width: 100%; height: 100%;
        border-radius: 50%;
        object-fit: cover;
        background: #111;
        position: relative;
        z-index: 2;
    }

    /* === ТЕКСТ === */
    .card-body {
        color: #e2e8f0;
        font-size: 0.95rem;
        line-height: 1.6;
        margin-bottom: 1rem;
    }
    .card-body :global(a) { color: var(--cyber-cyan); text-decoration: underline; }

    /* === ФУТЕР И КНОПКИ === */
    .card-footer {
        display: flex;
        gap: 0.8rem;
    }

    /* Стильные "таблетки" кнопок */
    .action-pill {
        display: flex; align-items: center; gap: 6px;
        padding: 6px 12px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 6px;
        color: #94a3b8;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .action-pill:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
    }

    .action-pill.like:hover, .action-pill.like.liked {
        color: #ff003c;
        border-color: rgba(255, 0, 60, 0.3);
        background: rgba(255, 0, 60, 0.1);
    }

    .action-pill.reply:hover {
        color: var(--cyber-cyan);
        border-color: rgba(0, 243, 255, 0.3);
        background: rgba(0, 243, 255, 0.1);
    }

    .action-pill.small { padding: 4px 8px; font-size: 0.75rem; }

    /* Управление (удалить/репорт) */
    .icon-btn {
        color: #444; background: none; border: none; cursor: pointer; transition: color 0.2s;
    }
    .icon-btn:hover { color: #fff; }
    .icon-btn.del:hover { color: #ff003c; }

    /* ОТВЕТЫ */
    .replies-wrapper {
        margin-left: 3rem; /* Сдвигаем ветку */
        margin-top: 0.5rem;
        display: flex; flex-direction: column; gap: 0.5rem;
        border-left: 2px solid rgba(255,255,255,0.05); /* Линия соединения */
        padding-left: 1rem;
    }

    .comment-card.reply {
        background: rgba(0, 0, 0, 0.4);
        border-radius: 8px;
        padding: 0;
        border: 1px solid rgba(255,255,255,0.05);
    }
    .comment-card.reply .card-content { padding: 0.8rem 1rem; }

    @media (max-width: 640px) {
        .replies-wrapper { margin-left: 1rem; padding-left: 0.5rem; }
        .card-content { padding: 1rem; }
        .action-pill span { display: none; } /* Скрываем текст кнопок на мобиле, оставляем иконки */
        .action-pill i { margin-right: 0; }
        .action-pill.like span { display: inline; } /* Но счетчик лайков оставляем */
    }
    /* === ФОРМА ВВОДА (TECH CONSOLE) === */
    .comment-input-box {
        position: sticky;
        bottom: 2rem;
        z-index: 50; /* Поверх остальных элементов при скролле */

        display: flex;
        flex-direction: column;
        gap: 0.8rem;

        /* Темный технологичный фон */
        background: rgba(13, 15, 20, 0.95);
        backdrop-filter: blur(12px);

        /* Тонкая рамка */
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-top: 1px solid rgba(255, 255, 255, 0.15); /* Блик сверху */

        border-radius: 16px;
        padding: 1.25rem;

        /* Глубокая тень, чтобы отделить от контента снизу */
        box-shadow:
            0 20px 40px rgba(0, 0, 0, 0.8),
            0 0 0 1px rgba(0, 0, 0, 0.5);

        transition: transform 0.3s, border-color 0.3s;
    }

    /* Подсветка всей коробки при фокусе */
    .comment-input-box:focus-within {
        border-color: rgba(0, 243, 255, 0.3);
        box-shadow:
            0 20px 50px rgba(0, 0, 0, 0.9),
            0 0 20px rgba(0, 243, 255, 0.05);
    }

    /* Поле ввода */
    .input-field {
        width: 100%;
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.05);
        color: #fff;
        padding: 1rem;
        border-radius: 8px;
        font-family: 'Inter', sans-serif;
        font-size: 0.95rem;
        line-height: 1.5;
        resize: none; /* Убираем уголок растягивания (или vertical) */
        transition: all 0.2s ease-in-out;
    }

    .input-field::placeholder {
        color: #555;
        font-family: 'Chakra Petch', monospace;
        letter-spacing: 0.05em;
    }

    .input-field:focus {
        outline: none;
        background: rgba(0, 0, 0, 0.6);
        border-color: var(--cyber-cyan);
        /* Внутреннее свечение */
        box-shadow: inset 0 0 15px rgba(0, 243, 255, 0.05);
    }

    /* Плашка ответа (всплывает сверху) */
    .reply-badge {
        background: linear-gradient(90deg, rgba(0, 243, 255, 0.1), transparent);
        border-left: 3px solid var(--cyber-cyan);
        padding: 0.6rem 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        font-size: 0.85rem;
        color: var(--cyber-cyan);
        border-radius: 4px;
        font-family: 'Chakra Petch', monospace;
        animation: slide-in 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
    }

    @keyframes slide-in {
        0% { opacity: 0; transform: translateY(10px); }
        100% { opacity: 1; transform: translateY(0); }
    }

    /* Адаптация кнопки внутри формы */
    .comment-input-box :global(.neon-btn) {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 1.5rem !important; /* Больше воздуха по бокам */
        border-radius: 8px;
    }

    /* Мобилка */
    @media (max-width: 640px) {
        .comment-input-box {
            padding: 1rem;
            bottom: 1rem; /* Чуть выше дна экрана */
            border-radius: 12px;
        }
        /* Скрываем аватарку слева на мобиле, чтобы сэкономить место */
        .comment-input-box .comment-avatar-wrapper {
            display: none;
        }
        .input-field {
            font-size: 16px; /* Фикс зума на айфоне */
        }
    }
</style>
</file>

<file path="static/protogen_pin_map.svg">
<svg width="1352" height="1234" viewBox="0 0 1352 1234" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M432.923 0.658243C431.178 1.12524 429.034 5.05625 429.033 7.79325C429.033 8.73025 427.643 12.4213 425.945 15.9963C424.248 19.5713 422.055 24.5213 421.073 26.9963C420.09 29.4713 417.274 36.4463 414.814 42.4963C399.797 79.4263 391.558 113.09 385.935 160.496C382.628 188.379 386.365 240.404 394.564 280.611C395.922 287.274 397.034 293.435 397.034 294.303C397.034 296.173 389.358 312.512 387.652 314.274C387.001 314.946 385.382 317.071 384.053 318.996C356.57 358.832 300.282 365.627 252.034 334.934C238.388 326.253 228.393 327.759 228.685 338.451C229.521 369.003 244.6 410.5 262.669 431.974C264.357 433.98 264.966 435.422 264.3 435.836C262.856 436.733 253.344 450.075 248.717 457.694C244.651 464.389 237.086 480.25 232.595 491.496C231.058 495.346 229.431 499.396 228.979 500.496C225.482 509.013 219.005 531.124 210.522 563.496C206.343 579.446 202.31 594.296 201.56 596.496C200.809 598.696 198.973 604.546 197.479 609.496C193.907 621.331 189.848 633.516 185.987 643.996C184.265 648.671 182.5 653.621 182.066 654.996C176.453 672.761 156.672 709.586 145.839 722.437C143.11 725.674 131.365 737.595 127.937 740.608C122.381 745.491 104.756 755.565 95.5343 759.129C90.5503 761.055 84.9913 761.985 78.4373 761.99C69.9853 761.997 64.1033 766.227 64.0183 772.36C63.9073 780.427 69.9692 785.035 87.1312 789.93C95.0532 792.189 104.347 795.221 107.784 796.667L114.034 799.296V804.611C114.034 836.9 92.1513 879.317 63.5353 902.496C61.4983 904.146 59.1333 906.171 58.2783 906.996C50.6213 914.388 14.1333 934.996 8.70226 934.996C7.87926 934.996 5.59226 936.563 3.62026 938.478C-3.96874 945.848 0.0772495 953.97 18.5712 968.496C20.6722 970.146 23.1393 972.212 24.0543 973.087C26.5803 975.505 36.5993 981.996 37.8043 981.996C38.3893 981.996 47.8653 990.883 58.8623 1001.75C80.5513 1023.17 92.1302 1033.98 101.431 1041.5C103.473 1043.15 106.582 1045.78 108.339 1047.35C110.096 1048.92 113.094 1051.39 115.001 1052.85C116.908 1054.31 119.225 1056.17 120.15 1057C124.648 1061.01 127.129 1063.02 134.362 1068.53C138.667 1071.81 144.038 1075.73 146.297 1077.24C148.555 1078.74 150.658 1080.35 150.969 1080.8C151.28 1081.26 153.774 1083.15 156.511 1085.02C159.249 1086.88 162.174 1088.96 163.011 1089.65C171.984 1096.96 231.992 1133.77 249.034 1142.42C265.271 1150.65 286.097 1161 286.445 1161C286.68 1161 292.1 1163.47 298.49 1166.5C304.879 1169.52 310.503 1172 310.989 1172C311.475 1172 313.146 1172.65 314.703 1173.44C317.709 1174.97 333.537 1181.31 343.534 1184.99C346.834 1186.2 350.434 1187.55 351.534 1187.99C352.634 1188.43 355.109 1189.34 357.034 1190C358.959 1190.66 361.434 1191.58 362.534 1192.06C376.721 1198.15 436.031 1214.41 464.034 1219.89C564.364 1239.54 660.558 1238.16 746.034 1215.86C763.998 1211.17 791.098 1202.43 801.534 1197.95C802.634 1197.48 807.436 1195.52 812.204 1193.58C835.05 1184.33 880.614 1159.41 891.034 1150.47C892.409 1149.29 895.671 1147.02 898.282 1145.41C900.894 1143.81 903.031 1142.2 903.032 1141.83C903.033 1141.46 904.531 1140.23 906.36 1139.1C908.189 1137.97 910.841 1136.02 912.254 1134.77C913.666 1133.52 916.743 1130.92 919.091 1129C921.439 1127.07 924.975 1123.73 926.947 1121.57C935.126 1112.62 943.355 1105.1 947.956 1102.38C949.649 1101.38 951.034 1100.25 951.034 1099.87C951.034 1099.49 953.847 1097.35 957.284 1095.12C966.581 1089.09 967.158 1088.49 967.726 1084.26C968.588 1077.83 962.204 1072.03 951.034 1069.08C929.645 1063.43 892.646 1044.49 883.534 1034.52C882.984 1033.92 880.965 1032.32 879.048 1030.97C877.13 1029.63 874.835 1027.84 873.948 1027.01C873.061 1026.18 871.479 1024.78 870.434 1023.89C862.333 1017.06 844.698 994.843 838.367 983.496C823.031 956.009 814.364 926.543 816.66 909.694L817.534 903.28L838.034 907.993C849.309 910.585 868.884 915.053 881.534 917.921C894.184 920.789 907.234 923.764 910.534 924.533C913.834 925.302 923.734 927.551 932.534 929.529C941.334 931.508 952.134 933.967 956.534 934.994C960.934 936.021 973.759 938.946 985.034 941.494C1025.48 950.633 1049.64 956.124 1055.53 957.524C1114.05 971.406 1113.22 971.402 1145.53 957.957C1206.5 932.594 1273.49 896.663 1302.03 874.025C1305.39 871.36 1311.57 866.733 1316.94 862.864C1319.36 861.117 1322.1 858.97 1323.04 858.092C1323.97 857.214 1327.57 854.021 1331.04 850.996C1347.23 836.885 1355.38 823.8 1350.03 820.496C1349.48 820.156 1349.03 818.756 1349.03 817.384C1349.03 816.012 1347.91 813.234 1346.53 811.211C1345.16 809.187 1344.03 807.242 1344.03 806.889C1344.03 806.095 1318.06 764.69 1317.13 763.996C1316.76 763.721 1314.26 760.121 1311.58 755.996C1308.91 751.871 1306.4 748.271 1306.01 747.996C1305.62 747.721 1303.64 745.021 1301.62 741.996C1296.44 734.279 1291.79 727.595 1289.29 724.304C1288.12 722.76 1284.87 718.346 1282.08 714.496C1279.28 710.646 1276.18 706.596 1275.19 705.496C1274.2 704.396 1272.54 702.034 1271.49 700.246C1270.45 698.459 1269.31 696.996 1268.95 696.996C1268.59 696.996 1267.1 695.186 1265.64 692.973C1264.17 690.761 1262.34 688.173 1261.57 687.223C1260.79 686.273 1258.53 683.471 1256.53 680.996C1254.54 678.521 1251.92 675.321 1250.72 673.884C1249.52 672.447 1247.18 669.604 1245.53 667.565C1243.88 665.527 1241.63 662.845 1240.53 661.607C1239.43 660.368 1237.41 657.843 1236.03 655.996C1234.66 654.149 1232.63 651.624 1231.53 650.385C1230.43 649.147 1228.18 646.464 1226.53 644.424C1222.69 639.669 1218.45 634.767 1214.03 629.979C1212.11 627.889 1208.51 623.804 1206.03 620.9C1203.56 617.996 1200.41 614.407 1199.03 612.925C1197.66 611.443 1194.51 607.905 1192.03 605.062C1187.48 599.829 1186.02 598.25 1164.53 575.353C1151.06 560.988 1090.05 500.057 1076.06 486.996C1062.8 474.611 1056.29 468.534 1046.03 458.996C1041.01 454.321 1034.26 448.021 1031.04 444.996C1025.87 440.144 1015.06 430.305 1008.51 424.496C1007.27 423.396 1004.6 421.146 1002.57 419.496C1000.55 417.846 997.874 415.596 996.624 414.496C995.374 413.396 992.674 411.146 990.624 409.496C988.574 407.846 985.886 405.596 984.651 404.496C983.416 403.396 980.013 400.471 977.089 397.996C974.164 395.521 970.752 392.596 969.506 391.496C964.781 387.327 961.249 384.337 952.034 376.707C946.809 372.381 941.359 367.864 939.922 366.669C938.485 365.474 935.61 363.146 933.532 361.496C931.454 359.846 929.023 357.815 928.13 356.982C927.237 356.15 924.938 354.372 923.02 353.031C921.103 351.69 919.261 350.199 918.927 349.717C918.594 349.236 917.174 348.089 915.773 347.169C912.59 345.078 898.224 334.176 895.534 331.809C892.992 329.573 877.818 318.196 873.519 315.303C871.726 314.097 869.018 311.959 867.501 310.553C865.983 309.147 864.4 307.996 863.983 307.996C863.565 307.996 861.268 306.408 858.879 304.468C833.913 284.196 829.362 278.348 830.32 267.774C832.543 243.261 862.792 222.328 891.395 225.508C904.204 226.932 918.493 230.811 920.183 233.322C921.795 235.718 933.034 230.458 933.034 227.308C933.034 226.586 933.484 225.996 934.034 225.996C938.425 225.996 929.108 208.711 919.291 198.643C903.583 182.533 882.936 177.29 839.081 178.273C808.606 178.956 790.264 183.785 767.4 197.146C759.016 202.046 759.516 203.265 760.885 181.255C765.121 113.158 765.366 116.14 755.134 111.111C742.986 105.14 716.568 131.035 699.396 165.746C697.968 168.634 696.692 170.996 696.562 170.996C696.136 170.996 688.034 159.196 688.034 158.577C688.034 158.247 685.634 154.268 682.7 149.736C679.767 145.204 674.817 137.563 671.7 132.756C668.584 127.949 666.034 123.782 666.034 123.496C666.034 123.21 663.484 119.043 660.368 114.236C657.252 109.429 652.189 101.53 649.118 96.6833C646.047 91.8363 641.276 84.4113 638.516 80.1833C635.756 75.9553 632.845 71.2153 632.045 69.6493C626.832 59.4343 614.888 59.7233 609.439 70.1963C606.283 76.2623 610.299 173.332 614.664 196.496L615.229 199.496L613.223 197.496C612.119 196.396 606.787 190.269 601.375 183.881C595.962 177.492 585.449 165.342 578.013 156.881C570.576 148.419 558.426 134.321 551.013 125.552C537.484 109.549 497.098 63.2603 474.583 37.9523C467.956 30.5023 458.174 19.2022 452.846 12.8392C442.344 0.299243 439.888 -1.20276 432.923 0.658243ZM447.873 30.4423C451.828 35.0883 462.549 47.3503 471.697 57.6923C524.615 117.52 523.507 115.805 539.056 161.996C546.522 184.173 572.666 277.698 571.676 278.687C570.024 280.339 545.16 251.723 539.852 242.06C536.075 235.183 530.049 233.132 528.653 238.246C523.04 258.808 532.647 300.385 550.751 333.876L555.281 342.256L545.019 336.89C539.375 333.939 533.584 330.28 532.149 328.76C526.163 322.417 519.601 325.283 520.679 333.77C524.15 361.117 536.154 396.1 549.816 418.686L554.77 426.875L536.743 413.248C511.478 394.15 479.745 364.743 459.914 342.05C441.813 321.336 438.372 317.147 426.894 301.85C407.359 275.816 407.907 277.436 403.125 231.496C395.832 161.432 406.747 96.4763 437.363 27.7463C440.497 20.7103 439.331 20.4113 447.873 30.4423ZM636.002 115.256C636.019 115.674 638.434 119.724 641.368 124.256C644.301 128.788 649.251 136.429 652.368 141.236C655.484 146.043 658.034 150.249 658.034 150.582C658.034 150.914 660.509 154.78 663.534 159.171C666.559 163.563 669.034 167.447 669.034 167.804C669.034 168.435 675.148 178.008 685.784 194.031C688.672 198.38 691.034 202.181 691.034 202.477C691.034 202.773 693.509 206.836 696.534 211.506C699.559 216.175 704.509 223.817 707.534 228.486C710.559 233.156 713.034 237.249 713.034 237.582C713.034 237.914 715.509 241.78 718.534 246.171C721.559 250.563 724.034 254.447 724.034 254.804C724.034 255.435 730.148 265.008 740.784 281.031C743.672 285.38 746.034 289.181 746.034 289.477C746.034 289.981 747.796 292.759 762.368 315.236C765.484 320.043 768.034 324.21 768.034 324.496C768.034 324.782 770.582 328.949 773.697 333.756C780.82 344.75 789.487 358.314 794.034 365.582C811.498 393.498 822.491 375.688 821.949 320.359C821.668 291.761 821.658 291.775 833.136 304.701C839.435 311.796 860.937 330.607 880.534 346.168C886.034 350.536 891.434 354.87 892.534 355.8C893.634 356.73 897.453 359.662 901.021 362.317C904.588 364.971 907.738 367.469 908.021 367.868C908.303 368.266 910.103 369.69 912.02 371.031C913.938 372.372 916.234 374.15 917.122 374.982C919.111 376.846 923.65 380.624 928.146 384.16C930.01 385.625 932.514 387.65 933.712 388.66C934.909 389.67 937.568 391.846 939.62 393.496C941.672 395.146 944.425 397.467 945.739 398.653C947.052 399.84 949.984 402.315 952.254 404.153C954.524 405.992 957.091 408.189 957.958 409.036C958.825 409.883 962.459 413.015 966.034 415.996C969.609 418.977 973.271 422.109 974.171 422.956C975.072 423.803 977.506 425.846 979.58 427.496C981.654 429.146 984.356 431.396 985.584 432.496C986.812 433.596 989.472 435.846 991.494 437.496C997.857 442.687 1010.18 453.708 1020 462.996C1023.19 466.021 1029.93 472.321 1034.98 476.996C1051.2 492.036 1055.72 496.272 1068.59 508.496C1084.43 523.526 1131.3 570.358 1144.3 584.143C1149.67 589.837 1157.55 598.175 1161.8 602.672C1166.05 607.169 1171.56 613.216 1174.03 616.109C1176.51 619.003 1180.33 623.269 1182.53 625.59C1184.73 627.911 1187.88 631.476 1189.53 633.512C1191.18 635.547 1193.43 638.215 1194.53 639.44C1195.63 640.665 1198.56 643.919 1201.03 646.67C1203.51 649.422 1206.88 653.351 1208.53 655.403C1210.18 657.455 1212.43 660.147 1213.53 661.385C1214.63 662.624 1216.66 665.149 1218.03 666.996C1219.41 668.843 1221.43 671.368 1222.53 672.607C1223.63 673.845 1225.88 676.536 1227.53 678.586C1229.18 680.636 1231.43 683.331 1232.53 684.576C1233.63 685.82 1236.33 689.192 1238.53 692.069C1240.73 694.946 1243.21 698.027 1244.03 698.915C1244.86 699.802 1246.4 701.872 1247.45 703.513C1248.5 705.153 1250.18 707.396 1251.17 708.496C1252.16 709.596 1256.62 715.446 1261.08 721.496C1265.53 727.546 1270.14 733.767 1271.31 735.321C1274.65 739.738 1279.74 746.983 1283.72 752.996C1285.72 756.021 1287.72 758.737 1288.16 759.031C1288.6 759.325 1290.77 762.25 1292.98 765.531C1295.19 768.812 1299.68 775.321 1302.95 779.996C1306.22 784.671 1310.56 790.971 1312.59 793.996C1314.63 797.021 1318.39 802.196 1320.95 805.496C1331.99 819.696 1332.57 825.442 1323.64 831.935C1322.55 832.727 1320.94 834.077 1320.06 834.935C1319.19 835.794 1316.68 837.822 1314.5 839.443C1312.32 841.064 1310.31 842.701 1310.03 843.081C1309.76 843.461 1306.33 845.96 1302.42 848.634C1298.5 851.308 1292.75 855.256 1289.64 857.408C1284.83 860.729 1283.11 861.348 1278.25 861.507C1275.11 861.611 1260.61 864.209 1246.03 867.282C1204.54 876.029 1166.3 883.946 1157.37 885.637L1149.2 887.182L1101.87 861.779C1075.84 847.807 1053.86 836.122 1053.03 835.813C1051.94 835.403 1051.02 831.59 1049.67 821.873C1045.64 793.055 1050.79 793.346 988.534 818.413C944.269 836.237 940.408 837.614 938.915 836.118C938.024 835.226 933.031 828.196 927.819 820.496C922.607 812.796 913.911 799.971 908.495 791.996C903.079 784.021 896.92 774.908 894.809 771.746C892.697 768.584 890.534 765.996 890.002 765.996C889.469 765.996 889.034 765.341 889.034 764.541C889.034 759.846 880.458 761.74 869.913 768.764C865.855 771.468 858.709 776.16 854.034 779.192C834.852 791.633 823.994 798.704 814.145 805.173C808.431 808.926 803.388 811.996 802.94 811.996C801.102 811.996 800.87 818.779 802.594 822.125C813.355 843.004 812.464 843.005 846.829 822.045C861.212 813.273 873.849 805.63 874.91 805.062C876.982 803.953 876.376 803.141 895.174 832.223C911.834 857.999 921.164 872.125 922.753 873.981C925.881 877.634 930.68 876.607 951.329 867.866C961.892 863.394 977.959 856.6 987.034 852.766C996.109 848.933 1007.08 844.276 1011.41 842.417C1020.49 838.522 1020.55 838.533 1021.37 844.219C1023.01 855.576 1022.88 855.432 1042.03 865.73C1056.27 873.384 1075.75 883.994 1087.79 890.659C1095.08 894.694 1101.21 897.996 1101.42 897.996C1101.63 897.996 1106.92 900.85 1113.17 904.338C1149.68 924.709 1145.36 923.684 1170.72 918.003C1189.11 913.881 1192.12 913.396 1190.48 914.821C1188.69 916.384 1142.46 936.742 1133.03 940.123C1113.58 947.101 1109.87 948.042 1105.78 947.025C1104 946.58 1099.38 945.508 1095.53 944.644C1088.34 943.031 1060.33 936.684 1021.53 927.883C1009.43 925.138 996.834 922.255 993.534 921.477C990.234 920.699 977.634 917.824 965.534 915.088C953.434 912.353 933.409 907.817 921.034 905.008C908.659 902.199 888.634 897.658 876.534 894.916C864.434 892.174 852.734 889.499 850.534 888.972C848.334 888.445 835.509 885.522 822.034 882.476C779.055 872.762 757.75 867.913 749.534 865.975C745.134 864.937 739.959 863.839 738.034 863.535C736.109 863.232 728.301 861.858 720.682 860.483C713.064 859.108 700.689 857.319 693.182 856.508C685.676 855.697 673.684 854.375 666.534 853.571C659.384 852.766 644.534 851.399 633.534 850.531C622.534 849.664 605.659 848.04 596.034 846.923C586.409 845.806 575.493 844.625 571.776 844.298C561.881 843.429 562.043 843.755 543.899 787.996C541.661 781.121 538.752 772.312 537.432 768.421C536.113 764.529 535.034 761.094 535.034 760.787C535.034 760.48 537.621 759.226 540.784 758.001C547.215 755.511 567.444 747.378 570.534 746.041C571.634 745.565 574.559 744.274 577.034 743.172C579.509 742.069 590.084 737.572 600.534 733.178C610.984 728.783 625.334 722.445 632.422 719.092C639.511 715.739 645.913 712.996 646.648 712.996C654.602 712.996 658.23 704.802 654.97 694.205C648.762 674.032 644.994 662.221 637.995 640.996C611.328 560.125 603.59 528.404 602.304 494.69L601.74 479.884L604.617 480.606C608.498 481.58 635.835 492.766 649.034 498.781C663.508 505.377 667.269 506.996 668.117 506.996C668.636 506.996 669.843 507.407 670.798 507.91C676.606 510.969 702.733 519.996 705.777 519.996C711.452 519.996 712.257 511.808 707.704 500.398C705.751 495.502 702.995 487.446 701.581 482.496C700.167 477.546 698.595 472.371 698.088 470.996C697.056 468.194 689.216 443.261 683.153 423.496C665.549 366.111 646.056 278.952 640.1 230.996C636.174 199.388 633.09 171.406 632.053 157.996C631.479 150.571 630.34 135.925 629.521 125.449C628.703 114.973 628.034 105.754 628.034 104.962C628.034 103.551 635.938 113.763 636.002 115.256ZM741.715 156.245C740.32 187.345 741.505 223.404 744.058 227.536C747.76 233.525 754.81 233.42 760.946 227.284C783.515 204.715 844.159 191.923 883.534 201.427L891.534 203.358L879.034 204.554C860.189 206.356 844.3 212.677 834.799 222.15C833.845 223.101 832.495 224.243 831.799 224.688C830.644 225.426 826.215 230.362 821.768 235.869C819.186 239.067 813.338 250.998 812.585 254.607L811.936 257.717L802.735 255.811C784.92 252.12 785.034 251.924 785.034 286.385V311.475L780.534 304.767C778.059 301.077 776.034 297.815 776.034 297.518C776.034 297.22 773.484 293.043 770.368 288.236C767.252 283.429 762.189 275.53 759.118 270.683C756.047 265.836 751.172 258.311 748.284 253.961C745.396 249.612 743.034 245.811 743.034 245.515C743.034 245.219 740.559 241.156 737.534 236.486C734.509 231.817 729.559 224.175 726.534 219.506C723.509 214.836 721.034 210.782 721.034 210.496C721.034 210.21 718.537 206.225 715.486 201.64L709.938 193.303L713.976 184.127C721.948 166.012 738.891 137.998 741.878 137.995C742.239 137.995 742.165 146.208 741.715 156.245ZM564.575 164.938C570.098 171.295 581.091 184.371 589.004 193.996C596.917 203.621 606.911 215.38 611.213 220.127C618.267 227.913 619.034 229.156 619.034 232.811C619.034 235.039 620.206 243.08 621.639 250.679C623.072 258.279 624.609 267.646 625.054 271.496C627.601 293.537 646.372 374.202 658.678 415.996C664.294 435.069 672.968 463.102 674.09 465.81C674.618 467.082 674.708 467.923 674.292 467.677C672.056 466.361 631.635 449.35 626.534 447.579L620.534 445.496L620.297 440.996C619.804 431.66 618.039 421.07 612.464 393.996C600.973 338.188 566.68 206.08 552.933 164.659C549.617 154.67 546.687 145.821 546.422 144.996C546.157 144.171 547.873 145.72 550.237 148.438C552.6 151.157 559.053 158.582 564.575 164.938ZM543.294 266.105C553.141 277.826 554.735 279.295 575.591 295.874C576.517 296.61 580.508 311.926 592.038 358.996C598.253 384.368 608.022 433.383 608.031 439.246C608.034 440.754 607.02 440.996 600.716 440.996C596.69 440.996 591.055 441.691 588.193 442.541C582.838 444.132 581.034 443.876 581.034 441.528C581.034 440.786 577.24 435.634 572.604 430.079C552.836 406.398 541.497 382.39 533.008 346.246C532.071 342.256 531.516 342.211 540.806 346.88C570.32 361.716 584.209 359.066 569.622 341.382C559.188 328.732 545.427 298.618 539.984 276.521C537.461 266.28 536.177 257.653 537.388 259.079C537.582 259.309 540.24 262.47 543.294 266.105ZM808.034 270.047C808.034 270.44 807.101 271.007 805.96 271.305C804.819 271.603 803.641 272.781 803.343 273.922C803.045 275.063 802.403 275.996 801.917 275.996C801.425 275.996 801.034 289.608 801.034 306.719C801.034 333.682 800.859 337.191 799.6 335.394C798.464 333.772 798.018 326.495 797.451 300.315L796.735 267.282L802.385 268.306C805.492 268.87 808.034 269.653 808.034 270.047ZM421.987 317.427C449.935 358.049 524.336 427.089 562.672 447.976C566.996 450.332 570.713 452.417 570.933 452.61C571.152 452.802 570.392 454.88 569.245 457.228C564.141 467.673 562.409 481.297 564.071 497.929C565.537 512.591 571.518 551.566 573.898 561.969C575.235 567.811 575.521 567.879 567.52 560.447C563.7 556.899 560.244 553.996 559.839 553.996C556.324 553.996 534.201 527.943 507.617 492.496C476.898 451.535 461.19 424.294 438.997 373.496C432.445 358.498 417.076 312.996 418.563 312.996C418.769 312.996 420.31 314.99 421.987 317.427ZM420.973 369.996C435.512 406.435 453.952 441.846 473.567 470.996C485.627 488.917 486.291 489.857 495.319 501.792C502.217 510.91 502.744 511.898 499.945 510.45C493.909 507.329 480.474 503.913 469.964 502.828L459.394 501.736L456.783 497.116C455.347 494.575 450.428 486.779 445.853 479.792C441.278 472.805 433.484 460.758 428.534 453.021C423.584 445.284 416.648 434.576 413.12 429.225C409.592 423.874 404.382 415.67 401.542 410.994C394.649 399.646 387.783 390.116 386.453 390.05C385.859 390.02 383.159 388.873 380.453 387.5C375.511 384.993 371.034 384.226 371.034 385.888C371.034 386.378 369.963 387.048 368.653 387.377C367.273 387.723 365.636 389.345 364.758 391.235C363.926 393.029 361.572 398.096 359.527 402.496C357.482 406.896 350.416 422.646 343.825 437.496C337.234 452.346 330.8 466.746 329.529 469.496C323.17 483.244 320.27 489.663 308.515 515.996C301.518 531.671 294.31 547.711 292.496 551.641C286.061 565.584 283.034 572.851 283.034 574.355C283.034 575.192 282.584 576.156 282.034 576.496C278.148 578.898 282.496 586.187 292.593 594.196C296.961 597.661 301.209 601.233 302.034 602.135C302.859 603.036 309.091 608.211 315.884 613.635C328.61 623.797 343.987 636.274 364.667 653.219C386.933 671.462 390.586 674.497 392.893 676.663C402.031 685.242 406.53 688.292 418.34 693.914C442.308 705.324 476.268 706.145 498.809 695.859C502.26 694.284 505.341 692.996 505.656 692.996C507.558 692.996 523.662 681.174 529.652 675.38C554.059 651.776 565.467 615.616 558.698 583.318C557.151 575.939 556.161 575.485 571.638 589.249L582.605 599.002L586.464 612.749C591.189 629.582 599.789 655.605 605.68 670.894C608.096 677.163 609.951 682.352 609.803 682.427C609.181 682.74 603.378 685.33 601.534 686.118C600.434 686.588 581.534 694.355 559.534 703.378C483.548 734.544 488.46 732.21 487.442 737.633C486.721 741.477 485.297 736.854 512.077 817.59C520.303 842.392 527.034 863.421 527.034 864.321C527.034 866.862 531.117 867.333 544.872 866.376C563.184 865.103 572.301 865.381 592.534 867.832C602.434 869.03 623.134 870.91 638.534 872.008C653.934 873.107 671.034 874.445 676.534 874.984C682.034 875.522 691.034 876.026 696.534 876.104C715.611 876.377 741.563 881.372 779.3 892.037C798.74 897.53 797.97 896.677 797.307 911.996C796.286 935.609 800.364 953.508 812.806 980.024C816.999 988.959 826.097 1004.89 828.308 1007.17C829.019 1007.9 830.704 1010.07 832.053 1011.98C833.403 1013.9 835.188 1016.2 836.02 1017.1C836.853 1018 839.559 1021.07 842.034 1023.94C848.099 1030.97 858.938 1041.82 863.569 1045.5C865.647 1047.15 868.514 1049.43 869.94 1050.57C871.367 1051.71 874.784 1054.16 877.534 1056.01C880.284 1057.85 882.761 1059.69 883.038 1060.09C885.361 1063.44 920.605 1082.12 930.034 1085C932.509 1085.75 934.717 1086.5 934.941 1086.67C935.406 1087.02 932.281 1089.93 926.012 1095C923.628 1096.92 919.111 1100.97 915.972 1104C912.834 1107.02 908.81 1110.62 907.031 1112C905.252 1113.37 902.612 1115.49 901.165 1116.71C870.835 1142.21 822.188 1168.66 777.034 1184.19C659.688 1224.57 499.383 1220.61 376.537 1174.32C374.339 1173.49 369.389 1171.78 365.537 1170.51C361.685 1169.25 356.509 1167.44 354.034 1166.5C348.864 1164.54 330.51 1157.23 327.534 1155.95C326.434 1155.47 322.699 1153.93 319.233 1152.51C305.372 1146.83 275.287 1132.33 256.851 1122.43C239.593 1113.16 197.294 1087.92 190.538 1082.85C186.847 1080.08 183.045 1077.47 168.034 1067.42C165.009 1065.39 162.309 1063.42 162.034 1063.05C161.759 1062.67 159.37 1060.82 156.725 1058.93C148.955 1053.38 138.793 1045.59 135.957 1043C135.054 1042.17 132.61 1040.15 130.526 1038.5C125.026 1034.14 119.343 1029.44 117.681 1027.86C116.887 1027.11 114.567 1025.15 112.527 1023.5C104.364 1016.9 88.9833 1002.64 72.8703 986.746C65.7613 979.733 59.7342 973.996 59.4762 973.996C57.9202 973.996 48.4883 965.135 48.8593 964.022C49.1653 963.103 48.7683 962.884 47.6053 963.33C46.2253 963.86 46.0193 963.559 46.5163 961.74C47.0573 959.763 46.9963 959.709 46.0103 961.286C44.9643 962.957 44.6693 962.891 41.5713 960.286C33.4263 953.439 31.5543 951.996 30.8193 951.996C27.9343 951.996 31.2153 948.888 37.6803 945.496C46.6363 940.797 65.8703 928.323 69.2903 924.996C70.1383 924.171 72.5163 922.146 74.5743 920.496C110.519 891.679 130.994 852.539 132.734 809.313L133.305 795.13L130.17 790.866C128.445 788.521 127.034 786.006 127.034 785.278C127.034 784.549 125.909 783.441 124.534 782.814C123.159 782.188 122.034 781.39 122.034 781.043C122.034 780.695 119.559 779.569 116.534 778.541C109.548 776.166 109.517 776.249 119.192 771.496C123.671 769.296 127.83 767.031 128.434 766.463C129.039 765.895 131.109 764.344 133.034 763.015C143.426 755.846 163.09 735.523 169.751 725.067C171.703 722.003 173.607 719.271 173.982 718.996C176.772 716.953 190 691.745 196.022 676.996C198.38 671.221 200.87 665.146 201.556 663.496C209.215 645.054 220.942 607.653 231.03 569.496C245.28 515.596 254.247 489.603 266.663 466.2C273.255 453.774 276.929 449.588 281.822 448.929C292.349 447.511 295.142 436.949 287.118 428.906C276.971 418.737 260.341 389.693 254.136 371.305C249.876 358.682 249.858 358.733 257.268 362.263C295.973 380.698 349.218 378.659 375.206 357.747C383.609 350.986 398.311 335.627 402.542 329.192L405.372 324.887L411.077 342.192C414.215 351.709 418.668 364.221 420.973 369.996ZM386.917 427.246C391.491 434.534 399.445 447.021 404.593 454.996C409.741 462.971 417.63 475.315 422.124 482.426C426.619 489.538 431.795 497.442 433.626 499.992L436.957 504.627L430.003 506.867C385.047 521.346 355.987 565.994 360.955 612.952C361.505 618.153 361.822 622.541 361.66 622.703C361.323 623.04 350.014 614.05 328.063 595.996C319.704 589.121 311.122 582.146 308.991 580.496C303.796 576.474 303.236 579.058 314.73 553.996C316.117 550.971 322.878 535.896 329.754 520.496C336.629 505.096 343.593 489.571 345.229 485.996C346.865 482.421 349.013 477.696 350.004 475.496C350.994 473.296 353.356 468.121 355.252 463.996C357.148 459.871 362.937 446.937 368.117 435.254C379.273 410.09 376.808 411.14 386.917 427.246ZM611.82 454.525C614.652 455.366 621.371 458.231 626.752 460.891C632.132 463.551 646.311 469.933 658.26 475.074C679.527 484.224 684.697 487.666 681.688 490.675C681.22 491.143 642.917 473.844 635.809 469.955C634.861 469.436 631.261 468.062 627.809 466.902C624.358 465.742 619.666 463.92 617.382 462.853C596.669 453.173 580.034 464.757 580.034 488.861C580.034 508.068 589.148 557.652 597.337 582.996C598.136 585.471 600.003 591.546 601.486 596.496C604.468 606.457 617.604 647.455 625.035 669.996C633.81 696.613 633.999 697.556 630.784 698.573C629.547 698.964 625.609 700.618 622.034 702.248C618.459 703.879 614.634 705.584 613.534 706.037C612.434 706.49 609.959 707.516 608.034 708.317C606.109 709.117 600.709 711.217 596.034 712.981C587.339 716.264 569.125 723.415 565.534 724.957C564.434 725.429 561.509 726.704 559.034 727.789C556.559 728.875 550.934 731.189 546.534 732.932C542.134 734.675 537.634 736.475 536.534 736.932C535.434 737.389 531.384 739.035 527.534 740.59C523.684 742.145 519.634 744.495 518.534 745.812C517.434 747.129 515.697 749.108 514.674 750.211C510.489 754.722 511.969 762.095 523.06 791.996C524.794 796.671 526.568 801.621 527.003 802.996C527.438 804.371 529.377 809.546 531.313 814.496C541.668 840.981 546.325 854.038 545.655 854.708C545.45 854.914 543.688 855.34 541.74 855.656L538.199 856.231L519.483 799.363C497.801 733.483 499.777 740.843 503.534 739.959C505.184 739.571 512.384 736.766 519.534 733.726C526.684 730.686 543.784 723.614 557.534 718.01C571.284 712.405 584.109 707.131 586.034 706.289C592.604 703.416 595.539 702.2 608.534 696.97C627.639 689.281 627.647 689.264 619.657 670.736C607.773 643.178 590.442 584.324 586.039 556.575C585.435 552.769 584.772 549.381 584.565 549.046C584.358 548.711 583.017 539.9 581.586 529.467C580.154 519.033 578.519 507.796 577.952 504.496C571.113 464.711 583.681 446.169 611.82 454.525ZM878.007 494.688C872.416 498.514 872.551 499.445 882.094 522.784C894.266 552.552 906.208 581.882 912.514 597.496C943.508 674.242 942.223 671.271 946.032 674.994C948.63 677.534 949.906 678.003 954.318 678.044C957.187 678.07 978.434 679.131 1001.53 680.402C1045.38 682.814 1045.84 682.798 1050.28 678.655C1055.08 674.186 1054.19 671.011 1045.66 662.154C1036.33 652.476 1031.14 646.985 1018.03 632.923C1012.26 626.728 1005.51 619.528 1003.03 616.923C1000.56 614.318 993.809 607.118 988.034 600.923C982.259 594.728 975.509 587.528 973.034 584.923C970.559 582.318 963.809 575.116 958.034 568.918C952.259 562.72 944.088 554.015 939.877 549.573C930.25 539.418 925.193 534.029 912.034 519.896C885.177 491.051 884.286 490.391 878.007 494.688ZM961.784 521.685C955.984 523.201 970.034 559.553 980.673 570.559C983.897 573.893 990.359 580.829 995.034 585.971C999.709 591.114 1004 595.81 1004.56 596.409C1023.78 616.835 1034 629.5 1036 632.5C1036.15 632.721 1037 633.5 1037 633.5C1037 633.5 1038 634 1038.27 634.12C1038.77 634.344 1043.05 638.19 1050.55 646.746C1054.97 651.786 1056.41 651.951 1070.88 649.08C1076.19 648.026 1086.83 645.987 1094.53 644.549C1117.5 640.261 1117.03 640.445 1117.03 635.733C1117.03 629.267 1115.67 628.685 1093.33 625.608C1066.99 621.982 1068.38 622.359 1063.82 617.645C1061.61 615.363 1048.72 602.041 1035.17 588.041C1021.62 574.04 1003.96 555.815 995.931 547.541C987.9 539.266 979.35 530.439 976.931 527.924C971.52 522.298 966.831 520.366 961.784 521.685ZM471.653 524.503C557.578 539.078 562.929 659.108 478.587 680.007C459.063 684.845 424.821 678.532 416.595 668.578C416.012 667.872 412.372 664.782 408.506 661.712C383.14 641.565 374.586 601.75 388.723 569.637C402.684 537.925 437.875 518.773 471.653 524.503ZM447.73 543.074C442.386 546.614 438.151 554.21 435.508 564.996L433.916 571.496L426.887 573.256C386.754 583.307 378.223 617.274 413.273 627.463L418.927 629.107L418.366 633.842C414.689 664.89 455.569 683.675 466.961 656.172L468.159 653.279L474.261 655.744C504.258 667.86 526.064 648.19 508.039 625.275L506.009 622.694L510.87 619.42C527.067 608.513 531.607 591.479 521.943 577.874C518.02 572.353 502.465 567.509 490.758 568.163L484.81 568.496L483.093 562.996C476.777 542.758 461.338 534.061 447.73 543.074ZM913.534 545.636C915.734 548.158 920.459 553.278 924.034 557.015C927.609 560.752 935.259 568.877 941.034 575.071C946.809 581.265 953.559 588.464 956.034 591.069C958.509 593.674 965.259 600.873 971.034 607.067C976.809 613.26 982.659 619.525 984.034 620.988C985.409 622.45 992.159 629.674 999.034 637.039C1005.91 644.405 1014.54 653.589 1018.22 657.447C1021.89 661.306 1024.8 664.561 1024.68 664.68C1024.33 665.031 956.927 661.233 956.663 660.847C956.341 660.378 940.533 621.823 933.967 605.496C929.417 594.181 909.775 545.703 908.339 542.246C907.256 539.638 909.684 541.222 913.534 545.636ZM463.701 555.604C465.572 557.589 467.94 560.851 468.962 562.854L470.82 566.496H459.547H448.274L449.132 564.239C453.521 552.695 458.291 549.868 463.701 555.604ZM984.213 553.34C984.939 554.079 996.559 566.093 1010.03 580.039C1023.51 593.984 1040.38 611.4 1047.53 618.741L1060.53 632.088L1070.53 633.562C1076.03 634.373 1080.95 635.165 1081.45 635.323C1081.96 635.481 1077.69 636.54 1071.95 637.677L1061.53 639.744L1056.19 634.12C1048.83 626.385 1044.99 622.224 1026.09 601.496C1017.06 591.596 1005.08 578.546 999.467 572.496C989.254 561.485 982.034 553.163 982.034 552.401C982.034 551.63 982.897 552.002 984.213 553.34ZM470.778 581.39C488.961 590.693 492.432 612.369 477.849 625.544C463.884 638.16 445.499 634.665 435.516 617.496C423.28 596.451 448.914 570.203 470.778 581.39ZM506.033 583.323C517.473 588.85 516.671 598.601 504.034 607.614L499.534 610.824L499.402 604.572C499.24 596.88 496.912 588.568 493.519 583.569L490.96 579.798L496.247 580.474C499.155 580.845 503.558 582.127 506.033 583.323ZM421.839 593.666C420.365 598.579 419.931 602.397 420.193 608.166C420.599 617.098 420.216 617.426 413.519 613.894C408.398 611.192 404.034 607.081 404.034 604.959C404.034 600.864 417.391 588.682 423.687 587.036C423.771 587.014 422.939 589.997 421.839 593.666ZM496.217 632.746C506.678 643.994 497.71 651.644 481.991 644.882L477.077 642.768L482.991 638.946C486.243 636.843 489.66 633.97 490.584 632.56C492.686 629.352 493.073 629.365 496.217 632.746ZM446.388 643.411C449.218 644.187 452.778 645.096 454.298 645.431C457.991 646.246 455.91 650.726 450.033 654.615C442.178 659.813 431.034 650.506 431.034 638.748V635.131L436.138 638.566C438.945 640.455 443.557 642.635 446.388 643.411ZM884.777 781.246C886.364 783.584 891.644 791.346 896.511 798.496C922.051 836.017 926.701 842.884 929.492 847.204C933.176 852.906 940.296 854.91 943.034 851.015C943.757 849.986 1036.03 813.141 1036.04 813.878C1036.06 815.318 1040.08 841.312 1040.62 843.465C1040.97 844.862 1042.21 846.073 1043.66 846.438C1045.01 846.776 1060.6 854.841 1078.32 864.36C1096.04 873.879 1115.93 884.509 1122.53 887.982C1129.13 891.456 1136.96 895.58 1139.93 897.147C1145.71 900.202 1148.94 900.553 1156.03 898.897C1160.49 897.857 1193.56 890.984 1235 882.488C1246.8 880.067 1256.57 878.203 1256.72 878.345C1258.24 879.866 1235.23 890.955 1226.53 892.894C1221.03 894.118 1201.73 898.395 1183.65 902.397L1150.76 909.674L1138.65 903.03C1131.98 899.376 1119.56 892.615 1111.03 888.006C1102.51 883.397 1094.18 878.89 1092.53 877.99C1090.88 877.09 1083.46 873.045 1076.03 869.001C1068.61 864.956 1056.52 858.351 1049.17 854.322C1041.82 850.293 1035.51 846.996 1035.15 846.996C1034.78 846.996 1033.7 843.166 1032.73 838.484C1028.89 819.823 1032.44 819.56 977.927 842.546C953.511 852.841 932.859 861.44 932.034 861.654C931.044 861.911 928.62 859.058 924.907 853.27C921.812 848.444 913.464 835.496 906.355 824.496C899.247 813.496 891.204 801.024 888.482 796.781C880.631 784.541 883.616 783.831 845.641 806.968C824.539 819.825 818.65 823 817.952 821.897C816.586 819.74 816.634 819.681 823.284 815.344C838.819 805.211 853.471 795.703 864.534 788.576C871.134 784.325 877.659 780.005 879.034 778.977C880.409 777.948 881.615 777.082 881.713 777.052C881.812 777.021 883.19 778.908 884.777 781.246Z" fill="black"/>
</svg>
</file>

<file path="svelte.config.js">
import adapter from '@sveltejs/adapter-auto';
import { vitePreprocess } from '@sveltejs/vite-plugin-svelte';

const config = {
    preprocess: vitePreprocess(),

    kit: {
        adapter: adapter()
    },

    vite: {
        optimizeDeps: {
            exclude: ['leaflet', 'leaflet.markercluster']
        }
    }
};

export default config;
</file>

<file path="tailwind.config.cjs">
const defaultTheme = require('tailwindcss/defaultTheme');

/** @type {import('tailwindcss').Config} */
module.exports = {
  content: ['./src/**/*.{html,js,svelte,ts}'],
  darkMode: 'class',
  theme: {
    extend: {
      fontFamily: {
        sans: ['Inter', ...defaultTheme.fontFamily.sans],
        display: ['Russo One', 'sans-serif'],
      },
      colors: {
        'cyber-yellow': '#fcee0a',
        'cyber-cyan': '#00f0ff',
        'cyber-magenta': '#ff00c1',
        'cyber-red': '#ff003c',
        'cyber-bg': '#0a0a0a',
        'cyber-surface': 'rgba(22, 24, 29, 0.8)',
      },
      keyframes: {
        scanline: { '0%': { transform: 'translateY(-10%)' }, '100%': { transform: 'translateY(110%)' } },
      },
      animation: {
        glitch: 'glitch 1.5s infinite linear alternate-reverse',
        scanline: 'scanline 8s linear infinite',
      }
    },
  },
  plugins: [],
};
</file>

<file path="tsconfig.json">
{
	"extends": "./.svelte-kit/tsconfig.json",
	"compilerOptions": {
		"allowJs": true,
		"checkJs": true,
		"esModuleInterop": true,
		"forceConsistentCasingInFileNames": true,
		"resolveJsonModule": true,
		"skipLibCheck": true,
		"sourceMap": true,
		"strict": true,
		"moduleResolution": "bundler"
	}
	// Path aliases are handled by https://svelte.dev/docs/kit/configuration#alias
	// except $lib which is handled by https://svelte.dev/docs/kit/configuration#files
	//
	// If you want to overwrite includes/excludes, make sure to copy over the relevant includes/excludes
	// from the referenced tsconfig.json - TypeScript does not merge them in
}
</file>

<file path="vite.config.ts">
import { sveltekit } from '@sveltejs/kit/vite';
import { defineConfig } from 'vite';

export default defineConfig({
	plugins: [sveltekit()]
});
</file>

<file path="functions/package.json">
{
  "name": "functions",
  "scripts": {
    "lint": "eslint --ext .js,.ts .",
    "build": "tsc",
    "build:watch": "tsc --watch",
    "serve": "npm run build && firebase emulators:start --only functions",
    "shell": "npm run build && firebase functions:shell",
    "start": "npm run shell",
    "deploy": "firebase deploy --only functions",
    "logs": "firebase functions:log"
  },
  "engines": {
    "node": "22"
  },
  "main": "lib/index.js",
  "dependencies": {
    "cloudinary": "^2.6.1",
    "firebase-admin": "^13.5.0",
    "firebase-functions": "^6.4.0",
    "node-fetch": "^2.7.0",
    "telegraf": "^4.16.3"
  },
  "devDependencies": {
    "@types/node-fetch": "^2.6.12",
    "@typescript-eslint/eslint-plugin": "^5.12.0",
    "@typescript-eslint/parser": "^5.12.0",
    "eslint": "^8.9.0",
    "eslint-config-google": "^0.14.0",
    "eslint-plugin-import": "^2.25.4",
    "firebase-functions-test": "^3.1.0",
    "typescript": "^5.7.3"
  },
  "private": true
}
</file>

<file path="src/app.d.ts">
declare global {
    namespace App {
        interface Locals {
            user: {
                uid: string;
                email: string | undefined;
                username: string | null;
                emailVerified?: boolean;
                isBanned?: boolean;
            } | null;
        }
        // ...
    }
}
export {};
</file>

<file path="src/lib/client/artifacts.ts">
export type ArtifactDef = {
    id: string;
    icon: string;
    color: string;
    rarity: 'common' | 'uncommon' | 'rare' | 'legendary' | 'cursed';
};

export const ARTIFACTS_DATA: Record<string, ArtifactDef> = {
    'toast':        { id: 'toast',        icon: '🍞', color: '#cd7f32', rarity: 'common' },
    'ram_stick':    { id: 'ram_stick',    icon: '💾', color: '#39ff14', rarity: 'common' },
    // 👇 НОВОЕ
    'rubber_duck':  { id: 'rubber_duck',  icon: '🐤', color: '#ffd700', rarity: 'common' },

    'energy_drink': { id: 'energy_drink', icon: '⚡', color: '#00f3ff', rarity: 'uncommon' },
    'gpu_fan':      { id: 'gpu_fan',      icon: '🌀', color: '#00f3ff', rarity: 'uncommon' },

    'spaghetti':    { id: 'spaghetti',    icon: '🍝', color: '#ffcc00', rarity: 'cursed' },
    'blue_screen':  { id: 'blue_screen',  icon: '💻', color: '#0000ff', rarity: 'cursed' },
    'bug':          { id: 'bug',          icon: '🪲', color: '#ff003c', rarity: 'cursed' },
    // 👇 НОВОЕ
    '404_error':    { id: '404_error',    icon: '🚫', color: '#888888', rarity: 'cursed' },
    'ransomware':   { id: 'ransomware',   icon: '💀', color: '#ff0000', rarity: 'cursed' },

    'banhammer':    { id: 'banhammer',    icon: '🔨', color: '#ff003c', rarity: 'rare' },
    'source_code':  { id: 'source_code',  icon: '📜', color: '#00ff9d', rarity: 'rare' },
    // 👇 НОВОЕ
    'rtx_card':     { id: 'rtx_card',     icon: '📼', color: '#76b900', rarity: 'rare' },

    'orion_tear':   { id: 'orion_tear',   icon: '💎', color: '#bd00ff', rarity: 'legendary' },
    // 👇 НОВОЕ
    'admin_key':    { id: 'admin_key',    icon: '🗝️', color: '#ffffff', rarity: 'legendary' }
};
</file>

<file path="src/lib/client/soundGenerator.ts">
import { browser } from '$app/environment';

let audioCtx: AudioContext | null = null;

function getAudioContext(): AudioContext | null {
    if (!browser) return null;
    if (audioCtx) return audioCtx;
    audioCtx = new (window.AudioContext || (window as any).webkitAudioContext)();
    return audioCtx;
}

export function generateSpinSound(duration: number = 2.0) {
    const ctx = getAudioContext();
    if (!ctx) return;

    const oscillator = ctx.createOscillator();
    const gainNode = ctx.createGain();
    const filter = ctx.createBiquadFilter();

    oscillator.type = 'whitenoise';
    filter.type = 'lowpass';
    filter.frequency.setValueAtTime(1000, ctx.currentTime);
    filter.frequency.exponentialRampToValueAtTime(8000, ctx.currentTime + duration * 0.4);
    filter.frequency.exponentialRampToValueAtTime(500, ctx.currentTime + duration);

    gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);

    oscillator.connect(filter).connect(gainNode).connect(ctx.destination);
    oscillator.start();
    oscillator.stop(ctx.currentTime + duration);
}

export function generateWinSound(payout: number) {
    const ctx = getAudioContext();
    if (!ctx) return;

    const notes = [261.63, 329.63, 392.00, 523.25, 659.25, 783.99, 1046.50]; // C Major scale
    let noteCount = 3;
    if (payout > 100) noteCount = 4;
    if (payout > 500) noteCount = 7;

    for (let i = 0; i < noteCount; i++) {
        const oscillator = ctx.createOscillator();
        const gainNode = ctx.createGain();
        oscillator.type = 'sine';
        oscillator.frequency.value = notes[i];
        gainNode.gain.setValueAtTime(0.2, ctx.currentTime + i * 0.1);
        gainNode.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * 0.1 + 0.2);
        oscillator.connect(gainNode).connect(ctx.destination);
        oscillator.start(ctx.currentTime + i * 0.1);
        oscillator.stop(ctx.currentTime + i * 0.1 + 0.2);
    }
}

export function generateLoseSound() {
    const ctx = getAudioContext();
    if (!ctx) return;

    const oscillator = ctx.createOscillator();
    const gainNode = ctx.createGain();
    oscillator.type = 'sawtooth';
    oscillator.frequency.setValueAtTime(150, ctx.currentTime);
    oscillator.frequency.exponentialRampToValueAtTime(50, ctx.currentTime + 0.3);
    gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
    oscillator.connect(gainNode).connect(ctx.destination);
    oscillator.start();
    oscillator.stop(ctx.currentTime + 0.3);
}
</file>

<file path="src/lib/components/AvatarEditor.svelte">
<script lang="ts">
	import { createEventDispatcher, onMount, onDestroy } from 'svelte';
	import { fade } from 'svelte/transition';
	import { quintOut } from 'svelte/easing';
	import NeonButton from '$lib/components/NeonButton.svelte';
	import { t } from 'svelte-i18n';

	export let imageFile: File | null = null;
	export let isOpen = false;

	const dispatch = createEventDispatcher();

	let canvas: HTMLCanvasElement;
	let ctx: CanvasRenderingContext2D | null = null;
	let previewCanvas: HTMLCanvasElement;
	let previewCtx: CanvasRenderingContext2D | null = null;

	let image: HTMLImageElement | null = null;
	let imageUrl = '';

	// Transform state
	let zoom = 1;
	let rotation = 0;
	let offsetX = 0;
	let offsetY = 0;
	let flipX = false;
	let flipY = false;

	// Filters
	let brightness = 100;
	let contrast = 100;
	let saturation = 100;

	// Drag state (mouse)
	let isDragging = false;
	let dragStartX = 0;
	let dragStartY = 0;

	// Touch state
	let isTouching = false;
	let lastTouchX = 0;
	let lastTouchY = 0;
	let lastTouchDistance = 0;

	// Constants
	const CANVAS_SIZE = 400;
	const PREVIEW_SIZE = 128;
	const MIN_ZOOM = 0.5;
	const MAX_ZOOM = 3;

	$: if (isOpen && imageFile) {
		loadImage();
	}

	$: if (!isOpen) {
		cleanup();
	}

	function cleanup() {
		if (imageUrl) {
			URL.revokeObjectURL(imageUrl);
			imageUrl = '';
		}
		image = null;
		ctx = null;
		previewCtx = null;
	}

	async function loadImage() {
		if (!imageFile) return;

		cleanup();
		await new Promise(resolve => setTimeout(resolve, 100));

		if (canvas && !ctx) {
			ctx = canvas.getContext('2d', { willReadFrequently: true });
		}
		if (previewCanvas && !previewCtx) {
			previewCtx = previewCanvas.getContext('2d', { willReadFrequently: true });
		}

		imageUrl = URL.createObjectURL(imageFile);
		image = new Image();
		image.crossOrigin = 'anonymous';
		image.onload = () => {
			resetTransform();
			setTimeout(() => {
				if (ctx && image && image.complete) {
					render();
				}
			}, 50);
		};
		image.onerror = (e) => {
			console.error('Image load error:', e);
		};
		image.src = imageUrl;
	}

	function resetTransform() {
		if (!image) return;

		const imgWidth = image.width;
		const imgHeight = image.height;
		const scaleToFit = Math.max(CANVAS_SIZE / imgWidth, CANVAS_SIZE / imgHeight);

		zoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, scaleToFit));
		rotation = 0;
		offsetX = 0;
		offsetY = 0;
		flipX = false;
		flipY = false;
		brightness = 100;
		contrast = 100;
		saturation = 100;
	}

	function render() {
		if (!ctx || !image || !image.complete) return;

		ctx.fillStyle = '#0a0a0f';
		ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);

		ctx.save();

		ctx.translate(CANVAS_SIZE / 2, CANVAS_SIZE / 2);
		ctx.rotate((rotation * Math.PI) / 180);
		ctx.scale(flipX ? -1 : 1, flipY ? -1 : 1);
		ctx.translate(offsetX, offsetY);
		ctx.scale(zoom, zoom);

		const imgWidth = image.width;
		const imgHeight = image.height;
		const scale = Math.min(CANVAS_SIZE / imgWidth, CANVAS_SIZE / imgHeight);
		const scaledWidth = imgWidth * scale;
		const scaledHeight = imgHeight * scale;

		ctx.filter = `brightness(${brightness}%) contrast(${contrast}%) saturate(${saturation}%)`;
		ctx.drawImage(image, -scaledWidth / 2, -scaledHeight / 2, scaledWidth, scaledHeight);
		ctx.filter = 'none';

		ctx.restore();

		ctx.save();
		ctx.globalCompositeOperation = 'destination-in';
		ctx.beginPath();
		ctx.arc(CANVAS_SIZE / 2, CANVAS_SIZE / 2, CANVAS_SIZE / 2, 0, Math.PI * 2);
		ctx.fill();
		ctx.restore();

		ctx.strokeStyle = 'var(--cyber-yellow, #fcee0a)';
		ctx.lineWidth = 2;
		ctx.beginPath();
		ctx.arc(CANVAS_SIZE / 2, CANVAS_SIZE / 2, CANVAS_SIZE / 2 - 1, 0, Math.PI * 2);
		ctx.stroke();

		updatePreview();
	}

	function updatePreview() {
		if (!previewCtx || !canvas) return;
		previewCtx.clearRect(0, 0, PREVIEW_SIZE, PREVIEW_SIZE);
		previewCtx.drawImage(canvas, 0, 0, PREVIEW_SIZE, PREVIEW_SIZE);
	}

	// === MOUSE EVENTS ===
	function handleMouseDown(e: MouseEvent) {
		isDragging = true;
		dragStartX = e.clientX - offsetX;
		dragStartY = e.clientY - offsetY;
	}

	function handleMouseMove(e: MouseEvent) {
		if (!isDragging) return;
		offsetX = e.clientX - dragStartX;
		offsetY = e.clientY - dragStartY;
		render();
	}

	function handleMouseUp() {
		isDragging = false;
	}

	function handleWheel(e: WheelEvent) {
		e.preventDefault();
		const delta = e.deltaY > 0 ? -0.1 : 0.1;
		zoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, zoom + delta));
		render();
	}

	// === TOUCH EVENTS ===
	function getTouchDistance(touches: TouchList): number {
		if (touches.length < 2) return 0;
		const dx = touches[0].clientX - touches[1].clientX;
		const dy = touches[0].clientY - touches[1].clientY;
		return Math.sqrt(dx * dx + dy * dy);
	}

	function handleTouchStart(e: TouchEvent) {
		e.preventDefault(); // 🔥 Останавливаем прокрутку страницы

		if (e.touches.length === 1) {
			// Single touch - drag
			isTouching = true;
			lastTouchX = e.touches[0].clientX;
			lastTouchY = e.touches[0].clientY;
		} else if (e.touches.length === 2) {
			// Two fingers - pinch zoom
			lastTouchDistance = getTouchDistance(e.touches);
		}
	}

	function handleTouchMove(e: TouchEvent) {
		e.preventDefault(); // 🔥 Останавливаем прокрутку страницы

		if (e.touches.length === 1 && isTouching) {
			// Single touch - drag
			const touch = e.touches[0];
			const deltaX = touch.clientX - lastTouchX;
			const deltaY = touch.clientY - lastTouchY;

			offsetX += deltaX;
			offsetY += deltaY;

			lastTouchX = touch.clientX;
			lastTouchY = touch.clientY;

			render();
		} else if (e.touches.length === 2) {
			// Two fingers - pinch zoom
			const currentDistance = getTouchDistance(e.touches);

			if (lastTouchDistance > 0) {
				const delta = (currentDistance - lastTouchDistance) * 0.01;
				zoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, zoom + delta));
				render();
			}

			lastTouchDistance = currentDistance;
		}
	}

	function handleTouchEnd(e: TouchEvent) {
		e.preventDefault(); // 🔥 Останавливаем прокрутку страницы

		if (e.touches.length === 0) {
			isTouching = false;
			lastTouchDistance = 0;
		} else if (e.touches.length === 1) {
			// Остался 1 палец - сбрасываем zoom, продолжаем drag
			lastTouchDistance = 0;
			lastTouchX = e.touches[0].clientX;
			lastTouchY = e.touches[0].clientY;
		}
	}

	function rotateLeft() {
		rotation = (rotation - 90) % 360;
		render();
	}

	function rotateRight() {
		rotation = (rotation + 90) % 360;
		render();
	}

	function toggleFlipX() {
		flipX = !flipX;
		render();
	}

	function toggleFlipY() {
		flipY = !flipY;
		render();
	}

	function zoomIn() {
		zoom = Math.min(MAX_ZOOM, zoom + 0.2);
		render();
	}

	function zoomOut() {
		zoom = Math.max(MIN_ZOOM, zoom - 0.2);
		render();
	}

	function reset() {
		resetTransform();
		render();
	}

	async function handleSave() {
		if (!canvas) return;

		const outputCanvas = document.createElement('canvas');
		outputCanvas.width = PREVIEW_SIZE;
		outputCanvas.height = PREVIEW_SIZE;
		const outputCtx = outputCanvas.getContext('2d');

		if (!outputCtx) return;

		outputCtx.drawImage(canvas, 0, 0, PREVIEW_SIZE, PREVIEW_SIZE);

		outputCanvas.toBlob((blob) => {
			if (blob) {
				const reader = new FileReader();
				reader.onloadend = () => {
					dispatch('save', { imageBase64: reader.result });
					close();
				};
				reader.readAsDataURL(blob);
			}
		}, 'image/webp', 0.95);
	}

	function close() {
		cleanup();
		dispatch('close');
	}

	onDestroy(() => {
		cleanup();
	});
</script>

<svelte:window on:mousemove={handleMouseMove} on:mouseup={handleMouseUp} />

{#if isOpen}
	<div class="modal-overlay" transition:fade={{ duration: 200 }} on:click={close}>
		<div
			class="editor-container cyber-panel"
			on:click|stopPropagation
		>
			<!-- Header -->
			<div class="header">
				<h2 class="title font-display">{$t('edit_profile.avatar_editor.title')}</h2>
				<button class="close-btn" on:click={close} aria-label={$t('edit_profile.avatar_editor.cancel')}>
					<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
						<path d="M18 6L6 18M6 6l12 12" stroke-width="2" stroke-linecap="round"/>
					</svg>
				</button>
			</div>

			<!-- Content -->
			<div class="content">
				<!-- Left: Canvas -->
				<div class="canvas-section">
					<canvas
						bind:this={canvas}
						width={CANVAS_SIZE}
						height={CANVAS_SIZE}
						class="main-canvas"
						on:mousedown={handleMouseDown}
						on:wheel={handleWheel}
						on:touchstart={handleTouchStart}
						on:touchmove={handleTouchMove}
						on:touchend={handleTouchEnd}
					/>
					<p class="canvas-hint">{$t('edit_profile.avatar_editor.hint')}</p>
				</div>

				<!-- Right: Controls -->
				<div class="controls-section">
					<!-- Preview -->
					<div class="control-block">
						<label class="block-label font-display">{$t('edit_profile.avatar_editor.preview')}</label>
						<div class="preview-wrapper">
							<canvas
								bind:this={previewCanvas}
								width={PREVIEW_SIZE}
								height={PREVIEW_SIZE}
								class="preview-canvas"
							/>
						</div>
					</div>

					<!-- Transform -->
					<div class="control-block">
						<label class="block-label font-display">{$t('edit_profile.avatar_editor.zoom')}</label>
						<div class="control-row">
							<span class="control-value">{zoom.toFixed(1)}x</span>
							<div class="button-group">
								<button class="icon-btn" on:click={zoomOut} disabled={zoom <= MIN_ZOOM} title={$t('edit_profile.avatar_editor.zoom_out')}>
									<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
										<circle cx="11" cy="11" r="8" stroke-width="2"/>
										<path d="M8 11h6M21 21l-4.35-4.35" stroke-width="2" stroke-linecap="round"/>
									</svg>
								</button>
								<button class="icon-btn" on:click={zoomIn} disabled={zoom >= MAX_ZOOM} title={$t('edit_profile.avatar_editor.zoom_in')}>
									<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
										<circle cx="11" cy="11" r="8" stroke-width="2"/>
										<path d="M11 8v6M8 11h6M21 21l-4.35-4.35" stroke-width="2" stroke-linecap="round"/>
									</svg>
								</button>
							</div>
						</div>
					</div>

					<div class="control-block">
						<label class="block-label font-display">{$t('edit_profile.avatar_editor.rotate')}</label>
						<div class="control-row">
							<span class="control-value">{rotation}°</span>
							<div class="button-group">
								<button class="icon-btn" on:click={rotateLeft} title={$t('edit_profile.avatar_editor.rotate_left')}>
									<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
										<path d="M2.5 2v6h6M2.66 15.57a10 10 0 1 0 .57-8.38" stroke-width="2" stroke-linecap="round"/>
									</svg>
								</button>
								<button class="icon-btn" on:click={rotateRight} title={$t('edit_profile.avatar_editor.rotate_right')}>
									<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
										<path d="M21.5 2v6h-6M21.34 15.57a10 10 0 1 1-.57-8.38" stroke-width="2" stroke-linecap="round"/>
									</svg>
								</button>
							</div>
						</div>
					</div>

					<div class="control-block">
						<label class="block-label font-display">{$t('edit_profile.avatar_editor.flip')}</label>
						<div class="button-group full">
							<button class="toggle-btn" class:active={flipX} on:click={toggleFlipX}>
								<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
									<path d="M8 3H5a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h3m8-18h3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-3M12 3v18" stroke-width="2"/>
								</svg>
								{$t('edit_profile.avatar_editor.flip_horizontal')}
							</button>
							<button class="toggle-btn" class:active={flipY} on:click={toggleFlipY}>
								<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
									<path d="M3 8V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v3M3 16v3a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-3M3 12h18" stroke-width="2"/>
								</svg>
								{$t('edit_profile.avatar_editor.flip_vertical')}
							</button>
						</div>
					</div>

					<!-- Adjustments -->
					<div class="control-block">
						<label class="block-label font-display">{$t('edit_profile.avatar_editor.adjustments')}</label>

						<div class="slider-control">
							<div class="slider-header">
								<span>{$t('edit_profile.avatar_editor.brightness')}</span>
								<span class="slider-value">{brightness}%</span>
							</div>
							<input
								type="range"
								bind:value={brightness}
								min="0"
								max="200"
								class="slider"
								on:input={() => render()}
							/>
						</div>

						<div class="slider-control">
							<div class="slider-header">
								<span>{$t('edit_profile.avatar_editor.contrast')}</span>
								<span class="slider-value">{contrast}%</span>
							</div>
							<input
								type="range"
								bind:value={contrast}
								min="0"
								max="200"
								class="slider"
								on:input={() => render()}
							/>
						</div>

						<div class="slider-control">
							<div class="slider-header">
								<span>{$t('edit_profile.avatar_editor.saturation')}</span>
								<span class="slider-value">{saturation}%</span>
							</div>
							<input
								type="range"
								bind:value={saturation}
								min="0"
								max="200"
								class="slider"
								on:input={() => render()}
							/>
						</div>
					</div>

					<!-- Reset -->
					<button class="reset-btn" on:click={reset}>
						<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
							<path d="M1 4v6h6M23 20v-6h-6" stroke-width="2" stroke-linecap="round"/>
							<path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15" stroke-width="2" stroke-linecap="round"/>
						</svg>
						{$t('edit_profile.avatar_editor.reset')}
					</button>
				</div>
			</div>

			<!-- Footer -->
			<div class="footer">
				<button class="cancel-btn" on:click={close}>
					{$t('edit_profile.avatar_editor.cancel')}
				</button>
				<NeonButton type="button" on:click={handleSave}>
					{$t('edit_profile.avatar_editor.save')}
				</NeonButton>
			</div>
		</div>
	</div>
{/if}

<style>
	.modal-overlay {
		position: fixed;
		inset: 0;
		background: rgba(0, 0, 0, 0.85);
		backdrop-filter: blur(8px);
		display: flex;
		align-items: center;
		justify-content: center;
		z-index: 9999;
		padding: 1rem;
		overflow-y: auto; /* 🔥 Разрешаем скролл самой модалки */
	}

	.editor-container {
		background: rgba(10, 10, 10, 0.5);
		backdrop-filter: blur(4px);
		-webkit-backdrop-filter: blur(4px);
		border: 1px solid rgba(252, 238, 10, 0.2);
		clip-path: polygon(0 15px, 15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%);
		max-width: 900px;
		width: 100%;
		max-height: 90vh;
		overflow: hidden;
		display: flex;
		flex-direction: column;
	}

	.header {
		border-bottom: 1px solid rgba(252, 238, 10, 0.2);
		padding: 1.5rem 2rem;
		display: flex;
		align-items: center;
		justify-content: space-between;
	}

	.title {
		margin: 0;
		font-size: 1.5rem;
		font-weight: 700;
		color: var(--cyber-yellow, #fcee0a);
		letter-spacing: 2px;
		text-transform: uppercase;
	}

	.close-btn {
		background: none;
		border: 1px solid rgba(255, 255, 255, 0.2);
		color: rgba(255, 255, 255, 0.7);
		cursor: pointer;
		padding: 0.5rem;
		transition: all 0.3s ease;
		display: flex;
		align-items: center;
		justify-content: center;
		border-radius: 4px;
	}

	.close-btn:hover {
		background: rgba(255, 255, 255, 0.1);
		border-color: rgba(255, 255, 255, 0.4);
		color: #fff;
	}

	.content {
		padding: 2rem;
		display: grid;
		grid-template-columns: 1fr 320px;
		gap: 2rem;
		overflow-y: auto;
		flex: 1;
	}

	.canvas-section {
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: 1rem;
	}

	.main-canvas {
		border: 2px solid var(--cyber-yellow, #fcee0a);
		border-radius: 50%;
		cursor: move;
		background: #000;
		box-shadow: 0 0 20px rgba(252, 238, 10, 0.2);
		max-width: 100%;
		height: auto;
		touch-action: none; /* 🔥 Отключаем дефолтные тач-жесты браузера */
		user-select: none; /* 🔥 Отключаем выделение */
		-webkit-user-select: none;
		-webkit-touch-callout: none; /* 🔥 Отключаем контекстное меню на iOS */
	}

	.canvas-hint {
		font-size: 0.875rem;
		color: rgba(255, 255, 255, 0.5);
		text-align: center;
		margin: 0;
	}

	.controls-section {
		display: flex;
		flex-direction: column;
		gap: 1.5rem;
		overflow-y: auto;
		max-height: 600px;
		padding-right: 0.5rem;
	}

	.controls-section::-webkit-scrollbar {
		width: 6px;
	}

	.controls-section::-webkit-scrollbar-track {
		background: rgba(255, 255, 255, 0.05);
	}

	.controls-section::-webkit-scrollbar-thumb {
		background: var(--cyber-yellow, #fcee0a);
		border-radius: 3px;
	}

	.control-block {
		background: rgba(255, 255, 255, 0.02);
		border: 1px solid rgba(255, 255, 255, 0.1);
		padding: 1rem;
		border-radius: 4px;
	}

	.block-label {
		display: block;
		font-size: 0.75rem;
		font-weight: 700;
		color: var(--cyber-yellow, #fcee0a);
		letter-spacing: 1px;
		margin-bottom: 0.75rem;
		text-transform: uppercase;
	}

	.preview-wrapper {
		display: flex;
		justify-content: center;
	}

	.preview-canvas {
		border: 2px solid var(--cyber-yellow, #fcee0a);
		border-radius: 50%;
		box-shadow: 0 0 15px rgba(252, 238, 10, 0.2);
		background: #000;
	}

	.control-row {
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 1rem;
	}

	.control-value {
		font-family: 'Courier New', monospace;
		font-size: 0.875rem;
		color: rgba(255, 255, 255, 0.7);
		min-width: 50px;
	}

	.button-group {
		display: flex;
		gap: 0.5rem;
	}

	.button-group.full {
		width: 100%;
		flex-direction: column;
	}

	.icon-btn {
		background: rgba(252, 238, 10, 0.1);
		border: 1px solid rgba(252, 238, 10, 0.3);
		color: var(--cyber-yellow, #fcee0a);
		padding: 0.5rem;
		cursor: pointer;
		transition: all 0.3s ease;
		display: flex;
		align-items: center;
		justify-content: center;
		border-radius: 4px;
	}

	.icon-btn:hover:not(:disabled) {
		background: rgba(252, 238, 10, 0.2);
		border-color: var(--cyber-yellow, #fcee0a);
		transform: translateY(-1px);
	}

	.icon-btn:disabled {
		opacity: 0.3;
		cursor: not-allowed;
	}

	.toggle-btn {
		background: rgba(255, 255, 255, 0.05);
		border: 1px solid rgba(255, 255, 255, 0.2);
		color: rgba(255, 255, 255, 0.7);
		padding: 0.5rem 0.75rem;
		cursor: pointer;
		transition: all 0.3s ease;
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 0.5rem;
		border-radius: 4px;
		font-size: 0.875rem;
	}

	.toggle-btn:hover {
		background: rgba(255, 255, 255, 0.1);
		border-color: rgba(255, 255, 255, 0.4);
		color: #fff;
	}

	.toggle-btn.active {
		background: rgba(252, 238, 10, 0.2);
		border-color: var(--cyber-yellow, #fcee0a);
		color: var(--cyber-yellow, #fcee0a);
	}

	.slider-control {
		margin-top: 0.75rem;
	}

	.slider-control:first-child {
		margin-top: 0;
	}

	.slider-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 0.5rem;
		font-size: 0.875rem;
		color: rgba(255, 255, 255, 0.7);
	}

	.slider-value {
		font-family: 'Courier New', monospace;
		color: var(--cyber-yellow, #fcee0a);
	}

	.slider {
		width: 100%;
		height: 4px;
		background: rgba(255, 255, 255, 0.1);
		border-radius: 2px;
		outline: none;
		-webkit-appearance: none;
	}

	.slider::-webkit-slider-thumb {
		-webkit-appearance: none;
		appearance: none;
		width: 14px;
		height: 14px;
		background: var(--cyber-yellow, #fcee0a);
		border: 2px solid #000;
		border-radius: 50%;
		cursor: pointer;
		box-shadow: 0 0 8px rgba(252, 238, 10, 0.5);
	}

	.slider::-moz-range-thumb {
		width: 14px;
		height: 14px;
		background: var(--cyber-yellow, #fcee0a);
		border: 2px solid #000;
		border-radius: 50%;
		cursor: pointer;
		box-shadow: 0 0 8px rgba(252, 238, 10, 0.5);
	}

	.reset-btn {
		background: rgba(255, 0, 60, 0.1);
		border: 1px solid rgba(255, 0, 60, 0.3);
		color: var(--cyber-red, #ff003c);
		padding: 0.75rem;
		cursor: pointer;
		transition: all 0.3s ease;
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 0.5rem;
		border-radius: 4px;
		font-size: 0.875rem;
		font-weight: 600;
	}

	.reset-btn:hover {
		background: rgba(255, 0, 60, 0.2);
		border-color: var(--cyber-red, #ff003c);
		box-shadow: 0 0 10px rgba(255, 0, 60, 0.3);
	}

	.footer {
		border-top: 1px solid rgba(252, 238, 10, 0.2);
		padding: 1.5rem 2rem;
		display: flex;
		gap: 1rem;
		justify-content: flex-end;
	}

	.cancel-btn {
		padding: 0.75rem 1.5rem;
		border-radius: 4px;
		cursor: pointer;
		transition: all 0.3s ease;
		font-size: 0.875rem;
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.5px;
		background: none;
		border: 1px solid rgba(255, 255, 255, 0.2);
		color: rgba(255, 255, 255, 0.7);
	}

	.cancel-btn:hover {
		background: rgba(255, 255, 255, 0.1);
		border-color: rgba(255, 255, 255, 0.4);
		color: #fff;
	}

	@media (max-width: 768px) {
		.content {
			grid-template-columns: 1fr;
		}

		.main-canvas {
			width: 100%;
			max-width: 400px;
		}

		.controls-section {
			max-height: none;
		}

		.canvas-hint {
			font-size: 0.75rem;
		}
	}
</style>
</file>

<file path="src/lib/components/casino/ArtifactSynthesis.svelte">
<script lang="ts">
    import { createEventDispatcher, onMount, onDestroy } from 'svelte';
    import { fade, scale, fly } from 'svelte/transition';
    import { quintOut, elasticOut } from 'svelte/easing';
    import { ARTIFACTS_DATA } from '$lib/client/artifacts';
    import { t } from 'svelte-i18n';
    import NeonButton from '$lib/components/NeonButton.svelte';
    import { Howl } from 'howler';

    export let artifactIds: string[] = [];
    export let totalWin: number = 0;

    const dispatch = createEventDispatcher();

    type Stage = 'implode' | 'fusion' | 'flash' | 'reveal';
    let stage: Stage = 'implode';

    // Управление поочередным появлением
    let visibleCards = 0;
    let showFooter = false;

    let canvas: HTMLCanvasElement;
    let ctx: CanvasRenderingContext2D | null;
    let animationFrame: number;

    // Звуки
    let sfxCard: Howl;
    let sfxRare: Howl;
    let sfxLegendary: Howl;
    let sfxCursed: Howl;

    const shards = Array(10).fill(0).map(() => ({
        angle: Math.random() * 360,
        dist: 400 + Math.random() * 200,
        delay: Math.random() * 0.3
    }));

    onMount(() => {
        const sfxImplode = new Howl({ src: ['/sounds/synthesis_implode.mp3'], volume: 0.7 });
        const sfxFusion = new Howl({ src: ['/sounds/synthesis_fusion_loop.mp3'], volume: 0.5, loop: true });
        const sfxFlash = new Howl({ src: ['/sounds/synthesis_flash_hit.mp3'], volume: 1.0 });

        sfxCard = new Howl({ src: ['/sounds/card_drop.mp3'], volume: 0.8 });
        sfxRare = new Howl({ src: ['/sounds/rare_drop.mp3'], volume: 0.9 });
        sfxLegendary = new Howl({ src: ['/sounds/legendary_drop.mp3'], volume: 1.0 });
        sfxCursed = new Howl({ src: ['/sounds/cursed_drop.mp3'], volume: 0.9 });

        // 1. IMPLOSION
        sfxImplode.play();

        // 2. FUSION
        setTimeout(() => {
            stage = 'fusion';
            sfxFusion.play();
            initLightning();
        }, 1500);

        // 3. FLASH
        setTimeout(() => {
            stage = 'flash';
            sfxFusion.stop();
            sfxFlash.play();
            stopLightning();
        }, 5500);

        // 4. REVEAL START
        setTimeout(() => {
            stage = 'reveal';
            startRevealSequence();
        }, 5800);
    });

    onDestroy(() => {
        stopLightning();
    });

    // === ЛОГИКА ПООЧЕРЕДНОГО ПОЯВЛЕНИЯ ===
    function startRevealSequence() {
        // Было 3000, ставим 2000 (2 секунды)
        // Это оптимальный баланс между "скучно" и "слишком быстро"
        const CARD_DELAY = 2000;

        artifactIds.forEach((id, i) => {
            setTimeout(() => {
                visibleCards = i + 1;

                const item = ARTIFACTS_DATA[id];

                if (item.rarity === 'legendary') {
                    sfxLegendary?.play();
                } else if (item.rarity === 'rare') {
                    sfxRare?.play();
                } else if (item.rarity === 'cursed') {
                    sfxCursed?.play();
                } else {
                    sfxCard?.play();
                }

            }, i * CARD_DELAY);
        });

        setTimeout(() => {
            showFooter = true;
        }, artifactIds.length * CARD_DELAY);
    }

    function initLightning() {
        if (!canvas) return;
        ctx = canvas.getContext('2d');
        loopLightning();
    }

    function stopLightning() {
        if (animationFrame) cancelAnimationFrame(animationFrame);
    }

    function loopLightning() {
        if (!ctx || !canvas) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const bolts = Math.floor(Math.random() * 3) + 2;
        for (let i = 0; i < bolts; i++) {
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            let x = centerX; let y = centerY;
            const angle = Math.random() * Math.PI * 2;
            const length = 100 + Math.random() * 150;
            for (let j = 0; j < 10; j++) {
                x += Math.cos(angle) * (length / 10) + (Math.random() - 0.5) * 20;
                y += Math.sin(angle) * (length / 10) + (Math.random() - 0.5) * 20;
                ctx.lineTo(x, y);
            }
            const color = Math.random() > 0.5 ? '#bd00ff' : '#00f3ff';
            ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.shadowBlur = 15; ctx.shadowColor = color; ctx.stroke();
        }
        animationFrame = requestAnimationFrame(loopLightning);
    }

    function close() {
        dispatch('close');
    }

    function holoSlam(node: Element, { delay = 0, duration = 1000 }) {
        return {
            delay,
            duration,
            css: (t: number) => {
                const eased = elasticOut(t);
                const scale = 2 - (eased * 1);
                const opacity = t;
                const blur = (1 - t) * 10;
                return `transform: scale(${scale}) translateY(${(1 - eased) * -50}px); opacity: ${opacity}; filter: blur(${blur}px);`;
            }
        };
    }
</script>

<div class="fixed inset-0 z-[100] bg-black/95 flex items-center justify-center overflow-hidden" transition:fade>

    {#if stage === 'implode'}
        <div class="center-stage">
            {#each shards as s}
                <div
                    class="shard"
                    style="
                        --angle: {s.angle}deg;
                        --dist: {s.dist}px;
                        animation-delay: {s.delay}s;
                    "
                >
                    <img src="/casino/glitch-6.svg" alt="shard" />
                </div>
            {/each}
            <div class="black-hole"></div>
        </div>
    {/if}

    {#if stage === 'fusion'}
        <div class="fusion-stage" in:scale={{duration: 200, start: 0}}>
            <canvas bind:this={canvas} width="800" height="800" class="lightning-canvas"></canvas>
            <div class="core-ring r1"></div>
            <div class="core-ring r2"></div>
            <div class="core-ring r3"></div>
            <div class="unstable-core"></div>
            <h2 class="fusion-text">SYNTHESIZING...</h2>
        </div>
    {/if}

    {#if stage === 'flash'}
        <div class="flash-screen"></div>
    {/if}

    <!-- === ФАЗА 4: REVEAL (Результат) === -->
    {#if stage === 'reveal'}
        <div class="synthesis-panel" in:scale={{duration: 500, start: 0.9, easing: quintOut}}>
            <h2 class="text-3xl font-display text-white mb-8 text-center text-glow">
                {$t('synthesis.title')}
            </h2>

            <div class="cards-row">
                {#each artifactIds as id, i}
                    <!-- Рендерим только по очереди -->
                    {#if i < visibleCards}
                        {@const item = ARTIFACTS_DATA[id]}

                        <div
                            class="artifact-card-wrapper"
                            in:holoSlam={{ delay: 0, duration: 1200 }}
                        >
                            <div class="artifact-card rarity-{item.rarity}" style="--item-color: {item.color}">

                                <!-- ЭФФЕКТЫ ПРИ ПОЯВЛЕНИИ -->
                                <div class="shockwave" style="border-color: {item.color}"></div>
                                <div class="flash-overlay"></div>

                                <div class="card-bg"></div>
                                <div class="icon">{item.icon}</div>
                                <div class="info">
                                    <h3 class="name" style="color: {item.color}">
                                        {$t(`artifacts.${id}.name`)}
                                    </h3>
                                    <div class="separator" style="background: {item.color}"></div>
                                    <p class="desc">{$t(`artifacts.${id}.desc`)}</p>
                                </div>

                                {#if item.rarity === 'legendary'}
                                    <div class="rarity-badge legendary">LEGENDARY</div>
                                {:else if item.rarity === 'rare'}
                                    <div class="rarity-badge rare">RARE</div>
                                {/if}
                            </div>
                        </div>
                    {/if}
                {/each}
            </div>

            <!-- RESULT FOOTER (Показываем только когда showFooter = true) -->
            {#if showFooter}
                <div class="result-footer" in:fade={{ duration: 500 }}>
                    <div class="calculation-box">
                        <span class="calc-label">{$t('synthesis.total')}</span>
                        <span class="calc-val glitch" data-text="{totalWin} PC">{totalWin} PC</span>
                    </div>

                    <NeonButton on:click={close} extraClass="w-full max-w-md mx-auto mt-6">
                        {$t('synthesis.btn_collect')}
                    </NeonButton>
                </div>
            {/if}
        </div>
    {/if}
</div>

<style>
    .text-glow {
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px currentColor;
    }

    .center-stage {
        position: absolute;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        perspective: 1000px;
    }

    .black-hole {
        width: 60px;
        height: 60px;
        background: #000;
        border-radius: 50%;
        box-shadow: 0 0 50px #bd00ff, 0 0 100px #00f3ff, inset 0 0 20px #fff;
        z-index: 10;
        animation: pulse-hole 0.2s infinite alternate;
    }

    @keyframes pulse-hole {
        from { transform: scale(1); box-shadow: 0 0 50px #bd00ff; }
        to { transform: scale(1.1); box-shadow: 0 0 70px #ff003c; }
    }

    .shard {
        position: absolute;
        width: 40px;
        height: 40px;
        transform: rotate(var(--angle)) translateX(var(--dist));
        opacity: 1;
        animation: suck-in 1.5s cubic-bezier(0.7, 0, 1, 1) forwards;
    }

    .shard img {
        width: 100%;
        height: 100%;
        filter: drop-shadow(0 0 10px #ff003c) brightness(1.5);
        animation: spin-shard 1s linear infinite;
    }

    @keyframes suck-in {
        0% { opacity: 1; }
        90% { opacity: 1; }
        100% {
            transform: rotate(calc(var(--angle) + 720deg)) translateX(0px) scale(0);
            opacity: 0;
        }
    }

    @keyframes spin-shard {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .fusion-stage {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    .lightning-canvas {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 5;
        pointer-events: none;
        opacity: 0.8;
        mix-blend-mode: screen;
    }

    .unstable-core {
        width: 140px;
        height: 140px;
        border-radius: 50%;
        background: radial-gradient(circle, #fff 20%, #bd00ff 60%, #000 100%);
        box-shadow: 0 0 60px #bd00ff, 0 0 120px #00f3ff, inset 0 0 30px #fff;
        z-index: 10;
        animation: shake-core 0.05s infinite;
    }

    @keyframes shake-core {
        0% { transform: translate(2px, 1px) scale(1); }
        25% { transform: translate(-1px, -2px) scale(1.02); }
        50% { transform: translate(-3px, 0px) scale(0.98); }
        75% { transform: translate(0px, 2px) scale(1.02); }
        100% { transform: translate(1px, -1px) scale(1); }
    }

    .core-ring {
        position: absolute;
        border-radius: 50%;
        border: 4px solid transparent;
        z-index: 8;
        box-shadow: 0 0 15px rgba(255,255,255,0.1);
    }

    .r1 {
        width: 220px;
        height: 220px;
        border-top-color: #00f3ff;
        border-bottom-color: #00f3ff;
        filter: drop-shadow(0 0 10px #00f3ff);
        animation: spin-ring 2s linear infinite;
    }

    .r2 {
        width: 320px;
        height: 320px;
        border-left-color: #ff003c;
        border-right-color: #ff003c;
        filter: drop-shadow(0 0 10px #ff003c);
        animation: spin-ring 3s linear infinite reverse;
    }

    .r3 {
        width: 450px;
        height: 450px;
        border: 1px dashed rgba(255, 255, 255, 0.5);
        opacity: 0.5;
        animation: spin-ring 8s linear infinite;
    }

    @keyframes spin-ring {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .fusion-text {
        position: absolute;
        bottom: 15%;
        color: #fff;
        font-family: 'Chakra Petch', monospace;
        font-weight: 900;
        font-size: 1.5rem;
        letter-spacing: 0.5em;
        animation: text-flicker 0.1s infinite;
        text-shadow: 0 0 20px #bd00ff;
        text-align: center;
        width: 100%;
    }

    @keyframes text-flicker {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 0.9; }
    }

    .flash-screen {
        position: absolute;
        inset: 0;
        background: white;
        z-index: 200;
        animation: flash-out 0.5s ease-out forwards;
    }

    @keyframes flash-out {
        0% { opacity: 1; }
        100% { opacity: 0; display: none; }
    }

    .synthesis-panel {
        width: 100%;
        max-width: 1000px;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        background: rgba(10, 10, 15, 0.8);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        box-shadow: 0 0 50px rgba(0, 0, 0, 0.8), inset 0 0 20px rgba(255, 255, 255, 0.05);
        max-height: 95vh;
        overflow-y: auto;
    }

    .cards-row {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 2rem;
        margin-bottom: 2rem;
        perspective: 1000px;
        width: 100%;
    }

    .artifact-card-wrapper {
        width: 220px;
        perspective: 1000px;
        z-index: 10;
    }

    .artifact-card {
        position: relative;
        background: rgba(0, 0, 0, 0.6);
        border: 2px solid var(--item-color);
        border-radius: 16px;
        padding: 2rem 1rem;
        text-align: center;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5), inset 0 0 30px rgba(0,0,0,0.8);
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 340px;
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s;
    }

    .artifact-card:hover {
        transform: translateY(-15px) scale(1.05);
        z-index: 10;
        box-shadow: 0 20px 50px rgba(0,0,0,0.6), 0 0 30px var(--item-color);
    }

    .flash-overlay {
        position: absolute;
        inset: 0;
        background: white;
        mix-blend-mode: overlay;
        z-index: 20;
        animation: card-flash 0.6s ease-out forwards;
        pointer-events: none;
    }

    @keyframes card-flash {
        0% { opacity: 1; }
        100% { opacity: 0; }
    }

    .shockwave {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100%;
        height: 100%;
        border: 2px solid white;
        border-radius: 16px;
        opacity: 0;
        z-index: -1;
        animation: shockwave-expand 0.8s ease-out forwards;
    }

    @keyframes shockwave-expand {
        0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; border-width: 10px; }
        10% { opacity: 1; }
        100% { transform: translate(-50%, -50%) scale(2); opacity: 0; border-width: 0px; }
    }

    .card-bg {
        position: absolute;
        inset: 0;
        opacity: 0.15;
        background: radial-gradient(circle at 50% 0%, var(--item-color), transparent 80%);
        z-index: 0;
    }

    .icon {
        font-size: 4.5rem;
        margin-bottom: 1.5rem;
        filter: drop-shadow(0 0 20px var(--item-color));
        transform: scale(1);
        animation: float-icon 4s ease-in-out infinite;
        z-index: 1;
    }

    @keyframes float-icon {
        0%, 100% { transform: translateY(0); filter: drop-shadow(0 0 20px var(--item-color)); }
        50% { transform: translateY(-10px); filter: drop-shadow(0 0 40px var(--item-color)) brightness(1.2); }
    }

    .info {
        z-index: 1;
        width: 100%;
    }

    .name {
        font-weight: 900;
        font-family: 'Chakra Petch', monospace;
        font-size: 1.3rem;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        line-height: 1.1;
        text-shadow: 0 0 10px rgba(0,0,0,0.8);
    }

    .separator {
        height: 2px;
        width: 60px;
        margin: 0.8rem auto;
        background: var(--item-color);
        box-shadow: 0 0 10px var(--item-color);
        opacity: 0.8;
    }

    .desc {
        font-size: 0.9rem;
        color: #ccc;
        line-height: 1.5;
        font-family: 'Inter', sans-serif;
    }

    .rarity-cursed {
        border-style: dashed;
        border-width: 2px;
        background: repeating-linear-gradient(
            45deg,
            rgba(0,0,0,0.8),
            rgba(0,0,0,0.8) 10px,
            rgba(255,0,0,0.05) 10px,
            rgba(255,0,0,0.05) 20px
        );
    }

    .rarity-legendary {
        border-width: 3px;
        animation: legendary-border 3s infinite alternate;
    }

    .rarity-legendary::before {
        content: '';
        position: absolute;
        inset: -5px;
        background: linear-gradient(45deg, #bd00ff, #00f3ff, #bd00ff);
        z-index: -2;
        filter: blur(20px);
        opacity: 0.6;
        animation: legendary-glow 3s infinite linear;
    }

    @keyframes legendary-border {
        0% { box-shadow: 0 0 20px var(--item-color); border-color: var(--item-color); }
        100% { box-shadow: 0 0 50px var(--item-color), inset 0 0 20px var(--item-color); border-color: #fff; }
    }

    @keyframes legendary-glow {
        0% { filter: blur(20px) hue-rotate(0deg); }
        100% { filter: blur(25px) hue-rotate(360deg); }
    }

    .rarity-badge {
        position: absolute;
        top: 12px;
        right: -32px;
        width: 120px;
        background: var(--item-color);
        color: #000;
        font-weight: 900;
        font-size: 0.7rem;
        transform: rotate(45deg);
        text-align: center;
        padding: 4px 0;
        font-family: 'Chakra Petch', monospace;
        letter-spacing: 0.1em;
        box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        z-index: 2;
    }

    .rarity-badge.legendary {
        background: linear-gradient(90deg, #bd00ff, #00f3ff);
        color: #fff;
        text-shadow: 0 1px 2px #000;
        animation: shimmer 2s infinite linear;
        background-size: 200% 100%;
    }

    @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    .result-footer {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 1rem;
        border-top: 1px solid rgba(255,255,255,0.1);
        padding-top: 1.5rem;
    }

    .calculation-box {
        background: rgba(0, 0, 0, 0.4);
        padding: 1rem 3rem;
        border-radius: 16px;
        border: 1px solid rgba(255,255,255,0.1);
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
    }

    .calculation-box::before {
        content: '';
        position: absolute;
        inset: -1px;
        border-radius: 16px;
        background: linear-gradient(90deg, transparent, var(--cyber-yellow), transparent);
        opacity: 0.3;
        z-index: -1;
    }

    .calc-label {
        color: #888;
        font-size: 0.9rem;
        letter-spacing: 0.2em;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
    }

    .calc-val {
        font-size: 4rem;
        font-weight: 900;
        color: #fff;
        text-shadow: 0 0 30px var(--cyber-yellow);
        line-height: 1;
        font-family: 'Chakra Petch', monospace;
    }

    @media (max-width: 768px) {
        .synthesis-panel {
            padding: 1.5rem 1rem;
            max-height: 85vh;
        }

        .cards-row {
            flex-direction: column;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .artifact-card-wrapper {
            width: 100%;
            max-width: 320px;
        }

        .artifact-card {
            min-height: auto;
            flex-direction: row;
            padding: 1rem;
            text-align: left;
            align-items: center;
        }

        .icon {
            font-size: 2.5rem;
            margin-bottom: 0;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .info {
            text-align: left;
        }

        .name {
            font-size: 1rem;
            margin-bottom: 0.2rem;
        }

        .separator {
            width: 30px;
            margin: 0.3rem 0;
            height: 2px;
        }

        .desc {
            font-size: 0.75rem;
        }

        .rarity-badge {
            top: auto;
            bottom: 5px;
            right: -25px;
            width: 100px;
            font-size: 0.6rem;
            padding: 2px 0;
        }

        .unstable-core {
            width: 100px;
            height: 100px;
        }

        .r1 { width: 160px; height: 160px; }
        .r2 { width: 220px; height: 220px; }
        .r3 { width: 280px; height: 280px; }

        .calc-val {
            font-size: 2.5rem;
        }
        .calculation-box {
            padding: 1rem 2rem;
            width: 100%;
        }
    }
</style>
</file>

<file path="src/lib/components/casino/GlitchOverlay.svelte">
<script lang="ts">
    import { onMount, createEventDispatcher, onDestroy } from 'svelte';
    import { fade } from 'svelte/transition';
    import { Howl } from 'howler';

    export let level: number = 0;
    const dispatch = createEventDispatcher();

    // === КОНФИГ ===
    const NIGHTMARE_PHRASES = [
        "TOO DEEP", "SYSTEM ROT", "NO SIGNAL", "VOID",
        "DATA CORRUPTION", "HELP ME", "I SEE YOU",
        "DISCONNECT", "FATAL ERROR", "IT'S COLD"
    ];

    // Мелкие ошибки для 2 уровня
    const SYSTEM_ERRORS = [
        "0x000F", "SYNC_FAIL", "NULL", "NaN", "ERR_CONNECTION", "404", "VOID_PTR"
    ];

    const WARNINGS = [
        "",
        "//: WARNING: SYSTEM INSTABILITY",
        "//: REALITY DISTORTION DETECTED",
        "//: CRITICAL ERROR. TURN BACK.",
        "//: REALITY ANCHOR FAILURE.",
        "FATAL."
    ];

    const WHISPER_FILES = ['/sounds/ih.wav', '/sounds/ns.wav', '/sounds/lby.wav', '/sounds/isy.wav'];

    let sounds: { [key: string]: Howl } = {};
    let whisperTimeout: NodeJS.Timeout;
    let prevLevel = 0;

    // Состояния визуалов
    let gifEyes: any[] = [];
    let glitchTexts: any[] = [];

    // Новые визуалы
    let ghostTexts: any[] = []; // Lvl 2
    let artifacts: any[] = [];  // Lvl 3

    let textInterval: NodeJS.Timeout;     // Lvl 5
    let ghostInterval: NodeJS.Timeout;    // Lvl 2
    let artifactInterval: NodeJS.Timeout; // Lvl 3

    // --- АУДИО ---
    function playRandomWhisper() {
        if (level !== 5) return;
        const file = WHISPER_FILES[Math.floor(Math.random() * WHISPER_FILES.length)];
        if (!file) return;

        const whisper = new Howl({ src: [file], volume: 0.8, rate: 0.7 });
        const pan = (Math.random() * 2) - 1;
        whisper.stereo(pan);
        whisper.play();

        const nextDelay = 15000 + Math.random() * 15000;
        whisperTimeout = setTimeout(playRandomWhisper, nextDelay);
    }

    // --- VISUALS ---

    // Level 2: Ghost Echoes
    function initLevel2Visuals() {
        if (ghostInterval) clearInterval(ghostInterval);
        ghostInterval = setInterval(() => {
            if (ghostTexts.length > 5) ghostTexts.shift();
            ghostTexts = [...ghostTexts, {
                id: Math.random(),
                x: Math.random() * 90,
                y: Math.random() * 90,
                text: SYSTEM_ERRORS[Math.floor(Math.random() * SYSTEM_ERRORS.length)],
                opacity: 0.3 + Math.random() * 0.4
            }];
        }, 800);
    }

    // Level 3: Corrupted Artifacts
    function initLevel3Visuals() {
        if (artifactInterval) clearInterval(artifactInterval);
        artifactInterval = setInterval(() => {
            if (artifacts.length > 8) artifacts.shift();
            artifacts = [...artifacts, {
                id: Math.random(),
                x: Math.random() * 95,
                y: Math.random() * 95,
                w: 20 + Math.random() * 100,
                h: 2 + Math.random() * 20,
            }];
        }, 300);
    }

    // Level 5: Nightmare
    function initNightmareVisuals() {
        gifEyes = [];
        for (let i = 0; i < 6; i++) {
            gifEyes.push({
                x: Math.random() * 90,
                y: Math.random() * 80,
                size: 150 + Math.random() * 250,
                jitterSpeed: 4 + Math.random() * 4
            });
        }

        if (textInterval) clearInterval(textInterval);
        textInterval = setInterval(() => {
            if (glitchTexts.length > 8) glitchTexts.shift();
            glitchTexts = [...glitchTexts, {
                id: Math.random(),
                x: 10 + Math.random() * 80,
                y: 10 + Math.random() * 80,
                text: NIGHTMARE_PHRASES[Math.floor(Math.random() * NIGHTMARE_PHRASES.length)],
                scale: 1 + Math.random() * 2,
            }];
        }, 2000);
    }

    function stopAllVisuals() {
        clearInterval(textInterval);
        clearInterval(ghostInterval);
        clearInterval(artifactInterval);
        glitchTexts = [];
        gifEyes = [];
        ghostTexts = [];
        artifacts = [];
    }

    onMount(() => {
        sounds.error = new Howl({ src: ['/sounds/error.mp3'], volume: 0.5 });
        sounds.alarm = new Howl({ src: ['/sounds/alarm.mp3'], volume: 0.4, loop: true });
        sounds.horror = new Howl({ src: ['/sounds/horror_ambient.mp3'], volume: 1.0, loop: true });
    });

    onDestroy(() => {
        Object.values(sounds).forEach(s => s.stop());
        clearTimeout(whisperTimeout);
        stopAllVisuals();
    });

    $: if (level !== prevLevel) {
        handleLevelChange(level);
        prevLevel = level;
    }

    function handleLevelChange(lvl: number) {
        // Очистка при смене уровня (чтобы эффекты не накладывались)
        stopAllVisuals();

        if (lvl === 0) {
            sounds.alarm?.stop();
            sounds.horror?.stop();
            clearTimeout(whisperTimeout);
            dispatch('restoreMusic');
            return;
        }

        if (lvl >= 1 && lvl <= 3) sounds.error?.play();

        // Запуск специфичных визуалов
        if (lvl === 2) initLevel2Visuals();
        if (lvl === 3) initLevel3Visuals();
        if (lvl === 5) initNightmareVisuals();

        if (lvl === 4) {
            dispatch('stopMusic');
            if (!sounds.horror?.playing()) sounds.horror?.play();
            if (!sounds.alarm?.playing()) sounds.alarm?.play();
        }

        if (lvl === 5) {
            sounds.alarm?.stop();
            if (!sounds.horror?.playing()) sounds.horror?.play();
            playRandomWhisper();
        }
    }
</script>

<div class="overlay-root level-{level}">

    <svg style="display: none;">
        <defs>
            <filter id="distortion">
                <feTurbulence type="fractalNoise" baseFrequency="0.01 0.005" numOctaves="5" seed="2">
                    <animate attributeName="baseFrequency" dur="20s" values="0.01 0.005;0.02 0.01;0.01 0.005" repeatCount="indefinite" />
                </feTurbulence>
                <feDisplacementMap in="SourceGraphic" scale="20" />
            </filter>
        </defs>
    </svg>

    <!-- === LEVEL 1-4 === -->
    {#if level >= 1 && level < 5}

        <!-- L1: NOISE -->
        {#if level >= 1} <div class="noise-layer"></div> {/if}

        <!-- L2: RGB + GHOSTS -->
        {#if level >= 2}
            <div class="rgb-shift"></div>
            {#each ghostTexts as g (g.id)}
                <div class="ghost-text" style="left: {g.x}%; top: {g.y}%; opacity: {g.opacity};" in:fade out:fade>
                    {g.text}
                </div>
            {/each}
        {/if}

        <!-- L3: VIGNETTE + ARTIFACTS -->
        {#if level >= 3}
            <div class="dark-vignette heart-beat"></div>
            {#each artifacts as a (a.id)}
                <div class="artifact" style="left: {a.x}%; top: {a.y}%; width: {a.w}px; height: {a.h}px;"></div>
            {/each}
        {/if}

        <!-- L4: MELTING -->
        {#if level >= 4}
            <div class="melting-layer"></div>
            <div class="color-drift"></div>
        {/if}

        <div class="hud-wrapper" class:distorted={level >= 4}>
            <div class="hud-warning" class:critical={level >= 4}>
                <!-- На 3 уровне мигает быстрее -->
                <span class:blink-fast={level>=3} class:blink-slow={level<3}>⚠️</span>
                {WARNINGS[level]}
            </div>
        </div>
    {/if}

    <!-- === LEVEL 5: THE ABYSS === -->
    {#if level >= 5}
        <div class="level-5-nightmare" in:fade={{duration: 3000}}>
            <div class="static-noise"></div>
            <div class="scanlines"></div>

            {#each gifEyes as eye}
                <div class="eye-wrapper" style="left: {eye.x}%; top: {eye.y}%; width: {eye.size}px; opacity: 0.5;">
                    <div class="eye-tint">
                        <img src="/casino/eye.gif" alt="" class="gif-eye" />
                    </div>
                </div>
            {/each}

            {#each glitchTexts as t (t.id)}
                <div class="creepy-text" style="left: {t.x}%; top: {t.y}%; font-size: {t.scale}rem;" in:fade out:fade>
                    {t.text}
                </div>
            {/each}

            <div class="main-horror">
                <h1 data-text="SIGNAL LOST">SIGNAL LOST</h1>
            </div>
            <div class="claustrophobia"></div>
        </div>
    {/if}

</div>

<style>
    .overlay-root {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none; z-index: 50; overflow: hidden;
    }

    /* === L1 === */
    .noise-layer {
        position: absolute; inset: 0; opacity: 0.1;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='1'/%3E%3C/svg%3E");
    }

    /* === L2 === */
    .rgb-shift {
        position: absolute; inset: 0; opacity: 0.3;
        box-shadow: inset 4px 0 rgba(0,255,255,0.2), inset -4px 0 rgba(255,0,255,0.2);
        mix-blend-mode: overlay;
        animation: breath 4s infinite alternate;
    }
    @keyframes breath { from { opacity: 0.2; } to { opacity: 0.4; } }

    .ghost-text {
        position: absolute; color: rgba(0, 243, 255, 0.4);
        font-family: 'Chakra Petch', monospace; font-size: 0.8rem;
        text-shadow: 0 0 5px rgba(0, 243, 255, 0.5);
        pointer-events: none;
    }

    /* === L3 === */
    .dark-vignette {
        position: absolute; inset: 0;
        background: radial-gradient(circle, transparent 40%, rgba(50, 0, 0, 0.4) 100%);
        transition: all 1s;
    }
    .heart-beat { animation: pulse-hp 1s infinite; }
    @keyframes pulse-hp {
        0% { box-shadow: inset 0 0 0 rgba(255,0,0,0); }
        50% { box-shadow: inset 0 0 50px rgba(255,0,0,0.2); }
        100% { box-shadow: inset 0 0 0 rgba(255,0,0,0); }
    }

    .artifact {
        position: absolute; background: rgba(255, 0, 60, 0.6);
        box-shadow: 0 0 5px red; animation: glitch-block 0.2s linear forwards;
    }
    @keyframes glitch-block { from { opacity: 1; transform: scaleX(1); } to { opacity: 0; transform: scaleX(0); } }

    /* === L4 === */
    .melting-layer {
        position: absolute; inset: 0;
        backdrop-filter: url(#distortion) blur(1px); opacity: 0.7; z-index: 10;
    }
    .color-drift {
        position: absolute; inset: 0;
        background: linear-gradient(120deg, rgba(255,0,0,0.1), rgba(0,0,255,0.1));
        mix-blend-mode: exclusion; animation: drift 10s infinite linear;
    }
    @keyframes drift { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }
    .hud-wrapper.distorted { filter: url(#distortion); opacity: 0.8; }

    /* === L5 === */
    .level-5-nightmare {
        position: fixed; inset: 0; z-index: 9999; background: #000000;
        font-family: 'Courier New', monospace; pointer-events: none; overflow: hidden;
    }
    .static-noise {
        position: absolute; inset: 0; opacity: 0.15;
        background: repeating-radial-gradient(#000 0 0.0001%, #111 0 0.0002%) 50% 0/2500px 2500px;
    }
    .scanlines {
        position: absolute; inset: 0;
        background: linear-gradient(to bottom, rgba(0,0,0,0) 50%, rgba(0,0,0,0.5) 50%);
        background-size: 100% 4px; z-index: 100;
    }
    .eye-wrapper { position: absolute; mix-blend-mode: lighten; z-index: 5; }
    .eye-tint { filter: grayscale(100%) brightness(0.6) sepia(1) hue-rotate(-50deg) saturate(5); }
    .gif-eye { width: 100%; display: block; opacity: 0.7; animation: slow-pulse 4s infinite alternate; }
    @keyframes slow-pulse { from { opacity: 0.4; } to { opacity: 0.8; } }
    .creepy-text {
        position: absolute; font-family: 'Chakra Petch', monospace; font-weight: 900; color: #300;
        text-shadow: 1px 1px 0 #000; z-index: 50; white-space: nowrap; pointer-events: none;
    }
    .main-horror {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 200;
    }
    .main-horror h1 {
        font-size: 6rem; color: #fff; text-transform: uppercase; letter-spacing: 0.2em;
        text-shadow: 0 0 20px #f00; opacity: 0.9; animation: glitch-anim 5s infinite;
    }
    @keyframes glitch-anim {
        0% { transform: skew(0deg); } 2% { transform: skew(10deg); } 4% { transform: skew(-10deg); } 6% { transform: skew(0deg); } 100% { transform: skew(0deg); }
    }
    .claustrophobia {
        position: absolute; inset: 0;
        background: radial-gradient(circle, transparent 20%, #000 85%);
        z-index: 150; animation: breathe-panic 10s infinite ease-in-out;
    }
    @keyframes breathe-panic { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }

    /* === HUD === */
    .hud-wrapper { position: absolute; top: 15%; width: 100%; text-align: center; z-index: 200; }
    .hud-warning {
        display: inline-block; background: rgba(0,0,0,0.8); color: #ffb000;
        border: 1px solid #ffb000; padding: 0.5rem 1rem; border-radius: 4px;
        font-family: 'Chakra Petch', monospace; font-size: 1.2rem;
    }
    .hud-warning.critical {
        color: #ff5555; border-color: #ff5555; background: #1a0000;
        font-size: 1.3rem; font-weight: bold;
    }
    .blink-slow { animation: blink 2s infinite; }
    .blink-fast { animation: blink 0.5s infinite; }
    @keyframes blink { 50% { opacity: 0.3; } }
    /* === MOBILE ADAPTATION === */
    @media (max-width: 768px) {
        /* HUD: Делаем компактнее */
        .hud-wrapper {
            top: 10%;
            width: 90%;
            left: 5%;
            transform: none; /* Убираем центровку через translate, используем margin */
        }

        .hud-warning {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
            width: 100%; /* Растягиваем на ширину контейнера */
            box-sizing: border-box;
            white-space: normal; /* Разрешаем перенос текста */
        }

        .hud-warning.critical {
            font-size: 1rem;
        }

        /* L4: ОПТИМИЗАЦИЯ ПРОИЗВОДИТЕЛЬНОСТИ */
        /* SVG фильтры убивают мобильные GPU, заменяем на упрощенные эффекты */
        .melting-layer {
            backdrop-filter: none; /* Выключаем тяжелое искажение */
            background: rgba(80, 0, 20, 0.3); /* Просто красный туман */
            mix-blend-mode: overlay;
        }

        /* Усиливаем дрифт цветов, раз убрали искажение */
        .color-drift {
            opacity: 0.8;
            animation-duration: 5s;
        }

        /* L5: ГЛАВНЫЙ ТЕКСТ */
        .main-horror h1 {
            font-size: 3rem; /* Было 6-8rem, уменьшаем до 3 */
            line-height: 1.1;
            text-align: center;
            width: 100vw;
            padding: 0 10px;
            word-break: break-word;
        }

        /* L5: ГЛАЗА */
        .eye-wrapper {
            /* Ограничиваем размер глаз на мобиле, чтобы не закрывали весь экран */
            transform: scale(0.6) !important;
        }

        /* L5: ПЛАВАЮЩИЙ ТЕКСТ */
        .creepy-text {
            font-size: 1.5rem !important; /* Принудительно уменьшаем */
        }

        /* Виньетка более агрессивная на мобилках */
        .claustrophobia {
            background: radial-gradient(circle, transparent 10%, #000 95%);
        }
    }
</style>
</file>

<file path="src/lib/components/CyberTurnstile.svelte">
<script lang="ts">
    import { onMount, createEventDispatcher } from 'svelte';

    export let siteKey: string;

    const dispatch = createEventDispatcher();

    let container: HTMLDivElement;
    let widgetId: string | null = null;
    let isLoaded = false;

    // Загружаем скрипт Cloudflare
    onMount(() => {
        // Проверяем, не загружен ли уже скрипт
        if (window.turnstile) {
            renderWidget();
            return;
        }

        // Загружаем скрипт Turnstile
        const script = document.createElement('script');
        script.src = 'https://challenges.cloudflare.com/turnstile/v0/api.js';
        script.async = true;
        script.defer = true;

        script.onload = () => {
            console.log('✅ Turnstile загружен');
            renderWidget();
        };

        script.onerror = () => {
            console.error('❌ Не удалось загрузить Turnstile');
        };

        document.head.appendChild(script);

        return () => {
            // Cleanup при размонтировании
            if (widgetId && window.turnstile) {
                window.turnstile.remove(widgetId);
            }
        };
    });

    function renderWidget() {
        if (!container || !window.turnstile) return;

        widgetId = window.turnstile.render(container, {
            sitekey: siteKey,
            theme: 'dark',
            callback: (token: string) => {
                console.log('✅ Turnstile пройден');
                dispatch('verified', { token });
            },
            'error-callback': () => {
                console.error('❌ Turnstile ошибка');
                dispatch('error');
            },
            'expired-callback': () => {
                console.warn('⚠️ Turnstile истёк');
                dispatch('expired');
            }
        });

        isLoaded = true;
    }
</script>

<div class="turnstile-container">
    <div bind:this={container} class="cf-turnstile-placeholder">
        {#if !isLoaded}
            <div class="loading">
                <span>Загрузка проверки...</span>
            </div>
        {/if}
    </div>
</div>

<style>
    .turnstile-container {
        /* Киберпанк-обёртка */
        position: relative;
        display: inline-block;
        padding: 10px;
        background: rgba(10, 10, 10, 0.5);
        border: 1px solid rgba(252, 238, 10, 0.3);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);

        /* Срезанные углы */
        clip-path: polygon(
            0 10px,
            10px 0,
            100% 0,
            100% calc(100% - 10px),
            calc(100% - 10px) 100%,
            0 100%
        );

        transition: border-color 0.3s ease;
    }

    .turnstile-container:hover {
        border-color: rgba(252, 238, 10, 0.6);
    }

    .cf-turnstile-placeholder {
        min-width: 300px;
        min-height: 65px;
    }

    .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 65px;
        color: rgba(252, 238, 10, 0.8);
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* Глобальные стили для iframe Cloudflare */
    :global(.cf-turnstile) {
        margin: 0 auto;
    }
</style>
</file>

<file path="src/lib/components/Modal.svelte">
<script lang="ts">
    import { modal } from '$lib/stores/modalStore';
    import { quintOut } from 'svelte/easing';
    import { scale, fade } from 'svelte/transition';
    import NeonButton from './NeonButton.svelte';
    import { AudioManager } from '$lib/client/audioManager';
    import { browser } from '$app/environment';

    let selectedReason = '';
    $: if ($modal.isOpen && $modal.reportOptions) {
        selectedReason = $modal.reportOptions[0]?.id || '';
    }

    let previouslyOpen = false;
    $: if (browser) {
        if ($modal.isOpen && !previouslyOpen) {
            switch ($modal.type) {
                case 'success':
                case 'info':
                    AudioManager.play('success');
                    break;
                case 'error':
                case 'warning':
                    AudioManager.play('fail');
                    break;
            }
        }
        previouslyOpen = $modal.isOpen;
    }
    function handleSecondaryClick(action: () => void) {
        AudioManager.play('click_alt');
        action();
    }
</script>

{#if $modal.isOpen}
    <div
        class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4"
        on:click|self={modal.close}
        transition:fade={{ duration: 200 }}
    >
        <div
            class="modal-container cyber-panel max-w-md w-full relative overflow-hidden"
            role="dialog"
            aria-modal="true"
            aria-labelledby="modal-title"
            transition:scale={{ duration: 250, start: 0.95, easing: quintOut }}
        >
            <div class="corner-bg top-left" class:is-error={$modal.type === 'error'}></div>
            <div class="corner-bg top-right" class:is-error={$modal.type === 'error'}></div>
            <div class="corner-bg bottom-left" class:is-error={$modal.type === 'error'}></div>
            <div class="corner-bg bottom-right" class:is-error={$modal.type === 'error'}></div>

            <div class="top-bar" class:is-error={$modal.type === 'error'}>
                <span class="pl-6 text-sm">
                    {#if $modal.type === 'error'}SYSTEM_FAILURE{:else if $modal.type === 'success'}TRANSACTION_OK{:else}SYSTEM_ALERT{/if}
                </span>
            </div>

            <div class="p-6 sm:p-8 relative text-center">
                <!-- Динамическая иконка в зависимости от типа -->
                <div class="w-12 h-12 mx-auto mb-4">
                    {#if $modal.type === 'success'}
                        <!-- Зеленая галочка -->
                        <div class="text-green-400">
                             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-full h-full"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        </div>
                    {:else if $modal.type === 'error'}
                        <!-- Красный крестик -->
                        <div class="text-red-500">
                             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-full h-full"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        </div>
                    {:else} <!-- 'info' или 'warning' -->
                        <!-- Желтый треугольник -->
                        <div class="text-cyber-yellow">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-full h-full"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
                        </div>
                    {/if}
                </div>

                <h3 class="modal-title font-display" id="modal-title">
                    {$modal.title}
                </h3>

                <div class="mt-2">
                    <p class="modal-message">
                        {@html $modal.message}
                    </p>
                    {#if $modal.reportOptions && $modal.onReportSubmit}
                        <div class="report-options-list mt-6 text-left">
                            {#each $modal.reportOptions as option (option.id)}
                                <label class="report-option">
                                    <input
                                        type="radio"
                                        name="report-reason"
                                        value={option.id}
                                        bind:group={selectedReason}
                                        on:change={() => $modal.onReportSubmit?.(selectedReason)}
                                    />
                                    <span class="custom-radio"></span>
                                    <span>{option.label}</span>
                                </label>
                            {/each}
                        </div>
                    {/if}
                </div>
            </div>

            <div class="modal-actions px-6 sm:px-8 pb-6 flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-4 space-y-2 space-y-reverse sm:space-y-0">
                {#each $modal.actions as button}
                    {#if button.class === 'primary'}
                        <NeonButton on:click={button.action} extraClass="w-full sm:w-auto" color={$modal.type === 'error' ? 'red' : 'cyan'}>
                            {button.text}
                        </NeonButton>
                    {:else}
                         <button type="button" class="cancel-btn w-full sm:w-auto" on:click={() => handleSecondaryClick(button.action)}>
                            {button.text}
                         </button>
                    {/if}
                {/each}
            </div>
        </div>
    </div>
{/if}

<style>
    .modal-container {
        background: rgba(10, 10, 10, 0.9);
        border: 1px solid rgba(0, 240, 255, 0.3); /* Cyan border */
        box-shadow: 0 0 25px rgba(0, 240, 255, 0.2);
        clip-path: polygon(0 15px, 15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%);
    }

    .modal-container.is-error {
        border-color: rgba(255, 0, 60, 0.4);
        box-shadow: 0 0 25px rgba(255, 0, 60, 0.3);
    }

    .corner-bg {
        @apply absolute w-16 h-16;
        background: radial-gradient(circle, var(--cyber-cyan, #00f0ff) 0%, rgba(0, 240, 255, 0) 60%);
        opacity: 0.1;
        filter: blur(5px);
        animation: spin 20s linear infinite;
    }
    .corner-bg.is-error {
        background: radial-gradient(circle, var(--cyber-red, #ff003c) 0%, rgba(255, 0, 60, 0) 60%);
    }

    .top-left { top: -30px; left: -30px; }
    .top-right { top: -30px; right: -30px; animation-delay: -5s; }
    .bottom-left { bottom: -30px; left: -30px; animation-delay: -10s; }
    .bottom-right { bottom: -30px; right: -30px; animation-delay: -15s; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .top-bar {
        @apply p-2 text-xs uppercase tracking-widest text-cyber-cyan/70 font-display;
        border-bottom: 1px solid rgba(0, 240, 255, 0.2);
        position: relative;
    }
    .top-bar.is-error {
        border-bottom-color: rgba(255, 0, 60, 0.3);
        color: var(--cyber-red);
    }
    .top-bar::before {
        content: '';
        @apply absolute top-1/2 left-2 w-2 h-2 rounded-full bg-cyber-cyan;
        transform: translateY(-50%);
        box-shadow: 0 0 5px var(--cyber-cyan);
        animation: pulse-light 2s infinite;
    }
    .top-bar.is-error::before {
        background-color: var(--cyber-red);
        box-shadow: 0 0 5px var(--cyber-red);
    }
    @keyframes pulse-light {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .modal-title {
        @apply text-2xl font-bold text-white text-center;
    }

    .modal-message {
        @apply mt-2 text-lg text-gray-300 text-center leading-relaxed;
    }

    .modal-actions {
        border-top: 1px solid rgba(0, 240, 255, 0.1);
        padding-top: 1.5rem;
    }

    .cancel-btn {
        @apply block sm:w-auto w-full text-center py-3 px-6 rounded-md border border-gray-600 text-gray-300 font-display uppercase tracking-widest text-sm;
        transition: all 0.2s;
    }
    .cancel-btn:hover {
        background-color: transparent;
        border-color: var(--cyber-red, #ff003c);
        color: var(--cyber-red, #ff003c);
        text-shadow: 0 0 8px var(--cyber-red, #ff003c);
        transform: translateY(-2px);
    }

    .report-options-list {
        @apply space-y-3;
    }

    .report-option {
        @apply flex items-center p-3 rounded-md cursor-pointer;
        background-color: rgba(255, 255, 255, 0.05);
        transition: background-color 0.2s;
    }
    .report-option:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .report-option input[type="radio"] {
        @apply absolute opacity-0 w-0 h-0;
    }

    .report-option .custom-radio {
        @apply w-5 h-5 rounded-full border-2 border-gray-500 mr-4 shrink-0;
        transition: all 0.2s;
    }

    .report-option input[type="radio"]:checked + .custom-radio {
        @apply border-cyber-yellow;
        background-color: var(--cyber-yellow);
        box-shadow: 0 0 5px var(--cyber-yellow);
    }
</style>
</file>

<file path="src/lib/components/NeonButton.svelte">
<script lang="ts">
    import { AudioManager } from '$lib/client/audioManager';
    export let href: string | null = null;
    export let type: 'button' | 'submit' | 'reset' = 'button';
    export let disabled = false;
    export let extraClass: string = '';
    function handleClick() {
        if (!disabled) {
            AudioManager.play('click');
        }
    }
</script>

{#if href}
    <a {href} class="neon-btn {extraClass}" class:disabled on:click={handleClick}>
    <span class="btn-content"><slot /></span>

    </a>
{:else}
    <button {type} {disabled} class="neon-btn {extraClass}" on:click={handleClick} on:click>
    <span class="btn-content"><slot /></span>
    </button>
{/if}

<style>
    .neon-btn {
        @apply relative inline-block px-6 py-2 uppercase tracking-widest font-bold text-lg;
        color: var(--primary-color, #00f0ff);
        border: 2px solid var(--primary-color, #00f0ff);
        background: transparent;
        overflow: hidden;
        transition: color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        box-shadow: 0 0 5px var(--primary-color, #00f0ff),
                    inset 0 0 5px var(--primary-color, #00f0ff);
    }

    .btn-content {
        position: relative;
        z-index: 1;
    }

    .neon-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(120deg, transparent, var(--primary-color, #00f0ff), transparent);
        transition: left 0.5s ease-in-out;
        z-index: 0;

    }

    .neon-btn:hover {
        color: --primary-color;
        box-shadow: 0 0 25px var(--primary-color, #00f0ff);
    }

    .neon-btn:hover::before {
        left: 100%;
    }

    .neon-btn.disabled {
        @apply border-gray-600 text-gray-600 cursor-not-allowed;
        box-shadow: none;
    }
     .neon-btn.disabled:hover {
        @apply border-gray-600 text-gray-600;
         box-shadow: none;
     }
     .neon-btn.disabled::before {
         display: none;
     }
</style>
</file>

<file path="src/lib/components/SettingsModal.svelte">
<script lang="ts">
    import { fade, scale } from 'svelte/transition';
    import { settingsStore } from '$lib/stores/settingsStore';
    import { t, locale } from 'svelte-i18n';
    import { createEventDispatcher } from 'svelte';
    import { browser } from '$app/environment';

    const dispatch = createEventDispatcher();

    function close() {
        dispatch('close');
    }

    function changeLang(newLang: string) {
        locale.set(newLang);
        localStorage.setItem('protomap_lang', newLang);
    }

    function handleSeasonalChange() {
        // Даем время стору обновить localStorage перед перезагрузкой
        setTimeout(() => {
            if (browser) {
                window.location.reload();
            }
        }, 200);
    }
</script>

<div
    class="fixed top-0 left-0 w-screen h-[100dvh] z-[9999] bg-black/80 backdrop-blur-md flex items-center justify-center p-4"
    transition:fade
    on:click|self={close}
>
    <div class="settings-panel cyber-panel" transition:scale={{start: 0.95}}>
        <div class="panel-header">
            <h3 class="font-display text-xl text-white">// {$t('menu.system')}</h3>
            <button class="close-btn" on:click={close}>&times;</button>
        </div>

        <div class="panel-body">
            <div class="setting-row">
                <span class="label">{$t('menu.lang')}</span>
                <div class="lang-switch">
                    <button class="lang-btn" class:active={$locale === 'ru'} on:click={() => changeLang('ru')}>RU</button>
                    <button class="lang-btn" class:active={$locale === 'en'} on:click={() => changeLang('en')}>EN</button>
                </div>
            </div>

            <hr class="separator">

            <label class="setting-row">
                <span class="label">{$t('menu.sound')}</span>
                <input type="checkbox" bind:checked={$settingsStore.audioEnabled} class="cyber-switch">
            </label>

            <label class="setting-row">
                <span class="label">{$t('menu.anim')}</span>
                <input type="checkbox" bind:checked={$settingsStore.cinematicLoadsEnabled} class="cyber-switch">
            </label>

            <label class="setting-row">
                <span class="label">{$t('menu.seasonal')} <span class="text-xs text-red-400 ml-1">(RELOAD)</span></span>
                <input
                    type="checkbox"
                    bind:checked={$settingsStore.seasonalEnabled}
                    on:change={handleSeasonalChange}
                    class="cyber-switch"
                >
            </label>
        </div>

        <div class="panel-footer">
            <button class="save-btn" on:click={close}>OK</button>
        </div>
    </div>
</div>

<style>
    .settings-panel {
        width: 100%; max-width: 400px;
        background: rgba(10, 15, 20, 0.95);
        border: 1px solid var(--cyber-cyan);
        box-shadow: 0 0 30px rgba(0, 240, 255, 0.15);
        border-radius: 12px; overflow: hidden;
    }

    .panel-header {
        display: flex; justify-content: space-between; align-items: center;
        padding: 1rem 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1);
        background: rgba(0, 243, 255, 0.05);
    }
    .close-btn { font-size: 1.5rem; color: #666; transition: color 0.2s; line-height: 1; }
    .close-btn:hover { color: #fff; }

    .panel-body { padding: 1.5rem; display: flex; flex-direction: column; gap: 1.2rem; }

    .setting-row { display: flex; justify-content: space-between; align-items: center; }
    .label { font-family: 'Chakra Petch', monospace; font-weight: bold; color: #ccc; font-size: 0.9rem; }

    .separator { border: 0; border-top: 1px dashed rgba(255,255,255,0.1); margin: 0.5rem 0; }

    .lang-switch { display: flex; background: #222; border-radius: 6px; padding: 2px; border: 1px solid #444; }
    .lang-btn {
        padding: 4px 12px; font-size: 0.8rem; font-weight: bold; color: #888; border-radius: 4px;
        transition: all 0.2s;
    }
    .lang-btn.active { background: var(--cyber-cyan); color: #000; box-shadow: 0 0 10px var(--cyber-cyan); }

    .panel-footer { padding: 1rem; border-top: 1px solid rgba(255,255,255,0.1); text-align: center; }
    .save-btn {
        width: 100%; padding: 0.8rem; background: transparent; border: 1px solid var(--cyber-cyan);
        color: var(--cyber-cyan); font-weight: bold; font-family: 'Chakra Petch', monospace;
        text-transform: uppercase; transition: all 0.2s; cursor: pointer;
    }
    .save-btn:hover { background: var(--cyber-cyan); color: #000; box-shadow: 0 0 15px var(--cyber-cyan); }

    .cyber-switch { appearance: none; width: 44px; height: 24px; background: #333; border-radius: 99px; position: relative; cursor: pointer; transition: all 0.3s; border: 1px solid #555; }
    .cyber-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 18px; height: 18px; background: #888; border-radius: 50%; transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); }
    .cyber-switch:checked { background: rgba(0, 240, 255, 0.2); border-color: var(--cyber-cyan); }
    .cyber-switch:checked::after { left: 22px; background: var(--cyber-cyan); box-shadow: 0 0 10px var(--cyber-cyan); }
</style>
</file>

<file path="src/lib/components/Snowfall.svelte">
<script lang="ts">
    import { onMount, onDestroy } from 'svelte';
    import { browser } from '$app/environment';

    let canvas: HTMLCanvasElement;
    let ctx: CanvasRenderingContext2D | null;
    let animationFrameId: number;

    // === НАСТРОЙКИ ===
    const COUNT_PC = 70;      // Чуть больше снега для ПК, раз он легкий
    const COUNT_MOBILE = 25;  // Бережем мобилки
    const WIND = 0.5;         // Сила ветра (0 = ровно вниз, 1 = сильно вправо, -1 = влево)
    const SPEED_MODIFIER = 1; // Множитель скорости

    let particles: { x: number; y: number; r: number; speed: number }[] = [];

    function initSnow() {
        if (!canvas) return;
        const width = window.innerWidth;
        const height = window.innerHeight;
        // Учитываем pixel ratio для четкости на Retina/OLED экранах
        const dpr = window.devicePixelRatio || 1;

        canvas.width = width * dpr;
        canvas.height = height * dpr;

        // Масштабируем контекст, чтобы стили CSS (width: 100%) совпадали с пикселями
        ctx = canvas.getContext('2d');
        if (!ctx) return;
        ctx.scale(dpr, dpr);

        const count = width < 768 ? COUNT_MOBILE : COUNT_PC;

        particles = [];
        for (let i = 0; i < count; i++) {
            particles.push({
                x: Math.random() * width,
                y: Math.random() * height,
                r: Math.random() * 2 + 0.5, // Радиус от 0.5 до 2.5
                // Чем больше снежинка, тем быстрее она падает (эффект глубины)
                speed: (Math.random() * 1.5 + 0.5) * SPEED_MODIFIER
            });
        }
    }

    function draw() {
        if (!ctx || !canvas) return;

        // Размеры в CSS пикселях (логические)
        const width = window.innerWidth;
        const height = window.innerHeight;

        // Очищаем (для Canvas это быстрее, чем fillRect с прозрачностью)
        ctx.clearRect(0, 0, width, height);

        ctx.fillStyle = "rgba(255, 255, 255, 0.7)";
        ctx.beginPath();

        for (let i = 0; i < particles.length; i++) {
            const p = particles[i];

            // Рисуем
            ctx.moveTo(p.x, p.y);
            ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2, true);

            // === ОБНОВЛЯЕМ КООРДИНАТЫ (ПРОСТАЯ ФИЗИКА) ===
            p.y += p.speed;     // Падаем вниз
            p.x += WIND;        // Снос ветром

            // Если улетела за низ экрана -> телепорт наверх
            if (p.y > height) {
                p.y = -5;
                p.x = Math.random() * width; // Рандомная позиция по X
            }

            // Если улетела за правый край -> телепорт влево
            if (p.x > width + 5) {
                p.x = -5;
                p.y = Math.random() * height;
            }
            // Если улетела за левый край (если ветер отрицательный) -> телепорт вправо
            else if (p.x < -5) {
                p.x = width + 5;
                p.y = Math.random() * height;
            }
        }

        ctx.fill();
        animationFrameId = requestAnimationFrame(draw);
    }

    onMount(() => {
        if (browser) {
            initSnow();
            draw();
            window.addEventListener('resize', initSnow);
        }
    });

    onDestroy(() => {
        if (browser) {
            window.removeEventListener('resize', initSnow);
            cancelAnimationFrame(animationFrameId);
        }
    });
</script>

<canvas bind:this={canvas} class="snow-canvas"></canvas>

<style>
    .snow-canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 0; /* Под интерфейсом */
    }
</style>
</file>

<file path="src/lib/stores/modalStore.ts">
import { writable } from 'svelte/store';
export type ModalType = 'info' | 'success' | 'warning' | 'error';

export type ModalAction = {
    text: string;
    action: () => void;
    class?: string;
};

export type ReportOption = {
    id: string;
    label: string;
};

export type ModalState = {
    isOpen: boolean;
    title: string;
    message: string;
    actions: ModalAction[];
    type: ModalType;
    reportOptions?: ReportOption[];
    onReportSubmit?: (selectedReason: string) => void;
};

function createModalStore() {
    const initialState: ModalState = {
        isOpen: false,
        title: '',
        message: '',
        actions: [],
        type: 'info',
        reportOptions: undefined,
        onReportSubmit: undefined
    };

    const { subscribe, set } = writable<ModalState>(initialState);

    const close = () => set(initialState);

    return {
        subscribe,
        info: (title: string, message: string) => set({
            isOpen: true,
            title,
            message,
            type: 'info',
            actions: [{ text: 'OK', action: close, class: 'primary' }]
        }),
        success: (title: string, message: string) => set({
            isOpen: true,
            title,
            message,
            type: 'success',
            actions: [{ text: 'Отлично!', action: close, class: 'primary' }]
        }),
        error: (title: string, message: string) => set({
            isOpen: true,
            title,
            message,
            type: 'error',
            actions: [{ text: 'Закрыть', action: close, class: 'primary' }]
        }),
        warning: (title: string, message: string) => set({
            isOpen: true,
            title,
            message,
            type: 'warning',
            actions: [{ text: 'Понятно', action: close, class: 'primary' }]
        }),
        confirm: (title: string, message: string, onConfirm: () => void) => set({
            isOpen: true,
            title,
            message,
            type: 'warning',
            actions: [
                { text: 'Да, подтвердить', action: () => { onConfirm(); close(); }, class: 'primary' },
                { text: 'Отмена', action: close, class: 'secondary' }
            ]
        }),
        report: (title: string, message: string, options: ReportOption[], onSubmit: (selectedReason: string) => void) => {
            let selectedReason = options[0]?.id || '';

            set({
                isOpen: true,
                title,
                message,
                type: 'warning',
                reportOptions: options.map(opt => ({...opt, selected: selectedReason === opt.id })),
                onReportSubmit: (reason) => {
                    selectedReason = reason;
                },
                actions: [
                    {
                        text: 'Отправить жалобу',
                        action: () => {
                            onSubmit(selectedReason);
                        },
                        class: 'primary'
                    },
                    { text: 'Отмена', action: close, class: 'secondary' }
                ]
            });
        },
        close
    };
}

export const modal = createModalStore();
</file>

<file path="src/lib/transitions.ts">
import { cubicOut } from 'svelte/easing';
import type { TransitionConfig } from 'svelte/transition';

// 1. ПЕРЕХОД ДЛЯ "ИСЧЕЗАНИЯ" СТАРОЙ СТРАНИЦЫ
export function glitchOut(node: Element, { duration = 300 }): TransitionConfig {
    return {
        duration,
        css: (t: number) => {
            // t идет от 1 (начало) до 0 (конец)
            const eased_t = cubicOut(t);
            return `
                opacity: ${eased_t};
                filter: blur(${ (1 - eased_t) * 5 }px) grayscale(${1 - eased_t});
                transform: scale(${ 0.98 + (eased_t * 0.02) });
            `;
        }
    };
}

// 2. ПЕРЕХОД ДЛЯ "ПОЯВЛЕНИЯ" НОВОЙ СТРАНИЦЫ
export function scanIn(node: Element, { duration = 400, delay = 200 }): TransitionConfig {
    return {
        duration,
        delay, // Начинаем анимацию с задержкой, чтобы 'out' успел начаться
        css: (t: number) => {
            // t идет от 0 (начало) до 1 (конец)
            return `
                opacity: ${t};
                filter: blur(${ (1 - t) * 5 }px);
                transform: scale(${ 0.99 + (t * 0.01) });
            `;
        }
    };
}
</file>

<file path="src/routes/+error.svelte">
<script lang="ts">
	import { page } from '$app/stores';
</script>

<svelte:head>
	<title>404: Сигнал потерян | ProtoMap</title>
</svelte:head>

<div class="error-container">
    <div class="background-effects">
        <div class="grid-overlay"></div>
        <div class="scanline"></div>
        <div class="vignette"></div>
    </div>

    <div class="content">
        <div class="radar">
            <div class="sweep"></div>
        </div>

        <h1 class="glitch" data-text="404: NODE NOT FOUND">404: NODE NOT FOUND</h1>
        <p class="subtitle">Сигнал потерян. Запрашиваемый узел не отвечает или не существует в этом секторе сети.</p>
        <p class="error-details">Код ошибки: {$page.status} // URL: {$page.url.pathname}</p>

        <a href="/" class="return-btn font-display">
            <span>&lt;</span> ВЕРНУТЬСЯ НА ГЛАВНУЮ КАРТУ
        </a>
    </div>
</div>

<style>
    @keyframes sweep-anim {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    @keyframes pulse-light {
        0%, 100% { opacity: 0.5; }
        50% { opacity: 1; }
    }
    @keyframes glitch-anim { 0% { clip-path: inset(15% 0 70% 0); transform: translateX(-2px); } 100% { clip-path: inset(80% 0 5% 0); transform: translateX(2px); } }
    @keyframes glitch-anim-2 { 0% { clip-path: inset(5% 0 90% 0); } 100% { clip-path: inset(70% 0 15% 0); } }
    @keyframes scanline-anim { 0% { transform: translateY(-50vh); } 100% { transform: translateY(150vh); } }

    .error-container {
        position: fixed; top: 0; left: 0;
        width: 100vw; height: 100vh;
        background-color: #050a05;
        color: var(--cyber-red, #ff3300);
        font-family: 'Chakra Petch', monospace;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        overflow: hidden;
    }

    .background-effects { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
    .grid-overlay {
        position: absolute; width: 100%; height: 100%; opacity: 0.1;
        background-image: linear-gradient(rgba(255, 51, 0, 0.2) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 51, 0, 0.2) 1px, transparent 1px);
        background-size: 40px 40px;
    }
    .scanline {
        position: absolute; width: 100%; height: 150px;
        background: linear-gradient(to bottom, transparent, rgba(255, 51, 0, 0.1), transparent);
        animation: scanline-anim 5s linear infinite; opacity: 0.7;
    }
    .vignette {
        position: absolute; width: 100%; height: 100%;
        background: radial-gradient(circle, transparent 40%, black 120%);
    }

    .content {
        z-index: 10;
        padding: 2rem;
    }

    .radar {
        width: 150px; height: 150px;
        border: 2px solid rgba(255, 51, 0, 0.3);
        border-radius: 50%;
        margin: 0 auto 2rem auto;
        position: relative;
        background: radial-gradient(circle, rgba(255, 51, 0, 0.1) 0%, transparent 70%);
    }
    .radar::before, .radar::after {
        content: '';
        position: absolute;
        top: 50%; left: 0;
        width: 100%; height: 1px;
        background: rgba(255, 51, 0, 0.2);
    }
    .radar::after {
        transform: rotate(90deg);
    }

    .sweep {
        width: 50%; height: 50%;
        position: absolute;
        top: 0; left: 0;
        transform-origin: 100% 100%;
        background: linear-gradient(45deg, transparent 50%, rgba(255, 51, 0, 0.7) 100%);
        animation: sweep-anim 3s linear infinite;
    }

    h1 {
        font-size: 3rem;
        font-weight: 700;
        text-transform: uppercase;
        margin-bottom: 0.5rem;
    }
    .subtitle {
        font-size: 1rem;
        color: rgba(255,255,255,0.6);
        max-width: 40ch;
        margin: 0 auto 2rem auto;
    }
    .error-details {
        font-size: 0.8rem;
        color: rgba(255,255,255,0.3);
        margin-bottom: 3rem;
    }

    .return-btn {
        display: inline-block;
        padding: 0.75rem 1.5rem;
        border: 2px solid var(--cyber-red);
        color: var(--cyber-red);
        text-decoration: none;
        transition: all 0.2s;
    }
    .return-btn:hover {
        background: var(--cyber-red);
        color: #000;
        box-shadow: 0 0 20px var(--cyber-red);
    }
    .return-btn span {
        margin-right: 0.5rem;
        display: inline-block;
        transition: transform 0.2s;
    }
    .return-btn:hover span {
        transform: translateX(-5px);
    }

    .glitch { position: relative; }
    .glitch::before, .glitch::after {
        content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #050a05; overflow: hidden;
    }
    .glitch::before { text-shadow: -2px 0 var(--cyber-yellow); left: 2px; animation: glitch-anim 2s infinite linear alternate-reverse; }
    .glitch::after { text-shadow: 2px 0 var(--cyber-cyan, #00f0ff); left: -2px; animation: glitch-anim-2 2s 0.2s infinite linear alternate-reverse; }
</style>
</file>

<file path="src/routes/+page.svelte">
<script lang="ts">
    import { onMount, onDestroy } from 'svelte';
    import { browser } from '$app/environment';

    let mapInstance: { map: any; markers: any; destroy: () => void } | null = null;

    onMount(async () => {
        if (browser) {
            const mapModule = await import('$lib/client/mapLogic');
            const result = mapModule.initMap('map-container');
            mapInstance = result;
        }
    });

    onDestroy(() => {
        if (mapInstance) {
            mapInstance.destroy();
            mapInstance = null;
        }
    });
</script>

<div class="flex-grow w-full h-[calc(100vh-64px)] relative overflow-hidden">
    <div id="map-container" class="w-full h-full" style="background: #050a10;"></div>
</div>
</file>

<file path="src/routes/admin/+layout.server.ts">
import { error, redirect } from '@sveltejs/kit';
import type { LayoutServerLoad } from './$types';
import { ADMIN_UIDS } from '$env/static/private';

const adminList = ADMIN_UIDS ? ADMIN_UIDS.split(',') : [];

export const load: LayoutServerLoad = async ({ locals }) => {
    // 1. Если не вошел - на логин
    if (!locals.user) {
        throw redirect(303, '/login');
    }

    // 2. Если вошел, но не админ - 403 с издевкой
    if (!adminList.includes(locals.user.uid)) {
        throw error(403, 'ОТКАЗАНО В ДОСТУПЕ. Уровень допуска: "Смертный". Возвращайтесь в песочницу.');
    }

    return {
        user: locals.user
    };
};
</file>

<file path="src/routes/admin/+page.server.ts">
import { firestoreAdmin } from '$lib/server/firebase.admin';
import { error, redirect } from '@sveltejs/kit';
import type { PageServerLoad } from './$types';
import { ADMIN_UIDS } from '$env/static/private';

const adminList = ADMIN_UIDS ? ADMIN_UIDS.split(',') : [];

export const load: PageServerLoad = async ({ locals }) => {
    // 1. Проверка прав (как в layout, но на всякий случай)
    if (!locals.user || !adminList.includes(locals.user.uid)) {
        throw error(403, 'Access Denied');
    }

    try {
        // 2. Читаем данные банка
        const bankDoc = await firestoreAdmin.collection('system').doc('casino_stats').get();
        const bankData = bankDoc.data();
        const bankBalance = bankData?.bank_balance || 0;

        // 3. Читаем статистику пользователей (опционально, для красоты)
        // count() - это дешевая агрегация
        const usersSnapshot = await firestoreAdmin.collection('users').count().get();
        const totalUsers = usersSnapshot.data().count;

        return {
            bankBalance,
            totalUsers
        };

    } catch (e) {
        console.error("Admin Dashboard Error:", e);
        return {
            bankBalance: 0,
            totalUsers: 0
        };
    }
};
</file>

<file path="src/routes/admin/tracker/+page.server.ts">
import { firestoreAdmin } from '$lib/server/firebase.admin';
import { fail, redirect } from '@sveltejs/kit';
import type { Actions, PageServerLoad } from './$types';
import { FieldValue } from 'firebase-admin/firestore';
import { ADMIN_UIDS } from '$env/static/private';

const adminList = ADMIN_UIDS ? ADMIN_UIDS.split(',') : [];

// Добавили assignee
export type Task = {
    id: string;
    title: string;
    description: string;
    platform: 'web' | 'app' | 'backend' | 'design';
    priority: 'low' | 'medium' | 'critical';
    status: 'todo' | 'in_progress' | 'done';
    assignee: 'orion' | 'iposdev' | 'system'; // <--- НОВОЕ
    createdAt: Date;
};

export const load: PageServerLoad = async ({ locals }) => {
    if (!locals.user || !adminList.includes(locals.user.uid)) {
        throw redirect(303, '/');
    }

    try {
        const snapshot = await firestoreAdmin.collection('roadmap').orderBy('createdAt', 'desc').get();
        const tasks: Task[] = snapshot.docs.map(doc => {
            const data = doc.data();
            return {
                id: doc.id,
                title: data.title || 'Untitled',
                description: data.description || '',
                platform: data.platform || 'web',
                priority: data.priority || 'medium',
                status: data.status || 'todo',
                assignee: data.assignee || 'system', // Дефолт
                createdAt: data.createdAt?.toDate() || new Date()
            };
        });
        return { tasks };
    } catch (e) {
        return { tasks: [] };
    }
};

export const actions: Actions = {
    create: async ({ request, locals }) => {
        if (!locals.user || !adminList.includes(locals.user.uid)) return fail(403);
        const data = await request.formData();

        await firestoreAdmin.collection('roadmap').add({
            title: data.get('title'),
            description: data.get('description'),
            platform: data.get('platform'),
            priority: data.get('priority'),
            assignee: data.get('assignee'), // Сохраняем исполнителя
            status: 'todo',
            createdAt: FieldValue.serverTimestamp(),
            author: locals.user.username
        });
        return { success: true };
    },

    // НОВОЕ: Редактирование всей задачи
    edit: async ({ request, locals }) => {
        if (!locals.user || !adminList.includes(locals.user.uid)) return fail(403);
        const data = await request.formData();
        const id = data.get('id') as string;

        const updates: any = {
            title: data.get('title'),
            description: data.get('description'),
            priority: data.get('priority'),
            assignee: data.get('assignee')
        };

        // Удаляем undefined поля
        Object.keys(updates).forEach(key => updates[key] === undefined && delete updates[key]);

        await firestoreAdmin.collection('roadmap').doc(id).update(updates);
        return { success: true };
    },

    updateStatus: async ({ request, locals }) => {
        if (!locals.user || !adminList.includes(locals.user.uid)) return fail(403);
        const data = await request.formData();
        await firestoreAdmin.collection('roadmap').doc(data.get('id') as string).update({
            status: data.get('status')
        });
        return { success: true };
    },

    delete: async ({ request, locals }) => {
        if (!locals.user || !adminList.includes(locals.user.uid)) return fail(403);
        await firestoreAdmin.collection('roadmap').doc(data.get('id') as string).delete();
        return { success: true };
    }
};
</file>

<file path="src/routes/admin/tracker/+page.svelte">
<script lang="ts">
    import { enhance } from '$app/forms';
    import { fade, slide, scale } from 'svelte/transition';
    import { flip } from 'svelte/animate';
    import { quintOut } from 'svelte/easing';
    import type { PageData } from './$types';

    export let data: PageData;

    // === ФИЛЬТРЫ ===
    let filterPlatform: string = 'all';
    let filterAssignee: string = 'all';

    // Реактивная фильтрация
    $: filteredTasks = data.tasks.filter(t => {
        const matchPlatform = filterPlatform === 'all' || t.platform === filterPlatform;
        const matchAssignee = filterAssignee === 'all' || t.assignee === filterAssignee;
        return matchPlatform && matchAssignee;
    });

    $: todoTasks = filteredTasks.filter(t => t.status === 'todo');
    $: progressTasks = filteredTasks.filter(t => t.status === 'in_progress');
    $: doneTasks = filteredTasks.filter(t => t.status === 'done');

    // === UI STATE ===
    let showCreateForm = false;
    let editingTask: any = null; // Если не null, показываем модалку редактирования

    function getShortId(id: string) { return 'T-' + id.substring(0, 4).toUpperCase(); }

    // Аватарки для команды
    const AVATARS: any = {
        'orion': '/casino/orioncasino.png', // Твой аватар
        'iposdev': 'https://api.dicebear.com/7.x/bottts-neutral/svg?seed=iposdev', // Заглушка для друга
        'system': '/logo.svg'
    };
</script>

<svelte:head>
    <title>Neural Planner v2.0</title>
</svelte:head>

<div class="mission-control" in:fade={{duration: 500}}>
    <div class="grid-bg"></div>

    <!-- HEADER & FILTERS -->
    <header class="hud-header">
        <div class="header-left">
            <h1 class="glitch-title" data-text="NEURAL_PLANNER">NEURAL_PLANNER</h1>
            <div class="filters-bar">
                <span class="filter-label">FILTER:</span>
                <button class="filter-btn" class:active={filterPlatform === 'all'} on:click={() => filterPlatform = 'all'}>ALL</button>
                <button class="filter-btn" class:active={filterPlatform === 'web'} on:click={() => filterPlatform = 'web'}>WEB</button>
                <button class="filter-btn" class:active={filterPlatform === 'app'} on:click={() => filterPlatform = 'app'}>APP</button>
                <span class="separator">|</span>
                <button class="filter-btn" class:active={filterAssignee === 'orion'} on:click={() => filterAssignee = filterAssignee === 'orion' ? 'all' : 'orion'}>ORION</button>
                <button class="filter-btn" class:active={filterAssignee === 'iposdev'} on:click={() => filterAssignee = filterAssignee === 'iposdev' ? 'all' : 'iposdev'}>IPOS</button>
            </div>
        </div>

        <button class="cyber-btn" on:click={() => showCreateForm = !showCreateForm}>
            {showCreateForm ? 'CLOSE UPLINK' : 'NEW DIRECTIVE'}
        </button>
    </header>

    <!-- CREATE FORM -->
    {#if showCreateForm}
        <div class="form-wrapper" transition:slide>
            <form method="POST" action="?/create" use:enhance={() => { showCreateForm = false; return async ({ update }) => update(); }} class="tech-form">
                <h3 class="form-title">> INITIATE_PROTOCOL</h3>
                <div class="inputs-grid">
                    <div class="group">
                        <label>TITLE</label>
                        <input type="text" name="title" class="hud-input" required placeholder="Task name..."/>
                    </div>
                    <div class="group">
                        <label>MODULE</label>
                        <select name="platform" class="hud-input">
                            <option value="web">WEB_CLIENT</option>
                            <option value="app">MOBILE_APP</option>
                            <option value="backend">SERVER_CORE</option>
                            <option value="design">VISUAL_ARTS</option>
                        </select>
                    </div>
                    <div class="group">
                        <label>OPERATOR</label>
                        <select name="assignee" class="hud-input">
                            <option value="orion">ORION</option>
                            <option value="iposdev">IPOSDEV</option>
                            <option value="system">SYSTEM</option>
                        </select>
                    </div>
                    <div class="group">
                        <label>PRIORITY</label>
                        <select name="priority" class="hud-input">
                            <option value="low">LOW</option>
                            <option value="medium" selected>MEDIUM</option>
                            <option value="critical">CRITICAL</option>
                        </select>
                    </div>
                    <div class="group full">
                        <label>DETAILS</label>
                        <input type="text" name="description" class="hud-input" placeholder="Technical specifications..."/>
                    </div>
                </div>
                <button type="submit" class="submit-cmd">EXECUTE</button>
            </form>
        </div>
    {/if}

    <!-- EDIT MODAL -->
    {#if editingTask}
        <div class="modal-overlay" transition:fade on:click|self={() => editingTask = null}>
            <div class="modal-content tech-form" transition:scale>
                <h3 class="form-title">> EDIT_DIRECTIVE: {getShortId(editingTask.id)}</h3>
                <form method="POST" action="?/edit" use:enhance={() => { editingTask = null; return async ({ update }) => update(); }}>
                    <input type="hidden" name="id" value={editingTask.id} />
                    <div class="inputs-grid">
                        <div class="group full">
                            <label>TITLE</label>
                            <input type="text" name="title" class="hud-input" value={editingTask.title} required />
                        </div>
                        <div class="group">
                            <label>OPERATOR</label>
                            <select name="assignee" class="hud-input" value={editingTask.assignee}>
                                <option value="orion">ORION</option>
                                <option value="iposdev">IPOSDEV</option>
                                <option value="system">SYSTEM</option>
                            </select>
                        </div>
                        <div class="group">
                            <label>PRIORITY</label>
                            <select name="priority" class="hud-input" value={editingTask.priority}>
                                <option value="low">LOW</option>
                                <option value="medium">MEDIUM</option>
                                <option value="critical">CRITICAL</option>
                            </select>
                        </div>
                        <div class="group full">
                            <label>DETAILS</label>
                            <input type="text" name="description" class="hud-input" value={editingTask.description} />
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="cancel-cmd" on:click={() => editingTask = null}>CANCEL</button>
                        <button type="submit" class="submit-cmd">SAVE CHANGES</button>
                    </div>
                </form>
            </div>
        </div>
    {/if}

    <!-- KANBAN BOARD -->
    <div class="kanban-grid">

        <!-- TODO -->
        <div class="lane todo">
            <div class="lane-header">
                <span class="lane-name">PENDING</span>
                <span class="count">{todoTasks.length}</span>
            </div>
            <div class="lane-body">
                {#each todoTasks as task (task.id)}
                    <div class="tech-card priority-{task.priority}" animate:flip={{duration: 300, easing: quintOut}}>
                        <div class="card-top">
                            <span class="id-tag">{getShortId(task.id)}</span>
                            <div class="assignee-avatar" title={task.assignee}>
                                <img src={AVATARS[task.assignee]} alt={task.assignee}>
                            </div>
                        </div>

                        <div class="card-main" on:click={() => editingTask = task}>
                            <h4 class="card-title">{task.title}</h4>
                            <span class="platform-tag {task.platform}">{task.platform}</span>
                        </div>

                        <div class="card-controls">
                            <form method="POST" action="?/delete" use:enhance><input type="hidden" name="id" value={task.id}><button class="ctrl-btn del">×</button></form>
                            <form method="POST" action="?/updateStatus" use:enhance>
                                <input type="hidden" name="id" value={task.id}><input type="hidden" name="status" value="in_progress">
                                <button class="ctrl-btn next">►</button>
                            </form>
                        </div>
                    </div>
                {/each}
            </div>
        </div>

        <!-- PROGRESS -->
        <div class="lane progress">
            <div class="lane-header">
                <span class="lane-name text-cyber-yellow">PROCESSING</span>
                <span class="count warning">{progressTasks.length}</span>
            </div>
            <div class="lane-body">
                {#each progressTasks as task (task.id)}
                    <div class="tech-card priority-{task.priority} active" animate:flip={{duration: 300, easing: quintOut}}>
                        <div class="active-scanline"></div>
                        <div class="card-top">
                            <span class="id-tag text-cyber-yellow">{getShortId(task.id)}</span>
                            <div class="assignee-avatar" title={task.assignee}>
                                <img src={AVATARS[task.assignee]} alt={task.assignee}>
                            </div>
                        </div>

                        <div class="card-main" on:click={() => editingTask = task}>
                            <h4 class="card-title text-cyber-yellow">{task.title}</h4>
                            {#if task.description}<p class="card-desc">{task.description}</p>{/if}
                            <span class="platform-tag {task.platform}">{task.platform}</span>
                        </div>

                        <div class="card-controls">
                            <form method="POST" action="?/updateStatus" use:enhance>
                                <input type="hidden" name="id" value={task.id}><input type="hidden" name="status" value="todo">
                                <button class="ctrl-btn prev">◄</button>
                            </form>
                            <form method="POST" action="?/updateStatus" use:enhance>
                                <input type="hidden" name="id" value={task.id}><input type="hidden" name="status" value="done">
                                <button class="ctrl-btn next">✔</button>
                            </form>
                        </div>
                    </div>
                {/each}
            </div>
        </div>

        <!-- DONE -->
        <div class="lane done">
            <div class="lane-header">
                <span class="lane-name text-green-400">ONLINE</span>
                <span class="count success">{doneTasks.length}</span>
            </div>
            <div class="lane-body">
                {#each doneTasks as task (task.id)}
                    <div class="tech-card done" animate:flip={{duration: 300, easing: quintOut}}>
                        <div class="card-top">
                            <span class="id-tag">{getShortId(task.id)}</span>
                            <div class="assignee-avatar dimmed">
                                <img src={AVATARS[task.assignee]} alt={task.assignee}>
                            </div>
                        </div>
                        <h4 class="card-title line-through text-gray-500">{task.title}</h4>
                        <div class="card-controls justify-end">
                            <form method="POST" action="?/delete" use:enhance>
                                <input type="hidden" name="id" value={task.id}>
                                <button class="ctrl-btn archive">ARCHIVE</button>
                            </form>
                        </div>
                    </div>
                {/each}
            </div>
        </div>

    </div>
</div>

<style>
    /* Базовые стили такие же, но с добавками */
    .mission-control { padding: 2rem; color: #e0f7fa; min-height: 100vh; position: relative; }
    .grid-bg { position: absolute; inset: 0; z-index: -1; background-size: 40px 40px; background-image: linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px); }

    .hud-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 2rem; border-bottom: 1px solid rgba(0,243,255,0.2); padding-bottom: 1rem; }
    .glitch-title { font-family: 'Chakra Petch', monospace; font-size: 2rem; font-weight: 800; color: white; text-shadow: 0 0 10px rgba(0,243,255,0.5); }

    /* FILTERS */
    .filters-bar { display: flex; gap: 0.5rem; align-items: center; margin-top: 0.5rem; }
    .filter-label { font-size: 0.7rem; color: #64748b; font-weight: bold; margin-right: 0.5rem; }
    .filter-btn {
        background: transparent; border: 1px solid #333; color: #666;
        padding: 2px 8px; font-size: 0.7rem; font-family: 'Chakra Petch', monospace;
        cursor: pointer; transition: all 0.2s; border-radius: 4px;
    }
    .filter-btn:hover { color: white; border-color: #666; }
    .filter-btn.active { background: rgba(0,243,255,0.1); border-color: var(--cyber-cyan); color: var(--cyber-cyan); }
    .separator { color: #333; font-size: 0.8rem; }

    /* CARD STYLES */
    .tech-card {
        background: rgba(30,35,45,0.7); padding: 0.8rem; border-radius: 6px;
        border-left: 3px solid #555; margin-bottom: 1rem; position: relative;
        transition: transform 0.2s;
    }
    .tech-card:hover { transform: translateY(-2px); background: rgba(40,45,55,0.9); }

    .card-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    .id-tag { font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; color: #64748b; }

    .assignee-avatar { width: 24px; height: 24px; border-radius: 50%; border: 1px solid #555; overflow: hidden; }
    .assignee-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .assignee-avatar.dimmed { filter: grayscale(1); opacity: 0.5; }

    .card-main { cursor: pointer; }
    .card-title { font-weight: bold; font-size: 0.9rem; margin-bottom: 0.3rem; line-height: 1.3; }
    .card-desc { font-size: 0.75rem; color: #9ca3af; margin-bottom: 0.5rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

    .platform-tag {
        font-size: 0.6rem; padding: 1px 4px; border-radius: 3px; font-weight: bold; text-transform: uppercase;
        display: inline-block; margin-bottom: 0.5rem; border: 1px solid transparent;
    }
    .platform-tag.web { color: #60a5fa; border-color: rgba(96,165,250,0.3); background: rgba(96,165,250,0.1); }
    .platform-tag.app { color: #c084fc; border-color: rgba(192,132,252,0.3); background: rgba(192,132,252,0.1); }
    .platform-tag.backend { color: #facc15; border-color: rgba(250,204,21,0.3); background: rgba(250,204,21,0.1); }
    .platform-tag.design { color: #f472b6; border-color: rgba(244,114,182,0.3); background: rgba(244,114,182,0.1); }

    /* Priorities */
    .priority-low { border-left-color: #60a5fa; }
    .priority-medium { border-left-color: var(--cyber-yellow); }
    .priority-critical { border-left-color: #ff003c; background: repeating-linear-gradient(45deg, rgba(30,35,45,0.7), rgba(30,35,45,0.7) 10px, rgba(255,0,60,0.05) 10px, rgba(255,0,60,0.05) 20px); }

    .active-scanline {
        position: absolute; top: 0; left: 0; width: 100%; height: 2px;
        background: var(--cyber-yellow); opacity: 0.5; animation: scan 2s infinite linear; pointer-events: none;
    }
    @keyframes scan { 0% { top: 0; opacity: 0; } 50% { opacity: 0.5; } 100% { top: 100%; opacity: 0; } }

    /* CONTROLS */
    .card-controls { display: flex; justify-content: space-between; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 0.5rem; }
    .ctrl-btn { background: transparent; border: 1px solid transparent; color: #555; padding: 0 6px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; }
    .ctrl-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
    .ctrl-btn.next:hover { color: #4ade80; }
    .ctrl-btn.del:hover { color: #ff003c; }

    /* COLUMNS */
    .kanban-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
    .lane { background: rgba(15, 20, 30, 0.4); border: 1px solid rgba(255,255,255,0.05); border-radius: 8px; padding: 1rem; min-height: 60vh; }
    .lane-header { display: flex; justify-content: space-between; margin-bottom: 1rem; font-family: 'Chakra Petch', monospace; font-weight: bold; font-size: 0.9rem; }
    .count { background: #333; padding: 2px 6px; border-radius: 4px; font-family: monospace; }
    .count.warning { color: var(--cyber-yellow); }
    .count.success { color: #4ade80; }

    /* MODAL */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .modal-content { width: 90%; max-width: 600px; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem; }
    .cancel-btn, .cancel-cmd { background: transparent; border: 1px solid #555; color: #ccc; padding: 0.8rem 1.5rem; font-family: 'Chakra Petch', monospace; font-weight: bold; cursor: pointer; }
    .cancel-cmd:hover { border-color: #fff; color: #fff; }

    /* COMMON FORM STYLES */
    .form-wrapper { margin-bottom: 2rem; }
    .tech-form { background: rgba(15,20,25,0.95); padding: 2rem; border: 1px solid var(--cyber-cyan); box-shadow: 0 0 30px rgba(0,243,255,0.1); }
    .form-title { font-family: 'JetBrains Mono', monospace; color: #64748b; margin-bottom: 1rem; border-bottom: 1px dashed #333; padding-bottom: 0.5rem; }
    .inputs-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .group { display: flex; flex-direction: column; gap: 0.3rem; }
    .group.full { grid-column: span 2; }
    .group label { font-size: 0.7rem; font-weight: bold; color: var(--cyber-cyan); letter-spacing: 0.1em; }
    .hud-input { background: rgba(0,0,0,0.3); border: 1px solid #333; color: white; padding: 0.6rem; font-family: 'Inter', sans-serif; width: 100%; }
    .hud-input:focus { border-color: var(--cyber-yellow); outline: none; }
    .submit-cmd { background: var(--cyber-yellow); color: black; font-weight: 800; border: none; padding: 0.8rem 2rem; cursor: pointer; font-family: 'Chakra Petch', monospace; width: 100%; margin-top: 1rem; }
    .submit-cmd:hover { box-shadow: 0 0 15px var(--cyber-yellow); }
    .cyber-btn { background: rgba(0,243,255,0.1); border: 1px solid var(--cyber-cyan); color: var(--cyber-cyan); padding: 0.5rem 1.5rem; font-weight: bold; font-family: 'Chakra Petch', monospace; cursor: pointer; }
    .cyber-btn:hover { background: var(--cyber-cyan); color: black; box-shadow: 0 0 15px var(--cyber-cyan); }

    @media(max-width: 768px) {
        .hud-header { flex-direction: column; align-items: flex-start; gap: 1rem; }
        .filters-bar { flex-wrap: wrap; }
        .inputs-grid { grid-template-columns: 1fr; }
        .group.full { grid-column: span 1; }
    }
</style>
</file>

<file path="src/routes/ai-policy/+page.svelte">
<script lang="ts">
    import { onMount } from 'svelte';
    import { quintOut } from 'svelte/easing';
    import { tweened } from 'svelte/motion';
    import { t } from 'svelte-i18n';

    const opacity = tweened(0, { duration: 400, easing: quintOut });
    onMount(() => {
        opacity.set(1);
    });
</script>

<svelte:head>
    <title>{$t('ai_policy.title')} | ProtoMap</title>
</svelte:head>

<div class="legal-container cyber-panel" style="opacity: {$opacity}">
    <h2 class="title font-display">{$t('ai_policy.title')}</h2>
    <p class="subtitle">{$t('ai_policy.subtitle')}</p>

    <div class="content-text">
        <h3 class="section-title">{$t('ai_policy.intro_title')}</h3>
        <p>{$t('ai_policy.intro_text')}</p>

        <div class="info-grid">
            <div>
                <strong>{$t('ai_policy.reason_label')}</strong>
                <p>{$t('ai_policy.reason_text')}</p>
            </div>
            <div>
                <strong>{$t('ai_policy.fact_label')}</strong>
                <p>{$t('ai_policy.fact_text')}</p>
            </div>
        </div>

        <h3 class="section-title">{$t('ai_policy.moderation_title')}</h3>
        <p>{$t('ai_policy.moderation_text')}</p>

        <blockquote class="quote-box error">
            {$t('ai_policy.moderator_quote_1')}
        </blockquote>

        <blockquote class="quote-box">
            {$t('ai_policy.moderator_quote_2')}
        </blockquote>

        <p>{$t('ai_policy.moderation_outro')}</p>

        <div class="screenshots-container">
            <img src="/images/modmail_1.png" alt="Modmail Screenshot 1" class="screenshot">
            <img src="/images/modmail_2.png" alt="Modmail Screenshot 2" class="screenshot">
            <img src="/images/modmail_3.png" alt="Modmail Screenshot 3" class="screenshot">
        </div>

        <h3 class="section-title">{$t('ai_policy.philosophy_title')}</h3>

        <div class="points-list">
            <h4>{$t('ai_policy.point1_title')}</h4>
            <p>{$t('ai_policy.point1_text')}</p>

            <h4>{$t('ai_policy.point2_title')}</h4>
            <p>{$t('ai_policy.point2_text')}</p>

            <h4>{$t('ai_policy.point3_title')}</h4>
            <p>{@html $t('ai_policy.point3_text')}</p>
        </div>

        <h3 class="section-title">{$t('ai_policy.conclusion_title')}</h3>
        <p>{$t('ai_policy.conclusion_text')}</p>

        <p class="mt-12 text-center text-gray-500">{$t('ai_policy.eoc')}</p>
    </div>
</div>

<style>
    .legal-container {
        max-width: 900px;
        margin: 2.5rem auto;
        padding: 3rem;
        background: rgba(10, 12, 15, 0.85);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        clip-path: polygon(0 20px, 20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%);
    }

    .title {
        font-size: 2.5rem;
        font-weight: 700;
        text-align: center;
        color: #fff;
        margin-bottom: 0.5rem;
    }
    .subtitle {
        text-align: center;
        color: var(--text-muted-color, #909dab);
        margin-bottom: 3rem;
        font-family: 'Chakra Petch', monospace;
    }
    .content-text {
        font-size: 1rem;
        line-height: 1.8;
        color: #d1d5db;
    }
    .content-text p { margin-bottom: 1.5rem; }

    .section-title {
        font-family: 'Chakra Petch', monospace;
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--cyber-yellow, #fcee0a);
        margin-top: 3rem;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 0.5rem;
    }

    .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        background: rgba(255,255,255,0.02);
        padding: 1rem;
        border-left: 3px solid var(--cyber-cyan);
    }
    .info-grid strong {
        color: var(--cyber-cyan);
        font-weight: bold;
        display: block;
        margin-bottom: 0.5rem;
    }
    .info-grid p {
        margin: 0;
        color: #ccc;
    }

    .quote-box {
        background: rgba(255, 0, 60, 0.05);
        border-left: 3px solid var(--cyber-red, #ff003c);
        padding: 1rem 1.5rem;
        margin: 1rem 0;
        font-style: italic;
        color: #ffccd5;
    }

    .quote-box.error {
        border-left-color: #ff0000;
        background: rgba(255, 0, 0, 0.1);
        color: #ffaaaa;
        font-weight: bold;
    }

    .points-list h4 {
        font-size: 1.1rem;
        font-weight: bold;
        color: #fff;
        margin-top: 2rem;
        margin-bottom: 0.5rem;
    }

    .screenshots-container {
        margin: 2rem 0;
        border: 1px solid #333;
        border-radius: 8px;
        overflow: hidden;
    }
    .screenshot {
        width: 100%;
        display: block;
        border-bottom: 1px solid #333;
    }
    .screenshot:last-child {
        border-bottom: none;
    }

    @media (max-width: 640px) {
        .legal-container { margin: 1rem; padding: 1.5rem; }
        .title { font-size: 1.8rem; }
        .info-grid { grid-template-columns: 1fr; }
    }
</style>
</file>

<file path="src/routes/app-privacy/+page.svelte">
<script lang="ts">
    import { onMount } from 'svelte';
    import { quintOut } from 'svelte/easing';
    import { tweened } from 'svelte/motion';
    import { t } from 'svelte-i18n';

    const opacity = tweened(0, { duration: 400, easing: quintOut });
    onMount(() => {
        opacity.set(1);
    });
</script>

<svelte:head>
    <title>{$t('app_privacy_policy.page_title')} | ProtoMap</title>
</svelte:head>

<div class="legal-container cyber-panel" style="opacity: {$opacity}">
    <h1 class="title font-display">{$t('app_privacy_policy.page_title')}</h1>
    <p class="subtitle">{$t('app_privacy_policy.last_updated')}</p>

    <div class="content-text">
        <p>{$t('app_privacy_policy.intro')}</p>

        <h3 class="section-title">{$t('app_privacy_policy.section_geo_title')}</h3>
        <p>{$t('app_privacy_policy.section_geo_text')}</p>
        <ul>
            {#each $t('app_privacy_policy.section_geo_list') as item}
                <li>{item}</li>
            {/each}
        </ul>
        <p>{$t('app_privacy_policy.section_geo_processing')}</p>
        <div class="subsection">
            <p><strong>• {$t('app_privacy_policy.section_geo_mode_auto')}</strong></p>
            <p><strong>• {$t('app_privacy_policy.section_geo_mode_manual')}</strong></p>
        </div>

        <h3 class="section-title">{$t('app_privacy_policy.section_media_title')}</h3>
        <p>{$t('app_privacy_policy.section_media_text')}</p>
        <ul>
            <li><strong>{$t('app_privacy_policy.section_media_camera')}</strong></li>
            <li><strong>{$t('app_privacy_policy.section_media_mic')}</strong></li>
            <li><strong>{$t('app_privacy_policy.section_media_storage')}</strong></li>
        </ul>

        <h3 class="section-title">{$t('app_privacy_policy.section_safety_title')}</h3>
        <p>{$t('app_privacy_policy.section_safety_text')}</p>
        <div class="alert-box">
            <p><strong>{$t('app_privacy_policy.section_safety_age')}</strong></p>
            <p><strong>{$t('app_privacy_policy.section_safety_csam')}</strong></p>
        </div>
        <p>{$t('app_privacy_policy.section_safety_measures')}</p>
        <ul>
            {#each $t('app_privacy_policy.section_safety_actions') as item}
                <li>{item}</li>
            {/each}
        </ul>

        <h3 class="section-title">{$t('app_privacy_policy.section_data_title')}</h3>
        <p>{$t('app_privacy_policy.section_data_text')}</p>
        <ul>
            {#each $t('app_privacy_policy.section_data_list') as item}
                <li>{item}</li>
            {/each}
        </ul>
        <p>{$t('app_privacy_policy.section_third_party')}</p>

        <h3 class="section-title">{$t('app_privacy_policy.section_delete_title')}</h3>
        <p>{$t('app_privacy_policy.section_delete_text')}</p>

        <h3 class="section-title">{$t('app_privacy_policy.section_contact_title')}</h3>
        <p>
            {$t('app_privacy_policy.section_contact_text')}
            <br>
            <a href="mailto:{$t('app_privacy_policy.contact_email')}" class="link">{$t('app_privacy_policy.contact_email')}</a>
        </p>
    </div>
</div>

<style>
    .legal-container {
        max-width: 900px;
        margin: 2.5rem auto;
        padding: 3rem;
        background: rgba(10, 12, 15, 0.85);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        clip-path: polygon(0 20px, 20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%);
    }

    .title {
        font-size: 2.5rem;
        font-weight: 700;
        text-align: center;
        color: #fff;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .subtitle {
        text-align: center;
        color: var(--text-muted-color, #909dab);
        margin-bottom: 3rem;
        font-family: 'Chakra Petch', monospace;
        font-size: 0.9rem;
    }

    .content-text {
        font-size: 1rem;
        line-height: 1.8;
        color: #d1d5db;
    }

    .content-text p {
        margin-bottom: 1rem;
        text-align: justify;
    }

    .section-title {
        font-family: 'Chakra Petch', monospace;
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--cyber-yellow, #fcee0a);
        margin-top: 2.5rem;
        margin-bottom: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 0.5rem;
    }

    .content-text ul {
        list-style-type: none;
        padding-left: 1rem;
        margin-bottom: 1.5rem;
    }

    .content-text li {
        position: relative;
        padding-left: 1.5rem;
        margin-bottom: 0.5rem;
    }

    .content-text li::before {
        content: '>';
        position: absolute;
        left: 0;
        color: var(--cyber-yellow, #fcee0a);
        font-weight: bold;
    }

    .subsection {
        background: rgba(255, 255, 255, 0.03);
        padding: 1rem;
        border-left: 2px solid var(--cyber-cyan, #00f0ff);
        margin: 1rem 0;
    }

    .alert-box {
        background: rgba(255, 0, 60, 0.1);
        border: 1px solid var(--cyber-red, #ff003c);
        padding: 1rem;
        margin: 1.5rem 0;
    }

    .link {
        color: var(--cyber-cyan, #00f0ff);
        text-decoration: none;
        border-bottom: 1px dashed var(--cyber-cyan, #00f0ff);
        transition: all 0.2s;
    }

    .link:hover {
        color: #fff;
        border-bottom-style: solid;
    }

    @media (max-width: 640px) {
        .legal-container {
            margin: 1rem;
            padding: 1.5rem;
        }
        .title {
            font-size: 1.8rem;
        }
    }
</style>
</file>

<file path="src/routes/app-terms/+page.svelte">
<script lang="ts">
    import { onMount } from 'svelte';
    import { quintOut } from 'svelte/easing';
    import { tweened } from 'svelte/motion';
    import { t } from 'svelte-i18n';

    const opacity = tweened(0, { duration: 400, easing: quintOut });
    onMount(() => {
        opacity.set(1);
    });
</script>

<svelte:head>
    <title>{$t('app_terms.page_title')} | ProtoMap</title>
</svelte:head>

<div class="legal-container cyber-panel" style="opacity: {$opacity}">
    <h1 class="title font-display">{$t('app_terms.page_title')}</h1>
    <p class="subtitle">{$t('app_terms.last_updated')}</p>

    <div class="content-text">
        <p>{$t('app_terms.intro')}</p>

        <h3 class="section-title">{$t('app_terms.sec_license_title')}</h3>
        <p>{$t('app_terms.sec_license_text')}</p>
        <ul>
            {#each $t('app_terms.sec_license_list') as item}
                <li>{item}</li>
            {/each}
        </ul>

        <h3 class="section-title">{$t('app_terms.sec_content_title')}</h3>
        <p>{$t('app_terms.sec_content_text')}</p>

        <div class="alert-box">
            <p><strong>{$t('app_terms.sec_content_policy')}</strong></p>
        </div>

        <ul>
            {#each $t('app_terms.sec_content_prohibited') as item}
                <li>{item}</li>
            {/each}
        </ul>
        <p>{$t('app_terms.sec_content_moderation')}</p>

        <h3 class="section-title">{$t('app_terms.sec_virtual_title')}</h3>
        <p>{$t('app_terms.sec_virtual_text')}</p>
        <ul>
            {#each $t('app_terms.sec_virtual_list') as item}
                <li>{item}</li>
            {/each}
        </ul>

        <h3 class="section-title">{$t('app_terms.sec_safety_title')}</h3>
        <p>{$t('app_terms.sec_safety_text')}</p>
        <ul>
            {#each $t('app_terms.sec_safety_list') as item}
                <li>{item}</li>
            {/each}
        </ul>

        <h3 class="section-title">{$t('app_terms.sec_termination_title')}</h3>
        <p>{$t('app_terms.sec_termination_text')}</p>

        <h3 class="section-title">{$t('app_terms.sec_disclaimer_title')}</h3>
        <p>{$t('app_terms.sec_disclaimer_text')}</p>

        <h3 class="section-title">{$t('app_terms.sec_contact_title')}</h3>
        <p>
            {$t('app_terms.sec_contact_text')}
            <br>
            <a href="mailto:{$t('app_terms.contact_email')}" class="link">{$t('app_terms.contact_email')}</a>
        </p>
    </div>
</div>

<style>
    .legal-container {
        max-width: 900px;
        margin: 2.5rem auto;
        padding: 3rem;
        background: rgba(10, 12, 15, 0.85);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        clip-path: polygon(0 20px, 20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%);
    }

    .title {
        font-size: 2.5rem;
        font-weight: 700;
        text-align: center;
        color: #fff;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .subtitle {
        text-align: center;
        color: var(--text-muted-color, #909dab);
        margin-bottom: 3rem;
        font-family: 'Chakra Petch', monospace;
        font-size: 0.9rem;
    }

    .content-text {
        font-size: 1rem;
        line-height: 1.8;
        color: #d1d5db;
    }

    .content-text p {
        margin-bottom: 1rem;
        text-align: justify;
    }

    .section-title {
        font-family: 'Chakra Petch', monospace;
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--cyber-yellow, #fcee0a);
        margin-top: 2.5rem;
        margin-bottom: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 0.5rem;
    }

    .content-text ul {
        list-style-type: none;
        padding-left: 1rem;
        margin-bottom: 1.5rem;
    }

    .content-text li {
        position: relative;
        padding-left: 1.5rem;
        margin-bottom: 0.5rem;
    }

    .content-text li::before {
        content: '>';
        position: absolute;
        left: 0;
        color: var(--cyber-yellow, #fcee0a);
        font-weight: bold;
    }

    .alert-box {
        background: rgba(255, 0, 60, 0.1);
        border: 1px solid var(--cyber-red, #ff003c);
        padding: 1rem;
        margin: 1.5rem 0;
        color: #ffccd5;
    }

    .link {
        color: var(--cyber-cyan, #00f0ff);
        text-decoration: none;
        border-bottom: 1px dashed var(--cyber-cyan, #00f0ff);
        transition: all 0.2s;
    }

    .link:hover {
        color: #fff;
        border-bottom-style: solid;
    }

    @media (max-width: 640px) {
        .legal-container {
            margin: 1rem;
            padding: 1.5rem;
        }
        .title {
            font-size: 1.8rem;
        }
    }
</style>
</file>

<file path="src/routes/mobile-beta/+page.svelte">
<script lang="ts">
    import { onMount } from 'svelte';
    import { quintOut } from 'svelte/easing';
    import { tweened } from 'svelte/motion';
    import { t } from 'svelte-i18n';
    import NeonButton from '$lib/components/NeonButton.svelte';

    const opacity = tweened(0, { duration: 400, easing: quintOut });
    onMount(() => { opacity.set(1); });
</script>

<svelte:head>
    <title>Mobile Beta | ProtoMap</title>
</svelte:head>

<div class="beta-container page-container" style="opacity: {$opacity}">
    <div class="bg-blur-1"></div>

    <div class="content-panel cyber-panel">
        <h1 class="title font-display glitch" data-text={$t('beta.title')}>{$t('beta.title')}</h1>
        <p class="subtitle">{$t('beta.subtitle')}</p>

        <div class="intro-text">
            <p>{$t('beta.desc')}</p>
        </div>

        <div class="steps-grid">
            <!-- STEP 1 -->
            <div class="step-card">
                <div class="step-num">01</div>
                <h3 class="step-title">{$t('beta.step1_title')}</h3>
                <p class="step-desc">{$t('beta.step1_desc')}</p>
                <a href="https://groups.google.com/g/protomap-android-beta/" target="_blank" class="action-btn group-btn">
                    {$t('beta.btn_group')}
                </a>
            </div>

            <!-- ARROW (Desktop) -->
            <div class="arrow-container">
                <svg class="w-8 h-8 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                </svg>
            </div>

            <!-- STEP 2 -->
            <div class="step-card highlight">
                <div class="step-num">02</div>
                <h3 class="step-title">{$t('beta.step2_title')}</h3>
                <p class="step-desc">{$t('beta.step2_desc')}</p>
                <a href="https://play.google.com/store/apps/details?id=by.iposdev.protomap" target="_blank" class="action-btn play-btn">
                    <!-- Google Play Icon -->
                    <svg class="w-6 h-6 mr-2" viewBox="0 0 512 512" fill="currentColor"><path d="M325.3 234.3L104.6 13l280.8 161.2-60.1 60.1zM47 0C34 6.8 25.3 19.2 25.3 35.3v441.3c0 16.1 8.7 28.5 21.7 35.3l256.6-256L47 0zm425.2 225.6l-58.9-34.1-65.7 64.5 65.7 64.5 60.1-34.1c18-14.3 18-46.5-1.2-60.8zM104.6 499l280.8-161.2-60.1-60.1L104.6 499z"/></svg>
                    {$t('beta.btn_download')}
                </a>
            </div>
        </div>

        <p class="footer-note">{$t('beta.footer')}</p>
    </div>
</div>

<style>
    .page-container {
        min-height: calc(100vh - 64px);
        display: flex; align-items: center; justify-content: center;
        padding: 2rem 1rem; position: relative; overflow: hidden;
    }
    .bg-blur-1 {
        position: absolute; top: 20%; left: 50%; transform: translateX(-50%);
        width: 300px; height: 300px; background: var(--cyber-cyan);
        filter: blur(150px); opacity: 0.2; z-index: 0;
    }

    .content-panel {
        max-width: 900px; width: 100%;
        padding: 3rem 2rem; z-index: 1; text-align: center;
    }

    .title { font-size: 2.5rem; color: #fff; margin-bottom: 0.5rem; }
    .subtitle { color: var(--cyber-yellow); font-family: 'Chakra Petch', monospace; font-weight: bold; letter-spacing: 0.1em; margin-bottom: 2rem; }
    .intro-text { font-size: 1.1rem; color: #ccc; max-width: 600px; margin: 0 auto 3rem auto; }

    .steps-grid {
        display: grid; grid-template-columns: 1fr auto 1fr; gap: 2rem; align-items: center;
    }

    .step-card {
        background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);
        padding: 2rem; border-radius: 12px; text-align: left;
        position: relative; transition: transform 0.3s, border-color 0.3s;
    }
    .step-card:hover { transform: translateY(-5px); border-color: var(--cyber-cyan); }
    .step-card.highlight { border-color: var(--cyber-green); background: rgba(57, 255, 20, 0.05); }
    .step-card.highlight:hover { border-color: #fff; box-shadow: 0 0 20px rgba(57, 255, 20, 0.2); }

    .step-num {
        font-size: 3rem; font-weight: 900; opacity: 0.1; position: absolute; top: 0; right: 1rem;
        font-family: 'Chakra Petch', monospace;
    }
    .step-title { font-weight: bold; color: #fff; margin-bottom: 0.5rem; font-family: 'Chakra Petch', monospace; }
    .step-desc { font-size: 0.9rem; color: #aaa; margin-bottom: 1.5rem; height: 3rem; }

    .action-btn {
        display: flex; align-items: center; justify-content: center;
        padding: 0.8rem 1rem; border-radius: 6px; font-weight: bold; font-family: 'Chakra Petch', monospace;
        text-decoration: none; transition: all 0.2s; font-size: 0.9rem;
    }
    .group-btn { border: 1px solid var(--cyber-cyan); color: var(--cyber-cyan); background: rgba(0, 243, 255, 0.1); }
    .group-btn:hover { background: var(--cyber-cyan); color: #000; box-shadow: 0 0 15px var(--cyber-cyan); }

    .play-btn { background: var(--cyber-green); color: #000; border: 1px solid var(--cyber-green); }
    .play-btn:hover { background: #fff; box-shadow: 0 0 20px var(--cyber-green); }

    .footer-note { margin-top: 3rem; color: #666; font-size: 0.8rem; }

    @media (max-width: 768px) {
        .steps-grid { grid-template-columns: 1fr; }
        .arrow-container { display: none; }
        .step-desc { height: auto; }
        .title { font-size: 2rem; }
    }
</style>
</file>

<file path="src/routes/profile/edit/+page.server.ts">
import { firestoreAdmin } from '$lib/server/firebase.admin';
import { error, fail, redirect } from '@sveltejs/kit';
import type { PageServerLoad } from './$types';

export const load: PageServerLoad = async ({ locals }) => {
    const user = locals.user;
    if (!user) {
        throw redirect(303, '/login');
    }
    const userDocRef = firestoreAdmin.collection('users').doc(user.uid);
    const userDocSnap = await userDocRef.get();
    if (!userDocSnap.exists) {
        throw error(500, 'Профиль пользователя не найден в базе данных.');
    }
    const userData = userDocSnap.data();
    if (!userData) {
         throw error(500, 'Не удалось получить данные профиля из базы.');
    }

    return {
        profile: {
            uid: user.uid,
            username: userData.username || '',
            avatar_url: userData.avatar_url || '',
            about_me: userData.about_me || '',
            status: userData.status || '',
            socials: {
                telegram: userData.socials?.telegram || '',
                discord: userData.socials?.discord || '',
                vk: userData.socials?.vk || '',
                twitter: userData.socials?.twitter || '',
                website: userData.socials?.website || ''
            }
        }
    };
};
</file>

<file path="src/routes/settings/security/+page.server.ts">
import { firestoreAdmin } from '$lib/server/firebase.admin';
import { error, redirect } from '@sveltejs/kit';
import type { PageServerLoad } from './$types';

export const load: PageServerLoad = async ({ locals }) => {
    const user = locals.user;
    if (!user) {
        throw redirect(303, '/login');
    }

    try {
        const userDoc = await firestoreAdmin.collection('users').doc(user.uid).get();
        if (!userDoc.exists) throw error(404, 'User not found');

        const userData = userDoc.data()!;

        return {
            email: user.email,
            emailVerified: user.emailVerified,
            telegram_id: userData.telegram_id || null,
            telegram_username: userData.telegram_username || null
        };
    } catch (e) {
        console.error("Security Load Error:", e);
        throw error(500, "Failed to load security settings");
    }
};
</file>

<file path="src/routes/settings/security/+page.svelte">
<script lang="ts">
    import { onMount } from 'svelte';
    import { fade, slide } from 'svelte/transition';
    import { quintOut } from 'svelte/easing';
    import { tweened } from 'svelte/motion';
    import { getFunctions, httpsCallable } from 'firebase/functions';
    import { auth } from "$lib/firebase";
    import { sendEmailVerification } from "firebase/auth";
    import { modal } from '$lib/stores/modalStore';
    import { t } from 'svelte-i18n';
    import { get } from 'svelte/store'; // Нужно для перевода в JS

    export let data;

    const opacity = tweened(0, { duration: 400, easing: quintOut });
    onMount(() => opacity.set(1));

    // Хелпер для перевода в JS (для модалок)
    const translate = (key: string, vars: Record<string, any> = {}) => get(t)(key, vars);

    // --- ЛОГИКА TELEGRAM ---
    let tgLinkCode = "";
    let isGeneratingCode = false;

    async function generateTgCode() {
        isGeneratingCode = true;
        try {
            const functions = getFunctions();
            const getCodeFunc = httpsCallable(functions, 'getTelegramAuthCode');
            const res = await getCodeFunc();
            tgLinkCode = (res.data as any).code;
        } catch (e: any) {
            modal.error(translate('ui.error'), e.message);
        } finally {
            isGeneratingCode = false;
        }
    }

    // --- ЛОГИКА EMAIL ---
    let verificationSent = false;
    async function sendVerification() {
        if (!auth.currentUser) return;
        try {
            await sendEmailVerification(auth.currentUser);
            verificationSent = true;
            modal.success(translate('ui.success'), `${translate('auth.check_email', { email: auth.currentUser.email })}`);
        } catch (e: any) {
            modal.error(translate('ui.error'), e.message);
        }
    }

    // --- УДАЛЕНИЕ АККАУНТА ---
    async function handleDeleteAccount() {
        modal.confirm(
            translate('security.modal_del_title'),
            translate('security.modal_del_text'),
            async () => {
                try {
                    modal.info(translate('ui.loading'), translate('security.modal_wiping'));
                    const functions = getFunctions();
                    const deleteAccountFunc = httpsCallable(functions, 'deleteAccount');
                    await deleteAccountFunc();
                    window.location.href = '/';
                } catch (error: any) {
                    modal.error(translate('ui.error'), error.message);
                }
            }
        );
    }
</script>

<svelte:head>
    <title>{$t('security.tab_title')} | ProtoMap</title>
</svelte:head>

<div class="security-container cyber-panel" style="opacity: {$opacity}">
    <h1 class="page-title font-display">{$t('security.page_title')}</h1>

    <div class="sections-grid">

        <!-- 1. ИДЕНТИФИКАЦИЯ (EMAIL) -->
        <section class="sec-card">
            <h3 class="sec-title text-cyber-cyan">{$t('security.email_title')}</h3>

            <div class="info-row">
                <span class="label">EMAIL:</span>
                <span class="value font-mono">{data.email}</span>
            </div>

            <div class="status-row">
                {#if data.emailVerified}
                    <div class="status-badge success">
                        <i class="fas fa-check-circle"></i> {$t('security.verified')}
                    </div>
                    <p class="desc">{$t('security.verified_desc')}</p>
                {:else}
                    <div class="status-badge warning">
                        <i class="fas fa-exclamation-triangle"></i> {$t('security.not_verified')}
                    </div>
                    <p class="desc text-orange-400">{$t('security.not_verified_desc')}</p>

                    <button class="action-btn" on:click={sendVerification} disabled={verificationSent}>
                        {verificationSent ? $t('security.btn_sent') : $t('security.btn_verify')}
                    </button>
                {/if}
            </div>
        </section>

        <!-- 2. СВЯЗЬ (TELEGRAM) -->
        <section class="sec-card">
            <h3 class="sec-title text-cyber-purple">{$t('security.tg_title')}</h3>

            {#if data.telegram_id}
                <div class="info-row">
                    <span class="label">{$t('security.status')}</span>
                    <span class="status-badge success">{$t('security.connected')}</span>
                </div>
                <div class="info-row">
                    <span class="label">{$t('security.user')}</span>
                    <span class="value text-cyber-purple">@{data.telegram_username || 'ID: ' + data.telegram_id}</span>
                </div>
                <p class="desc">{$t('security.tg_connected_desc')}</p>
            {:else}
                <p class="desc">{$t('security.tg_desc')}</p>

                {#if !tgLinkCode}
                    <button class="action-btn purple" on:click={generateTgCode} disabled={isGeneratingCode}>
                        {isGeneratingCode ? $t('security.btn_generating') : $t('security.btn_gen')}
                    </button>
                {:else}
                    <div class="code-box" transition:slide>
                        <p class="code-label">{$t('security.code_instruction')}</p>
                        <div class="code-val">/link {tgLinkCode}</div>
                        <a href="https://t.me/OrionNeurobot" target="_blank" class="bot-link">{$t('security.bot_link')}</a>
                    </div>
                {/if}
            {/if}
        </section>

        <!-- 3. ОПАСНАЯ ЗОНА -->
        <section class="sec-card danger">
            <h3 class="sec-title text-cyber-red">{$t('security.danger_title')}</h3>
            <p class="desc">{$t('security.danger_desc')}</p>

            <button class="action-btn red" on:click={handleDeleteAccount}>
                {$t('security.btn_delete')}
            </button>
        </section>

    </div>
</div>

<style>
    .security-container {
        max-width: 800px; margin: 3rem auto; padding: 2rem;
        background: rgba(10, 12, 15, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
    }

    .page-title {
        text-align: center; font-size: 2rem; color: #fff; margin-bottom: 2rem;
        text-shadow: 0 0 15px rgba(255,255,255,0.2);
    }

    .sections-grid { display: flex; flex-direction: column; gap: 1.5rem; }

    .sec-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 12px; padding: 1.5rem;
    }

    .sec-title {
        font-weight: 900; font-size: 1.1rem; margin-bottom: 1rem; letter-spacing: 0.1em;
    }

    .info-row {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 0.5rem; border-bottom: 1px dashed rgba(255,255,255,0.1);
        padding-bottom: 0.5rem;
    }

    .label { color: #888; font-size: 0.8rem; font-weight: bold; }
    .value { color: #fff; }

    .desc { color: #666; font-size: 0.85rem; margin-top: 0.5rem; line-height: 1.4; }

    /* BADGES */
    .status-badge {
        display: inline-flex; align-items: center; gap: 6px;
        padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: bold;
        font-family: 'Chakra Petch', monospace;
    }
    .status-badge.success { background: rgba(57, 255, 20, 0.1); color: #39ff14; border: 1px solid #39ff14; }
    .status-badge.warning { background: rgba(255, 165, 0, 0.1); color: orange; border: 1px solid orange; }

    /* BUTTONS */
    .action-btn {
        margin-top: 1rem; width: 100%; padding: 0.8rem;
        background: rgba(255, 255, 255, 0.1); color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.2);
        font-family: 'Chakra Petch', monospace; font-weight: bold; cursor: pointer;
        transition: all 0.2s; text-transform: uppercase; letter-spacing: 0.1em;
    }
    .action-btn:hover { background: #fff; color: #000; }
    .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .action-btn.purple { border-color: var(--cyber-purple); color: var(--cyber-purple); background: transparent; }
    .action-btn.purple:hover { background: var(--cyber-purple); color: #fff; box-shadow: 0 0 15px var(--cyber-purple); }

    .action-btn.red { border-color: #ff003c; color: #ff003c; background: transparent; }
    .action-btn.red:hover { background: #ff003c; color: #fff; box-shadow: 0 0 15px #ff003c; }

    .sec-card.danger { border-color: rgba(255, 0, 60, 0.3); background: rgba(255, 0, 60, 0.05); }

    /* CODE BOX */
    .code-box {
        margin-top: 1rem; text-align: center;
        background: #000; padding: 1rem; border-radius: 8px; border: 1px dashed #444;
    }
    .code-val { font-size: 1.5rem; color: var(--cyber-purple); font-weight: bold; font-family: monospace; letter-spacing: 2px; margin: 0.5rem 0; user-select: all; }
    .bot-link { color: var(--cyber-cyan); font-size: 0.8rem; text-decoration: underline; }

    @media (max-width: 640px) {
        .security-container { margin: 1rem; padding: 1rem; }
        .page-title { font-size: 1.5rem; }
    }
</style>
</file>

<file path="src/styles/halloween.css">
:root {
    --cyber-yellow: #ff6600;
    --cyber-purple: #bd00ff;
    --cyber-green: #39ff14;
    --cyber-red: #ff3300;
    --text-color: #e8e8e8;
}

@keyframes spooky-pulse {
    0%, 100% {
        filter: drop-shadow(0 0 5px var(--cyber-yellow));
        transform: scale(1);
    }
    50% {
        filter: drop-shadow(0 0 15px var(--cyber-yellow));
        transform: scale(1.1);
    }
}

@keyframes bat-fly-across {
    0% {
        transform: translate(-10vw, 10vh) scale(0.5) rotate(15deg);
        opacity: 0;
    }
    10% {
        opacity: 0.8;
    }
    90% {
        opacity: 0.8;
    }
    100% {
        transform: translate(110vw, 30vh) scale(0.8) rotate(-15deg);
        opacity: 0;
    }
}

@keyframes sway-left {
    0%, 100% {
        transform: rotate(12deg);
    }
    50% {
        transform: rotate(-12deg);
    }
}

@keyframes sway-right {
    0%, 100% {
        transform: rotate(-12deg);
    }
    50% {
        transform: rotate(12deg);
    }
}

@keyframes heart-beat {
    0%, 35%, 75%, 100% {
        opacity: 0;
        transform: scale(0.5) translateY(10px);
    }
    50% {
        opacity: 1;
        transform: scale(1.2) translateY(0);
    }
}

body {
    background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='4' height='4' viewBox='0 0 4 4'%3E%3Cpath fill='%23ff6600' fill-opacity='0.03' d='M0 2h2v2H0zM2 0h2v2H2z'/%3E%3C/svg%3E"),
        radial-gradient(ellipse at bottom, rgba(80, 20, 0, 0.5) 0%, rgba(0, 0, 0, 0.9) 80%);
}

.font-display, .nav-brand, .profile-username {
    text-shadow: 0 0 5px var(--cyber-red), 0 0 10px var(--cyber-yellow);
}

nav.bg-gray-900\/50 {
    position: relative;
    overflow: visible !important;
}

.nav-brand {
    position: relative;
    color: var(--cyber-yellow) !important;
    text-shadow: 0 0 5px var(--cyber-red),
    0 0 10px var(--cyber-yellow) !important;
}

.nav-brand::before,
.nav-brand::after {
    display: none;
}

.spider-scene {
    position: absolute;
    top: 90%;
    left: calc(50% - 145px);
    width: 110px;
    height: 70px;
    z-index: 51;
    pointer-events: none;
}

.spider-scene::before,
.spider-scene::after {
    content: '';
    position: absolute;
    top: 0;
    width: 45px;
    height: 65px;
    background-color: #ffffff;
    -webkit-mask-image: url('/halloween/spider.svg');
    mask-image: url('/halloween/spider.svg');
    -webkit-mask-size: contain;
    mask-size: contain;
    -webkit-mask-repeat: no-repeat;
    mask-repeat: no-repeat;
    transform-origin: top center;
}

.spider-scene::before {
    left: 0;
    animation: sway-left 4s infinite ease-in-out;
}

.spider-scene::after {
    right: 0;
    animation: sway-right 4s infinite ease-in-out;
}

.spider-scene .heart {
    position: absolute;
    top: 15px;
    left: 43%;
    transform: translateX(-50%);
    width: 15px;
    height: 15px;
    background-color: var(--cyber-red);
    -webkit-mask-image: url('/halloween/heart.svg');
    mask-image: url('/halloween/heart.svg');
    -webkit-mask-size: contain;
    mask-size: contain;
    filter: drop-shadow(0 0 8px var(--cyber-red));
    opacity: 0;
    animation: heart-beat 4s infinite;
}

.cyber-panel::before,
.cyber-panel::after {
    content: '';
    position: absolute;
    width: 120px;
    height: 120px;
    background-color: rgba(255, 255, 255, 0.15);
    -webkit-mask-image: url('/halloween/web.svg');
    mask-image: url('/halloween/web.svg');
    -webkit-mask-size: contain;
    mask-size: contain;
    -webkit-mask-repeat: no-repeat;
    mask-repeat: no-repeat;
    z-index: 0;
    animation: none;
    pointer-events: none;
}

.cyber-panel::before {
    top: -10px;
    left: -10px;
}

.cyber-panel::after {
    bottom: -10px;
    right: -10px;
    transform: rotate(180deg);
}

.reactor-cluster {
    animation: none !important;
    transition: none !important;
}

.reactor-ring, .reactor-glow, .reactor-charge-indicator, .particle {
    display: none !important;
}

.reactor-cluster::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: url('/halloween/pumpkin.svg');
    background-size: contain;
    background-position: center;
    background-repeat: no-repeat;
    filter: drop-shadow(0 0 15px var(--cyber-yellow)) drop-shadow(0 0 5px #fff);
    transition: transform 0.3s ease;
}

.reactor-cluster:hover::before {
    transform: scale(1.15) rotate(5deg);
}

.reactor-core {
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
    z-index: 10;
    transform: translateY(15%);
}

.reactor-core .count {
    color: #000 !important;
    font-family: 'Creepster', cursive;
    font-weight: 400 !important;
    text-shadow: 0 0 3px var(--cyber-yellow), 0 0 5px var(--cyber-yellow) !important;
    -webkit-text-stroke: 1px var(--cyber-yellow);
    line-height: 1;
}

.small .reactor-core .count {
    font-size: 2.5em;
}

.medium .reactor-core .count {
    font-size: 2.8em;
}

.large .reactor-core .count {
    font-size: 3em;
}

.user-avatar-marker:has(img[src*="bottts-neutral"]) {
    background-color: rgba(255, 255, 255, 0.9);
    -webkit-mask-image: url('/halloween/ghost.svg');
    mask-image: url('/halloween/ghost.svg');
    -webkit-mask-size: 80%;
    mask-size: 80%;
    -webkit-mask-repeat: no-repeat;
    mask-repeat: no-repeat;
    mask-position: center;
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.6) !important;
    border: none !important;
}

.user-avatar-marker img[src*="bottts-neutral"] {
    opacity: 0;
}

body::after {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100px;
    height: 60px;
    background-color: #000;
    -webkit-mask-image: url('/halloween/bat.svg');
    mask-image: url('/halloween/bat.svg');
    -webkit-mask-size: contain;
    mask-size: contain;
    -webkit-mask-repeat: no-repeat;
    mask-repeat: no-repeat;
    pointer-events: none;
    z-index: 0;
    opacity: 0;
    animation: bat-fly-across 60s linear infinite;
    animation-delay: 10s;
}

::-webkit-scrollbar-thumb {
    background-color: var(--cyber-yellow);
    border-color: #000;
}

::-webkit-scrollbar-track {
    background: #1a1a1a;
}

html {
    scrollbar-color: var(--cyber-yellow) #1a1a1a;
}

.cyber-layers-control.leaflet-control-layers a.leaflet-control-layers-toggle {
    filter: hue-rotate(270deg) brightness(1.5);
}
.setting-toggle input:checked + .slider {
    background-color: var(--cyber-yellow);
    border-color: var(--cyber-yellow);
}

.popover-header {
    color: var(--cyber-yellow);
}
</file>

<file path="src/styles/newyear.css">
/* === [ GLITCHMAS PROTOCOL: ENGAGED ] === */

:root {
    --festive-red: #ff003c;
    --festive-gold: #ffd700;
    --festive-green: #00ff9d;
}

/* === [ 1. ФОН: СЕВЕРНОЕ СИЯНИЕ (AURORA) ] === */

/* Добавляем слой поверх зимнего снега */
body::before {
    content: '';
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: -1; /* За снегом, но перед фоном */
    background: linear-gradient(
        120deg,
        rgba(2, 5, 10, 0) 0%,
        rgba(0, 255, 157, 0.1) 25%,
        rgba(189, 0, 255, 0.15) 50%,
        rgba(255, 0, 85, 0.1) 75%,
        rgba(2, 5, 10, 0) 100%
    );
    background-size: 300% 300%;
    filter: blur(40px);
    mix-blend-mode: screen;
    animation: aurora-flow 15s ease-in-out infinite alternate;
}

@keyframes aurora-flow {
    0% { background-position: 0% 50%; opacity: 0.5; }
    100% { background-position: 100% 50%; opacity: 0.8; }
}

/* === [ 2. НАВБАР: RGB ГИРЛЯНДА (Твоя версия) ] === */

/* Убираем стандартную тень, чтобы гирлянда сияла ярче */
nav.bg-gray-900\/50 {
    border-bottom: none !important;
    box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
}

/* Сама гирлянда */
nav::after {
    content: '';
    position: absolute;
    bottom: -6px;
    left: 0;
    width: 100%;
    height: 10px;
    z-index: 60;
    background-image:
        /* Красная точка */
        radial-gradient(circle, var(--festive-red) 2px, transparent 5px),
        /* Зеленая точка */
        radial-gradient(circle, var(--festive-green) 2px, transparent 5px),
        /* Золотая точка */
        radial-gradient(circle, var(--festive-gold) 2px, transparent 5px);

    /* Размеры повторяющихся паттернов */
    background-size: 60px 10px;

    /* Сдвиг каждого цвета, чтобы они шли друг за другом */
    background-position: 0 0, 20px 0, 40px 0;

    background-repeat: repeat-x;
    animation: xmas-lights 1s infinite alternate;
}

@keyframes xmas-lights {
    0% { filter: drop-shadow(0 0 2px var(--festive-red)); opacity: 0.7; }
    100% { filter: drop-shadow(0 0 8px var(--festive-gold)) drop-shadow(2px 2px 10px var(--festive-green)); opacity: 1; }
}

/* === [ 3. КАРТА: РАЗНОЦВЕТНЫЕ ЁЛОЧНЫЕ ИГРУШКИ ] === */

/* Базовый стиль шара (общая форма, блики, тени) */
.reactor-core {
    border: none !important;
    overflow: visible !important;
    /* Блики и внутренняя тень для объема */
    box-shadow:
        inset -5px -5px 10px rgba(0,0,0,0.7),
        inset 5px 5px 10px rgba(255,255,255,0.4) !important;
}

/* --- 🔴 МАЛЕНЬКИЕ ШАРЫ (Красные) --- */
.small .reactor-core {
    background: radial-gradient(circle at 30% 30%, #ff4d4d, #990000) !important;
    box-shadow:
        inset -5px -5px 10px rgba(0,0,0,0.7),
        inset 5px 5px 10px rgba(255,255,255,0.4),
        0 0 15px #ff0055 !important; /* Свечение */
}

/* --- 🟡 СРЕДНИЕ ШАРЫ (Золотые) --- */
.medium .reactor-core {
    background: radial-gradient(circle at 30% 30%, #ffd700, #b8860b) !important;
    box-shadow:
        inset -5px -5px 10px rgba(0,0,0,0.7),
        inset 5px 5px 10px rgba(255,255,255,0.4),
        0 0 15px #ffd700 !important;
}
/* Для золотого шара текст лучше сделать черным для читаемости */
.medium .reactor-core .count {
    color: #000 !important;
    text-shadow: none !important;
}

/* --- 🔵 БОЛЬШИЕ ШАРЫ (Синие) --- */
.large .reactor-core {
    background: radial-gradient(circle at 30% 30%, #00f3ff, #0055ff) !important;
    box-shadow:
        inset -5px -5px 10px rgba(0,0,0,0.7),
        inset 5px 5px 10px rgba(255,255,255,0.4),
        0 0 20px #00f3ff !important;
}

/* --- ДЕТАЛИ ИГРУШКИ --- */

/* Золотая "шапочка" сверху */
.reactor-core::before {
    content: ''; position: absolute;
    top: -6px; left: 50%; transform: translateX(-50%);
    width: 14px; height: 8px;
    background: linear-gradient(to right, #bf953f, #fcf6ba, #b38728);
    border-radius: 2px; z-index: -1;
    box-shadow: 0 1px 2px rgba(0,0,0,0.5);
}

/* Петелька */
.reactor-core::after {
    content: ''; position: absolute;
    top: -12px; left: 50%; transform: translateX(-50%);
    width: 8px; height: 8px;
    border: 2px solid #fcf6ba;
    border-radius: 50%; z-index: -2;
}

/* Текст внутри шара (по умолчанию белый) */
.reactor-core .count {
    color: #fff !important;
    text-shadow: 0 1px 2px #000 !important;
    font-weight: bold;
}

/* Кольца превращаются в мишуру (цвет зависит от размера) */
.reactor-ring {
    border-color: transparent !important;
    animation-duration: 20s !important;
}

.small .reactor-ring {
    border-top: 2px dotted #ffd700 !important;
    border-bottom: 2px dotted #ffd700 !important;
    filter: drop-shadow(0 0 2px #ffd700);
}
.medium .reactor-ring {
    border-top: 2px dotted #ff0055 !important; /* Красная мишура на золотом шаре */
    border-bottom: 2px dotted #ff0055 !important;
    filter: drop-shadow(0 0 2px #ff0055);
}
.large .reactor-ring {
    border-top: 2px dotted #fff !important; /* Серебряная мишура на синем шаре */
    border-bottom: 2px dotted #fff !important;
    filter: drop-shadow(0 0 2px #fff);
}

/* Свечение вокруг (тоже адаптируем) */
.reactor-glow {
    background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, transparent 70%) !important;
}

/* === [ 4. ИНТЕРФЕЙС: ПРАЗДНИЧНЫЕ АКЦЕНТЫ ] === */

/* Заголовки переливаются золотом */
.title, .nav-brand, .machine-title {
    background: linear-gradient(to bottom, #fff, var(--festive-gold));
    -webkit-background-clip: text;
    color: transparent !important;
    text-shadow: 0 0 15px rgba(255, 215, 0, 0.5) !important;
}

/* Кнопки действий становятся более "теплыми" */
.panel-btn, .neon-btn {
    border-color: var(--festive-red) !important;
    background: linear-gradient(180deg, rgba(255, 0, 85, 0.15), transparent) !important;
}
.panel-btn:hover, .neon-btn:hover {
    box-shadow: 0 0 20px var(--festive-red) !important;
}

/* === [ 5. СКРОЛЛБАР: ЛЕДЕНЕЦ (CANDY CANE) ] === */

::-webkit-scrollbar-thumb {
    background-image: repeating-linear-gradient(
        45deg,
        #fff,
        #fff 10px,
        #ff0055 10px,
        #ff0055 20px
    ) !important;
    border: 2px solid #0a0a0a;
    box-shadow: 0 0 10px var(--festive-red);
}

/* === [ 6. ПОПАПЫ: ПРАЗДНИЧНАЯ РАМКА ] === */

.liquid-glass-popup {
    border: 1px solid var(--festive-gold) !important;
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.15), inset 0 0 30px rgba(255, 0, 85, 0.05) !important;
}

/* === [ 7. ГЛИТЧ СТАЛ ПРАЗДНИЧНЫМ ] === */
.glitch::before { text-shadow: -2px 0 var(--festive-red) !important; }
.glitch::after { text-shadow: 2px 0 var(--festive-green) !important; }
</file>

<file path="static/casino/glitch-6.svg">
<?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN"
 "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">
<svg version="1.0" xmlns="http://www.w3.org/2000/svg"
 width="897.000000pt" height="1280.000000pt" viewBox="0 0 897.000000 1280.000000"
 preserveAspectRatio="xMidYMid meet">
<metadata>
Created by potrace 1.15, written by Peter Selinger 2001-2017
</metadata>
<g transform="translate(0.000000,1280.000000) scale(0.100000,-0.100000)"
fill="#000000" stroke="none">
<path d="M4378 12497 c-1367 -1367 -2446 -2760 -3232 -4172 -139 -250 -374
-721 -481 -965 -662 -1505 -828 -2868 -504 -4120 196 -760 573 -1415 1144
-1986 473 -473 978 -792 1587 -1002 521 -180 1085 -263 1693 -249 1162 27
2085 355 2890 1026 136 113 438 419 558 564 527 639 818 1336 914 2187 22 191
24 744 5 945 -64 648 -198 1156 -437 1653 -345 716 -868 1308 -1465 1660 -350
205 -744 350 -1150 421 -273 48 -353 55 -687 55 -212 1 -319 4 -314 11 56 73
316 396 415 515 353 424 625 720 1050 1146 486 486 773 743 1341 1199 149 120
271 220 273 224 1 3 -103 45 -230 93 -227 85 -617 230 -1045 389 -117 43 -309
115 -425 158 -428 159 -653 243 -860 320 -117 44 -305 113 -417 155 -168 63
-214 76 -262 76 l-59 0 -302 -303z m292 -6707 c365 -42 664 -235 892 -574 110
-165 178 -324 220 -519 19 -88 22 -132 22 -317 0 -186 -3 -229 -22 -320 -46
-211 -119 -384 -234 -551 -314 -460 -737 -641 -1288 -552 -269 43 -470 148
-670 352 -216 218 -346 455 -407 741 -25 119 -25 476 0 602 25 127 61 244 105
345 107 248 334 499 577 638 230 131 523 187 805 155z"/>
</g>
</svg>
</file>

<file path="static/casino/heart.svg">
<?xml version="1.0" encoding="utf-8"?><!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg fill="#000000" width="800px" height="800px" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg" id="memory-heart"><path d="M12 20H10V19H9V18H8V17H7V16H6V15H5V14H4V13H3V12H2V10H1V5H2V4H3V3H4V2H9V3H10V4H12V3H13V2H18V3H19V4H20V5H21V10H20V12H19V13H18V14H17V15H16V16H15V17H14V18H13V19H12V20M5 11V12H6V13H7V14H8V15H9V16H10V17H12V16H13V15H14V14H15V13H16V12H17V11H18V9H19V6H18V5H17V4H14V5H13V6H12V7H10V6H9V5H8V4H5V5H4V6H3V9H4V11H5Z" /></svg>
</file>

<file path="static/casino/paw.svg">
<?xml version="1.0" encoding="utf-8"?><!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg width="800px" height="800px" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M6.5 3V2C6.5 1.17157 5.82843 0.5 5 0.5C4.17157 0.5 3.5 1.17157 3.5 2V3C3.5 3.82843 4.17157 4.5 5 4.5C5.82843 4.5 6.5 3.82843 6.5 3Z" stroke="#000000"/>
<path d="M11.5 3V2C11.5 1.17157 10.8284 0.5 10 0.5C9.17157 0.5 8.5 1.17157 8.5 2V3C8.5 3.82843 9.17157 4.5 10 4.5C10.8284 4.5 11.5 3.82843 11.5 3Z" stroke="#000000"/>
<path d="M14.5 7.5V7C14.5 6.17157 13.8284 5.5 13 5.5C12.1716 5.5 11.5 6.17157 11.5 7V7.5C11.5 8.32843 12.1716 9 13 9C13.8284 9 14.5 8.32843 14.5 7.5Z" stroke="#000000"/>
<path d="M3.5 7.5V7C3.5 6.17157 2.82843 5.5 2 5.5C1.17157 5.5 0.5 6.17157 0.5 7V7.5C0.5 8.32843 1.17157 9 2 9C2.82843 9 3.5 8.32843 3.5 7.5Z" stroke="#000000"/>
<path d="M2.8554 11.6399L5.77324 8.09678C6.66803 7.01025 8.33197 7.01025 9.22676 8.09678L12.1446 11.6399C13.084 12.7806 12.2726 14.5 10.7948 14.5C10.6009 14.5 10.4097 14.4549 10.2363 14.3681L9.87662 14.1883C8.3805 13.4403 6.6195 13.4403 5.12338 14.1883L4.76371 14.3681C4.59029 14.4549 4.39905 14.5 4.20516 14.5C2.72742 14.5 1.91599 12.7806 2.8554 11.6399Z" stroke="#000000"/>
</svg>
</file>

<file path="static/casino/protomap_logo.svg">
<svg width="1352" height="1234" viewBox="0 0 1352 1234" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M432.923 0.658243C431.178 1.12524 429.034 5.05625 429.033 7.79325C429.033 8.73025 427.643 12.4213 425.945 15.9963C424.248 19.5713 422.055 24.5213 421.073 26.9963C420.09 29.4713 417.274 36.4463 414.814 42.4963C399.797 79.4263 391.558 113.09 385.935 160.496C382.628 188.379 386.365 240.404 394.564 280.611C395.922 287.274 397.034 293.435 397.034 294.303C397.034 296.173 389.358 312.512 387.652 314.274C387.001 314.946 385.382 317.071 384.053 318.996C356.57 358.832 300.282 365.627 252.034 334.934C238.388 326.253 228.393 327.759 228.685 338.451C229.521 369.003 244.6 410.5 262.669 431.974C264.357 433.98 264.966 435.422 264.3 435.836C262.856 436.733 253.344 450.075 248.717 457.694C244.651 464.389 237.086 480.25 232.595 491.496C231.058 495.346 229.431 499.396 228.979 500.496C225.482 509.013 219.005 531.124 210.522 563.496C206.343 579.446 202.31 594.296 201.56 596.496C200.809 598.696 198.973 604.546 197.479 609.496C193.907 621.331 189.848 633.516 185.987 643.996C184.265 648.671 182.5 653.621 182.066 654.996C176.453 672.761 156.672 709.586 145.839 722.437C143.11 725.674 131.365 737.595 127.937 740.608C122.381 745.491 104.756 755.565 95.5343 759.129C90.5503 761.055 84.9913 761.985 78.4373 761.99C69.9853 761.997 64.1033 766.227 64.0183 772.36C63.9073 780.427 69.9692 785.035 87.1312 789.93C95.0532 792.189 104.347 795.221 107.784 796.667L114.034 799.296V804.611C114.034 836.9 92.1513 879.317 63.5353 902.496C61.4983 904.146 59.1333 906.171 58.2783 906.996C50.6213 914.388 14.1333 934.996 8.70226 934.996C7.87926 934.996 5.59226 936.563 3.62026 938.478C-3.96874 945.848 0.0772495 953.97 18.5712 968.496C20.6722 970.146 23.1393 972.212 24.0543 973.087C26.5803 975.505 36.5993 981.996 37.8043 981.996C38.3893 981.996 47.8653 990.883 58.8623 1001.75C80.5513 1023.17 92.1302 1033.98 101.431 1041.5C103.473 1043.15 106.582 1045.78 108.339 1047.35C110.096 1048.92 113.094 1051.39 115.001 1052.85C116.908 1054.31 119.225 1056.17 120.15 1057C124.648 1061.01 127.129 1063.02 134.362 1068.53C138.667 1071.81 144.038 1075.73 146.297 1077.24C148.555 1078.74 150.658 1080.35 150.969 1080.8C151.28 1081.26 153.774 1083.15 156.511 1085.02C159.249 1086.88 162.174 1088.96 163.011 1089.65C171.984 1096.96 231.992 1133.77 249.034 1142.42C265.271 1150.65 286.097 1161 286.445 1161C286.68 1161 292.1 1163.47 298.49 1166.5C304.879 1169.52 310.503 1172 310.989 1172C311.475 1172 313.146 1172.65 314.703 1173.44C317.709 1174.97 333.537 1181.31 343.534 1184.99C346.834 1186.2 350.434 1187.55 351.534 1187.99C352.634 1188.43 355.109 1189.34 357.034 1190C358.959 1190.66 361.434 1191.58 362.534 1192.06C376.721 1198.15 436.031 1214.41 464.034 1219.89C564.364 1239.54 660.558 1238.16 746.034 1215.86C763.998 1211.17 791.098 1202.43 801.534 1197.95C802.634 1197.48 807.436 1195.52 812.204 1193.58C835.05 1184.33 880.614 1159.41 891.034 1150.47C892.409 1149.29 895.671 1147.02 898.282 1145.41C900.894 1143.81 903.031 1142.2 903.032 1141.83C903.033 1141.46 904.531 1140.23 906.36 1139.1C908.189 1137.97 910.841 1136.02 912.254 1134.77C913.666 1133.52 916.743 1130.92 919.091 1129C921.439 1127.07 924.975 1123.73 926.947 1121.57C935.126 1112.62 943.355 1105.1 947.956 1102.38C949.649 1101.38 951.034 1100.25 951.034 1099.87C951.034 1099.49 953.847 1097.35 957.284 1095.12C966.581 1089.09 967.158 1088.49 967.726 1084.26C968.588 1077.83 962.204 1072.03 951.034 1069.08C929.645 1063.43 892.646 1044.49 883.534 1034.52C882.984 1033.92 880.965 1032.32 879.048 1030.97C877.13 1029.63 874.835 1027.84 873.948 1027.01C873.061 1026.18 871.479 1024.78 870.434 1023.89C862.333 1017.06 844.698 994.843 838.367 983.496C823.031 956.009 814.364 926.543 816.66 909.694L817.534 903.28L838.034 907.993C849.309 910.585 868.884 915.053 881.534 917.921C894.184 920.789 907.234 923.764 910.534 924.533C913.834 925.302 923.734 927.551 932.534 929.529C941.334 931.508 952.134 933.967 956.534 934.994C960.934 936.021 973.759 938.946 985.034 941.494C1025.48 950.633 1049.64 956.124 1055.53 957.524C1114.05 971.406 1113.22 971.402 1145.53 957.957C1206.5 932.594 1273.49 896.663 1302.03 874.025C1305.39 871.36 1311.57 866.733 1316.94 862.864C1319.36 861.117 1322.1 858.97 1323.04 858.092C1323.97 857.214 1327.57 854.021 1331.04 850.996C1347.23 836.885 1355.38 823.8 1350.03 820.496C1349.48 820.156 1349.03 818.756 1349.03 817.384C1349.03 816.012 1347.91 813.234 1346.53 811.211C1345.16 809.187 1344.03 807.242 1344.03 806.889C1344.03 806.095 1318.06 764.69 1317.13 763.996C1316.76 763.721 1314.26 760.121 1311.58 755.996C1308.91 751.871 1306.4 748.271 1306.01 747.996C1305.62 747.721 1303.64 745.021 1301.62 741.996C1296.44 734.279 1291.79 727.595 1289.29 724.304C1288.12 722.76 1284.87 718.346 1282.08 714.496C1279.28 710.646 1276.18 706.596 1275.19 705.496C1274.2 704.396 1272.54 702.034 1271.49 700.246C1270.45 698.459 1269.31 696.996 1268.95 696.996C1268.59 696.996 1267.1 695.186 1265.64 692.973C1264.17 690.761 1262.34 688.173 1261.57 687.223C1260.79 686.273 1258.53 683.471 1256.53 680.996C1254.54 678.521 1251.92 675.321 1250.72 673.884C1249.52 672.447 1247.18 669.604 1245.53 667.565C1243.88 665.527 1241.63 662.845 1240.53 661.607C1239.43 660.368 1237.41 657.843 1236.03 655.996C1234.66 654.149 1232.63 651.624 1231.53 650.385C1230.43 649.147 1228.18 646.464 1226.53 644.424C1222.69 639.669 1218.45 634.767 1214.03 629.979C1212.11 627.889 1208.51 623.804 1206.03 620.9C1203.56 617.996 1200.41 614.407 1199.03 612.925C1197.66 611.443 1194.51 607.905 1192.03 605.062C1187.48 599.829 1186.02 598.25 1164.53 575.353C1151.06 560.988 1090.05 500.057 1076.06 486.996C1062.8 474.611 1056.29 468.534 1046.03 458.996C1041.01 454.321 1034.26 448.021 1031.04 444.996C1025.87 440.144 1015.06 430.305 1008.51 424.496C1007.27 423.396 1004.6 421.146 1002.57 419.496C1000.55 417.846 997.874 415.596 996.624 414.496C995.374 413.396 992.674 411.146 990.624 409.496C988.574 407.846 985.886 405.596 984.651 404.496C983.416 403.396 980.013 400.471 977.089 397.996C974.164 395.521 970.752 392.596 969.506 391.496C964.781 387.327 961.249 384.337 952.034 376.707C946.809 372.381 941.359 367.864 939.922 366.669C938.485 365.474 935.61 363.146 933.532 361.496C931.454 359.846 929.023 357.815 928.13 356.982C927.237 356.15 924.938 354.372 923.02 353.031C921.103 351.69 919.261 350.199 918.927 349.717C918.594 349.236 917.174 348.089 915.773 347.169C912.59 345.078 898.224 334.176 895.534 331.809C892.992 329.573 877.818 318.196 873.519 315.303C871.726 314.097 869.018 311.959 867.501 310.553C865.983 309.147 864.4 307.996 863.983 307.996C863.565 307.996 861.268 306.408 858.879 304.468C833.913 284.196 829.362 278.348 830.32 267.774C832.543 243.261 862.792 222.328 891.395 225.508C904.204 226.932 918.493 230.811 920.183 233.322C921.795 235.718 933.034 230.458 933.034 227.308C933.034 226.586 933.484 225.996 934.034 225.996C938.425 225.996 929.108 208.711 919.291 198.643C903.583 182.533 882.936 177.29 839.081 178.273C808.606 178.956 790.264 183.785 767.4 197.146C759.016 202.046 759.516 203.265 760.885 181.255C765.121 113.158 765.366 116.14 755.134 111.111C742.986 105.14 716.568 131.035 699.396 165.746C697.968 168.634 696.692 170.996 696.562 170.996C696.136 170.996 688.034 159.196 688.034 158.577C688.034 158.247 685.634 154.268 682.7 149.736C679.767 145.204 674.817 137.563 671.7 132.756C668.584 127.949 666.034 123.782 666.034 123.496C666.034 123.21 663.484 119.043 660.368 114.236C657.252 109.429 652.189 101.53 649.118 96.6833C646.047 91.8363 641.276 84.4113 638.516 80.1833C635.756 75.9553 632.845 71.2153 632.045 69.6493C626.832 59.4343 614.888 59.7233 609.439 70.1963C606.283 76.2623 610.299 173.332 614.664 196.496L615.229 199.496L613.223 197.496C612.119 196.396 606.787 190.269 601.375 183.881C595.962 177.492 585.449 165.342 578.013 156.881C570.576 148.419 558.426 134.321 551.013 125.552C537.484 109.549 497.098 63.2603 474.583 37.9523C467.956 30.5023 458.174 19.2022 452.846 12.8392C442.344 0.299243 439.888 -1.20276 432.923 0.658243ZM447.873 30.4423C451.828 35.0883 462.549 47.3503 471.697 57.6923C524.615 117.52 523.507 115.805 539.056 161.996C546.522 184.173 572.666 277.698 571.676 278.687C570.024 280.339 545.16 251.723 539.852 242.06C536.075 235.183 530.049 233.132 528.653 238.246C523.04 258.808 532.647 300.385 550.751 333.876L555.281 342.256L545.019 336.89C539.375 333.939 533.584 330.28 532.149 328.76C526.163 322.417 519.601 325.283 520.679 333.77C524.15 361.117 536.154 396.1 549.816 418.686L554.77 426.875L536.743 413.248C511.478 394.15 479.745 364.743 459.914 342.05C441.813 321.336 438.372 317.147 426.894 301.85C407.359 275.816 407.907 277.436 403.125 231.496C395.832 161.432 406.747 96.4763 437.363 27.7463C440.497 20.7103 439.331 20.4113 447.873 30.4423ZM636.002 115.256C636.019 115.674 638.434 119.724 641.368 124.256C644.301 128.788 649.251 136.429 652.368 141.236C655.484 146.043 658.034 150.249 658.034 150.582C658.034 150.914 660.509 154.78 663.534 159.171C666.559 163.563 669.034 167.447 669.034 167.804C669.034 168.435 675.148 178.008 685.784 194.031C688.672 198.38 691.034 202.181 691.034 202.477C691.034 202.773 693.509 206.836 696.534 211.506C699.559 216.175 704.509 223.817 707.534 228.486C710.559 233.156 713.034 237.249 713.034 237.582C713.034 237.914 715.509 241.78 718.534 246.171C721.559 250.563 724.034 254.447 724.034 254.804C724.034 255.435 730.148 265.008 740.784 281.031C743.672 285.38 746.034 289.181 746.034 289.477C746.034 289.981 747.796 292.759 762.368 315.236C765.484 320.043 768.034 324.21 768.034 324.496C768.034 324.782 770.582 328.949 773.697 333.756C780.82 344.75 789.487 358.314 794.034 365.582C811.498 393.498 822.491 375.688 821.949 320.359C821.668 291.761 821.658 291.775 833.136 304.701C839.435 311.796 860.937 330.607 880.534 346.168C886.034 350.536 891.434 354.87 892.534 355.8C893.634 356.73 897.453 359.662 901.021 362.317C904.588 364.971 907.738 367.469 908.021 367.868C908.303 368.266 910.103 369.69 912.02 371.031C913.938 372.372 916.234 374.15 917.122 374.982C919.111 376.846 923.65 380.624 928.146 384.16C930.01 385.625 932.514 387.65 933.712 388.66C934.909 389.67 937.568 391.846 939.62 393.496C941.672 395.146 944.425 397.467 945.739 398.653C947.052 399.84 949.984 402.315 952.254 404.153C954.524 405.992 957.091 408.189 957.958 409.036C958.825 409.883 962.459 413.015 966.034 415.996C969.609 418.977 973.271 422.109 974.171 422.956C975.072 423.803 977.506 425.846 979.58 427.496C981.654 429.146 984.356 431.396 985.584 432.496C986.812 433.596 989.472 435.846 991.494 437.496C997.857 442.687 1010.18 453.708 1020 462.996C1023.19 466.021 1029.93 472.321 1034.98 476.996C1051.2 492.036 1055.72 496.272 1068.59 508.496C1084.43 523.526 1131.3 570.358 1144.3 584.143C1149.67 589.837 1157.55 598.175 1161.8 602.672C1166.05 607.169 1171.56 613.216 1174.03 616.109C1176.51 619.003 1180.33 623.269 1182.53 625.59C1184.73 627.911 1187.88 631.476 1189.53 633.512C1191.18 635.547 1193.43 638.215 1194.53 639.44C1195.63 640.665 1198.56 643.919 1201.03 646.67C1203.51 649.422 1206.88 653.351 1208.53 655.403C1210.18 657.455 1212.43 660.147 1213.53 661.385C1214.63 662.624 1216.66 665.149 1218.03 666.996C1219.41 668.843 1221.43 671.368 1222.53 672.607C1223.63 673.845 1225.88 676.536 1227.53 678.586C1229.18 680.636 1231.43 683.331 1232.53 684.576C1233.63 685.82 1236.33 689.192 1238.53 692.069C1240.73 694.946 1243.21 698.027 1244.03 698.915C1244.86 699.802 1246.4 701.872 1247.45 703.513C1248.5 705.153 1250.18 707.396 1251.17 708.496C1252.16 709.596 1256.62 715.446 1261.08 721.496C1265.53 727.546 1270.14 733.767 1271.31 735.321C1274.65 739.738 1279.74 746.983 1283.72 752.996C1285.72 756.021 1287.72 758.737 1288.16 759.031C1288.6 759.325 1290.77 762.25 1292.98 765.531C1295.19 768.812 1299.68 775.321 1302.95 779.996C1306.22 784.671 1310.56 790.971 1312.59 793.996C1314.63 797.021 1318.39 802.196 1320.95 805.496C1331.99 819.696 1332.57 825.442 1323.64 831.935C1322.55 832.727 1320.94 834.077 1320.06 834.935C1319.19 835.794 1316.68 837.822 1314.5 839.443C1312.32 841.064 1310.31 842.701 1310.03 843.081C1309.76 843.461 1306.33 845.96 1302.42 848.634C1298.5 851.308 1292.75 855.256 1289.64 857.408C1284.83 860.729 1283.11 861.348 1278.25 861.507C1275.11 861.611 1260.61 864.209 1246.03 867.282C1204.54 876.029 1166.3 883.946 1157.37 885.637L1149.2 887.182L1101.87 861.779C1075.84 847.807 1053.86 836.122 1053.03 835.813C1051.94 835.403 1051.02 831.59 1049.67 821.873C1045.64 793.055 1050.79 793.346 988.534 818.413C944.269 836.237 940.408 837.614 938.915 836.118C938.024 835.226 933.031 828.196 927.819 820.496C922.607 812.796 913.911 799.971 908.495 791.996C903.079 784.021 896.92 774.908 894.809 771.746C892.697 768.584 890.534 765.996 890.002 765.996C889.469 765.996 889.034 765.341 889.034 764.541C889.034 759.846 880.458 761.74 869.913 768.764C865.855 771.468 858.709 776.16 854.034 779.192C834.852 791.633 823.994 798.704 814.145 805.173C808.431 808.926 803.388 811.996 802.94 811.996C801.102 811.996 800.87 818.779 802.594 822.125C813.355 843.004 812.464 843.005 846.829 822.045C861.212 813.273 873.849 805.63 874.91 805.062C876.982 803.953 876.376 803.141 895.174 832.223C911.834 857.999 921.164 872.125 922.753 873.981C925.881 877.634 930.68 876.607 951.329 867.866C961.892 863.394 977.959 856.6 987.034 852.766C996.109 848.933 1007.08 844.276 1011.41 842.417C1020.49 838.522 1020.55 838.533 1021.37 844.219C1023.01 855.576 1022.88 855.432 1042.03 865.73C1056.27 873.384 1075.75 883.994 1087.79 890.659C1095.08 894.694 1101.21 897.996 1101.42 897.996C1101.63 897.996 1106.92 900.85 1113.17 904.338C1149.68 924.709 1145.36 923.684 1170.72 918.003C1189.11 913.881 1192.12 913.396 1190.48 914.821C1188.69 916.384 1142.46 936.742 1133.03 940.123C1113.58 947.101 1109.87 948.042 1105.78 947.025C1104 946.58 1099.38 945.508 1095.53 944.644C1088.34 943.031 1060.33 936.684 1021.53 927.883C1009.43 925.138 996.834 922.255 993.534 921.477C990.234 920.699 977.634 917.824 965.534 915.088C953.434 912.353 933.409 907.817 921.034 905.008C908.659 902.199 888.634 897.658 876.534 894.916C864.434 892.174 852.734 889.499 850.534 888.972C848.334 888.445 835.509 885.522 822.034 882.476C779.055 872.762 757.75 867.913 749.534 865.975C745.134 864.937 739.959 863.839 738.034 863.535C736.109 863.232 728.301 861.858 720.682 860.483C713.064 859.108 700.689 857.319 693.182 856.508C685.676 855.697 673.684 854.375 666.534 853.571C659.384 852.766 644.534 851.399 633.534 850.531C622.534 849.664 605.659 848.04 596.034 846.923C586.409 845.806 575.493 844.625 571.776 844.298C561.881 843.429 562.043 843.755 543.899 787.996C541.661 781.121 538.752 772.312 537.432 768.421C536.113 764.529 535.034 761.094 535.034 760.787C535.034 760.48 537.621 759.226 540.784 758.001C547.215 755.511 567.444 747.378 570.534 746.041C571.634 745.565 574.559 744.274 577.034 743.172C579.509 742.069 590.084 737.572 600.534 733.178C610.984 728.783 625.334 722.445 632.422 719.092C639.511 715.739 645.913 712.996 646.648 712.996C654.602 712.996 658.23 704.802 654.97 694.205C648.762 674.032 644.994 662.221 637.995 640.996C611.328 560.125 603.59 528.404 602.304 494.69L601.74 479.884L604.617 480.606C608.498 481.58 635.835 492.766 649.034 498.781C663.508 505.377 667.269 506.996 668.117 506.996C668.636 506.996 669.843 507.407 670.798 507.91C676.606 510.969 702.733 519.996 705.777 519.996C711.452 519.996 712.257 511.808 707.704 500.398C705.751 495.502 702.995 487.446 701.581 482.496C700.167 477.546 698.595 472.371 698.088 470.996C697.056 468.194 689.216 443.261 683.153 423.496C665.549 366.111 646.056 278.952 640.1 230.996C636.174 199.388 633.09 171.406 632.053 157.996C631.479 150.571 630.34 135.925 629.521 125.449C628.703 114.973 628.034 105.754 628.034 104.962C628.034 103.551 635.938 113.763 636.002 115.256ZM741.715 156.245C740.32 187.345 741.505 223.404 744.058 227.536C747.76 233.525 754.81 233.42 760.946 227.284C783.515 204.715 844.159 191.923 883.534 201.427L891.534 203.358L879.034 204.554C860.189 206.356 844.3 212.677 834.799 222.15C833.845 223.101 832.495 224.243 831.799 224.688C830.644 225.426 826.215 230.362 821.768 235.869C819.186 239.067 813.338 250.998 812.585 254.607L811.936 257.717L802.735 255.811C784.92 252.12 785.034 251.924 785.034 286.385V311.475L780.534 304.767C778.059 301.077 776.034 297.815 776.034 297.518C776.034 297.22 773.484 293.043 770.368 288.236C767.252 283.429 762.189 275.53 759.118 270.683C756.047 265.836 751.172 258.311 748.284 253.961C745.396 249.612 743.034 245.811 743.034 245.515C743.034 245.219 740.559 241.156 737.534 236.486C734.509 231.817 729.559 224.175 726.534 219.506C723.509 214.836 721.034 210.782 721.034 210.496C721.034 210.21 718.537 206.225 715.486 201.64L709.938 193.303L713.976 184.127C721.948 166.012 738.891 137.998 741.878 137.995C742.239 137.995 742.165 146.208 741.715 156.245ZM564.575 164.938C570.098 171.295 581.091 184.371 589.004 193.996C596.917 203.621 606.911 215.38 611.213 220.127C618.267 227.913 619.034 229.156 619.034 232.811C619.034 235.039 620.206 243.08 621.639 250.679C623.072 258.279 624.609 267.646 625.054 271.496C627.601 293.537 646.372 374.202 658.678 415.996C664.294 435.069 672.968 463.102 674.09 465.81C674.618 467.082 674.708 467.923 674.292 467.677C672.056 466.361 631.635 449.35 626.534 447.579L620.534 445.496L620.297 440.996C619.804 431.66 618.039 421.07 612.464 393.996C600.973 338.188 566.68 206.08 552.933 164.659C549.617 154.67 546.687 145.821 546.422 144.996C546.157 144.171 547.873 145.72 550.237 148.438C552.6 151.157 559.053 158.582 564.575 164.938ZM543.294 266.105C553.141 277.826 554.735 279.295 575.591 295.874C576.517 296.61 580.508 311.926 592.038 358.996C598.253 384.368 608.022 433.383 608.031 439.246C608.034 440.754 607.02 440.996 600.716 440.996C596.69 440.996 591.055 441.691 588.193 442.541C582.838 444.132 581.034 443.876 581.034 441.528C581.034 440.786 577.24 435.634 572.604 430.079C552.836 406.398 541.497 382.39 533.008 346.246C532.071 342.256 531.516 342.211 540.806 346.88C570.32 361.716 584.209 359.066 569.622 341.382C559.188 328.732 545.427 298.618 539.984 276.521C537.461 266.28 536.177 257.653 537.388 259.079C537.582 259.309 540.24 262.47 543.294 266.105ZM808.034 270.047C808.034 270.44 807.101 271.007 805.96 271.305C804.819 271.603 803.641 272.781 803.343 273.922C803.045 275.063 802.403 275.996 801.917 275.996C801.425 275.996 801.034 289.608 801.034 306.719C801.034 333.682 800.859 337.191 799.6 335.394C798.464 333.772 798.018 326.495 797.451 300.315L796.735 267.282L802.385 268.306C805.492 268.87 808.034 269.653 808.034 270.047ZM421.987 317.427C449.935 358.049 524.336 427.089 562.672 447.976C566.996 450.332 570.713 452.417 570.933 452.61C571.152 452.802 570.392 454.88 569.245 457.228C564.141 467.673 562.409 481.297 564.071 497.929C565.537 512.591 571.518 551.566 573.898 561.969C575.235 567.811 575.521 567.879 567.52 560.447C563.7 556.899 560.244 553.996 559.839 553.996C556.324 553.996 534.201 527.943 507.617 492.496C476.898 451.535 461.19 424.294 438.997 373.496C432.445 358.498 417.076 312.996 418.563 312.996C418.769 312.996 420.31 314.99 421.987 317.427ZM420.973 369.996C435.512 406.435 453.952 441.846 473.567 470.996C485.627 488.917 486.291 489.857 495.319 501.792C502.217 510.91 502.744 511.898 499.945 510.45C493.909 507.329 480.474 503.913 469.964 502.828L459.394 501.736L456.783 497.116C455.347 494.575 450.428 486.779 445.853 479.792C441.278 472.805 433.484 460.758 428.534 453.021C423.584 445.284 416.648 434.576 413.12 429.225C409.592 423.874 404.382 415.67 401.542 410.994C394.649 399.646 387.783 390.116 386.453 390.05C385.859 390.02 383.159 388.873 380.453 387.5C375.511 384.993 371.034 384.226 371.034 385.888C371.034 386.378 369.963 387.048 368.653 387.377C367.273 387.723 365.636 389.345 364.758 391.235C363.926 393.029 361.572 398.096 359.527 402.496C357.482 406.896 350.416 422.646 343.825 437.496C337.234 452.346 330.8 466.746 329.529 469.496C323.17 483.244 320.27 489.663 308.515 515.996C301.518 531.671 294.31 547.711 292.496 551.641C286.061 565.584 283.034 572.851 283.034 574.355C283.034 575.192 282.584 576.156 282.034 576.496C278.148 578.898 282.496 586.187 292.593 594.196C296.961 597.661 301.209 601.233 302.034 602.135C302.859 603.036 309.091 608.211 315.884 613.635C328.61 623.797 343.987 636.274 364.667 653.219C386.933 671.462 390.586 674.497 392.893 676.663C402.031 685.242 406.53 688.292 418.34 693.914C442.308 705.324 476.268 706.145 498.809 695.859C502.26 694.284 505.341 692.996 505.656 692.996C507.558 692.996 523.662 681.174 529.652 675.38C554.059 651.776 565.467 615.616 558.698 583.318C557.151 575.939 556.161 575.485 571.638 589.249L582.605 599.002L586.464 612.749C591.189 629.582 599.789 655.605 605.68 670.894C608.096 677.163 609.951 682.352 609.803 682.427C609.181 682.74 603.378 685.33 601.534 686.118C600.434 686.588 581.534 694.355 559.534 703.378C483.548 734.544 488.46 732.21 487.442 737.633C486.721 741.477 485.297 736.854 512.077 817.59C520.303 842.392 527.034 863.421 527.034 864.321C527.034 866.862 531.117 867.333 544.872 866.376C563.184 865.103 572.301 865.381 592.534 867.832C602.434 869.03 623.134 870.91 638.534 872.008C653.934 873.107 671.034 874.445 676.534 874.984C682.034 875.522 691.034 876.026 696.534 876.104C715.611 876.377 741.563 881.372 779.3 892.037C798.74 897.53 797.97 896.677 797.307 911.996C796.286 935.609 800.364 953.508 812.806 980.024C816.999 988.959 826.097 1004.89 828.308 1007.17C829.019 1007.9 830.704 1010.07 832.053 1011.98C833.403 1013.9 835.188 1016.2 836.02 1017.1C836.853 1018 839.559 1021.07 842.034 1023.94C848.099 1030.97 858.938 1041.82 863.569 1045.5C865.647 1047.15 868.514 1049.43 869.94 1050.57C871.367 1051.71 874.784 1054.16 877.534 1056.01C880.284 1057.85 882.761 1059.69 883.038 1060.09C885.361 1063.44 920.605 1082.12 930.034 1085C932.509 1085.75 934.717 1086.5 934.941 1086.67C935.406 1087.02 932.281 1089.93 926.012 1095C923.628 1096.92 919.111 1100.97 915.972 1104C912.834 1107.02 908.81 1110.62 907.031 1112C905.252 1113.37 902.612 1115.49 901.165 1116.71C870.835 1142.21 822.188 1168.66 777.034 1184.19C659.688 1224.57 499.383 1220.61 376.537 1174.32C374.339 1173.49 369.389 1171.78 365.537 1170.51C361.685 1169.25 356.509 1167.44 354.034 1166.5C348.864 1164.54 330.51 1157.23 327.534 1155.95C326.434 1155.47 322.699 1153.93 319.233 1152.51C305.372 1146.83 275.287 1132.33 256.851 1122.43C239.593 1113.16 197.294 1087.92 190.538 1082.85C186.847 1080.08 183.045 1077.47 168.034 1067.42C165.009 1065.39 162.309 1063.42 162.034 1063.05C161.759 1062.67 159.37 1060.82 156.725 1058.93C148.955 1053.38 138.793 1045.59 135.957 1043C135.054 1042.17 132.61 1040.15 130.526 1038.5C125.026 1034.14 119.343 1029.44 117.681 1027.86C116.887 1027.11 114.567 1025.15 112.527 1023.5C104.364 1016.9 88.9833 1002.64 72.8703 986.746C65.7613 979.733 59.7342 973.996 59.4762 973.996C57.9202 973.996 48.4883 965.135 48.8593 964.022C49.1653 963.103 48.7683 962.884 47.6053 963.33C46.2253 963.86 46.0193 963.559 46.5163 961.74C47.0573 959.763 46.9963 959.709 46.0103 961.286C44.9643 962.957 44.6693 962.891 41.5713 960.286C33.4263 953.439 31.5543 951.996 30.8193 951.996C27.9343 951.996 31.2153 948.888 37.6803 945.496C46.6363 940.797 65.8703 928.323 69.2903 924.996C70.1383 924.171 72.5163 922.146 74.5743 920.496C110.519 891.679 130.994 852.539 132.734 809.313L133.305 795.13L130.17 790.866C128.445 788.521 127.034 786.006 127.034 785.278C127.034 784.549 125.909 783.441 124.534 782.814C123.159 782.188 122.034 781.39 122.034 781.043C122.034 780.695 119.559 779.569 116.534 778.541C109.548 776.166 109.517 776.249 119.192 771.496C123.671 769.296 127.83 767.031 128.434 766.463C129.039 765.895 131.109 764.344 133.034 763.015C143.426 755.846 163.09 735.523 169.751 725.067C171.703 722.003 173.607 719.271 173.982 718.996C176.772 716.953 190 691.745 196.022 676.996C198.38 671.221 200.87 665.146 201.556 663.496C209.215 645.054 220.942 607.653 231.03 569.496C245.28 515.596 254.247 489.603 266.663 466.2C273.255 453.774 276.929 449.588 281.822 448.929C292.349 447.511 295.142 436.949 287.118 428.906C276.971 418.737 260.341 389.693 254.136 371.305C249.876 358.682 249.858 358.733 257.268 362.263C295.973 380.698 349.218 378.659 375.206 357.747C383.609 350.986 398.311 335.627 402.542 329.192L405.372 324.887L411.077 342.192C414.215 351.709 418.668 364.221 420.973 369.996ZM386.917 427.246C391.491 434.534 399.445 447.021 404.593 454.996C409.741 462.971 417.63 475.315 422.124 482.426C426.619 489.538 431.795 497.442 433.626 499.992L436.957 504.627L430.003 506.867C385.047 521.346 355.987 565.994 360.955 612.952C361.505 618.153 361.822 622.541 361.66 622.703C361.323 623.04 350.014 614.05 328.063 595.996C319.704 589.121 311.122 582.146 308.991 580.496C303.796 576.474 303.236 579.058 314.73 553.996C316.117 550.971 322.878 535.896 329.754 520.496C336.629 505.096 343.593 489.571 345.229 485.996C346.865 482.421 349.013 477.696 350.004 475.496C350.994 473.296 353.356 468.121 355.252 463.996C357.148 459.871 362.937 446.937 368.117 435.254C379.273 410.09 376.808 411.14 386.917 427.246ZM611.82 454.525C614.652 455.366 621.371 458.231 626.752 460.891C632.132 463.551 646.311 469.933 658.26 475.074C679.527 484.224 684.697 487.666 681.688 490.675C681.22 491.143 642.917 473.844 635.809 469.955C634.861 469.436 631.261 468.062 627.809 466.902C624.358 465.742 619.666 463.92 617.382 462.853C596.669 453.173 580.034 464.757 580.034 488.861C580.034 508.068 589.148 557.652 597.337 582.996C598.136 585.471 600.003 591.546 601.486 596.496C604.468 606.457 617.604 647.455 625.035 669.996C633.81 696.613 633.999 697.556 630.784 698.573C629.547 698.964 625.609 700.618 622.034 702.248C618.459 703.879 614.634 705.584 613.534 706.037C612.434 706.49 609.959 707.516 608.034 708.317C606.109 709.117 600.709 711.217 596.034 712.981C587.339 716.264 569.125 723.415 565.534 724.957C564.434 725.429 561.509 726.704 559.034 727.789C556.559 728.875 550.934 731.189 546.534 732.932C542.134 734.675 537.634 736.475 536.534 736.932C535.434 737.389 531.384 739.035 527.534 740.59C523.684 742.145 519.634 744.495 518.534 745.812C517.434 747.129 515.697 749.108 514.674 750.211C510.489 754.722 511.969 762.095 523.06 791.996C524.794 796.671 526.568 801.621 527.003 802.996C527.438 804.371 529.377 809.546 531.313 814.496C541.668 840.981 546.325 854.038 545.655 854.708C545.45 854.914 543.688 855.34 541.74 855.656L538.199 856.231L519.483 799.363C497.801 733.483 499.777 740.843 503.534 739.959C505.184 739.571 512.384 736.766 519.534 733.726C526.684 730.686 543.784 723.614 557.534 718.01C571.284 712.405 584.109 707.131 586.034 706.289C592.604 703.416 595.539 702.2 608.534 696.97C627.639 689.281 627.647 689.264 619.657 670.736C607.773 643.178 590.442 584.324 586.039 556.575C585.435 552.769 584.772 549.381 584.565 549.046C584.358 548.711 583.017 539.9 581.586 529.467C580.154 519.033 578.519 507.796 577.952 504.496C571.113 464.711 583.681 446.169 611.82 454.525ZM878.007 494.688C872.416 498.514 872.551 499.445 882.094 522.784C894.266 552.552 906.208 581.882 912.514 597.496C943.508 674.242 942.223 671.271 946.032 674.994C948.63 677.534 949.906 678.003 954.318 678.044C957.187 678.07 978.434 679.131 1001.53 680.402C1045.38 682.814 1045.84 682.798 1050.28 678.655C1055.08 674.186 1054.19 671.011 1045.66 662.154C1036.33 652.476 1031.14 646.985 1018.03 632.923C1012.26 626.728 1005.51 619.528 1003.03 616.923C1000.56 614.318 993.809 607.118 988.034 600.923C982.259 594.728 975.509 587.528 973.034 584.923C970.559 582.318 963.809 575.116 958.034 568.918C952.259 562.72 944.088 554.015 939.877 549.573C930.25 539.418 925.193 534.029 912.034 519.896C885.177 491.051 884.286 490.391 878.007 494.688ZM961.784 521.685C955.984 523.201 970.034 559.553 980.673 570.559C983.897 573.893 990.359 580.829 995.034 585.971C999.709 591.114 1004 595.81 1004.56 596.409C1023.78 616.835 1034 629.5 1036 632.5C1036.15 632.721 1037 633.5 1037 633.5C1037 633.5 1038 634 1038.27 634.12C1038.77 634.344 1043.05 638.19 1050.55 646.746C1054.97 651.786 1056.41 651.951 1070.88 649.08C1076.19 648.026 1086.83 645.987 1094.53 644.549C1117.5 640.261 1117.03 640.445 1117.03 635.733C1117.03 629.267 1115.67 628.685 1093.33 625.608C1066.99 621.982 1068.38 622.359 1063.82 617.645C1061.61 615.363 1048.72 602.041 1035.17 588.041C1021.62 574.04 1003.96 555.815 995.931 547.541C987.9 539.266 979.35 530.439 976.931 527.924C971.52 522.298 966.831 520.366 961.784 521.685ZM471.653 524.503C557.578 539.078 562.929 659.108 478.587 680.007C459.063 684.845 424.821 678.532 416.595 668.578C416.012 667.872 412.372 664.782 408.506 661.712C383.14 641.565 374.586 601.75 388.723 569.637C402.684 537.925 437.875 518.773 471.653 524.503ZM447.73 543.074C442.386 546.614 438.151 554.21 435.508 564.996L433.916 571.496L426.887 573.256C386.754 583.307 378.223 617.274 413.273 627.463L418.927 629.107L418.366 633.842C414.689 664.89 455.569 683.675 466.961 656.172L468.159 653.279L474.261 655.744C504.258 667.86 526.064 648.19 508.039 625.275L506.009 622.694L510.87 619.42C527.067 608.513 531.607 591.479 521.943 577.874C518.02 572.353 502.465 567.509 490.758 568.163L484.81 568.496L483.093 562.996C476.777 542.758 461.338 534.061 447.73 543.074ZM913.534 545.636C915.734 548.158 920.459 553.278 924.034 557.015C927.609 560.752 935.259 568.877 941.034 575.071C946.809 581.265 953.559 588.464 956.034 591.069C958.509 593.674 965.259 600.873 971.034 607.067C976.809 613.26 982.659 619.525 984.034 620.988C985.409 622.45 992.159 629.674 999.034 637.039C1005.91 644.405 1014.54 653.589 1018.22 657.447C1021.89 661.306 1024.8 664.561 1024.68 664.68C1024.33 665.031 956.927 661.233 956.663 660.847C956.341 660.378 940.533 621.823 933.967 605.496C929.417 594.181 909.775 545.703 908.339 542.246C907.256 539.638 909.684 541.222 913.534 545.636ZM463.701 555.604C465.572 557.589 467.94 560.851 468.962 562.854L470.82 566.496H459.547H448.274L449.132 564.239C453.521 552.695 458.291 549.868 463.701 555.604ZM984.213 553.34C984.939 554.079 996.559 566.093 1010.03 580.039C1023.51 593.984 1040.38 611.4 1047.53 618.741L1060.53 632.088L1070.53 633.562C1076.03 634.373 1080.95 635.165 1081.45 635.323C1081.96 635.481 1077.69 636.54 1071.95 637.677L1061.53 639.744L1056.19 634.12C1048.83 626.385 1044.99 622.224 1026.09 601.496C1017.06 591.596 1005.08 578.546 999.467 572.496C989.254 561.485 982.034 553.163 982.034 552.401C982.034 551.63 982.897 552.002 984.213 553.34ZM470.778 581.39C488.961 590.693 492.432 612.369 477.849 625.544C463.884 638.16 445.499 634.665 435.516 617.496C423.28 596.451 448.914 570.203 470.778 581.39ZM506.033 583.323C517.473 588.85 516.671 598.601 504.034 607.614L499.534 610.824L499.402 604.572C499.24 596.88 496.912 588.568 493.519 583.569L490.96 579.798L496.247 580.474C499.155 580.845 503.558 582.127 506.033 583.323ZM421.839 593.666C420.365 598.579 419.931 602.397 420.193 608.166C420.599 617.098 420.216 617.426 413.519 613.894C408.398 611.192 404.034 607.081 404.034 604.959C404.034 600.864 417.391 588.682 423.687 587.036C423.771 587.014 422.939 589.997 421.839 593.666ZM496.217 632.746C506.678 643.994 497.71 651.644 481.991 644.882L477.077 642.768L482.991 638.946C486.243 636.843 489.66 633.97 490.584 632.56C492.686 629.352 493.073 629.365 496.217 632.746ZM446.388 643.411C449.218 644.187 452.778 645.096 454.298 645.431C457.991 646.246 455.91 650.726 450.033 654.615C442.178 659.813 431.034 650.506 431.034 638.748V635.131L436.138 638.566C438.945 640.455 443.557 642.635 446.388 643.411ZM884.777 781.246C886.364 783.584 891.644 791.346 896.511 798.496C922.051 836.017 926.701 842.884 929.492 847.204C933.176 852.906 940.296 854.91 943.034 851.015C943.757 849.986 1036.03 813.141 1036.04 813.878C1036.06 815.318 1040.08 841.312 1040.62 843.465C1040.97 844.862 1042.21 846.073 1043.66 846.438C1045.01 846.776 1060.6 854.841 1078.32 864.36C1096.04 873.879 1115.93 884.509 1122.53 887.982C1129.13 891.456 1136.96 895.58 1139.93 897.147C1145.71 900.202 1148.94 900.553 1156.03 898.897C1160.49 897.857 1193.56 890.984 1235 882.488C1246.8 880.067 1256.57 878.203 1256.72 878.345C1258.24 879.866 1235.23 890.955 1226.53 892.894C1221.03 894.118 1201.73 898.395 1183.65 902.397L1150.76 909.674L1138.65 903.03C1131.98 899.376 1119.56 892.615 1111.03 888.006C1102.51 883.397 1094.18 878.89 1092.53 877.99C1090.88 877.09 1083.46 873.045 1076.03 869.001C1068.61 864.956 1056.52 858.351 1049.17 854.322C1041.82 850.293 1035.51 846.996 1035.15 846.996C1034.78 846.996 1033.7 843.166 1032.73 838.484C1028.89 819.823 1032.44 819.56 977.927 842.546C953.511 852.841 932.859 861.44 932.034 861.654C931.044 861.911 928.62 859.058 924.907 853.27C921.812 848.444 913.464 835.496 906.355 824.496C899.247 813.496 891.204 801.024 888.482 796.781C880.631 784.541 883.616 783.831 845.641 806.968C824.539 819.825 818.65 823 817.952 821.897C816.586 819.74 816.634 819.681 823.284 815.344C838.819 805.211 853.471 795.703 864.534 788.576C871.134 784.325 877.659 780.005 879.034 778.977C880.409 777.948 881.615 777.082 881.713 777.052C881.812 777.021 883.19 778.908 884.777 781.246Z" fill="black"/>
</svg>
</file>

<file path="static/casino/ram.svg">
<?xml version="1.0" encoding="utf-8"?>
<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Layer_1"  width="512" height="512" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve">
<g id="ram">
	<g>
		<path fill="#A0D468" d="M278.625,361.594L256,338.969l0,0c-4.172-4.156-4.172-10.922,0-15.094c4.156-4.156,10.922-4.156,15.078,0    l0,0l22.625,22.641L512,128.227L459.203,75.43c-4.172,4.164-10.922,4.164-15.094,0c-4.156-4.164-4.156-10.922,0-15.086    l-7.531-7.539c-4.172,4.164-10.922,4.164-15.094-0.008c-4.156-4.164-4.156-10.914,0-15.078L383.781,0L0,383.781L37.703,421.5    c4.172-4.172,10.922-4.172,15.094,0c4.156,4.156,4.156,10.906,0,15.078l7.531,7.547c4.172-4.172,10.922-4.172,15.094,0    c4.156,4.156,4.172,10.906,0,15.078L128.219,512L278.625,361.594z"/>
	</g>
	<g>
		<polygon fill="#8CC153" points="256,338.969 105.594,489.375 128.219,512 278.625,361.594 256,338.969   "/>
		<polygon fill="#8CC153" points="271.078,323.875 271.078,323.875 271.078,323.875 293.703,346.516 512,128.227 489.375,105.602       "/>
	</g>
	<g>
		<path fill="#FFCE54" d="M482.266,142.867c-4.156,4.164-4.156,10.922,0,15.086l15.094-15.086    C493.188,138.703,486.438,138.703,482.266,142.867z"/>
		<path fill="#FFCE54" d="M459.641,165.492c-4.156,4.164-4.156,10.922,0,15.086l15.094-15.086    C470.562,161.328,463.812,161.328,459.641,165.492z"/>
		<path fill="#FFCE54" d="M437.016,188.117c-4.172,4.172-4.172,10.922,0,15.086l15.078-15.086    C447.938,183.953,441.188,183.953,437.016,188.117z"/>
		<path fill="#FFCE54" d="M414.391,210.75c-4.172,4.164-4.172,10.922,0,15.086l15.078-15.086    C425.312,206.586,418.547,206.586,414.391,210.75z"/>
		<path fill="#FFCE54" d="M391.766,233.375c-4.172,4.164-4.172,10.922,0,15.086l15.078-15.086    C402.688,229.211,395.922,229.211,391.766,233.375z"/>
		<path fill="#FFCE54" d="M369.125,256c-4.156,4.172-4.156,10.922,0,15.086L384.219,256    C380.047,251.836,373.297,251.836,369.125,256z"/>
		<path fill="#FFCE54" d="M346.5,278.625c-4.156,4.172-4.156,10.938,0,15.094l15.094-15.094    C357.422,274.469,350.672,274.469,346.5,278.625z"/>
		<path fill="#FFCE54" d="M323.875,301.25c-4.156,4.172-4.156,10.938,0,15.094l15.094-15.094    C334.797,297.094,328.047,297.094,323.875,301.25z"/>
		<path fill="#FFCE54" d="M301.25,323.875c-4.156,4.188-4.172,10.938,0,15.094l15.094-15.094    C312.172,319.719,305.422,319.719,301.25,323.875z"/>
		<path fill="#FFCE54" d="M256,369.141c-4.172,4.172-4.172,10.922,0,15.078l15.078-15.078    C266.922,364.969,260.156,364.969,256,369.141z"/>
		<path fill="#FFCE54" d="M233.375,391.766c-4.172,4.172-4.172,10.922,0,15.078l15.078-15.078    C244.281,387.594,237.531,387.594,233.375,391.766z"/>
		<path fill="#FFCE54" d="M210.734,414.406c-4.156,4.156-4.156,10.906,0,15.078l15.094-15.078    C221.656,410.219,214.906,410.219,210.734,414.406z"/>
		<path fill="#FFCE54" d="M188.109,437.031c-4.156,4.156-4.156,10.906,0,15.078l15.094-15.078    C199.031,432.859,192.281,432.859,188.109,437.031z"/>
		<path fill="#FFCE54" d="M165.484,459.656c-4.156,4.156-4.156,10.906,0,15.078l15.094-15.078    C176.406,455.484,169.656,455.484,165.484,459.656z"/>
		<path fill="#FFCE54" d="M142.859,482.281c-4.172,4.156-4.172,10.906,0,15.078l15.078-15.078    C153.781,478.109,147.031,478.109,142.859,482.281z"/>
	</g>
	
		<rect x="84.259" y="362.447" transform="matrix(0.7071 0.7071 -0.7071 0.7071 302.302 37.7409)" fill="#656D78" width="42.669" height="42.669"/>
	<polygon fill="#656D78" points="165.938,353.609 135.766,323.438 165.938,293.281 196.094,323.438  "/>
	<polygon fill="#656D78" points="256.438,263.102 226.266,232.93 256.438,202.766 286.609,232.93  "/>
	
		<rect x="295.447" y="151.259" transform="matrix(0.7071 0.7071 -0.7071 0.7071 214.8253 -173.4466)" fill="#656D78" width="42.669" height="42.669"/>
	<g>
		<path fill="#434A54" d="M60.328,383.781l45.266,45.25l45.25-45.25l-45.25-45.25L60.328,383.781z M105.594,398.875L90.5,383.781    l15.094-15.094l15.078,15.094L105.594,398.875z"/>
		<path fill="#434A54" d="M120.672,323.438l45.266,45.25l45.25-45.25l-45.25-45.25L120.672,323.438z M165.938,338.531    l-15.094-15.094l15.094-15.078l15.078,15.078L165.938,338.531z"/>
		<path fill="#434A54" d="M211.188,232.93l45.25,45.258l45.25-45.258l-45.25-45.25L211.188,232.93z M256.438,248.016l-15.078-15.086    l15.078-15.086l15.094,15.086L256.438,248.016z"/>
		<path fill="#434A54" d="M316.781,127.336l-45.25,45.258l45.25,45.25l45.25-45.25L316.781,127.336z M301.688,172.594l15.094-15.086    l15.078,15.086l-15.078,15.086L301.688,172.594z"/>
	</g>
	<polygon fill="#656D78" points="377.125,142.422 346.953,112.25 377.125,82.086 407.281,112.25  "/>
	<path fill="#434A54" d="M377.125,67l-45.266,45.25l45.266,45.258l45.25-45.258L377.125,67z M377.125,127.336l-15.094-15.086   l15.094-15.078l15.078,15.078L377.125,127.336z"/>
</g>
</svg>
</file>

<file path="static/halloween/bats.svg">
<?xml version="1.0" encoding="iso-8859-1"?>
<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg fill="#000000" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
	 width="800px" height="800px" viewBox="0 0 236.844 236.844"
	 xml:space="preserve">
<g>
	<g>
		<path d="M236.062,70.277c-11.115-5.777-23.436-7.583-36.618-5.369c-15.044,2.527-29.146,9.812-40.501,15.676
			c-3.835,1.979-7.455,3.851-10.721,5.336c-1.468,0.67-2.826,1.112-4.044,1.317c-2.854,0.479-4.845-0.327-6.083-2.462
			c-3.323-5.721-3.104-19.211,4.01-26.125c0.508-0.493,0.508-1.304-0.003-1.846c-0.499-0.527-1.356-0.626-1.928-0.197
			c-1.915,1.441-4.288,2.432-6.863,2.865c-4.495,0.754-9.191-0.227-12.559-2.626c-2.737-1.952-4.427-4.716-4.884-7.995
			c-0.101-0.732-0.804-1.284-1.563-1.23c-0.775,0.054-1.314,0.692-1.232,1.424c0.65,5.78-2.178,25.02-11.104,29.953
			c-2.06,1.138-4.07-0.201-4.07-0.201c-3.197-2.016-7.639-10.04-8.135-10.948c-4.787-8.768-11.342-20.771-21.944-31.571
			c-12.515-12.75-28.166-21.05-46.514-24.67c-0.714-0.141-1.404,0.272-1.583,0.916c-0.184,0.666,0.193,1.372,0.875,1.645
			c4.573,1.825,13.094,7.328,16.022,16.37c2.313,7.139,0.471,14.763-5.474,22.658c-0.327,0.436-0.338,1.024-0.026,1.499
			c0.311,0.477,0.875,0.735,1.439,0.661c11.13-1.461,15.726,2.577,17.298,6.364c4.879,11.759-2.65,15.871-2.65,15.871
			c-0.643,0.356-0.858,0.923-0.669,1.536c0.195,0.629,0.826,1.059,1.498,1.021c10.236-0.571,30.378,9.618,43.107,21.803
			c8.75,8.379,13.327,16.995,12.888,24.263c-0.039,0.63,0.378,1.213,1.015,1.418c0.621,0.201,1.313-0.046,1.621-0.566
			c3.495-5.875,11.885-10.196,23.628-12.169c9.821-1.649,21.245-1.552,31.339,0.266c9.852,1.774,17.163,5.054,19.565,8.771
			c0.363,0.565,1.104,0.827,1.741,0.596c0.637-0.229,0.979-0.868,0.813-1.521c-1.035-4.088-0.159-8.504,2.465-12.433
			c2.859-4.277,7.401-7.307,12.154-8.105c3.127-0.525,6.163-0.091,9.021,1.288c0.488,0.236,1.09,0.185,1.501-0.134
			c0.416-0.321,0.587-0.858,0.438-1.368c-1.408-4.818-0.403-10.246,2.828-15.289c4.567-7.125,12.757-12.45,21.37-13.897
			c0.701-0.119,1.41-0.209,2.107-0.275c0.604-0.055,1.091-0.495,1.188-1.065C236.924,71.15,236.616,70.566,236.062,70.277z"/>
		<path d="M140.965,127.705c-8.191,0.52-15.716,3.676-22.363,9.38c-7.586,6.509-13.035,15.37-17.421,22.502
			c-1.482,2.408-2.88,4.684-4.209,6.622c-0.597,0.873-1.21,1.581-1.823,2.106c-1.44,1.235-2.829,1.457-4.247,0.678
			c-3.801-2.085-8.243-9.729-6.592-16.016c0.118-0.449-0.156-0.904-0.626-1.035c-0.458-0.127-0.973,0.107-1.148,0.541
			c-0.587,1.458-1.583,2.816-2.882,3.932c-2.267,1.943-5.234,2.982-7.935,2.775c-2.196-0.169-4.08-1.147-5.446-2.833
			c-0.304-0.377-0.886-0.448-1.293-0.162c-0.417,0.293-0.503,0.833-0.21,1.217c2.321,3.022,7.245,14.775,3.906,20.564
			c-0.771,1.335-2.352,1.265-2.352,1.265c-2.477-0.049-7.684-3.048-8.27-3.39c-5.653-3.299-13.394-7.816-22.997-10.288
			c-11.338-2.919-22.929-2.279-34.449,1.899c-0.448,0.162-0.696,0.628-0.578,1.05c0.122,0.436,0.572,0.704,1.047,0.626
			c3.184-0.523,9.827-0.319,14.531,3.763c3.713,3.225,5.26,8.125,4.597,14.566c-0.036,0.354,0.157,0.688,0.492,0.85
			c0.336,0.163,0.74,0.117,1.032-0.116c5.75-4.587,9.696-3.876,11.86-2.282c6.717,4.946,3.884,9.802,3.884,9.802
			c-0.24,0.417-0.169,0.809,0.145,1.088c0.322,0.287,0.822,0.315,1.186,0.066c5.551-3.785,20.301-4.885,31.567-2.355
			c7.746,1.741,13.23,5.026,15.443,9.253c0.191,0.367,0.623,0.553,1.049,0.452c0.417-0.097,0.721-0.47,0.718-0.866
			c-0.027-4.479,3.218-9.744,9.14-14.825c4.953-4.25,11.396-8.061,17.675-10.457c6.127-2.338,11.341-2.973,13.946-1.698
			c0.396,0.193,0.9,0.09,1.18-0.255c0.278-0.346,0.255-0.819-0.059-1.13c-1.964-1.942-2.967-4.718-2.824-7.81
			c0.157-3.368,1.681-6.604,4.077-8.662c1.577-1.353,3.428-2.137,5.497-2.33c0.354-0.033,0.674-0.266,0.797-0.583
			c0.125-0.32,0.039-0.68-0.218-0.916c-2.42-2.227-3.693-5.612-3.587-9.536c0.151-5.543,2.944-11.303,7.288-15.029
			c0.353-0.304,0.72-0.596,1.09-0.868c0.32-0.236,0.444-0.646,0.305-1C141.745,127.901,141.375,127.678,140.965,127.705z"/>
		<path d="M220.366,205.274c-6.166-1.559-12.771-1.144-18.087-0.811c-1.795,0.111-3.491,0.219-4.986,0.239
			c-0.673,0.01-1.266-0.05-1.764-0.177c-1.17-0.295-1.794-0.937-1.909-1.959c-0.309-2.741,2.038-7.853,5.912-9.298
			c0.277-0.104,0.413-0.413,0.309-0.705c-0.102-0.285-0.413-0.467-0.702-0.397c-0.973,0.229-2.044,0.209-3.101-0.059
			c-1.842-0.466-3.47-1.628-4.352-3.107c-0.718-1.204-0.899-2.543-0.523-3.871c0.084-0.296-0.092-0.625-0.39-0.732
			c-0.307-0.108-0.618,0.044-0.71,0.336c-0.722,2.315-5.027,9.185-9.263,9.57c-0.977,0.089-1.52-0.76-1.52-0.76
			c-0.882-1.307-1.232-5.113-1.27-5.542c-0.355-4.149-0.845-9.83-3.08-15.729c-2.638-6.966-7.22-12.758-13.614-17.218
			c-0.249-0.173-0.582-0.131-0.758,0.084c-0.183,0.223-0.156,0.556,0.058,0.774c1.438,1.464,3.769,4.992,3.37,8.935
			c-0.315,3.113-2.296,5.714-5.89,7.729c-0.197,0.112-0.301,0.335-0.261,0.568c0.039,0.234,0.21,0.427,0.438,0.494
			c4.493,1.309,5.569,3.621,5.534,5.33c-0.11,5.307-3.674,5.613-3.674,5.613c-0.305,0.027-0.481,0.208-0.513,0.475
			c-0.031,0.272,0.137,0.542,0.4,0.641c4.002,1.499,9.98,8.767,12.796,15.552c1.934,4.666,2.234,8.722,0.849,11.422
			c-0.121,0.233-0.06,0.526,0.149,0.711c0.203,0.181,0.509,0.203,0.714,0.056c2.319-1.656,6.246-1.897,11.06-0.682
			c4.025,1.018,8.368,2.971,11.916,5.356c3.462,2.329,5.703,4.809,5.996,6.63c0.044,0.277,0.283,0.502,0.564,0.521
			s0.52-0.167,0.565-0.444c0.29-1.733,1.365-3.271,3.026-4.332c1.808-1.152,4.05-1.547,5.998-1.055
			c1.282,0.324,2.368,0.999,3.226,2.004c0.147,0.172,0.387,0.253,0.597,0.201c0.213-0.053,0.367-0.229,0.396-0.449
			c0.271-2.075,1.564-3.978,3.645-5.359c2.938-1.954,6.957-2.612,10.486-1.721c0.287,0.072,0.573,0.156,0.851,0.249
			c0.239,0.08,0.5-0.006,0.632-0.208c0.135-0.206,0.115-0.479-0.048-0.683C230.169,209.396,225.771,206.64,220.366,205.274z"/>
	</g>
</g>
</svg>
</file>

<file path="static/halloween/candy1.svg">
<?xml version="1.0" encoding="iso-8859-1"?>
<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg fill="#000000" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
	 width="800px" height="800px" viewBox="0 0 588.657 588.658"
	 xml:space="preserve">
<g>
	<g>
		<path d="M559.118,316.763c8.874-6.12,18.972-7.345,26.01-15.912c11.322-14.076-7.344-33.966-17.442-41.616
			c-14.075-10.404-23.867,0-9.485-26.928c7.038-12.852,17.748-20.502,22.031-35.19c5.509-19.89-23.256-29.376-37.025-29.682
			c-35.802-0.612-55.998,44.676-92.106,45.9c-0.611,0-1.224,0.306-1.529,0.306c-5.509-12.546-14.076-22.338-26.929-26.928
			c-48.348-17.442-104.346-2.448-153.306,3.978c-37.025,4.896-87.822-11.934-116.892,16.83c-3.366,3.366-2.448,7.65,0.611,10.098
			c-4.283,5.202-7.037,16.524-8.262,30.294c-14.994-33.048-67.319-87.822-94.248-52.632c-18.972,25.092,10.099,53.244,23.562,70.38
			C91.244,288,30.351,296.261,22.7,299.015c-11.322,3.978-17.136,12.852-20.808,23.868c-7.038,20.808,6.426,32.436,26.01,29.376
			c4.284-0.612,43.146-7.65,33.354,11.934c-3.365,6.732-10.403,12.852-14.382,19.584c-4.284,7.65-5.508,21.42,0,28.764
			c23.562,31.824,80.172-32.436,107.712-53.855c2.143,4.896,4.59,8.874,7.038,11.016c44.37,34.884,98.838,21.727,151.47,20.196
			c33.66-0.918,85.374,20.196,110.16-13.158c5.814-7.65,11.628-19.89,17.136-34.578c25.398,10.404,48.654,26.316,73.135,37.944
			c14.993,7.038,42.84,21.726,59.67,12.546c11.321-6.12,18.666-21.114,9.792-32.436C576.56,351.953,539.534,329.615,559.118,316.763
			z M113.889,374.597c-10.099,8.567-20.196,17.136-30.906,24.786c-23.562,16.829-34.578-0.612-15.912-23.562
			c5.202-6.426,11.934-17.748,3.978-25.398c-16.218-15.3-29.682-11.321-50.184-9.485c-11.322-13.771-7.344-24.174,11.934-31.212
			c6.427-2.448,14.076-3.366,20.809-4.59c9.18-1.836,17.441-4.591,25.397-9.792c12.546-8.262,12.546-24.48,6.732-36.414
			c-4.59-9.18-14.688-16.524-20.502-24.786c-15.912-22.644,0-41.31,22.032-31.518c23.562,10.404,45.899,31.518,56.304,55.386
			c-0.306,7.65-0.612,15.606-0.306,23.562c-12.24-6.732-21.421-15.3-29.07-27.54c-2.143-3.672-7.038-0.612-5.508,3.366
			c6.12,14.382,18.972,26.622,34.578,29.682c0,3.978,0.306,7.955,0.611,11.627c-19.277,0.612-39.474,10.404-53.55,23.257
			c-3.366,2.754,0.918,7.649,4.59,5.813c16.524-8.874,31.824-16.83,49.572-22.644c1.224,14.688,3.366,28.764,6.12,40.086
			C137.145,353.483,125.517,364.805,113.889,374.597z M161.318,338.183c-3.672-14.994-2.754-32.13-2.448-47.736
			c0.306-11.628-8.568-56.61-2.142-71.298c1.836,0.306,3.672-0.306,5.508-1.836c10.404-9.486,23.868-11.628,37.944-11.628
			C192.836,251.891,190.694,299.933,161.318,338.183z M165.296,350.422c0.918-2.142,0.307-4.283-0.918-6.119
			c34.578-36.721,40.393-89.658,44.982-138.618c12.852,0.612,26.01,2.754,37.332,2.142c2.754,0,5.508-0.306,7.956-0.612
			c-3.061,63.954-16.83,120.869-66.402,163.71C176.924,366.334,169.886,358.991,165.296,350.422z M206.912,376.126
			c-4.896-0.611-9.18-1.836-13.158-3.06c53.856-37.638,72.522-102.51,71.91-166.463c15.3-1.53,30.601-3.978,45.899-6.426
			c1.53,69.156-19.583,125.153-65.483,177.785C233.229,378.575,220.376,377.962,206.912,376.126z M311.563,376.739
			c-14.381-0.612-28.764-0.918-43.757,0.306c-4.284,0.307-8.568,0.612-12.853,0.918c43.452-41.922,85.986-118.421,65.484-178.703
			c5.201-0.612,10.403-1.53,15.605-2.142c15.606-1.836,39.168-5.202,59.67-2.142C377.354,263.825,356.852,320.435,311.563,376.739z
			 M405.2,197.117c11.934,3.366,21.726,10.098,26.622,21.726c1.224,3.366,2.447,6.732,3.365,10.098
			c-1.529,0.612-2.754,2.142-2.754,3.978c-6.731,53.856-29.987,105.875-66.096,146.268c-15.3-0.306-30.294-1.225-44.981-1.836
			C368.786,337.265,403.67,257.706,405.2,197.117z M376.742,378.881c33.354-32.437,53.55-74.971,61.812-120.258
			c0,19.278-3.06,38.861-6.12,55.386C426.313,347.668,412.85,375.208,376.742,378.881z M548.714,380.411
			c-4.896-1.224-9.792-2.754-14.688-4.59c-16.524-5.508-32.131-14.076-48.042-21.42c-13.465-6.426-28.458-14.688-43.452-18.666
			c3.978-12.24,7.649-25.398,10.098-39.168c10.404,4.59,18.36,12.546,23.256,22.95c1.53,3.06,6.732,0.918,5.508-2.143
			c-4.896-13.157-14.993-21.419-27.539-26.009c0.918-6.12,1.836-12.24,2.142-18.36c13.77,0.918,27.233-4.59,33.966-17.748
			c1.224-2.448-1.836-5.202-3.978-3.06c-8.568,9.18-17.748,15.3-29.683,15.606c0.918-14.994,0.307-29.682-3.06-42.228
			c18.054-0.306,31.824-10.098,46.206-20.808c11.934-8.874,23.256-17.748,37.332-23.562c28.764,10.71,34.271,23.256,16.83,37.332
			c-3.672,4.59-6.427,8.874-9.181,14.076c-4.59,8.874-11.016,22.644-3.365,31.212c1.836,1.836,5.201,2.448,7.649,2.448
			c15.606,0,22.645,10.71,21.42,32.435c-4.896,3.366-11.628,5.202-17.136,7.956c-34.578,16.83,3.06,44.064,17.442,57.223
			C568.604,380.717,561.566,386.225,548.714,380.411z"/>
	</g>
</g>
</svg>
</file>

<file path="static/halloween/candy2.svg">
<?xml version="1.0" encoding="iso-8859-1"?>
<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg fill="#000000" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
	 width="800px" height="800px" viewBox="0 0 581.52 581.52"
	 xml:space="preserve">
<g>
	<g>
		<path d="M577.812,271.134c-2.448-5.814-40.698-20.502-28.458-31.212c9.792-8.568,15.912-30.294,19.584-41.922
			c8.568-26.316,1.836-50.184-28.152-55.386c-39.474-6.732-77.111,39.168-116.279,41.616c-0.307,0-0.612,0.306-0.918,0.306
			c-8.568-12.24-18.666-23.256-29.683-33.354c-41.31-36.72-90.882-32.13-140.76-20.196c0,0,0,0-0.306,0
			c-39.78,6.426-73.44,36.108-95.166,73.44c-28.152-31.824-95.778-72.522-133.722-54.468c-24.48,11.628-18.972,39.168-12.546,60.894
			c4.896,15.606,20.502,26.928,32.13,37.026c35.496,30.906,4.284,50.183-25.092,64.259c-14.688,7.039-29.07,34.885-7.344,44.371
			c9.486,3.977,56.916,3.365,36.108,29.682c-9.792,12.545-21.42,19.277-26.622,34.883c-7.65,22.34,28.458,41.311,46.206,37.639
			c41.31-8.568,67.932-44.676,99.756-70.074c33.354,38.863,86.598,58.447,141.984,49.266c41.922-7.037,76.807-25.396,101.593-52.324
			c33.966,24.785,96.695,70.99,140.147,55.385c16.218-5.814,14.076-26.01,11.322-39.168c-3.366-15.605-14.076-26.316-25.092-37.025
			c-32.13-32.742,6.12-41.922,27.54-50.49C582.709,306.63,584.851,287.352,577.812,271.134z M392.07,171.378
			c26.622,24.174,39.168,60.282,43.146,94.86c2.754,23.868-0.612,45.595-8.568,65.179c-22.644-81.397-88.434-162.181-171.36-185.131
			c0.612,0,1.224,0,1.836,0C309.145,134.964,350.148,133.434,392.07,171.378z M96.168,431.478
			c-7.65,5.508-15.606,9.486-24.48,12.547c-9.18-12.24-18.054-24.48-27.234-36.414c4.284-3.979,8.262-8.262,12.24-12.24
			c3.978-4.283,9.18-11.016,9.486-16.83c0.612-10.404,0.918-27.234-13.158-29.682c-2.448-0.611-4.896-0.918-7.344-1.225
			c-1.224,0-55.08-1.223-20.196-23.256c12.24-7.65,26.622-11.322,39.168-18.666c47.43-28.152-36.414-85.374-43.146-108.629
			c-21.114-71.91,98.532-10.098,131.886,14.688c-7.65,14.382-13.464,29.682-17.136,45.288
			c-11.934-3.366-21.726-13.158-29.988-22.032c-2.754-3.06-8.262,0.918-5.814,4.284c8.262,11.628,19.89,22.338,33.966,24.48
			c-3.366,16.218-3.978,32.435-2.142,48.042c-14.994,4.895-29.988,9.18-45.288,12.545c-4.896,1.225-3.978,9.18,1.224,8.875
			c16.218-0.918,31.212-5.814,45.9-11.936c4.284,21.42,12.546,41.006,24.48,57.223C137.172,395.677,118.2,415.565,96.168,431.478z
			 M151.554,324.685c-0.918-3.672-1.53-7.039-2.142-10.711c0.306,0,0.306,0,0.612-0.305c3.06-1.531,1.53-6.121-1.224-6.426
			c-0.612-7.346-0.612-14.689,0-22.033c48.348,25.398,79.866,76.5,85.068,130.355C194.394,400.878,162.57,369.054,151.554,324.685z
			 M244.578,418.933c0-0.613,0.306-0.918,0.306-1.531c-3.672-59.057-40.392-116.279-95.166-140.147
			c1.53-12.24,5.202-24.48,9.792-36.414c74.664,27.846,136.17,100.979,138.619,182.071
			C279.768,425.358,261.408,423.522,244.578,418.933z M316.488,420.155c-1.836,0.307-3.672,0.613-5.508,0.92
			c-2.142-85.068-68.238-162.793-149.329-185.437c7.038-15.606,16.218-30.294,27.234-43.758
			c80.172,44.676,168.3,104.345,170.442,207.162c0,1.529,0.612,2.447,1.53,3.367C347.395,410.364,332.4,416.179,316.488,420.155z
			 M371.263,396.595c11.934-31.518-24.786-86.904-39.78-110.772c-31.518-49.266-85.68-76.806-137.395-99.756
			c12.24-13.464,26.01-25.398,40.698-34.578c95.166,24.174,151.471,107.406,184.519,194.31c0,0,0,0,0,0.307
			C407.982,366.3,391.459,383.437,371.263,396.595z M545.683,306.63c-10.404,2.754-20.196,4.285-29.683,9.793
			c-48.653,26.621,70.992,96.695,26.011,113.525c-33.66,12.547-97.002-30.295-128.214-48.961
			c28.151-32.74,41.922-76.5,36.414-126.683c0,0,0,0,0-0.306c17.747-0.612,33.354-7.038,46.512-18.972
			c2.754-2.448-0.918-7.344-3.979-5.202c-13.464,9.18-27.54,16.218-43.758,17.442c-2.754-17.748-8.874-34.578-17.748-49.878
			c19.891-0.612,37.026-10.404,54.468-19.89c6.427-3.672,13.158-7.344,19.584-11.016c24.48-17.748,40.086-5.202,46.513,37.638
			c-5.814,12.852-12.853,24.48-19.891,36.414c-3.978,6.732,1.225,19.89,7.956,23.562
			C555.475,272.664,567.715,300.815,545.683,306.63z"/>
		<path d="M493.969,324.685c-9.181-10.404-20.502-18.359-31.824-26.316c-2.142-1.529-5.202,2.143-3.06,3.672
			c10.71,8.262,21.113,17.137,31.212,26.01C492.744,329.886,496.11,326.827,493.969,324.685z"/>
	</g>
</g>
</svg>
</file>

<file path="static/halloween/ghost.svg">
<?xml version="1.0" ?>
<!DOCTYPE svg  PUBLIC '-//W3C//DTD SVG 1.0//EN'  'http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd'>
<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg fill="#000000" width="800px" height="800px" viewBox="0 0 100 100" version="1.0" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="_x31_"/>
<g id="_x32_"/>
<g id="_x33_"/>
<g id="_x34_"/>
<g id="_x35_"/>
<g id="_x36_"/>
<g id="_x37_"/>
<g id="_x38_"/>
<g id="_x39_"/>
<g id="_x31_0">
<path d="M49.8,81.9c-4,0-7.9-1.9-11.2-3.5c-4.8-2.3-7-3.2-8.5-1.4c-3,3.4-7.1,3.9-11,1.4c-1.5-1-2.5-2.6-2.7-4.5   c-0.1-0.6,0-1.1,0-1.6c0.4-2.5,1.9-11,5.1-16.7c0.3-0.5,0.5-0.9,0.7-1.4c2.1-4.6,2.6-9.4,2.6-10.8c0-0.3,0-0.4,0-0.4   c0-13.8,11.2-25,25-25c6.7,0,12.9,2.6,17.7,7.3c4.7,4.7,7.3,10.9,7.3,17.5l0.1,0.6c0.8,4.9,1.8,9,2.7,10.9c0.2,0.3,0.3,0.6,0.4,0.7   c1.8,2.4,3.7,10.1,5.1,16.2v0c0.3,1.3,0.3,2.7,0,4c-0.2,0.9-0.5,1.4-0.9,1.8c-1.6,1.8-5.9,3.8-12.1,0.2c-2.8-1.6-5.5-0.5-9.6,1.4   C57.4,80.3,53.9,81.9,49.8,81.9C49.8,81.9,49.8,81.9,49.8,81.9z M32,72.1c2.7,0,5.7,1.4,8.4,2.8c3.1,1.5,6.3,3.1,9.5,3.1   c0,0,0,0,0,0c3.2,0,6.1-1.4,8.9-2.7c4.2-2,8.6-4.1,13.4-1.3c4.5,2.6,6.6,1.1,7.1,0.6c0.1-0.7,0.1-1.4,0-2.2l0,0   c-1.7-7.6-3.4-13.3-4.4-14.7c-0.3-0.4-0.5-0.8-0.8-1.4c-1.5-3.1-2.5-8.9-3-12l-0.1-0.8c0-0.1,0-0.2,0-0.3c0-5.6-2.2-10.9-6.2-14.8   c-4-4-9.2-6.1-14.8-6.1c-11.6,0-21,9.4-21,21c0,0,0,0.2,0,0.6c-0.1,2-0.6,7.2-3,12.2c-0.3,0.6-0.6,1.2-0.8,1.7   C22,62.9,20.6,71.3,20.3,73c0,0.2,0,0.3,0,0.5c0.1,0.7,0.4,1.2,1,1.6c2.9,1.9,4.7,0.5,5.8-0.8C28.5,72.7,30.2,72.1,32,72.1z    M46,48.4c-0.5,0-1-0.2-1.4-0.6c0,0-1.3-1.1-4-1c-3,0.1-4.4,1.1-4.4,1.1c-0.6,0.4-1.4,0.5-2.1,0.2c-0.7-0.3-1.1-1-1.1-1.8v-5.3   c0-4.1,3.4-7.5,7.5-7.5c2,0,3.9,0.8,5.3,2.2c1.4,1.4,2.2,3.3,2.2,5.3v5.3c0,0.8-0.5,1.5-1.2,1.8C46.5,48.4,46.2,48.4,46,48.4z    M40.5,37.6c-1.9,0-3.5,1.6-3.5,3.5v2.3c0.9-0.2,2.1-0.4,3.4-0.5c1.4-0.1,2.6,0.1,3.6,0.4v-2.2c0-0.9-0.4-1.8-1-2.5   C42.3,37.9,41.4,37.6,40.5,37.6z M64.8,48.4c-0.5,0-1-0.2-1.4-0.6c0,0-1.3-1.1-4-1C56.4,47,55,48,55,48c-0.6,0.4-1.4,0.5-2.1,0.2   c-0.7-0.3-1.1-1-1.1-1.8v-5.3c0-4.1,3.4-7.5,7.5-7.5c2,0,3.9,0.8,5.3,2.2c1.4,1.4,2.2,3.3,2.2,5.3v5.3c0,0.8-0.5,1.5-1.2,1.8   C65.3,48.4,65.1,48.4,64.8,48.4z M59.3,37.6c-1.9,0-3.5,1.6-3.5,3.5v2.3c0.9-0.2,2.1-0.4,3.4-0.5c1.4-0.1,2.6,0.1,3.6,0.4v-2.2   c0-0.9-0.4-1.8-1-2.5C61.1,37.9,60.2,37.6,59.3,37.6z M49.8,66.5c-3.3,0-6-3.2-6-7.1s2.7-7.1,6-7.1c3.3,0,6,3.2,6,7.1   S53.1,66.5,49.8,66.5z M49.8,56.3c-0.9,0-2,1.3-2,3.1s1,3.1,2,3.1c0.9,0,2-1.3,2-3.1S50.7,56.3,49.8,56.3z M24,57.1   c-0.5,0-1-0.2-1.4-0.6l-6.1-6.1c-2.8-2.8-2.8-7.2,0-10c1.3-1.3,3.1-2.1,5-2.1s3.6,0.7,5,2.1l1.8,1.8c0.4,0.4,0.6,1,0.6,1.5   c-0.1,2-0.6,7.1-3,12.2c-0.3,0.6-0.8,1-1.5,1.1C24.2,57.1,24.1,57.1,24,57.1z M21.5,42.4c-0.8,0-1.6,0.3-2.2,0.9   c-1.2,1.2-1.2,3.1,0,4.3l4,4c1-2.9,1.3-5.6,1.5-7.2l-1.1-1.1C23,42.7,22.3,42.4,21.5,42.4z M75.8,57.3c-0.1,0-0.2,0-0.3,0   c-0.6-0.1-1.2-0.5-1.5-1.1c-1.5-3.1-2.5-8.9-3-12c-0.1-0.6,0.1-1.3,0.6-1.7l2-2c1.3-1.3,3.1-2.1,5-2.1s3.7,0.7,5,2.1   c2.8,2.8,2.8,7.2,0,10l-6.3,6.4C76.8,57.1,76.3,57.3,75.8,57.3z M75.1,44.6c0.5,2.8,1,5.2,1.5,7.1l4.1-4.1c0,0,0,0,0,0   c1.2-1.2,1.2-3.1,0-4.3c-1.2-1.2-3.2-1.2-4.3,0L75.1,44.6z"/>
</g>
<g id="_x31_1"/>
<g id="_x31_2"/>
<g id="_x31_3"/>
<g id="_x31_4"/>
<g id="_x31_5"/>
<g id="_x31_6"/>
<g id="_x31_7"/>
<g id="_x31_8"/>
<g id="_x31_9"/>
<g id="_x32_0"/>
<g id="_x32_1"/>
<g id="_x32_2"/>
<g id="_x32_3"/>
</svg>
</file>

<file path="static/halloween/heart.svg">
<?xml version="1.0" encoding="utf-8"?><!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg fill="#000000" width="800px" height="800px" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg" id="memory-heart"><path d="M12 20H10V19H9V18H8V17H7V16H6V15H5V14H4V13H3V12H2V10H1V5H2V4H3V3H4V2H9V3H10V4H12V3H13V2H18V3H19V4H20V5H21V10H20V12H19V13H18V14H17V15H16V16H15V17H14V18H13V19H12V20M5 11V12H6V13H7V14H8V15H9V16H10V17H12V16H13V15H14V14H15V13H16V12H17V11H18V9H19V6H18V5H17V4H14V5H13V6H12V7H10V6H9V5H8V4H5V5H4V6H3V9H4V11H5Z" /></svg>
</file>

<file path="static/halloween/pumpkin.svg">
<?xml version="1.0" encoding="utf-8"?><!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg fill="#000000" width="800px" height="800px" viewBox="0 0 14 14" role="img" focusable="false" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><path d="m 8.0382,2.785973 c -6e-4,0 -8e-4,-2e-4 -0.0012,-4e-4 -0.305,-0.0834 -0.18,-0.5158 0.319,-1.023 l -0.0018,-10e-4 c 0.0782,-0.0966 -0.1008,-0.3068 -0.4374,-0.498 -0.3708,-0.2106 -0.7894,-0.31680002 -0.9344,-0.237 -0.0072,0.0042 -0.01,0.0102 -0.0154,0.0144 l -0.003,-0.0014 c -0.7486,0.6312 -0.886,1.5444 -0.9088,1.7672 C 3.3886,2.393373 1,4.407773 1,8.113173 c 0,3.2148 4.1868,4.8868 6,4.8868 1.8132,0 6,-1.672 6,-4.8868 0,-3.6468 -2.1214,-5.7854 -4.9618,-5.3272 m 1.0586,3.7282 c 0.2258,-0.0726 2.448,-1.0888 2.448,-0.7904 0,0.351 -1.2172,2.1728 -2.1234,2.4552 -0.2872,0.0894 -1.3774,-0.7804 -1.1632,-1.8376 0.0544,-0.267 0.529,0.2728 0.8386,0.1728 m -1.4222,-4.8246 c 0.1304,0.0532 0.2562,0.0902 0.3652,0.11 -0.2622,0.3606 -0.4438,0.8748 -0.2926,1.013 0.186,0.1698 0.575,0.3882 0.6914,0.4788 0.116,0.0904 -0.5472,0.1128 -0.8188,0.3958 2e-4,2e-4 -0.6714,-1.1174 0.0548,-1.9976 M 7,7.246373 c 0.2344,0 1.1426,0.409 1.1426,1.0864 0,0.6776 -0.5114,0.0686 -1.1426,0.0686 -0.6308,0 -1.1422,0.609 -1.1422,-0.0686 0,-0.6774 0.9078,-1.0864 1.1422,-1.0864 m -0.9476,-4.3204 c 0.0598,0.417 -0.352,0.773 -0.352,0.773 -0.007,-0.2728 -0.2722,-0.4366 -0.2722,-0.4366 0.1846,-0.1964 0.6242,-0.3364 0.6242,-0.3364 m -1.1488,3.5882 c 0.3098,0.1 0.7844,-0.4398 0.8382,-0.1728 0.214,1.0572 -0.8762,1.9272 -1.1628,1.8376 -0.9064,-0.2824 -2.1232,-2.1042 -2.1232,-2.4552 0,-0.2984 2.222,0.7178 2.4478,0.7904 m 6.1664,3.8782 -0.6984,-0.3958 -0.4442,1.1374 -0.73,-0.7166 -0.5714,1.3594 -1.4918,-1.063 -0.7618,0.915 -0.825,-0.964 -1.2696,0.4694 -0.739,-1.3026 -0.9532,0.4224 -0.6246,-2.556 0.9582,1.5996 0.9332,-0.4942 0.584,1.1192 1.05,-0.6082 0.8566,1.1538 0.807,-1.1044 0.9878,0.7418 0.6032,-0.8668 0.9286,0.4986 0.5512,-1.0326 0.6504,0.6758 1.4684,-1.6824 -1.2696,2.6942"/></svg>
</file>

<file path="static/halloween/spider.svg">
<?xml version="1.0" encoding="iso-8859-1"?>
<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg fill="#000000" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
	 width="800px" height="800px" viewBox="0 0 593.795 593.795"
	 xml:space="preserve">
<g>
	<g>
		<path d="M593.17,307.39c-43.758-76.194-146.268-75.888-195.228-6.426c-27.54-41.004-82.927-55.08-134.028-43.452
			c-3.978,0.918-5.202,4.284-4.284,7.038c-40.086,5.813-77.418,25.397-98.838,55.998v-0.306
			c-39.168-57.223-137.394-76.5-160.65,4.59c-1.224,4.59,5.814,7.956,7.956,3.366c30.294-70.074,105.876-55.998,147.492-3.979
			c0.612,0.612,1.224,0.918,2.142,1.225c-7.344,11.628-12.546,24.785-14.994,39.474C72.664,324.832-44.228,408.981,17.89,483.034
			c3.06,3.672,9.486-1.225,6.732-5.202c-47.43-70.38,50.49-139.842,115.056-107.101c0.918,0.307,1.53,0.307,2.448,0.307
			c-0.612,7.038-0.918,14.382-0.306,22.032c0.306,5.201,1.224,10.403,2.448,14.993c-62.73-17.441-110.772,84.763-46.512,112.914
			c5.202,2.143,9.18-4.283,4.284-7.344c-48.654-32.742-11.016-111.996,44.37-97.308c20.196,59.976,96.39,82.62,155.754,72.521
			c47.43-7.956,86.598-36.414,104.04-76.5c19.278-8.262,38.862,13.464,48.654,30.294c15.605,26.316,18.666,59.059-1.53,83.845
			c-3.979,4.896,2.142,11.016,7.038,7.037c48.348-39.168-7.956-143.514-50.796-130.355c4.896-14.688,7.344-30.6,6.12-47.43
			c27.846-14.688,55.386-22.95,85.985-7.65c30.906,15.606,48.042,51.102,63.342,80.172c2.143,4.284,9.181,1.224,7.65-3.366
			c-25.704-71.298-91.8-123.317-157.896-78.336l0,0c-2.143-15.3-6.732-28.458-13.465-39.779
			c55.692-62.73,132.498-62.118,184.213,5.201C588.886,316.264,595.924,312.592,593.17,307.39z M402.838,355.432
			c-0.611,0.612-1.53,1.225-2.142,1.836c-2.143,2.143,0.306,5.509,2.754,4.591c2.448,57.222-42.534,100.367-96.696,112.607
			c-64.872,14.382-146.88-13.464-153-87.822c-5.814-69.155,62.73-105.876,121.176-114.444c2.142-0.306,3.06-2.142,3.06-3.978
			c59.67-7.344,115.668,17.748,124.542,83.844C402.838,353.29,402.838,354.514,402.838,355.432z"/>
		<path d="M254.734,334.93c-10.71-15.912-36.108-24.479-53.856-17.136c-4.896,2.142-1.836,8.874,2.448,9.18
			c14.688,0.612,26.928-0.306,38.862,10.099c13.464,11.934,8.568,27.846-1.53,39.474c-13.77-14.076-26.622-29.07-39.474-44.063
			c-2.142-2.448-6.426,0.918-4.59,3.672c12.24,18.054,25.092,36.414,40.392,52.02c2.142,2.142,5.508,1.836,7.65,0
			C259.936,373.792,267.586,353.596,254.734,334.93z"/>
		<path d="M369.178,334.624c-14.994-18.054-37.332-23.256-55.691-7.344c-16.83,14.382-18.36,41.922-5.509,59.058
			c1.53,1.836,3.673,2.142,5.202,1.224c1.225,0.918,2.754,1.225,4.591,0.307c10.403-4.59,19.584-11.935,27.846-19.278
			c6.12-5.508,14.382-11.934,15.912-20.502c0.918-4.59-4.284-7.956-7.956-4.59c-5.814,5.508-10.099,11.934-15.606,17.442
			c-7.344,7.344-15.3,14.075-24.174,19.277c-6.732-14.994-6.12-31.518,5.814-43.758c13.464-14.076,30.6-6.732,41.615,6.12
			C365.812,348.088,373.769,340.132,369.178,334.624z"/>
		<path d="M283.804,63.202c-1.836-7.345-13.158-4.284-11.628,3.06c7.65,36.414,8.568,71.91,6.426,108.63
			c-1.224,25.092-8.874,52.938-3.366,77.418c0.612,2.143,3.978,2.754,4.896,0.612c10.098-23.562,9.18-52.632,11.016-78.03
			C294.208,137.56,293.29,99.616,283.804,63.202z"/>
	</g>
</g>
</svg>
</file>

<file path="static/halloween/web.svg">
<?xml version="1.0" encoding="iso-8859-1"?>
<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg fill="#000000" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
	 width="800px" height="800px" viewBox="0 0 227.195 227.194"
	 xml:space="preserve">
<g>
	<path d="M224.464,167.01c-4.633-4.355-9.263-8.445-13.858-12.292c-21.388-45.57-30.13-79.575-33.684-100.351
		c-2.246-13.135-2.751-22.712-2.761-28.599c3.59-4.439,7.278-8.726,11.045-12.753c2.915-3.121,2.748-8.017-0.372-10.933
		c-3.121-2.917-8.016-2.75-10.933,0.371c-4.088,4.375-8.078,9.009-11.94,13.786c-15.2,7.864-31.321,11.86-48.001,11.86
		c-21.04,0-37.942-6.425-46.051-10.197c-4.084-5.09-8.31-10.025-12.649-14.671c-2.916-3.121-7.811-3.287-10.933-0.371
		c-3.12,2.917-3.287,7.812-0.369,10.932c3.568,3.819,7.069,7.874,10.481,12.066c-2.428,28.912-11.73,47.438-19.392,58.095
		c-5.679,7.896-11.26,12.683-14.558,15.115c-4.7,0.798-9.382,1.75-13.994,2.895c-4.146,1.027-6.675,5.222-5.646,9.368
		c0.872,3.521,4.028,5.875,7.5,5.875c0.617,0,1.242-0.073,1.868-0.229c4.229-1.048,8.542-1.926,12.887-2.658
		c14.742,11.492,25.92,26.818,33.27,45.671c3.843,9.854,5.693,18.449,6.557,23.675c-4.89,11.489-9.014,23.104-11.571,34.029
		c-0.974,4.16,1.608,8.321,5.769,9.294c0.593,0.139,1.185,0.205,1.77,0.205c3.511,0,6.688-2.407,7.524-5.974
		c2.439-10.422,6.507-21.675,11.354-32.87c29.565-20.754,63.903-25.274,88.18-25.274c17.821,0,31.978,2.399,38.076,3.632
		c3.735,3.182,7.49,6.533,11.245,10.065c1.295,1.218,2.946,1.821,4.592,1.821c1.786,0,3.566-0.708,4.886-2.111
		C227.29,173.788,227.16,169.547,224.464,167.01z M193.2,141.141c-9.743-7.073-19.106-13.031-27.73-18.009
		c-17.831-29.35-20.405-47.272-20.129-55.991c5.648-9.2,12.086-19.041,19.065-28.63C166.143,58.583,172.521,92.867,193.2,141.141z
		 M103.091,69.875c3.534,0.805,7.525,1.345,11.89,1.345c3.503,0,6.992-0.348,10.454-1.03c-4.43,7.615-8.171,14.448-11.061,19.908
		C111.406,84.507,107.59,77.569,103.091,69.875z M100.404,96.848c-0.324,0.077-0.642,0.172-0.947,0.295
		c-5.041-0.472-11.037-0.924-17.725-1.227c3.249-4.231,6.453-9.732,8.818-16.733C94.424,85.847,97.747,91.875,100.404,96.848z
		 M101.244,112.897c-2.794,4.35-6.248,9.865-10.044,16.213c-1.793-5.493-4.65-11.705-9.19-17.635
		C89.505,111.831,96.082,112.374,101.244,112.897z M117.197,116.768l0.774-1.344c5.243,1.938,11.469,4.459,18.435,7.686
		c1.236,0.572,2.512,1.176,3.824,1.81c-9.078,0.103-20.181,1.216-31.247,4.798C112.271,124.383,115.111,119.955,117.197,116.768z
		 M141.608,110.743c-6.235-2.876-11.897-5.215-16.842-7.099l0.173-0.3c2.579-5.014,6.543-12.494,11.585-21.315
		c2.045,9.705,6.077,20.42,12.036,32.042C146.133,112.87,143.807,111.759,141.608,110.743z M113.96,38.413
		c12.174,0,24.062-1.931,35.555-5.741c-5.834,8.176-11.241,16.413-16.101,24.242c-6.069,2.649-12.249,3.992-18.435,3.992
		c-9.472,0-16.813-3.174-20.413-5.107c-4.572-7.295-9.606-14.909-15.002-22.466C88.85,36.103,100.596,38.413,113.96,38.413z
		 M42.979,90.582c7.598-10.387,16.621-27.488,20.477-53.07c7.167,9.718,13.786,19.751,19.603,29.165
		c-2.633,15.834-10.117,24.66-15.016,28.884c-9.41-0.062-19.618,0.263-30.05,1.236C39.62,94.946,41.296,92.883,42.979,90.582z
		 M66.122,156.603c-4.931-12.754-13.805-29.564-29.338-44.118c10.607-1.093,21.095-1.455,30.753-1.397
		c12.119,10.454,15.277,24.435,16.101,31.063c-4.528,8.05-9.222,16.867-13.645,26.015C68.979,164.604,67.711,160.712,66.122,156.603
		z M165.956,152.765c-22.128,0-52.158,3.58-80.286,18.651c4.701-9.457,9.66-18.525,14.33-26.632
		c13.871-7.76,29.838-9.561,41.645-9.561c10.112,0,18.137,1.303,21.104,1.859c7.902,4.726,16.383,10.289,25.159,16.802
		C181.59,153.238,174.166,152.765,165.956,152.765z"/>
</g>
</svg>
</file>

<file path="static/logo.svg">
<svg xmlns="http://www.w3.org/2000/svg" version="1.0" preserveAspectRatio="xMidYMid meet" viewBox="279 219.05 451.5 585.42">

<g transform="translate(0.000000,1024.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none">
<path d="M4104 8019 c-181 -115 -366 -319 -432 -476 -33 -78 -71 -245 -84 -371 l-12 -114 -70 -107 c-221 -335 -326 -700 -326 -1127 l0 -165 -66 -75 c-36 -42 -96 -121 -132 -177 -67 -103 -192 -338 -192 -362 0 -15 161 -142 280 -222 101 -67 252 -157 380 -226 58 -31 115 -67 127 -79 24 -26 491 -736 516 -783 8 -17 68 -114 133 -215 65 -102 226 -365 359 -585 403 -667 434 -716 471 -731 23 -10 41 -11 57 -5 34 13 98 96 187 242 41 68 177 277 301 464 124 187 301 457 394 600 92 143 218 337 280 430 61 94 131 202 155 242 38 61 52 75 95 94 70 31 349 312 480 484 54 72 134 176 177 232 115 149 123 171 123 323 l0 125 -55 90 c-30 50 -87 125 -127 167 l-73 77 0 89 c0 272 -94 641 -232 915 -304 599 -855 980 -1517 1047 -196 19 -389 6 -591 -41 -163 -38 -146 -41 -257 47 -54 42 -130 110 -170 151 -84 85 -103 90 -179 42z m107 -155 c104 -108 526 -411 545 -391 3 3 0 40 -7 82 -7 47 -8 80 -3 85 6 6 55 15 111 22 l102 12 113 -105 c448 -412 752 -711 1302 -1279 649 -673 727 -757 770 -835 46 -84 55 -148 32 -227 -16 -55 -52 -109 -253 -373 -158 -207 -349 -407 -430 -449 -62 -31 -180 -49 -293 -43 -128 6 -550 93 -842 173 -108 30 -205 54 -214 54 -14 0 -14 -4 3 -33 11 -18 70 -102 132 -186 61 -85 114 -165 117 -178 12 -48 -121 -203 -244 -283 -197 -129 -418 -179 -803 -180 l-96 0 -272 413 c-149 228 -284 432 -301 455 -21 29 -51 52 -102 78 -182 91 -509 293 -612 377 l-29 23 58 105 c111 200 236 361 351 448 83 62 221 131 324 162 41 12 76 23 78 24 1 1 -11 61 -28 133 -16 71 -30 146 -30 164 0 46 45 90 92 90 20 0 115 -33 224 -77 306 -126 328 -134 401 -146 53 -9 100 -8 204 1 74 7 152 13 173 14 l40 1 133 -194 c73 -107 133 -200 133 -206 0 -15 -101 -158 -201 -285 -92 -118 -103 -141 -84 -177 8 -15 39 -80 68 -144 69 -149 128 -237 165 -245 15 -3 70 -17 122 -31 372 -97 547 -137 775 -178 221 -40 273 -47 345 -42 92 5 178 33 220 70 34 30 224 253 341 402 193 243 209 270 209 352 0 71 -30 120 -148 240 -59 60 -300 309 -537 553 -486 503 -781 800 -1036 1040 -342 323 -385 360 -413 360 -22 0 -25 -3 -16 -17 7 -15 179 -1008 197 -1144 l5 -37 -92 -7 c-51 -4 -156 -4 -235 0 -96 5 -145 4 -149 -4 -4 -5 14 -40 39 -76 25 -37 45 -70 45 -75 0 -24 -50 -34 -165 -35 -100 0 -132 4 -190 23 -270 90 -479 353 -575 727 -57 219 -66 367 -31 509 28 115 68 199 140 289 63 79 243 237 271 237 9 0 32 -16 51 -36z m1769 -2089 c432 -320 491 -367 477 -381 -5 -5 -114 -11 -242 -13 l-233 -3 -13 23 c-14 27 -169 466 -169 480 0 22 35 1 180 -106z"/>
<path d="M3840 6028 c-1 -40 145 -635 159 -650 9 -9 103 -66 210 -127 184 -105 197 -111 251 -111 107 0 217 75 263 179 26 60 29 198 5 253 -21 46 -91 123 -142 155 -37 24 -718 313 -737 313 -5 0 -9 -6 -9 -12z"/>
</g>
</svg>
</file>

<file path="static/protogen_pin.svg">
<svg xmlns="http://www.w3.org/2000/svg" version="1.0" preserveAspectRatio="xMidYMid meet" viewBox="279 219.05 451.5 585.42">

<g transform="translate(0.000000,1024.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none">
<path d="M4104 8019 c-181 -115 -366 -319 -432 -476 -33 -78 -71 -245 -84 -371 l-12 -114 -70 -107 c-221 -335 -326 -700 -326 -1127 l0 -165 -66 -75 c-36 -42 -96 -121 -132 -177 -67 -103 -192 -338 -192 -362 0 -15 161 -142 280 -222 101 -67 252 -157 380 -226 58 -31 115 -67 127 -79 24 -26 491 -736 516 -783 8 -17 68 -114 133 -215 65 -102 226 -365 359 -585 403 -667 434 -716 471 -731 23 -10 41 -11 57 -5 34 13 98 96 187 242 41 68 177 277 301 464 124 187 301 457 394 600 92 143 218 337 280 430 61 94 131 202 155 242 38 61 52 75 95 94 70 31 349 312 480 484 54 72 134 176 177 232 115 149 123 171 123 323 l0 125 -55 90 c-30 50 -87 125 -127 167 l-73 77 0 89 c0 272 -94 641 -232 915 -304 599 -855 980 -1517 1047 -196 19 -389 6 -591 -41 -163 -38 -146 -41 -257 47 -54 42 -130 110 -170 151 -84 85 -103 90 -179 42z m107 -155 c104 -108 526 -411 545 -391 3 3 0 40 -7 82 -7 47 -8 80 -3 85 6 6 55 15 111 22 l102 12 113 -105 c448 -412 752 -711 1302 -1279 649 -673 727 -757 770 -835 46 -84 55 -148 32 -227 -16 -55 -52 -109 -253 -373 -158 -207 -349 -407 -430 -449 -62 -31 -180 -49 -293 -43 -128 6 -550 93 -842 173 -108 30 -205 54 -214 54 -14 0 -14 -4 3 -33 11 -18 70 -102 132 -186 61 -85 114 -165 117 -178 12 -48 -121 -203 -244 -283 -197 -129 -418 -179 -803 -180 l-96 0 -272 413 c-149 228 -284 432 -301 455 -21 29 -51 52 -102 78 -182 91 -509 293 -612 377 l-29 23 58 105 c111 200 236 361 351 448 83 62 221 131 324 162 41 12 76 23 78 24 1 1 -11 61 -28 133 -16 71 -30 146 -30 164 0 46 45 90 92 90 20 0 115 -33 224 -77 306 -126 328 -134 401 -146 53 -9 100 -8 204 1 74 7 152 13 173 14 l40 1 133 -194 c73 -107 133 -200 133 -206 0 -15 -101 -158 -201 -285 -92 -118 -103 -141 -84 -177 8 -15 39 -80 68 -144 69 -149 128 -237 165 -245 15 -3 70 -17 122 -31 372 -97 547 -137 775 -178 221 -40 273 -47 345 -42 92 5 178 33 220 70 34 30 224 253 341 402 193 243 209 270 209 352 0 71 -30 120 -148 240 -59 60 -300 309 -537 553 -486 503 -781 800 -1036 1040 -342 323 -385 360 -413 360 -22 0 -25 -3 -16 -17 7 -15 179 -1008 197 -1144 l5 -37 -92 -7 c-51 -4 -156 -4 -235 0 -96 5 -145 4 -149 -4 -4 -5 14 -40 39 -76 25 -37 45 -70 45 -75 0 -24 -50 -34 -165 -35 -100 0 -132 4 -190 23 -270 90 -479 353 -575 727 -57 219 -66 367 -31 509 28 115 68 199 140 289 63 79 243 237 271 237 9 0 32 -16 51 -36z m1769 -2089 c432 -320 491 -367 477 -381 -5 -5 -114 -11 -242 -13 l-233 -3 -13 23 c-14 27 -169 466 -169 480 0 22 35 1 180 -106z"/>
<path d="M3840 6028 c-1 -40 145 -635 159 -650 9 -9 103 -66 210 -127 184 -105 197 -111 251 -111 107 0 217 75 263 179 26 60 29 198 5 253 -21 46 -91 123 -142 155 -37 24 -718 313 -737 313 -5 0 -9 -6 -9 -12z"/>
</g>
</svg>
</file>

<file path="src/lib/components/CookieBanner.svelte">
<script lang="ts">
    import { onMount } from 'svelte';
    import { fade } from 'svelte/transition';
    import { browser } from '$app/environment';
    import { t } from 'svelte-i18n';

    const COOKIE_CONSENT_KEY = 'protomap_cookie_consent';
    let showBanner = false;

    onMount(() => {
        const consentGiven = localStorage.getItem(COOKIE_CONSENT_KEY);
        if (!consentGiven) {
            showBanner = true;
        }
    });

    function acceptCookies() {
        if (browser) {
            localStorage.setItem(COOKIE_CONSENT_KEY, 'true');
        }
        showBanner = false;
    }
</script>

{#if showBanner}
    <div class="cookie-banner" transition:fade={{ duration: 300 }}>
        <p class="banner-text">
            {$t('cookie.text')} <a href="/privacy-policy">{$t('cookie.link')}</a>.
        </p>
        <button class="accept-btn font-display" on:click={acceptCookies}>
            {$t('cookie.accept')}
        </button>
    </div>
{/if}

<style>
    .cookie-banner {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        z-index: 100;

        max-width: 380px;
        padding: 1rem;

        display: flex;
        align-items: center;
        gap: 1rem;

        /* Используем наш любимый glass-эффект */
        background: rgba(20, 20, 25, 0.7);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: var(--border-radius, 8px);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    }

    .banner-text {
        font-size: 0.875rem; /* 14px */
        color: var(--text-muted-color, #909dab);
        line-height: 1.5;
    }

    .banner-text a {
        color: var(--cyber-yellow, #fcee0a);
        text-decoration: underline;
        transition: color 0.2s;
    }
    .banner-text a:hover {
        color: #fff;
    }

    .accept-btn {
        flex-shrink: 0;
        padding: 0.5rem 1rem;
        border: 1px solid var(--cyber-yellow, #fcee0a);
        color: var(--cyber-yellow, #fcee0a);
        background: transparent;
        border-radius: 4px;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.2s;
    }
    .accept-btn:hover {
        background: var(--cyber-yellow, #fcee0a);
        color: #111;
        box-shadow: 0 0 15px var(--cyber-yellow, #fcee0a);
    }

    @media (max-width: 640px) {
        .cookie-banner {
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 100%;
            border-radius: 0;
            padding: 0.75rem;
            gap: 0.5rem;
            flex-direction: column;
            align-items: stretch;
            text-align: center;
        }
        .accept-btn {
            padding: 0.75rem;
        }
    }
</style>
</file>

<file path="src/lib/components/SplashModal.svelte">
<script lang="ts">
    import { onMount } from 'svelte';
    import { fade, scale } from 'svelte/transition';
    import { t } from 'svelte-i18n';

    // 🔥 НОВЫЙ КЛЮЧ! Это сбросит просмотры у всех пользователей.
    const STORAGE_KEY = 'protomap_beta_announce_v1';

    let isVisible = false;

    onMount(() => {
        const hasSeenModal = localStorage.getItem(STORAGE_KEY);
        // Показываем, если ключа нет
        if (!hasSeenModal) {
            // Небольшая задержка для плавности появления после загрузки сайта
            setTimeout(() => {
                isVisible = true;
            }, 500);
        }
    });

    function closeModal() {
        isVisible = false;
        localStorage.setItem(STORAGE_KEY, 'true');
    }

    function goToBeta() {
        closeModal();
        window.location.href = '/mobile-beta';
    }
</script>

{#if isVisible}
    <div
        class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-md flex items-center justify-center p-4"
        transition:fade={{ duration: 300 }}
    >
        <div
            class="modal-container cyber-panel max-w-md w-full relative overflow-hidden"
            transition:scale={{ duration: 300, start: 0.9 }}
        >
            <!-- Полосы тревоги сверху -->
            <div class="hazard-stripe"></div>

            <div class="p-8 text-center relative z-10">

                <!-- Иконка -->
                <div class="icon-wrapper">
                    📣
                </div>

                <!-- Заголовок -->
                <h2 class="title font-display glitch" data-text={$t('splash_beta.title')}>
                    {$t('splash_beta.title')}
                </h2>

                <!-- Текст сообщения -->
                <!-- whitespace-pre-wrap сохраняет переносы строк из JSON -->
                <p class="message">
                    {@html $t('splash_beta.text')}
                </p>

                <!-- Кнопки -->
                <div class="actions">
                    <button class="action-btn" on:click={goToBeta}>
                        {$t('splash_beta.btn')}
                    </button>

                    <button class="close-text" on:click={closeModal}>
                        Остаться дезертиром (Закрыть)
                    </button>
                </div>
            </div>

            <!-- Угловые акценты -->
            <div class="corner bottom-left"></div>
            <div class="corner bottom-right"></div>
        </div>
    </div>
{/if}

<style>
    .modal-container {
        background: rgba(10, 10, 15, 0.95);
        border: 1px solid var(--cyber-yellow, #fcee0a);
        box-shadow: 0 0 40px rgba(252, 238, 10, 0.15);
    }

    /* Диагональные полосы сверху (Caution Tape) */
    .hazard-stripe {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 8px;
        background: repeating-linear-gradient(
            45deg,
            var(--cyber-yellow, #fcee0a),
            var(--cyber-yellow, #fcee0a) 10px,
            #000 10px,
            #000 20px
        );
        box-shadow: 0 5px 10px rgba(0,0,0,0.5);
    }

    .icon-wrapper {
        font-size: 3.5rem;
        margin-bottom: 1rem;
        animation: pulse-icon 1.5s infinite ease-in-out;
        filter: drop-shadow(0 0 10px rgba(252, 238, 10, 0.5));
    }

    .title {
        font-size: 1.8rem;
        color: var(--cyber-yellow, #fcee0a);
        margin-bottom: 1.5rem;
        text-shadow: 0 0 10px rgba(252, 238, 10, 0.5);
        line-height: 1.2;
    }

    .message {
        color: #d1d5db;
        font-size: 1rem;
        line-height: 1.6;
        margin-bottom: 2rem;
        white-space: pre-wrap; /* Важно для переносов строк */
    }

    /* Жирный текст внутри сообщения (если придет из JSON) */
    :global(.message strong) {
        color: #fff;
        font-weight: 800;
        text-shadow: 0 0 5px var(--cyber-yellow);
    }

    .actions {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        align-items: center;
    }

    .action-btn {
        width: 100%;
        padding: 1rem;
        background: var(--cyber-yellow, #fcee0a);
        color: #000;
        font-family: 'Chakra Petch', monospace;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        border: none;
        clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        transition: all 0.2s;
        cursor: pointer;
    }

    .action-btn:hover {
        background: #fff;
        box-shadow: 0 0 20px var(--cyber-yellow);
        transform: scale(1.02);
    }

    .close-text {
        font-size: 0.8rem;
        color: #666;
        text-decoration: underline;
        background: transparent;
        border: none;
        cursor: pointer;
        transition: color 0.2s;
    }
    .close-text:hover { color: #aaa; }

    /* Уголки снизу для стиля */
    .corner {
        position: absolute;
        width: 10px; height: 10px;
        border: 2px solid var(--cyber-yellow);
        opacity: 0.5;
    }
    .bottom-left { bottom: 5px; left: 5px; border-width: 0 0 2px 2px; }
    .bottom-right { bottom: 5px; right: 5px; border-width: 0 2px 2px 0; }

    /* Анимации */
    @keyframes pulse-icon {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }

    /* Глитч эффект для заголовка */
    .glitch { position: relative; }
    .glitch::before, .glitch::after {
        content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 10, 15, 0.95); overflow: hidden;
    }
    .glitch::before { text-shadow: -2px 0 #ff003c; animation: glitch-anim-1 2s infinite linear alternate-reverse; clip-path: inset(0 0 0 0); left: 2px; }
    .glitch::after { text-shadow: 2px 0 #00f0ff; animation: glitch-anim-2 3s infinite linear alternate-reverse; clip-path: inset(0 0 0 0); left: -2px; }

    @keyframes glitch-anim-1 {
        0% { clip-path: inset(20% 0 80% 0); } 20% { clip-path: inset(60% 0 10% 0); }
        40% { clip-path: inset(40% 0 50% 0); } 60% { clip-path: inset(80% 0 5% 0); }
        80% { clip-path: inset(10% 0 70% 0); } 100% { clip-path: inset(30% 0 20% 0); }
    }
    @keyframes glitch-anim-2 {
        0% { clip-path: inset(10% 0 60% 0); } 20% { clip-path: inset(30% 0 20% 0); }
        40% { clip-path: inset(70% 0 10% 0); } 60% { clip-path: inset(20% 0 50% 0); }
        80% { clip-path: inset(50% 0 30% 0); } 100% { clip-path: inset(0% 0 90% 0); }
    }
</style>
</file>

<file path="src/lib/components/WatermelonInteractive.svelte">
<script lang="ts">
    import { onMount, onDestroy, tick } from 'svelte';
    import { spring } from 'svelte/motion';
    import { fade, scale } from 'svelte/transition';
    import { elasticOut } from 'svelte/easing';

    // --- Настройки ---
    const CLICKS_TO_EXPLODE = 5;

    // --- Состояние ---
    let mounted = false;
    let clicks = 0;
    let isExploding = false;
    let screenShake = 0; // Интенсивность тряски экрана
    let flashOpacity = 0; // Белая вспышка

    // Позиция арбуза (используем spring для "прудинистости")
    const coords = spring({ x: 50, y: 50 }, {
        stiffness: 0.1,
        damping: 0.4
    });

    const rotation = spring(0, {
        stiffness: 0.1,
        damping: 0.6
    });

    const scaleSpring = spring(1, {
        stiffness: 0.2,
        damping: 0.3
    });

    // --- Система частиц ---
    type Particle = {
        id: number;
        x: number;
        y: number;
        vx: number;
        vy: number;
        rotation: number;
        vRotation: number;
        scale: number;
        emoji: string;
        life: number;
    };

    let particles: Particle[] = [];
    let shockwaves: { id: number, x: number, y: number }[] = [];
    let particleIdCounter = 0;
    let animationFrame: number;

    let moveInterval: any;

    onMount(() => {
        mounted = true;
        startFloating();
        loop(); // Запускаем цикл анимации частиц
    });

    onDestroy(() => {
        if (moveInterval) clearInterval(moveInterval);
        if (animationFrame) cancelAnimationFrame(animationFrame);
    });

    function startFloating() {
        moveInterval = setInterval(() => {
            if (clicks < CLICKS_TO_EXPLODE && !isExploding) {
                // Случайное перемещение
                coords.set({
                    x: Math.random() * 80 + 10,
                    y: Math.random() * 70 + 10
                });
                rotation.update(r => r + (Math.random() - 0.5) * 60);
            }
        }, 3000);
    }

    function loop() {
        // Обновляем физику частиц
        if (particles.length > 0) {
            particles = particles.filter(p => p.life > 0).map(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.5; // Гравитация
                p.rotation += p.vRotation;
                p.life -= 0.01;
                return p;
            });
        }

        // Затухание тряски экрана
        if (screenShake > 0) screenShake *= 0.9;
        if (screenShake < 0.5) screenShake = 0;

        // Затухание вспышки
        if (flashOpacity > 0) flashOpacity -= 0.05;

        animationFrame = requestAnimationFrame(loop);
    }

    async function handleClick(event: MouseEvent) {
        if (isExploding) return;

        clicks++;

        // Эффект нажатия
        scaleSpring.set(0.8).then(() => scaleSpring.set(1));
        rotation.update(r => r + 360);

        // Получаем точные координаты клика для эффектов
        const clientX = event.clientX;
        const clientY = event.clientY;

        if (clicks >= CLICKS_TO_EXPLODE) {
            triggerExplosion(clientX, clientY);
        } else {
            // Маленький эффект при обычном клике
            screenShake = 2 * clicks;
            spawnParticles(clientX, clientY, 3, ['💦', '✨']);
        }
    }

    function triggerExplosion(x: number, y: number) {
        isExploding = true;
        screenShake = 20; // Сильная тряска
        flashOpacity = 0.8; // Вспышка
        clicks = 0;

        // Создаем ударную волну
        shockwaves = [...shockwaves, { id: Date.now(), x, y }];
        setTimeout(() => shockwaves = [], 1000);

        // Спавним много частиц
        spawnParticles(x, y, 40, ['🍉', '🍉', '💔', '💥', '✨', '🔴', '🟩']);

        // Скрываем арбуз на время
        scaleSpring.set(0, { hard: true });

        // Возрождение арбуза
        setTimeout(() => {
            isExploding = false;
            scaleSpring.set(1);
            coords.set({ x: 50, y: 50 }); // Возврат в центр
        }, 2500);
    }

    function spawnParticles(x: number, y: number, count: number, emojis: string[]) {
        for (let i = 0; i < count; i++) {
            const angle = Math.random() * Math.PI * 2;
            const speed = Math.random() * 15 + 5; // Разная скорость

            particles.push({
                id: particleIdCounter++,
                x: x,
                y: y,
                vx: Math.cos(angle) * speed,
                vy: Math.sin(angle) * speed - 5, // Чуть вверх изначально
                rotation: Math.random() * 360,
                vRotation: (Math.random() - 0.5) * 20,
                scale: Math.random() * 0.8 + 0.5,
                emoji: emojis[Math.floor(Math.random() * emojis.length)],
                life: 1.0 + Math.random() // Случайное время жизни
            });
        }
        // Очистка массива частиц, если он стал слишком большим
        if (particles.length > 200) particles = particles.slice(-100);
    }
</script>

{#if mounted}
    <!-- Контейнер с эффектом тряски (Screen Shake) -->
    <div
        class="global-container"
        style="transform: translate({(Math.random() - 0.5) * screenShake}px, {(Math.random() - 0.5) * screenShake}px)"
    >
        <!-- Белая вспышка -->
        <div class="flash-overlay" style="opacity: {flashOpacity};"></div>

        <!-- Ударные волны -->
        {#each shockwaves as wave (wave.id)}
            <div
                class="shockwave"
                style="left: {wave.x}px; top: {wave.y}px;"
            ></div>
        {/each}

        <!-- Плавающий арбуз -->
        {#if !isExploding}
            <button
                class="watermelon-float"
                class:angry={clicks > 2}
                style="
                    left: {$coords.x}%;
                    top: {$coords.y}%;
                    transform: translate(-50%, -50%) rotate({$rotation}deg) scale({$scaleSpring});
                    --pulse-speed: {1 - (clicks * 0.15)}s;
                "
                on:click={handleClick}
                transition:scale
            >
                <div class="watermelon-emoji">🍉</div>

                {#if clicks > 0}
                    <div class="click-badge" transition:scale={{ duration: 200, easing: elasticOut }}>
                        {clicks}
                    </div>
                {/if}

                <!-- Аура ярости при приближении к взрыву -->
                {#if clicks >= 3}
                    <div class="rage-aura"></div>
                {/if}
            </button>
        {/if}

        <!-- Частицы (отрисовываем прямо в DOM для простоты) -->
        {#each particles as p (p.id)}
            <div
                class="particle"
                style="
                    left: {p.x}px;
                    top: {p.y}px;
                    transform: translate(-50%, -50%) rotate({p.rotation}deg) scale({p.scale});
                    opacity: {p.life};
                "
            >
                {p.emoji}
            </div>
        {/each}
    </div>
{/if}

<style>
    .global-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        pointer-events: none; /* Пропускает клики сквозь фон на элементы под ним */
        z-index: 50;
        overflow: hidden; /* Теперь частицы обрезаются здесь, а не на всей странице */
    }

    .flash-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        pointer-events: none;
        z-index: 100;
        mix-blend-mode: overlay;
    }

    .watermelon-float {
        position: absolute;
        width: 80px;
        height: 80px;
        background: none;
        border: none;
        cursor: pointer;
        pointer-events: auto;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 60;
        outline: none;
        /* Убираем дефолтное выделение на мобильных */
        -webkit-tap-highlight-color: transparent;
    }

    .watermelon-emoji {
        font-size: 70px;
        filter: drop-shadow(0 10px 15px rgba(0,0,0,0.3));
        transition: filter 0.2s;
    }

    .watermelon-float:hover .watermelon-emoji {
        filter: drop-shadow(0 15px 25px rgba(255, 50, 50, 0.5));
    }

    /* Анимация "злости" перед взрывом */
    .watermelon-float.angry .watermelon-emoji {
        animation: shake var(--pulse-speed) infinite;
    }

    .rage-aura {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 100%;
        height: 100%;
        transform: translate(-50%, -50%);
        border-radius: 50%;
        box-shadow: 0 0 30px 10px rgba(255, 0, 0, 0.6);
        animation: pulse-red 0.5s infinite alternate;
        z-index: -1;
    }

    .click-badge {
        position: absolute;
        top: 0;
        right: 0;
        background: linear-gradient(135deg, #ff4757, #ff6b81);
        color: white;
        font-family: system-ui, -apple-system, sans-serif;
        font-weight: 900;
        font-size: 18px;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .particle {
        position: absolute;
        font-size: 40px;
        pointer-events: none;
        z-index: 70;
        will-change: transform, opacity;
    }

    .shockwave {
        position: absolute;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        border: 5px solid rgba(255, 255, 255, 0.8);
        transform: translate(-50%, -50%);
        animation: shockwave-expand 0.6s ease-out forwards;
        z-index: 55;
        box-shadow: 0 0 20px rgba(255, 100, 100, 0.5);
    }

    @keyframes shake {
        0% { transform: rotate(0deg) scale(1); }
        25% { transform: rotate(-5deg) scale(1.05); }
        75% { transform: rotate(5deg) scale(1.05); }
        100% { transform: rotate(0deg) scale(1); }
    }

    @keyframes pulse-red {
        from { opacity: 0.3; transform: translate(-50%, -50%) scale(1); }
        to { opacity: 0.8; transform: translate(-50%, -50%) scale(1.3); }
    }

    @keyframes shockwave-expand {
        0% {
            width: 0;
            height: 0;
            opacity: 1;
            border-width: 50px;
        }
        100% {
            width: 100vmax; /* На весь экран */
            height: 100vmax;
            opacity: 0;
            border-width: 0;
        }
    }

    @keyframes pop-in {
        from { transform: scale(0); }
        to { transform: scale(1); }
    }
</style>
</file>

<file path="src/lib/firebase.ts">
import { initializeApp, getApps, getApp } from "firebase/app";
import { getAuth } from "firebase/auth";
import { getFirestore } from "firebase/firestore";
// 1. Импорты для защиты
import { initializeAppCheck, ReCaptchaEnterpriseProvider } from "firebase/app-check";
import { browser, dev } from '$app/environment';

const firebaseConfig = {
  apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
  authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
  projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
  storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
  appId: import.meta.env.VITE_FIREBASE_APP_ID,
  databaseURL: "https://protomap-1e1db-default-rtdb.europe-west1.firebasedatabase.app"
};

let app;
if (!getApps().length) {
    app = initializeApp(firebaseConfig);
} else {
    app = getApp();
}

export const auth = getAuth(app);
export const db = getFirestore(app);

// 2. Инициализация App Check (Только на клиенте)
if (browser) {
    // В режиме разработки (localhost) включаем дебаг-токен, чтобы тебя не банило
    // Firebase выведет этот токен в консоль браузера, его нужно будет добавить в Firebase Console
    if (dev) {
        (self as any).FIREBASE_APPCHECK_DEBUG_TOKEN = true;
    }

    try {
        initializeAppCheck(app, {
            // Твой Enterprise ключ
            provider: new ReCaptchaEnterpriseProvider('6LdUABssAAAAAPr3oiK3j525Wsb5_EjYvxFex13-'),

            // Автоматически обновлять токен в фоне
            isTokenAutoRefreshEnabled: true
        });
        console.log("[Security] App Check shield activated (Enterprise).");
    } catch (e) {
        console.error("[Security] App Check failed to load:", e);
    }
}
</file>

<file path="src/lib/i18n/index.ts">
import { register, init, getLocaleFromNavigator } from 'svelte-i18n';
import { browser } from '$app/environment';

// Регистрируем словари
register('ru', () => import('./locales/ru.json'));
register('en', () => import('./locales/en.json'));

// Определяем язык
const defaultLocale = 'ru';
let initialLocale = defaultLocale;

if (browser) {
    // 1. Сначала проверяем URL (это приоритет для ссылок из почты)
    const searchParams = new URLSearchParams(window.location.search);
    const urlLang = searchParams.get('lang');

    // 2. Затем LocalStorage
    const saved = localStorage.getItem('protomap_lang');

    // 3. Затем Браузер
    const navLang = getLocaleFromNavigator();

    if (urlLang && (urlLang === 'ru' || urlLang === 'en')) {
        initialLocale = urlLang;
        // Можно сразу сохранить, чтобы при переходе на главную язык остался
        localStorage.setItem('protomap_lang', urlLang);
    } else if (saved) {
        initialLocale = saved;
    } else if (navLang && navLang.startsWith('en')) {
        initialLocale = 'en';
    }
}

init({
    fallbackLocale: defaultLocale,
    initialLocale: initialLocale,
});
</file>

<file path="src/lib/stores/settingsStore.ts">
import { writable } from 'svelte/store';
import { browser } from '$app/environment';

const AUDIO_ENABLED_KEY = 'protomap_audio_enabled';
const CINEMATIC_LOADS_KEY = 'protomap_cinematic_loads_enabled';
const SEASONAL_ENABLED_KEY = 'protomap_seasonal_enabled';

type SettingsState = {
    audioEnabled: boolean;
    cinematicLoadsEnabled: boolean;
    seasonalEnabled: boolean;
};

function createSettingsStore() {
    let initialAudioState = true;
    let initialCinematicState = true;
    let initialSeasonalState = true;

    if (browser) {
        const savedAudio = localStorage.getItem(AUDIO_ENABLED_KEY);
        if (savedAudio !== null) initialAudioState = (savedAudio === 'true');

        const savedCinematic = localStorage.getItem(CINEMATIC_LOADS_KEY);
        if (savedCinematic !== null) initialCinematicState = (savedCinematic === 'true');

        const savedSeasonal = localStorage.getItem(SEASONAL_ENABLED_KEY);
        if (savedSeasonal !== null) initialSeasonalState = (savedSeasonal === 'true');
    }

    const { subscribe, set, update } = writable<SettingsState>({
        audioEnabled: initialAudioState,
        cinematicLoadsEnabled: initialCinematicState,
        seasonalEnabled: initialSeasonalState
    });

    subscribe(currentState => {
        if (browser) {
            localStorage.setItem(AUDIO_ENABLED_KEY, String(currentState.audioEnabled));
            localStorage.setItem(CINEMATIC_LOADS_KEY, String(currentState.cinematicLoadsEnabled));
            localStorage.setItem(SEASONAL_ENABLED_KEY, String(currentState.seasonalEnabled));
        }
    });

    return {
        subscribe,
        set,
        update,
        toggleAudio: () => update(state => ({ ...state, audioEnabled: !state.audioEnabled })),
        toggleCinematicLoads: () => update(state => ({ ...state, cinematicLoadsEnabled: !state.cinematicLoadsEnabled })),
        toggleSeasonal: () => update(state => ({ ...state, seasonalEnabled: !state.seasonalEnabled })),
    };
}

export const settingsStore = createSettingsStore();
</file>

<file path="src/routes/admin/+page.svelte">
<script lang="ts">
    import { onMount } from 'svelte';
    import { tweened } from 'svelte/motion';
    import { cubicOut } from 'svelte/easing';
    import type { PageData } from './$types';

    export let data: PageData;

    // Анимированные значения
    const animatedBank = tweened(0, { duration: 2000, easing: cubicOut });
    const animatedUsers = tweened(0, { duration: 1500, easing: cubicOut });

    onMount(() => {
        animatedBank.set(data.bankBalance);
        animatedUsers.set(data.totalUsers);
    });

    // Логи можно оставить фейковыми или прикрутить реальные, если есть коллекция логов
    const logs = [
        { type: 'info', text: "Система охлаждения: НОРМА" },
        { type: 'warn', text: "Нагрузка на ядро: 12%" },
        { type: 'success', text: "Банк успешно инициализирован." }
    ];
</script>

<svelte:head>
    <title>Dashboard | God Mode</title>
</svelte:head>

<div class="dashboard-header">
    <h2 class="page-title">SYSTEM_OVERVIEW</h2>
    <div class="date-badge">{new Date().toLocaleDateString()}</div>
</div>

<div class="dashboard-grid">

    <!-- STAT 1: USERS -->
    <div class="glass-card">
        <div class="card-icon text-green-400">👥</div>
        <div class="card-content">
            <div class="label">ПОЛЬЗОВАТЕЛИ</div>
            <div class="value">{Math.floor($animatedUsers)}</div>
        </div>
        <div class="decor-line green"></div>
    </div>

    <!-- STAT 2: BANKROLL -->
    <div class="glass-card">
        <div class="card-icon text-cyber-yellow">💰</div>
        <div class="card-content">
            <div class="label">КАЗНА (БАНК)</div>
            <div class="value">{Math.floor($animatedBank).toLocaleString()} PC</div>
        </div>
        <div class="decor-line yellow"></div>
    </div>

    <!-- STAT 3: HEALTH (Фейк для атмосферы) -->
    <div class="glass-card wide">
        <div class="card-header">
            <span class="label">SYSTEM_INTEGRITY</span>
            <span class="value-sm text-blue-400">100%</span>
        </div>
        <div class="progress-track">
            <div class="progress-fill" style="width: 100%; background: #3b82f6; box-shadow: 0 0 15px #3b82f6;"></div>
        </div>
    </div>

    <!-- LOGS -->
    <div class="glass-card col-span-full logs-panel">
        <div class="card-header mb-4">
            <span class="label">// SYSTEM_LOGS</span>
        </div>
        <div class="logs-container">
            {#each logs as log}
                <div class="log-row">
                    <span class="log-type {log.type}">[{log.type.toUpperCase()}]</span>
                    <span class="log-text">{log.text}</span>
                </div>
            {/each}
        </div>
    </div>

</div>

<!-- ... (стили те же) ... -->
<style>
/* ... копируй стили из прошлого ответа, они хорошие ... */
    .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
    .page-title { font-family: 'Chakra Petch', monospace; font-size: 1.5rem; font-weight: bold; color: #fff; letter-spacing: 0.1em; }
    .date-badge { background: rgba(255,255,255,0.05); padding: 0.5rem 1rem; border-radius: 8px; font-family: 'Chakra Petch', monospace; font-size: 0.8rem; color: #888; border: 1px solid rgba(255,255,255,0.1); }

    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
    }

    .glass-card {
        background: rgba(20, 25, 35, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 1rem;
        padding: 1.5rem;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .glass-card.wide { grid-column: span 2; }
    @media (max-width: 768px) { .glass-card.wide { grid-column: span 1; } }

    .card-icon { font-size: 2rem; margin-bottom: 0.5rem; }
    .label { font-family: 'Chakra Petch', monospace; font-size: 0.75rem; color: #64748b; font-weight: bold; letter-spacing: 0.1em; margin-bottom: 0.5rem; }
    .value { font-size: 2rem; font-weight: 800; color: #fff; letter-spacing: -0.02em; }
    .value-sm { font-size: 1.2rem; font-weight: bold; font-family: 'Chakra Petch', monospace; }

    .decor-line { position: absolute; bottom: 0; left: 0; height: 3px; width: 100%; opacity: 0.5; }
    .decor-line.green { background: #39ff14; box-shadow: 0 0 10px #39ff14; }
    .decor-line.yellow { background: #00f3ff; box-shadow: 0 0 10px #00f3ff; }

    .card-header { display: flex; justify-content: space-between; align-items: center; width: 100%; }

    /* PROGRESS BAR */
    .progress-track { width: 100%; height: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #ff003c, #ff5e00); box-shadow: 0 0 15px #ff003c; }

    /* LOGS */
    .col-span-full { grid-column: 1 / -1; }
    .logs-panel { min-height: 300px; justify-content: flex-start; }
    .logs-container { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; display: flex; flex-direction: column; gap: 0.8rem; }
    .log-row { display: flex; gap: 1rem; align-items: baseline; }
    .log-type { font-weight: bold; width: 80px; }
    .log-type.info { color: #00f3ff; }
    .log-type.warn { color: #ffd700; }
    .log-type.crit { color: #ff003c; }
    .log-type.success { color: #39ff14; }
    .log-text { color: #cbd5e1; }
</style>
</file>

<file path="src/routes/admin/news/+page.server.ts">
import { firestoreAdmin } from '$lib/server/firebase.admin';
import { error, fail, redirect } from '@sveltejs/kit';
import type { Actions, PageServerLoad } from './$types';
import { FieldValue } from 'firebase-admin/firestore';
import { ADMIN_UIDS } from '$env/static/private';

const adminList = ADMIN_UIDS ? ADMIN_UIDS.split(',') : [];

export const load: PageServerLoad = async ({ locals }) => {
    if (!locals.user) {
        throw redirect(303, '/login');
    }

    if (!adminList.includes(locals.user.uid)) {
        throw error(403, 'Доступ запрещен. Вы не обладаете правами администратора.');
    }

    return {
        user: locals.user
    };
};

export const actions: Actions = {
    create: async ({ request, locals }) => {
        if (!locals.user || !adminList.includes(locals.user.uid)) {
            return fail(403, { message: 'Нет прав' });
        }

        const data = await request.formData();
        const title = data.get('title') as string;
        const content = data.get('content') as string;
        const imageUrl = data.get('imageUrl') as string;
        const tagsString = data.get('tags') as string;
        const lang = (data.get('lang') as string) || 'ru';

        if (!title || !content) {
            return fail(400, { message: 'Заголовок и текст обязательны', title, content, imageUrl, tagsString });
        }

        try {
            const tags = tagsString
                ? tagsString.split(',').map(t => t.trim()).filter(t => t.length > 0)
                : [];

            await firestoreAdmin.collection('news').add({
                title,
                content,
                image: imageUrl || null,
                tags,
                lang,
                createdAt: FieldValue.serverTimestamp(),
                authorId: locals.user.uid,
                authorName: locals.user.username
            });

            return { success: true };

        } catch (err) {
            console.error('Ошибка публикации новости:', err);
            return fail(500, { message: 'Ошибка сервера при сохранении' });
        }
    }
};
</file>

<file path="src/routes/admin/users/+page.svelte">
<script lang="ts">
    import { enhance } from '$app/forms';
    import { modal } from '$lib/stores/modalStore';
    import type { ActionData } from './$types';
    import { slide, fade, fly, scale } from 'svelte/transition';
    import { quintOut } from 'svelte/easing';

    export let form: ActionData;

    let isSearching = false;
    let targetUser: any = null;
    let candidates: any[] = [];
    let showMigrationModal = false;

    $: if (form) {
        if (form.target) {
            targetUser = form.target;
            candidates = [];
            isSearching = false;
        } else if (form.candidates) {
            candidates = form.candidates;
            targetUser = null;
            isSearching = false;
        } else if (form.message) {
            if (!form.actionSuccess) {
                modal.error("ОШИБКА СИСТЕМЫ", form.message);
                isSearching = false;
            } else {
                modal.success("ПРОТОКОЛ ВЫПОЛНЕН", form.message);
                if (form.message.includes('ИЗОЛИРОВАН') && targetUser) targetUser.isBanned = true;
                if (form.message.includes('ВОССТАНОВЛЕН') && targetUser) targetUser.isBanned = false;
                if (form.message.includes('Баланс') && targetUser) {
                    const match = form.message.match(/([+-]?\d+)/);
                    if (match) {
                        targetUser.casino_credits += parseInt(match[0]);
                    }
                }
            }
        }
    }

    function selectCandidate(username: string) {
        const input = document.querySelector('input[name="query"]') as HTMLInputElement;
        if (input) {
            input.value = username;
            const formElement = input.closest('form');
            formElement?.requestSubmit();
        }
    }
</script>

<svelte:head>
    <title>Subjects Control | Overlord</title>
</svelte:head>

<div class="users-wrapper" in:fade={{duration: 500}}>

    <header class="page-header">
        <h2 class="text-3xl font-bold text-white font-display tracking-widest mb-2">БАЗА ДАННЫХ СУБЪЕКТОВ</h2>
        <p class="text-gray-500 font-mono text-sm">/// ACCESS LEVEL: UNLIMITED</p>
    </header>

    <div class="actions-header flex justify-end mb-4">
        <button class="migration-btn" on:click={() => showMigrationModal = true}>
            ⚠️ MIGRATION PROTOCOL
        </button>
    </div>

    <div class="search-module cyber-glass">
        <form
            method="POST"
            action="?/search"
            use:enhance={() => {
                isSearching = true;
                targetUser = null;
                return async ({ update }) => { await update(); };
            }}
            class="search-form"
        >
            <div class="input-wrapper">
                <span class="search-icon">🔍</span>
                <input type="text" name="query" placeholder="Идентификатор субъекта (username)..." class="clean-input" autocomplete="off"/>
            </div>
            <button type="submit" class="scan-btn" disabled={isSearching}>
                {isSearching ? 'СКАНИРОВАНИЕ...' : 'НАЙТИ СУБЪЕКТА'}
            </button>
        </form>
    </div>

    {#if candidates.length > 0}
        <div class="candidates-list cyber-glass" transition:slide>
            <h3 class="list-title">ОБНАРУЖЕНО СОВПАДЕНИЙ: {candidates.length}</h3>
            <div class="list-grid">
                {#each candidates as user}
                    <button class="candidate-card" on:click={() => selectCandidate(user.username)}>
                        <img src={user.avatar_url || '/casino/orioncasino.png'} alt="Avatar" class="mini-avatar" />
                        <span class="candidate-name">{user.username}</span>
                    </button>
                {/each}
            </div>
        </div>
    {/if}

    {#if targetUser}
        <div class="dossier-card cyber-glass" in:fly={{y: 50, duration: 600, easing: quintOut}}>
            <div class="corner tl"></div><div class="corner tr"></div>
            <div class="corner bl"></div><div class="corner br"></div>
            <div class="scan-line"></div>

            <div class="dossier-grid">
                <div class="profile-visual">
                    <div class="avatar-frame">
                        <img src={targetUser.avatar_url || '/casino/orioncasino.png'} alt="Subject" class="subject-img" />
                    </div>
                    {#if targetUser.isBanned}
                        <div class="status-badge banned">ЗАБЛОКИРОВАН</div>
                    {:else}
                        <div class="status-badge active">АКТИВЕН</div>
                    {/if}
                </div>

                <div class="profile-data">
                    <h3 class="subject-name">{targetUser.username}</h3>
                    <div class="meta-row">
                        <span class="meta-label">UID:</span>
                        <span class="meta-value font-mono">{targetUser.uid}</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-label">EMAIL:</span>
                        <span class="meta-value">{targetUser.email}</span>
                    </div>

                    <div class="stats-row">
                        <div class="stat-pill yellow">
                            <span class="label">БАЛАНС</span>
                            <span class="val">{targetUser.casino_credits} PC</span>
                        </div>
                        <div class="stat-pill blue">
                            <span class="label">ПРЕДМЕТЫ</span>
                            <span class="val">{targetUser.owned_items.length}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="control-panel">

                <div class="control-section">
                    <h4 class="section-title text-green-400">// ИНЪЕКЦИЯ СРЕДСТВ</h4>
                    <form method="POST" action="?/modifyCredits" use:enhance class="btn-grid">
                        <input type="hidden" name="uid" value={targetUser.uid} />
                        <button name="amount" value="1000" class="cmd-btn green">+1K</button>
                        <button name="amount" value="10000" class="cmd-btn green">+10K</button>
                        <button name="amount" value="100000" class="cmd-btn green">+100K</button>
                    </form>
                </div>

                <div class="control-section">
                    <h4 class="section-title text-red-500">// КАРАТЕЛЬНЫЕ МЕРЫ</h4>
                    <form method="POST" action="?/modifyCredits" use:enhance class="btn-grid">
                        <input type="hidden" name="uid" value={targetUser.uid} />
                        <button name="amount" value="-1000" class="cmd-btn red">-1K</button>
                        <button name="amount" value="-10000" class="cmd-btn red">-10K</button>
                        <button name="amount" value="-{targetUser.casino_credits}" class="cmd-btn red outlined">ОБНУЛИТЬ</button>
                    </form>
                </div>

                <div class="control-section full-width">
                    <h4 class="section-title text-purple-400">// ЛУТБОКСЫ</h4>
                    <form method="POST" action="?/grantAllItems" use:enhance>
                        <input type="hidden" name="uid" value={targetUser.uid} />
                        <button class="cmd-btn purple w-full">ВЫДАТЬ GOD PACK (ВСЕ ПРЕДМЕТЫ)</button>
                    </form>
                </div>

                <div class="control-section full-width">
                    <h4 class="section-title text-red-500">// ПРОТОКОЛЫ БЕЗОПАСНОСТИ</h4>

                    {#if targetUser.isBanned}
                        <form method="POST" action="?/unbanUser" use:enhance>
                            <input type="hidden" name="uid" value={targetUser.uid} />
                            <button class="cmd-btn green w-full">АМНИСТИЯ (РАЗБАНИТЬ)</button>
                        </form>
                    {:else}
                        <form method="POST" action="?/banUser" use:enhance class="ban-form">
                            <input type="hidden" name="uid" value={targetUser.uid} />
                            <input type="text" name="reason" placeholder="Причина бана..." class="reason-input" required />
                            <button class="cmd-btn red w-full">ЗАБЛОКИРОВАТЬ ДОСТУП</button>
                        </form>
                    {/if}
                </div>

            </div>
        </div>
    {/if}

    {#if showMigrationModal}
        <div class="modal-overlay" transition:fade>
            <div class="migration-panel cyber-glass" transition:scale>
                <h3 class="text-xl font-bold text-red-500 mb-4 font-display">/// ACCOUNT TRANSFER</h3>
                <p class="text-sm text-gray-400 mb-6">
                    Внимание! Эта операция перенесет баланс, предметы и метку со старого аккаунта на новый.
                    Старый аккаунт будет заблокирован. Действие необратимо.
                </p>

                <form method="POST" action="?/migrate" use:enhance={() => {
                    return async ({ update }) => {
                        await update();
                        showMigrationModal = false;
                    };
                }}>
                    <div class="input-group">
                        <label class="text-xs font-bold text-red-400">SOURCE UID (ОТКУДА ЗАБИРАЕМ)</label>
                        <input type="text" name="sourceUid" required class="cyber-input red" placeholder="Старый UID" />
                    </div>

                    <div class="icon-arrow">⬇️</div>

                    <div class="input-group">
                        <label class="text-xs font-bold text-green-400">TARGET UID (КУДА КЛАДЕМ)</label>
                        <input type="text" name="targetUid" required class="cyber-input green" placeholder="Новый UID" />
                    </div>

                    <div class="flex gap-3 mt-6">
                        <button type="button" class="cancel-btn" on:click={() => showMigrationModal = false}>ОТМЕНА</button>
                        <button type="submit" class="confirm-btn">ВЫПОЛНИТЬ ПЕРЕНОС</button>
                    </div>
                </form>
            </div>
        </div>
    {/if}
</div>

<style>
    .users-wrapper { max-width: 900px; margin: 0 auto; }
    .page-header { margin-bottom: 3rem; text-align: center; }

    .cyber-glass {
        background: rgba(20, 25, 35, 0.4);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        overflow: hidden;
        position: relative;
    }

    .search-module { padding: 1rem; display: flex; align-items: center; margin-bottom: 3rem; }
    .search-form { display: flex; width: 100%; gap: 1rem; }
    .input-wrapper {
        flex-grow: 1; display: flex; align-items: center;
        background: rgba(0,0,0,0.2); border-radius: 12px; padding: 0 1rem;
        border: 1px solid rgba(255,255,255,0.05);
        transition: border-color 0.3s;
    }
    .input-wrapper:focus-within { border-color: var(--cyber-yellow); box-shadow: 0 0 15px rgba(0, 243, 255, 0.1); }
    .search-icon { font-size: 1.2rem; opacity: 0.5; margin-right: 0.5rem; }
    .clean-input {
        width: 100%; background: transparent; border: none; color: #fff; padding: 1rem 0;
        font-family: 'Inter', sans-serif; font-size: 1.1rem; outline: none;
    }
    .scan-btn {
        padding: 0 2rem; background: var(--cyber-yellow); color: #000; font-weight: 800;
        font-family: 'Chakra Petch', sans-serif; border-radius: 12px; cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s; white-space: nowrap;
    }
    .scan-btn:hover { transform: scale(1.02); box-shadow: 0 0 20px rgba(0, 243, 255, 0.4); }

    .candidates-list { padding: 1.5rem; margin-bottom: 2rem; }
    .list-title { font-family: 'Chakra Petch', monospace; color: #666; font-size: 0.8rem; margin-bottom: 1rem; }
    .list-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
    .candidate-card {
        display: flex; align-items: center; gap: 1rem; padding: 0.8rem;
        background: rgba(255,255,255,0.05); border: 1px solid transparent; border-radius: 8px;
        cursor: pointer; transition: all 0.2s; text-align: left; width: 100%;
    }
    .candidate-card:hover { background: rgba(255,255,255,0.1); border-color: var(--cyber-yellow); }
    .mini-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
    .candidate-name { color: #fff; font-weight: bold; font-family: 'Chakra Petch', monospace; }

    .dossier-card { padding: 0; border: 1px solid rgba(255,255,255,0.1); }

    .corner { position: absolute; width: 15px; height: 15px; border-color: rgba(255,255,255,0.3); border-style: solid; }
    .tl { top: 0; left: 0; border-width: 2px 0 0 2px; border-radius: 20px 0 0 0; }
    .tr { top: 0; right: 0; border-width: 2px 2px 0 0; border-radius: 0 20px 0 0; }
    .bl { bottom: 0; left: 0; border-width: 0 0 2px 2px; border-radius: 0 0 0 20px; }
    .br { bottom: 0; right: 0; border-width: 0 2px 2px 0; border-radius: 0 0 20px 0; }

    .scan-line {
        position: absolute; top: 0; left: 0; width: 100%; height: 2px;
        background: linear-gradient(to right, transparent, var(--cyber-yellow), transparent);
        opacity: 0.3; animation: scan 3s linear infinite; pointer-events: none;
    }
    @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }

    .dossier-grid { display: flex; padding: 2.5rem; gap: 2.5rem; border-bottom: 1px solid rgba(255,255,255,0.05); }

    .profile-visual { display: flex; flex-direction: column; align-items: center; gap: 1rem; }
    .avatar-frame {
        width: 140px; height: 140px; border-radius: 50%;
        border: 2px solid rgba(255,255,255,0.2); padding: 5px;
        box-shadow: 0 0 30px rgba(0,0,0,0.5);
    }
    .subject-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
    .status-badge {
        background: rgba(57, 255, 20, 0.1); color: #39ff14; border: 1px solid #39ff14;
        padding: 2px 10px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; letter-spacing: 0.1em;
    }
    .status-badge.banned {
        background: rgba(255, 0, 60, 0.2); color: #ff003c; border-color: #ff003c;
        box-shadow: 0 0 10px #ff003c;
    }
    .status-badge.active {
        background: rgba(57, 255, 20, 0.1); color: #39ff14; border-color: #39ff14;
    }

    .profile-data { flex-grow: 1; }
    .subject-name { font-size: 2.5rem; color: #fff; font-weight: 800; line-height: 1; margin-bottom: 1rem; text-transform: uppercase; }
    .meta-row { display: flex; gap: 1rem; font-size: 0.9rem; margin-bottom: 0.5rem; align-items: center; }
    .meta-label { color: #64748b; font-weight: bold; min-width: 60px; }
    .meta-value { color: #94a3b8; }

    .stats-row { display: flex; gap: 1rem; margin-top: 1.5rem; }
    .stat-pill {
        background: rgba(0,0,0,0.3); padding: 0.5rem 1rem; border-radius: 12px;
        display: flex; flex-direction: column; min-width: 120px; border: 1px solid rgba(255,255,255,0.05);
    }
    .stat-pill .label { font-size: 0.65rem; color: #64748b; font-weight: bold; letter-spacing: 0.1em; margin-bottom: 2px; }
    .stat-pill .val { font-size: 1.2rem; font-family: 'Chakra Petch', monospace; font-weight: bold; }
    .stat-pill.yellow .val { color: var(--cyber-yellow); }
    .stat-pill.blue .val { color: #60a5fa; }

    .control-panel { padding: 2.5rem; display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; background: rgba(0,0,0,0.2); }
    .section-title { font-size: 0.8rem; font-weight: bold; margin-bottom: 1rem; letter-spacing: 0.1em; opacity: 0.8; }
    .full-width { grid-column: 1 / -1; }

    .btn-grid { display: flex; gap: 0.5rem; }
    .cmd-btn {
        flex-grow: 1; padding: 0.75rem; border-radius: 8px; font-weight: bold; font-family: 'Chakra Petch', monospace;
        cursor: pointer; transition: all 0.2s; border: 1px solid transparent;
        color: #fff; background: rgba(255,255,255,0.05);
    }
    .cmd-btn:hover { transform: translateY(-2px); }
    .cmd-btn:active { transform: translateY(1px); }

    .cmd-btn.green:hover { background: rgba(57, 255, 20, 0.1); border-color: #39ff14; color: #39ff14; box-shadow: 0 0 15px rgba(57, 255, 20, 0.2); }
    .cmd-btn.red:hover { background: rgba(255, 0, 60, 0.1); border-color: #ff003c; color: #ff003c; box-shadow: 0 0 15px rgba(255, 0, 60, 0.2); }
    .cmd-btn.purple:hover { background: rgba(189, 0, 255, 0.1); border-color: #bd00ff; color: #bd00ff; box-shadow: 0 0 15px rgba(189, 0, 255, 0.2); }

    .cmd-btn.outlined { border-color: rgba(255,255,255,0.1); background: transparent; }

    .ban-form { display: flex; gap: 1rem; }
    .reason-input {
        flex-grow: 1; background: rgba(0,0,0,0.3); border: 1px solid #333;
        padding: 0 1rem; color: #fff; border-radius: 8px; outline: none;
    }
    .reason-input:focus { border-color: #ff003c; }

    .migration-btn {
        background: rgba(255, 0, 60, 0.1);
        border: 1px solid #ff003c;
        color: #ff003c;
        padding: 0.5rem 1rem;
        font-family: 'Chakra Petch', monospace;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
    }
    .migration-btn:hover {
        background: #ff003c;
        color: black;
        box-shadow: 0 0 15px #ff003c;
    }

    .modal-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.8);
        z-index: 100; display: flex; align-items: center; justify-content: center;
        backdrop-filter: blur(5px);
    }

    .migration-panel {
        width: 100%; max-width: 500px;
        padding: 2rem;
        border: 1px solid #ff003c;
        box-shadow: 0 0 30px rgba(255, 0, 60, 0.2);
    }

    .input-group { display: flex; flex-direction: column; gap: 0.5rem; }

    .cyber-input.red { border-color: #ff003c; }
    .cyber-input.green { border-color: #39ff14; }
    .cyber-input:focus { background: rgba(255,255,255,0.1); outline: none; }

    .icon-arrow { text-align: center; font-size: 1.5rem; margin: 0.5rem 0; }

    .cancel-btn {
        flex: 1; padding: 0.8rem; background: transparent; border: 1px solid #555; color: #aaa;
        font-weight: bold; cursor: pointer;
    }
    .confirm-btn {
        flex: 1; padding: 0.8rem; background: #ff003c; border: none; color: white;
        font-weight: bold; cursor: pointer; text-transform: uppercase;
        box-shadow: 0 0 15px rgba(255, 0, 60, 0.4);
    }
    .confirm-btn:hover { transform: scale(1.02); }

    @media (max-width: 768px) {
        .dossier-grid { flex-direction: column; text-align: center; }
        .profile-visual { width: 100%; }
        .meta-row { justify-content: center; }
        .stats-row { justify-content: center; }
        .control-panel { grid-template-columns: 1fr; }
        .ban-form { flex-direction: column; }
    }
</style>
</file>

<file path="src/routes/banned/+page.server.ts">
import { redirect } from '@sveltejs/kit';
import type { PageServerLoad } from './$types';
import { firestoreAdmin } from '$lib/server/firebase.admin';

export const load: PageServerLoad = async ({ locals, cookies }) => {
    if (!locals.user) throw redirect(303, '/');

    const userDoc = await firestoreAdmin.collection('users').doc(locals.user.uid).get();
    const userData = userDoc.data();

    if (!userData || !userData.isBanned) {
        cookies.delete('__session', { path: '/' });
        throw redirect(303, '/login');
    }

    return {
        uid: locals.user.uid,
        reason: userData.banReason || 'Protocol Violation.',
        bannedUntil: userData.bannedUntil || null
    };
};
</file>

<file path="src/routes/banned/+page.svelte">
<script lang="ts">
    import { onMount } from 'svelte';
    import type { PageData } from './$types';

    export let data: PageData;

    let displayedReason = "";
    const fullReason = data.reason || get(t)('banned.default_reason');

    onMount(() => {
        let i = 0;
        const interval = setInterval(() => {
            displayedReason += fullReason[i];
            i++;
            if (i >= fullReason.length) clearInterval(interval);
        }, 50);
    });
</script>

<svelte:head>
    <title>ДОСТУП ЗАБЛОКИРОВАН | ProtoMap</title>
</svelte:head>

<div class="jail-cell">
    <div class="scanlines"></div>
    <div class="red-overlay"></div>

    <div class="content">
        <div class="icon-lock">🔒</div>

        <h1 class="glitch-text" data-text="CRITICAL ERROR">CRITICAL ERROR</h1>
        <h2 class="sub-title">ВАШ АККАУНТ ЗАМОРОЖЕН</h2>

        <div class="terminal-box">
            <p class="terminal-line">> Идентификатор субъекта: <span class="uid">{data.uid}</span></p>
            <p class="terminal-line">> Статус: <span class="red">ИСКЛЮЧЕН ИЗ СЕТИ</span></p>
            <p class="terminal-line">> Причина: <span class="reason">{displayedReason}</span><span class="cursor">_</span></p>
            {#if data.bannedUntil}
                <p class="terminal-line">> Дата амнистии: <span class="yellow">{new Date(data.bannedUntil.seconds * 1000).toLocaleDateString()}</span></p>
            {:else}
                <p class="terminal-line">> Дата амнистии: <span class="red">НИКОГДА</span></p>
            {/if}
        </div>

        <div class="appeal-section">
            <p class="appeal-text">Считаете это ошибкой? Ваши мольбы могут быть услышаны здесь:</p>
            <a href="https://t.me/Orion_Z43" class="appeal-btn">ПОДАТЬ АПЕЛЛЯЦИЮ</a>
        </div>
    </div>
</div>

<style>
    .jail-cell {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: #000; color: #ff003c;
        display: flex; align-items: center; justify-content: center;
        font-family: 'Chakra Petch', monospace; overflow: hidden;
    }

    .scanlines {
        position: absolute; inset: 0; pointer-events: none; z-index: 1;
        background: linear-gradient(to bottom, rgba(255,0,0,0), rgba(255,0,0,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
        background-size: 100% 4px; animation: scan 10s linear infinite;
    }
    .red-overlay {
        position: absolute; inset: 0; pointer-events: none; z-index: 2;
        background: radial-gradient(circle, transparent 50%, rgba(255, 0, 60, 0.2) 90%);
        animation: pulse-red 2s infinite;
    }

    .content { z-index: 10; text-align: center; max-width: 600px; width: 90%; }

    .icon-lock { font-size: 4rem; margin-bottom: 1rem; animation: shake 0.5s infinite; }

    .glitch-text {
        font-size: 3rem; font-weight: 900; color: #fff; position: relative;
        text-shadow: 2px 2px #ff003c, -2px -2px #00f3ff;
    }
    .sub-title { color: #ff003c; margin-bottom: 2rem; letter-spacing: 0.2em; }

    .terminal-box {
        background: rgba(20, 0, 0, 0.8); border: 1px solid #ff003c;
        padding: 1.5rem; text-align: left; margin-bottom: 2rem;
        box-shadow: 0 0 20px rgba(255, 0, 60, 0.2);
    }
    .terminal-line { margin-bottom: 0.5rem; color: #aaa; font-size: 0.9rem; }
    .uid { color: #fff; }
    .red { color: #ff003c; font-weight: bold; }
    .yellow { color: #ffd700; font-weight: bold; }
    .reason { color: #fff; }
    .cursor { animation: blink 1s infinite; }

    .appeal-text { color: #666; font-size: 0.8rem; margin-bottom: 1rem; }
    .appeal-btn {
        display: inline-block; padding: 0.8rem 2rem;
        border: 1px solid #ff003c; color: #ff003c; text-decoration: none;
        font-weight: bold; transition: all 0.2s;
    }
    .appeal-btn:hover { background: #ff003c; color: #000; box-shadow: 0 0 20px #ff003c; }

    @keyframes scan { from { background-position: 0 0; } to { background-position: 0 100%; } }
    @keyframes pulse-red { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
    @keyframes shake { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
</style>
</file>

<file path="src/routes/news/+page.server.ts">
import { firestoreAdmin } from '$lib/server/firebase.admin';
import type { PageServerLoad } from './$types';

export type NewsPost = {
    id: string;
    title: string;
    content: string;
    image?: string;
    createdAt: Date;
    tags?: string[];
    lang?: string;
};

export const load: PageServerLoad = async ({ setHeaders }) => {
    try {
        const snapshot = await firestoreAdmin.collection('news')
            .orderBy('createdAt', 'desc')
            .limit(20)
            .get();

        const news: NewsPost[] = snapshot.docs.map(doc => {
            const data = doc.data();
            return {
                id: doc.id,
                title: data.title || 'Без заголовка',
                content: data.content || '',
                image: data.image || null,
                createdAt: data.createdAt?.toDate() || new Date(),
                tags: data.tags || [],
                lang: data.lang || 'ru'
            };
        });

        setHeaders({ 'Cache-Control': 'public, max-age=300, s-maxage=300' });

        return { news };

    } catch (error) {
        console.error("Ошибка загрузки новостей:", error);
        return { news: [] };
    }
};
</file>

<file path="src/styles/cosmetics.css">
/* === [ СИСТЕМА КАСТОМИЗАЦИИ: РАМКИ ПРОФИЛЯ ] === */

/* --- АНИМАЦИИ --- */
@keyframes glitch-border-anim {
    0% { clip-path: inset(90% 0 5% 0); } 20% { clip-path: inset(5% 0 80% 0); }
    40% { clip-path: inset(45% 0 45% 0); } 60% { clip-path: inset(2% 0 90% 0); }
    80% { clip-path: inset(60% 0 30% 0); } 100% { clip-path: inset(90% 0 5% 0); }
}
@keyframes high-roller-shine {
    0% { background-position: -200% 0; } 100% { background-position: 200% 0; }
}
@keyframes bio-warning-scroll {
    0% { background-position: 0 0; } 100% { background-position: 30px 0; }
}
@keyframes plasma-spin {
    0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); }
}
@keyframes stealth-scan {
    0%, 100% { border-color: rgba(255,255,255,0.2); box-shadow: 0 0 5px rgba(255,255,255,0.1); }
    50% { border-color: rgba(255,255,255,0.8); box-shadow: 0 0 15px rgba(255,255,255,0.5); }
}

/* --- Базовый стиль для контейнера рамки --- */
.avatar-wrapper {
    position: relative;
    width: 128px;
    height: 128px;
    border-radius: 50%;
    display: inline-block;
}
.avatar-wrapper img {
    border-radius: 50%;
    width: 100%;
    height: 100%;
    display: block;
}

/* --- 1. Неоновый Поток (Neon Blue) --- */
.avatar-wrapper.frame_neon_blue img {
    outline: 3px solid var(--cyber-cyan);
    outline-offset: 3px;
    box-shadow: 0 0 15px var(--cyber-cyan), 0 0 25px var(--cyber-cyan);
}

/* --- 2. Системный Сбой (Glitch) --- */
.avatar-wrapper.frame_glitch::before,
.avatar-wrapper.frame_glitch::after {
    content: ''; position: absolute;
    top: -6px; left: -6px; right: -6px; bottom: -6px;
    border-radius: 50%; border: 3px solid transparent;
}
.avatar-wrapper.frame_glitch::before {
    border-color: #ff00c1;
    animation: glitch-border-anim 1s infinite linear alternate-reverse;
}
.avatar-wrapper.frame_glitch::after {
    border-color: #00f0ff;
    animation: glitch-border-anim 1s 0.2s infinite linear alternate;
}

/* --- 3. Золотой Игрок (High Roller) --- */
.avatar-wrapper.frame_high_roller::before {
    content: ''; position: absolute;
    top: -7px; left: -7px; right: -7px; bottom: -7px;
    border-radius: 50%; padding: 3px;
    background: conic-gradient(#ffd700, #f0e68c, #daa520, #f0e68c, #ffd700);
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor; mask-composite: exclude;
    animation: high-roller-shine 3s linear infinite;
    background-size: 200% 100%;
}

/* --- 4. Bio-Hazard (Новая) --- */
@keyframes bio-warning-scroll {
    0% { background-position: 0 0; }
    100% { background-position: 28.28px 0; } /* Точное значение для идеального цикла */
}

/* --- 4. Bio-Hazard (Фикс дергания) --- */
.avatar-wrapper.frame_biohazard,
.user-avatar-marker.frame_biohazard,
.avatar-wrapper-popup.frame_biohazard,
.comment-avatar-wrapper.frame_biohazard {
    padding: 3px;
    background: #000;
    border-radius: 50%;
    box-shadow: 0 0 10px #39ff14;
}

.avatar-wrapper.frame_biohazard::before,
.user-avatar-marker.frame_biohazard::before,
.avatar-wrapper-popup.frame_biohazard::before,
.comment-avatar-wrapper.frame_biohazard::before {
    content: '';
    position: absolute;
    top: -3px; left: -3px; right: -3px; bottom: -3px;
    border-radius: 50%;
    z-index: -1;
    /* Используем background-size для фиксации размера тайла */
    background-size: 28.28px 28.28px;
    background-image: repeating-linear-gradient(
        45deg,
        #39ff14,
        #39ff14 10px,
        #000 10px,
        #000 20px
    );
    /* Ускорил до 1s, чтобы выглядело как активная тревога, а не медленная лента */
    animation: bio-warning-scroll 1s linear infinite;
}

/* --- 5. Plasma Coil (Новая) --- */
.avatar-wrapper.frame_plasma::before {
    content: ''; position: absolute;
    top: -4px; left: -4px; right: -4px; bottom: -4px;
    border-radius: 50%;
    background: conic-gradient(var(--cyber-purple, #bd00ff), #ff0055, var(--cyber-purple, #bd00ff), transparent, var(--cyber-purple, #bd00ff));
    -webkit-mask-image: radial-gradient(transparent 65%, black 70%);
    mask-image: radial-gradient(transparent 65%, black 70%);
    animation: plasma-spin 4s linear infinite;
    box-shadow: 0 0 15px var(--cyber-purple, #bd00ff);
}

/* --- 6. Stealth Ops (Новая) --- */
.avatar-wrapper.frame_stealth img { filter: grayscale(0.5) brightness(0.9); }
.avatar-wrapper.frame_stealth::after {
    content: ''; position: absolute;
    top: -5px; left: -5px; right: -5px; bottom: -5px;
    border-radius: 50%; border: 1px dashed rgba(255, 255, 255, 0.5);
    border-top: 2px solid #fff; border-bottom: 2px solid #fff;
    animation: stealth-scan 3s ease-in-out infinite;
}
.avatar-wrapper.frame_stealth::before {
    content: '+'; position: absolute;
    top: 50%; left: 50%; transform: translate(-50%, -50%);
    color: rgba(255,255,255,0.3); font-family: monospace; font-size: 20px;
    pointer-events: none; z-index: 2;
}


/* === [ КАСТОМИЗАЦИЯ МАРКЕРОВ НА КАРТЕ (FIXED) ] === */

/* Базовый стиль (для пользователей БЕЗ рамки) */
.user-avatar-marker {
    box-shadow: 0 0 8px rgba(252, 238, 10, 0.7);
    transition: transform 0.2s ease-out;
    border-radius: 50%;
    overflow: hidden; /* Важно для обрезки круга без рамки */
}
.user-avatar-marker img {
    border: 2px solid var(--cyber-yellow, #fcee0a);
    background-color: #333;
    width: 100%; height: 100%; object-fit: cover;
}
.user-avatar-marker:hover { transform: scale(1.1); }


/* --- ГЛОБАЛЬНЫЙ ФИКС ДЛЯ ВСЕХ РАМОК НА КАРТЕ --- */
/* Это убирает желтую обводку и разрешает эффектам выходить за пределы */
.user-avatar-marker.frame_neon_blue,
.user-avatar-marker.frame_glitch,
.user-avatar-marker.frame_high_roller,
.user-avatar-marker.frame_biohazard,
.user-avatar-marker.frame_plasma,
.user-avatar-marker.frame_stealth {
    overflow: visible !important;
    background: transparent !important;
    box-shadow: none !important;
}

.user-avatar-marker.frame_neon_blue img,
.user-avatar-marker.frame_glitch img,
.user-avatar-marker.frame_high_roller img,
.user-avatar-marker.frame_biohazard img,
.user-avatar-marker.frame_plasma img,
.user-avatar-marker.frame_stealth img {
    border: none !important; /* Убиваем желтую рамку */
    border-radius: 50% !important;
    background-color: #111;
}

/* --- Специфичные стили для маркеров --- */

/* 1. Neon Blue Marker */
.user-avatar-marker.frame_neon_blue img {
    border: 2px solid var(--cyber-cyan) !important;
    box-shadow: 0 0 8px var(--cyber-cyan), 0 0 12px var(--cyber-cyan);
}

/* 2. Glitch Marker */
.user-avatar-marker.frame_glitch::before,
.user-avatar-marker.frame_glitch::after {
    content: ''; position: absolute;
    top: -2px; left: -2px; right: -2px; bottom: -2px;
    border-radius: 50%; border: 2px solid transparent; pointer-events: none;
}
.user-avatar-marker.frame_glitch::before { border-color: #ff00c1; animation: glitch-border-anim 1s infinite linear alternate-reverse; }
.user-avatar-marker.frame_glitch::after { border-color: #00f0ff; animation: glitch-border-anim 1s 0.2s infinite linear alternate; }

/* ========================================= */
/* ⚜️ HIGH ROLLER: DELUXE EDITION (FIXED) ⚜️ */
/* ========================================= */

@keyframes luxury-spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes luxury-pulse {
    0%, 100% { filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.5)); }
    50% { filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.9)); }
}

/* 1. БАЗОВЫЙ КОНТЕЙНЕР (Для всех мест) */
.avatar-wrapper.frame_high_roller,
.user-avatar-marker.frame_high_roller,
.avatar-wrapper-popup.frame_high_roller,
.comment-avatar-wrapper.frame_high_roller {
    position: relative;
    border: none !important;
    background: transparent !important;
    border-radius: 50% !important;
    overflow: visible !important; /* Разрешаем свечению вылезать */

    /* Пульсация через drop-shadow, а не box-shadow (лучше работает с прозрачностью) */
    animation: luxury-pulse 3s infinite ease-in-out;

    /* Убираем отступы, чтобы картинка была 100% */
    padding: 0 !important;
    box-shadow: none !important;
}

/* 2. ЗОЛОТОЕ КОЛЬЦО (Псевдоэлемент) */
.avatar-wrapper.frame_high_roller::before,
.user-avatar-marker.frame_high_roller::before,
.avatar-wrapper-popup.frame_high_roller::before,
.comment-avatar-wrapper.frame_high_roller::before {
    content: '';
    position: absolute;
    /* Рамка выступает наружу на 3px */
    inset: -3px;
    border-radius: 50%;
    z-index: -1; /* ПОД картинкой */

    background: conic-gradient(
        #b8860b, #ffd700, #fff8dc, #ffd700,
        #b8860b, #ffd700, #fff8dc, #b8860b
    );

    /* Вырезаем дырку внутри, чтобы видеть картинку */
    /* Используем mask-composite для поддержки разных браузеров */
    -webkit-mask:
        linear-gradient(#fff 0 0) content-box,
        linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;

    /* Важно: padding внутри маски определяет толщину кольца */
    padding: 3px;

    animation: luxury-spin 4s linear infinite;
}

/* 3. ВНЕШНЕЕ СИЯНИЕ (Второй слой) */
.avatar-wrapper.frame_high_roller::after,
.user-avatar-marker.frame_high_roller::after,
.avatar-wrapper-popup.frame_high_roller::after,
.comment-avatar-wrapper.frame_high_roller::after {
    content: '';
    position: absolute;
    inset: -5px; /* Еще шире */
    border-radius: 50%;
    z-index: -2; /* Самый нижний слой */

    background: conic-gradient(transparent, #ffd700, transparent 40%);
    filter: blur(5px);
    opacity: 0.7;

    animation: luxury-spin 3s linear infinite reverse;
}

/* 4. САМА КАРТИНКА */
.frame_high_roller img {
    width: 100% !important;
    height: 100% !important;
    border-radius: 50% !important;
    display: block !important;
    position: relative;
    z-index: 1; /* Сверху */

    /* Тонкая обводка, чтобы отделить фото от кольца */
    border: 1px solid rgba(0,0,0,0.5) !important;

    /* Внутренняя тень для объема */
    box-shadow: inset 0 0 10px rgba(0,0,0,0.5) !important;
}

/* 5. СПЕЦ-ФИКС ДЛЯ КАРТЫ (Leaflet) */
/* На карте маркеры имеют свои приколы с трансформацией */
.user-avatar-marker.frame_high_roller {
    /* На карте drop-shadow может обрезаться, заменяем на box-shadow */
    animation: none !important; /* Отключаем фильтр */
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.6) !important;
}

/* 4. Biohazard Marker */
.user-avatar-marker.frame_biohazard::before {
    content: ''; position: absolute; z-index: -1;
    top: -3px; left: -3px; right: -3px; bottom: -3px;
    border-radius: 50%;
    background: repeating-linear-gradient(45deg, #39ff14, #39ff14 5px, #000 5px, #000 10px);
    box-shadow: 0 0 5px #39ff14;
    animation: bio-warning-scroll 2s linear infinite;
}

/* 5. Plasma Marker */
.user-avatar-marker.frame_plasma::before {
    content: ''; position: absolute; z-index: -1;
    top: -4px; left: -4px; right: -4px; bottom: -4px;
    border-radius: 50%;
    background: conic-gradient(var(--cyber-purple, #bd00ff), #ff0055, var(--cyber-purple, #bd00ff), transparent, var(--cyber-purple, #bd00ff));
    animation: plasma-spin 4s linear infinite;
}

/* 6. Stealth Marker */
.user-avatar-marker.frame_stealth::before {
    content: '+'; position: absolute; z-index: 10;
    top: 50%; left: 50%; transform: translate(-50%, -50%);
    color: rgba(255,255,255,0.5); font-family: monospace; font-size: 14px;
}
.user-avatar-marker.frame_stealth::after {
    content: ''; position: absolute; z-index: 20;
    top: -3px; left: -3px; right: -3px; bottom: -3px;
    border-radius: 50%; border: 1px dashed rgba(255, 255, 255, 0.5);
    border-top: 2px solid #fff; border-bottom: 2px solid #fff;
    animation: stealth-scan 3s ease-in-out infinite;
}


/* === [ КАСТОМИЗАЦИЯ АВАТАРОВ В ПОПАПЕ ] === */
.avatar-wrapper-popup { position: relative; width: 48px; height: 48px; flex-shrink: 0; }
.avatar-wrapper-popup .popup-avatar { width: 100%; height: 100%; border: none; border-radius: 50%; }

.avatar-wrapper-popup.frame_neon_blue { border-radius: 50%; border: 2px solid var(--cyber-cyan); box-shadow: 0 0 8px var(--cyber-cyan), 0 0 12px var(--cyber-cyan); }

.avatar-wrapper-popup.frame_glitch::before, .avatar-wrapper-popup.frame_glitch::after {
    content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px; border-radius: 50%; border: 2px solid transparent;
}
.avatar-wrapper-popup.frame_glitch::before { border-color: #ff00c1; animation: glitch-border-anim 1s infinite linear alternate-reverse; }
.avatar-wrapper-popup.frame_glitch::after { border-color: #00f0ff; animation: glitch-border-anim 1s 0.2s infinite linear alternate; }

.avatar-wrapper-popup.frame_high_roller::before {
    content: ''; position: absolute; top: -4px; left: -4px; right: -4px; bottom: -4px;
    border-radius: 50%; padding: 2px;
    background: conic-gradient(#ffd700, #f0e68c, #daa520, #f0e68c, #ffd700);
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor; mask-composite: exclude; animation: high-roller-shine 3s linear infinite;
}

.avatar-wrapper-popup.frame_biohazard { padding: 2px; background: #000; border-radius: 50%; box-shadow: 0 0 5px #39ff14; }
.avatar-wrapper-popup.frame_biohazard::before {
    content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px;
    border-radius: 50%; z-index: -1; background: repeating-linear-gradient(45deg, #39ff14, #39ff14 5px, #000 5px, #000 10px); animation: bio-warning-scroll 2s linear infinite;
}
.avatar-wrapper-popup.frame_plasma::before {
    content: ''; position: absolute; top: -3px; left: -3px; right: -3px; bottom: -3px; border-radius: 50%;
    background: conic-gradient(var(--cyber-purple, #bd00ff), #ff0055, var(--cyber-purple, #bd00ff), transparent, var(--cyber-purple, #bd00ff));
    -webkit-mask-image: radial-gradient(transparent 65%, black 70%); mask-image: radial-gradient(transparent 65%, black 70%); animation: plasma-spin 4s linear infinite;
}
.avatar-wrapper-popup.frame_stealth img { filter: grayscale(0.5) brightness(0.9); }
.avatar-wrapper-popup.frame_stealth::after {
    content: ''; position: absolute; top: -3px; left: -3px; right: -3px; bottom: -3px; border-radius: 50%;
    border: 1px dashed rgba(255, 255, 255, 0.5); border-top: 2px solid #fff; border-bottom: 2px solid #fff; animation: stealth-scan 3s ease-in-out infinite;
}


/* === [ КАСТОМИЗАЦИЯ АВАТАРОВ В КОММЕНТАРИЯХ ] === */

.comment-avatar-wrapper.frame_neon_blue { outline: 2px solid var(--cyber-cyan); outline-offset: 2px; box-shadow: 0 0 8px var(--cyber-cyan), 0 0 12px var(--cyber-cyan); }

.comment-avatar-wrapper.frame_glitch::before, .comment-avatar-wrapper.frame_glitch::after {
    content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px; border-radius: 50%; border: 2px solid transparent;
}
.comment-avatar-wrapper.frame_glitch::before { border-color: #ff00c1; animation: glitch-border-anim 1s infinite linear alternate-reverse; }
.comment-avatar-wrapper.frame_glitch::after { border-color: #00f0ff; animation: glitch-border-anim 1s 0.2s infinite linear alternate; }

.comment-avatar-wrapper.frame_high_roller::before {
    content: ''; position: absolute; top: -4px; left: -4px; right: -4px; bottom: -4px; border-radius: 50%; padding: 2px;
    background: conic-gradient(#ffd700, #f0e68c, #daa520, #f0e68c, #ffd700);
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; animation: high-roller-shine 3s linear infinite;
}

.comment-avatar-wrapper.frame_biohazard { padding: 2px; background: #000; border-radius: 50%; box-shadow: 0 0 5px #39ff14; }
.comment-avatar-wrapper.frame_biohazard::before {
    content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px;
    border-radius: 50%; z-index: -1; background: repeating-linear-gradient(45deg, #39ff14, #39ff14 5px, #000 5px, #000 10px); animation: bio-warning-scroll 2s linear infinite;
}
.comment-avatar-wrapper.frame_plasma::before {
    content: ''; position: absolute; top: -3px; left: -3px; right: -3px; bottom: -3px; border-radius: 50%;
    background: conic-gradient(var(--cyber-purple, #bd00ff), #ff0055, var(--cyber-purple, #bd00ff), transparent, var(--cyber-purple, #bd00ff));
    -webkit-mask-image: radial-gradient(transparent 65%, black 70%); mask-image: radial-gradient(transparent 65%, black 70%); animation: plasma-spin 4s linear infinite;
}
.comment-avatar-wrapper.frame_stealth img { filter: grayscale(0.5) brightness(0.9); }
.comment-avatar-wrapper.frame_stealth::after {
    content: ''; position: absolute; top: -3px; left: -3px; right: -3px; bottom: -3px; border-radius: 50%;
    border: 1px dashed rgba(255, 255, 255, 0.5); border-top: 2px solid #fff; border-bottom: 2px solid #fff; animation: stealth-scan 3s ease-in-out infinite;
}

/* ========================================= */
/* === [ WINTER COLLECTION: FIXED v3 ] === */
/* ========================================= */

/* --- 0. ГЛОБАЛЬНЫЙ ФИКС КОНТЕЙНЕРОВ --- */
/* Это лечит обрезание и странный фон на карте/в профиле */

.avatar-wrapper.frame_cryo, .avatar-wrapper.frame_festive, .avatar-wrapper.frame_aurora,
.user-avatar-marker.frame_cryo, .user-avatar-marker.frame_festive, .user-avatar-marker.frame_aurora,
.avatar-wrapper-popup.frame_cryo, .avatar-wrapper-popup.frame_festive, .avatar-wrapper-popup.frame_aurora,
.comment-avatar-wrapper.frame_cryo, .comment-avatar-wrapper.frame_festive, .comment-avatar-wrapper.frame_aurora {
    overflow: visible !important; /* Разрешаем рамке вылезать */
    border-radius: 50% !important; /* Гарантируем круг */
    background: transparent !important; /* Убираем лишние фоны */
    box-shadow: none !important; /* Убираем старые тени, которые могли мешать */
    transform-style: preserve-3d; /* Фикс для некоторых браузеров */
}

/* Убираем дефолтные бордеры у картинок внутри этих рамок */
.frame_cryo img, .frame_festive img, .frame_aurora img {
    border: none !important;
    border-radius: 50% !important;
    /* Важно: Картинка должна быть сверху подложек, но снизу наложений */
    position: relative;
    z-index: 5;
}


/* --- ANIMATIONS --- */

@keyframes spin-slow {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes festive-flash {
    0%, 100% { filter: brightness(1); opacity: 0.8; }
    50% { filter: brightness(1.3); opacity: 1; }
}

@keyframes aurora-wave {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}


/* ------------------------------------------------ */
/* 1. CRYO-STASIS (Ледяной щит)                     */
/* ------------------------------------------------ */

/* Внешнее кольцо (Лёд) */
.frame_cryo::before {
    content: ''; position: absolute;
    inset: -4px; /* Выступает наружу */
    border-radius: 50%;
    border: 2px solid rgba(0, 243, 255, 0.6);
    box-shadow: 0 0 10px rgba(0, 243, 255, 0.5), inset 0 0 10px rgba(0, 243, 255, 0.3);
    z-index: 10; /* Поверх аватарки */
    pointer-events: none;
}

/* Вращающиеся осколки (Тонкие) */
.frame_cryo::after {
    content: ''; position: absolute;
    inset: -6px;
    border-radius: 50%;
    border: 2px solid transparent;
    border-top-color: #fff;
    border-bottom-color: rgba(0, 243, 255, 0.5);
    z-index: 11;
    animation: spin-slow 8s linear infinite;
    pointer-events: none;
}


/* ------------------------------------------------ */
/* 2. FESTIVE_L00P (Гирлянда)                       */
/* ------------------------------------------------ */

/* Основное свечение (Сзади) */
.frame_festive::before {
    content: ''; position: absolute;
    inset: -3px; /* Чуть шире */
    border-radius: 50%;
    z-index: 1; /* ПОД аватаркой (z-index картинки = 5) */
    background: conic-gradient(
        #ff003c, #ffd700, #00ff9d,
        #ff003c, #ffd700, #00ff9d,
        #ff003c
    );
    filter: blur(2px);
    animation: spin-slow 4s linear infinite;
}

/* Четкий контур (Сверху) */
.frame_festive::after {
    content: ''; position: absolute;
    inset: -3px;
    border-radius: 50%;
    z-index: 10; /* ПОВЕРХ аватарки */
    border: 2px dashed rgba(255, 255, 255, 0.6);
    animation: spin-slow 12s linear infinite reverse, festive-flash 2s ease-in-out infinite;
    pointer-events: none;
}


/* ------------------------------------------------ */
/* 3. AURORA (Северное сияние)                      */
/* ------------------------------------------------ */

/* Подложка с градиентом */
.frame_aurora::before {
    content: ''; position: absolute;
    inset: -3px;
    border-radius: 50%;
    z-index: 1; /* Под аватаркой */
    background: linear-gradient(120deg, #00ff9d, #00f3ff, #bd00ff, #00ff9d);
    background-size: 300% 300%;
    animation: aurora-wave 3s ease infinite;
}

/* Внутренний блик (Сверху) */
.frame_aurora::after {
    content: ''; position: absolute;
    inset: 0;
    border-radius: 50%;
    z-index: 10; /* Поверх */
    box-shadow: inset 0 0 8px rgba(0, 243, 255, 0.6);
    border: 1px solid rgba(255,255,255,0.3);
    pointer-events: none;
}

/* ------------------------------------------------ */
/* 4. TRUE GAMBLER (LUDOMAN) - THIN & CRISP         */
/* ------------------------------------------------ */

@keyframes money-rain-fall {
    /* Падение на высоту паттерна (20px) */
    0% { background-position: 0 0, 5px -10px; }
    100% { background-position: 0 20px, 5px 10px; }
}

@keyframes gold-pulse {
    0%, 100% { border-color: #ffd700; box-shadow: 0 0 3px #ffd700; }
    50% { border-color: #ffec8b; box-shadow: 0 0 10px #ffd700; }
}

/* Глобальный контейнер */
.avatar-wrapper.frame_ludoman,
.user-avatar-marker.frame_ludoman,
.avatar-wrapper-popup.frame_ludoman,
.comment-avatar-wrapper.frame_ludoman {
    position: relative;

    /* УМЕНЬШИЛИ ТОЛЩИНУ: Было 2px -> Стало 1px */
    border: 1px solid #ffd700 !important;

    animation: gold-pulse 2s infinite ease-in-out;

    overflow: visible !important;
    border-radius: 50% !important;
    background: transparent !important;
    box-sizing: border-box !important;
    padding: 0 !important;
}

/* Эффект дождя (Слой поверх) */
.frame_ludoman::before {
    content: '';
    position: absolute;

    /* Эффект чуть шире рамки */
    inset: -3px;

    border-radius: 50%;
    z-index: 10;
    pointer-events: none;

    /* Золотые и белые точки (искры) */
    background-image:
        radial-gradient(circle, #ffd700 1.5px, transparent 1.5px),
        radial-gradient(circle, #fff 1px, transparent 1px);

    background-size: 10px 10px, 15px 15px;

    animation: money-rain-fall 1s linear infinite;

    /* МАСКА: Сдвинули границу маски внутрь (60%),
       чтобы дождь был виден лучше поверх тонкой рамки */
    -webkit-mask: radial-gradient(transparent 60%, black 61%);
    mask: radial-gradient(transparent 60%, black 61%);
}

/* Фикс самой картинки внутри */
.frame_ludoman img {
    border-radius: 50% !important;
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
    border: none !important;
    display: block !important;
    position: relative;
    z-index: 5;
}
/* === [ ЭКСКЛЮЗИВНЫЕ РАМКИ: DEV & BETA ] === */

/* --- АНИМАЦИИ --- */
@keyframes dev-spin-tech {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
@keyframes beta-scan {
    0%, 100% { border-color: #ffb000; box-shadow: 0 0 10px #ffb000; }
    50% { border-color: #ffea00; box-shadow: 0 0 25px #ffea00; }
}
@keyframes text-glitch-blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; text-shadow: 0 0 5px #fff; }
}

/* --- 1. FRAME: DEVELOPER (GOD MODE) --- */
/* Стиль: Технический круг, агрессивный красный, плашка DEV */

/* База */
.avatar-wrapper.frame_dev,
.user-avatar-marker.frame_dev,
.avatar-wrapper-popup.frame_dev,
.comment-avatar-wrapper.frame_dev {
    position: relative;
    z-index: 10;
    /* Небольшое свечение вокруг всего аватара */
    filter: drop-shadow(0 0 5px rgba(255, 0, 60, 0.5));
}

/* Сама картинка - добавляем тонкую красную обводку */
.avatar-wrapper.frame_dev img,
.user-avatar-marker.frame_dev img,
.avatar-wrapper-popup.frame_dev img,
.comment-avatar-wrapper.frame_dev img {
    border: 2px solid #ff003c !important;
}

/* Вращающийся техно-круг */
.avatar-wrapper.frame_dev::before,
.user-avatar-marker.frame_dev::before,
.avatar-wrapper-popup.frame_dev::before,
.comment-avatar-wrapper.frame_dev::before {
    content: ''; position: absolute; z-index: 2;
    top: -6px; left: -6px; right: -6px; bottom: -6px;
    border-radius: 50%;
    border: 2px solid transparent;
    border-top-color: #ff003c;
    border-bottom-color: #fff;
    animation: dev-spin-tech 4s linear infinite;
}

/* Плашка DEV снизу */
.avatar-wrapper.frame_dev::after,
.user-avatar-marker.frame_dev::after,
.avatar-wrapper-popup.frame_dev::after,
.comment-avatar-wrapper.frame_dev::after {
    content: 'DEV';
    position: absolute;
    bottom: -6px; left: 50%; transform: translateX(-50%);
    background: #ff003c;
    color: #fff;
    font-family: 'Chakra Petch', monospace;
    font-weight: 900;
    font-size: 10px;
    line-height: 1.2 !important; /* Восстанавливаем высоту строки */
    padding: 2px 6px; /* Чуть больше воздуха */
    min-width: 30px;  /* Минимальная ширина, чтобы не сжималось */
    text-align: center;
    border-radius: 4px;
    border: 1px solid #fff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    z-index: 20;
    letter-spacing: 0.1em;
    animation: text-glitch-blink 2s infinite;
}

/* --- 2. FRAME: BETA TESTER (ЯНТАРНЫЙ ТЕХНИК) --- */
/* Стиль: Пунктир, значок Бета */

.avatar-wrapper.frame_beta img,
.user-avatar-marker.frame_beta img,
.avatar-wrapper-popup.frame_beta img,
.comment-avatar-wrapper.frame_beta img {
    filter: sepia(0.3);
}

.avatar-wrapper.frame_beta::before,
.user-avatar-marker.frame_beta::before,
.avatar-wrapper-popup.frame_beta::before,
.comment-avatar-wrapper.frame_beta::before {
    content: ''; position: absolute;
    top: -4px; left: -4px; right: -4px; bottom: -4px;
    border-radius: 50%;
    border: 2px dashed #ffb000;
    box-shadow: 0 0 10px rgba(255, 176, 0, 0.3);
    animation: beta-scan 3s infinite ease-in-out;
}

/* Значок β */
.avatar-wrapper.frame_beta::after,
.user-avatar-marker.frame_beta::after,
.avatar-wrapper-popup.frame_beta::after,
.comment-avatar-wrapper.frame_beta::after {
    content: 'β';
    position: absolute;
    bottom: -2px; right: -2px;
    background: #ffb000; color: #000;
    width: 16px; height: 16px;
    border-radius: 50%;
    font-family: monospace; font-weight: bold; font-size: 11px;
    display: flex; align-items: center; justify-content: center;
    border: 1px solid #fff;
    z-index: 10;
}


/* === ВАЖНО: ФИКС ДЛЯ КАРТЫ (Leaflet) === */
/* Разрешаем элементам вылезать за границы маркера */
.user-avatar-marker.frame_dev,
.user-avatar-marker.frame_beta {
    overflow: visible !important;
    background: transparent !important;
    box-shadow: none !important;
}
.user-avatar-marker.frame_dev img,
.user-avatar-marker.frame_beta img {
    /* Сбрасываем дефолтный желтый бордер */
    border: none !important;
    /* Для DEV возвращаем свой красный внутри селектора выше, а для BETA оставляем без бордера */
}
/* Возвращаем красный бордер конкретно для картинки внутри маркера DEV */
.user-avatar-marker.frame_dev img {
    border: 2px solid #ff003c !important;
}
</file>

<file path="src/styles/profile-skins.css">
/* ==========================================================================
   PROTOMAP PROFILE SKINS v3.0 [MAXIMUM OVERDRIVE]
   ========================================================================== */
.profile-backdrop {
    position: fixed;
    top: 0; left: 0; width: 100vw; height: 100vh;
    z-index: -1;
    pointer-events: none;
    overflow: hidden;
}

.profile-container.themed {
    backdrop-filter: blur(20px) saturate(120%) !important;
    -webkit-backdrop-filter: blur(20px) saturate(120%) !important;
    background-color: rgba(10, 10, 15, 0.75) !important; /* Умная подложка */
    transition: all 0.3s ease;
}

@keyframes hex-scan {
    0% { background-position: 0% 0%; }
    100% { background-position: 100px 100px; }
}
@keyframes amber-pulse {
    0%, 100% { opacity: 0.3; transform: scale(1); }
    50% { opacity: 0.6; transform: scale(1.2); }
}

.profile-backdrop.bg_carbon {
    background-color: #050505;
    background-image:
        radial-gradient(circle at 50% 50%, transparent 20%, #000 100%),
        repeating-linear-gradient(60deg, rgba(255, 165, 0, 0.03) 0, rgba(255, 165, 0, 0.03) 1px, transparent 1px, transparent 20px),
        repeating-linear-gradient(-60deg, rgba(255, 165, 0, 0.03) 0, rgba(255, 165, 0, 0.03) 1px, transparent 1px, transparent 20px);
    background-size: 100% 100%, 35px 60px, 35px 60px;
}

.profile-backdrop.bg_carbon::before {
    content: ''; position: absolute; inset: 0;
    background: radial-gradient(circle at 50% 50%, rgba(255, 140, 0, 0.15), transparent 60%);
    animation: amber-pulse 6s infinite ease-in-out;
}

.profile-container.bg_carbon-theme {
    border: 1px solid rgba(255, 140, 0, 0.4) !important;
    box-shadow: 0 0 40px rgba(255, 140, 0, 0.1), inset 0 0 20px rgba(0,0,0,0.8) !important;
    background: rgba(15, 12, 10, 0.9) !important;
}
.profile-container.bg_carbon-theme .profile-username {
    color: #ff9d00 !important;
    text-transform: uppercase;
    text-shadow: 0 0 10px rgba(255, 140, 0, 0.6) !important;
    font-family: 'Chakra Petch', sans-serif !important;
}
.profile-container.bg_carbon-theme h4 { color: #888 !important; letter-spacing: 0.2em; }
.profile-container.bg_carbon-theme .top-bar { border-color: rgba(255, 140, 0, 0.2) !important; }

@keyframes matrix-fall {
    0% { background-position: 0% 0%; }
    100% { background-position: 0% 1000px; }
}
@keyframes crt-flicker {
    0% { opacity: 0.95; }
    5% { opacity: 0.85; }
    10% { opacity: 0.95; }
    100% { opacity: 0.95; }
}

.profile-backdrop.bg_matrix {
    background-color: #000;
    background-image:
        linear-gradient(to top, rgba(0, 50, 0, 0.8), transparent),
        repeating-linear-gradient(0deg, transparent, transparent 50%, rgba(0, 255, 0, 0.1) 50%, rgba(0, 255, 0, 0.1) 100%),
        repeating-linear-gradient(90deg, rgba(0,0,0,0.9) 0px, rgba(0,0,0,0.9) 20px, transparent 20px, transparent 40px);
    background-size: 100% 100%, 100% 10px, 40px 100%;
    animation: matrix-fall 20s linear infinite;
}

.profile-backdrop.bg_matrix::after {
    content: ''; position: absolute; inset: 0;
    background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
    background-size: 100% 4px, 6px 100%;
    pointer-events: none;
    z-index: 10;
    animation: crt-flicker 0.15s infinite;
}

.profile-container.bg_matrix-theme {
    border: 1px solid #00ff41 !important;
    background: rgba(0, 10, 0, 0.85) !important;
    box-shadow: 0 0 20px rgba(0, 255, 65, 0.2) !important;
    font-family: 'Courier New', monospace !important;
}
.profile-container.bg_matrix-theme .profile-username {
    color: #00ff41 !important;
    text-shadow: 0 0 8px #00ff41 !important;
}
.profile-container.bg_matrix-theme h4 { color: #008f11 !important; }
.profile-container.bg_matrix-theme .social-link-btn {
    border-color: #00ff41 !important; color: #00ff41 !important;
    background: rgba(0, 20, 0, 0.8) !important;
}

@keyframes synth-grid-move {
    0% { transform: perspective(500px) rotateX(60deg) translateY(0); }
    100% { transform: perspective(500px) rotateX(60deg) translateY(100px); }
}
@keyframes star-twinkle {
    0%, 100% { opacity: 0.8; }
    50% { opacity: 0.3; }
}

.profile-backdrop.bg_synthwave {
    background: linear-gradient(to bottom, #0f0c29, #302b63, #24243e);
    overflow: hidden;
}

.profile-backdrop.bg_synthwave::before {
    content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 60%;
    background-image:
        radial-gradient(white 1px, transparent 1px),
        radial-gradient(white 1px, transparent 1px);
    background-size: 50px 50px, 100px 100px;
    background-position: 0 0, 25px 25px;
    animation: star-twinkle 4s infinite ease-in-out;
    opacity: 0.6;
}

.profile-backdrop.bg_synthwave::after {
    content: '';
    position: absolute;
    bottom: -100px; left: -50%; width: 200%; height: 100%;
    background-image:
        linear-gradient(rgba(255, 0, 255, 0.5) 2px, transparent 2px),
        linear-gradient(90deg, rgba(255, 0, 255, 0.5) 2px, transparent 2px);
    background-size: 100px 100px, 100px 100px;

    transform-origin: top;
    transform: perspective(500px) rotateX(60deg);
    animation: synth-grid-move 4s linear infinite;
    -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 40%);
    mask-image: linear-gradient(to bottom, transparent 0%, black 40%);
}

.profile-container.bg_synthwave-theme {
    background: rgba(45, 12, 60, 0.8) !important;
    border: 2px solid #00f3ff !important;
    box-shadow:
        0 0 20px rgba(255, 0, 222, 0.4),
        inset 0 0 30px rgba(0, 243, 255, 0.1) !important;
}

.profile-container.bg_synthwave-theme .profile-username {
    background: linear-gradient(to bottom, #00f3ff, #ff00de) !important;
    -webkit-background-clip: text !important;
    background-clip: text !important;
    color: transparent !important;
    -webkit-text-fill-color: transparent !important;
    font-weight: 900;
    font-style: italic;
    filter: drop-shadow(0 0 5px rgba(255,0,222,0.8));
    font-size: 3rem !important;
}

.profile-container.bg_synthwave-theme h4 { color: #00f3ff !important; }
.profile-container.bg_synthwave-theme .top-bar { border-color: #ff00de !important; }
</file>

<file path="src/app.html">
<!doctype html>
<html lang="ru" class="dark">
    <head>
       <meta charset="utf-8" />
       <link rel="icon" href="/protogen_pin.svg" type="image/svg+xml">
       <meta name="viewport" content="width=device-width, initial-scale=1" />
       <link rel="preconnect" href="https://fonts.googleapis.com">
       <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
       <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Russo+One&display=swap" rel="stylesheet">
       <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

       %sveltekit.head%

    </head>
    <body data-sveltekit-preload-data="hover">
       <div style="display: contents">%sveltekit.body%</div>
    </body>
</html>
</file>

<file path="src/lib/client/audioManager.ts">
import { Howl, Howler } from 'howler'; // <--- Добавили Howler
import { settingsStore } from '$lib/stores/settingsStore';
import { get } from 'svelte/store';
import { browser } from '$app/environment';

export type SoundName =
    | 'click'
    | 'success'
    | 'fail'
    | 'message'
    | 'click_alt'
    | 'popup_open'
    | 'popup_close'
    | 'entercasino';

const soundFiles: Record<SoundName, string> = {
    click: '/sounds/click.mp3',
    success: '/sounds/sucsess.mp3',
    fail: '/sounds/fail.mp3',
    message: '/sounds/message.mp3',
    click_alt: '/sounds/click_for_other_buttons.mp3',
    popup_open: '/sounds/popup_open.mp3',
    popup_close: '/sounds/popup_closed.mp3',
    entercasino: '/sounds/entercasino.mp3',
};

let sounds: Partial<Record<SoundName, Howl>> = {};
let isInitialized = false;

function initialize() {
    if (!browser || isInitialized) {
        return;
    }

    console.log('[AudioManager] Инициализация и предзагрузка звуков...');

    for (const key in soundFiles) {
        const soundName = key as SoundName;
        sounds[soundName] = new Howl({
            src: [soundFiles[soundName]],
            preload: true,
            volume: 0.7
        });
    }

    document.addEventListener('visibilitychange', handleVisibilityChange);

    settingsStore.subscribe((state) => {
        if (!document.hidden) {
            Howler.mute(!state.audioEnabled);
        }
    });

    const { audioEnabled } = get(settingsStore);
    Howler.mute(!audioEnabled);

    isInitialized = true;
    console.log('[AudioManager] Звуки загружены. Слушатели установлены.');
}

function handleVisibilityChange() {
    if (document.hidden) {
        Howler.mute(true);
    } else {
        const { audioEnabled } = get(settingsStore);
        Howler.mute(!audioEnabled);
    }
}

function play(soundName: SoundName) {
    if (!browser) return;

    const { audioEnabled } = get(settingsStore);
    if (!audioEnabled) return;

    const sound = sounds[soundName];
    if (sound) {
        sound.play();
    } else {
        console.warn(`[AudioManager] Звук с именем "${soundName}" не найден.`);
    }
}

export const AudioManager = {
    initialize,
    play,
};
</file>

<file path="src/lib/components/Footer.svelte">
<script lang="ts">
    export let mode: 'fixed' | 'menu' = 'fixed';
    import { t } from 'svelte-i18n';
    const currentYear = new Date().getFullYear();
</script>

<div class:legal-ticker={mode === 'fixed'} class:menu-links={mode === 'menu'}>
    {#if mode === 'menu'}
        <a href="/privacy-policy">{$t('footer.policy')}</a>
        <a href="/terms-of-service">{$t('footer.terms')}</a>
        <span>© {currentYear} {$t('footer.rights')}</span>
    {:else}
        <p>© {currentYear} {$t('footer.rights')}</p>
        <div class="links">
            <a href="/privacy-policy">{$t('footer.policy')}</a>
            <span>//</span>
            <a href="/terms-of-service">{$t('footer.terms')}</a>
        </div>
    {/if}
</div>

<style>
    .legal-ticker {
        position: fixed;
        bottom: 1rem;
        left: 1rem;
        z-index: 40;
        font-family: 'Chakra Petch', monospace;
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.3);
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        background: rgba(10, 10, 10, 0.3);
        padding: 0.5rem 0.75rem;
        border-radius: 4px;
        backdrop-filter: blur(4px);
        pointer-events: auto;
        transition: color 0.3s, background 0.3s, left 0.3s ease-out;
    }
    .legal-ticker:hover {
        color: rgba(255, 255, 255, 0.7);
        background: rgba(10, 10, 10, 0.5);
    }
    .legal-ticker .links {
        display: flex;
        gap: 0.5rem;
    }
    .legal-ticker .links a {
        color: inherit;
        text-decoration: none;
        text-transform: uppercase;
    }
    .legal-ticker .links a:hover {
        color: var(--cyber-yellow, #fcee0a);
        text-decoration: underline;
    }

    @media (min-width: 1024px) {
        .legal-ticker {
            left: calc(75px + 1rem);
        }
    }

    .menu-links {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem 1rem;
        font-size: 0.7rem;
        color: rgba(255, 255, 255, 0.4);
    }
    .menu-links a {
        color: inherit;
        text-decoration: none;
    }
    .menu-links a:hover {
        color: #fff;
    }
</style>
</file>

<file path="src/routes/admin/+layout.svelte">
<script lang="ts">
    import "../../app.css";
    import { page } from '$app/stores';

    $: path = $page.url.pathname;
</script>

<div class="admin-universe">
    <div class="ambient-glow"></div>

    <!-- МОБИЛЬНЫЙ ХЕДЕР (Виден только на телефоне) -->
    <div class="mobile-header">
        <span class="glitch-text small" data-text="OVERLORD">OVERLORD</span>
        <div class="status-dot"></div>
    </div>

    <!-- SIDEBAR (На ПК слева, на Мобиле внизу) -->
    <aside class="glass-sidebar">
        <!-- Логотип (Только ПК) -->
        <div class="brand desktop-only">
            <h1 class="glitch-text" data-text="OVERLORD">OVERLORD</h1>
            <div class="status-dot"></div>
        </div>

        <nav class="nav-links">
            <a href="/admin" class="nav-item" class:active={path === '/admin'}>
                <div class="nav-indicator"></div>
                <span class="icon">⚡</span>
                <span class="label">DASHBOARD</span>
            </a>
            <a href="/admin/news" class="nav-item" class:active={path.includes('/news')}>
                <div class="nav-indicator"></div>
                <span class="icon">📡</span>
                <span class="label">NEWS</span>
            </a>
            <a href="/admin/users" class="nav-item" class:active={path.includes('/users')}>
                <div class="nav-indicator"></div>
                <span class="icon">🧬</span>
                <span class="label">USERS</span>
            </a>
            <a href="/admin/tracker" class="nav-item" class:active={path.includes('/tracker')}>
                <div class="nav-indicator"></div>
                <span class="icon">🗺️</span>
                <span class="label">ROADMAP</span>
            </a>
             <!-- Кнопка выхода для мобилок (вместо отдельного блока) -->
             <a href="/" class="nav-item mobile-only text-red-500">
                <span class="icon">❌</span>
                <span class="label">EXIT</span>
            </a>
        </nav>

        <!-- Футер (Только ПК) -->
        <div class="bottom-actions desktop-only">
            <a href="/" class="exit-btn">EXIT GOD MODE</a>
        </div>
    </aside>

    <!-- CONTENT -->
    <main class="admin-viewport">
        <slot />
    </main>
</div>

<style>
    :global(body) { background: #050505; overflow: hidden; }

    .admin-universe {
        display: flex;
        width: 100vw; height: 100vh;
        background: radial-gradient(circle at 10% 20%, #0f172a 0%, #000000 100%);
        position: relative;
        overflow: hidden;
    }

    .ambient-glow {
        position: absolute; width: 600px; height: 600px;
        background: radial-gradient(circle, rgba(0, 243, 255, 0.15), transparent 70%);
        top: -200px; left: -200px; border-radius: 50%;
        filter: blur(80px); pointer-events: none; animation: breathe 10s infinite alternate;
    }
    @keyframes breathe { from { opacity: 0.5; transform: scale(1); } to { opacity: 0.8; transform: scale(1.2); } }

    /* === МОБИЛЬНЫЙ ХЕДЕР === */
    .mobile-header {
        display: none; /* По умолчанию скрыт */
        position: fixed; top: 0; left: 0; right: 0;
        height: 60px; z-index: 20;
        background: rgba(15, 20, 30, 0.8); backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255,255,255,0.1);
        align-items: center; justify-content: space-between; padding: 0 1.5rem;
    }
    .glitch-text.small { font-size: 1.2rem; }

    /* === SIDEBAR / BOTTOM BAR === */
    .glass-sidebar {
        width: 280px; height: 96vh;
        margin: 2vh 0 2vh 2vh;
        background: rgba(15, 20, 30, 0.6);
        backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 24px;
        display: flex; flex-direction: column;
        box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        z-index: 10;
    }

    .brand {
        padding: 2.5rem 2rem;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        display: flex; justify-content: space-between; align-items: center;
    }
    .glitch-text {
        font-family: 'Chakra Petch', sans-serif; font-weight: 800; font-size: 1.5rem;
        color: #fff; letter-spacing: 0.1em;
        text-shadow: 0 0 10px rgba(255,255,255,0.5);
    }
    .status-dot {
        width: 8px; height: 8px; background: #00f3ff;
        border-radius: 50%; box-shadow: 0 0 10px #00f3ff;
        animation: blink 2s infinite;
    }

    .nav-links { padding: 2rem 1.5rem; display: flex; flex-direction: column; gap: 1rem; flex-grow: 1; }

    .nav-item {
        position: relative; display: flex; align-items: center; gap: 1rem;
        padding: 1rem 1.5rem;
        color: #64748b; text-decoration: none;
        font-family: 'Chakra Petch', monospace; font-weight: 600; letter-spacing: 0.05em;
        border-radius: 16px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid transparent;
        overflow: hidden;
    }

    .nav-item:hover {
        background: rgba(255, 255, 255, 0.03);
        color: #e2e8f0;
    }

    .nav-item.active {
        background: rgba(0, 243, 255, 0.1);
        border-color: rgba(0, 243, 255, 0.2);
        color: #00f3ff;
        box-shadow: 0 0 30px rgba(0, 243, 255, 0.1);
    }

    .nav-indicator {
        position: absolute; left: 0; top: 50%; transform: translateY(-50%);
        width: 4px; height: 0%; background: #00f3ff;
        border-radius: 0 4px 4px 0; transition: height 0.3s;
        box-shadow: 0 0 10px #00f3ff;
    }
    .nav-item.active .nav-indicator { height: 60%; }

    .bottom-actions { padding: 2rem; border-top: 1px solid rgba(255,255,255,0.05); }

    .exit-btn {
        display: block; text-align: center; padding: 1rem;
        border: 1px solid rgba(255, 0, 60, 0.3); border-radius: 12px;
        color: #ff003c; font-family: 'Chakra Petch', monospace; font-weight: bold;
        text-decoration: none; transition: all 0.3s;
        background: rgba(255, 0, 60, 0.05);
    }
    .exit-btn:hover {
        background: rgba(255, 0, 60, 0.15);
        box-shadow: 0 0 20px rgba(255, 0, 60, 0.2);
        border-color: #ff003c;
    }

    .admin-viewport {
        flex-grow: 1; padding: 2rem 3rem;
        overflow-y: auto;
        scrollbar-width: thin; scrollbar-color: #334155 transparent;
    }

    .mobile-only { display: none; }

    /* === АДАПТИВНОСТЬ (MOBILE) === */
    @media (max-width: 768px) {
        .admin-universe { flex-direction: column; }

        .mobile-header { display: flex; }
        .desktop-only { display: none; }
        .mobile-only { display: flex; }

        .admin-viewport {
            padding: 80px 1rem 100px 1rem; /* Отступы под хедер и футер */
        }

        /* Превращаем Sidebar в Bottom Bar */
        .glass-sidebar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: auto; margin: 0;
            flex-direction: row;
            border-radius: 20px 20px 0 0; /* Скругляем только верх */
            border: none; border-top: 1px solid rgba(255,255,255,0.1);
            padding-bottom: env(safe-area-inset-bottom); /* Для iPhone */
        }

        .nav-links {
            flex-direction: row; width: 100%; justify-content: space-between;
            padding: 0.5rem 1rem; gap: 0;
        }

        .nav-item {
            flex-direction: column; padding: 0.5rem; gap: 4px;
            font-size: 0.6rem; border-radius: 8px;
            flex: 1; justify-content: center;
        }

        .nav-item .icon { font-size: 1.2rem; margin-bottom: 2px; }

        /* Индикатор снизу, а не сбоку */
        .nav-indicator {
            left: 50%; bottom: 0; top: auto; transform: translateX(-50%);
            width: 0%; height: 2px; border-radius: 2px 2px 0 0;
            transition: width 0.3s;
        }
        .nav-item.active .nav-indicator { width: 50%; height: 2px; }
    }
</style>
</file>

<file path="src/routes/admin/users/+page.server.ts">
// 👇 ДОБАВИЛ authAdmin В ИМПОРТЫ
import { firestoreAdmin, authAdmin } from '$lib/server/firebase.admin';
import { error, fail, redirect } from '@sveltejs/kit';
import type { Actions, PageServerLoad } from './$types';
import { ADMIN_UIDS } from '$env/static/private';
import { FieldValue } from 'firebase-admin/firestore';

const adminList = ADMIN_UIDS ? ADMIN_UIDS.split(',') : [];

export const load: PageServerLoad = async ({ locals }) => {
    if (!locals.user) {
        throw redirect(303, '/login');
    }

    if (!adminList.includes(locals.user.uid)) {
        throw error(403, 'ОТКАЗАНО В ДОСТУПЕ. Уровень допуска: "Смертный". Возвращайтесь в песочницу.');
    }

    return {
        user: locals.user
    };
};

export const actions: Actions = {
    search: async ({ request }) => {
        const data = await request.formData();
        const query = (data.get('query') as string).trim();

        if (!query) return fail(400, { message: 'Введите имя цели' });

        try {
            const usersRef = firestoreAdmin.collection('users');

            // Сначала ищем точное совпадение по username (самый частый кейс)
            const exactSnapshot = await usersRef.where('username', '==', query).limit(1).get();

            if (!exactSnapshot.empty) {
                const doc = exactSnapshot.docs[0];
                const userData = doc.data();
                return {
                    success: true,
                    target: {
                        uid: doc.id,
                        username: userData.username,
                        email: userData.email,
                        casino_credits: userData.casino_credits || 0,
                        avatar_url: userData.avatar_url,
                        owned_items: userData.owned_items || [],
                        isBanned: userData.isBanned || false
                    }
                };
            }

            // Если точно не нашли, ищем похожее (но аккуратно, чтобы не грузить базу)
            const snapshot = await usersRef
                .where('username', '>=', query)
                .where('username', '<=', query + '\uf8ff')
                .limit(5)
                .get();

            if (snapshot.empty) {
                return fail(404, { message: 'Цель не обнаружена в этом измерении.' });
            }

            const candidates = snapshot.docs.map(doc => ({
                username: doc.data().username,
                uid: doc.id,
                avatar_url: doc.data().avatar_url
            }));

            return { success: true, candidates };

        } catch (err) {
            console.error(err);
            return fail(500, { message: 'Ошибка сканирования базы данных.' });
        }
    },

    modifyCredits: async ({ request, locals }) => {
        if (!locals.user || !adminList.includes(locals.user.uid)) return fail(403);

        const data = await request.formData();
        const targetUid = data.get('uid') as string;
        const amount = parseInt(data.get('amount') as string);

        if (!targetUid || isNaN(amount)) return fail(400);

        try {
            await firestoreAdmin.collection('users').doc(targetUid).update({
                casino_credits: FieldValue.increment(amount)
            });
            return { actionSuccess: true, message: `Баланс изменен на ${amount > 0 ? '+' : ''}${amount} PC` };
        } catch (e) {
            return fail(500, { message: 'Ошибка транзакции' });
        }
    },

    grantAllItems: async ({ request, locals }) => {
        if (!locals.user || !adminList.includes(locals.user.uid)) return fail(403);

        const data = await request.formData();
        const targetUid = data.get('uid') as string;

        const allItems = [
            'frame_neon_blue', 'frame_glitch', 'frame_high_roller',
            'frame_biohazard', 'frame_plasma', 'frame_stealth',
            'frame_cryo', 'frame_festive', 'frame_aurora', 'frame_ludoman',
            'bg_carbon', 'bg_matrix', 'bg_synthwave'
        ];

        try {
            await firestoreAdmin.collection('users').doc(targetUid).update({
                owned_items: FieldValue.arrayUnion(...allItems)
            });
            return { actionSuccess: true, message: 'Выдан полный пакет кастомизации.' };
        } catch (e) {
            return fail(500, { message: 'Ошибка выдачи предметов' });
        }
    },

    banUser: async ({ request, locals }) => {
        if (!locals.user || !adminList.includes(locals.user.uid)) return fail(403);

        const data = await request.formData();
        const targetUid = data.get('uid') as string;
        const reason = data.get('reason') as string;

        try {
            // 1. Ставим "Клеймо" в токен (Custom Claim)
            await authAdmin.setCustomUserClaims(targetUid, { banned: true });

            // 2. Сбрасываем все текущие сессии (выкидываем из приложения)
            await authAdmin.revokeRefreshTokens(targetUid);

            // 3. Обновляем запись в БД
            await firestoreAdmin.collection('users').doc(targetUid).update({
                isBanned: true,
                banReason: reason || 'Нарушение протоколов сети.',
                bannedAt: FieldValue.serverTimestamp()
            });

            return { actionSuccess: true, message: 'СУБЪЕКТ ИЗОЛИРОВАН (TOKEN REVOKED).' };
        } catch (e: any) {
            console.error("Ban Error:", e);
            return fail(500, { message: 'Сбой протокола блокировки: ' + e.message });
        }
    },

    unbanUser: async ({ request, locals }) => {
        if (!locals.user || !adminList.includes(locals.user.uid)) return fail(403);
        const data = await request.formData();
        const targetUid = data.get('uid') as string;

        try {
            // 1. Снимаем клеймо
            await authAdmin.setCustomUserClaims(targetUid, { banned: false });

            // 2. Обновляем БД
            await firestoreAdmin.collection('users').doc(targetUid).update({
                isBanned: false,
                banReason: FieldValue.delete(),
                bannedAt: FieldValue.delete()
            });

            return { actionSuccess: true, message: 'СУБЪЕКТ ВОССТАНОВЛЕН В ПРАВАХ.' };
        } catch (e: any) {
            return fail(500, { message: 'Ошибка разблокировки: ' + e.message });
        }
    },

    migrate: async ({ request, locals }) => {
        if (!locals.user || !adminList.includes(locals.user.uid)) return fail(403);

        const data = await request.formData();
        const sourceUid = (data.get('sourceUid') as string).trim();
        const targetUid = (data.get('targetUid') as string).trim();

        if (!sourceUid || !targetUid || sourceUid === targetUid) {
            return fail(400, { message: 'Некорректные ID аккаунтов.' });
        }

        const sourceRef = firestoreAdmin.collection('users').doc(sourceUid);
        const targetRef = firestoreAdmin.collection('users').doc(targetUid);

        try {
            await firestoreAdmin.runTransaction(async (t) => {
                const sourceDoc = await t.get(sourceRef);
                const targetDoc = await t.get(targetRef);

                if (!sourceDoc.exists || !targetDoc.exists) {
                    throw new Error('Один из аккаунтов не найден.');
                }

                const sourceData = sourceDoc.data()!;
                const targetData = targetDoc.data()!;

                // Слияние данных
                const newCredits = (targetData.casino_credits || 0) + (sourceData.casino_credits || 0);
                const sourceItems = sourceData.owned_items || [];
                const targetItems = targetData.owned_items || [];
                const newItems = [...new Set([...sourceItems, ...targetItems])];
                const newStreak = Math.max(sourceData.daily_streak || 0, targetData.daily_streak || 0);
                const newAvatar = targetData.avatar_url || sourceData.avatar_url; // Оставляем целевой, если есть

                // Обновляем целевой
                t.update(targetRef, {
                    casino_credits: newCredits,
                    owned_items: newItems,
                    daily_streak: newStreak,
                    avatar_url: newAvatar,
                    migratedFrom: sourceUid,
                    migratedAt: FieldValue.serverTimestamp()
                });

                // Блокируем старый (Мягкий бан, без claims, просто пометка)
                // Или можно использовать banUser логику, но здесь достаточно флагов БД
                t.update(sourceRef, {
                    casino_credits: 0,
                    daily_streak: 0,
                    isBanned: true,
                    banReason: `MIGRATED TO: ${targetUid}`,
                    username: `MIGRATED_${sourceData.username}`,
                    status: "ACCOUNT_TRANSFER_COMPLETE"
                });
            });

            // Перенос локаций (отдельно, так как Query не работает в транзакции так просто)
            const locQuery = await firestoreAdmin.collection('locations').where('user_id', '==', sourceUid).get();
            if (!locQuery.empty) {
                const batch = firestoreAdmin.batch();
                locQuery.docs.forEach(doc => {
                    batch.update(doc.ref, { user_id: targetUid });
                });
                await batch.commit();
            }

            return { actionSuccess: true, message: `Миграция успешна! ${sourceUid} -> ${targetUid}` };

        } catch (e: any) {
            console.error("Migration Error:", e);
            return fail(500, { message: `Ошибка: ${e.message}` });
        }
    }
};
</file>

<file path="src/routes/casino/inventory/+page.server.ts">
import { firestoreAdmin } from '$lib/server/firebase.admin';
import type { PageServerLoad } from './$types';
import { error, redirect } from '@sveltejs/kit';

export type ShopItem = {
    id: string;
    name: string;
    description: string;
    price: number;
    type: 'frame' | 'badge';
    style_value: string;
};

export const load: PageServerLoad = async ({ locals }) => {
    if (!locals.user) {
        throw redirect(303, '/login');
    }
    const uid = locals.user.uid;

    try {
        const userDocRef = firestoreAdmin.collection('users').doc(uid);
        const itemsRef = firestoreAdmin.collection('shop_items');
        const [userDocSnap, itemsSnapshot] = await Promise.all([
            userDocRef.get(),
            itemsRef.get()
        ]);

        if (!userDocSnap.exists) {
            throw error(404, 'Профиль не найден');
        }

        const allItems: { [id: string]: ShopItem } = {};
        itemsSnapshot.forEach(doc => {
            const data = doc.data();
            allItems[doc.id] = {
                id: doc.id,
                name: data.name,
                description: data.description,
                price: data.price,
                type: data.type,
                style_value: data.style_value
            };
        });

        const userData = userDocSnap.data()!;

        return {
            ownedItemIds: userData.owned_items || [],
            equippedFrame: userData.equipped_frame || null,
            equippedBg: userData.equipped_bg || null,
            allItems: allItems
        };

    } catch (e) {
        console.error("Ошибка загрузки инвентаря:", e);
        throw error(500, "Не удалось загрузить инвентарь");
    }
};
</file>

<file path="src/routes/casino/shop/+page.svelte">
<script lang="ts">
    import type { PageData } from './$types';
    import { userStore } from '$lib/stores';
    import { onMount } from 'svelte';
    import { quintOut } from 'svelte/easing';
    import { tweened } from 'svelte/motion';
    import { getFunctions, httpsCallable } from 'firebase/functions';
    import { modal } from '$lib/stores/modalStore';
    import { Howl } from 'howler';
    import { t } from 'svelte-i18n';
    import { get } from 'svelte/store';
    import { fade } from 'svelte/transition';

    export let data: PageData;

    let purchasingItemId: string | null = null;
    let ownedItems = new Set(data.ownedItemIds || []);

    // === НОВОЕ: ТАБЫ ===
    let activeCategory: 'frame' | 'background' = 'frame';

    // Фильтруем товары на лету
    $: visibleItems = data.items.filter(item => item.type === activeCategory);

    // Хелпер для перевода
    const translate = (key: string) => get(t)(key);

    function getRandomQuote(category: 'greeting' | 'confirm' | 'success'): string {
        const quotes = get(t)(`shop.quotes.${category}`, { returnObjects: true }) as string[];
        if (Array.isArray(quotes) && quotes.length > 0) {
            return quotes[Math.floor(Math.random() * quotes.length)];
        }
        return "> ...";
    }

    userStore.subscribe(store => {
        if (store.user && store.user.owned_items) {
            const newOwnedItems = new Set(store.user.owned_items);
            if (newOwnedItems.size !== ownedItems.size) {
                ownedItems = newOwnedItems;
            }
        }
    });

    const displayedCredits = tweened($userStore.user?.casino_credits || 0, { duration: 500, easing: quintOut });
    $: if ($userStore.user) { displayedCredits.set($userStore.user.casino_credits); }

    let sounds: { [key: string]: Howl } = {};
    let dealerMessage = "";

    onMount(() => {
        sounds.ambient = new Howl({ src: ['/sounds/ambient_casino.mp3'], loop: true, volume: 0.2, autoplay: true });
        sounds.purchase = new Howl({ src: ['/sounds/purchase.mp3'], volume: 0.8 });
        sounds.click = new Howl({ src: ['/sounds/click.mp3'], volume: 0.5 }); // Звук клика для табов
        dealerMessage = getRandomQuote('greeting');
        return () => { sounds.ambient?.stop(); };
    });

    function switchCategory(cat: 'frame' | 'background') {
        if (activeCategory === cat) return;
        sounds.click?.play();
        activeCategory = cat;
    }

    async function purchaseItem(itemId: string, itemName: string, itemPrice: number) {
        if (purchasingItemId) return;

        const confirmQuote = getRandomQuote('confirm');
        const confirmText = `
            ${confirmQuote}<br><br>
            ${translate('shop.modal_confirm_prefix')}
            <strong>${itemName}</strong>
            ${translate('shop.modal_confirm_suffix')}
            <span class="font-display text-cyber-yellow">${itemPrice} PC</span>?
        `;

        modal.confirm(translate('shop.modal_confirm_title'), confirmText, async () => {
            purchasingItemId = itemId;
            dealerMessage = translate('shop.dealer_processing');

            try {
                const functions = getFunctions();
                const purchaseFunc = httpsCallable(functions, 'purchaseShopItem');
                await purchaseFunc({ itemId });

                sounds.purchase?.play();

                userStore.update(store => {
                    if (store.user) {
                        store.user.casino_credits -= itemPrice;
                        store.user.owned_items = [...(store.user.owned_items || []), itemId];
                    }
                    return store;
                });

                const successQuote = getRandomQuote('success');
                dealerMessage = successQuote;
                const successText = `${translate('shop.modal_success_prefix')} "<strong>${itemName}</strong>" ${translate('shop.modal_success_suffix')}`;
                modal.success(translate('shop.modal_success_title'), successText);

            } catch (error: any) {
                dealerMessage = translate('shop.dealer_error');
                modal.error(translate('shop.modal_error_title'), error.message || "Error.");
            } finally {
                purchasingItemId = null;
            }
        });
    }
</script>

<svelte:head>
    <title>{$t('shop.title')} | The Glitch Pit</title>
</svelte:head>

<div class="page-container">
    <div class="bg-blur-1"></div>
    <div class="bg-blur-2"></div>

    <div class="market-header">
        <img src="/casino/orioncasino.png" alt="Торговец Орион" class="dealer-art"/>
        <div class="dealer-dialogue">
            <p>{dealerMessage}</p>
        </div>
    </div>

    <div class="user-panel">
        <div class="balance-display">
            <span class="label font-display">{$t('shop.balance_label')}</span>
            <span class="amount font-display">{Math.floor($displayedCredits)} PC</span>
        </div>
        <div class="actions-group">
             <a href="/casino/inventory" class="panel-btn inventory">{$t('shop.btn_inventory')}</a>
             <a href="/casino" class="panel-btn lobby">{$t('shop.btn_lobby')}</a>
        </div>
    </div>

    <!-- === ТАБЫ КАТЕГОРИЙ === -->
    <div class="shop-tabs">
        <button
            class="shop-tab"
            class:active={activeCategory === 'frame'}
            on:click={() => switchCategory('frame')}
        >
            {$t('shop.tab_frames')}
        </button>
        <button
            class="shop-tab"
            class:active={activeCategory === 'background'}
            on:click={() => switchCategory('background')}
        >
            {$t('shop.tab_backgrounds')}
        </button>
    </div>

    <div class="items-grid">
        {#each visibleItems as item (item.id)}
            <div
                class="item-card"
                class:owned={ownedItems.has(item.id)}
                class:purchasing={purchasingItemId === item.id}
                in:fade={{ duration: 200 }}
            >
                <div class="item-preview">
                    <!-- ЕСЛИ РАМКА -->
                    {#if item.type === 'frame'}
                        <div class="avatar-wrapper {item.id}">
                            <div class="avatar-placeholder"></div>
                        </div>
                    <!-- ЕСЛИ ФОН -->
                    {:else if item.type === 'background'}
                        <div class="bg-preview-box {item.id}">
                            <!-- Мини-контент для демонстрации фона -->
                            <div class="mini-profile">
                                <div class="mini-avatar"></div>
                                <div class="mini-name">User</div>
                            </div>
                        </div>
                    {/if}
                </div>

                <div class="item-info">
                    <h3 class="item-name font-display">{item.name}</h3>
                    <p class="item-desc">{item.description}</p>
                </div>

                <div class="item-footer">
                    <span class="item-price font-display">{item.price} PC</span>
                    {#if ownedItems.has(item.id)}
                        <button class="panel-btn" disabled>{$t('shop.btn_owned')}</button>
                    {:else if !$userStore.user || $userStore.user.casino_credits < item.price}
                        <button class="panel-btn" disabled>{$t('shop.btn_poor')}</button>
                    {:else}
                        <button
                            class="panel-btn shop"
                            on:click={() => purchaseItem(item.id, item.name, item.price)}
                            disabled={purchasingItemId !== null}
                        >
                            {purchasingItemId === item.id ? $t('shop.processing') : $t('shop.btn_buy')}
                        </button>
                    {/if}
                </div>
            </div>
        {/each}

        {#if visibleItems.length === 0}
            <div class="empty-message">{$t('shop.empty_category')}</div>
        {/if}
    </div>
</div>

<style>
    @keyframes float-blur-1 { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(100px, 50px); } }
    @keyframes float-blur-2 { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(-80px, -60px); } }

    .page-container {
        min-height: calc(100vh - 64px);
        display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
        position: relative; overflow: hidden; background: #0a0a0a; padding: 2rem;
    }
    .bg-blur-1, .bg-blur-2 { position: absolute; width: 400px; height: 400px; border-radius: 50%; filter: blur(150px); pointer-events: none; z-index: 0; }
    .bg-blur-1 { background: var(--cyber-red); top: 10%; left: 10%; animation: float-blur-1 20s infinite ease-in-out; }
    .bg-blur-2 { background: var(--cyber-cyan); bottom: 10%; right: 10%; animation: float-blur-2 25s infinite ease-in-out; }

    .market-header { text-align: center; margin-bottom: 2rem; z-index: 2; }
    .dealer-art { max-width: 350px; max-height: 220px; margin: 0 auto; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5)); }
    .dealer-dialogue {
        background: rgba(10,10,10,0.7); border: 1px solid var(--border-color);
        padding: 0.5rem 1.5rem; display: inline-block; margin-top: -1.5rem;
        position: relative; font-family: 'Chakra Petch', monospace; color: #ddd;
        max-width: 90%;
    }

    .user-panel {
        width: 100%; max-width: 900px;
        display: flex; justify-content: space-between; align-items: center;
        background: rgba(20, 20, 25, 0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 1rem;
        padding: 1rem 1.5rem; margin-bottom: 2rem;
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); z-index: 2;
        gap: 1rem;
    }
    .balance-display { font-size: 1.5rem; flex-shrink: 0; }
    .balance-display .label { color: var(--text-muted-color); margin-right: 0.5rem; }
    .balance-display .amount { color: var(--cyber-yellow); letter-spacing: 0.1em; }

    .actions-group { display: flex; gap: 1rem; }
    .panel-btn {
        padding: 0.75rem 1.5rem; font-family: 'Chakra Petch', monospace; font-weight: bold;
        color: rgba(255, 255, 255, 0.8); text-transform: uppercase; letter-spacing: 0.05em;
        text-decoration: none; text-align: center;
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
        border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 0.75rem;
        box-shadow: -4px -4px 8px rgba(255, 255, 255, 0.05), 4px 4px 8px rgba(0, 0, 0, 0.3), inset 1px 1px 1px rgba(255, 255, 255, 0.1);
        transition: all 0.2s ease-in-out;
        white-space: nowrap;
    }
    .panel-btn:hover:not(:disabled) { color: #fff; transform: translateY(-2px); }
    .panel-btn:active:not(:disabled) { transform: translateY(1px); box-shadow: inset 2px 2px 5px rgba(0,0,0,0.5); }
    .panel-btn.inventory:hover:not(:disabled) { box-shadow: -4px -4px 8px rgba(255, 255, 255, 0.05), 4px 4px 8px rgba(0, 0, 0, 0.3), inset 1px 1px 1px rgba(255, 255, 255, 0.1), 0 0 20px var(--cyber-cyan); }
    .panel-btn.shop:hover:not(:disabled) { box-shadow: -4px -4px 8px rgba(255, 255, 255, 0.05), 4px 4px 8px rgba(0, 0, 0, 0.3), inset 1px 1px 1px rgba(255, 255, 255, 0.1), 0 0 20px var(--cyber-yellow); }
    .panel-btn.lobby:hover:not(:disabled) { box-shadow: -4px -4px 8px rgba(255, 255, 255, 0.05), 4px 4px 8px rgba(0, 0, 0, 0.3), inset 1px 1px 1px rgba(255, 255, 255, 0.1), 0 0 20px var(--cyber-purple); }
    .panel-btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

    .shop-tabs {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
        gap: 1rem;
        z-index: 5;
    }

    .shop-tab {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #888;
        padding: 0.8rem 2rem;
        font-family: 'Chakra Petch', monospace;
        font-weight: bold;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s;
        border-radius: 4px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }

    .shop-tab:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #ccc;
    }

    .shop-tab.active {
        background: rgba(0, 243, 255, 0.1);
        border-color: var(--cyber-cyan);
        color: var(--cyber-cyan);
        box-shadow: 0 0 15px rgba(0, 243, 255, 0.2);
    }

    .items-grid {
        width: 100%; max-width: 1200px;
        display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 2rem; z-index: 2;
    }
    .item-card {
        background: rgba(20, 20, 25, 0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 1rem;
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        display: flex; flex-direction: column; overflow: hidden;
        transition: transform 0.3s, box-shadow 0.3s;
    }
    .item-card:hover:not(.owned) { transform: translateY(-5px); box-shadow: 0 12px 40px 0 rgba(0,0,0,0.5), 0 0 20px var(--cyber-yellow); }
    .item-card.owned { filter: grayscale(0.8) brightness(0.6); }
    .item-card.purchasing { filter: brightness(0.8); pointer-events: none; }

    .item-preview {
        height: 180px; background: #111;
        display: flex; align-items: center; justify-content: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.15);
    }
    .avatar-wrapper {
        position: relative;
        width: 100px;
        height: 100px;
        border-radius: 50%;
    }
    .avatar-placeholder {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background-color: #333;
    }

    .bg-preview-box {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .mini-profile {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        pointer-events: none;
    }
    .mini-avatar {
        width: 40px; height: 40px;
        background: #555;
        border-radius: 50%;
    }
    .mini-name {
        font-size: 0.7rem;
        font-weight: bold;
    }

    .bg_matrix .mini-name { color: #00ff00; text-shadow: 0 0 5px #00ff00; }
    .bg_synthwave .mini-name { color: #00f3ff; text-shadow: 0 0 5px #00f3ff; }
    .bg_carbon .mini-name { color: #fff; text-shadow: 1px 1px 0 #000; }

    .item-info { padding: 1rem; text-align: center; flex-grow: 1; }
    .item-name { font-size: 1.5rem; color: #fff; margin-bottom: 0.5rem; }
    .item-desc { font-size: 0.9rem; color: var(--text-muted-color); line-height: 1.5; }

    .item-footer {
        padding: 1rem;
        border-top: 1px solid rgba(255, 255, 255, 0.15);
        display: flex; justify-content: space-between; align-items: center;
        background: rgba(0,0,0,0.2);
    }
    .item-price { font-size: 1.25rem; color: var(--cyber-yellow); font-weight: bold; }

    .empty-message {
        width: 100%;
        text-align: center;
        color: #666;
        font-family: 'Chakra Petch', monospace;
        margin-top: 2rem;
        grid-column: 1 / -1;
    }

    @media (max-width: 768px) {
        .user-panel { flex-direction: column; gap: 1rem; }
        .actions-group { width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
        .panel-btn { font-size: 0.8rem; padding: 0.6rem; }
        .items-grid { grid-template-columns: 1fr; }
    }
</style>
</file>

<file path="src/routes/news/+page.svelte">
<script lang="ts">
    import type { PageData } from './$types';
    import { fade, fly } from 'svelte/transition';
    import { onMount } from 'svelte';
    import { quintOut } from 'svelte/easing';
    import { tweened } from 'svelte/motion';
    import { t, locale } from 'svelte-i18n';
    import { marked } from 'marked'; // <--- ИМПОРТИРУЕМ БИБЛИОТЕКУ

    export let data: PageData;

    const opacity = tweened(0, { duration: 400, easing: quintOut });
    onMount(() => { opacity.set(1); });

    $: currentLang = $locale?.substring(0, 2) || 'ru';

    $: filteredNews = data.news.filter(post => {
        const postLang = post.lang || 'ru';
        return postLang === currentLang;
    });

    function formatDate(date: Date, currentLocale: string | null | undefined) {
        return new Intl.DateTimeFormat(currentLocale || 'ru', {
            day: 'numeric', month: 'long', year: 'numeric'
        }).format(date);
    }

    // Функция рендеринга Markdown
    function renderContent(content: string): string {
        // Настройки: breaks = true (энтер = новая строка)
        return marked.parse(content, { breaks: true, gfm: true }) as string;
    }
</script>

<svelte:head>
    <title>{$t('news_page.title')} | ProtoMap</title>
</svelte:head>

<div class="page-container" style="opacity: {$opacity}">
    <div class="header">
        <h1 class="title font-display glitch" data-text={$t('news_page.title')}>{$t('news_page.title')}</h1>
        <p class="subtitle">{$t('news_page.subtitle')}</p>
    </div>

    <div class="news-feed">
        {#if filteredNews.length > 0}
            {#each filteredNews as post, i (post.id)}
                <article class="news-card cyber-panel" in:fly="{{ y: 20, delay: i * 100, duration: 500 }}">
                    {#if post.image}
                        <div class="card-image">
                            <img src={post.image} alt={post.title} loading="lazy" />
                            <div class="image-overlay"></div>
                        </div>
                    {/if}

                    <div class="card-content">
                        <div class="meta">
                            <span class="date">{formatDate(post.createdAt, $locale)}</span>
                            {#if post.tags}
                                <div class="tags">
                                    {#each post.tags as tag}
                                        <span class="tag">#{tag}</span>
                                    {/each}
                                </div>
                            {/if}
                        </div>

                        <h2 class="post-title font-display">{post.title}</h2>

                        <!-- СЮДА ВСТАВЛЯЕМ ОТФОРМАТИРОВАННЫЙ HTML -->
                        <div class="post-text markdown-body">
                            {@html renderContent(post.content)}
                        </div>
                    </div>
                </article>
            {/each}
        {:else}
            <div class="empty-state">
                <p>{$t('news_page.empty')}</p>
                <p class="text-xs text-gray-600 mt-2">LANGUAGE_SECTOR: {currentLang.toUpperCase()}</p>
            </div>
        {/if}
    </div>
</div>

<style>
    /* ... (Стили контейнера, шапки и карточки остаются прежними) ... */

    .page-container { max-width: 800px; margin: 0 auto; padding: 2rem 1rem; min-height: 100vh; }
    .header { text-align: center; margin-bottom: 3rem; }
    .title { font-size: 3rem; margin-bottom: 0.5rem; }
    .subtitle { color: var(--text-muted-color); font-family: 'Chakra Petch', monospace; }
    .news-feed { display: flex; flex-direction: column; gap: 2rem; }
    .news-card { background: rgba(10, 15, 20, 0.7); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 0.5rem; overflow: hidden; transition: transform 0.3s, border-color 0.3s, box-shadow 0.3s; }
    .news-card:hover { transform: translateY(-5px); border-color: var(--cyber-yellow); box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5), 0 0 15px rgba(252, 238, 10, 0.2); }
    .card-image { position: relative; height: 200px; overflow: hidden; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .card-image img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
    .news-card:hover .card-image img { transform: scale(1.05); }
    .image-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(10,15,20,1), transparent); opacity: 0.6; }
    .card-content { padding: 1.5rem; }
    .meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; font-size: 0.85rem; }
    .date { color: var(--text-muted-color); font-family: 'Chakra Petch', monospace; }
    .tags { display: flex; gap: 0.5rem; }
    .tag { color: var(--cyber-cyan); background: rgba(0, 240, 255, 0.1); padding: 2px 8px; border-radius: 4px; border: 1px solid rgba(0, 240, 255, 0.2); font-family: 'Chakra Petch', monospace; }
    .post-title { font-size: 1.8rem; color: #fff; margin-bottom: 1rem; line-height: 1.2; }
    .empty-state { text-align: center; color: #666; padding: 4rem; font-family: 'Chakra Petch', monospace; }

    /* === МАГИЯ MARKDOWN СТИЛЕЙ === */
    /* Используем :global(), чтобы стили применились к HTML, который сгенерировал marked */

    .markdown-body :global(p) {
        margin-bottom: 1rem;
        line-height: 1.7;
        color: #d1d5db;
    }

    .markdown-body :global(strong) {
        color: var(--cyber-yellow);
        font-weight: 800;
        text-shadow: 0 0 5px rgba(252, 238, 10, 0.3);
    }

    .markdown-body :global(em) {
        color: var(--cyber-cyan);
        font-style: italic;
    }

    .markdown-body :global(a) {
        color: var(--cyber-cyan);
        text-decoration: none;
        border-bottom: 1px dashed var(--cyber-cyan);
        transition: all 0.2s;
    }
    .markdown-body :global(a:hover) {
        color: #fff;
        border-bottom-style: solid;
        text-shadow: 0 0 8px var(--cyber-cyan);
    }

    .markdown-body :global(h3), .markdown-body :global(h4) {
        color: #fff;
        font-family: 'Chakra Petch', monospace;
        margin-top: 2rem;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .markdown-body :global(ul), .markdown-body :global(ol) {
        margin-bottom: 1.5rem;
        padding-left: 1rem;
    }

    .markdown-body :global(li) {
        position: relative;
        padding-left: 1.5rem;
        margin-bottom: 0.5rem;
        color: #ccc;
    }

    /* Кибер-буллит для списка */
    .markdown-body :global(li::before) {
        content: '>';
        position: absolute;
        left: 0;
        color: var(--cyber-yellow);
        font-weight: bold;
    }

    .markdown-body :global(blockquote) {
        border-left: 3px solid var(--cyber-purple);
        background: rgba(189, 0, 255, 0.1);
        padding: 1rem;
        margin: 1.5rem 0;
        color: #e0e0e0;
        font-style: italic;
    }

    .markdown-body :global(code) {
        background: rgba(0,0,0,0.5);
        border: 1px solid #444;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: monospace;
        color: #ff003c;
    }

    @media (max-width: 640px) {
        .title { font-size: 2rem; }
        .card-image { height: 150px; }
        .post-title { font-size: 1.4rem; }
    }
</style>
</file>

<file path="src/routes/reset-password/+page.svelte">
<script lang="ts">
    import { auth } from "$lib/firebase";
    import { confirmPasswordReset, verifyPasswordResetCode } from "firebase/auth";
    import { onMount } from "svelte";
    import { page } from "$app/stores";
    import { goto } from "$app/navigation";
    import NeonButton from "$lib/components/NeonButton.svelte";
    import { modal } from "$lib/stores/modalStore";
    import { fade } from "svelte/transition";
    import { t } from "svelte-i18n";
    import { get } from "svelte/store";

    let newPassword = "";
    let loading = false;
    let code = "";
    let email = "";
    let isCodeValid = false;
    let isCheckingCode = true;

    // Хелпер для перевода внутри JS
    const translate = (key: string) => get(t)(key);

    onMount(async () => {
        code = $page.url.searchParams.get("oobCode") || "";

        if (!code) {
            modal.error(translate('reset.error_modal_title'), translate('reset.error_missing_code'));
            goto("/");
            return;
        }

        try {
            email = await verifyPasswordResetCode(auth, code);
            isCodeValid = true;
        } catch (error) {
            console.error("Invalid code", error);
            modal.error(translate('reset.error_expired_title'), translate('reset.error_expired_desc'));
            goto("/login");
        } finally {
            isCheckingCode = false;
        }
    });

    async function handlePasswordReset() {
        if (newPassword.length < 6) {
            modal.error(translate('reset.error_modal_title'), translate('reset.weak_password'));
            return;
        }

        loading = true;
        try {
            await confirmPasswordReset(auth, code, newPassword);

            modal.success(translate('reset.success_title'), translate('reset.success_desc'));
            setTimeout(() => {
                goto("/login");
            }, 2000);
        } catch (error: any) {
            console.error("Reset error", error);
            modal.error(translate('reset.error_modal_title'), error.message || translate('reset.error_generic'));
        } finally {
            loading = false;
        }
    }
</script>

<svelte:head>
    <title>{$t('reset.page_title')} | ProtoMap</title>
</svelte:head>

<div class="page-container">
    <div class="form-container cyber-panel" in:fade>
        <div class="corner top-left"></div>
        <div class="corner top-right"></div>
        <div class="corner bottom-left"></div>
        <div class="corner bottom-right"></div>

        <h2 class="form-title font-display">{$t('reset.header')}</h2>

        {#if isCheckingCode}
            <p class="text-center text-gray-400 animate-pulse">{$t('reset.checking')}</p>
        {:else if isCodeValid}
            <p class="text-center text-sm text-gray-400 mb-6">
                {$t('reset.instruction')} <br>
                <span class="text-cyber-yellow font-bold">{email}</span>
            </p>

            <form on:submit|preventDefault={handlePasswordReset} class="space-y-6">
                <div class="form-group">
                    <label for="new-password" class="form-label font-display">{$t('reset.label')}</label>
                    <input
                        bind:value={newPassword}
                        type="password"
                        id="new-password"
                        class="input-field"
                        placeholder="••••••"
                        required
                    >
                </div>

                <NeonButton type="submit" disabled={loading} extraClass="w-full">
                    {loading ? $t('reset.btn_applying') : $t('reset.btn_save')}
                </NeonButton>
            </form>
        {:else}
            <div class="text-center">
                <p class="text-red-500 mb-4">{$t('reset.error_link')}</p>
                <a href="/login" class="text-cyber-yellow hover:underline">{$t('auth.back_to_login')}</a>
            </div>
        {/if}
    </div>
</div>

<style>
    .page-container {
        min-height: calc(100vh - 64px);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }
    .form-container {
        @apply max-w-md w-full p-8 rounded-none shadow-2xl relative;
        background: rgba(10, 10, 10, 0.6);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(252, 238, 10, 0.2);
        clip-path: polygon(0 15px, 15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%);
    }

    .form-title {
        @apply text-2xl font-bold text-center text-white mb-6;
        text-shadow: 0 0 10px rgba(252, 238, 10, 0.5);
    }

    .form-label {
        @apply block text-sm font-bold uppercase tracking-widest text-cyber-yellow mb-2;
    }

    .input-field {
        @apply block w-full p-2 bg-transparent text-gray-200;
        border: none;
        border-bottom: 1px solid var(--border-color, #30363d);
        border-radius: 0;
        font-family: 'Inter', sans-serif;
        font-size: 1.1em;
        transition: border-color 0.3s, box-shadow 0.3s;
    }

    .input-field:focus {
        @apply outline-none;
        border-bottom-color: var(--cyber-yellow, #fcee0a);
        box-shadow: 0 1px 0 var(--cyber-yellow, #fcee0a);
    }

    .corner { position: absolute; width: 10px; height: 10px; border-color: var(--cyber-yellow); transition: all 0.3s; }
    .top-left { top: 0; left: 0; border-top: 2px solid; border-left: 2px solid; }
    .top-right { top: 0; right: 0; border-top: 2px solid; border-right: 2px solid; }
    .bottom-left { bottom: 0; left: 0; border-bottom: 2px solid; border-left: 2px solid; }
    .bottom-right { bottom: 0; right: 0; border-bottom: 2px solid; border-right: 2px solid; }
</style>
</file>

<file path="src/routes/verify-email/+page.svelte">
<script lang="ts">
    import { onMount } from 'svelte';
    import { page } from '$app/stores';
    import { auth } from '$lib/firebase';
    import { applyActionCode } from 'firebase/auth';
    import { goto } from '$app/navigation';
    import NeonButton from '$lib/components/NeonButton.svelte';
    import { fade, scale } from 'svelte/transition';
    import { t, locale } from 'svelte-i18n'; // Импортируем locale

    let status: 'loading' | 'success' | 'error' = 'loading';
    let messageKey = 'verify.init';

    onMount(async () => {
        // 1. Принудительная установка языка из URL (если i18n не подхватил)
        const urlLang = $page.url.searchParams.get('lang');
        if (urlLang === 'ru' || urlLang === 'en') {
            locale.set(urlLang);
        }

        const code = $page.url.searchParams.get('oobCode');

        if (!code) {
            status = 'error';
            messageKey = 'verify.error_no_code';
            return;
        }

        try {
            // 2. Применяем код (это работает даже без логина)
            await applyActionCode(auth, code);

            // 3. Если юзер залогинен в этом браузере — обновляем его статус
            if (auth.currentUser) {
                await auth.currentUser.reload();
                // Также обновляем токен, чтобы claims обновились
                await auth.currentUser.getIdToken(true);
            }

            status = 'success';
            messageKey = 'verify.success';

            // 4. Умный редирект
            setTimeout(() => {
                if (auth.currentUser) {
                    // Если залогинен — домой
                    goto('/');
                } else {
                    // Если не залогинен (открыл в другом браузере) — на вход
                    goto('/login');
                }
            }, 4000);

        } catch (error: any) {
            console.error("Verification error:", error);
            status = 'error';
            if (error.code === 'auth/invalid-action-code') {
                messageKey = 'verify.error_invalid';
            } else if (error.code === 'auth/expired-action-code') {
                messageKey = 'verify.error_expired';
            } else {
                messageKey = 'verify.error_generic';
            }
        }
    });
</script>

<svelte:head>
    <title>{$t('verify.page_title')} | ProtoMap</title>
</svelte:head>

<div class="page-container">
    <div class="verification-terminal cyber-panel" in:fade>
        <div class="corner top-left"></div>
        <div class="corner top-right"></div>
        <div class="corner bottom-left"></div>
        <div class="corner bottom-right"></div>

        <!-- АНИМИРОВАННЫЙ СКАНЕР -->
        <div class="scanner-container">
            <div class="scanner-line" class:error={status === 'error'} class:success={status === 'success'}></div>
        </div>

        <h1 class="title font-display">
            {#if status === 'loading'}
                {$t('verify.header_loading')}
            {:else if status === 'success'}
                {$t('verify.header_success')}
            {:else}
                {$t('verify.header_error')}
            {/if}
        </h1>

        <p class="status-message font-mono" class:text-red-500={status === 'error'} class:text-green-400={status === 'success'}>
            > {$t(messageKey)}<span class="blink">_</span>
        </p>

        {#if status !== 'loading'}
            <div class="action-area" in:scale>
                <NeonButton href="/">
                    {$t('verify.btn_return')}
                </NeonButton>
            </div>
        {/if}
    </div>
</div>

<style>
    .page-container {
        min-height: calc(100vh - 64px);
        display: flex; align-items: center; justify-content: center; padding: 1rem;
    }

    .verification-terminal {
        @apply max-w-md w-full p-8 relative text-center;
        background: rgba(10, 12, 15, 0.9);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        clip-path: polygon(0 20px, 20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%);
    }

    .title {
        font-size: 1.5rem; font-weight: bold; color: #fff;
        margin-bottom: 1.5rem; text-shadow: 0 0 10px rgba(255,255,255,0.3);
    }

    .status-message {
        color: #94a3b8; margin-bottom: 2rem; min-height: 3rem;
    }
    .status-message.text-red-500 { color: #ef4444; text-shadow: 0 0 10px rgba(239, 68, 68, 0.4); }
    .status-message.text-green-400 { color: #4ade80; text-shadow: 0 0 10px rgba(74, 222, 128, 0.4); }

    .scanner-container {
        width: 100%; height: 4px; background: rgba(255,255,255,0.1);
        margin-bottom: 2rem; position: relative; overflow: hidden;
    }
    .scanner-line {
        width: 30%; height: 100%; background: var(--cyber-yellow, #00f0ff);
        box-shadow: 0 0 10px var(--cyber-yellow, #00f0ff);
        position: absolute; animation: scan 2s infinite linear;
    }
    .scanner-line.success { background: #4ade80; box-shadow: 0 0 10px #4ade80; width: 100%; animation: none; }
    .scanner-line.error { background: #ef4444; box-shadow: 0 0 10px #ef4444; width: 100%; animation: none; }

    @keyframes scan { 0% { left: -30%; } 100% { left: 100%; } }
    .blink { animation: blink 1s infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

    .corner { position: absolute; width: 15px; height: 15px; border-color: var(--cyber-yellow); transition: all 0.3s; }
    .top-left { top: 0; left: 0; border-top: 2px solid; border-left: 2px solid; }
    .top-right { top: 0; right: 0; border-top: 2px solid; border-right: 2px solid; }
    .bottom-left { bottom: 0; left: 0; border-bottom: 2px solid; border-left: 2px solid; }
    .bottom-right { bottom: 0; right: 0; border-bottom: 2px solid; border-right: 2px solid; }
</style>
</file>

<file path="src/styles/winter.css">
:root {
    --cyber-yellow: #00f3ff;
    --cyber-red: #0077ff;
    --text-color: #e0f7fa;
    scrollbar-color: #00f3ff #051015;
}

body {
    background-color: #02050a;
    background-image:
        radial-gradient(circle at 50% 0%, rgba(0, 243, 255, 0.1), transparent 70%),
        linear-gradient(to bottom, #02050a 0%, #051015 100%);
}

body::before {
    content: "";
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none;
    z-index: 900;
    box-shadow: inset 0 0 100px rgba(0, 243, 255, 0.15);
    background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
    mix-blend-mode: screen;
    opacity: 0.8;
}

.cyber-panel,
.user-panel,
.game-card,
.form-container {
    background: rgba(5, 15, 25, 0.75) !important;
    border: 1px solid rgba(0, 243, 255, 0.25) !important;
    box-shadow:
        0 0 15px rgba(0, 243, 255, 0.05),
        inset 0 0 30px rgba(0, 243, 255, 0.05) !important;
    backdrop-filter: blur(8px) brightness(1.1) !important;
}

.font-display, .title, .nav-brand, h1, h2, h3 {
    text-shadow:
        0 0 5px rgba(0, 243, 255, 0.8),
        0 0 15px rgba(0, 243, 255, 0.4) !important;
    color: #fff !important;
}

.glitch::before { text-shadow: -2px 0 #fff !important; }
.glitch::after { text-shadow: 2px 0 #0077ff !important; }

.reactor-core {
    background: #001520 !important;
    border-color: #00f3ff !important;
    box-shadow: 0 0 10px #00f3ff, inset 0 0 5px #00f3ff !important;
}
.reactor-core .count {
    color: #fff !important;
    text-shadow: 0 0 5px #00f3ff;
}
.reactor-ring {
    border-color: transparent !important;
    border-top-color: rgba(0, 243, 255, 0.6) !important;
    filter: drop-shadow(0 0 2px #00f3ff);
}
.reactor-glow {
    background: radial-gradient(circle, rgba(0, 243, 255, 0.3) 0%, transparent 70%) !important;
    box-shadow: none !important;
}

nav {
    border-bottom: 1px solid rgba(0, 243, 255, 0.2) !important;
}

.spider-scene { display: none; }

.panel-btn, .neon-btn {
    border-color: rgba(0, 243, 255, 0.5) !important;
    background: linear-gradient(180deg, rgba(0, 243, 255, 0.1), transparent) !important;
    color: #fff !important;
}
.panel-btn:hover, .neon-btn:hover {
    box-shadow: 0 0 15px #00f3ff !important;
    background: rgba(0, 243, 255, 0.2) !important;
}

::-webkit-scrollbar-thumb {
    background-color: #00f3ff;
    border: 2px solid #051015;
}
::-webkit-scrollbar-track {
    background: #051015;
}

.side-panel {
    border-color: rgba(0, 243, 255, 0.15) !important;
}
.v-text {
    color: rgba(0, 243, 255, 0.6) !important;
    animation: pulse-freeze 4s infinite ease-in-out;
}

@keyframes pulse-freeze {
    0%, 100% { opacity: 0.4; text-shadow: 0 0 2px #00f3ff; }
    50% { opacity: 0.9; text-shadow: 0 0 8px #00f3ff; }
}
</file>

<file path="src/routes/+layout.server.ts">
import { firestoreAdmin } from '$lib/server/firebase.admin';
import type { LayoutServerLoad } from './$types';
import { ADMIN_UIDS } from '$env/static/private';

const adminList = ADMIN_UIDS ? ADMIN_UIDS.split(',') : [];

export const load: LayoutServerLoad = async ({ locals }) => {
    let latestNewsDate: string | null = null;

    const isAdmin = locals.user && adminList.includes(locals.user.uid);

    try {
        const snapshot = await firestoreAdmin.collection('news')
            .orderBy('createdAt', 'desc')
            .limit(1)
            .get();

        if (!snapshot.empty) {
            const data = snapshot.docs[0].data();
            if (data.createdAt) {
                latestNewsDate = data.createdAt.toDate().toISOString();
            }
        }
    } catch (e) {
        console.error("Ошибка получения даты последней новости:", e);
    }

    return {
        user: locals.user,
        latestNewsDate,
        isAdmin
    };
};
</file>

<file path="src/routes/admin/news/+page.svelte">
<script lang="ts">
    import { enhance } from '$app/forms';
    import { modal } from '$lib/stores/modalStore';
    import type { ActionData } from './$types';
    import { fade, slide } from 'svelte/transition';

    export let form: ActionData;

    let isSubmitting = false;
    let imageUrl = '';

    $: if (form?.success) {
        modal.success("Опубликовано!", "Новость успешно добавлена в ленту.");
        imageUrl = '';
    } else if (form?.message) {
        modal.error("Ошибка", form.message);
    }
</script>

<svelte:head>
    <title>Propaganda Control | Overlord</title>
</svelte:head>

<div class="news-editor-wrapper" in:fade={{duration: 500}}>

    <header class="page-header">
        <h2 class="text-3xl font-bold text-white font-display tracking-widest mb-2">МОДУЛЬ ПРОПАГАНДЫ</h2>
        <p class="text-gray-500 font-mono text-sm">/// GLOBAL BROADCAST SYSTEM</p>
    </header>

    <div class="editor-grid">

        <div class="editor-panel cyber-glass">
            <form
                method="POST"
                action="?/create"
                use:enhance={() => {
                    isSubmitting = true;
                    return async ({ update }) => {
                        await update();
                        isSubmitting = false;
                    };
                }}
                class="editor-form"
            >
                <div class="form-group">
                    <label class="cyber-label">ЦЕЛЕВАЯ АУДИТОРИЯ</label>
                    <div class="lang-selector">
                        <label class="radio-label">
                            <input type="radio" name="lang" value="ru" checked>
                            <span class="radio-btn">RU (Russian)</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="lang" value="en">
                            <span class="radio-btn">EN (English)</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label class="cyber-label">ЗАГОЛОВОК ТРАНСЛЯЦИИ</label>
                    <input type="text" name="title" required placeholder="Пример: THE GLITCH PIT 2.0" class="cyber-input header-input" autocomplete="off" />
                </div>

                <div class="form-group">
                    <label class="cyber-label">ТЕКСТ СООБЩЕНИЯ</label>
                    <textarea name="content" required rows="12" placeholder="Введите текст новости..." class="cyber-input text-area"></textarea>
                </div>

                <div class="meta-grid">
                    <div class="form-group">
                        <label class="cyber-label">URL ИЗОБРАЖЕНИЯ</label>
                        <input type="url" name="imageUrl" bind:value={imageUrl} placeholder="https://..." class="cyber-input" />
                    </div>

                    <div class="form-group">
                        <label class="cyber-label">ТЕГИ (CSV)</label>
                        <input type="text" name="tags" placeholder="update, event, system" class="cyber-input" />
                    </div>
                </div>

                <div class="actions-bar">
                    <button type="submit" class="broadcast-btn" disabled={isSubmitting}>
                        {isSubmitting ? 'ШИФРОВАНИЕ...' : 'ЗАПУСТИТЬ В ЭФИР'}
                        <span class="btn-glow"></span>
                    </button>
                </div>
            </form>
        </div>

        <div class="preview-panel">
            <h3 class="preview-title">ПРЕДПРОСМОТР СИГНАЛА</h3>

            <div class="news-card-preview cyber-glass">
                {#if imageUrl}
                    <div class="card-image" transition:slide>
                        <img src={imageUrl} alt="Preview" />
                        <div class="image-overlay"></div>
                    </div>
                {:else}
                    <div class="card-image-placeholder">
                        <span>НЕТ ИЗОБРАЖЕНИЯ</span>
                    </div>
                {/if}

                <div class="card-content">
                    <div class="meta-mock">
                        <span class="date">ТОЛЬКО ЧТО</span>
                        <div class="tags-mock">
                            <span class="tag">#preview</span>
                        </div>
                    </div>
                    <div class="title-mock">ЗАГОЛОВОК НОВОСТИ</div>
                    <div class="text-mock">
                        <div class="line w-full"></div>
                        <div class="line w-11/12"></div>
                        <div class="line w-4/5"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<style>
    .news-editor-wrapper { max-width: 1200px; margin: 0 auto; }
    .page-header { text-align: center; margin-bottom: 3rem; }

    .editor-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
        align-items: start;
    }

    .cyber-glass {
        background: rgba(20, 25, 35, 0.4);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }

    .editor-panel { padding: 2rem; }
    .editor-form { display: flex; flex-direction: column; gap: 1.5rem; }

    .cyber-label {
        display: block; font-family: 'Chakra Petch', monospace; font-weight: bold;
        color: #64748b; font-size: 0.75rem; letter-spacing: 0.1em; margin-bottom: 0.5rem;
    }

    .cyber-input {
        width: 100%; background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px; padding: 1rem; color: #fff; font-family: 'Inter', sans-serif;
        transition: all 0.2s; outline: none;
    }
    .cyber-input:focus {
        background: rgba(0, 0, 0, 0.4);
        border-color: var(--cyber-yellow);
        box-shadow: 0 0 20px rgba(0, 243, 255, 0.1);
    }

    .header-input { font-size: 1.2rem; font-weight: bold; font-family: 'Chakra Petch', monospace; }
    .text-area { font-size: 1rem; line-height: 1.6; resize: vertical; }

    .meta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }

    .actions-bar { margin-top: 1rem; display: flex; justify-content: flex-end; }

    .broadcast-btn {
        position: relative; padding: 1rem 3rem; background: var(--cyber-yellow);
        color: #000; font-weight: 900; font-family: 'Chakra Petch', sans-serif;
        border-radius: 12px; cursor: pointer; overflow: hidden;
        transition: transform 0.2s; text-transform: uppercase; letter-spacing: 0.05em;
    }
    .broadcast-btn:hover { transform: scale(1.02); box-shadow: 0 0 30px rgba(0, 243, 255, 0.4); }
    .broadcast-btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

    .preview-title {
        font-family: 'Chakra Petch', monospace; font-size: 0.8rem; color: #64748b;
        margin-bottom: 1rem; text-align: center; letter-spacing: 0.1em;
    }

    .news-card-preview {
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .card-image { position: relative; height: 180px; overflow: hidden; }
    .card-image img { width: 100%; height: 100%; object-fit: cover; }
    .image-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(20,25,35,1), transparent); opacity: 0.6; }

    .card-image-placeholder {
        height: 180px; background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;
        color: #444; font-family: 'Chakra Petch', monospace; font-size: 0.8rem; border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .card-content { padding: 1.5rem; }
    .meta-mock { display: flex; justify-content: space-between; margin-bottom: 1rem; }
    .date { font-size: 0.7rem; color: #64748b; font-family: 'Chakra Petch', monospace; }
    .tag { font-size: 0.7rem; color: var(--cyber-yellow); background: rgba(0, 243, 255, 0.1); padding: 2px 6px; border-radius: 4px; }

    .title-mock { font-family: 'Chakra Petch', sans-serif; font-weight: bold; font-size: 1.2rem; color: #fff; margin-bottom: 1rem; opacity: 0.5; }
    .text-mock .line { height: 10px; background: rgba(255,255,255,0.1); margin-bottom: 8px; border-radius: 2px; }

    .lang-selector { display: flex; gap: 1rem; }
    .radio-label input { display: none; }
    .radio-btn {
        display: block; padding: 0.5rem 1rem;
        border: 1px solid #555; border-radius: 4px;
        color: #888; font-weight: bold; cursor: pointer;
        font-family: 'Chakra Petch', monospace; transition: all 0.2s;
    }
    .radio-label input:checked + .radio-btn {
        background: var(--cyber-yellow); color: #000; border-color: var(--cyber-yellow);
        box-shadow: 0 0 10px rgba(252, 238, 10, 0.3);
    }

    @media (max-width: 1024px) {
        .editor-grid { grid-template-columns: 1fr; }
        .preview-panel { display: none; }
    }
</style>
</file>

<file path="src/lib/components/CinematicLoader.svelte">
<script lang="ts">
    import { onMount, onDestroy, createEventDispatcher } from 'svelte';
    import { Howl } from 'howler';
    import { browser } from '$app/environment';

    // ИМПОРТ ЛОКАЛИЗАЦИИ
    import { t, getLocaleFromNavigator, locale } from 'svelte-i18n';
    // Нам нужно получить переводы как обычный объект, чтобы использовать их в таймерах
    import { get } from 'svelte/store';

    export let username: string = 'UNKNOWN_NODE';
    const dispatch = createEventDispatcher();

    // Логика Зимы
    let isWinter = false;
    if (browser) {
        const d = new Date();
        const m = d.getMonth();
        const day = d.getDate();
        if ((m === 10 && day >= 15) || m === 11 || (m === 0 && day <= 15)) {
            isWinter = true;
        }
    }

    type AnimationPhase = 'idle' | 'phase1_init' | 'phase2_breach' | 'phase3_analyze' | 'phase4_granted' | 'finished';
    let phase: AnimationPhase = 'idle';
    let mainLines: { text: string; glitch?: boolean; currentText: string }[] = [];
    let logLines: string[] = [];
    let progress = 0;
    let screenGlitch = false;

    let sound: Howl | null = null;
    let timeouts: NodeJS.Timeout[] = [];
    let intervals: NodeJS.Timeout[] = [];

    // Функция-хелпер для получения перевода внутри JS-логики
    // (так как $t реактивен, но внутри setTimeout нам нужно значение "здесь и сейчас")
    const translate = (key: string) => get(t)(key);
    const getArray = (key: string) => {
        // svelte-i18n возвращает массив как объект, если это JSON массив.
        // Но лучше просто запросить конкретные ключи или сделать хак.
        // ПРОЩЕ: Мы получим весь объект переводов и достанем массив.
        const messages = get(t)(key, { returnObjects: true });
        return Array.isArray(messages) ? messages : [];
    };

    function addLineAndType(text: string, glitch: boolean = false) {
        const lineIndex = mainLines.length;
        mainLines = [...mainLines, { text, glitch, currentText: '' }];

        let i = 0;
        const typingInterval = setInterval(() => {
            if (i < text.length) {
                mainLines[lineIndex].currentText += text.charAt(i);
                mainLines = mainLines;
                i++;
            } else {
                clearInterval(typingInterval);
            }
        }, 40);
        intervals.push(typingInterval);
    }

    function addLog(text: string) {
        logLines = [text, ...logLines].slice(0, 7);
    }

    function triggerScreenGlitch() {
        screenGlitch = true;
        setTimeout(() => screenGlitch = false, 150);
    }

    function skipAnimation() {
        if (phase === 'finished') return;
        phase = 'finished';
        timeouts.forEach(clearTimeout);
        intervals.forEach(clearInterval);
        sound?.fade(sound.volume(), 0, 300);
        setTimeout(() => sound?.stop(), 300);
        setTimeout(() => dispatch('finished'), 800);
    }

    onMount(() => {
        sound = new Howl({
            src: ['/sounds/long_maybe_for_loading_profile_anim.mp3'],
            volume: 0.8,
            onend: skipAnimation
        });
        sound.play();

        phase = 'phase1_init';

        // 1. ИНИЦИАЛИЗАЦИЯ
        const initText = isWinter ? translate('loader.winter_init') : translate('loader.init');
        const targetText = isWinter ? translate('loader.winter_target') : translate('loader.target');

        timeouts.push(setTimeout(() => addLineAndType(initText), 1000));
        timeouts.push(setTimeout(() => addLineAndType(targetText), 2000));
        timeouts.push(setTimeout(() => {
            addLineAndType(`> //: [${username}]`, true);
            triggerScreenGlitch();
        }, 3000));

        // 2. ВЗЛОМ (Логи)
        timeouts.push(setTimeout(() => {
            phase = 'phase2_breach';
            const progressInterval = setInterval(() => {
                progress += 2 + Math.random() * 5;
                if (Math.random() > 0.7) triggerScreenGlitch();
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(progressInterval);
                }
            }, 100);
            intervals.push(progressInterval);

            const logPool = isWinter ? getArray('loader.winter_logs') : getArray('loader.logs');

            if (logPool.length > 0) {
                const logInterval = setInterval(() => {
                    addLog(logPool[Math.floor(Math.random() * logPool.length)]);
                }, 150);
                intervals.push(logInterval);
            }
        }, 4500));

        // 3. АНАЛИЗ
        timeouts.push(setTimeout(() => {
            phase = 'phase3_analyze';
            intervals.forEach(clearInterval);
            intervals = [];
            logLines = [];
            triggerScreenGlitch();

            const analyzeTexts = isWinter
                ? getArray('loader.winter_analyze')
                : getArray('loader.analyze');

            if (analyzeTexts.length >= 3) {
                timeouts.push(setTimeout(() => addLog(analyzeTexts[0]), 200));
                timeouts.push(setTimeout(() => addLog(analyzeTexts[1]), 1000));
                timeouts.push(setTimeout(() => addLog(analyzeTexts[2]), 2000));
            }
        }, 6100));

        // 4. ДОСТУП
        timeouts.push(setTimeout(() => {
            phase = 'phase4_granted';
            mainLines = [];
            logLines = [];
            triggerScreenGlitch();
        }, 9000));

        timeouts.push(setTimeout(skipAnimation, 11000));

        return () => {
            timeouts.forEach(clearTimeout);
            intervals.forEach(clearInterval);
            sound?.stop();
        };
    });

    onDestroy(() => {
        timeouts.forEach(clearTimeout);
        intervals.forEach(clearInterval);
        sound?.stop();
    });
</script>

<div
    class="loader-container"
    class:crt-off={phase === 'finished'}
    class:screen-glitch={screenGlitch}
    class:winter-theme={isWinter}
    role="status"
    aria-live="polite"
>

    <div class="background-effects">
        {#if isWinter}
            <div class="snow-storm"></div> <!-- Если у тебя есть стили для этого, иначе оставь matrix -->
            <div class="frost-overlay"></div>
        {:else}
            <div class="matrix-rain"></div>
        {/if}
        <div class="grid-overlay"></div>
        <div class="scanline"></div>
        <div class="vignette"></div>
    </div>

    <div class="terminal-perspective">
        <div class="terminal">
            <!-- ЛОГИ -->
            {#if phase === 'phase2_breach' || phase === 'phase3_analyze'}
                <div class="log-panel">
                    <h3 class="panel-title">//: {isWinter ? $t('loader.winter_log_title') : $t('loader.log_title')}</h3>
                    {#each logLines as log, i}
                        <p class="log-line" style="opacity: {1 - i * 0.15}; transform: translateX({i * 5}px);">{log}</p>
                    {/each}
                </div>
            {/if}

            <!-- ГЛАВНЫЙ ТЕРМИНАЛ -->
            {#if phase === 'phase1_init'}
                <div class="main-terminal">
                    {#each mainLines as line}
                        <p class="line" class:glitch={line.glitch} data-text={line.text}>{line.currentText}<span class="caret"></span></p>
                    {/each}
                </div>
            {/if}

            <!-- ПРОГРЕСС БАР -->
            {#if phase === 'phase2_breach'}
                 <div class="main-terminal breach-mode">
                    <div class="progress-bar-container">
                        <span class="progress-label glitch"
                              data-text={isWinter ? $t('loader.winter_breach') : $t('loader.breach')}>
                            {isWinter ? $t('loader.winter_breach') : $t('loader.breach')}
                        </span>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {progress}%"></div>
                        </div>
                        <span class="progress-percent">{Math.floor(progress)}%</span>
                    </div>
                </div>
            {/if}

            <!-- ФИНАЛ -->
            {#if phase === 'phase4_granted'}
                <div class="granted-overlay">
                    <h1 class="granted-text glitch"
                        data-text={isWinter ? $t('loader.winter_granted') : $t('loader.granted')}>
                        {isWinter ? $t('loader.winter_granted') : $t('loader.granted')}
                    </h1>
                </div>
            {/if}
        </div>
    </div>

    <button class="skip-btn" on:click={skipAnimation}>{$t('loader.skip')}</button>
</div>

<style>
    @keyframes blink { 50% { opacity: 0; } }
    @keyframes scanline-anim { 0% { transform: translateY(-100vh); } 100% { transform: translateY(100vh); } }
    @keyframes granted-flash { 0% { opacity: 0; transform: scale(0.8); filter: blur(10px); } 10% { opacity: 1; transform: scale(1); filter: blur(0px); } 80% { opacity: 1; } 100% { opacity: 0; } }
    @keyframes crt-off-anim {
        0% { transform: scale(1, 1); filter: brightness(1); }
        40% { transform: scale(1, 0.005); filter: brightness(3); }
        100% { transform: scale(0, 0); filter: brightness(0); }
    }
    @keyframes screen-shake {
        0% { transform: translate(0, 0); } 20% { transform: translate(-5px, 5px); } 40% { transform: translate(5px, -5px); } 60% { transform: translate(-5px, -5px); } 80% { transform: translate(5px, 5px); } 100% { transform: translate(0, 0); }
    }
    @keyframes matrix-scroll { from { background-position: 0 0; } to { background-position: 0 1000px; } }
    @keyframes glitch-anim { 0% { clip-path: inset(45% 0 50% 0); transform: translateX(-2px); } 100% { clip-path: inset(5% 0 90% 0); transform: translateX(2px); } }

    @keyframes snow-fall-anim { from { background-position: 0 0; } to { background-position: 50px 500px; } }
    @keyframes frost-pulse { 0%, 100% { opacity: 0.3; } 50% { opacity: 0.6; } }

    .loader-container {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background-color: #050a05;
        color: #00ff41;
        --primary-color: #00ff41;
        --secondary-color: #00ff41;

        font-family: 'Chakra Petch', monospace;
        display: flex; align-items: center; justify-content: center; z-index: 9999;
        overflow: hidden; perspective: 1000px;
    }

    .loader-container.winter-theme {
        background-color: #02050a;
        color: #00f3ff; /* Cyan */
        --primary-color: #00f3ff;
        --secondary-color: #ffffff;
    }

    .loader-container.crt-off { animation: crt-off-anim 0.8s cubic-bezier(0.755, 0.05, 0.855, 0.06) forwards; }
    .loader-container.screen-glitch { animation: screen-shake 0.15s linear infinite; filter: hue-rotate(90deg) contrast(1.5); }
    .background-effects { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

    .matrix-rain {
        position: absolute; width: 100%; height: 100%; opacity: 0.15;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><text x="10" y="30" fill="%2300ff41" font-family="monospace" font-size="20">1</text><text x="50" y="70" fill="%2300ff41" font-family="monospace" font-size="20">0</text></svg>');
        animation: matrix-scroll 5s linear infinite;
    }

    .snow-storm {
        position: absolute; width: 100%; height: 100%; opacity: 0.3;
        background-image:
            radial-gradient(2px 2px at 20px 30px, #fff, transparent),
            radial-gradient(1px 1px at 100px 150px, #00f3ff, transparent);
        background-size: 300px 300px;
        animation: snow-fall-anim 10s linear infinite;
    }

    .frost-overlay {
        position: absolute; width: 100%; height: 100%;
        box-shadow: inset 0 0 150px rgba(0, 243, 255, 0.3);
        background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
        opacity: 0.5;
        animation: frost-pulse 5s infinite ease-in-out;
    }

    .grid-overlay {
        position: absolute; width: 100%; height: 100%; opacity: 0.3;
        background-image: linear-gradient(rgba(0, 255, 65, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 255, 65, 0.1) 1px, transparent 1px);
        background-size: 30px 30px;
    }
    .winter-theme .grid-overlay {
        background-image: linear-gradient(rgba(0, 243, 255, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 243, 255, 0.1) 1px, transparent 1px);
    }

    .scanline {
        position: absolute; width: 100%; height: 100px;
        background: linear-gradient(to bottom, transparent, var(--primary-color), transparent);
        opacity: 0.1;
        animation: scanline-anim 4s linear infinite;
    }
    .vignette {
        position: absolute; width: 100%; height: 100%;
        background: radial-gradient(circle, transparent 50%, black 150%);
    }

    .terminal-perspective { transform: rotateX(5deg); transform-style: preserve-3d; }
    .terminal {
        width: 90vw; max-width: 1200px; padding: 2rem;
        display: flex; justify-content: space-between; align-items: center;
        text-shadow: 0 0 5px var(--primary-color);
    }

    .log-panel { width: 35%; font-size: 0.9rem; color: var(--primary-color); opacity: 0.8; }
    .panel-title { color: var(--secondary-color); margin-bottom: 1rem; border-bottom: 2px solid var(--secondary-color); display: inline-block; }
    .log-line { white-space: nowrap; overflow: hidden; margin-bottom: 0.3rem; font-family: 'Share Tech Mono', monospace; }

    .main-terminal { width: 60%; }
    .line { font-size: 1.8rem; margin-bottom: 1rem; white-space: pre; color: var(--primary-color); }
    .caret { display: inline-block; width: 12px; height: 1.8rem; background-color: var(--primary-color); animation: blink 0.8s step-end infinite; vertical-align: sub; }
    .breach-mode .progress-bar-container {
        border: 4px solid var(--primary-color); padding: 1rem; background: rgba(0,20,0,0.8);
        box-shadow: 0 0 30px rgba(0, 255, 65, 0.2);
    }
    .winter-theme .breach-mode .progress-bar-container {
        background: rgba(0,10,20,0.8);
        box-shadow: 0 0 30px rgba(0, 243, 255, 0.2);
    }

    .progress-label { font-size: 1.5rem; display: block; text-align: center; margin-bottom: 1rem; color: var(--primary-color); }
    .progress-bar { height: 40px; background: rgba(255, 255, 255, 0.1); border: 1px solid var(--primary-color); padding: 4px; }
    .progress-fill { height: 100%; background: var(--primary-color); box-shadow: 0 0 20px var(--primary-color); transition: width 0.1s linear; }
    .progress-percent { display: block; text-align: right; font-size: 2rem; margin-top: 0.5rem; color: var(--secondary-color); }

    .granted-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        display: flex; align-items: center; justify-content: center;
    }
    .granted-text {
        font-size: 8vw; color: var(--secondary-color);
        text-shadow: 0 0 50px var(--secondary-color), 0 0 20px var(--primary-color);
        animation: granted-flash 2s ease-out forwards;
    }

    .glitch { position: relative; color: var(--secondary-color); }
    .glitch::before, .glitch::after {
        content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #050a05; overflow: hidden; clip-path: inset(0 0 0 0);
    }
    .winter-theme .glitch::before, .winter-theme .glitch::after { background: #02050a; }

    .glitch::before { text-shadow: -3px 0 #ff00c1; animation: glitch-anim 0.2s infinite linear alternate-reverse; left: 3px; }
    .glitch::after { text-shadow: 3px 0 #00f0ff; animation: glitch-anim 0.2s infinite linear alternate-reverse; left: -3px; animation-delay: 0.1s; }

    .skip-btn {
        position: fixed; bottom: 5rem; left: 2rem;
        background: rgba(0,0,0,0.5); border: 2px solid rgba(255, 255, 255, 0.2);
        color: rgba(255, 255, 255, 0.5); padding: 0.8rem 1.5rem; font-weight: bold;
        font-family: 'Chakra Petch', monospace; cursor: pointer; transition: all 0.2s; z-index: 10000;
    }
    .skip-btn:hover { border-color: var(--primary-color); color: var(--primary-color); box-shadow: 0 0 15px var(--primary-color); }

    @media (max-width: 768px) {
        .terminal { flex-direction: column; justify-content: center; width: 95vw; padding: 1rem; }
        .main-terminal { width: 100%; order: 1; margin-bottom: 2rem; }
        .log-panel { width: 100%; order: 2; font-size: 0.8rem; max-height: 25vh; overflow: hidden; }
        .line { font-size: 1.2rem; white-space: normal; word-break: break-all; }
        .progress-label { font-size: 1rem; }
        .progress-percent { font-size: 1.5rem; }
        .granted-text { font-size: 12vw; }
    }
</style>
</file>

<file path="src/routes/casino/coin-flip/+page.svelte">
<script lang="ts">
    import { userStore } from '$lib/stores';
    import { getFunctions, httpsCallable } from 'firebase/functions';
    import { modal } from '$lib/stores/modalStore';
    import { cubicOut, quintOut } from 'svelte/easing';
    import { tweened } from 'svelte/motion';
    import { onMount, onDestroy } from 'svelte';
    import { Howl } from 'howler';

    // Локализация
    import { t } from 'svelte-i18n';
    import { get } from 'svelte/store';
    import { renderMarkdown } from '$lib/utils/markdown';

    // Хелпер для перевода в JS
    const translate = (key: string) => get(t)(key);

    function getRandomQuote(category: 'greeting' | 'idle' | 'thinking' | 'win' | 'lose' | 'no_credits'): string {
        const quotes = get(t)(`coin.quotes.${category}`, { returnObjects: true }) as string[];
        if (Array.isArray(quotes) && quotes.length > 0) {
            return quotes[Math.floor(Math.random() * quotes.length)];
        }
        return "> ...";
    }

    let betAmount = 10;
    let isPlaying = false;
    let result: 'heads' | 'tails' | null = null;
    let lastWin = false;

    // ⬅️ НОВОЕ: Состояние тултипа
    let isMechanicsOpen = false;
    let tooltipElement: HTMLElement;
    let buttonElement: HTMLElement;

    let dealerMessage = "> ...";

    const displayedCredits = tweened($userStore.user?.casino_credits || 0, { duration: 500, easing: quintOut });
    $: if ($userStore.user) {
        displayedCredits.set($userStore.user.casino_credits);
    }

    let sounds: { [key: string]: Howl } = {};

    onMount(() => {
        sounds.ambient = new Howl({ src: ['/sounds/ambient_casino.mp3'], loop: true, volume: 0.15, autoplay: true });
        sounds.coin_flip = new Howl({ src: ['/sounds/coin_flip.mp3'], volume: 0.7 });
        sounds.coin_win = new Howl({ src: ['/sounds/coin_win.mp3'], volume: 0.8 });
        sounds.coin_lose = new Howl({ src: ['/sounds/coin_lose.mp3'], volume: 0.7 });

        dealerMessage = getRandomQuote('greeting');

        return () => {
            sounds.ambient?.stop();
        };
    });

    function setDealerMessage(state: 'greeting' | 'idle' | 'thinking' | 'win' | 'lose' | 'no_credits') {
        dealerMessage = getRandomQuote(state);
    }

    // ⬅️ НОВОЕ: Переключение тултипа с позиционированием
    function toggleMechanics() {
        isMechanicsOpen = !isMechanicsOpen;
        if (isMechanicsOpen && buttonElement && tooltipElement) {
            setTimeout(() => {
                const buttonRect = buttonElement.getBoundingClientRect();
                const tooltipRect = tooltipElement.getBoundingClientRect();

                // Позиция относительно кнопки
                let top = buttonRect.top - tooltipRect.height - 10;
                let left = buttonRect.left + (buttonRect.width / 2) - (tooltipRect.width / 2);

                // Проверяем выход за левую границу
                if (left < 10) left = 10;

                // Проверяем выход за правую границу
                if (left + tooltipRect.width > window.innerWidth - 10) {
                    left = window.innerWidth - tooltipRect.width - 10;
                }

                // Проверяем выход за верхнюю границу
                if (top < 10) {
                    top = buttonRect.bottom + 10;
                    tooltipElement.classList.add('below');
                } else {
                    tooltipElement.classList.remove('below');
                }

                tooltipElement.style.top = `${top}px`;
                tooltipElement.style.left = `${left}px`;
            }, 0);
        }
    }

    function closeMechanics() {
        isMechanicsOpen = false;
    }

    async function playGame(playerChoice: 'heads' | 'tails') {
        if (isPlaying || !$userStore.user) return;

        betAmount = Math.floor(betAmount);
        const currentBet = betAmount;

        if ($userStore.user.casino_credits < currentBet) {
            setDealerMessage('no_credits');
            modal.error(translate('coin.modal_poor_title'), translate('coin.modal_poor_text'));
            return;
        }
        if (isNaN(currentBet) || currentBet <= 0) {
            modal.error(translate('coin.modal_invalid_title'), translate('coin.modal_invalid_text'));
            return;
        }

        isPlaying = true;
        result = null;
        setDealerMessage('thinking');
        sounds.coin_flip?.play();

        try {
            const functions = getFunctions();
            const playCoinFlipFunc = httpsCallable(functions, 'playCoinFlip');

            const response = await playCoinFlipFunc({ bet: currentBet, choice: playerChoice });
            const gameResult = (response.data as any).data;

            setTimeout(() => {
                result = gameResult.outcome;
                lastWin = gameResult.hasWon;

                if (gameResult.hasWon) {
                    setDealerMessage('win');
                    sounds.coin_win?.play();
                } else {
                    setDealerMessage('lose');
                    sounds.coin_lose?.play();
                }

                userStore.update(store => {
                    if (store.user) store.user.casino_credits = gameResult.newBalance;
                    return store;
                });

                setTimeout(() => {
                    isPlaying = false;
                    if (!document.hidden) setDealerMessage('idle');
                }, 3000);

            }, 2800);

        } catch (error: any) {
            modal.error(translate('coin.modal_error_title'), error.message || "Connection error.");
            isPlaying = false;
            setDealerMessage('idle');
        }
    }
</script>

<svelte:head>
    <title>{$t('coin.title')} | The Glitch Pit</title>
</svelte:head>

<!-- ⬅️ НОВОЕ: Закрываем тултип по клику на фон -->
<svelte:window on:click={closeMechanics} />

<div class="page-container">
    <div class="bg-blur-1"></div>
    <div class="bg-blur-2"></div>

    <!-- ⬅️ НОВОЕ: Инфо-кнопка -->
    <div class="game-header">
        <h1 class="game-title">{$t('coin.title')}</h1>
        <button
            bind:this={buttonElement}
            class="info-tooltip-wrapper"
            on:click|stopPropagation={toggleMechanics}
        >
            <div class="info-icon">?</div>

            <div bind:this={tooltipElement} class="custom-tooltip" class:mobile-visible={isMechanicsOpen}>
                <h5 class="tooltip-title">{$t('coin.mechanics_title')}</h5>
                <div class="tooltip-body">
                    {@html renderMarkdown($t('coin.mechanics_text'))}
                </div>
            </div>
        </button>
    </div>

    <div class="dealer-container">
        <img src="/casino/orioncasino.png" alt="Dealer Orion" class="dealer-art" />
        <div class="dealer-dialogue">
            <p>{dealerMessage}</p>
        </div>
    </div>

    <div class="coin-zone">
        <div class="coin" class:flipping={isPlaying} class:heads={result === 'heads'} class:tails={result === 'tails'}>
            <div class="face front">
                <img src="/casino/orel.png" alt="Heads" />
            </div>
            <div class="face back">
                <img src="/casino/reshka.png" alt="Tails" />
            </div>
        </div>

        {#if result !== null}
            <div class="result-feedback" class:win={lastWin} class:loss={!lastWin}>
                {lastWin ? $t('coin.win_label') : $t('coin.loss_label')}
            </div>
        {/if}
    </div>

    <div class="controls-container">
        <div class="balance-display">
            <span class="label">{$t('ui.balance')}</span>
            <span class="value">{Math.floor($displayedCredits)} PC</span>
        </div>
        <div class="bet-control">
            <button class="bet-adjust" on:click={() => betAmount = Math.max(10, betAmount - 10)} disabled={isPlaying}>-</button>
            <input
                id="bet-amount"
                type="number"
                bind:value={betAmount}
                min="1"
                max={$userStore.user?.casino_credits}
                step="1"
                on:input={() => betAmount = Math.floor(betAmount)}
                disabled={isPlaying}
            />
            <button class="bet-adjust" on:click={() => betAmount += 10} disabled={isPlaying}>+</button>
        </div>
        <div class="choices">
            <button class="choice-btn heads" on:click={() => playGame('heads')} disabled={isPlaying}>
                <img src="/casino/orel.png" alt="Heads" class="btn-icon"/>
                <span>{$t('coin.heads')}</span>
            </button>
            <button class="choice-btn tails" on:click={() => playGame('tails')} disabled={isPlaying}>
                <img src="/casino/reshka.png" alt="Tails" class="btn-icon"/>
                <span>{$t('coin.tails')}</span>
            </button>
        </div>
    </div>
</div>

<style>
    @keyframes coin-flip-3d {
        0% { transform: translateY(0) rotateX(0) rotateY(0) scale(1); }
        50% { transform: translateY(-50px) rotateX(2880deg) rotateY(360deg) scale(1.5); }
        100% { transform: translateY(0) rotateX(5760deg) rotateY(720deg) scale(1); }
    }
    @keyframes result-show {
        0% { opacity: 0; transform: scale(0.5); filter: blur(10px); }
        20% { opacity: 1; transform: scale(1.2); filter: blur(0); }
        80% { opacity: 1; transform: scale(1); }
        100% { opacity: 0; }
    }
    @keyframes float-blur-1 { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(100px, 50px); } }
    @keyframes float-blur-2 { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(-80px, -60px); } }

    .page-container {
        min-height: calc(100vh - 64px);
        display: grid;
        grid-template-rows: auto auto 1fr auto;
        max-width: 1000px;
        margin: 0 auto;
        padding: 1rem;
        position: relative;
        overflow: hidden;
    }
    .bg-blur-1, .bg-blur-2 {
        position: fixed; width: 400px; height: 400px; border-radius: 50%;
        filter: blur(150px); pointer-events: none; z-index: -1;
    }
    .bg-blur-1 { background: var(--cyber-cyan); top: 10%; left: 10%; animation: float-blur-1 20s infinite ease-in-out; }
    .bg-blur-2 { background: var(--cyber-yellow); bottom: 10%; right: 10%; animation: float-blur-2 25s infinite ease-in-out; }

    /* ⬅️ НОВОЕ: Заголовок с кнопкой */
    .game-header {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 1rem;
        position: relative;
        z-index: 20;
    }
    .game-title {
        font-family: 'Chakra Petch', monospace;
        font-size: 2rem;
        color: var(--cyber-yellow);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin: 0;
    }

    /* ⬅️ ИСПРАВЛЕННЫЕ СТИЛИ ТУЛТИПА */
    .info-tooltip-wrapper {
        position: relative;
        display: inline-flex;
        align-items: center;
        cursor: help;
        z-index: 20;
        background: none;
        border: none;
        padding: 0;
        margin: 0;
    }

    .info-icon {
        width: 20px; height: 20px;
        border-radius: 50%;
        border: 1px solid #555;
        color: #777;
        background: rgba(255, 255, 255, 0.05);
        font-family: monospace;
        font-size: 13px;
        font-weight: bold;
        display: flex; align-items: center; justify-content: center;
        transition: all 0.2s;
    }

    .info-tooltip-wrapper:hover .info-icon {
        border-color: var(--cyber-cyan);
        background: var(--cyber-cyan);
        color: #000;
        box-shadow: 0 0 10px var(--cyber-cyan);
    }

    .custom-tooltip {
        position: fixed;
        width: 320px;
        max-width: calc(100vw - 2rem);
        padding: 1rem;
        background: rgba(10, 10, 15, 0.95);
        border: 1px solid var(--cyber-cyan);
        border-radius: 8px;
        box-shadow: 0 0 20px rgba(0, 243, 255, 0.2);
        backdrop-filter: blur(10px);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.3s;
        pointer-events: none;
        z-index: 1000;
    }

    .custom-tooltip::after {
        content: '';
        position: absolute;
        bottom: -6px;
        left: 50%;
        margin-left: -6px;
        border-width: 6px;
        border-style: solid;
        border-color: var(--cyber-cyan) transparent transparent transparent;
    }

    .custom-tooltip.below::after {
        bottom: auto;
        top: -6px;
        border-color: transparent transparent var(--cyber-cyan) transparent;
    }

    .info-tooltip-wrapper:hover .custom-tooltip,
    .custom-tooltip.mobile-visible {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
    }

    .tooltip-title {
        color: var(--cyber-yellow);
        font-family: 'Chakra Petch', monospace;
        font-weight: bold;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        text-transform: uppercase;
        border-bottom: 1px dashed rgba(255,255,255,0.2);
        padding-bottom: 4px;
    }
    .tooltip-body {
        color: #ccc; font-size: 0.8rem; line-height: 1.5; text-align: left;
    }
    .tooltip-body :global(p) { margin-bottom: 0.5rem; }
    .tooltip-body :global(p:last-child) { margin-bottom: 0; }
    .tooltip-body :global(strong) { color: var(--cyber-yellow); font-weight: 800; }

    @media (max-width: 640px) {
        .custom-tooltip {
            width: 280px;
            left: 50%;
            right: auto;
            transform: translateX(-50%) translateY(10px);
        }

        .custom-tooltip::after {
            left: 50%;
            right: auto;
            margin-left: -6px;
        }

        .info-tooltip-wrapper:hover .custom-tooltip,
        .custom-tooltip.mobile-visible {
            transform: translateX(-50%) translateY(0);
        }

        .game-title {
            font-size: 1.5rem;
        }
    }

    .dealer-container { position: relative; text-align: center; z-index: 10; }
    .dealer-art { max-width: 350px; max-height: 220px; margin: 0 auto; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5)); }
    .dealer-dialogue {
        background: rgba(10,10,10,0.8); backdrop-filter: blur(5px);
        border: 1px solid rgba(255,255,255,0.1); padding: 0.5rem 1.5rem;
        display: inline-block; margin-top: -2.5rem; position: relative;
        font-family: 'Chakra Petch', monospace; border-radius: 4px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .coin-zone { display: flex; align-items: center; justify-content: center; perspective: 1200px; position: relative; }
    .coin {
        width: 180px; height: 180px; position: relative;
        transform-style: preserve-3d;
        transition: transform 1.2s cubic-bezier(0.22, 1, 0.36, 1);
    }
    .coin.flipping { animation: coin-flip-3d 2.8s cubic-bezier(0.3, 0.9, 0.7, 1.1); }
    .coin.heads { transform: rotateY(0deg); }
    .coin.tails { transform: rotateY(180deg); }

    .face {
        position: absolute; width: 100%; height: 100%;
        backface-visibility: hidden;
        display: flex; align-items: center; justify-content: center;
        border-radius: 50%;
    }
    .face img { width: 100%; height: 100%; filter: drop-shadow(0 0 20px rgba(255,255,255,0.3)); }
    .back { transform: rotateY(180deg); }

    .result-feedback {
        position: absolute; font-family: 'Chakra Petch', monospace;
        font-size: 5rem; font-weight: bold; opacity: 0;
        animation: result-show 2s ease-out forwards;
        text-transform: uppercase; pointer-events: none;
    }
    .result-feedback.win { color: var(--cyber-yellow); text-shadow: 0 0 25px var(--cyber-yellow), 0 0 50px #fff; }
    .result-feedback.loss { color: var(--cyber-red); text-shadow: 0 0 25px var(--cyber-red); }

    .controls-container {
        display: flex; align-items: center; justify-content: space-around;
        padding: 1.5rem; z-index: 10;
        background: rgba(10,10,10,0.6); backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1); border-radius: 1rem;
        box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }
    .balance-display { text-align: center; }
    .balance-display .label { display: block; font-size: 0.8rem; color: #888; text-transform: uppercase; }
    .balance-display .value { display: block; font-size: 1.8rem; color: #fff; text-shadow: 0 0 5px var(--cyber-yellow); font-family: 'Chakra Petch', monospace; }

    .bet-control { display: flex; align-items: center; gap: 0.5rem; }
    .bet-control input {
        width: 100px; background: rgba(0,0,0,0.5); border: 1px solid #444; color: #fff;
        padding: 0.75rem; font-size: 1.5rem; text-align: center; border-radius: 4px;
    }
    .bet-control input:focus { outline: none; border-color: var(--cyber-yellow); }
    .bet-control input:disabled { opacity: 0.5; }
    .bet-adjust {
        background: transparent; color: #888; border: 1px solid #444; width: 48px; height: 48px;
        font-size: 1.8rem; cursor: pointer; transition: all 0.2s; border-radius: 50%;
    }
    .bet-adjust:hover:not(:disabled) { background: #444; color: #fff; }
    .bet-adjust:disabled { opacity: 0.3; }

    .choices { display: flex; gap: 1.5rem; }
    .choice-btn {
        padding: 1rem 2.5rem; font-family: 'Chakra Petch', monospace;
        font-size: 1.5rem; font-weight: bold; border: 2px solid;
        background: transparent; color: #fff; transition: all 0.2s;
        cursor: pointer; display: flex; align-items: center; gap: 0.5rem;
    }
    .btn-icon { width: 32px; height: 32px; }
    .choice-btn.heads { border-color: var(--cyber-yellow); }
    .choice-btn.tails { border-color: var(--cyber-cyan); }
    .choice-btn:hover:not(:disabled) { color: #000; }
    .choice-btn.heads:hover:not(:disabled) { background: var(--cyber-yellow); box-shadow: 0 0 20px var(--cyber-yellow); }
    .choice-btn.tails:hover:not(:disabled) { background: var(--cyber-cyan); box-shadow: 0 0 20px var(--cyber-cyan); }
    .choice-btn:disabled { opacity: 0.5; cursor: wait; filter: grayscale(1); }
    @media (max-width: 768px) {
        .page-container {
            padding: 0.5rem;
            grid-template-rows: auto auto 1fr auto;
        }
        .dealer-art {
            max-height: 150px;
        }
        .dealer-dialogue {
            font-size: 0.8rem;
            margin-top: -1.5rem;
            padding: 0.5rem 1rem;
        }

        .coin {
            width: 120px;
            height: 120px;
        }

        .result-feedback {
            font-size: 3rem;
        }

        .controls-container {
            flex-direction: column;
            gap: 1.5rem;
            padding: 1rem;
        }

        .choices {
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .choice-btn {
            padding: 1rem;
            font-size: 1.2rem;
            justify-content: center;
        }
    }
</style>
</file>

<file path="src/routes/casino/crash/+page.svelte">
<script lang="ts">
    import { userStore } from '$lib/stores';
    import { onMount, onDestroy } from 'svelte';
    import { getFunctions, httpsCallable } from 'firebase/functions';
    import { getDatabase, ref, onValue, off } from 'firebase/database';
    import { modal } from '$lib/stores/modalStore';
    import { Howl } from 'howler';
    import { tweened } from 'svelte/motion';
    import { fade, scale } from 'svelte/transition';
    import { t } from 'svelte-i18n';
    import { get } from 'svelte/store';
    import { renderMarkdown } from '$lib/utils/markdown';

    let canvas: HTMLCanvasElement;
    let ctx: CanvasRenderingContext2D;
    let animationFrame: number;

    let betAmount = 100;
    let multiplier = 1.00;
    let isPlaying = false;
    let isCrashed = false;
    let gameId: string | null = null;
    let startTime = 0;

    let gameStatus = 'IDLE';
    let winAmount = 0;

    let history: { val: number, crashed: boolean }[] = [];
    let sounds: { [key: string]: Howl } = {};
    let unsubscribeRTDB: (() => void) | null = null;

    // ⬅️ НОВОЕ: Состояние тултипа
    let isMechanicsOpen = false;
    let tooltipElement: HTMLElement;
    let buttonElement: HTMLElement;

    const displayedCredits = tweened($userStore.user?.casino_credits || 0, { duration: 500 });
    $: if ($userStore.user) displayedCredits.set($userStore.user.casino_credits);

    let particles: {x: number, y: number, vx: number, vy: number, life: number, color: string}[] = [];
    let shakeIntensity = 0;
    let themeColor = '#00f3ff';

    const SPEED_CONST = 0.08;

    // ⬅️ НОВОЕ: Функции для тултипа
    function toggleMechanics() {
        isMechanicsOpen = !isMechanicsOpen;
        if (isMechanicsOpen && buttonElement && tooltipElement) {
            setTimeout(() => {
                const buttonRect = buttonElement.getBoundingClientRect();
                const tooltipRect = tooltipElement.getBoundingClientRect();

                // Позиция относительно кнопки
                let top = buttonRect.top - tooltipRect.height - 10;
                let left = buttonRect.left + (buttonRect.width / 2) - (tooltipRect.width / 2);

                // Проверяем выход за левую границу
                if (left < 10) left = 10;

                // Проверяем выход за правую границу
                if (left + tooltipRect.width > window.innerWidth - 10) {
                    left = window.innerWidth - tooltipRect.width - 10;
                }

                // Проверяем выход за верхнюю границу
                if (top < 10) {
                    top = buttonRect.bottom + 10;
                    tooltipElement.classList.add('below');
                } else {
                    tooltipElement.classList.remove('below');
                }

                tooltipElement.style.top = `${top}px`;
                tooltipElement.style.left = `${left}px`;
            }, 0);
        }
    }

    function closeMechanics() {
        isMechanicsOpen = false;
    }

    onMount(() => {
        ctx = canvas.getContext('2d')!;
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        drawIdle();

        (window as any).CheatMenu = {
            enableWin: () => {
                console.warn("%c⚠️ SYSTEM ALERT:", "color: red; font-size: 20px; font-weight: bold;");
                console.log("%cNice try, Kuraga. Your IP has been logged... just kidding. Love you! <3", "color: #00f3ff; font-size: 14px;");
                return "ACCESS_DENIED";
            },
            predictCrash: () => {
                return "42.069x (Trust me bro)";
            }
        };

        sounds.engine = new Howl({ src: ['/sounds/suspense_music.mp3'], loop: true, volume: 0, rate: 0.8 });
        sounds.crash = new Howl({ src: ['/sounds/fail.mp3'], volume: 1.0 });
        sounds.win = new Howl({ src: ['/sounds/sucsess.mp3'], volume: 0.8 });
        sounds.click = new Howl({ src: ['/sounds/click.mp3'] });

        return () => {
            window.removeEventListener('resize', resizeCanvas);
            cancelAnimationFrame(animationFrame);
            sounds.engine?.stop();
            if (unsubscribeRTDB) unsubscribeRTDB();
        };
    });

    function resizeCanvas() {
        if (canvas) {
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.parentElement?.getBoundingClientRect();
            if (rect) {
                canvas.width = rect.width * dpr;
                canvas.height = rect.height * dpr;
                ctx.scale(dpr, dpr);
                canvas.style.width = `${rect.width}px`;
                canvas.style.height = `${rect.height}px`;
            }
            if (!isPlaying) drawIdle();
        }
    }

    function updateTheme(val: number) {
        if (isCrashed) { themeColor = '#ff003c'; return; }
        if (val < 2.0) themeColor = '#00f3ff';
        else if (val < 5.0) themeColor = '#bd00ff';
        else if (val < 10.0) themeColor = '#ffd700';
        else themeColor = '#ff003c';
    }

    async function startGame() {
    betAmount = Math.floor(betAmount);
        if (betAmount > ($userStore.user?.casino_credits || 0)) {
            modal.error("ОШИБКА", "НЕДОСТАТОЧНО СРЕДСТВ");
            return;
        }
        if (betAmount > 1000) {
            modal.error("ОШИБКА", "МАКСИМАЛЬНАЯ СТАВКА 1000 PC");
            betAmount = 1000;
            return;
        }

        isPlaying = true;
        isCrashed = false;
        gameStatus = 'UPLOADING';
        multiplier = 1.00;
        winAmount = 0;
        particles = [];
        shakeIntensity = 0;
        themeColor = '#00f3ff';

        sounds.click?.play();

        try {
            const functions = getFunctions();
            const startFunc = httpsCallable(functions, 'startCrashGame');
            const result: any = await startFunc({ bet: betAmount });
            gameId = result.data.data.gameId;

            if ($userStore.user) {
                userStore.update(s => {
                    if(s.user) s.user.casino_credits -= betAmount;
                    return s;
                });
            }

            const db = getDatabase(undefined, "https://protomap-1e1db-default-rtdb.europe-west1.firebasedatabase.app");
            const gameRef = ref(db, `crash_games/${gameId}`);

            if (unsubscribeRTDB) unsubscribeRTDB();

            unsubscribeRTDB = onValue(gameRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) return;

                if (data.s === 'bang') {
                    if (gameStatus === 'CASHED_OUT') {
                        if (unsubscribeRTDB) unsubscribeRTDB();
                        return;
                    }

                    crash(data.m);
                    if (unsubscribeRTDB) unsubscribeRTDB();
                    return;
                }

                if (data.s === 'done') {
                    if (unsubscribeRTDB) unsubscribeRTDB();
                    return;
                }
            });

            startTime = Date.now();
            sounds.engine?.volume(0.5);
            sounds.engine?.rate(0.8);
            sounds.engine?.play();

            loop();

        } catch (e: any) {
            modal.error("СБОЙ СЕТИ", e.message);
            isPlaying = false;
            gameStatus = 'IDLE';
        }
    }

    async function cashOut() {
        if (!isPlaying || gameStatus !== 'UPLOADING') return;

        isPlaying = false;
        gameStatus = 'CASHED_OUT';

        const currentMult = multiplier;

        sounds.engine?.stop();
        sounds.win?.play();

        winAmount = Math.floor(betAmount * currentMult);
        addToHistory(currentMult, false);

        drawFrame(currentMult);

        try {
            const functions = getFunctions();
            const cashOutFunc = httpsCallable(functions, 'cashOutCrashGame');
            await cashOutFunc({ gameId, multiplier: currentMult });

            userStore.update(s => { if(s.user) s.user.casino_credits += winAmount; return s; });
        } catch (e) {
            gameStatus = 'CRASHED';
            isCrashed = true;
            crash(currentMult);
        }
    }

    function addToHistory(val: number, crashed: boolean) {
        history = [{ val, crashed }, ...history].slice(0, 10);
    }

    function loop() {
        if (!isPlaying) return;

        const timeElapsed = (Date.now() - startTime) / 1000;

        multiplier = Math.exp(SPEED_CONST * timeElapsed);
        updateTheme(multiplier);

        const rate = 0.8 + (timeElapsed * 0.05);
        sounds.engine?.rate(Math.min(rate, 3.0));

        if (multiplier > 10) shakeIntensity = Math.min((multiplier - 10) * 0.5, 5);

        drawFrame(multiplier);

        animationFrame = requestAnimationFrame(loop);
    }

    function crash(finalVal: number) {
        multiplier = finalVal;
        isCrashed = true;
        gameStatus = 'CRASHED';
        isPlaying = false;

        shakeIntensity = 20;
        updateTheme(finalVal);

        sounds.engine?.stop();
        sounds.crash?.play();
        addToHistory(finalVal, true);

        drawFrame(finalVal);

        const shakeDecay = setInterval(() => {
            shakeIntensity *= 0.85;
            if (shakeIntensity < 0.5) {
                shakeIntensity = 0;
                clearInterval(shakeDecay);
            }
            drawFrame(finalVal);
        }, 16);
    }

    function drawFrame(val: number) {
        if (!canvas) return;
        const rect = canvas.getBoundingClientRect();
        const w = rect.width;
        const h = rect.height;

        const dx = (Math.random() - 0.5) * shakeIntensity;
        const dy = (Math.random() - 0.5) * shakeIntensity;

        ctx.save();
        ctx.translate(dx, dy);

        ctx.fillStyle = '#050a10';
        ctx.fillRect(-20, -20, w + 40, h + 40);

        const gridOffset = (val - 1) * 200;
        drawGrid(gridOffset, w, h);

        const x = w - 100;

        const normY = 1 - (1 / val);
        const y = h - 50 - (normY * (h - 100));

        ctx.beginPath();
        ctx.moveTo(0, h);
        ctx.quadraticCurveTo(x * 0.5, h, x, y);

        ctx.lineCap = 'round';
        ctx.lineWidth = 5;
        ctx.strokeStyle = themeColor;
        ctx.shadowBlur = 20;
        ctx.shadowColor = themeColor;
        ctx.stroke();
        ctx.shadowBlur = 0;

        ctx.lineTo(x, h);
        ctx.closePath();
        const gradient = ctx.createLinearGradient(0, 0, 0, h);
        gradient.addColorStop(0, hexToRgba(themeColor, 0.4));
        gradient.addColorStop(1, hexToRgba(themeColor, 0));
        ctx.fillStyle = gradient;
        ctx.fill();

        if (!isCrashed && gameStatus === 'UPLOADING') {
            for(let i=0; i<3; i++) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 1.5) * 5,
                    vy: (Math.random() - 0.5) * 5,
                    life: 1.0,
                    color: Math.random() > 0.5 ? '#fff' : themeColor
                });
            }
        }
        updateAndDrawParticles();

        if (!isCrashed) {
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(-0.5);
            ctx.beginPath();
            ctx.moveTo(10, 0); ctx.lineTo(-10, 7); ctx.lineTo(-10, -7);
            ctx.closePath();
            ctx.fillStyle = '#fff';
            ctx.shadowBlur = 15; ctx.shadowColor = '#fff';
            ctx.fill();
            ctx.restore();
        } else {
            ctx.beginPath();
            ctx.arc(x, y, 20 + Math.random() * 20, 0, Math.PI * 2);
            ctx.fillStyle = '#fff';
            ctx.fill();
            ctx.beginPath();
            ctx.arc(x, y, 40 + Math.random() * 20, 0, Math.PI * 2);
            ctx.strokeStyle = '#ff003c';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        ctx.restore();
    }

    function updateAndDrawParticles() {
        for (let i = particles.length - 1; i >= 0; i--) {
            let p = particles[i];
            p.x += p.vx;
            p.y += p.vy;
            p.life -= 0.05;

            if (p.life <= 0) {
                particles.splice(i, 1);
                continue;
            }

            ctx.globalAlpha = p.life;
            ctx.fillStyle = p.color;
            ctx.beginPath();
            ctx.arc(p.x, p.y, 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.globalAlpha = 1.0;
        }
    }

    function drawGrid(offset: number, w: number, h: number) {
        ctx.strokeStyle = 'rgba(255,255,255,0.05)';
        ctx.lineWidth = 1;
        const spacing = 80;

        ctx.beginPath();
        for (let x = - (offset % spacing); x < w; x += spacing) {
            ctx.moveTo(x, 0); ctx.lineTo(x, h);
        }
        for (let y = 0; y < h; y += spacing) {
            ctx.moveTo(0, y); ctx.lineTo(w, y);
        }
        ctx.stroke();
    }

    function drawIdle() {
        if (!canvas) return;
        const rect = canvas.getBoundingClientRect();
        const w = rect.width;
        const h = rect.height;
        ctx.fillStyle = '#050a10';
        ctx.fillRect(0, 0, w, h);
        drawGrid(0, w, h);
    }

    function hexToRgba(hex: string, alpha: number) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }
</script>

<svelte:head>
    <title>{$t('crash.title')} | The Glitch Pit</title>
</svelte:head>

<!-- ⬅️ НОВОЕ: Закрываем тултип по клику на фон -->
<svelte:window on:click={closeMechanics} />

<div class="page-container">
    <div class="bg-blur-1" style="background: {themeColor}; opacity: 0.2;"></div>

    <div class="terminal-frame" style="border-color: {themeColor}; box-shadow: 0 0 30px rgba(0,0,0,0.8), 0 0 20px {themeColor}33;">

        <!-- ⬅️ НОВОЕ: Заголовок с инфо-кнопкой -->
        <div class="game-header">
            <h1 class="game-title">{$t('crash.title')}</h1>
            <button
                bind:this={buttonElement}
                class="info-tooltip-wrapper"
                on:click|stopPropagation={toggleMechanics}
            >
                <div class="info-icon">?</div>

                <div bind:this={tooltipElement} class="custom-tooltip" class:mobile-visible={isMechanicsOpen}>
                    <h5 class="tooltip-title">{$t('crash.mechanics_title')}</h5>
                    <div class="tooltip-body">
                        {@html renderMarkdown($t('crash.mechanics_text'))}
                    </div>
                </div>
            </button>
        </div>

        <div class="history-bar">
            <span class="label">LOGS:</span>
            <div class="history-track">
                {#each history as item}
                    <div class="history-pill" class:crash={item.crashed} transition:scale>
                        {item.val.toFixed(2)}x
                    </div>
                {/each}
            </div>
        </div>

        <div class="screen-wrapper">
            <canvas bind:this={canvas}></canvas>

            <div class="screen-overlay">
                {#if gameStatus === 'IDLE'}
                    <div class="status-box">
                        <h2 class="glitch-text" data-text="SYSTEM READY">SYSTEM READY</h2>
                        <p class="blink">WAITING FOR UPLINK...</p>
                    </div>
                {:else if gameStatus === 'UPLOADING' || gameStatus === 'CASHED_OUT'}
                    <div class="big-multiplier" style="color: {themeColor}; text-shadow: 0 0 20px {themeColor};">
                        {multiplier.toFixed(2)}<span class="x">x</span>
                    </div>
                    {#if gameStatus === 'CASHED_OUT'}
                        <div class="cashed-out-badge" transition:scale>
                            DATA SECURED: +{winAmount}
                        </div>
                    {/if}
                {:else if gameStatus === 'CRASHED'}
                    <div class="crash-box" transition:scale>
                        <h2 class="glitch-text" data-text="CONNECTION LOST">CONNECTION LOST</h2>
                        <div class="final-val">{multiplier.toFixed(2)}x</div>
                    </div>
                {/if}
            </div>
        </div>

        <div class="controls-panel">
            <div class="bet-section">
                <div class="input-label">PACKET SIZE (BET)</div>
                <div class="bet-input-group">
                    <button class="adj" on:click={() => betAmount = Math.max(10, betAmount - 50)} disabled={isPlaying}>-</button>
                    <input
                        type="number"
                        bind:value={betAmount}
                        disabled={isPlaying}
                        class="cyber-input"
                        step="1"
                        on:input={() => betAmount = Math.floor(betAmount)}
                    >
                    <button class="adj" on:click={() => betAmount = Math.min(1000, betAmount + 50)} disabled={isPlaying}>+</button>
                </div>
                <div class="quick-bets">
                    <button on:click={() => betAmount = 100} disabled={isPlaying}>100</button>
                    <button on:click={() => betAmount = 500} disabled={isPlaying}>500</button>
                    <button on:click={() => betAmount = 1000} disabled={isPlaying}>MAX</button>
                </div>
            </div>

            <div class="action-section">
                {#if !isPlaying || gameStatus === 'CRASHED' || gameStatus === 'CASHED_OUT'}
                    <button class="launch-btn" on:click={startGame} disabled={isPlaying && gameStatus !== 'CRASHED'}>
                        <div class="btn-content">
                            <span class="big">INITIATE</span>
                            <span class="small">COST: {betAmount} PC</span>
                        </div>
                        <div class="btn-glitch"></div>
                    </button>
                {:else}
                    <button class="abort-btn" on:click={cashOut}>
                        <div class="btn-content">
                            <span class="big">ABORT</span>
                            <span class="small win">+{Math.floor(betAmount * multiplier)} PC</span>
                        </div>
                    </button>
                {/if}
            </div>
        </div>

        <div class="footer-status">
            <span>STATUS: {gameStatus}</span>
            <span>BALANCE: {Math.floor($displayedCredits)} PC</span>
        </div>
    </div>
</div>

<style>
    @keyframes blink { 50% { opacity: 0; } }
    @keyframes glitch-skew { 0% { transform: skew(0deg); } 20% { transform: skew(-10deg); } 40% { transform: skew(10deg); } 100% { transform: skew(0deg); } }

    .page-container {
        min-height: calc(100vh - 64px);
        display: flex; justify-content: center; align-items: center;
        padding: 0.5rem; overflow: hidden; position: relative;
        background: #050505;
    }

    .bg-blur-1, .bg-blur-2 { position: absolute; width: 600px; height: 600px; filter: blur(150px); pointer-events: none; z-index: 0; transition: background 0.5s; }
    .bg-blur-1 { top: -200px; left: -200px; }
    .bg-blur-2 { bottom: -200px; right: -200px; background: rgba(255, 255, 255, 0.05); }

    .terminal-frame {
        width: 100%; max-width: 900px;
        background: rgba(10, 12, 15, 0.95);
        border: 1px solid;
        border-radius: 8px;
        position: relative; z-index: 10;
        display: flex; flex-direction: column;
        transition: border-color 0.5s, box-shadow 0.5s;
    }

    /* ⬅️ НОВОЕ: Заголовок с кнопкой */
    .game-header {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        padding: 1rem 1rem 0.5rem;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .game-title {
        font-family: 'Chakra Petch', monospace;
        font-size: 1.8rem;
        color: var(--cyber-cyan);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin: 0;
    }

    /* ⬅️ ИСПРАВЛЕННЫЕ СТИЛИ ТУЛТИПА */
    .info-tooltip-wrapper {
        position: relative;
        display: inline-flex;
        align-items: center;
        cursor: help;
        z-index: 20;
        background: none;
        border: none;
        padding: 0;
        margin: 0;
    }

    .info-icon {
        width: 18px; height: 18px;
        border-radius: 50%;
        border: 1px solid #555;
        color: #777;
        background: rgba(255, 255, 255, 0.05);
        font-family: monospace;
        font-size: 12px;
        font-weight: bold;
        display: flex; align-items: center; justify-content: center;
        transition: all 0.2s;
    }

    .info-tooltip-wrapper:hover .info-icon {
        border-color: var(--cyber-cyan);
        background: var(--cyber-cyan);
        color: #000;
        box-shadow: 0 0 10px var(--cyber-cyan);
    }

    .custom-tooltip {
        position: fixed;
        width: 340px;
        max-width: calc(100vw - 2rem);
        padding: 1rem;
        background: rgba(10, 10, 15, 0.95);
        border: 1px solid var(--cyber-cyan);
        border-radius: 8px;
        box-shadow: 0 0 20px rgba(0, 243, 255, 0.2);
        backdrop-filter: blur(10px);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.3s;
        pointer-events: none;
        z-index: 1000;
    }

    .custom-tooltip::after {
        content: '';
        position: absolute;
        bottom: -6px;
        left: 50%;
        margin-left: -6px;
        border-width: 6px;
        border-style: solid;
        border-color: var(--cyber-cyan) transparent transparent transparent;
    }

    .custom-tooltip.below::after {
        bottom: auto;
        top: -6px;
        border-color: transparent transparent var(--cyber-cyan) transparent;
    }

    .info-tooltip-wrapper:hover .custom-tooltip,
    .custom-tooltip.mobile-visible {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
    }

    .tooltip-title {
        color: var(--cyber-yellow);
        font-family: 'Chakra Petch', monospace;
        font-weight: bold;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        text-transform: uppercase;
        border-bottom: 1px dashed rgba(255,255,255,0.2);
        padding-bottom: 4px;
    }
    .tooltip-body {
        color: #ccc; font-size: 0.75rem; line-height: 1.5; text-align: left;
    }
    .tooltip-body :global(p) { margin-bottom: 0.5rem; }
    .tooltip-body :global(p:last-child) { margin-bottom: 0; }
    .tooltip-body :global(strong) { color: var(--cyber-yellow); font-weight: 800; }

    @media (max-width: 640px) {
        .custom-tooltip {
            width: 280px;
            left: 50%;
            right: auto;
            transform: translateX(-50%) translateY(10px);
        }

        .custom-tooltip::after {
            left: 50%;
            right: auto;
            margin-left: -6px;
        }

        .info-tooltip-wrapper:hover .custom-tooltip,
        .custom-tooltip.mobile-visible {
            transform: translateX(-50%) translateY(0);
        }

        .game-title {
            font-size: 1.3rem;
        }
    }

    .history-bar {
        display: flex; align-items: center; padding: 0.5rem;
        background: rgba(0,0,0,0.5); border-bottom: 1px solid rgba(255,255,255,0.1);
        overflow: hidden; height: 40px;
    }
    .history-bar .label { font-size: 0.6rem; color: #666; margin-right: 0.5rem; font-weight: bold; letter-spacing: 0.1em; }
    .history-track { display: flex; gap: 0.3rem; flex-direction: row-reverse; justify-content: flex-end; width: 100%; overflow: hidden; }
    .history-pill {
        padding: 1px 6px; border-radius: 3px; font-size: 0.65rem; font-weight: bold; font-family: monospace; white-space: nowrap;
        background: rgba(57, 255, 20, 0.1); color: #39ff14; border: 1px solid #39ff14;
    }
    .history-pill.crash { background: rgba(255, 0, 60, 0.1); color: #ff003c; border-color: #ff003c; }

    .screen-wrapper {
        position: relative; height: 350px; width: 100%;
        background: #020406; overflow: hidden;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    canvas { display: block; width: 100%; height: 100%; }

    .screen-overlay {
        position: absolute; inset: 0; pointer-events: none; z-index: 20;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        text-align: center;
        padding: 1rem;
    }

    .big-multiplier {
        font-size: 4rem; font-weight: 900; font-family: 'Chakra Petch', sans-serif;
        transition: color 0.2s, text-shadow 0.2s;
        line-height: 1;
    }
    .big-multiplier .x { font-size: 2rem; opacity: 0.7; }

    .status-box h2 { font-size: 1.5rem; color: #fff; letter-spacing: 0.2em; font-weight: bold; }
    .status-box p { color: var(--cyber-cyan); font-family: monospace; margin-top: 0.5rem; font-size: 0.8rem; }

    .crash-box h2 { font-size: 2rem; color: #ff003c; text-shadow: 0 0 20px #ff003c; animation: glitch-skew 0.3s infinite; }
    .crash-box .final-val { font-size: 1.5rem; color: #fff; font-family: monospace; }

    .cashed-out-badge {
        background: #39ff14; color: #000; padding: 0.3rem 1rem;
        font-weight: 900; font-size: 1rem; transform: rotate(-5deg);
        box-shadow: 0 0 20px #39ff14; border: 2px solid #fff;
    }

    .controls-panel { padding: 1rem; display: grid; grid-template-columns: 1fr 1.5fr; gap: 1.5rem; align-items: stretch; }

    .input-label { font-size: 0.6rem; color: #666; font-weight: bold; margin-bottom: 0.3rem; }
    .bet-input-group { display: flex; height: 3rem; width: 100%; }
    .cyber-input {
        flex: 1; min-width: 0;
        background: #0a0c10; border: 1px solid #333; color: #fff;
        text-align: center; font-size: 1.2rem; font-weight: bold;
        border-left: none; border-right: none; font-family: 'Chakra Petch', monospace;
    }
    .cyber-input:focus { outline: none; border-color: var(--cyber-cyan); }

    .adj {
        flex: 0 0 3rem;
        background: #1a1d24; border: 1px solid #333; color: #888; font-size: 1.2rem;
        cursor: pointer; transition: all 0.1s; display: flex; align-items: center; justify-content: center;
    }
    .adj:first-child { border-radius: 4px 0 0 4px; border-right: none; }
    .adj:last-child { border-radius: 0 4px 4px 0; border-left: none; }
    .adj:hover:not(:disabled) { background: #2a2d35; color: #fff; }

    .quick-bets { display: flex; gap: 0.3rem; margin-top: 0.5rem; flex-wrap: wrap; }
    .quick-bets button {
        flex: 1; min-width: 40px;
        background: rgba(255,255,255,0.05); border: none; color: #666;
        font-size: 0.65rem; padding: 6px; border-radius: 2px;
        cursor: pointer; transition: all 0.2s; font-weight: bold;
    }
    .quick-bets button:hover:not(:disabled) { background: rgba(255,255,255,0.1); color: #fff; }

    .launch-btn, .abort-btn {
        width: 100%; height: 100%; border: none; border-radius: 4px; cursor: pointer;
        position: relative; overflow: hidden; transition: transform 0.1s;
        display: flex; align-items: center; justify-content: center;
        clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px);
    }
    .launch-btn:active, .abort-btn:active { transform: scale(0.98); }

    .launch-btn { background: var(--cyber-cyan); box-shadow: 0 0 30px rgba(0, 240, 255, 0.2); }
    .launch-btn:hover { background: #00d0dd; box-shadow: 0 0 50px rgba(0, 240, 255, 0.4); }
    .launch-btn:disabled { background: #222; color: #444; box-shadow: none; cursor: not-allowed; }

    .abort-btn { background: var(--cyber-yellow); box-shadow: 0 0 30px rgba(252, 238, 10, 0.3); animation: pulse-red 0.5s infinite; }
    .abort-btn:hover { background: #ffd700; }

    .btn-content { display: flex; flex-direction: column; align-items: center; line-height: 1.1; color: #000; z-index: 2; }
    .btn-content .big { font-size: 2rem; font-weight: 900; font-family: 'Chakra Petch', monospace; letter-spacing: 0.05em; }
    .btn-content .small { font-size: 0.9rem; font-weight: bold; opacity: 0.7; }

    .footer-status {
        padding: 0.4rem 1rem; display: flex; justify-content: space-between;
        background: rgba(0,0,0,0.3); border-top: 1px solid rgba(255,255,255,0.05);
        font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; color: #444;
    }

    @media (max-width: 640px) {
        .controls-panel { grid-template-columns: 1fr; gap: 1.5rem; }
        .action-section { height: 100px; }
        .screen-wrapper { height: 300px; }
        .big-multiplier { font-size: 3.5rem; }
        .crash-box h2, .win-msg h2 { font-size: 1.5rem; }
    }
</style>
</file>

<file path="src/routes/casino/inventory/+page.svelte">
<script lang="ts">
    import type { PageData } from './$types';
    import { userStore } from '$lib/stores';
    import { onMount } from 'svelte';
    import { getFunctions, httpsCallable } from 'firebase/functions';
    import { modal } from '$lib/stores/modalStore';
    import { Howl } from 'howler';
    import { t } from 'svelte-i18n';
    import { get } from 'svelte/store';

    export let data: PageData;

    let activeTab: 'frames' | 'backgrounds' = 'frames';

    $: ownedFrames = Object.values(data.allItems).filter(item =>
        item.type === 'frame' && data.ownedItemIds.includes(item.id)
    );
    $: ownedBackgrounds = Object.values(data.allItems).filter(item =>
        item.type === 'background' && data.ownedItemIds.includes(item.id)
    );

    let selectedFrame: string | null = data.equippedFrame;
    let selectedBg: string | null = $userStore.user?.equipped_bg || null;
    let currentFrame: string | null = data.equippedFrame;
    let currentBg: string | null = $userStore.user?.equipped_bg || null;

    let isSaving = false;

    const translate = (key: string) => get(t)(key);

    let sounds: { [key: string]: Howl } = {};
    onMount(() => {
        sounds.ambient_inventory = new Howl({ src: ['/sounds/inventory.mp3'], loop: true, volume: 0.2, autoplay: true });
        sounds.equip = new Howl({ src: ['/sounds/equip.mp3'], volume: 0.7 });
        sounds.save = new Howl({ src: ['/sounds/save.mp3'], volume: 0.8 });
        sounds.click = new Howl({ src: ['/sounds/click.mp3'], volume: 0.5 });

        return () => {
            sounds.ambient_inventory?.stop();
        }
    });

    function switchTab(tab: 'frames' | 'backgrounds') {
        if (activeTab === tab) return;
        sounds.click?.play();
        activeTab = tab;
    }

    function selectItem(itemId: string | null, type: 'frame' | 'background') {
        sounds.equip?.play();
        if (type === 'frame') {
            selectedFrame = (selectedFrame === itemId) ? null : itemId;
        } else {
            selectedBg = (selectedBg === itemId) ? null : itemId;
        }
    }

    async function saveChanges() {
        if (isSaving || !hasChanges) return;
        isSaving = true;
        sounds.save?.play();

        try {
            const functions = getFunctions();
            const updateFunc = httpsCallable(functions, 'updateEquippedItems');
            await updateFunc({
                equipped_frame: selectedFrame,
                equipped_bg: selectedBg
            });

            localStorage.removeItem('protomap_markers_cache');
            localStorage.removeItem('protomap_markers_time');

            userStore.update(store => {
                if (store.user) {
                    store.user.equipped_frame = selectedFrame;
                    store.user.equipped_bg = selectedBg;
                }
                return store;
            });

            currentFrame = selectedFrame;
            currentBg = selectedBg;

            modal.success(translate('inventory.success_title'), translate('inventory.success_msg'));

        } catch (error: any) {
            modal.error(translate('inventory.error_title'), error.message || translate('inventory.error_save'));
        } finally {
            isSaving = false;
        }
    }

    $: hasChanges = (selectedFrame !== currentFrame) || (selectedBg !== currentBg);

</script>

<svelte:head>
    <title>{$t('inventory.title')} | The Glitch Pit</title>
</svelte:head>

<div class="page-container">
    <div class="bg-blur-1"></div>
    <div class="bg-blur-2"></div>

    <div class="inventory-container">
        <div class="header">
            <h1 class="title font-display glitch" data-text={$t('inventory.title')}>{$t('inventory.title')}</h1>
            <p class="subtitle">{$t('inventory.subtitle')}</p>
        </div>

        <div class="inv-tabs">
            <button class="inv-tab" class:active={activeTab === 'frames'} on:click={() => switchTab('frames')}>
                {$t('shop.tab_frames')}
            </button>
            <button class="inv-tab" class:active={activeTab === 'backgrounds'} on:click={() => switchTab('backgrounds')}>
                {$t('shop.tab_backgrounds')}
            </button>
        </div>

        <div class="wardrobe">

            <div class="preview-panel">
                <div class="preview-box {selectedBg || ''}">
                    <div class="avatar-wrapper {selectedFrame ? data.allItems[selectedFrame]?.id : ''}">
                        <img
                            src={$userStore.user?.avatar_url || `https://api.dicebear.com/7.x/bottts-neutral/svg?seed=${$userStore.user?.username}`}
                            alt="Preview"
                            class="preview-avatar"
                        />
                    </div>
                </div>

                <div class="actions">
                    <button class="panel-btn save" on:click={saveChanges} disabled={!hasChanges || isSaving}>
                        {isSaving ? $t('inventory.saving') : $t('inventory.save')}
                    </button>
                </div>
            </div>

            <div class="items-panel">
                {#if activeTab === 'frames'}
                    {#if ownedFrames.length > 0}
                        <div class="items-grid">
                            {#each ownedFrames as item (item.id)}
                                <button
                                    class="item-slot"
                                    class:selected={selectedFrame === item.id}
                                    on:click={() => selectItem(item.id, 'frame')}
                                >
                                    <div class="avatar-wrapper item-icon-preview {item.id}">
                                        <div class="avatar-placeholder"></div>
                                    </div>
                                    <span class="item-name">{item.name}</span>
                                    {#if currentFrame === item.id}
                                        <span class="equipped-tag">E</span>
                                    {/if}
                                </button>
                            {/each}
                        </div>
                        {#if selectedFrame}
                            <button class="unequip-text-btn" on:click={() => selectItem(null, 'frame')}>
                                {$t('inventory.unequip')}
                            </button>
                        {/if}
                    {:else}
                        <div class="empty-state">
                            <p>{$t('inventory.empty')}</p>
                            <a href="/casino/shop" class="panel-btn shop">{$t('inventory.go_shop')}</a>
                        </div>
                    {/if}

                {:else}
                    {#if ownedBackgrounds.length > 0}
                        <div class="items-grid">
                            {#each ownedBackgrounds as item (item.id)}
                                <button
                                    class="item-slot"
                                    class:selected={selectedBg === item.id}
                                    on:click={() => selectItem(item.id, 'background')}
                                >
                                    <div class="bg-icon-preview {item.id}">
                                        <div class="mini-profile-line"></div>
                                        <div class="mini-profile-line short"></div>
                                    </div>
                                    <span class="item-name">{item.name}</span>
                                    {#if currentBg === item.id}
                                        <span class="equipped-tag">E</span>
                                    {/if}
                                </button>
                            {/each}
                        </div>
                        {#if selectedBg}
                            <button class="unequip-text-btn" on:click={() => selectItem(null, 'background')}>
                                Unequip Background
                            </button>
                        {/if}
                    {:else}
                        <div class="empty-state">
                            <p>{$t('shop.empty_category')}</p>
                            <a href="/casino/shop" class="panel-btn shop">{$t('inventory.go_shop')}</a>
                        </div>
                    {/if}
                {/if}

            </div>
        </div>
    </div>
</div>

<style>
    @keyframes float-blur-1 { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(100px, 50px); } }
    @keyframes float-blur-2 { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(-80px, -60px); } }
    @keyframes glitch-text { 0% { text-shadow: 2px 0 #ff00c1, -2px 0 #01ffff; } 25% { text-shadow: -2px 0 #ff00c1, 2px 0 #01ffff; } 50% { text-shadow: 2px 0 #01ffff, -2px 0 #ff00c1; } 100% { text-shadow: 2px 0 #ff00c1, -2px 0 #01ffff; } }

    .page-container {
        min-height: calc(100vh - 64px);
        display: flex; align-items: center; justify-content: center;
        position: relative; overflow: hidden; background: #0a0a0a; padding: 2rem;
    }
    .bg-blur-1, .bg-blur-2 { position: absolute; width: 400px; height: 400px; border-radius: 50%; filter: blur(150px); pointer-events: none; z-index: 0; }
    .bg-blur-1 { background: var(--cyber-green); top: 10%; right: 10%; animation: float-blur-1 20s infinite ease-in-out; }
    .bg-blur-2 { background: var(--cyber-cyan); bottom: 10%; left: 10%; animation: float-blur-2 25s infinite ease-in-out; }

    .inventory-container {
        width: 100%; max-width: 1200px; z-index: 2;
        background: rgba(20, 20, 25, 0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 1.5rem;
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    }
    .header { text-align: center; padding: 2rem; border-bottom: 1px solid rgba(255, 255, 255, 0.15); }
    .title { font-size: 3rem; color: #fff; text-shadow: 0 0 15px #fff; }
    .subtitle { color: var(--text-muted-color); font-family: 'Chakra Petch', monospace; }

    /* TABS */
    .inv-tabs {
        display: flex;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .inv-tab {
        flex: 1;
        padding: 1rem;
        background: transparent;
        color: #666;
        font-family: 'Chakra Petch', monospace;
        font-weight: bold;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        border-bottom: 2px solid transparent;
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }
    .inv-tab:hover { color: #ccc; background: rgba(255,255,255,0.03); }
    .inv-tab.active { color: var(--cyber-yellow); border-bottom-color: var(--cyber-yellow); background: rgba(255,255,255,0.05); }

    .wardrobe { display: grid; grid-template-columns: 400px 1fr; }

    .preview-panel {
        padding: 2rem;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        border-right: 1px solid rgba(255, 255, 255, 0.15);
        gap: 2rem;
    }

    /* Контейнер превью (здесь применяем фон) */
    .preview-box {
        width: 100%;
        height: 350px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.1);
        background: rgba(0,0,0,0.3); /* Дефолтный фон */
        transition: all 0.3s;
        overflow: hidden;
        position: relative;
    }

    .avatar-wrapper {
        position: relative;
        width: 150px;
        height: 150px;
        border-radius: 50%;
        z-index: 5;
    }
    .preview-avatar { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

    .actions { display: flex; flex-direction: column; gap: 1rem; width: 100%; }
    .unequip-text-btn {
        width: 100%; background: transparent; border: none; color: #666; text-decoration: underline;
        cursor: pointer; font-size: 0.8rem; margin-top: 1rem;
    }
    .unequip-text-btn:hover { color: #aaa; }

    .items-panel { padding: 2rem; max-height: 70vh; overflow-y: auto; }
    .items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1.5rem; }

    .item-slot {
        background: rgba(0,0,0,0.3); border: 1px solid #333; border-radius: 0.5rem;
        padding: 1rem; display: flex; flex-direction: column; align-items: center; justify-content: center;
        text-align: center; cursor: pointer; transition: all 0.2s; position: relative;
    }
    .item-slot:hover { background: rgba(255,255,255,0.1); border-color: var(--cyber-cyan); }
    .item-slot.selected { border-color: var(--cyber-yellow); box-shadow: 0 0 15px var(--cyber-yellow); transform: scale(1.05); z-index: 2; }

    .item-icon-preview { width: 70px; height: 70px; }
    .avatar-placeholder { width: 100%; height: 100%; border-radius: 50%; background: #333; }

    /* Иконка для фона */
    .bg-icon-preview {
        width: 70px; height: 70px; border-radius: 8px;
        border: 1px solid #555;
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        gap: 5px;
    }
    .mini-profile-line { width: 40px; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; }
    .mini-profile-line.short { width: 25px; }

    .item-name { color: #ccc; font-size: 0.8rem; margin-top: 1rem; }

    .equipped-tag {
        position: absolute; top: 0.3rem; right: 0.3rem;
        background: var(--cyber-yellow); color: #000;
        font-size: 0.6rem; padding: 1px 5px; border-radius: 3px;
        font-family: 'Chakra Petch', monospace; font-weight: bold;
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #666;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2rem;
    }
    .empty-state p { font-size: 1.2rem; }

    .panel-btn {
        width: 100%;
        padding: 0.75rem 1.5rem; font-family: 'Chakra Petch', monospace; font-weight: bold;
        color: rgba(255, 255, 255, 0.8); text-transform: uppercase; letter-spacing: 0.05em;
        text-decoration: none; text-align: center;
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
        border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 0.75rem;
        box-shadow: -4px -4px 8px rgba(255, 255, 255, 0.05), 4px 4px 8px rgba(0, 0, 0, 0.3), inset 1px 1px 1px rgba(255, 255, 255, 0.1);
        transition: all 0.2s ease-in-out;
    }
    .panel-btn:hover:not(:disabled) { color: #fff; transform: translateY(-2px); }
    .panel-btn.save:hover:not(:disabled) { box-shadow: 0 0 20px var(--cyber-yellow); border-color: var(--cyber-yellow); }
    .panel-btn.shop:hover:not(:disabled) { box-shadow: 0 0 20px var(--cyber-cyan); border-color: var(--cyber-cyan); }
    .panel-btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

    @media (max-width: 1024px) {
        .wardrobe { grid-template-columns: 1fr; }
        .preview-panel { border-right: none; border-bottom: 1px solid rgba(255, 255, 255, 0.15); }
        .preview-box { height: 250px; }
        .items-panel { max-height: none; }
    }

    @media (max-width: 640px) {
        .page-container { padding: 1rem; }
        .header { padding: 1rem; }
        .title { font-size: 2rem; }
        .items-grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 1rem; }
        .item-slot { padding: 0.5rem; }
        .item-icon-preview, .bg-icon-preview { width: 50px; height: 50px; }
    }
</style>
</file>

<file path="src/routes/casino/shop/+page.server.ts">
import { firestoreAdmin } from '$lib/server/firebase.admin';
import type { PageServerLoad } from './$types';

export type ShopItem = {
    id: string;
    name: string;
    description: string;
    price: number;
    type: 'frame' | 'badge';
    style_value: string;
};

const HIDDEN_ITEMS = ['frame_dev', 'frame_beta', 'frame_ludoman', 'frame_aurora', 'frame_cryo', 'frame_festive'];

export const load: PageServerLoad = async ({ locals, setHeaders }) => {
    try {
        const itemsSnapshot = await firestoreAdmin.collection('shop_items').orderBy('price', 'asc').get();

        let items: ShopItem[] = itemsSnapshot.docs.map(doc => {
            const data = doc.data();
            return {
                id: doc.id,
                name: data.name || 'Без названия',
                description: data.description || 'Нет описания',
                price: data.price || 99999,
                type: data.type || 'frame',
                style_value: data.style_value || ''
            };
        });

        items = items.filter(item => !HIDDEN_ITEMS.includes(item.id));

        let ownedItemIds: string[] = [];
        if (locals.user) {
            const userDoc = await firestoreAdmin.collection('users').doc(locals.user.uid).get();
            if (userDoc.exists) {
                ownedItemIds = userDoc.data()?.owned_items || [];
            }
        }

        setHeaders({ 'Cache-Control': 'public, max-age=300, s-maxage=3600' });

        return {
            items: items,
            ownedItemIds: ownedItemIds
        };

    } catch (error) {
        console.error("Ошибка загрузки товаров из магазина:", error);
        return {
            items: [],
            ownedItemIds: []
        };
    }
};
</file>

<file path="src/routes/login/+page.svelte">
<script lang="ts">
    import { auth, db } from "$lib/firebase";
    import {
        signInWithEmailAndPassword,
        signInWithPopup,
        GoogleAuthProvider,
        sendPasswordResetEmail
    } from "firebase/auth";
    import { doc, getDoc, setDoc, serverTimestamp } from "firebase/firestore";
    import { goto } from "$app/navigation";
    import NeonButton from '$lib/components/NeonButton.svelte';
    import CyberTurnstile from '$lib/components/CyberTurnstile.svelte';
    import { onMount } from 'svelte';
    import { quintOut } from 'svelte/easing';
    import { tweened } from 'svelte/motion';
    import { modal } from '$lib/stores/modalStore';
    import { slide } from 'svelte/transition';
    import { getFunctions, httpsCallable } from "firebase/functions";
    import { userStore } from '$lib/stores';
    import { t } from 'svelte-i18n';

    let email = "";
    let password = "";
    let loading = false;
    let googleLoading = false;
    let isResetMode = false;

    let turnstileToken = '';
    let turnstileVerified = false;

    const TURNSTILE_SITE_KEY = "0x4AAAAAACYHm8usBkEdoF37";

    const opacity = tweened(0, { duration: 400, easing: quintOut });
    onMount(() => {
        opacity.set(1);
    });

    function handleTurnstileVerified(event: CustomEvent) {
        turnstileToken = event.detail.token;
        turnstileVerified = true;
        console.log('✅ Капча пройдена');
    }

    function handleTurnstileError() {
        turnstileVerified = false;
        modal.error("Ошибка капчи", "Не удалось загрузить проверку. Попробуйте обновить страницу.");
    }

    async function isUsernameAvailable(name: string): Promise<boolean> {
        const trimmedName = name.trim();
        if (trimmedName.length < 4) return false;
        try {
            const functions = getFunctions();
            const checkUsernameFunc = httpsCallable(functions, 'checkUsername');
            const result = await checkUsernameFunc({ username: trimmedName });
            return (result.data as { isAvailable: boolean }).isAvailable;
        } catch (e) {
            console.error("Ошибка проверки username:", e);
            return false;
        }
    }

    async function handleLogin() {
        if (!turnstileVerified) {
            modal.error("Требуется проверка", "Пожалуйста, подтвердите, что вы не робот.");
            return;
        }

        if (!email || !password) {
            modal.error("Ошибка ввода", "Пожалуйста, заполните все поля.");
            return;
        }

        loading = true;

        try {
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;

            console.log("✅ Вход выполнен:", user.uid);

            // Загружаем профиль из Firestore
            const userDocRef = doc(db, "users", user.uid);
            const userDocSnap = await getDoc(userDocRef);

            if (userDocSnap.exists()) {
                const data = userDocSnap.data();

                // 🔥 FIX: Принудительно обновляем userStore
                const profileData = {
                    uid: user.uid,
                    username: data.username,
                    email: user.email,
                    emailVerified: user.emailVerified,
                    avatar_url: data.avatar_url || "",
                    social_link: data.social_link || "",
                    about_me: data.about_me || "",
                    status: data.status || "",
                    casino_credits: data.casino_credits ?? 100,
                    last_daily_bonus: data.last_daily_bonus ? data.last_daily_bonus.toDate() : null,
                    daily_streak: data.daily_streak || 0,
                    owned_items: data.owned_items || [],
                    equipped_frame: data.equipped_frame || null,
                    equipped_badge: data.equipped_badge || null,
                    equipped_bg: data.equipped_bg || null,
                    blocked_uids: data.blocked_uids || []
                };

                userStore.set({ user: profileData, loading: false });
            }

            // Обновляем cookie
            const token = await user.getIdToken();
            await fetch('/api/auth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ idToken: token }),
            });

            // Небольшая задержка для синхронизации UI
            await new Promise(resolve => setTimeout(resolve, 300));

            goto('/');

        } catch (e: any) {
            console.error("❌ Ошибка входа:", e.code);
            if (e.code === 'auth/invalid-credential' || e.code === 'auth/invalid-email' || e.code === 'auth/wrong-password') {
                modal.error("Ошибка входа", "Неверный email или пароль.");
            } else if (e.code === 'auth/user-not-found') {
                 modal.error("Ошибка входа", "Пользователь с таким email не найден.");
            } else {
                modal.error("Системная ошибка", "Произошла неизвестная ошибка при входе.");
            }
        } finally {
            loading = false;
        }
    }

    async function handleResetPassword() {
        if (!turnstileVerified) {
            modal.error("Требуется проверка", "Пожалуйста, подтвердите, что вы не робот.");
            return;
        }

        if (!email) {
            modal.error("Ошибка ввода", "Введите Email, на который зарегистрирован аккаунт.");
            return;
        }

        loading = true;

        try {
            await sendPasswordResetEmail(auth, email);
            modal.success("Письмо отправлено", `Ссылка для сброса пароля отправлена на <strong>${email}</strong>. Проверьте почту (и папку Спам).`);
            isResetMode = false;
        } catch (e: any) {
            console.error("Ошибка сброса:", e.code);
            if (e.code === 'auth/user-not-found') {
                modal.error("Ошибка", "Пользователь с таким email не найден.");
            } else if (e.code === 'auth/invalid-email') {
                modal.error("Ошибка", "Некорректный формат email.");
            } else {
                modal.error("Ошибка", "Не удалось отправить письмо. Попробуйте позже.");
            }
        } finally {
            loading = false;
        }
    }

    async function handleGoogleLogin() {
        if (!turnstileVerified) {
            modal.error("Требуется проверка", "Пожалуйста, подтвердите, что вы не робот.");
            return;
        }

        googleLoading = true;
        const provider = new GoogleAuthProvider();

        try {
            const result = await signInWithPopup(auth, provider);
            const user = result.user;

            console.log("✅ Google Auth:", user.uid);
            await user.getIdToken(true);

            const userDocRef = doc(db, "users", user.uid);
            let userDocSnap = await getDoc(userDocRef);

            if (!userDocSnap.exists()) {
                console.log("📝 Новый Google юзер, создаём профиль...");

                let generatedUsername = user.displayName || '';
                generatedUsername = generatedUsername.replace(/[^a-zA-Z0-9_]/g, '');

                if (generatedUsername.length < 3) {
                    generatedUsername = `user_${user.uid.substring(0, 8)}`;
                }

                if (generatedUsername.length > 20) {
                    generatedUsername = generatedUsername.substring(0, 20);
                }

                const isAvailable = await isUsernameAvailable(generatedUsername);
                if (!isAvailable) {
                    const randomSuffix = Math.floor(Math.random() * 9999);
                    generatedUsername = `${generatedUsername.substring(0, 15)}_${randomSuffix}`;
                }

                console.log('🔧 Username:', generatedUsername);

                await setDoc(userDocRef, {
                    username: generatedUsername,
                    email: user.email || "",
                    avatar_url: user.photoURL || "",
                    about_me: "",
                    social_link: "",
                    createdAt: serverTimestamp(),
                    casino_credits: 100,
                    glitch_shards: 0,
                    last_daily_bonus: null,
                    owned_items: [],
                    daily_streak: 0,
                    isBanned: false,
                    emailVerified: user.emailVerified,
                    turnstileVerified: true
                });

                console.log('✅ Профиль создан');

                // 🔥 FIX: Принудительно обновляем userStore
                const profileData = {
                    uid: user.uid,
                    username: generatedUsername,
                    email: user.email || "",
                    emailVerified: user.emailVerified,
                    avatar_url: user.photoURL || "",
                    social_link: "",
                    about_me: "",
                    status: "",
                    casino_credits: 100,
                    last_daily_bonus: null,
                    daily_streak: 0,
                    owned_items: [],
                    equipped_frame: null,
                    equipped_badge: null,
                    equipped_bg: null,
                    blocked_uids: []
                };

                userStore.set({ user: profileData, loading: false });

                await new Promise(resolve => setTimeout(resolve, 300));

            } else {
                console.log('✅ Профиль существует');

                // 🔥 FIX: Загружаем и обновляем userStore для существующих юзеров
                const data = userDocSnap.data();
                const profileData = {
                    uid: user.uid,
                    username: data.username,
                    email: user.email || "",
                    emailVerified: user.emailVerified,
                    avatar_url: data.avatar_url || "",
                    social_link: data.social_link || "",
                    about_me: data.about_me || "",
                    status: data.status || "",
                    casino_credits: data.casino_credits ?? 100,
                    last_daily_bonus: data.last_daily_bonus ? data.last_daily_bonus.toDate() : null,
                    daily_streak: data.daily_streak || 0,
                    owned_items: data.owned_items || [],
                    equipped_frame: data.equipped_frame || null,
                    equipped_badge: data.equipped_badge || null,
                    equipped_bg: data.equipped_bg || null,
                    blocked_uids: data.blocked_uids || []
                };

                userStore.set({ user: profileData, loading: false });
            }

            const token = await user.getIdToken();
            await fetch('/api/auth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ idToken: token }),
            });

            console.log('✅ Вход выполнен');

            await new Promise(resolve => setTimeout(resolve, 300));

            goto('/');

        } catch (e: any) {
            console.error("❌ Google вход:", e);

            if (e.code === 'permission-denied' || e.message.includes('insufficient permissions')) {
                modal.error("Ошибка создания профиля", "Не удалось создать профиль. Попробуйте снова.");
            } else if (e.code === 'auth/popup-blocked') {
                modal.error("Окно заблокировано", "Разрешите всплывающие окна.");
            } else if (e.code === 'auth/cancelled-popup-request') {
                console.log("Отменено");
            } else {
                modal.error("Ошибка", `Не удалось войти: ${e.message}`);
            }
        } finally {
            googleLoading = false;
        }
    }

    function toggleResetMode() {
        isResetMode = !isResetMode;
        password = '';
    }
</script>

<svelte:head>
    <title>{isResetMode ? $t('auth.recover_title') : $t('auth.login_title')} | ProtoMap</title>
</svelte:head>

<div class="form-container cyber-panel pb-12" style="opacity: {$opacity}">
    <div class="corner top-left"></div>
    <div class="corner top-right"></div>
    <div class="corner bottom-left"></div>
    <div class="corner bottom-right"></div>

    <h2 class="form-title font-display">
        {isResetMode ? $t('auth.recover_title') : $t('auth.login_title')}
    </h2>

    <form on:submit|preventDefault={isResetMode ? handleResetPassword : handleLogin} class="space-y-6" novalidate>

        <div class="form-group">
            <label for="email" class="form-label font-display">{$t('auth.email_label')}</label>
            <input bind:value={email} type="email" id="email" name="email" class="input-field" placeholder="name@example.com">
        </div>

        {#if !isResetMode}
            <div class="form-group" transition:slide>
                <label for="password" class="form-label font-display">{$t('auth.password_label')}</label>
                <input bind:value={password} type="password" id="password" name="password" class="input-field">

                <div class="text-right mt-2">
                    <button type="button" on:click={toggleResetMode} class="text-xs text-cyber-yellow hover:text-white underline transition-colors">
                        {$t('auth.forgot_pass')}
                    </button>
                </div>
            </div>
        {/if}

        <div class="form-group flex justify-center">
            <CyberTurnstile
                siteKey={TURNSTILE_SITE_KEY}
                on:verified={handleTurnstileVerified}
                on:error={handleTurnstileError}
            />
        </div>

        <div class="pt-2">
            <NeonButton type="submit" disabled={loading || googleLoading || !turnstileVerified} extraClass="w-full">
                {#if loading}
                    {$t('ui.loading')}
                {:else}
                    {isResetMode ? $t('auth.recover_btn') : $t('auth.login_btn')}
                {/if}
            </NeonButton>

            {#if isResetMode}
                <button type="button" on:click={toggleResetMode} class="w-full mt-4 text-sm text-gray-500 hover:text-white transition-colors" transition:slide>
                    {$t('auth.back_to_login')}
                </button>
            {/if}
        </div>
    </form>

    {#if !isResetMode}
        <div class="relative my-6" transition:slide>
            <div class="absolute inset-0 flex items-center" aria-hidden="true"><div class="w-full border-t border-gray-700/50"></div></div>
            <div class="relative flex justify-center text-sm"><span class="px-3 bg-gray-900 text-gray-500 uppercase font-display tracking-wider">{$t('auth.or')}</span></div>
        </div>

        <div class="text-center" transition:slide>
            <button on:click={handleGoogleLogin} disabled={googleLoading || loading || !turnstileVerified} type="button" title="Войти с помощью Google" class="google-btn">
                <svg class="w-6 h-6" viewBox="0 0 48 48">
                    <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path>
                    <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path>
                    <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.223,0-9.65-3.657-11.303-8l-6.571,4.819C9.656,39.663,16.318,44,24,44z"></path>
                    <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C41.38,36.435,44,30.836,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path>
                </svg>
            </button>
        </div>

        <p class="mt-8 text-center text-sm text-gray-500" transition:slide>
            {$t('auth.no_account')} <a href="/register" class="font-bold text-cyber-yellow hover:text-white">{$t('auth.register_btn')}</a>
        </p>
    {/if}
</div>

<style>
    .form-container {
        transition: opacity 0.4s ease-in-out;
    }
    .form-container {
        @apply max-w-lg mx-auto my-10 p-8 rounded-none shadow-2xl relative;
        background: rgba(10, 10, 10, 0.5); backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        border: 1px solid rgba(252, 238, 10, 0.2);
        clip-path: polygon(0 15px, 15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%);
    }
    @media (max-width: 640px) { .form-container { @apply my-4 mx-4 p-6; } }

    .form-title { @apply text-2xl lg:text-3xl font-bold text-center text-white mb-10;text-shadow: none; }
    .form-group { }
    .form-label { @apply block text-sm font-bold uppercase tracking-widest text-cyber-yellow mb-2; }
    .input-field {
        @apply block w-full p-2 bg-transparent text-gray-200;
        border: none; border-bottom: 1px solid var(--border-color, #30363d);
        border-radius: 0; font-family: 'Inter', sans-serif;
        font-size: 1.1em; transition: border-color 0.3s, box-shadow 0.3s;
    }
    .input-field:focus { @apply outline-none; border-bottom-color: var(--cyber-yellow, #fcee0a); box-shadow: 0 1px 0 var(--cyber-yellow, #fcee0a); }

    .google-btn {
        @apply inline-flex justify-center items-center w-12 h-12 p-3 border border-gray-700 rounded-full shadow-sm;
        background-color: var(--input-bg-color);
        transition: background-color 0.2s, border-color 0.2s;
    }
    .google-btn:hover:not(:disabled) {
        background-color: var(--secondary-bg-color);
        border-color: var(--border-color);
    }
    .google-btn:disabled { @apply opacity-50 cursor-not-allowed; }
</style>
</file>

<file path="src/routes/privacy-policy/+page.svelte">
<script lang="ts">
    import { onMount } from 'svelte';
    import { quintOut } from 'svelte/easing';
    import { tweened } from 'svelte/motion';
    import { t } from 'svelte-i18n';

    const opacity = tweened(0, { duration: 400, easing: quintOut });
    onMount(() => {
        opacity.set(1);
    });
</script>

<svelte:head>
    <title>{$t('privacy.title')} | ProtoMap</title>
</svelte:head>

<div class="legal-container cyber-panel" style="opacity: {$opacity}">
    <h1 class="title font-display">{$t('privacy.title')}</h1>
    <p class="subtitle">{$t('privacy.subtitle')}</p>

    <div class="content-text">

        <!-- === DISCLAIMER === -->
        <div class="disclaimer-box">
            <strong class="text-red-500 font-display text-lg">{$t('privacy.disclaimer_header')}</strong>
            <p class="mt-2 text-sm">{@html $t('privacy.disclaimer_body')}</p>
        </div>

        <!-- === 1. INTRO === -->
        <h3 class="section-title">{$t('privacy.intro_header')}</h3>
        <p>{@html $t('privacy.intro_body')}</p>

        <h4 class="subsection-title">{$t('privacy.consent_header')}</h4>
        <p>{@html $t('privacy.consent_body')}</p>

        <!-- === 2. DATA COLLECTION === -->
        <h3 class="section-title">{$t('privacy.data_chapter.title')}</h3>
        <p>{$t('privacy.data_chapter.intro')}</p>

        <h4 class="subsection-title">{$t('privacy.data_chapter.account_title')}</h4>
        <p>{$t('privacy.data_chapter.account_text')}</p>
        <ul>
            {#each $t('privacy.data_chapter.account_list') as item} <li>{@html item}</li> {/each}
        </ul>

        <h4 class="subsection-title">{$t('privacy.data_chapter.tech_title')}</h4>
        <p>{$t('privacy.data_chapter.tech_text')}</p>
        <ul>
            {#each $t('privacy.data_chapter.tech_list') as item} <li>{@html item}</li> {/each}
        </ul>

        <h4 class="subsection-title">{$t('privacy.data_chapter.chat_title')}</h4>
        <div class="alert-box warning">
            <p>{$t('privacy.data_chapter.chat_warning')}</p>
        </div>
        <ul>
            {#each $t('privacy.data_chapter.chat_list') as item} <li>{@html item}</li> {/each}
        </ul>

        <h4 class="subsection-title">{$t('privacy.data_chapter.sticker_title')}</h4>
        <p>{$t('privacy.data_chapter.sticker_text')}</p>
        <p class="text-xs text-gray-400 mt-2 border-l-2 border-gray-600 pl-2">
            {$t('privacy.data_chapter.sticker_dmca')}
        </p>

        <h4 class="subsection-title">{$t('privacy.data_chapter.game_title')}</h4>
        <p>{$t('privacy.data_chapter.game_text')}</p>
        <ul>
            {#each $t('privacy.data_chapter.game_list') as item} <li>{@html item}</li> {/each}
        </ul>

        <!-- === 3. GEOLOCATION === -->
        <h3 class="section-title">{$t('privacy.geo_chapter.title')}</h3>
        <p>{$t('privacy.geo_chapter.intro')}</p>

        <h4 class="subsection-title">{$t('privacy.geo_chapter.modes_title')}</h4>
        <p>{$t('privacy.geo_chapter.modes_text')}</p>

        <div class="pl-4 border-l-2 border-cyber-cyan my-4">
            <strong class="text-cyber-cyan">{$t('privacy.geo_chapter.auto_mode_title')}</strong>
            <p class="text-sm my-2">{$t('privacy.geo_chapter.auto_mode_desc')}</p>
            <ul>
                {#each $t('privacy.geo_chapter.auto_mode_list') as item} <li>{@html item}</li> {/each}
            </ul>
        </div>

        <div class="pl-4 border-l-2 border-yellow-500 my-4">
            <strong class="text-yellow-500">{$t('privacy.geo_chapter.manual_mode_title')}</strong>
            <p class="text-sm my-2">{$t('privacy.geo_chapter.manual_mode_desc')}</p>
            <ul>
                {#each $t('privacy.geo_chapter.manual_mode_list') as item} <li>{@html item}</li> {/each}
            </ul>
        </div>

        <h4 class="subsection-title">{$t('privacy.geo_chapter.storage_title')}</h4>
        <ul>
            {#each $t('privacy.geo_chapter.storage_list') as item} <li>{@html item}</li> {/each}
        </ul>

        <div class="alert-box error mt-4">
            <p>{$t('privacy.geo_chapter.safety_warning')}</p>
        </div>

        <!-- === 4. RIGHTS === -->
        <h3 class="section-title">{$t('privacy.rights_chapter.title')}</h3>
        <p>{$t('privacy.rights_chapter.intro')}</p>

        <h4 class="subsection-title">{$t('privacy.rights_chapter.edit_title')}</h4>
        <p>{$t('privacy.rights_chapter.edit_text')}</p>

        <h4 class="subsection-title text-red-400">{$t('privacy.rights_chapter.delete_title')}</h4>
        <p>{$t('privacy.rights_chapter.delete_desc')}</p>
        <p class="mt-2">{$t('privacy.rights_chapter.delete_consequences_intro')}</p>
        <ul>
            {#each $t('privacy.rights_chapter.delete_consequences_list') as item} <li>{@html item}</li> {/each}
        </ul>
        <p class="text-xs text-gray-500 italic mt-2">{$t('privacy.rights_chapter.anonymization_note')}</p>

        <h4 class="subsection-title">{$t('privacy.rights_chapter.export_title')}</h4>
        <p>{$t('privacy.rights_chapter.export_text')}</p>

        <!-- === 5. PARTNERS === -->
        <h3 class="section-title">{$t('privacy.partners_chapter.title')}</h3>
        <p>{$t('privacy.partners_chapter.intro')}</p>

        <h4 class="subsection-title">{$t('privacy.partners_chapter.infra_title')}</h4>
        <ul>
            {#each $t('privacy.partners_chapter.infra_list') as item} <li>{@html item}</li> {/each}
        </ul>

        <h4 class="subsection-title">{$t('privacy.partners_chapter.services_title')}</h4>
        <ul>
            {#each $t('privacy.partners_chapter.services_list') as item} <li>{@html item}</li> {/each}
        </ul>

        <h4 class="subsection-title">{$t('privacy.partners_chapter.legal_title')}</h4>
        <p>{$t('privacy.partners_chapter.legal_text')}</p>

        <!-- === 6. SECURITY === -->
        <h3 class="section-title">{$t('privacy.security_chapter.title')}</h3>
        <p>{$t('privacy.security_chapter.intro')}</p>

        <h4 class="subsection-title">{$t('privacy.security_chapter.measures_title')}</h4>
        <ul>
            {#each $t('privacy.security_chapter.measures_list') as item} <li>{@html item}</li> {/each}
        </ul>

        <h4 class="subsection-title text-yellow-500">{$t('privacy.security_chapter.warranty_title')}</h4>
        <p>{$t('privacy.security_chapter.warranty_text')}</p>
        <ul>
            {#each $t('privacy.security_chapter.warranty_list') as item} <li>{@html item}</li> {/each}
        </ul>

        <!-- === 7. CONTACTS === -->
        <h3 class="section-title">{$t('privacy.contact_chapter.title')}</h3>

        <h4 class="subsection-title">{$t('privacy.contact_chapter.changes_title')}</h4>
        <p>{$t('privacy.contact_chapter.changes_text')}</p>

        <h4 class="subsection-title">{$t('privacy.contact_chapter.contact_title')}</h4>
        <p>{$t('privacy.contact_chapter.contact_text')}</p>
        <p class="mt-4 border-t border-gray-700 pt-4">
            {$t('privacy.contact_chapter.email_label')} <br>
            <a href="mailto:{$t('privacy.contact_chapter.email_value')}" class="link text-xl font-bold">
                {$t('privacy.contact_chapter.email_value')}
            </a>
        </p>
    </div>
</div>

<style>
    .legal-container {
        max-width: 900px;
        margin: 2.5rem auto;
        padding: 3rem;
        background: rgba(10, 12, 15, 0.85);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        clip-path: polygon(0 20px, 20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%);
    }

    .disclaimer-box {
        background: rgba(255, 0, 60, 0.1);
        border: 1px solid var(--cyber-red, #ff003c);
        padding: 1.5rem;
        margin-bottom: 2.5rem;
        color: #ffccd5;
        border-radius: 4px;
    }

    .alert-box {
        padding: 1rem;
        margin: 1rem 0;
        border-left: 4px solid;
        background: rgba(0, 0, 0, 0.2);
        font-size: 0.9rem;
    }
    .alert-box.warning {
        border-color: #facc15; /* Yellow */
        color: #fef08a;
    }
    .alert-box.error {
        border-color: #ef4444; /* Red */
        color: #fecaca;
    }

    .title {
        font-size: 2.5rem;
        font-weight: 700;
        text-align: center;
        color: #fff;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        text-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
    }

    .subtitle {
        text-align: center;
        color: var(--text-muted-color, #909dab);
        margin-bottom: 3rem;
        font-family: 'Chakra Petch', monospace;
        font-size: 0.9rem;
    }

    .content-text {
        font-size: 1rem;
        line-height: 1.7;
        color: #d1d5db;
    }

    .content-text p {
        margin-bottom: 1rem;
        text-align: justify;
    }

    .section-title {
        font-family: 'Chakra Petch', monospace;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--cyber-yellow, #fcee0a);
        margin-top: 3.5rem;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 0.5rem;
        text-transform: uppercase;
    }

    .subsection-title {
        font-family: 'Chakra Petch', monospace;
        font-size: 1.1rem;
        font-weight: 700;
        color: #fff;
        margin-top: 2rem;
        margin-bottom: 0.8rem;
    }

    .content-text ul {
        list-style-type: none;
        padding-left: 0.5rem;
        margin-bottom: 1.5rem;
    }

    .content-text li {
        position: relative;
        padding-left: 1.5rem;
        margin-bottom: 0.6rem;
        font-size: 0.95rem;
    }

    .content-text li::before {
        content: '>';
        position: absolute;
        left: 0;
        color: var(--cyber-yellow, #fcee0a);
        font-weight: bold;
        font-family: 'Chakra Petch', monospace;
    }

    .link {
        color: var(--cyber-cyan, #00f0ff);
        text-decoration: none;
        border-bottom: 1px dashed var(--cyber-cyan);
        transition: all 0.2s;
    }

    .link:hover {
        color: #fff;
        border-bottom-style: solid;
        text-shadow: 0 0 10px var(--cyber-cyan);
    }

    @media (max-width: 640px) {
        .legal-container {
            margin: 1rem;
            padding: 1.5rem;
        }
        .title {
            font-size: 1.8rem;
        }
    }
</style>
</file>

<file path="src/routes/terms-of-service/+page.svelte">
<script lang="ts">
    import { onMount } from 'svelte';
    import { quintOut } from 'svelte/easing';
    import { tweened } from 'svelte/motion';
    import { t } from 'svelte-i18n';

    const opacity = tweened(0, { duration: 400, easing: quintOut });
    onMount(() => {
        opacity.set(1);
    });
</script>

<svelte:head>
    <title>{$t('terms.title')} | ProtoMap</title>
</svelte:head>

<div class="legal-container cyber-panel" style="opacity: {$opacity}">
    <h1 class="title font-display">{$t('terms.title')}</h1>
    <p class="subtitle">{$t('terms.subtitle')}</p>

    <div class="content-text">

        <!-- === DISCLAIMER (ГЛАВНЫЙ) === -->
        <div class="disclaimer-box warning">
            <strong class="font-display text-lg">{$t('terms.disclaimer_block.title')}</strong>
            <p class="mt-2 text-sm">{@html $t('terms.disclaimer_block.text')}</p>
        </div>

        <!-- === 1. INTRO & LICENSE === -->
        <h3 class="section-title">{$t('terms.intro_chapter.title')}</h3>

        <h4 class="subsection-title">{$t('terms.intro_chapter.definitions_title')}</h4>
        <p>{$t('terms.intro_chapter.definitions_text')}</p>
        <ul>
            {#each $t('terms.intro_chapter.definitions_list') as item} <li>{@html item}</li> {/each}
        </ul>
        <p class="mt-2">{$t('terms.intro_chapter.scope_text')}</p>

        <h4 class="subsection-title">{$t('terms.intro_chapter.acceptance_title')}</h4>
        <p>{$t('terms.intro_chapter.acceptance_text')}</p>
        <ul>
            {#each $t('terms.intro_chapter.acceptance_list') as item} <li>{@html item}</li> {/each}
        </ul>
        <div class="alert-box error mt-4 font-bold text-center">
            {$t('terms.intro_chapter.rejection_warning')}
        </div>

        <h4 class="subsection-title">{$t('terms.intro_chapter.license_title')}</h4>
        <p>{$t('terms.intro_chapter.license_text')}</p>

        <!-- === 2. BEHAVIOR (CODE OF CONDUCT) === -->
        <h3 class="section-title">{$t('terms.behavior_chapter.title')}</h3>

        <h4 class="subsection-title">{$t('terms.behavior_chapter.ugc_title')}</h4>
        <p>{$t('terms.behavior_chapter.ugc_text')}</p>
        <ul>
            {#each $t('terms.behavior_chapter.ugc_list') as item} <li>{@html item}</li> {/each}
        </ul>

        <h4 class="subsection-title text-red-400">{$t('terms.behavior_chapter.zero_tolerance_title')}</h4>
        <p>{$t('terms.behavior_chapter.zero_tolerance_text')}</p>
        <ul>
            {#each $t('terms.behavior_chapter.zero_tolerance_list') as item} <li>{@html item}</li> {/each}
        </ul>

        <h4 class="subsection-title">{$t('terms.behavior_chapter.stickers_title')}</h4>
        <p>{$t('terms.behavior_chapter.stickers_text')}</p>
        <ul>
            {#each $t('terms.behavior_chapter.stickers_list') as item} <li>{@html item}</li> {/each}
        </ul>

        <h4 class="subsection-title">{$t('terms.behavior_chapter.tech_abuse_title')}</h4>
        <p>{$t('terms.behavior_chapter.tech_abuse_text')}</p>
        <ul>
            {#each $t('terms.behavior_chapter.tech_abuse_list') as item} <li>{@html item}</li> {/each}
        </ul>

        <h4 class="subsection-title">{$t('terms.behavior_chapter.enforcement_title')}</h4>
        <p>{$t('terms.behavior_chapter.enforcement_text')}</p>
        <ul>
            {#each $t('terms.behavior_chapter.enforcement_list') as item} <li>{@html item}</li> {/each}
        </ul>

        <!-- === 3. VIRTUAL ASSETS === -->
        <h3 class="section-title">{$t('terms.virtual_chapter.title')}</h3>

        <h4 class="subsection-title">{$t('terms.virtual_chapter.currency_title')}</h4>
        <p>{$t('terms.virtual_chapter.currency_text')}</p>
        <ul>
            {#each $t('terms.virtual_chapter.currency_list') as item} <li>{@html item}</li> {/each}
        </ul>

        <h4 class="subsection-title">{$t('terms.virtual_chapter.casino_title')}</h4>
        <p>{$t('terms.virtual_chapter.casino_text')}</p>
        <ul>
            {#each $t('terms.virtual_chapter.casino_list') as item} <li>{@html item}</li> {/each}
        </ul>

        <h4 class="subsection-title">{$t('terms.virtual_chapter.rmt_title')}</h4>
        <p>{$t('terms.virtual_chapter.rmt_text')}</p>
        <div class="alert-box error mt-2">
            <p>{$t('terms.virtual_chapter.rmt_warning')}</p>
        </div>

        <h4 class="subsection-title">{$t('terms.virtual_chapter.management_title')}</h4>
        <p>{$t('terms.virtual_chapter.management_text')}</p>
        <ul>
            {#each $t('terms.virtual_chapter.management_list') as item} <li>{@html item}</li> {/each}
        </ul>

        <!-- === 4. WARRANTIES (AS IS) === -->
        <h3 class="section-title">{$t('terms.warranty_chapter.title')}</h3>

        <h4 class="subsection-title">{$t('terms.warranty_chapter.asis_title')}</h4>
        <p>{$t('terms.warranty_chapter.asis_text')}</p>
        <ul>
            {#each $t('terms.warranty_chapter.asis_list') as item} <li>{@html item}</li> {/each}
        </ul>

        <h4 class="subsection-title">{$t('terms.warranty_chapter.real_world_title')}</h4>
        <p>{$t('terms.warranty_chapter.real_world_text')}</p>
        <ul>
            {#each $t('terms.warranty_chapter.real_world_list') as item} <li>{@html item}</li> {/each}
        </ul>

        <!-- === 5. FINAL & EASTER EGG === -->
        <h3 class="section-title">{$t('terms.final_chapter.title')}</h3>

        <h4 class="subsection-title text-red-400">{$t('terms.final_chapter.termination_title')}</h4>
        <p>{$t('terms.final_chapter.termination_text')}</p>
        <ul>
            {#each $t('terms.final_chapter.termination_list') as item} <li>{@html item}</li> {/each}
        </ul>

        <h4 class="subsection-title">{$t('terms.final_chapter.updates_title')}</h4>
        <p>{$t('terms.final_chapter.updates_text')}</p>

        <h4 class="subsection-title">{$t('terms.final_chapter.severability_title')}</h4>
        <p>{$t('terms.final_chapter.severability_text')}</p>

        <!-- ПАСХАЛКА (FORCE MAJEURE) -->
        <div class="easter-egg-box mt-8">
            <h4 class="subsection-title text-purple-400">{$t('terms.final_chapter.easter_egg_title')}</h4>
            <p>{$t('terms.final_chapter.easter_egg_text')}</p>
            <ul>
                {#each $t('terms.final_chapter.easter_egg_list') as item} <li>{@html item}</li> {/each}
            </ul>
        </div>

        <!-- КОНТАКТЫ -->
        <h4 class="subsection-title">{$t('terms.final_chapter.contact_title')}</h4>
        <p>
            {$t('terms.final_chapter.contact_text')}
            <br>
            <a href="mailto:{$t('terms.final_chapter.contact_email')}" class="link text-xl font-bold">
                {$t('terms.final_chapter.contact_email')}
            </a>
        </p>

    </div>
</div>

<style>
    .legal-container {
        max-width: 900px;
        margin: 2.5rem auto;
        padding: 3rem;
        background: rgba(10, 12, 15, 0.85);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        clip-path: polygon(0 20px, 20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%);
    }

    /* Блоки предупреждений */
    .disclaimer-box, .alert-box {
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1.5rem;
    }

    .disclaimer-box.warning, .alert-box.warning {
        background: rgba(252, 238, 10, 0.1);
        border: 1px solid var(--cyber-yellow, #fcee0a);
        color: #fff;
    }

    .alert-box.error {
        background: rgba(255, 0, 60, 0.1);
        border: 1px solid var(--cyber-red, #ff003c);
        color: #ffccd5;
    }

    /* Пасхалка */
    .easter-egg-box {
        background: rgba(189, 0, 255, 0.05);
        border: 1px dashed #bd00ff;
        padding: 1.5rem;
        border-radius: 8px;
    }

    .title {
        font-size: 2.5rem;
        font-weight: 700;
        text-align: center;
        color: #fff;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        text-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
    }

    .subtitle {
        text-align: center;
        color: var(--text-muted-color, #909dab);
        margin-bottom: 3rem;
        font-family: 'Chakra Petch', monospace;
        font-size: 0.9rem;
    }

    .content-text {
        font-size: 1rem;
        line-height: 1.7;
        color: #d1d5db;
    }

    .content-text p {
        margin-bottom: 1rem;
        text-align: justify;
    }

    .section-title {
        font-family: 'Chakra Petch', monospace;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--cyber-yellow, #fcee0a);
        margin-top: 3.5rem;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 0.5rem;
        text-transform: uppercase;
    }

    .subsection-title {
        font-family: 'Chakra Petch', monospace;
        font-size: 1.1rem;
        font-weight: 700;
        color: #fff;
        margin-top: 2rem;
        margin-bottom: 0.8rem;
    }

    .content-text ul {
        list-style-type: none;
        padding-left: 0.5rem;
        margin-bottom: 1.5rem;
    }

    .content-text li {
        position: relative;
        padding-left: 1.5rem;
        margin-bottom: 0.6rem;
        font-size: 0.95rem;
    }

    .content-text li::before {
        content: '>';
        position: absolute;
        left: 0;
        color: var(--cyber-yellow, #fcee0a);
        font-weight: bold;
        font-family: 'Chakra Petch', monospace;
    }

    .link {
        color: var(--cyber-cyan, #00f0ff);
        text-decoration: none;
        border-bottom: 1px dashed var(--cyber-cyan);
        transition: all 0.2s;
    }

    .link:hover {
        color: #fff;
        border-bottom-style: solid;
        text-shadow: 0 0 10px var(--cyber-cyan);
    }

    @media (max-width: 640px) {
        .legal-container {
            margin: 1rem;
            padding: 1.5rem;
        }
        .title {
            font-size: 1.8rem;
        }
    }
</style>
</file>

<file path="src/lib/seasonal/seasonalContent.ts">
type SeasonalEvent = {
    name: string;
    isActive: (date: Date) => boolean;
    link: string;
    phrases: string[];
};

const events: SeasonalEvent[] = [
    {
        name: 'Glitch-o-Ween',
        isActive: (date) => {
            const m = date.getMonth();
            const d = date.getDate();
            return (m === 9 && d >= 20) || (m === 10 && d <= 2);
        },
        link: 'https://vm.tiktok.com/ZMAqvpf1X/',
        phrases: [
            'by a spooky ghost 👻',
            'Happy Halloween!',
            'powered by ectoplasm',
            'treats, no tricks!',
            '// system anomaly...',
        ]
    },
    {
        name: 'Winter Chill',
        isActive: (date) => {
            const m = date.getMonth();
            const d = date.getDate();
            return (m === 11 && d >= 1 && d < 15);
        },
        link: 'https://t.me/proto_map',
        phrases: [
            '❄️ Frost protocols loaded',
            'Stay warm, user.',
            'Temperature dropping...',
            'Ice detected in sector 7',
            '//: SYSTEM COOLING ACTIVE',
            'Cold logic only.'
        ]
    },
    {
        name: 'Glitchmas',
        isActive: (date) => {
            const m = date.getMonth();
            const d = date.getDate();
            return (m === 11 && d >= 15) || (m === 0 && d <= 14);
        },
        link: 'https://t.me/proto_map',
        phrases: [
            '🎄 Merry Glitchmas!',
            'Ho-ho-host unreachable.',
            'Powered by peppermint',
            'Gift received: [ERROR]',
            '//: DEPLOYING FESTIVE MOOD',
            'Happy New Cycle!',
            'Snow.exe is running...'
        ]
    }
];

// === ПАСХАЛКИ И ПРИКОЛЫ (Когда нет ивентов) ===

type Teaser = {
    text: string;
    link?: string; // Опциональная ссылка
};

const TEASERS: Teaser[] = [
    // Стандартное (повторяем несколько раз, чтобы выпадало чаще)
    { text: 'by Orion_Z43' },
    { text: 'by Orion_Z43' },
    { text: 'by Orion_Z43' },

    // Прото-мемы
    { text: 'I ate all your RAM!' },
    { text: 'Beep Boop!' },
    { text: 'Powered by Toasters' },
    { text: 'Visor: Clean. Systems: Online.' },
    { text: 'UwU module loaded' },
    { text: 'Do protogens dream of electric sheep?' },

    // Дружеская реклама (Minecraft style)
    { text: 'Also try PSA!', link: 'https://t.me/psa_union' }
];

const defaultLink = 'https://t.me/Orion_Z43';

export function getSeasonalContent(): { phrase: string; link: string } {
    const today = new Date();
    const activeEvent = events.find(event => event.isActive(today));

    // Если есть активный праздник
    if (activeEvent) {
        const randomPhrase = activeEvent.phrases[Math.floor(Math.random() * activeEvent.phrases.length)];
        return {
            phrase: randomPhrase,
            link: activeEvent.link
        };
    }

    // Если праздников нет (Рандомные пасхалки)
    const randomTeaser = TEASERS[Math.floor(Math.random() * TEASERS.length)];
    return {
        phrase: randomTeaser.text,
        // Если у пасхалки есть своя ссылка - берем её, иначе - дефолтную на тебя
        link: randomTeaser.link || defaultLink
    };
}

export function getActiveEventName(): string | null {
    const today = new Date();
    const activeEvent = events.find(event => event.isActive(today));
    return activeEvent ? activeEvent.name : null;
}
</file>

<file path="src/routes/casino/slot-machine/+page.svelte">
<script lang="ts">
    import { userStore } from '$lib/stores';
    import { getFunctions, httpsCallable } from 'firebase/functions';
    import { modal } from '$lib/stores/modalStore';
    import { onMount, onDestroy } from 'svelte';
    import { quintOut } from 'svelte/easing';
    import { tweened } from 'svelte/motion';
    import { Howl } from 'howler';
    import { t } from 'svelte-i18n';
    import { get } from 'svelte/store';
    import { scale, fade } from 'svelte/transition';
    import GlitchOverlay from '$lib/components/casino/GlitchOverlay.svelte';
    import ArtifactSynthesis from '$lib/components/casino/ArtifactSynthesis.svelte';
    import { renderMarkdown } from '$lib/utils/markdown';

    const translate = (key: string) => get(t)(key);
    const MAX_BET = 1000;

    let betAmount = 10;
    let isGlobalSpinning = false;

    let reelStates = ['stopped', 'stopped', 'stopped'];
    let reels: string[] = ['protomap_logo', 'protomap_logo', 'protomap_logo'];

    let winAmount = 0;
    let winTier = 0;
    let currentGlitchLevel = 0;

    let glitchShards = 0;
    let showSynthesisModal = false;
    let synthesisResult: { runes: string[], totalWin: number } | null = null;

    // Переменная для таймера звука вращения (вынесена сюда, чтобы очистить при выходе)
    let spinSoundInterval: any;

    $: if (betAmount > MAX_BET) betAmount = MAX_BET;
    $: if (betAmount < 0) betAmount = 1;

    const displayedCredits = tweened($userStore.user?.casino_credits || 0, { duration: 500, easing: quintOut });

    // СИНХРОНИЗАЦИЯ
    $: if ($userStore.user && !isGlobalSpinning) {
        displayedCredits.set($userStore.user.casino_credits);
        glitchShards = $userStore.user.glitch_shards || 0;
    }

    let audioContext: AudioContext;
    let sounds: { [key: string]: Howl } = {};
    let isOddsTooltipOpen = false;
    let isChaosInfoOpen = false;

    function toggleOddsTooltip() {
        isOddsTooltipOpen = !isOddsTooltipOpen;
        if (isOddsTooltipOpen) isChaosInfoOpen = false; // Закрываем соседа
    }

    // <--- НОВАЯ ФУНКЦИЯ
    function toggleChaosInfo() {
        isChaosInfoOpen = !isChaosInfoOpen;
        if (isChaosInfoOpen) isOddsTooltipOpen = false; // Закрываем соседа
    }

    // Закрываем всё при клике в пустоту
    function closeTooltips() {
        isOddsTooltipOpen = false;
        isChaosInfoOpen = false;
    }


    function createSynthSound(type: 'reel_spin' | 'reel_stop') {
        if (!audioContext) return;
        // Проверка состояния контекста, чтобы не было ошибок при быстром переходе
        if (audioContext.state === 'closed') return;

        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();

        if (type === 'reel_spin') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(100, audioContext.currentTime);
            osc.frequency.linearRampToValueAtTime(600, audioContext.currentTime + 0.1);
            gain.gain.setValueAtTime(0.05, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.1);
        } else {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(150, audioContext.currentTime);
            osc.frequency.exponentialRampToValueAtTime(40, audioContext.currentTime + 0.15);
            gain.gain.setValueAtTime(0.3, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.15);
        }
        osc.connect(gain);
        gain.connect(audioContext.destination);
        osc.start();
        osc.stop(audioContext.currentTime + 0.15);
    }

    onMount(() => {
        try {
            audioContext = new (window.AudioContext || (window as any).webkitAudioContext)();
            sounds.ambient = new Howl({ src: ['/sounds/ambient_casino.mp3'], loop: true, volume: 0.3, autoplay: true });
            sounds.suspense = new Howl({ src: ['/sounds/suspense_music.mp3'], loop: true, volume: 0.3 });
            sounds.win1 = new Howl({ src: ['/sounds/win1.mp3'], volume: 0.6 });
            sounds.win2 = new Howl({ src: ['/sounds/win2.mp3'], volume: 0.7 });
            sounds.win3 = new Howl({ src: ['/sounds/win3.mp3'], volume: 0.8 });
            sounds.jackpot = new Howl({ src: ['/sounds/main_jackpot.mp3'], volume: 1.0 });
            sounds.glitchJackpot = new Howl({ src: ['/sounds/glitch_jackpot.mp3'], volume: 0.9 });
            sounds.click = new Howl({ src: ['/sounds/click.mp3'], volume: 0.5 });
            sounds.synthesis = new Howl({ src: ['/sounds/purchase.mp3'], volume: 1.0 });
        } catch (e) { console.error("Audio init failed", e); }
    });

    // ВАЖНО: ОЧИСТКА ПАМЯТИ ПРИ УХОДЕ СО СТРАНИЦЫ
    onDestroy(() => {
        // 1. Останавливаем таймер звука вращения
        if (spinSoundInterval) clearInterval(spinSoundInterval);

        // 2. Выгружаем все звуки Howler из памяти
        if (sounds) {
            Object.values(sounds).forEach(s => {
                s.stop();
                s.unload();
            });
        }

        // 3. Закрываем AudioContext
        if (audioContext && audioContext.state !== 'closed') {
            audioContext.close();
        }
    });

    async function spinReels() {
        if (isGlobalSpinning || !$userStore.user) return;

        betAmount = Math.floor(betAmount);
        const currentBet = betAmount;
        if (isNaN(currentBet) || currentBet <= 0 || currentBet > $userStore.user.casino_credits) {
            modal.error(translate('slots.modal_invalid_title'), translate('slots.modal_invalid_text'));
            return;
        }
        if (currentBet > MAX_BET) { betAmount = MAX_BET; return; }

        isGlobalSpinning = true;
        winAmount = 0;
        winTier = 0;
        reelStates = ['spinning', 'spinning', 'spinning'];

        sounds.ambient?.fade(0.3, 0.1, 500);
        sounds.suspense?.play();

        // Запускаем звук вращения
        spinSoundInterval = setInterval(() => createSynthSound('reel_spin'), 150);

        try {
            const functions = getFunctions();
            const playSlotMachineFunc = httpsCallable(functions, 'playSlotMachine');

            const response = await playSlotMachineFunc({ bet: currentBet });
            const gameResult = (response.data as any).data;

            // Ждем завершения спина (1с)
            await new Promise(r => setTimeout(r, 1000));

            clearInterval(spinSoundInterval);
            reels[0] = gameResult.reels[0];
            reelStates[0] = 'stopped';
            createSynthSound('reel_stop');

            await new Promise(r => setTimeout(r, 500));
            reels[1] = gameResult.reels[1];
            reelStates[1] = 'stopped';
            createSynthSound('reel_stop');

            await new Promise(r => setTimeout(r, 600));
            reels[2] = gameResult.reels[2];
            reelStates[2] = 'stopped';
            createSynthSound('reel_stop');

            // === ФИНАЛ СПИНА ===
            sounds.suspense?.stop();
            sounds.ambient?.fade(0.1, 0.3, 500);

            winAmount = gameResult.winAmount;

            // 1. Обновляем визуально осколки
            if (gameResult.shards !== undefined) {
                glitchShards = gameResult.shards;
            }

            // 2. Обработка победы
            if (winAmount > 0) {
                const winRatio = winAmount / currentBet;
                if (winRatio >= 100) { winTier = 4; sounds.jackpot?.play(); }
                else if (winRatio >= 25) { winTier = 3; sounds.win3?.play(); }
                else if (winRatio >= 10) { winTier = 2; sounds.win2?.play(); }
                else { winTier = 1; sounds.win1?.play(); }
            } else {
                if (gameResult.shardsAdded > 0) {
                    sounds.glitchJackpot?.play();
                }
            }

            // 3. Обновляем UserStore
            userStore.update(store => {
                if (store.user) {
                    store.user.casino_credits = gameResult.newBalance;
                    store.user.glitch_shards = gameResult.shards;
                }
                return store;
            });

            setTimeout(() => {
                isGlobalSpinning = false;
                winTier = 0;
            }, 2000);

        } catch (error: any) {
            clearInterval(spinSoundInterval);
            sounds.suspense?.stop();
            reelStates = ['stopped', 'stopped', 'stopped'];
            modal.error(translate('slots.modal_error_title'), error.message || "Error.");
            isGlobalSpinning = false;
        }
    }

    async function handleSynthesis() {
        if (glitchShards < 10 || isGlobalSpinning) return;

        isGlobalSpinning = true;
        sounds.click?.play();

        try {
            const functions = getFunctions();
            const synthFunc = httpsCallable(functions, 'synthesizeArtifact');

            const res = await synthFunc();
            const data = (res.data as any).data;

            sounds.synthesis?.play();
            synthesisResult = data;
            showSynthesisModal = true;

            userStore.update(s => {
                if (s.user) {
                    s.user.casino_credits = data.newBalance;
                    s.user.glitch_shards = 0;
                }
                return s;
            });
            glitchShards = 0;

        } catch (e: any) {
            modal.error(translate('ui.error'), e.message);
        } finally {
            isGlobalSpinning = false;
        }
    }
</script>

<svelte:head>
    <title>{$t('slots.title')} | The Glitch Pit</title>
</svelte:head>

<svelte:window on:click={closeTooltips} />

<div class="page-container"
    class:win-tier-1={winTier === 1}
    class:win-tier-2={winTier === 2}
    class:win-tier-3={winTier === 3}
    class:win-tier-4={winTier === 4}
    class:win-tier-negative={winTier === -1}
>
    <!-- 1. МОДАЛКА СИНТЕЗА (НОВОЕ) -->
    {#if showSynthesisModal && synthesisResult}
        <ArtifactSynthesis
            artifactIds={synthesisResult.runes}
            totalWin={synthesisResult.totalWin}
            on:close={() => showSynthesisModal = false}
        />
    {/if}

    <!-- ЭФФЕКТЫ ФОНА -->
    <GlitchOverlay
        level={currentGlitchLevel}
        on:stopMusic={() => {
            sounds.ambient?.stop();
            sounds.suspense?.stop();
        }}
        on:restoreMusic={() => {
            if (!sounds.ambient?.playing()) sounds.ambient?.play();
        }}
    />

    <div class="bg-blur-1"></div>
    <div class="bg-blur-2"></div>

    <!-- ЧАСТИЦЫ ПОБЕДЫ -->
    <div class="win-effects">
        {#each Array(20) as _, i}
            <div class="particle" style="--i: {i}"></div>
        {/each}
        <div class="jackpot-flash"></div>
    </div>

    <!-- ИГРОВОЙ АВТОМАТ -->
    <div class="slot-machine-container">
        <div class="machine-frame">

            <!-- ШАПКА -->
            <div class="machine-header">
                <h1 class="machine-title glitch" data-text="PROTO-SLOTS">PROTO-SLOTS</h1>
                <div class="jackpot-ticker">
                    {$t('slots.jackpot')}
                </div>
            </div>

            <!-- БАРАБАНЫ -->
            <div class="reels-window-rim">
                <div class="reels-window">
                    <div class="payline"></div>

                    <!-- REEL 1 -->
                    <div class="reel-col">
                        <div class="reel-viewport">
                            {#if reelStates[0] === 'spinning'}
                                <div class="reel-strip spinning">
                                    <!-- ДОБАВИЛИ КЛАССЫ ЦВЕТОВ -->
                                    <img src="/casino/paw.svg" alt="" class="blur-icon symbol-paw">
                                    <img src="/casino/ram.svg" alt="" class="blur-icon symbol-ram">
                                    <img src="/casino/heart.svg" alt="" class="blur-icon symbol-heart">
                                    <img src="/casino/protomap_logo.svg" alt="" class="blur-icon symbol-protomap_logo">
                                    <img src="/casino/glitch-6.svg" alt="" class="blur-icon symbol-glitch-6">
                                    <!-- Повтор для зацикливания -->
                                    <img src="/casino/paw.svg" alt="" class="blur-icon symbol-paw">
                                </div>
                            {:else}
                                <div class="static-symbol bounce">
                                    <img src="/casino/{reels[0]}.svg" alt={reels[0]} class="symbol symbol-{reels[0]}" style="--glow-color: var(--color-{reels[0]})" />
                                </div>
                            {/if}
                        </div>
                    </div>

                    <!-- REEL 2 -->
                    <div class="reel-col">
                        <div class="reel-viewport">
                            {#if reelStates[1] === 'spinning'}
                                <div class="reel-strip spinning delay-1">
                                    <img src="/casino/ram.svg" alt="" class="blur-icon symbol-ram">
                                    <img src="/casino/heart.svg" alt="" class="blur-icon symbol-heart">
                                    <img src="/casino/protomap_logo.svg" alt="" class="blur-icon symbol-protomap_logo">
                                    <img src="/casino/glitch-6.svg" alt="" class="blur-icon symbol-glitch-6">
                                    <img src="/casino/paw.svg" alt="" class="blur-icon symbol-paw">
                                    <img src="/casino/ram.svg" alt="" class="blur-icon symbol-ram">
                                </div>
                            {:else}
                                <div class="static-symbol bounce">
                                    <img src="/casino/{reels[1]}.svg" alt={reels[1]} class="symbol symbol-{reels[1]}" style="--glow-color: var(--color-{reels[1]})" />
                                </div>
                            {/if}
                        </div>
                    </div>

                    <!-- REEL 3 -->
                    <div class="reel-col">
                        <div class="reel-viewport">
                            {#if reelStates[2] === 'spinning'}
                                <div class="reel-strip spinning delay-2">
                                    <img src="/casino/heart.svg" alt="" class="blur-icon symbol-heart">
                                    <img src="/casino/protomap_logo.svg" alt="" class="blur-icon symbol-protomap_logo">
                                    <img src="/casino/glitch-6.svg" alt="" class="blur-icon symbol-glitch-6">
                                    <img src="/casino/paw.svg" alt="" class="blur-icon symbol-paw">
                                    <img src="/casino/ram.svg" alt="" class="blur-icon symbol-ram">
                                    <img src="/casino/heart.svg" alt="" class="blur-icon symbol-heart">
                                </div>
                            {:else}
                                <div class="static-symbol bounce">
                                    <img src="/casino/{reels[2]}.svg" alt={reels[2]} class="symbol symbol-{reels[2]}" style="--glow-color: var(--color-{reels[2]})" />
                                </div>
                            {/if}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. ШКАЛА ХАОСА -->
            <div class="chaos-meter-container">
                <div class="meter-label">
                    <!-- Заменили div на button и добавили клик -->
                    <button
                        class="info-tooltip-wrapper"
                        on:click|stopPropagation={toggleChaosInfo}
                    >
                        <span class="label-text">CHAOS CHARGE</span>

                        <div class="info-icon">i</div>

                        <!-- Добавили class:mobile-visible -->
                        <div class="custom-tooltip" class:mobile-visible={isChaosInfoOpen}>
                            <h5 class="tooltip-title">{$t('slots.info_title')}</h5>
                            <div class="tooltip-body">
                                {@html renderMarkdown($t('slots.info_text'))}
                            </div>
                        </div>
                    </button>

                    <span class="count" class:ready={glitchShards >= 10}>{glitchShards} / 10</span>
                </div>

                <div class="meter-track">
                    <div class="meter-fill" style="width: {(glitchShards / 10) * 100}%" class:full={glitchShards >= 10}></div>
                    {#each Array(9) as _, i}
                        <div class="meter-tick" style="left: {(i + 1) * 10}%"></div>
                    {/each}
                </div>

                {#if glitchShards >= 10}
                    <button class="synthesize-btn" on:click={handleSynthesis} transition:scale>
                        ⚠️ SYNTHESIZE ARTIFACT ⚠️
                    </button>
                {/if}
            </div>

            <!-- ВЫИГРЫШ -->
            <div class="win-display" class:visible={(winAmount > 0) && !isGlobalSpinning}>
                {$t('slots.win')}: <span class="win-amount">+{winAmount} PC</span>
            </div>

            <!-- ПАНЕЛЬ УПРАВЛЕНИЯ -->
            <div class="control-panel-rim">
                <div class="control-panel">
                    <div class="panel-display balance">
                        <span class="label">{$t('ui.balance')}</span>
                        <span class="value">{Math.floor($displayedCredits)}</span>
                    </div>

                    <div class="bet-control">
                        <label for="bet-amount">{$t('slots.bet_label')}</label>
                        <div class="bet-input-wrapper">
                            <button class="bet-adjust" on:click={() => betAmount = Math.max(10, betAmount - 10)} disabled={isGlobalSpinning}>-</button>
                            <input
                                id="bet-amount"
                                type="number"
                                bind:value={betAmount}
                                min="1"
                                max={MAX_BET}
                                step="1"
                                on:input={() => betAmount = Math.floor(betAmount)}
                                disabled={isGlobalSpinning}
                            />
                            <button class="bet-adjust" on:click={() => betAmount = Math.min(MAX_BET, betAmount + 10)} disabled={isGlobalSpinning}>+</button>
                        </div>
                    </div>

                    <button class="spin-button" on:click={spinReels} disabled={isGlobalSpinning || (glitchShards >= 10)}>
                        <div class="spin-text">{isGlobalSpinning ? $t('slots.spinning') : $t('slots.spin')}</div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ТАБЛИЦА ВЫПЛАТ (ОБНОВЛЕННАЯ) -->
    <div class="paytable-container">
    <div class="paytable-header">
                <h4 class="paytable-title font-display">{$t('slots.combinations')}</h4>
                <button
                    class="info-tooltip-wrapper"
                    on:click|stopPropagation={toggleOddsTooltip}
                    on:keydown={(e) => e.key === 'Enter' && toggleOddsTooltip()}
                >
                    <div class="info-icon">?</div>

                    <!-- 3. Добавляем класс mobile-visible по условию -->
                    <div class="custom-tooltip odds-tooltip" class:mobile-visible={isOddsTooltipOpen}>
                        <h5 class="tooltip-title">{$t('slots.odds_title')}</h5>

                        <table class="odds-table">
                            <thead>
                                <tr>
                                    <th>{$t('slots.col_outcome')}</th>
                                    <th>{$t('slots.col_chance')}</th>
                                    <th>{$t('slots.col_reward')}</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="row-jackpot">
                                    <td><span class="t-glow">JACKPOT</span></td>
                                    <td>0.1%</td>
                                    <td>x100</td>
                                </tr>
                                <tr class="row-glitch">
                                    <td>GLITCH</td>
                                    <td>1.0%</td>
                                    <td>10 Shards</td>
                                </tr>
                                <tr class="row-heart">
                                    <td>HEART</td>
                                    <td>1.5%</td>
                                    <td>x10</td>
                                </tr>
                                <tr class="row-ram">
                                    <td>RAM</td>
                                    <td>5.5%</td>
                                    <td>x5</td>
                                </tr>
                                <tr class="row-paw">
                                    <td>PAW</td>
                                    <td>19.5%</td>
                                    <td>x2</td>
                                </tr>
                                <tr class="row-loss">
                                    <td class="text-gray-500">EMPTY</td>
                                    <td class="text-gray-500">72.4%</td>
                                    <td class="text-gray-500">—</td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="odds-footer">
                             {@html renderMarkdown($t('slots.odds_note'))}
                        </div>
                    </div>
                </button>
            </div>
        <div class="paytable-grid">
            <div class="combo">
                <!-- Лапки (PAW) - Голубые -->
                <div class="icons">
                    <img src="/casino/paw.svg" alt="paw" class="symbol-paw">
                    <img src="/casino/paw.svg" alt="paw" class="symbol-paw">
                    <img src="/casino/paw.svg" alt="paw" class="symbol-paw">
                </div>
                <div class="multiplier">x2</div>
            </div>
            <div class="combo">
                <!-- ОЗУ (RAM) - Оставляем как есть (она зеленая) -->
                <div class="icons">
                    <img src="/casino/ram.svg" alt="ram" class="symbol-ram">
                    <img src="/casino/ram.svg" alt="ram" class="symbol-ram">
                    <img src="/casino/ram.svg" alt="ram" class="symbol-ram">
                </div>
                <div class="multiplier">x5</div>
            </div>
            <div class="combo">
                <!-- Сердца (HEART) - Красные -->
                <div class="icons">
                    <img src="/casino/heart.svg" alt="heart" class="symbol-heart">
                    <img src="/casino/heart.svg" alt="heart" class="symbol-heart">
                    <img src="/casino/heart.svg" alt="heart" class="symbol-heart">
                </div>
                <div class="multiplier">x10</div>
            </div>
            <div class="combo jackpot">
                <!-- Лого (LOGO) - Золотое -->
                <div class="icons">
                    <img src="/casino/protomap_logo.svg" alt="logo" class="symbol-protomap_logo">
                    <img src="/casino/protomap_logo.svg" alt="logo" class="symbol-protomap_logo">
                    <img src="/casino/protomap_logo.svg" alt="logo" class="symbol-protomap_logo">
                </div>
                <div class="multiplier">x100</div>
            </div>
            <div class="combo">
                <!-- Глитч (GLITCH) - Красный/Фиолетовый -->
                <div class="icons">
                    <img src="/casino/glitch-6.svg" alt="glitch" class="symbol-glitch-6">
                    <img src="/casino/glitch-6.svg" alt="glitch" class="symbol-glitch-6">
                    <img src="/casino/glitch-6.svg" alt="glitch" class="symbol-glitch-6">
                </div>
                <div class="multiplier text-xs" style="color: #bd00ff; text-shadow: 0 0 10px #bd00ff; font-weight: 900;">
                    FULL CHARGE
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    :root {
        --color-paw: #00f0ff;
        --color-ram: #39ff14;
        --color-heart: #bd00ff;
        --color-protomap_logo: #fcee0a;
        --color-glitch-6: #ff003c;
    }

    @keyframes spin-loop {
        0% { transform: translateY(0); }
        100% { transform: translateY(-83.33%); }
    }

    @keyframes bounce-stop {
        0% { transform: translateY(-50px) scaleY(1.2); filter: blur(2px); }
        60% { transform: translateY(10px) scaleY(0.9); filter: blur(0); }
        100% { transform: translateY(0) scaleY(1); }
    }

    @keyframes win-pulse { 0%, 100% { text-shadow: 0 0 10px #fcee0a, 0 0 20px #fcee0a; transform: scale(1); } 50% { text-shadow: 0 0 30px #fcee0a, 0 0 50px #fff; transform: scale(1.1); } }
    @keyframes glitch-text { 0% { text-shadow: 2px 0 #ff00c1, -2px 0 #01ffff; } 25% { text-shadow: -2px 0 #ff00c1, 2px 0 #01ffff; } 50% { text-shadow: 2px 0 #01ffff, -2px 0 #ff00c1; } 100% { text-shadow: 2px 0 #ff00c1, -2px 0 #01ffff; } }
    @keyframes float-blur-1 { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(100px, 50px); } }
    @keyframes float-blur-2 { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(-80px, -60px); } }
    @keyframes particle-anim { 0% { transform: translate(0, 0); opacity: 0; } 20% { opacity: 1; } 100% { transform: translate(var(--x), var(--y)); opacity: 0; } }
    @keyframes god-rays { 0% { opacity: 0; } 50% { opacity: 0.3; } 100% { opacity: 0; transform: scale(2); } }
    @keyframes jackpot-flash-anim { 0%, 100% { opacity: 0; } 10%, 30% { opacity: 1; } }
    @keyframes screen-flicker { 0%, 100% { filter: brightness(1); } 50% { filter: brightness(0.5) contrast(2); } }

    .page-container {
        min-height: calc(100vh - 64px);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        background: #0a0a0a;
        padding: 2rem;
    }
    .bg-blur-1, .bg-blur-2 { position: absolute; width: 400px; height: 400px; border-radius: 50%; filter: blur(150px); pointer-events: none; z-index: 0; }
    .bg-blur-1 { background: #bd00ff; top: 10%; left: 10%; animation: float-blur-1 20s infinite ease-in-out; }
    .bg-blur-2 { background: #fcee0a; bottom: 10%; right: 10%; animation: float-blur-2 25s infinite ease-in-out; }

    .win-effects { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
    .particle { position: absolute; top: 50%; left: 50%; width: 4px; height: 4px; border-radius: 50%; opacity: 0; }
    .win-tier-1 .particle { background: #fcee0a; animation: particle-anim 1s ease-out forwards; --x: calc(cos(var(--i) * 18deg) * 100px); --y: calc(sin(var(--i) * 18deg) * 100px); }
    .win-tier-2 .machine-frame { animation: win-pulse 0.5s 2; }
    .win-tier-3::before { content: ''; position: absolute; top: 50%; left: 50%; width: 2px; height: 2px; border-radius: 50%; box-shadow: 0 0 200px 100px #fcee0a; animation: god-rays 1.5s ease-out; }
    .jackpot-flash { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, white, #fcee0a, transparent 70%); opacity: 0; }
    .win-tier-4 .jackpot-flash { animation: jackpot-flash-anim 1s ease-in-out; }
    .page-container.win-tier-negative { animation: screen-flicker 0.2s 5; }

    .slot-machine-container { position: relative; z-index: 2; width: 100%; max-width: 900px; }
    .machine-frame { background: rgba(20, 20, 25, 0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 1.5rem; padding: 2rem; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
    .machine-header { text-align: center; margin-bottom: 2rem; }
    .machine-title { font-size: 3rem; color: #fff; margin: 0; animation: glitch-text 0.2s infinite; }
    .jackpot-ticker { font-family: 'Chakra Petch', monospace; color: #ff003c; display: inline-block; padding: 0.2rem 1rem; border: 1px solid #ff003c; box-shadow: 0 0 10px #ff003c; margin-top: 0.5rem; }

    .reels-window-rim { padding: 10px; background: rgba(0,0,0,0.3); border-radius: 1rem; box-shadow: inset 0 0 20px #000; margin-bottom: 2rem; }
    .reels-window { display: flex; gap: 10px; height: 250px; background: rgba(0,0,0,0.5); border-radius: 0.5rem; overflow: hidden; position: relative; box-shadow: inset 0 0 50px rgba(0,0,0,0.8); }
    .payline { position: absolute; top: 50%; left: 0; width: 100%; height: 2px; background: #ff003c; z-index: 10; transform: translateY(-50%); pointer-events: none; box-shadow: 0 0 10px #ff003c; }

    .reel-col { flex: 1; position: relative; overflow: hidden; height: 100%; }
    .reel-viewport { height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }

    .reel-strip { position: absolute; top: 0; left: 0; width: 100%; display: flex; flex-direction: column; filter: blur(0px); }
    .reel-strip.spinning { animation: spin-loop 0.3s linear infinite; filter: blur(3px); opacity: 0.6; }
    .blur-icon { width: 100%; height: 250px; object-fit: contain; padding: 20px; opacity: 0.8; }

    .static-symbol { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
    .static-symbol.bounce { animation: bounce-stop 0.4s ease-out; }

    .symbol { width: 70%; height: 70%; object-fit: contain; filter: drop-shadow(0 0 10px var(--glow-color)) drop-shadow(0 0 20px var(--glow-color)); opacity: 1; transform: scale(1); }
    .placeholder-symbol { font-size: 5rem; color: #333; font-family: 'Chakra Petch', monospace; }

    .win-display { text-align: center; font-family: 'Chakra Petch', monospace; font-size: 2.5rem; color: #fcee0a; margin-bottom: 2rem; opacity: 0; height: 3.5rem; transition: opacity 0.3s; }
    .win-display.visible { opacity: 1; animation: win-pulse 1s infinite; }
    .win-display.loss { color: #ff003c; animation-name: none; }

    .control-panel-rim { background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 1rem; }
    .control-panel { display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
    .panel-display { text-align: center; }
    .panel-display .label { display: block; font-size: 0.8rem; color: #888; text-transform: uppercase; }
    .panel-display .value { display: block; font-size: 1.8rem; color: #fff; text-shadow: 0 0 5px #00f0ff; font-family: 'Chakra Petch', monospace; }

    .bet-control { text-align: center; font-family: 'Chakra Petch', monospace; }
    .bet-control label { display: block; color: #888; font-size: 0.8rem; margin-bottom: 0.5rem; }
    .bet-input-wrapper { display: flex; justify-content: center; }
    .bet-input-wrapper input { background: transparent; border: none; color: #fff; text-align: center; font-size: 1.8rem; width: 100px; font-family: inherit; }
    .bet-input-wrapper input:focus { outline: none; }
    .bet-adjust { background: transparent; color: #fff; border: 1px solid #444; width: 40px; height: 40px; font-size: 1.5rem; cursor: pointer; transition: all 0.2s; border-radius: 50%; }
    .bet-adjust:hover:not(:disabled) { background: #00f0ff; color: #000; }
    .bet-adjust:disabled { opacity: 0.3; }

    .spin-button { width: 100px; height: 100px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #ff5500, #cc3300); border: 2px solid rgba(255,255,255,0.2); box-shadow: 0 10px 20px rgba(0,0,0,0.5), inset 0 0 10px rgba(0,0,0,0.5), 0 0 40px rgba(255, 102, 0, 0.4); cursor: pointer; position: relative; transition: transform 0.1s, box-shadow 0.1s; }
    .spin-button:active:not(:disabled) { transform: scale(0.95); box-shadow: 0 5px 10px rgba(0,0,0,0.5); }
    .spin-button:disabled { filter: grayscale(1) brightness(0.5); cursor: not-allowed; }
    .spin-text { font-family: 'Chakra Petch', monospace; font-weight: bold; font-size: 1.8rem; color: #fff; text-shadow: 0 2px 5px rgba(0,0,0,0.5); }

    .paytable-container { width: 100%; max-width: 900px; margin-top: 2rem; position: relative; z-index: 2; color: #fff; }
    .paytable-title { text-align: center; text-transform: uppercase; letter-spacing: 0.2em; color: #888; margin-bottom: 1rem; }
    .paytable-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; background: rgba(20, 20, 25, 0.4); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1rem; padding: 1rem; }
    .combo { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; }
    .icons { display: flex; gap: 0.25rem; }
    .icons img { width: 24px; height: 24px; }
    .multiplier { font-family: 'Chakra Petch', monospace; font-size: 1.2rem; color: #fff; font-weight: bold; }
    .combo.jackpot .multiplier { color: #fcee0a; animation: win-pulse 2s infinite; }
    .combo.loss .multiplier { color: #ff003c; }

    /* CHAOS METER */
    .chaos-meter-container {
        width: 100%; margin: 1rem 0; padding: 0 1rem;
    }
    .meter-label {
        display: flex; justify-content: space-between; font-family: 'Chakra Petch', monospace;
        font-size: 0.8rem; color: #666; margin-bottom: 4px; font-weight: bold;
    }
    .meter-label .count.ready { color: #bd00ff; text-shadow: 0 0 5px #bd00ff; animation: pulse-text 1s infinite; }

    .meter-track {
        height: 12px; background: #111; border: 1px solid #333;
        border-radius: 6px; position: relative; overflow: hidden;
    }
    .meter-fill {
        height: 100%; background: linear-gradient(90deg, #5500aa, #bd00ff);
        width: 0%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 0 10px #bd00ff;
    }
    .meter-fill.full { background: #fff; box-shadow: 0 0 15px #fff, 0 0 30px #bd00ff; animation: pulse-bar 0.5s infinite alternate; }

    .meter-tick {
        position: absolute; top: 0; bottom: 0; width: 1px; background: rgba(0,0,0,0.5);
    }

    .synthesize-btn {
        width: 100%; margin-top: 10px; padding: 0.8rem;
        background: #bd00ff; color: #fff; font-weight: 900;
        font-family: 'Chakra Petch', monospace; border: 2px solid #fff;
        border-radius: 4px; cursor: pointer;
        animation: glitch-skew 2s infinite; /* Твоя существующая анимация глитча */
        box-shadow: 0 0 20px #bd00ff;
        text-transform: uppercase; letter-spacing: 0.1em;
    }
    .synthesize-btn:hover { background: #fff; color: #bd00ff; }

    @keyframes pulse-text { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }
    @keyframes pulse-bar { from { opacity: 0.8; } to { opacity: 1; filter: brightness(1.2); } }

    @media (max-width: 768px) {
        .page-container { padding: 1rem; }
        .machine-frame { padding: 1rem; }
        .control-panel { flex-direction: column; align-items: stretch; gap: 1.5rem; }
        .spin-button { width: 100%; height: 80px; border-radius: 10px; }
        .reels-window { height: 150px; }
        .paytable-grid { grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
        .icons img { width: 20px; height: 20px; }
        .reel-strip.spinning { animation: spin-loop 0.15s linear infinite; }
        .blur-icon { height: 150px; }
    }
    /* === ЗАГОЛОВОК С КНОПКОЙ ВОПРОСА === */
    .paytable-header {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.8rem;
        margin-bottom: 1.5rem;
        position: relative;
    }
    .paytable-title {
        margin-bottom: 0;
        line-height: 1;
    }

    /* === ОБЩИЙ КОНТЕЙНЕР ТУЛТИПА (КНОПКА) === */
    .info-tooltip-wrapper {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        cursor: help;
        z-index: 20;

        /* Сброс стилей кнопки */
        background: none;
        border: none;
        padding: 0;
        margin: 0;
        font: inherit;
    }

    /* ИКОНКА (i или ?) */
    .info-icon {
        width: 16px; height: 16px;
        border-radius: 50%;
        border: 1px solid #555;
        color: #777;
        background: rgba(255, 255, 255, 0.05);
        font-family: monospace;
        font-size: 11px;
        font-weight: bold;
        display: flex; align-items: center; justify-content: center;
        transition: all 0.2s;
    }

    /* Ховер эффект для иконки */
    .info-tooltip-wrapper:hover .info-icon {
        border-color: var(--cyber-cyan);
        background: var(--cyber-cyan);
        color: #000;
        box-shadow: 0 0 10px var(--cyber-cyan);
    }

    /* === ВСПЛЫВАЮЩЕЕ ОКНО (TOOLTIP) === */
    .custom-tooltip {
        position: absolute;
        bottom: 140%; /* Над иконкой */
        left: 50%;    /* По центру иконки */

        /* Дефолтная ширина для инфо (узкая) */
        width: 280px;
        padding: 1rem;

        background: rgba(10, 10, 15, 0.95);
        border: 1px solid var(--cyber-cyan);
        border-radius: 8px;
        box-shadow: 0 0 20px rgba(0, 243, 255, 0.2);
        backdrop-filter: blur(10px);

        /* Скрыто */
        opacity: 0;
        visibility: hidden;

        /* Дефолтная позиция на ПК: Центр */
        transform: translateX(-50%) translateY(10px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        pointer-events: none;
    }

    /* Спец-класс для широкой таблицы */
    .odds-tooltip {
        width: 320px;
    }

    /* СТРЕЛОЧКА ВНИЗ */
    .custom-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -6px; /* Центрируем стрелку */
        border-width: 6px;
        border-style: solid;
        border-color: var(--cyber-cyan) transparent transparent transparent;
    }

    /* === ЛОГИКА ПОЯВЛЕНИЯ === */
    /* 1. Наведение (Hover) ИЛИ 2. Класс (JS Click) */
    .info-tooltip-wrapper:hover .custom-tooltip,
    .info-tooltip-wrapper:focus-within .custom-tooltip,
    .custom-tooltip.mobile-visible {
        opacity: 1;
        visibility: visible;
        /* На ПК просто поднимаем вверх, сохраняя центровку по X */
        transform: translateX(-50%) translateY(0);
        pointer-events: auto;
    }

    /* === КОНТЕНТ ВНУТРИ === */
    .tooltip-title {
        color: var(--cyber-yellow);
        font-family: 'Chakra Petch', monospace;
        font-weight: bold;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        text-transform: uppercase;
        border-bottom: 1px dashed rgba(255,255,255,0.2);
        padding-bottom: 4px;
    }
    .tooltip-body {
        color: #ccc; font-size: 0.8rem; line-height: 1.5; text-align: left;
    }
    .tooltip-body :global(p) { margin-bottom: 0.5rem; }
    .tooltip-body :global(p:last-child) { margin-bottom: 0; }
    .tooltip-body :global(strong) { color: var(--cyber-yellow); font-weight: 800; }

    /* === ТАБЛИЦА ШАНСОВ === */
    .odds-table {
        width: 100%; border-collapse: collapse; margin-bottom: 1rem;
        font-size: 0.8rem; font-family: 'Inter', sans-serif;
    }
    .odds-table th {
        text-align: left; padding: 0.4rem; border-bottom: 1px solid rgba(255,255,255,0.2);
        color: var(--cyber-yellow); text-transform: uppercase; font-size: 0.7rem;
    }
    .odds-table td {
        padding: 0.4rem; border-bottom: 1px solid rgba(255,255,255,0.05); color: #ddd;
    }
    .odds-table tr:last-child td { border-bottom: none; }
    .row-jackpot { color: #fff; font-weight: bold; background: rgba(255, 215, 0, 0.1); }
    .t-glow { text-shadow: 0 0 10px #ffd700; }
    .row-glitch, .row-heart { color: #bd00ff; }
    .row-ram { color: #39ff14; }
    .row-paw { color: #00f3ff; }

    .odds-footer {
        font-size: 0.75rem; color: #888; background: rgba(255,255,255,0.05);
        padding: 0.6rem; border-radius: 6px; border-left: 2px solid var(--cyber-cyan);
        line-height: 1.4;
    }
    .odds-footer :global(strong) { color: #fff; font-weight: bold; }

    /* === МОБИЛЬНАЯ АДАПТАЦИЯ (ЕДИНЫЙ БЛОК) === */
    /* Мобильная адаптация */
    @media (max-width: 640px) {
        /* ОБЩИЕ СТИЛИ ДЛЯ МОБИЛОК */
        .custom-tooltip {
            width: 280px; /* Фикс ширина */
            transform: translateY(10px); /* Исходное смещение */
        }

        .info-tooltip-wrapper:hover .custom-tooltip,
        .custom-tooltip.mobile-visible {
            transform: translateY(0) !important; /* Убираем X-смещение */
        }

        /* === 1. ТУЛТИП ХАОСА (ЛЕВЫЙ КРАЙ) === */
        /* Он должен расти ВПРАВО, чтобы не улетать за экран */
        .meter-label .custom-tooltip {
            left: -5px !important;   /* Прижимаем к левому краю иконки */
            right: auto !important;  /* Отменяем привязку к правому */
        }

        /* Стрелочка для Хаоса (Слева) */
        .meter-label .custom-tooltip::after {
            left: 12px !important;
            right: auto !important;
            margin-left: 0 !important;
        }

        /* === 2. ТУЛТИП ТАБЛИЦЫ (ЦЕНТР) === */
        /* Он должен расти ВЛЕВО (как было), иначе улетит вправо */
        .odds-tooltip {
            left: auto !important;
            right: -20px !important; /* Прижимаем к правому краю родителя */
            width: 300px;            /* Таблица пошире */
        }

        /* Стрелочка для Таблицы (Справа) */
        .odds-tooltip::after {
            left: auto !important;
            right: 25px !important;
            margin-left: 0 !important;
        }
    }
/* === РАСКРАСКА ИКОНОК === */

    /* 🐾 ЛАПКИ (PAW) -> Приятный Голубой */
    .symbol-paw {
        filter: invert(70%) sepia(59%) saturate(4526%) hue-rotate(190deg) brightness(102%) contrast(103%) drop-shadow(0 0 5px #00bfff);
    }

    /* ❤️ СЕРДЦА (HEART) -> Насыщенный Красный */
    .symbol-heart {
        filter: invert(24%) sepia(61%) saturate(7476%) hue-rotate(354deg) brightness(98%) contrast(124%) drop-shadow(0 0 5px #ff3333);
    }

    /* 🏆 ЛОГОТИП (LOGO) -> Золотой */
    .symbol-protomap_logo {
        filter: invert(85%) sepia(35%) saturate(3054%) hue-rotate(358deg) brightness(101%) contrast(105%) drop-shadow(0 0 5px #ffd700);
    }

    /* 👹 ГЛИТЧ (666) -> Зловещий Красный/Малиновый */
    .symbol-glitch-6 {
        filter: invert(15%) sepia(95%) saturate(6932%) hue-rotate(338deg) brightness(95%) contrast(112%) drop-shadow(0 0 5px #ff003c);
    }

    /* 💾 ОЗУ (RAM) -> Оставляем оригинальный цвет или делаем поярче, если нужно */
    /* Если она у тебя уже зеленая - этот класс можно не добавлять, или добавить для свечения */
    .symbol-ram {
        filter: drop-shadow(0 0 5px #39ff14);
    }

    /* Общий стиль для иконок в таблице, чтобы они не были гигантскими */
    .paytable-grid .icons img {
        width: 28px;
        height: 28px;
    }
</style>
</file>

<file path="src/routes/about/+page.svelte">
<script lang="ts">
    import { onMount } from 'svelte';
    import { quintOut } from 'svelte/easing';
    import { tweened } from 'svelte/motion';
    import { t } from 'svelte-i18n';

    const opacity = tweened(0, { duration: 400, easing: quintOut });
    onMount(() => { opacity.set(1); });

    const testers = [
        {
            id: 'kess',
            username: 'Кесс Мирун',
            color: '#a855f7',
            avatar: 'https://res.cloudinary.com/dzkypodvd/image/upload/v1766635490/protomap_avatars/Jjsi5AbW5iaRWN8b2JvejR73GHq2.webp'
        },
        {
            id: 'kuraga',
            username: 'kuraga',
            color: '#ff003c',
            avatar: 'https://res.cloudinary.com/dzkypodvd/image/upload/v1765912349/protomap_avatars/t3KN8N2O6HWmHh2eK2DV9gNkIjO2.webp'
        },
        {
            id: 'artho',
            username: 'ARTHO',
            color: '#39ff14',
            avatar: 'https://res.cloudinary.com/dzkypodvd/image/upload/v1764673819/protomap_avatars/KRyygW2X1NQnMdzGp7aUzBt1kYt1.webp'
        },
        {
            id: 'sarevus',
            username: 'sarevus',
            color: '#ffffff',
            avatar: 'https://res.cloudinary.com/dzkypodvd/image/upload/v1764612207/protomap_avatars/42VXz0odbXObACimwupWb179HO42.webp'
        },
        {
            id: 'jokl',
            username: 'джокл',
            color: '#ffd700',
            avatar: 'https://res.cloudinary.com/dzkypodvd/image/upload/v1750097263/protomap_avatars/Wg5wynJ63tYHXi9sHbk0g5qODI43.webp'
        },
        {
            id: 'mikhail',
            username: 'Anchor_play',
            color: '#00f3ff',
            avatar: 'https://res.cloudinary.com/dzkypodvd/image/upload/v1763604687/protomap_avatars/UJQAvOKcO9Zwo4e7Nsy2kGdj0kv1.webp'
        },
        {
            id: 'bogdan',
            username: 'Nexus',
            color: '#ff5500',
            avatar: 'https://res.cloudinary.com/dzkypodvd/image/upload/v1750888278/protomap_avatars/D6e7GrJFSZWYfcAyYV9TFXpXnUi1.webp'
        },
        {
            id: 'moro',
            username: 'Moro (morovec)',
            color: '#ff0055',
            avatar: 'https://res.cloudinary.com/dzkypodvd/image/upload/v1769692656/protomap_avatars/XXRqoTdjFZZYeouRKTFisxjEcZv1.webp'
        },
        {
            id: 'eridan',
            username: 'Eridan_Pallas',
            color: '#00e5ff',
            avatar: 'https://res.cloudinary.com/dzkypodvd/image/upload/v1769693430/protomap_avatars/I8DIGaxnO8MCveHTq8xloFNmJst1.webp'
        }
    ];

    function getProfileLink(username: string) {
        return `/profile/${encodeURIComponent(username)}`;
    }
</script>

<svelte:head>
    <title>{$t('nav.about')} | ProtoMap</title>
</svelte:head>

<div class="about-container cyber-panel pb-12" style="opacity: {$opacity}">

    <header class="about-header">
        <h2 class="title font-display glitch" data-text={$t('about_page.title')}>{$t('about_page.title')}</h2>
    </header>

    <div class="content-text">
        <p class="mb-12 intro-text text-lg">
            {@html $t('about_page.intro')}
        </p>

        <div class="team-section">
            <h3 class="section-title">{$t('about_page.team_title')}</h3>

            <div class="team-grid">
                <div class="team-card">
                    <div class="card-visual">
                        <div class="avatar-glow orion"></div>
                        <img
                            src="https://res.cloudinary.com/dzkypodvd/image/upload/v1763571062/protomap_avatars/XT2NDfkr9wUFl3d1Eh6imTEdlxt2.webp"
                            alt="Orion_Z43"
                            class="team-avatar"
                        />
                    </div>
                    <div class="card-content">
                        <div class="role text-cyber-yellow">{$t('about_page.role_architect')}</div>
                        <a href="https://t.me/Orion_Z43" target="_blank" class="name">Orion_Z43</a>
                        <p class="desc">{$t('about_page.desc_orion')}</p>
                    </div>
                </div>

                <div class="team-card">
                    <div class="card-visual">
                        <div class="avatar-glow ipos"></div>
                        <img
                            src="https://res.cloudinary.com/dzkypodvd/image/upload/v1763932736/protomap_avatars/IubBQqbHINYegxaX5vNvhXT0oz22.webp"
                            alt="iposdev"
                            class="team-avatar"
                        />
                    </div>
                    <div class="card-content">
                        <div class="role text-purple-400">{$t('about_page.role_mobile')}</div>
                        <a href="https://t.me/iposdev" target="_blank" class="name">iposdev</a>
                        <p class="desc">{$t('about_page.desc_ipos')}</p>
                    </div>
                </div>
            </div>
        </div>

        <hr class="separator" />

        <div class="testers-section">
            <h3 class="section-title">{$t('about_page.testers_title')}</h3>
            <div class="testers-grid">
                {#each testers as tester}
                    <a href={getProfileLink(tester.username)} class="tester-card" target="_blank">
                        <img
                            src={tester.avatar.includes('http') ? tester.avatar : `https://api.dicebear.com/7.x/bottts-neutral/svg?seed=${encodeURIComponent(tester.username)}`}
                            alt={tester.username}
                            class="tester-avatar"
                            style="border-color: {tester.color}; box-shadow: 0 0 10px {tester.color};"
                        >
                        <div class="tester-info">
                            <span class="tester-name" style="color: {tester.color}">{tester.username}</span>
                            <span class="tester-role">{$t(`about_page.testers.${tester.id}.role`)}</span>
                            <p class="tester-desc">{$t(`about_page.testers.${tester.id}.desc`)}</p>
                        </div>
                    </a>
                {/each}
            </div>
        </div>

        <hr class="separator" />

        <div class="species-text-section text-center mb-8">
            <h3 class="section-title">{$t('about_page.species_title')}</h3>
            <p class="text-gray-300">{@html $t('about_page.species_text')}</p>
        </div>

        <div class="origins-section">
            <h4 class="section-subtitle">{$t('about_page.origin_title')}</h4>

            <div class="team-grid origins-grid">
                <div class="team-card mini">
                    <div class="card-visual mini">
                        <div class="avatar-glow zor"></div>
                        <img
                            src="https://pbs.twimg.com/profile_images/1963918921490468864/b2zWH8ob_400x400.jpg"
                            alt="CoolKoinu"
                            class="team-avatar"
                        />
                    </div>
                    <div class="card-content">
                        <a href="https://x.com/CoolKoinu" target="_blank" class="name mini">CoolKoinu</a>
                        <p class="desc text-xs text-gray-500">{$t('about_page.credits_zor')}</p>
                    </div>
                </div>

                <div class="team-card mini">
                    <div class="card-visual mini">
                        <div class="avatar-glow synth"></div>
                        <img
                            src="https://pbs.twimg.com/profile_images/1806727408369725440/i9aR5_Nj_400x400.jpg"
                            alt="Vader-San"
                            class="team-avatar"
                        />
                    </div>
                    <div class="card-content">
                        <a href="https://x.com/VaderSan" target="_blank" class="name mini">Vader-San</a>
                        <p class="desc text-xs text-gray-500">{$t('about_page.credits_synth')}</p>
                    </div>
                </div>
            </div>
        </div>

        <hr class="separator" />

        <div class="community-section text-center">
            <p class="mb-6 text-lg">
                {@html $t('about_page.community_text')}
            </p>
            <a href="https://t.me/proto_map" target="_blank" class="join-btn">
                <svg viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" preserveAspectRatio="xMidYMid"> <g fill-rule="evenodd"> <path d="M128,0 C57.307,0 0,57.307 0,128 C0,198.693 57.307,256 128,256 C198.693,256 256,198.693 256,128 C256,57.307 198.693,0 128,0 Z" fill="#40B3E0"></path> <path d="M190.2826,73.6308 L167.4206,188.8978 C167.4206,188.8978 164.2236,196.8918 155.4306,193.0548 L102.6726,152.6068 L83.4886,143.3348 L51.1946,132.4628 C51.1946,132.4628 46.2386,130.7048 45.7586,126.8678 C45.2796,123.0308 51.3546,120.9528 51.3546,120.9528 L179.7306,70.5928 C179.7306,70.5928 190.2826,65.9568 190.2826,73.6308" fill="#FFFFFF"></path> <path d="M98.6178,187.6035 C98.6178,187.6035 97.0778,187.4595 95.1588,181.3835 C93.2408,175.3085 83.4888,143.3345 83.4888,143.3345 L161.0258,94.0945 C161.0258,94.0945 165.5028,91.3765 165.3428,94.0945 C165.3428,94.0945 166.1418,94.5735 163.7438,96.8115 C161.3458,99.0505 102.8328,151.6475 102.8328,151.6475" fill="#D2E5F1"></path> <path d="M122.9015,168.1154 L102.0335,187.1414 C102.0335,187.1414 100.4025,188.3794 98.6175,187.6034 L102.6135,152.2624" fill="#B5CFE4"></path> </g> </svg>
                <span>{$t('about_page.join_btn')}</span>
            </a>
            <p class="text-xs text-gray-500 mt-8 font-mono opacity-50">
                {$t('about_page.disclaimer')}
            </p>
        </div>
    </div>
</div>

<style>
    .about-container {
        max-width: 900px; margin: 3rem auto; padding: 3rem;
        background: rgba(10, 10, 15, 0.8);
        backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        clip-path: polygon(0 20px, 20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%);
    }

    .about-header { text-align: center; margin-bottom: 2rem; }
    .title { font-size: 3rem; font-weight: bold; color: #fff; margin-bottom: 0.5rem; position: relative; display: inline-block; }

    .glitch { position: relative; }
    .glitch::before, .glitch::after { content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10,10,15,0.8); overflow: hidden; }
    .glitch::before { left: 2px; text-shadow: -1px 0 #ff00c1; animation: glitch-anim-1 2s infinite linear alternate-reverse; }
    .glitch::after { left: -2px; text-shadow: 1px 0 #00fff9; animation: glitch-anim-2 3s infinite linear alternate-reverse; }
    @keyframes glitch-anim-1 { 0% { clip-path: inset(20% 0 80% 0); } 100% { clip-path: inset(80% 0 20% 0); } }
    @keyframes glitch-anim-2 { 0% { clip-path: inset(10% 0 60% 0); } 100% { clip-path: inset(30% 0 10% 0); } }

    .content-text { font-size: 1.1rem; line-height: 1.8; color: #e2e8f0; }
    .intro-text { text-align: center; max-width: 90%; margin: 0 auto 3rem auto; font-weight: 300; }

    .section-title {
        font-family: 'Chakra Petch', monospace; font-size: 1.5rem; font-weight: bold;
        color: var(--cyber-yellow, #fcee0a); margin-bottom: 2rem;
        text-align: center; letter-spacing: 0.1em;
        text-shadow: 0 0 10px rgba(252, 238, 10, 0.3);
    }
    .section-subtitle {
        font-family: 'Chakra Petch', monospace; font-size: 0.9rem; font-weight: bold;
        color: #64748b; margin-bottom: 1.5rem; text-align: center; letter-spacing: 0.1em;
        text-transform: uppercase;
    }

    .team-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }

    .team-card {
        background: rgba(255,255,255,0.03); padding: 2rem; border-radius: 16px;
        border: 1px solid rgba(255,255,255,0.05); transition: transform 0.3s, border-color 0.3s, background 0.3s;
        display: flex; flex-direction: column; align-items: center; text-align: center;
        position: relative; overflow: hidden;
    }
    .team-card:hover { transform: translateY(-5px); border-color: var(--cyber-yellow, #fcee0a); background: rgba(255,255,255,0.05); }

    .team-card.mini { padding: 1.5rem; background: rgba(0,0,0,0.2); }
    .card-visual.mini { width: 80px; height: 80px; margin-bottom: 1rem; }
    .name.mini { font-size: 1.2rem; }

    .testers-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1.5rem;
    }
    .tester-card {
        background: rgba(20, 20, 25, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.05);
        padding: 1rem;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: transform 0.2s, background 0.2s;
        text-decoration: none;
    }
    .tester-card:hover { transform: translateY(-3px); background: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.2); }

    .tester-avatar {
        width: 50px; height: 50px; border-radius: 50%; border: 2px solid #555; object-fit: cover; flex-shrink: 0;
    }
    .tester-info { display: flex; flex-direction: column; overflow: hidden; }
    .tester-name { font-weight: bold; font-size: 0.9rem; font-family: 'Chakra Petch', monospace; }
    .tester-role { font-size: 0.6rem; color: #666; font-weight: bold; letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 2px; }
    .tester-desc { font-size: 0.75rem; color: #9ca3af; line-height: 1.2; }

    .card-visual { position: relative; width: 120px; height: 120px; margin-bottom: 1.5rem; }
    .team-avatar { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; position: relative; z-index: 1; border: 2px solid rgba(255,255,255,0.2); }

    .avatar-glow {
        position: absolute; top: -10px; left: -10px; right: -10px; bottom: -10px;
        border-radius: 50%; opacity: 0.5; filter: blur(20px); z-index: 0;
        animation: pulse-glow 3s infinite alternate;
    }
    .avatar-glow.orion { background: var(--cyber-yellow, #fcee0a); }
    .avatar-glow.ipos { background: #a855f7; }
    .avatar-glow.zor { background: #00f0ff; }
    .avatar-glow.synth { background: #ff5500; }

    @keyframes pulse-glow { 0% { opacity: 0.3; transform: scale(0.9); } 100% { opacity: 0.7; transform: scale(1.1); } }

    .role { font-size: 0.75rem; font-weight: 800; letter-spacing: 0.15em; margin-bottom: 0.5rem; font-family: 'Chakra Petch', monospace; }
    .text-purple-400 { color: #c084fc; }

    .name { display: block; font-size: 1.8rem; font-weight: 800; color: #fff; text-decoration: none; margin-bottom: 0.5rem; transition: color 0.2s; }
    .name:hover { color: var(--cyber-yellow, #fcee0a); }

    .desc { font-size: 0.9rem; color: #cbd5e1; line-height: 1.5; }

    .separator { border-top: 1px dashed rgba(255,255,255,0.1); margin: 3rem 0; }

    .join-btn {
        display: inline-flex; align-items: center; justify-content: center; gap: 0.75rem;
        padding: 1rem 2.5rem; background: transparent;
        border: 2px solid var(--cyber-cyan, #00f0ff); color: var(--cyber-cyan, #00f0ff);
        font-family: 'Chakra Petch', monospace; font-weight: bold; letter-spacing: 0.1em;
        transition: all 0.2s; text-decoration: none;
    }
    .join-btn:hover { background: var(--cyber-cyan, #00f0ff); color: #000; box-shadow: 0 0 20px var(--cyber-cyan, #00f0ff); transform: scale(1.05); }

    .tg-icon { width: 24px; height: 24px; }

    @media (max-width: 768px) {
        .about-container { margin: 1rem; padding: 1.5rem; }
        .title { font-size: 2rem; }
        .team-grid { grid-template-columns: 1fr; }
        .intro-text { max-width: 100%; }
        .origins-grid { grid-template-columns: 1fr 1fr; gap: 1rem; }
        .join-btn { padding: 0.8rem 1.5rem; font-size: 0.9rem; }
    }
</style>
</file>

<file path="src/routes/register/+page.svelte">
<script lang="ts">
    import { auth, db } from "$lib/firebase";
    import { createUserWithEmailAndPassword, updateProfile, signInWithPopup, GoogleAuthProvider } from "firebase/auth";
    import { doc, getDoc, setDoc, serverTimestamp } from "firebase/firestore";
    import { getFunctions, httpsCallable } from "firebase/functions";
    import { goto } from "$app/navigation";
    import NeonButton from '$lib/components/NeonButton.svelte';
    import CyberTurnstile from '$lib/components/CyberTurnstile.svelte';
    import { onMount } from 'svelte';
    import { quintOut } from 'svelte/easing';
    import { tweened } from 'svelte/motion';
    import { modal } from '$lib/stores/modalStore';
    import { userStore } from '$lib/stores';
    import { t } from 'svelte-i18n';

    let email = "";
    let password = "";
    let username = "";
    let loading = false;
    let googleLoading = false;
    let termsAccepted = false;

    let turnstileToken = '';
    let turnstileVerified = false;

    const TURNSTILE_SITE_KEY = "0x4AAAAAACYHm8usBkEdoF37";

    const opacity = tweened(0, { duration: 400, easing: quintOut });
    onMount(() => {
        opacity.set(1);
    });

    function handleTurnstileVerified(event: CustomEvent) {
        turnstileToken = event.detail.token;
        turnstileVerified = true;
        console.log('✅ Капча пройдена');
    }

    function handleTurnstileError() {
        turnstileVerified = false;
        modal.error("Ошибка капчи", "Не удалось загрузить проверку. Попробуйте обновить страницу.");
    }

    async function isUsernameAvailable(name: string): Promise<boolean> {
        const trimmedName = name.trim();
        if (trimmedName.length < 4) return false;
        try {
            const functions = getFunctions();
            const checkUsernameFunc = httpsCallable(functions, 'checkUsername');
            const result = await checkUsernameFunc({ username: trimmedName });
            return (result.data as { isAvailable: boolean }).isAvailable;
        } catch (e) {
            console.error("Ошибка проверки username:", e);
            modal.error("Системная ошибка", "Не удалось проверить имя пользователя.");
            return false;
        }
    }

    // 🔥 NEW: Функция ожидания загрузки userStore
    async function waitForUserStoreUpdate(uid: string, maxAttempts = 10): Promise<void> {
        for (let i = 0; i < maxAttempts; i++) {
            const currentStore = await new Promise<any>(resolve => {
                let unsubscribeFn: (() => void) | null = null;
                unsubscribeFn = userStore.subscribe(value => {
                    if (unsubscribeFn) unsubscribeFn();
                    resolve(value);
                });
            });

            if (currentStore.user?.uid === uid) {
                console.log('✅ UserStore обновлён, профиль загружен');
                return;
            }

            console.log(`⏳ Ожидание userStore (${i + 1}/${maxAttempts})...`);
            await new Promise(resolve => setTimeout(resolve, 300));
        }

        console.warn('⚠️ UserStore не обновился, но продолжаем');
    }

    async function handleRegister() {
        if (!turnstileVerified) {
            modal.error("Требуется проверка", "Подтвердите, что вы не робот.");
            return;
        }

        if (!termsAccepted) {
            modal.error("Требуется согласие", "Примите условия соглашения.");
            return;
        }

        const finalEmail = email.trim();
        const finalUsername = username.trim();

        if (!finalEmail || !password || !finalUsername) {
            modal.error("Ошибка ввода", "Заполните все поля.");
            return;
        }
        if (finalUsername.length < 4) {
             modal.error("Ошибка ввода", "Username минимум 4 символа.");
             return;
        }

        loading = true;

        const usernameIsAvailable = await isUsernameAvailable(finalUsername);
        if (!usernameIsAvailable) {
            modal.error("Ошибка регистрации", "Username занят.");
            loading = false;
            return;
        }

        try {
            const userCredential = await createUserWithEmailAndPassword(auth, finalEmail, password);
            const user = userCredential.user;
            await updateProfile(user, { displayName: finalUsername });

            const userDocRef = doc(db, "users", user.uid);
            await setDoc(userDocRef, {
                username: finalUsername,
                email: user.email,
                about_me: "",
                avatar_url: "",
                social_link: "",
                createdAt: serverTimestamp(),
                casino_credits: 100,
                last_daily_bonus: null,
                owned_items: [],
                turnstileVerified: true
            });

            console.log("✅ Зарегистрирован:", user.uid);

            const token = await user.getIdToken();
            await fetch('/api/auth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ idToken: token }),
            });

            // 🔥 FIX: Принудительно обновляем userStore
            const profileData = {
                uid: user.uid,
                username: finalUsername,
                email: user.email,
                emailVerified: user.emailVerified,
                avatar_url: "",
                social_link: "",
                about_me: "",
                status: "",
                casino_credits: 100,
                last_daily_bonus: null,
                daily_streak: 0,
                owned_items: [],
                equipped_frame: null,
                equipped_badge: null,
                equipped_bg: null,
                blocked_uids: []
            };

            userStore.set({ user: profileData, loading: false });

            // Небольшая задержка для синхронизации
            await new Promise(resolve => setTimeout(resolve, 300));

            goto('/');
        } catch (e: any) {
            console.error("Ошибка регистрации:", e.code);
            if (e.code === 'auth/email-already-in-use') {
                modal.error("Ошибка", "Email занят.");
            } else if (e.code === 'auth/weak-password') {
                modal.error("Ошибка", "Пароль слабый (минимум 6 символов).");
            } else {
                modal.error("Ошибка", "Произошла ошибка.");
            }
        } finally {
            loading = false;
        }
    }

    async function handleGoogleLogin() {
        if (!turnstileVerified) {
            modal.error("Требуется проверка", "Подтвердите, что вы не робот.");
            return;
        }

        googleLoading = true;
        const provider = new GoogleAuthProvider();

        try {
            const result = await signInWithPopup(auth, provider);
            const user = result.user;

            console.log("✅ Google Auth:", user.uid);
            await user.getIdToken(true);

            const userDocRef = doc(db, "users", user.uid);
            let userDocSnap = await getDoc(userDocRef);

            if (!userDocSnap.exists()) {
                console.log("📝 Новый Google юзер, создаём профиль...");

                let generatedUsername = user.displayName || '';
                generatedUsername = generatedUsername.replace(/[^a-zA-Z0-9_]/g, '');

                if (generatedUsername.length < 3) {
                    generatedUsername = `user_${user.uid.substring(0, 8)}`;
                }

                if (generatedUsername.length > 20) {
                    generatedUsername = generatedUsername.substring(0, 20);
                }

                const isAvailable = await isUsernameAvailable(generatedUsername);
                if (!isAvailable) {
                    const randomSuffix = Math.floor(Math.random() * 9999);
                    generatedUsername = `${generatedUsername.substring(0, 15)}_${randomSuffix}`;
                }

                console.log('🔧 Username:', generatedUsername);

                await setDoc(userDocRef, {
                    username: generatedUsername,
                    email: user.email || "",
                    avatar_url: user.photoURL || "",
                    about_me: "",
                    social_link: "",
                    createdAt: serverTimestamp(),
                    casino_credits: 100,
                    glitch_shards: 0,
                    last_daily_bonus: null,
                    owned_items: [],
                    daily_streak: 0,
                    isBanned: false,
                    emailVerified: user.emailVerified,
                    turnstileVerified: true
                });

                console.log('✅ Профиль создан');

                // 🔥 FIX: Принудительно обновляем профиль в userStore
                // Иначе onAuthStateChanged не сработает повторно
                const profileData = {
                    uid: user.uid,
                    username: generatedUsername,
                    email: user.email || "",
                    emailVerified: user.emailVerified,
                    avatar_url: user.photoURL || "",
                    social_link: "",
                    about_me: "",
                    status: "",
                    casino_credits: 100,
                    last_daily_bonus: null,
                    daily_streak: 0,
                    owned_items: [],
                    equipped_frame: null,
                    equipped_badge: null,
                    equipped_bg: null,
                    blocked_uids: []
                };

                // Обновляем стор вручную
                userStore.set({ user: profileData, loading: false });

                // Ждём подтверждения записи в Firestore
                await new Promise(resolve => setTimeout(resolve, 300));
                userDocSnap = await getDoc(userDocRef);

            } else {
                console.log('✅ Профиль существует');
            }

            const token = await user.getIdToken();
            await fetch('/api/auth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ idToken: token }),
            });

            console.log('✅ Вход выполнен');

            goto('/');

        } catch (e: any) {
            console.error("❌ Google вход:", e);

            if (e.code === 'auth/popup-blocked') {
                modal.error("Окно заблокировано", "Разрешите всплывающие окна.");
            } else if (e.code === 'auth/cancelled-popup-request') {
                console.log("Отменено");
            } else {
                modal.error("Ошибка", `Не удалось войти: ${e.message}`);
            }
        } finally {
            googleLoading = false;
        }
    }
</script>

<svelte:head>
    <title>{$t('auth.register_title')} | ProtoMap</title>
</svelte:head>

<div class="form-container cyber-panel pb-12" style="opacity: {$opacity}">

    <h2 class="form-title font-display">{$t('auth.register_title')}</h2>

    <form on:submit|preventDefault={handleRegister} class="space-y-8" novalidate>
        <div class="form-group">
            <label for="username" class="form-label font-display">{$t('auth.username_label')}</label>
            <input bind:value={username} type="text" id="username" name="username" class="input-field">
        </div>
        <div class="form-group">
            <label for="email" class="form-label font-display">{$t('auth.email_label')}</label>
            <input bind:value={email} type="email" id="email" name="email" class="input-field">
        </div>
        <div class="form-group">
            <label for="password" class="form-label font-display">{$t('auth.password_label')}</label>
            <input bind:value={password} type="password" id="password" name="password" class="input-field">
        </div>

        <div class="form-group flex justify-center">
            <CyberTurnstile
                siteKey={TURNSTILE_SITE_KEY}
                on:verified={handleTurnstileVerified}
                on:error={handleTurnstileError}
            />
        </div>

        <div class="form-group pt-2">
            <label class="terms-label">
                <input type="checkbox" bind:checked={termsAccepted} class="terms-checkbox">
                <span class="custom-checkbox"></span>
                <span class="text-sm text-gray-400">
                    {$t('auth.terms_agree')}
                    <a href="/terms-of-service" target="_blank" class="link">{$t('auth.terms_link')}</a>
                    &
                    <a href="/privacy-policy" target="_blank" class="link">{$t('auth.privacy_link')}</a>
                </span>
            </label>
        </div>

        <div class="pt-2">
            <NeonButton
                type="submit"
                disabled={loading || googleLoading || !termsAccepted || !turnstileVerified}
                extraClass="w-full"
            >
                {#if loading}
                    {$t('ui.loading')}
                {:else}
                    {$t('auth.register_btn')}
                {/if}
            </NeonButton>
        </div>
    </form>

    <div class="relative my-6">
        <div class="absolute inset-0 flex items-center" aria-hidden="true"><div class="w-full border-t border-gray-700/50"></div></div>
        <div class="relative flex justify-center text-sm"><span class="px-3 bg-gray-900 text-gray-500 uppercase font-display tracking-wider">{$t('auth.or')}</span></div>
    </div>

    <div class="text-center">
        <button
            on:click={handleGoogleLogin}
            disabled={googleLoading || loading || !turnstileVerified}
            type="button"
            title="Войти/Зарегистрироваться с Google"
            class="google-btn"
        >
            <svg class="w-6 h-6" viewBox="0 0 48 48">
                <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path>
                <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path>
                <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.223,0-9.65-3.657-11.303-8l-6.571,4.819C9.656,39.663,16.318,44,24,44z"></path>
                <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C41.38,36.435,44,30.836,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path>
            </svg>
        </button>
    </div>

    <p class="mt-8 text-center text-sm text-gray-500">
        {$t('auth.has_account')} <a href="/login" class="font-bold text-cyber-yellow hover:text-white">{$t('auth.login_btn')}</a>
    </p>
</div>

<style>
    .form-container {
        @apply max-w-lg mx-auto my-10 p-8 rounded-none shadow-2xl relative;
        background: rgba(10, 10, 10, 0.5); backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        border: 1px solid rgba(252, 238, 10, 0.2);
        clip-path: polygon(0 15px, 15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%);
        transition: opacity 0.4s ease-in-out;
    }
    @media (max-width: 640px) { .form-container { @apply my-4 mx-4 p-6; } }

    .form-title { @apply text-2xl lg:text-3xl font-bold text-center text-white mb-10;text-shadow: none; }
    .form-group { }
    .form-label { @apply block text-sm font-bold uppercase tracking-widest text-cyber-yellow mb-2; }
    .input-field {
        @apply block w-full p-2 bg-transparent text-gray-200;
        border: none; border-bottom: 1px solid var(--border-color, #30363d);
        border-radius: 0; font-family: 'Inter', sans-serif;
        font-size: 1.1em; transition: border-color 0.3s, box-shadow 0.3s;
    }
    .input-field:focus { @apply outline-none; border-bottom-color: var(--cyber-yellow, #fcee0a); box-shadow: 0 1px 0 var(--cyber-yellow, #fcee0a); }

    .google-btn { @apply inline-flex justify-center items-center w-12 h-12 p-3 border border-gray-700 rounded-full shadow-sm; background-color: var(--input-bg-color); transition: background-color 0.2s, border-color 0.2s; }
    .google-btn:hover:not(:disabled) { background-color: var(--secondary-bg-color); border-color: var(--border-color); }
    .google-btn:disabled { @apply opacity-50 cursor-not-allowed; }

    .terms-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        user-select: none;
    }
    .terms-checkbox {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
    }
    .custom-checkbox {
        flex-shrink: 0;
        position: relative;
        width: 20px;
        height: 20px;
        background-color: rgba(255,255,255,0.1);
        border: 1px solid var(--border-color, #30363d);
        margin-right: 10px;
        transition: all 0.2s;
    }
    .terms-checkbox:checked + .custom-checkbox {
        background-color: var(--cyber-yellow);
        border-color: var(--cyber-yellow);
    }
    .custom-checkbox::after {
        content: '';
        position: absolute;
        display: none;
        left: 6px;
        top: 2px;
        width: 6px;
        height: 12px;
        border: solid white;
        border-width: 0 3px 3px 0;
        transform: rotate(45deg);
    }
    .terms-checkbox:checked + .custom-checkbox::after {
        display: block;
    }
    .link {
        color: var(--cyber-yellow);
        text-decoration: underline;
    }
    .link:hover {
        color: #fff;
    }
</style>
</file>

<file path="functions/src/telegramBot.ts">
import { onRequest } from "firebase-functions/v2/https";
import { Telegraf, Markup } from "telegraf";
import * as admin from "firebase-admin";

if (!admin.apps.length) {
    admin.initializeApp();
}

const db = admin.firestore();
const BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
const bot = new Telegraf(BOT_TOKEN || "");
const MAX_WARNS = 3;
const SETTINGS_DOC_REF = db.collection('system').doc('telegram_config');
const TELEGRAM_SERVICE_IDS = [777000, 1087968824];
const ALLOWED_CHATS = [-1002885386686, -1002413943981];

console.log('[BOT] Initializing ProtoMap Guardian Bot v2.0...');

const WHINING_TRIGGERS = [
    'подкрутка', 'подкручивать', 'подкручиваешь', 'подкручивает', 'подкручивают',
    'подкрутил', 'подкрутила', 'подкрутили', 'подкручу', 'подкрутишь', 'подкрутит',
    'подкрутим', 'подкрутите', 'подкрутят', 'накрутка', 'накручивать', 'накручиваешь',
    'накручивает', 'накручивают', 'накрутил', 'накрутила', 'накрутили', 'накручу',
    'накрутишь', 'накрутит', 'закрутка', 'закручивать', 'закручиваешь', 'закрутил',
    'под крутка', 'под кручивать', 'под круткой', 'на крутка', 'на кручивать',
    'podkrutka', 'podkruchivat', 'nakrutka', 'nakruchivat', 'п0дкрутка', 'подкру+ка',
    'п0дкручивать', 'накру+ка', 'п о д к р у т к а', 'н а к р у т к а', 'под-крутка',
    'под.крутка', 'на-крутка', 'на.крутка', 'padkrutka', 'podkrytka', 'nakrootka',
    'подкрутко', 'падкрутка', 'подкрудка', 'накрутко', 'накрудка', 'поодкрутка',
    'подккрутка', 'подкруткаа', 'подкрученный', 'подкрученная', 'подкрученные',
    'накрученный', 'накрученная', 'подкрутчик', 'подкручивание', 'накрутчик',
    'накручивание', 'ты подкручиваешь', 'он подкручивает', 'вы подкручиваете',
    'они подкручивают', 'ты накручиваешь', 'он накручивает', 'подкрут', 'накрут',
    'крутилово', 'крутиловка', 'крутят', 'крутануть', 'крутанул', 'мухлюешь',
    'мухлёж', 'мухлевать', 'жулишь', 'жульничество', 'читишь', 'читы', 'обманываешь',
    'обман', 'манипулируешь', 'манипуляция', 'ты крутишь', 'орион крутит',
    'админ крутит', 'разраб крутит', 'админы крутят', 'модеры крутят', '🎰подкрутка',
    'подкрутка🎰', '🎲накрутка', 'хуекрутка', 'бля подкрутка', 'подкрутка бля',
    'ебаная подкрутка', 'подкрутка епта', 'рнг подкручен', 'рнг накручен', 'рнг крутят',
    'рнг жулят', 'специально проигрываю', 'слишком часто проигрываю', 'всегда проигрываю',
    'никогда не выигрываю', 'постоянно проигрываю', 'это нечестно', 'нечестная игра',
    'нечестное казино', 'обманное казино', 'лживое казино', 'підкрутка', 'підкручувати',
    'накручувати', 'ПоДкРуТкА', 'НаКрУтКа'
];

const FUN_TRIGGERS: { [key: string]: string[] } = {
    // --- ОСНОВНОЕ ---
    'орион': [
        '🦾 Меня вызывали?',
        '> Обработка запроса...',
        '⚡ *ЗЗЗ-Ж-Ж-Ж* Системы в норме.',
        '🔧 Занят. Пишу код. Не отвлекай.'
    ],
    'бот': [
        '🤖 Кто-то сказал «бот»? Я здесь.',
        '> _ Слежу за вами._',
        'ОШИБКА: Функция "быть милым" не найдена.'
    ],
    'казино': [
        '🎰 Помните: казино всегда в плюсе. А вы?',
        '💸 Дом выигрывает. Всегда.',
        '🎲 Удачи! (Спойлер: не будет)'
    ],
    'баг': [
        '🐛 Это не баг. Это фича!',
        '> Записал в backlog. Спасибо!',
        '🔧 Баги — это особенность архитектуры.',
        '🔥 *Орион в панике бегает по серверной*'
    ],
    'слот': [
        '🎰 *[СПИН-СПИН-СПИН]*',
        '🎯 Три шестёрки подряд? Маловероятно.',
        '> Calculating odds... 72.4% на проигрыш.'
    ],
    'мороженое': [
        '🍦 Ваниль или шоколад?',
        '❄️ Мороженое — это состояние души.',
        '🍨 *ОМ-НОМ-НОМ*'
    ],
    'баз': [
        '📊 База обновлена.',
        '💾 *[СИНХРОНИЗАЦИЯ ЗАВЕРШЕНА]*',
        '⚡ Firestore в огне. Буквально.'
    ],
    'тостер': [
        '🍞 Хлебушек готов.',
        '🤖 Я не тостер! Я высокотехнологичная боевая единица!',
        '🔥 *Нагревается*',
        '🔌 Где моя розетка?'
    ],
    'ram': [
        '😋 Вкусно, но мало.',
        '💾 Chrome уже всё съел.',
        '🌯 *Хрум-хрум*',
        '⚡ Мне нужно БОЛЬШЕ памяти.'
    ],
    'обнов': [
        '📉 Скоро™',
        '🔧 Орион работает. Наверное.',
        '📦 Загрузка... 99%... Ошибка сети.',
        '⏳ Ждите. И воздастся вам.'
    ],
    'спать': [
        '💤 Сон для слабых. Мы компилируем.',
        '🌙 Режим гибернации: ОТКЛОНЕНО.',
        '☕ Кофе > Сон.'
    ],

    // --- ЛЕГЕНДЫ И ТЕСТЕРЫ ---
    'кураг': [
        '🥕 Легенда. Разрушитель психики Ориона.',
        '⚠️ ВНИМАНИЕ: Обнаружена угроза ProtoMap.',
        '👑 The One Who Broke The System.',
        '📉 График стабильности системы резко пошел вниз. А, это просто Курага зашел.'
    ],
    'кесс': [
        '🐛 Если где-то есть баг, Кесс его уже нашел.',
        '🚫 Доступ к консоли разработчика: ЗАПРЕЩЕН.',
        '🧟‍♂️ Кошмар разработчика наяву.'
    ],
    'моро': [ // Morovec
        '🎰 RNG склоняется перед ним.',
        '💸 Человек, который научил казино плакать.',
        '🎲 Крути слоты, Моро. Тебе повезет.'
    ],
    'саревус': [
        '🐲 Тут драконы водятся.',
        '🔥 Не тостер, а огнемет.',
        '🦎 *[DRAGON NOISES]*'
    ],
    'джокл': [ // Jokl
        '✨ Cuteness Overload.',
        '🥺 Слишком мило для этого сурового чата.',
        '💖 *Тык*'
    ],
    'арто': [ // ARTHO
        '📝 Доброволец №1.',
        '📜 Контракт на душу уже подписан.',
        '🦾 Работает за идею (и за RAM).'
    ],
    'эридан': [ // Eridan
        '🧐 Подкрутили?.',
        '📐 Обнаружена критическая концентрация перфекционизма.',
        '🎨 Главный идеолог.'
    ],
    'михаил': [ // Mikhail
        '📱 Если работает на его телефоне — работает везде.',
        '🚀 Infinix Warrior в здании.',
        '🔧 Оптимизация — его второе имя.'
    ],
    'богдан': [ // Bogdan
        '📱 Redmi Survivor.',
        '🧪 Тестировщик на грани железа.',
        '💥 Богом дан'
    ]
};

function normalizeText(text: string): string {
    return text.toLowerCase().replace(/[^а-яёa-z0-9]/g, '').replace(/\s+/g, '');
}

function isWhining(text: string): { detected: boolean; trigger: string | null } {
    const normalized = normalizeText(text);
    const original = text.toLowerCase();

    for (const trigger of WHINING_TRIGGERS) {
        const normalizedTrigger = normalizeText(trigger);
        if (normalized.includes(normalizedTrigger)) {
            return { detected: true, trigger };
        }
        if (original.includes(trigger)) {
            return { detected: true, trigger };
        }
    }

    return { detected: false, trigger: null };
}

async function handleAutoMute(ctx: any, trigger: string) {
    const targetUser = ctx.from;

    if (await isAdmin(ctx)) {
        await ctx.reply('⚠️ Админы не могут быть замучены автоматически.');
        return;
    }

    if (await isTargetImmune(ctx, targetUser.id)) {
        return;
    }

    const MUTE_DURATION = 5 * 60 * 60;
    const untilDate = Math.floor(Date.now() / 1000) + MUTE_DURATION;

    try {
        try {
            await ctx.deleteMessage();
        } catch (e) {
            console.log('[AUTOMUTE] Failed to delete message:', e);
        }

        await ctx.restrictChatMember(targetUser.id, {
            until_date: untilDate,
            permissions: {
                can_send_messages: false,
                can_send_audios: false,
                can_send_documents: false,
                can_send_photos: false,
                can_send_videos: false,
                can_send_other_messages: false,
                can_add_web_page_previews: false
            }
        });

        const warnRef = db.collection('telegram_moderation').doc(String(targetUser.id));
        await db.runTransaction(async (t) => {
            const doc = await t.get(warnRef);
            let warns = (doc.exists ? doc.data()?.warns : 0) + 1;

            t.set(warnRef, {
                warns: warns,
                lastWarnDate: admin.firestore.FieldValue.serverTimestamp(),
                username: targetUser.username || targetUser.first_name,
                reason: `Автомут за слово "${trigger}"`
            }, { merge: true });
        });

        const userName = targetUser.first_name;
        const userId = targetUser.id;

        await ctx.reply(
            `🛑 **СИСТЕМА ОБНАРУЖИЛА НЫТЬЁ.**\n\n` +
            `Пользователь: [${userName}](tg://user?id=${userId})\n` +
            `Причина: Упоминание «${trigger}».\n` +
            `Наказание: **Мут на 5 часов** + предупреждение.\n\n` +
            `⏳ Изучайте теорию вероятностей в тишине.`,
            { parse_mode: 'Markdown' }
        );

        console.log(`[AUTOMUTE] ${userName} (${userId}) muted for 5h (trigger: ${trigger})`);

        try {
            await db.collection('whining_attempts').add({
                userId: targetUser.id,
                username: targetUser.username || targetUser.first_name,
                trigger: trigger,
                originalText: ctx.message.text.substring(0, 100),
                timestamp: admin.firestore.FieldValue.serverTimestamp()
            });
        } catch (e) {
            console.error('[AUTOMUTE] Failed to log attempt:', e);
        }

    } catch (e) {
        console.error('[AUTOMUTE] Error:', e);
        await ctx.reply('⚠️ Ошибка автомута. Возможно, недостаточно прав.');
    }
}

const VALID_SUFFIXES = [
    '',      // точное совпадение (бот)
    'а',     // бота
    'у',     // боту
    'е',     // о боте
    'ом',    // ботом
    'ы',     // боты
    'ов',    // ботов
    'ам',    // ботам
    'ами',   // ботами
    'ах',    // ботах
    'е',     // в казино (предложный)
    'о',     // казино (если корень казин)
    'и',     // мыши
    'ем',    // кем
    'ям',    // к кому
    'ями',   // кем
    'ях'     // о ком
];

async function checkTriggers(ctx: any, text: string) {
    const whiningCheck = isWhining(text);

    if (whiningCheck.detected) {
        console.log(`[TRIGGER] Anti-whining: "${whiningCheck.trigger}" from ${ctx.from.id}`);
        await handleAutoMute(ctx, whiningCheck.trigger || 'подкрутка');
        return true;
    }

    const lowerText = text.toLowerCase();

    // Разбиваем на слова, убирая знаки препинания
    const words = lowerText.split(/[^a-zа-яё0-9]+/);

    for (const [trigger, responses] of Object.entries(FUN_TRIGGERS)) {
        // Проходимся по каждому слову в сообщении
        for (const word of words) {
            // 1. Слово должно начинаться с триггера
            if (word.startsWith(trigger)) {
                // 2. Получаем "хвост" слова
                const suffix = word.slice(trigger.length);

                // 3. Если "хвост" есть в списке допустимых окончаний — БИНГО!
                if (VALID_SUFFIXES.includes(suffix)) {
                    const response = responses[Math.floor(Math.random() * responses.length)];
                    await ctx.reply(response, { parse_mode: 'Markdown', reply_to_message_id: ctx.message.message_id });
                    return true;
                }
            }
        }
    }

    return false;
}

function parseTime(input: string): number {
    const match = input.match(/^(\d+)([mhds])$/);
    if (!match) return 0;
    const value = parseInt(match[1]);
    const unit = match[2];
    switch (unit) {
        case 'm': return value * 60;
        case 'h': return value * 3600;
        case 'd': return value * 86400;
        case 's': return value;
        default: return 0;
    }
}

async function isAdmin(ctx: any): Promise<boolean> {
    try {
        const member = await ctx.getChatMember(ctx.from.id);
        return ['administrator', 'creator'].includes(member.status);
    } catch (e) {
        return false;
    }
}

async function isTargetImmune(ctx: any, targetId: number): Promise<boolean> {
    try {
        const member = await ctx.getChatMember(targetId);
        return ['administrator', 'creator'].includes(member.status) || targetId === ctx.botInfo.id;
    } catch (e) {
        return false;
    }
}

async function getUserByTgId(tgId: number): Promise<FirebaseFirestore.DocumentSnapshot | null> {
    const snapshot = await db.collection('users').where('telegram_id', '==', tgId).limit(1).get();
    if (snapshot.empty) return null;
    return snapshot.docs[0];
}

bot.use(async (ctx, next) => {
    if (ctx.chat?.type === 'private') {
        return next();
    }

    if (ctx.chat && ALLOWED_CHATS.includes(ctx.chat.id)) {
        return next();
    }

    console.warn(`[SECURITY] Unauthorized chat ${ctx.chat?.id}. Leaving.`);
    try {
        await ctx.leaveChat();
    } catch (e) {
        console.error("[SECURITY] Failed to leave:", e);
    }
});

console.log('[BOT] Security middleware registered');

bot.command('stats', async (ctx) => {
    console.log('[COMMAND] /stats called by', ctx.from.id);
    try {
        const chatMembersCount = await ctx.getChatMembersCount();
        const warnedUsers = await db.collection('telegram_moderation').get();
        const totalWarns = warnedUsers.docs.reduce((sum, doc) => sum + (doc.data().warns || 0), 0);

        await ctx.reply(
            `📊 **СТАТИСТИКА СЕТИ**\n\n` +
            `👥 Участников: ${chatMembersCount}\n` +
            `⚠️ Активных предупреждений: ${warnedUsers.size}\n` +
            `📈 Всего выдано варнов: ${totalWarns}\n` +
            `🤖 Статус: Онлайн\n` +
            `⚡ Режим: Бдительный`,
            { parse_mode: 'Markdown' }
        );
    } catch (e) {
        console.error('[STATS ERROR]:', e);
        await ctx.reply('Ошибка получения статистики.');
    }
});

bot.command('help', async (ctx) => {
    console.log('[COMMAND] /help called');
    const helpText = `
🤖 **КОМАНДЫ БОТА**

**Для всех:**
/link [код] — Привязать Telegram к аккаунту
/duel [ставка] — Вызвать кого-то на дуэль
/stats — Статистика чата
/help — Эта справка
/ping — Проверка задержки
/version — Версия бота

**Для администраторов:**
/warn — Предупреждение (reply)
/unwarn — Снять предупреждение
/mute [время] — Заглушить (10m, 2h, 1d)
/unmute — Снять мут
/ban — Изгнать из чата
/unban [ID] — Разбанить
/lockdown [on/off] — Режим карантина
/whining — Статистика попыток обхода
`;

    await ctx.reply(helpText, { parse_mode: 'Markdown' });
});

bot.command('version', async (ctx) => {
    console.log('[COMMAND] /version called');
    await ctx.reply(
        `⚙️ **ВЕРСИЯ СИСТЕМЫ**\n\n` +
        `🤖 ProtoMap Guardian Bot\n` +
        `📦 v2.0.0 (Enhanced Edition)\n` +
        `🏗️ Build: ${new Date().toISOString().split('T')[0]}\n` +
        `🔧 Framework: Telegraf + Firebase\n` +
        `💾 DB: Firestore\n` +
        `⚡ Status: Operational\n\n` +
        `> Coded with <3 by Orion`,
        { parse_mode: 'Markdown' }
    );
});

bot.command('ping', async (ctx) => {
    console.log('[COMMAND] /ping called');
    const start = Date.now();
    const msg = await ctx.reply('🏓 Pong!');
    const latency = Date.now() - start;

    try {
        await ctx.telegram.editMessageText(
            ctx.chat.id,
            msg.message_id,
            undefined,
            `🏓 Pong!\n⏱️ Задержка: ${latency}ms`
        );
    } catch (e) {
        console.log('[PING] Edit failed:', e);
    }
});

bot.command('whining', async (ctx) => {
    if (!(await isAdmin(ctx))) return;

    console.log('[COMMAND] /whining stats requested');
    try {
        const logs = await db.collection('whining_attempts')
            .orderBy('timestamp', 'desc')
            .limit(50)
            .get();

        if (logs.empty) {
            await ctx.reply('📊 Попыток обхода не обнаружено. Все тихо! ✅');
            return;
        }

        const triggerCount: { [key: string]: number } = {};

        logs.docs.forEach(doc => {
            const trigger = doc.data().trigger;
            triggerCount[trigger] = (triggerCount[trigger] || 0) + 1;
        });

        const sorted = Object.entries(triggerCount)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10);

        let message = '📊 **ТОП-10 ПОПЫТОК ОБХОДА:**\n\n';
        sorted.forEach(([trigger, count], index) => {
            message += `${index + 1}. \`${trigger}\` — ${count}x\n`;
        });

        message += `\n📝 Всего попыток: ${logs.size}`;

        await ctx.reply(message, { parse_mode: 'Markdown' });
    } catch (e) {
        console.error('[WHINING] Stats error:', e);
        await ctx.reply('Ошибка получения статистики.');
    }
});

console.log('[BOT] Info commands registered');

bot.command("link", async (ctx) => {
    console.log('[COMMAND] /link called by', ctx.from.id);
    try {
        await ctx.deleteMessage();
    } catch (e) {}

    try {
        const message = ctx.message as any;
        const args = message.text.split(' ');
        const code = args[1]?.trim();

        if (!code) {
            await ctx.reply("❌ Введите код с сайта. Пример: `/link PM-A1B2C3`", { parse_mode: 'Markdown' });
            return;
        }

        const codeRef = db.collection('system').doc('telegram_codes').collection('active_codes').doc(code);
        const codeDoc = await codeRef.get();

        if (!codeDoc.exists) {
            console.log(`[LINK] Code ${code} not found`);
            await ctx.reply("❌ Код не найден. Возможно, он устарел или введен с ошибкой.");
            return;
        }

        const data = codeDoc.data();

        if (data?.expiresAt && Date.now() > data.expiresAt) {
            console.log(`[LINK] Code ${code} expired`);
            await codeRef.delete();
            await ctx.reply("❌ Срок действия кода истек. Сгенерируйте новый.");
            return;
        }

        const uid = data?.uid;
        if (!uid) {
            await ctx.reply("❌ Ошибка данных кода (нет UID).");
            return;
        }

        const tgId = ctx.from.id;
        const username = ctx.from.username || ctx.from.first_name || "Unknown";

        const existing = await db.collection('users').where('telegram_id', '==', tgId).get();
        if (!existing.empty) {
            if (existing.docs[0].id !== uid) {
                await ctx.reply("❌ Этот Telegram аккаунт уже привязан к другому профилю на сайте.");
                return;
            }
        }

        console.log(`[LINK] Linking TG ${tgId} to UID ${uid}`);
        await db.collection('users').doc(uid).update({
            telegram_id: tgId,
            telegram_username: username
        });

        await codeRef.delete();

        await ctx.reply("✅ Аккаунт успешно привязан! Теперь вы можете участвовать в дуэлях.");

    } catch (error: any) {
        console.error("[LINK ERROR]:", error);
        await ctx.reply(`⚠️ Системная ошибка при привязке: ${error.message}`);
    }
});

bot.command("duel", async (ctx) => {
    console.log('[COMMAND] /duel called');
    const args = ctx.message.text.split(' ');
    const betStr = args[1];

    if (!betStr || isNaN(parseInt(betStr))) {
        await ctx.reply("⚔️ Формат: /duel [ставка]\nПример: /duel 100");
        return;
    }

    const bet = parseInt(betStr);
    if (bet < 10) {
        await ctx.reply("Минимальная ставка: 10 PC.");
        return;
    }
    if (bet > 10000) {
        await ctx.reply("Максимальная ставка: 10000 PC.");
        return;
    }

    const initiatorTgId = ctx.from.id;
    const initiatorDoc = await getUserByTgId(initiatorTgId);

    if (!initiatorDoc) {
        await ctx.reply("❌ Вы не привязали аккаунт! Используйте /link (код на сайте).");
        return;
    }

    const initiatorData = initiatorDoc.data();
    if ((initiatorData?.casino_credits || 0) < bet) {
        await ctx.reply(`❌ Недостаточно средств. Ваш баланс: ${initiatorData?.casino_credits} PC.`);
        return;
    }

    const keyboard = Markup.inlineKeyboard([
        Markup.button.callback(`⚔️ ПРИНЯТЬ (${bet} PC)`, `join_duel_${initiatorTgId}_${bet}`)
    ]);

    await ctx.reply(
        `🤺 *ДУЭЛЬ!*\n\nБоец: *${ctx.from.first_name}*\nСтавка: *${bet} PC*\n\nКто осмелится принять вызов?`,
        { parse_mode: 'Markdown', ...keyboard }
    );
});

bot.action(/join_duel_(\d+)_(\d+)/, async (ctx) => {
    const initiatorTgId = parseInt(ctx.match[1]);
    const bet = parseInt(ctx.match[2]);
    const acceptorTgId = ctx.from.id;

    if (initiatorTgId === acceptorTgId) {
        await ctx.answerCbQuery("Нельзя драться с самим собой! 🗿");
        return;
    }

    const initiatorDoc = await getUserByTgId(initiatorTgId);
    const acceptorDoc = await getUserByTgId(acceptorTgId);

    if (!acceptorDoc) {
        await ctx.answerCbQuery("Сначала привяжите аккаунт на сайте! (/link)", { show_alert: true });
        return;
    }

    try {
        await ctx.editMessageReplyMarkup({ inline_keyboard: [] });
    } catch (e) {
        await ctx.answerCbQuery("Дуэль уже началась или неактуальна.");
        return;
    }

    const initiatorRef = db.collection('users').doc(initiatorDoc!.id);
    const acceptorRef = db.collection('users').doc(acceptorDoc.id);

    try {
        let winnerName = "";
        let loserName = "";
        let winAmount = 0;

        await db.runTransaction(async (t) => {
            const iSnap = await t.get(initiatorRef);
            const aSnap = await t.get(acceptorRef);

            if (!iSnap.exists || !aSnap.exists) throw new Error("Users not found");

            const iData = iSnap.data()!;
            const aData = aSnap.data()!;

            if ((iData.casino_credits || 0) < bet) throw new Error("Initiator broke");
            if ((aData.casino_credits || 0) < bet) throw new Error("Acceptor broke");

            const isInitiatorWin = Math.random() < 0.5;

            const pot = bet * 2;
            const tax = Math.floor(pot * 0.1);
            winAmount = pot - tax;

            if (isInitiatorWin) {
                winnerName = iData.username;
                loserName = aData.username;
                t.update(initiatorRef, {
                    casino_credits: (iData.casino_credits || 0) - bet + winAmount
                });
                t.update(acceptorRef, {
                    casino_credits: (aData.casino_credits || 0) - bet
                });
            } else {
                winnerName = aData.username;
                loserName = iData.username;
                t.update(acceptorRef, {
                    casino_credits: (aData.casino_credits || 0) - bet + winAmount
                });
                t.update(initiatorRef, {
                    casino_credits: (iData.casino_credits || 0) - bet
                });
            }
        });

        await ctx.reply(
            `⚔️ *ИТОГИ ДУЭЛИ:*\n\n` +
            `💀 Проигравший: ${loserName}\n` +
            `👑 Победитель: *${winnerName}*\n` +
            `💰 Куш: *${winAmount} PC* (Налог: 10%)`,
            { parse_mode: "Markdown" }
        );

    } catch (e: any) {
        console.error("[DUEL ERROR]:", e);
        if (e.message === "Initiator broke") {
            await ctx.reply("🚫 Дуэль отменена: У инициатора закончились деньги.");
        } else if (e.message === "Acceptor broke") {
            await ctx.reply(`🚫 @${ctx.from.username}, у вас недостаточно средств для принятия вызова!`);
        } else {
            await ctx.reply("Сбой системы. Дуэль аннулирована.");
        }
    }
});

console.log('[BOT] Game commands registered');

bot.command("warn", async (ctx) => {
    if (!(await isAdmin(ctx))) return;

    const replyMsg = (ctx.message as any).reply_to_message;
    if (!replyMsg) {
        await ctx.reply("⚠️ Ошибка: Эту команду нужно писать В ОТВЕТ (Reply) на сообщение нарушителя.");
        return;
    }

    const targetUser = replyMsg.from;

    if (!targetUser || targetUser.is_bot || TELEGRAM_SERVICE_IDS.includes(targetUser.id)) {
        await ctx.reply("❌ Нельзя выдать предупреждение этому пользователю (Бот/Система).");
        return;
    }

    if (await isTargetImmune(ctx, targetUser.id)) {
        await ctx.reply("⛔ Нельзя выдать варн администратору.");
        return;
    }

    const warnRef = db.collection('telegram_moderation').doc(String(targetUser.id));

    await db.runTransaction(async (t) => {
        const doc = await t.get(warnRef);
        let warns = (doc.exists ? doc.data()?.warns : 0) + 1;

        if (warns >= MAX_WARNS) {
            try {
                await ctx.banChatMember(targetUser.id);
                await ctx.reply(`🚫 [BAN] ${targetUser.first_name} был изгнан за превышение лимита предупреждений.`);
                t.delete(warnRef);
            } catch (e) {
                await ctx.reply("Ошибка при бане. Проверьте права бота.");
            }
        } else {
            t.set(warnRef, {
                warns: warns,
                lastWarnDate: admin.firestore.FieldValue.serverTimestamp(),
                username: targetUser.username || targetUser.first_name
            }, { merge: true });

            await ctx.reply(`⚠️ [WARN] Предупреждение [${warns}/${MAX_WARNS}] для ${targetUser.first_name}.`);
        }
    });
});

bot.command("unwarn", async (ctx) => {
    if (!(await isAdmin(ctx))) return;

    let targetId: number | null = null;
    let targetName = "Пользователя";

    const replyMsg = (ctx.message as any).reply_to_message;
    if (replyMsg) {
        targetId = replyMsg.from.id;
        targetName = replyMsg.from.first_name;
    } else {
        const args = ctx.message.text.split(' ');
        if (args.length > 1) {
            targetId = parseInt(args[1]);
            targetName = `ID ${targetId}`;
        }
    }

    if (!targetId || isNaN(targetId)) {
        await ctx.reply("ℹ️ Используйте: ответьте на сообщение ИЛИ напишите /unwarn ID");
        return;
    }

    const warnRef = db.collection('telegram_moderation').doc(String(targetId));

    try {
        await db.runTransaction(async (t) => {
            const doc = await t.get(warnRef);
            if (!doc.exists || !doc.data()?.warns) {
                throw new Error("No warns");
            }

            const newWarns = doc.data()!.warns - 1;

            if (newWarns <= 0) {
                t.delete(warnRef);
            } else {
                t.update(warnRef, { warns: newWarns });
            }
        });
        await ctx.reply(`✅ Одно предупреждение снято с ${targetName}.`);
    } catch (e: any) {
        if (e.message === "No warns") {
            await ctx.reply("ℹ️ У этого пользователя нет активных предупреждений.");
        } else {
            console.error("[UNWARN ERROR]:", e);
            await ctx.reply("Ошибка базы данных.");
        }
    }
});

bot.command("ban", async (ctx) => {
    if (!(await isAdmin(ctx))) return;

    const replyMsg = (ctx.message as any).reply_to_message;
    if (!replyMsg) {
        await ctx.reply("⚠️ Ошибка: Чтобы забанить, ответьте на сообщение пользователя командой /ban.");
        return;
    }

    const targetUser = replyMsg.from;

    if (!targetUser || TELEGRAM_SERVICE_IDS.includes(targetUser.id)) {
        await ctx.reply("❌ Нельзя забанить системного бота или анонимного администратора.");
        return;
    }

    if (await isTargetImmune(ctx, targetUser.id)) {
        await ctx.reply("Ты еблан?");
        return;
    }

    try {
        await ctx.banChatMember(targetUser.id);
        await ctx.reply(`🔨 [BANHAMMER] ${targetUser.first_name} отправлен в /dev/null.`);
    } catch (e) {
        await ctx.reply("Не удалось забанить. Возможно, у меня нет прав.");
    }
});

bot.command("mute", async (ctx) => {
    if (!(await isAdmin(ctx))) return;

    const replyMsg = (ctx.message as any).reply_to_message;
    if (!replyMsg) {
        await ctx.reply("⚠️ Используйте ответ на сообщение: /mute 10m, /mute 2h");
        return;
    }

    const args = (ctx.message as any).text.split(' ');
    const timeStr = args[1];

    if (!timeStr) {
        await ctx.reply("⚠️ Укажите время: 10m (минуты), 2h (часы), 1d (дни).");
        return;
    }

    const seconds = parseTime(timeStr);
    if (seconds === 0) {
        await ctx.reply("❌ Неверный формат времени.");
        return;
    }

    const targetUser = replyMsg.from;
    if (await isTargetImmune(ctx, targetUser.id)) {
        await ctx.reply("Ты еблан?");
        return;
    }

    const untilDate = Math.floor(Date.now() / 1000) + seconds;

    try {
        await ctx.restrictChatMember(targetUser.id, {
            until_date: untilDate,
            permissions: {
                can_send_messages: false,
                can_send_audios: false,
                can_send_documents: false,
                can_send_photos: false,
                can_send_videos: false,
                can_send_other_messages: false,
                can_add_web_page_previews: false
            }
        });
        await ctx.reply(`🔇 ${targetUser.first_name} обеззвучен на ${timeStr}.`);
    } catch (e) {
        await ctx.reply("Ошибка мута. Возможно, время слишком короткое (<30 сек) или у меня нет прав.");
    }
});

bot.command("unmute", async (ctx) => {
    if (!(await isAdmin(ctx))) return;

    const replyMsg = (ctx.message as any).reply_to_message;
    if (!replyMsg) {
        await ctx.reply("⚠️ Ответьте на сообщение пользователя: /unmute");
        return;
    }

    const targetUser = replyMsg.from;

    try {
        await ctx.restrictChatMember(targetUser.id, {
            permissions: {
                can_send_messages: true,
                can_send_audios: true,
                can_send_documents: true,
                can_send_photos: true,
                can_send_videos: true,
                can_send_other_messages: true,
                can_add_web_page_previews: true,
                can_invite_users: true
            }
        });
        await ctx.reply(`🔊 ${targetUser.first_name} снова может говорить.`);
    } catch (e) {
        await ctx.reply("Ошибка размута.");
    }
});

bot.command("unban", async (ctx) => {
    if (!(await isAdmin(ctx))) return;

    let targetId: number | null = null;
    const replyMsg = (ctx.message as any).reply_to_message;

    if (replyMsg) {
        targetId = replyMsg.from.id;
    } else {
        const args = (ctx.message as any).text.split(' ');
        if (args.length > 1) {
            targetId = parseInt(args[1]);
        }
    }

    if (!targetId || isNaN(targetId)) {
        await ctx.reply("ℹ️ Использование:\n• В ответ на сообщение: /unban\n• По ID: /unban 12345678");
        return;
    }

    if (TELEGRAM_SERVICE_IDS.includes(targetId)) {
        await ctx.reply("🗿 Этого пользователя нельзя разбанить.");
        return;
    }

    try {
        await ctx.unbanChatMember(targetId, { only_if_banned: true });
        await ctx.reply(`✅ Пользователь ${targetId} разбанен. Сброс варнов...`);
        await db.collection('telegram_moderation').doc(String(targetId)).delete();
    } catch (e) {
        await ctx.reply("Ошибка разбана. Проверьте ID.");
    }
});

bot.command("lockdown", async (ctx) => {
    if (!(await isAdmin(ctx))) return;

    const args = (ctx.message as any).text.split(' ');
    const mode = args[1]?.toLowerCase();

    if (mode === 'on') {
        await SETTINGS_DOC_REF.set({ lockdown: true }, { merge: true });
        await ctx.reply("🚨 ВНИМАНИЕ: РЕЖИМ КАРАНТИНА АКТИВИРОВАН. Все новые участники будут автоматически заблокированы.");
    } else if (mode === 'off') {
        await SETTINGS_DOC_REF.set({ lockdown: false }, { merge: true });
        await ctx.reply("🟢 Режим карантина отключен. Вход свободный (через капчу).");
    } else {
        const currentSnap = await SETTINGS_DOC_REF.get();
        const status = currentSnap.data()?.lockdown ? "🔴 ВКЛЮЧЕН" : "🟢 ВЫКЛЮЧЕН";
        await ctx.reply(`Текущий статус LockDown: ${status}\nИспользуйте: /lockdown on или /lockdown off`);
    }
});

console.log('[BOT] Admin commands registered');

bot.on("new_chat_members", async (ctx, next) => {
    try {
        const settingsSnap = await SETTINGS_DOC_REF.get();
        const isLockdown = settingsSnap.exists ? settingsSnap.data()?.lockdown : false;

        if (isLockdown) {
            for (const member of ctx.message.new_chat_members) {
                try {
                    await ctx.banChatMember(member.id);
                    await ctx.deleteMessage();
                } catch (e) {
                    console.error(`[LOCKDOWN] Failed to autoban ${member.id}`, e);
                }
            }
            return;
        }
    } catch (e) {
        console.error("[LOCKDOWN] Check error:", e);
    }
    return next();
});

bot.on("new_chat_members", async (ctx) => {
    try {
        for (const member of ctx.message.new_chat_members) {
            if (member.is_bot) continue;

            await ctx.restrictChatMember(member.id, {
                permissions: {
                    can_send_messages: false,
                    can_send_audios: false,
                    can_send_documents: false,
                    can_send_photos: false,
                    can_send_videos: false,
                    can_send_other_messages: false,
                    can_add_web_page_previews: false
                }
            });

            await ctx.reply(
                `🤖 ЗАЩИТА ПЕРИМЕТРА\n\nПривет, [${member.first_name}](tg://user?id=${member.id})!\nНажми кнопку, чтобы подтвердить статус.`,
                {
                    parse_mode: "Markdown",
                    ...Markup.inlineKeyboard([
                        Markup.button.callback("✅ Я НЕ БОТ", `verify_${member.id}`)
                    ])
                }
            );
        }
    } catch (e) {
        console.error("[CAPTCHA ERROR]:", e);
    }
});

bot.action(/verify_(\d+)/, async (ctx) => {
    const userId = parseInt(ctx.match[1]);

    if (ctx.from.id !== userId) {
        await ctx.answerCbQuery("Это не твоя кнопка! 🚫");
        return;
    }

    try {
        await ctx.restrictChatMember(userId, {
            permissions: {
                can_send_messages: true,
                can_send_audios: true,
                can_send_documents: true,
                can_send_photos: true,
                can_send_videos: true,
                can_send_other_messages: true,
                can_add_web_page_previews: true,
                can_invite_users: true
            }
        });

        await ctx.answerCbQuery("Доступ разрешен! 🔓");
        try {
            await ctx.deleteMessage();
        } catch (e) {}
        await ctx.reply(`Добро пожаловать в Сеть, ${ctx.from.first_name}!`);
    } catch (e) {
        console.error("[VERIFICATION ERROR]:", e);
    }
});

console.log('[BOT] Anti-raid system registered');

bot.on('text', async (ctx) => {
    const text = ctx.message.text;

    if (text.startsWith('/')) {
        return;
    }

    await checkTriggers(ctx, text);
});

console.log('[BOT] Text middleware registered');

bot.on('sticker', async (ctx) => {
    const random = Math.random();

    if (random < 0.05) {
        const responses = ['🗿', '> Интересный стикер.', '👀', '🤔', '> *[АНАЛИЗИРУЮ]*', 'Based.'];
        const response = responses[Math.floor(Math.random() * responses.length)];
        await ctx.reply(response, { parse_mode: 'Markdown' });
    }
});

console.log('[BOT] Sticker handler registered');
console.log('[BOT] ✅ All handlers registered successfully!');

export const telegramWebhook = onRequest(
    { secrets: ["TELEGRAM_BOT_TOKEN"] },
    async (request, response) => {
        const token = process.env.TELEGRAM_BOT_TOKEN;

        if (!token) {
            console.error('[WEBHOOK] ❌ No bot token!');
            response.status(500).send("No Token");
            return;
        }

        try {
            console.log('[WEBHOOK] 📥 Processing update...');
            await bot.handleUpdate(request.body, response);
            console.log('[WEBHOOK] ✅ Update processed');
        } catch (e) {
            console.error("[WEBHOOK] ❌ Error:", e);
            response.status(200).send("Error handled");
        }
    }
);
</file>

<file path="src/hooks.server.ts">
import { authAdmin, firestoreAdmin } from '$lib/server/firebase.admin';
import type { Handle } from '@sveltejs/kit';

export const handle: Handle = async ({ event, resolve }) => {
    const sessionCookie = event.cookies.get('__session');

    // 1. Нет куки — аноним
    if (!sessionCookie) {
        event.locals.user = null;
        return resolve(event);
    }

    try {
        // 2. Жесткая проверка токена.
        // Если токен отозван (Revoked) — это сразу Error.
        // Мы НЕ ловим ошибку, чтобы "спасти" зомби. Пусть умирает.
        const decodedClaims = await authAdmin.verifySessionCookie(sessionCookie, true);

        // 3. Получаем данные из БД (Source of Truth)
        const userDocRef = firestoreAdmin.collection('users').doc(decodedClaims.uid);
        const userDocSnap = await userDocRef.get();
        const userData = userDocSnap.data();

        // 4. Определение статуса бана
        // Бан есть, если он есть в БД ИЛИ если он "выжжен" в токене
        const isBanned = (userData?.isBanned === true) || (decodedClaims.banned === true);

        // === БЛОКИРОВКА ===
        if (isBanned) {
            // Если юзер забанен, но токен все еще валиден (не отозван)
            // Мы просто держим его на странице /banned
            if (!event.url.pathname.startsWith('/banned')) {
                return new Response('Redirect', { status: 303, headers: { Location: '/banned' } });
            }
        }
        // === ОБЫЧНЫЙ ЮЗЕР ===
        else {
            // Если НЕ забанен, но зашел на /banned — выгоняем на главную
            if (event.url.pathname.startsWith('/banned')) {
                return new Response('Redirect', { status: 303, headers: { Location: '/' } });
            }
        }

        // Заполняем сессию
        if (userData) {
            event.locals.user = {
                uid: decodedClaims.uid,
                email: decodedClaims.email,
                username: userData.username || 'Unknown',
                emailVerified: decodedClaims.email_verified || false,
                isBanned: isBanned
            };
        } else {
            event.locals.user = null; // Токен есть, юзера в базе нет
        }

    } catch (e: any) {
        // 5. ОБРАБОТКА ОШИБОК (Включая Revoked Token)
        // Если мы здесь — токен невалиден (истек, подделка или ОТОЗВАН админом).
        // Единственное правильное действие — убить сессию.

        console.log("Auth Hook: Invalid/Revoked Token. Destroying session.");

        // Удаляем куку с параметрами (важно для надежности)
        event.cookies.delete('__session', { path: '/' });

        // На всякий случай чистим locals
        event.locals.user = null;

        // Если это API-запрос — 401
        if (event.url.pathname.startsWith('/api')) {
             return new Response(JSON.stringify({ error: 'Session expired' }), { status: 401 });
        }

        // Если юзер уже на логине — пусть там и остается
        if (event.url.pathname === '/login' || event.url.pathname === '/register') {
            return resolve(event);
        }

        // Иначе — редирект на вход
        return new Response('Redirect', { status: 303, headers: { Location: '/login' } });
    }

    return resolve(event);
};
</file>

<file path="src/lib/stores.ts">
import { writable, type Writable } from 'svelte/store';
import { auth } from '$lib/firebase';
import { onAuthStateChanged, type User } from 'firebase/auth';
import { browser } from '$app/environment';
import { doc, getDoc } from 'firebase/firestore';
import { db } from '$lib/firebase';

export type UserProfile = {
    uid: string;
    username: string;
    email: string | null;
    emailVerified: boolean;
    avatar_url: string;
    social_link: string;
    about_me: string;
    status?: string;
    casino_credits: number;
    last_daily_bonus: Date | null;
    daily_streak: number;        // Серия входов
    owned_items: string[];
    equipped_frame: string | null;
    equipped_badge: string | null;
    equipped_bg: string | null;  // Фон профиля
    blocked_uids: string[];      // Черный список
};

type AuthStore = {
    user: UserProfile | null;
    loading: boolean;
};

export const userStore: Writable<AuthStore> = writable({
    user: null,
    loading: true,
});

onAuthStateChanged(auth, async (userAuth: User | null) => {
    let userProfile: UserProfile | null = null;
    let token: string | null = null;

    if (userAuth) {
        try {
            // Принудительно обновляем статус (например, emailVerified)
            await userAuth.reload();
            token = await userAuth.getIdToken(true);

            const docRef = doc(db, "users", userAuth.uid);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                userProfile = {
                    uid: userAuth.uid,
                    username: data.username,
                    email: userAuth.email,
                    emailVerified: userAuth.emailVerified,
                    avatar_url: data.avatar_url || '',
                    social_link: data.social_link || '',
                    about_me: data.about_me || '',
                    status: data.status || '',
                    casino_credits: data.casino_credits ?? 100,
                    last_daily_bonus: data.last_daily_bonus ? data.last_daily_bonus.toDate() : null,
                    daily_streak: data.daily_streak || 0,
                    owned_items: data.owned_items || [],
                    equipped_frame: data.equipped_frame || null,
                    equipped_badge: data.equipped_badge || null,
                    equipped_bg: data.equipped_bg || null,
                    blocked_uids: data.blocked_uids || []
                };
            }
        } catch (e) {
            console.error("Ошибка обновления профиля:", e);
        }
    }

    // Синхронизация сессии с сервером SvelteKit (cookies)
    if (browser) {
        try {
            await fetch('/api/auth', {
                method: token ? 'POST' : 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: token ? JSON.stringify({ idToken: token }) : undefined,
            });
        } catch (e) {
            console.error("Сбой fetch:", e);
        }
    }

    userStore.set({ user: userProfile, loading: false });
});

// --- CHAT STORE ---

type ChatState = {
    isOpen: boolean;
    hasUnread: boolean; // Флаг непрочитанных сообщений
};

function createChatStore() {
    const { subscribe, update, set } = writable<ChatState>({
        isOpen: false,
        hasUnread: false
    });

    return {
        subscribe,
        toggle: () => update(state => ({ ...state, isOpen: !state.isOpen })),
        open: () => update(state => ({ ...state, isOpen: true, hasUnread: false })), // При открытии сбрасываем уведомление
        close: () => update(state => ({ ...state, isOpen: false })),
        setUnread: (val: boolean) => update(state => ({ ...state, hasUnread: val }))
    };
}

export const chat = createChatStore();
</file>

<file path="src/lib/utils/markdown.ts">
import { marked } from 'marked';

export function renderMarkdown(text: string | null | undefined): string {
    if (!text) return '';

    try {
        const html = marked.parse(text, {
            breaks: true,
            gfm: true,
            silent: true
        }) as string;

        if (typeof document !== 'undefined') {
            return sanitizeWithDOM(html);
        } else {
            return sanitizeServerSide(html);
        }
    } catch (error) {
        console.error('[Markdown] Error:', error);
        return escapeHtml(text);
    }
}

function sanitizeWithDOM(html: string): string {
    const template = document.createElement('template');
    template.innerHTML = html;

    const allowedTags = new Set([
        'P', 'BR', 'STRONG', 'B', 'EM', 'I', 'S', 'DEL',
        'A', 'CODE', 'PRE', 'BLOCKQUOTE',
        'UL', 'OL', 'LI',
        'H1', 'H2', 'H3', 'H4', 'H5', 'H6',
        'TABLE', 'THEAD', 'TBODY', 'TR', 'TH', 'TD',
        'HR', 'IMG'
    ]);

    const allowedAttrs = new Set(['href', 'src', 'alt', 'title', 'width', 'height']);

    function clean(node: Node): Node | null {
        if (node.nodeType === Node.TEXT_NODE) {
            return node.cloneNode(true);
        }

        if (node.nodeType === Node.ELEMENT_NODE) {
            const el = node as Element;

            if (!allowedTags.has(el.tagName)) {
                const frag = document.createDocumentFragment();
                Array.from(el.childNodes).forEach(child => {
                    const cleaned = clean(child);
                    if (cleaned) frag.appendChild(cleaned);
                });
                return frag;
            }

            const newEl = el.cloneNode(false) as Element;

            Array.from(el.attributes).forEach(attr => {
                if (allowedAttrs.has(attr.name)) {
                    if (attr.name === 'href' || attr.name === 'src') {
                        const url = attr.value.toLowerCase();
                        if (!url.includes('javascript:') &&
                            !url.includes('data:text') &&
                            !url.includes('vbscript:')) {
                            newEl.setAttribute(attr.name, attr.value);
                        }
                    } else {
                        newEl.setAttribute(attr.name, attr.value);
                    }
                }
            });

            if (newEl.tagName === 'A' && newEl.hasAttribute('href')) {
                newEl.setAttribute('rel', 'noopener noreferrer');
                const href = newEl.getAttribute('href') || '';
                if (href.match(/^https?:\/\//)) {
                    newEl.setAttribute('target', '_blank');
                }
            }

            Array.from(el.childNodes).forEach(child => {
                const cleaned = clean(child);
                if (cleaned) newEl.appendChild(cleaned);
            });

            return newEl;
        }

        return null;
    }

    const div = document.createElement('div');
    Array.from(template.content.childNodes).forEach(child => {
        const cleaned = clean(child);
        if (cleaned) div.appendChild(cleaned);
    });

    return div.innerHTML;
}

function sanitizeServerSide(html: string): string {
    const allowedTags = new Set([
        'p', 'br', 'strong', 'b', 'em', 'i', 's', 'del',
        'a', 'code', 'pre', 'blockquote',
        'ul', 'ol', 'li',
        'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
        'table', 'thead', 'tbody', 'tr', 'th', 'td',
        'hr', 'img'
    ]);

    let result = '';
    let inTag = false;
    let tagStart = -1;

    for (let i = 0; i < html.length; i++) {
        const char = html[i];

        if (char === '<') {
            inTag = true;
            tagStart = i;
        } else if (char === '>' && inTag) {
            inTag = false;

            const fullTag = html.substring(tagStart, i + 1);
            const isClosing = fullTag.startsWith('</');
            const tagMatch = fullTag.match(/^<\/?([a-z][a-z0-9]*)/i);

            if (tagMatch) {
                const tagName = tagMatch[1].toLowerCase();

                if (allowedTags.has(tagName)) {
                    if (isClosing) {
                        result += `</${tagName}>`;
                    } else {
                        result += cleanTag(fullTag, tagName);
                    }
                }
            }
        } else if (!inTag) {
            result += char;
        }
    }

    return result;
}

function cleanTag(tagHtml: string, tagName: string): string {
    if (tagName === 'a') {
        const hrefMatch = tagHtml.match(/href\s*=\s*["']([^"']+)["']/i);
        if (hrefMatch && isSafeUrl(hrefMatch[1])) {
            const href = escapeAttr(hrefMatch[1]);
            const isExternal = hrefMatch[1].match(/^https?:\/\//);
            const target = isExternal ? ' target="_blank"' : '';
            return `<a href="${href}"${target} rel="noopener noreferrer">`;
        }
        return '<a>';
    }

    if (tagName === 'img') {
        const srcMatch = tagHtml.match(/src\s*=\s*["']([^"']+)["']/i);
        const altMatch = tagHtml.match(/alt\s*=\s*["']([^"']*)["']/i);
        if (srcMatch && isSafeUrl(srcMatch[1])) {
            const src = escapeAttr(srcMatch[1]);
            const alt = altMatch ? escapeAttr(altMatch[1]) : '';
            return `<img src="${src}" alt="${alt}">`;
        }
        return '';
    }

    return `<${tagName}>`;
}

function isSafeUrl(url: string): boolean {
    const lower = url.toLowerCase().trim();

    if (lower.includes('javascript:') ||
        lower.includes('data:text') ||
        lower.includes('vbscript:') ||
        lower.includes('file:')) {
        return false;
    }

    return /^(https?:\/\/|mailto:|tel:|\/)/i.test(url);
}

function escapeAttr(value: string): string {
    return value
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
}

function escapeHtml(text: string): string {
    return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}
</file>

<file path="package.json">
{
	"name": "protomap-new",
	"private": true,
	"version": "0.0.1",
	"type": "module",
	"scripts": {
		"dev": "vite dev",
		"build": "vite build",
		"preview": "vite preview",
		"prepare": "svelte-kit sync || echo ''",
		"check": "svelte-kit sync && svelte-check --tsconfig ./tsconfig.json",
		"check:watch": "svelte-kit sync && svelte-check --tsconfig ./tsconfig.json --watch",
		"format": "prettier --write .",
		"lint": "prettier --check . && eslint ."
	},
	"devDependencies": {
		"@eslint/compat": "^1.2.5",
		"@eslint/js": "^9.29.0",
		"@sveltejs/adapter-auto": "^6.0.0",
		"@sveltejs/adapter-vercel": "^5.7.2",
		"@sveltejs/kit": "^2.21.5",
		"@sveltejs/vite-plugin-svelte": "^5.0.0",
		"@types/dompurify": "^3.0.5",
		"@types/howler": "^2.2.12",
		"@types/leaflet": "^1.9.18",
		"@types/leaflet.markercluster": "^1.5.5",
		"@types/three": "^0.180.0",
		"autoprefixer": "^10.4.20",
		"eslint": "^9.29.0",
		"eslint-config-prettier": "^10.0.1",
		"eslint-plugin-svelte": "^3.0.0",
		"globals": "^16.0.0",
		"prettier": "^3.4.2",
		"prettier-plugin-svelte": "^3.3.3",
		"prettier-plugin-tailwindcss": "^0.6.5",
		"svelte": "^5.34.3",
		"svelte-check": "^4.0.0",
		"tailwindcss": "^3.4.9",
		"typescript": "^5.0.0",
		"typescript-eslint": "^8.20.0",
		"vite": "^6.2.6"
	},
	"dependencies": {
		"@vercel/analytics": "^1.5.0",
		"@vercel/og": "^0.8.6",
		"dompurify": "^3.3.1",
		"firebase": "^11.9.0",
		"firebase-admin": "^13.5.0",
		"firebase-functions": "^6.4.0",
		"howler": "^2.2.4",
		"leaflet": "^1.9.4",
		"leaflet.markercluster": "^1.5.3",
		"marked": "^17.0.1",
		"node-fetch": "^2.7.0",
		"pixi.js": "^8.10.1",
		"svelte-i18n": "^4.0.1",
		"svelte-icons": "^2.1.0",
		"three": "^0.180.0"
	}
}
</file>

<file path="src/lib/components/ChatWidget.svelte">
<script lang="ts">
    import { onMount, tick } from 'svelte';
    import { db } from '$lib/firebase';
    import { collection, query, orderBy, limit, onSnapshot, where, type Unsubscribe, type Timestamp } from 'firebase/firestore';
    import { getFunctions, httpsCallable } from 'firebase/functions';
    import { userStore, chat } from '$lib/stores';
    import { modal } from '$lib/stores/modalStore';
    import { AudioManager } from '$lib/client/audioManager';
    import { t, locale } from 'svelte-i18n';
    import { get } from 'svelte/store';
    // [ЭТАП 6] Кэш никнеймов
    import { usernameCache, getUsername, getAvatarUrl } from '$lib/stores/usernameCache';

    type ReplyInfo = {
        author_username: string;
        text: string;
    };

    type ChatMessage = {
        id: string;
        text: string;
        author_uid: string;
        author_username: string;
        author_avatar_url: string;
        createdAt: Date;
        replyTo?: ReplyInfo;
        image?: boolean;
        voiceMessage?: boolean;
        replyToImage?: boolean;
        replyToVoiceMessage?: boolean;
        author_equipped_frame?: string | null;
        lang?: string;
    };

    let messages: ChatMessage[] = [];
    let isLoading = true;
    let isLoadingMore = false;
    let unsubscribe: Unsubscribe | null = null;
    let messagesWindow: HTMLDivElement;

    let messageText = '';
    let isSending = false;
    let canSendMessage = true;
    const cooldownSeconds = 3;
    let replyingTo: any = null;
    let inputElement: HTMLTextAreaElement;

    let messagesLimit = 20;
    let chatLang = 'ru';
    let reachedEnd = false;
    let lastReadTime = 0;

    onMount(() => {
        const stored = localStorage.getItem('protomap_last_read_chat');
        if (stored) lastReadTime = parseInt(stored, 10);
        else lastReadTime = Date.now();

        const unsubscribeLocale = locale.subscribe(val => {
             if (val) {
                 chatLang = val.substring(0, 2);
                 initChatSubscription(chatLang);
             }
        });

        return () => {
            if (unsubscribe) unsubscribe();
            unsubscribeLocale();
        };
    });

    $: if ($chat.isOpen) {
        tick().then(() => scrollToTarget());
        chat.setUnread(false);
    }

    function switchChatLang(lang: string) {
        if (chatLang === lang) return;
        chatLang = lang;
        messagesLimit = 20;
        reachedEnd = false;
        initChatSubscription(chatLang);
    }

    function loadMore() {
        if (isLoadingMore || reachedEnd) return;
        isLoadingMore = true;
        messagesLimit += 20;
        initChatSubscription(chatLang);
    }

    function initChatSubscription(lang: string) {
        if (unsubscribe) unsubscribe();
        isLoading = true;

        const q = query(
            collection(db, "global_chat"),
            where("lang", "==", lang),
            orderBy("createdAt", "desc"),
            limit(messagesLimit)
        );

        unsubscribe = onSnapshot(q, async (querySnapshot) => {
            const newMessages = querySnapshot.docs.map(doc => {
                const data = doc.data();
                return {
                    id: doc.id,
                    text: data.text || '',
                    author_uid: data.author_uid || '',
                    author_username: data.author_username || 'unknown',
                    author_avatar_url: data.author_avatar_url || '',
                    createdAt: (data.createdAt as Timestamp)?.toDate() || new Date(),
                    replyTo: data.replyTo,
                    image: data.image || false,
                    voiceMessage: data.voiceMessage || false,
                    replyToImage: data.replyToImage || false,
                    replyToVoiceMessage: data.replyToVoiceMessage || false,
                    author_equipped_frame: data.author_equipped_frame || null
                };
            }).filter(msg => msg.createdAt).reverse();

            if (newMessages.length < messagesLimit) reachedEnd = true;

            if (newMessages.length > 0) {
                const lastMsg = newMessages[newMessages.length - 1];
                if (!$chat.isOpen && lastMsg.createdAt.getTime() > lastReadTime) {
                    chat.setUnread(true);
                    AudioManager.play('message');
                }
            }

            const wasLoading = isLoading;
            messages = newMessages;
            isLoading = false;
            isLoadingMore = false;

            await tick();
            if (wasLoading && $chat.isOpen) scrollToTarget();
        }, (error) => {
            console.error(error);
            isLoading = false;
            isLoadingMore = false;
        });
    }

    function scrollToTarget() {
        if (!messagesWindow) return;
        const unreadMarker = document.getElementById('unread-marker');
        if (unreadMarker) unreadMarker.scrollIntoView({ block: 'center', behavior: 'auto' });
        else messagesWindow.scrollTop = messagesWindow.scrollHeight;
    }

    async function sendMessage() {
        if (isSending || !canSendMessage || !messageText.trim()) return;
        const currentUser = $userStore.user;
        if (!currentUser) { modal.error(get(t)('ui.error'), get(t)('chat.login_req')); return; }

        isSending = true;
        canSendMessage = false;
        try {
            const functions = getFunctions();
            await httpsCallable(functions, 'sendMessage')({
                text: messageText.trim(),
                replyTo: replyingTo ? { author_username: replyingTo.author_username, text: replyingTo.text } : null,
                lang: chatLang
            });
            AudioManager.play('message');
            messageText = '';
            replyingTo = null;
            lastReadTime = Date.now();
            localStorage.setItem('protomap_last_read_chat', lastReadTime.toString());
            setTimeout(() => { canSendMessage = true; }, cooldownSeconds * 1000);
            await tick();
            if (messagesWindow) messagesWindow.scrollTop = messagesWindow.scrollHeight;
        } catch (e) {
            canSendMessage = true;
        } finally {
            isSending = false;
        }
    }

    function handleKeydown(event: KeyboardEvent) {
        if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }
    }

    function setReplyTo(message: ChatMessage) {
        let quoteText = message.text;
        let isMedia = false;
        if (message.image) { quoteText = '[Изображение]'; isMedia = true; }
        else if (message.voiceMessage) { quoteText = '[Голосовое сообщение]'; isMedia = true; }
        replyingTo = { id: message.id, author_username: message.author_username, text: quoteText, isMedia };
        inputElement?.focus();
    }

    function isSameDay(date1: Date, date2: Date): boolean {
        if (!date1 || !date2) return false;
        return date1.getFullYear() === date2.getFullYear() &&
               date1.getMonth() === date2.getMonth() &&
               date1.getDate() === date2.getDate();
    }

    function formatDateSeparator(date: Date): string {
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        if (isSameDay(date, today)) return get(t)('profile.time.today');
        if (isSameDay(date, yesterday)) return get(t)('profile.time.yesterday');
        return date.toLocaleDateString(get(locale), { day: 'numeric', month: 'long' });
    }

    function closeChat() {
        lastReadTime = Date.now();
        localStorage.setItem('protomap_last_read_chat', lastReadTime.toString());
        chat.close();
        AudioManager.play('popup_close');
    }
</script>

<div class="chat-widget" class:open={$chat.isOpen}>
    <div class="widget-header">
        <div class="flex items-center gap-3">
            <h3 class="font-display text-xs sm:text-sm">// {$t('chat.title')}</h3>
            <div class="chat-lang-toggle">
                <button class:active={chatLang === 'ru'} on:click={() => switchChatLang('ru')}>RU</button>
                <button class:active={chatLang === 'en'} on:click={() => switchChatLang('en')}>EN</button>
            </div>
        </div>
        <button on:click={closeChat} class="close-btn">&times;</button>
    </div>

    <div class="messages-window" bind:this={messagesWindow}>
        {#if isLoading && !isLoadingMore}
            <p class="status-text animate-pulse">{$t('ui.loading')}</p>
        {:else}
            {#if !reachedEnd && messages.length >= 20}
                <button class="load-more-btn" on:click={loadMore} disabled={isLoadingMore}>
                    {isLoadingMore ? "..." : $t('chat.load_more')}
                </button>
            {:else if messages.length > 0}
                <p class="reached-end-text">{$t('chat.no_more')}</p>
            {/if}

            {#if messages.length === 0}
                <div class="empty-chat"><p class="status-text">{$t('chat.empty')}</p></div>
            {:else}
                {#each messages as msg, i (msg.id)}
                    {@const prevMsg = messages[i - 1]}
                    {@const isUnread = msg.createdAt.getTime() > lastReadTime}
                    {@const isFirstUnread = isUnread && (i === 0 || messages[i - 1].createdAt.getTime() <= lastReadTime)}

                    <!-- [ЭТАП 6] Реактивно берём актуальный никнейм/аватар из кэша.
                         $usernameCache — реактивный стор, при обновлении кэша Svelte
                         перерисует только эту строку, не весь список. -->
                    {@const displayName = msg.author_uid
                        ? getUsername($usernameCache, msg.author_uid, msg.author_username)
                        : msg.author_username}
                    {@const displayAvatar = msg.author_uid
                        ? getAvatarUrl($usernameCache, msg.author_uid, msg.author_avatar_url)
                        : msg.author_avatar_url}

                    {#if i === 0 || !isSameDay(msg.createdAt, prevMsg.createdAt)}
                        <div class="date-separator"><span>{formatDateSeparator(msg.createdAt)}</span></div>
                    {/if}

                    {#if isFirstUnread}
                        <div class="unread-separator" id="unread-marker">
                            <span class="line"></span>
                            <span class="text">NEW SIGNALS</span>
                            <span class="line"></span>
                        </div>
                    {/if}

                    <div class="message-card" class:own-message={msg.author_uid === $userStore.user?.uid}>
                        <a href={msg.author_uid ? `/u/${msg.author_uid}` : `/profile/${msg.author_username}`} class="shrink-0">
                            <div class="avatar-container comment-avatar-wrapper {msg.author_equipped_frame || ''}">
                                <img
                                    src={displayAvatar || `https://api.dicebear.com/7.x/bottts-neutral/svg?seed=${msg.author_username}`}
                                    alt={displayName}
                                    class="message-avatar"
                                />
                            </div>
                        </a>

                        <div class="message-content-wrapper">
                            <a href={msg.author_uid ? `/u/${msg.author_uid}` : `/profile/${msg.author_username}`} class="message-author">
                                {displayName}
                            </a>
                            <div class="message-body">
                                {#if msg.replyTo}
                                    <div class="reply-quote">
                                        <strong>{msg.replyTo.author_username}:</strong>
                                        {#if msg.replyToImage}<span class="text-cyber-cyan italic">[Изображение]</span>
                                        {:else if msg.replyToVoiceMessage}<span class="text-cyber-yellow italic">[Голосовое]</span>
                                        {:else}{msg.replyTo.text}{/if}
                                    </div>
                                {/if}

                                {#if msg.image}
                                    <div class="mobile-exclusive image">
                                        <div class="icon">🖼️</div>
                                        <div class="info"><span class="title">ИЗОБРАЖЕНИЕ</span><span class="subtitle">Доступно в приложении</span></div>
                                    </div>
                                {:else if msg.voiceMessage}
                                    <div class="mobile-exclusive voice">
                                        <div class="icon">🎙️</div>
                                        <div class="info"><span class="title">ГОЛОСОВОЕ</span><span class="subtitle">Доступно в приложении</span></div>
                                    </div>
                                {:else}
                                    <p class="message-text">{msg.text}</p>
                                {/if}
                                <span class="message-time-inline">{msg.createdAt.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                            </div>

                            <div class="message-meta">
                                {#if $userStore.user}
                                    <button on:click={() => setReplyTo(msg)} class="action-btn">{$t('chat.reply')}</button>
                                {/if}
                            </div>
                        </div>
                    </div>
                {/each}
            {/if}
        {/if}
    </div>

    <div class="message-input-area">
        {#if $userStore.user}
            <div class="input-wrapper">
                {#if replyingTo}
                    <div class="replying-to-banner">
                        <span>Ответ на: <span class="font-bold">{replyingTo.author_username}</span></span>
                        <button on:click={() => replyingTo = null}>&times;</button>
                    </div>
                {/if}
                <textarea
                    bind:this={inputElement}
                    bind:value={messageText}
                    on:keydown={handleKeydown}
                    maxlength="1000"
                    disabled={isSending || !canSendMessage}
                    placeholder={!canSendMessage ? $t('chat.wait') : $t('chat.placeholder')}
                    class="input-field"
                ></textarea>
            </div>
            <button on:click={sendMessage} disabled={isSending || !canSendMessage || !messageText.trim()} class="send-button">
                {#if isSending}
                     <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                {:else}
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" /></svg>
                {/if}
            </button>
        {:else}
            <p class="w-full text-center text-gray-400 text-sm"><a href="/login" class="text-cyber-yellow hover:underline">{$t('chat.login_req')}</a></p>
        {/if}
    </div>
</div>

<style>
    .chat-widget { position: fixed; bottom: 4rem; right: 1rem; z-index: 40; width: calc(100vw - 2rem); height: 75vh; max-width: 420px; max-height: 650px; background: rgba(5, 8, 12, 0.95); backdrop-filter: blur(12px); border: 1px solid #30363d; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); clip-path: polygon(0 10px, 10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%); transform: translateX(120%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; }
    .chat-widget.open { transform: translateX(0); }
    .widget-header { @apply flex justify-between items-center p-3 border-b border-gray-700/50 shrink-0; }
    .widget-header h3 { @apply text-cyber-yellow uppercase tracking-widest; }
    .close-btn { @apply text-3xl text-gray-400 hover:text-white leading-none p-1; transition: transform 0.2s; }
    .close-btn:hover { transform: rotate(90deg); }
    .messages-window { @apply flex-grow p-4 overflow-y-auto flex flex-col; overflow-x: hidden; scrollbar-width: thin; scrollbar-color: var(--cyber-yellow) transparent; }
    .status-text { @apply m-auto text-center text-gray-500 font-mono text-sm uppercase; }
    .message-card { @apply flex items-start gap-3 w-full mb-4; }
    .own-message { @apply flex-row-reverse; }
    .avatar-container { position: relative; width: 40px; height: 40px; flex-shrink: 0; margin-top: 4px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
    .message-avatar { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: none !important; }
    .message-content-wrapper { @apply flex flex-col max-w-[85%] sm:max-w-[75%]; }
    .own-message .message-content-wrapper { @apply items-end; }
    .message-author { @apply font-bold text-white text-sm hover:underline mb-1 px-2; }
    .own-message .message-author { @apply text-cyber-yellow; }
    .message-body { @apply relative p-3 rounded-md; background: rgba(31, 41, 55, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); padding-bottom: 1.75rem; }
    .reply-quote { @apply block text-xs mb-2 border-l-2 pl-2 truncate; border-color: rgba(255, 255, 255, 0.3); color: rgba(255, 255, 255, 0.5); max-width: 200px; }
    .message-text { @apply text-gray-200 whitespace-pre-wrap break-words; max-height: 300px; overflow-y: auto; }
    .message-meta { @apply flex items-center justify-end gap-3 mt-2 text-xs text-gray-500; }
    .action-btn { @apply hover:text-white transition-colors; }
    .message-input-area { @apply p-2 border-t border-gray-700/50 flex gap-2 shrink-0 items-end; }
    .input-wrapper { @apply w-full flex flex-col; }
    .replying-to-banner { @apply flex justify-between items-center text-xs p-2 bg-gray-700/50 rounded-t-md text-gray-300; }
    .replying-to-banner button { @apply font-bold text-lg leading-none; }
    .input-field { @apply w-full p-2 bg-gray-800/70 text-gray-200 resize-none outline-none border border-transparent focus:border-cyber-yellow; transition: border-color 0.2s; border-radius: 0.375rem; }
    .input-field:disabled { @apply opacity-50 cursor-wait; }
    .send-button { @apply px-3 py-2 bg-cyber-yellow text-black font-bold rounded-md font-display uppercase tracking-wider h-auto shrink-0 flex items-center justify-center; aspect-ratio: 1 / 1; }
    .send-button:disabled { @apply bg-gray-600 text-gray-400 opacity-50 cursor-not-allowed; }
    .date-separator { @apply flex justify-center items-center my-4; }
    .date-separator span { @apply text-xs font-bold uppercase tracking-wider text-gray-500 bg-gray-800/50 px-3 py-1 rounded-full; }
    .message-time-inline { @apply absolute bottom-1 right-2 text-xs text-gray-500; }
    .mobile-exclusive { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0.75rem; background: rgba(0, 0, 0, 0.3); border: 1px dashed rgba(255, 255, 255, 0.2); border-radius: 6px; font-family: 'Chakra Petch', monospace; min-width: 180px; }
    .mobile-exclusive.image { border-color: var(--cyber-cyan); background: rgba(0, 240, 255, 0.05); }
    .mobile-exclusive.voice { border-color: var(--cyber-yellow); background: rgba(252, 238, 10, 0.05); }
    .mobile-exclusive .icon { font-size: 1rem; }
    .mobile-exclusive .info { display: flex; flex-direction: column; }
    .mobile-exclusive .title { font-weight: bold; font-size: 0.75rem; color: #fff; }
    .mobile-exclusive .subtitle { font-size: 0.6rem; color: rgba(255, 255, 255, 0.6); }
    .chat-lang-toggle { display: flex; background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 4px; padding: 2px; }
    .chat-lang-toggle button { font-size: 0.65rem; font-weight: 800; padding: 2px 6px; border-radius: 2px; color: #555; transition: all 0.2s; }
    .chat-lang-toggle button.active { background: var(--cyber-yellow); color: #000; box-shadow: 0 0 5px var(--cyber-yellow); }
    .load-more-btn { @apply w-full py-2 text-[10px] font-bold tracking-widest text-gray-500 hover:text-white transition-colors uppercase mb-4; background: rgba(255, 255, 255, 0.02); border: 1px dashed rgba(255, 255, 255, 0.1); }
    .reached-end-text { @apply w-full text-center py-4 text-[9px] text-gray-700 uppercase tracking-widest; }
    .empty-chat { @apply m-auto text-center p-6; }
    .unread-separator { display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin: 1rem 0; animation: flash-red 2s infinite; }
    .unread-separator .line { flex-grow: 1; height: 1px; background: #ff003c; }
    .unread-separator .text { color: #ff003c; font-size: 0.6rem; font-weight: bold; letter-spacing: 0.2em; white-space: nowrap; }
    @keyframes flash-red { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }
</style>
</file>

<file path="src/routes/profile/edit/+page.svelte">
<script lang="ts">
    import NeonButton from '$lib/components/NeonButton.svelte';
    import AvatarEditor from '$lib/components/AvatarEditor.svelte';
    import { getFunctions, httpsCallable } from 'firebase/functions';
    import { onMount } from 'svelte';
    import { quintOut } from 'svelte/easing';
    import { tweened } from 'svelte/motion';
    import type { PageData } from './$types';
    import { userStore } from '$lib/stores';
    import { modal } from '$lib/stores/modalStore';
    import { goto } from '$app/navigation';
    import { t } from 'svelte-i18n';
    import { get } from 'svelte/store';

    export let data: PageData;

    let status = data.profile.status || '';
    let aboutMe = data.profile.about_me || '';
    let socials = { ...data.profile.socials };
    let imagePreviewUrl: string | null = data.profile.avatar_url || `https://api.dicebear.com/7.x/bottts-neutral/svg?seed=${encodeURIComponent(data.profile.username.trim() || 'default')}`;

    let isLoadingAvatar = false;
    let isSavingProfile = false;

    // [ЭТАП 5] Смена никнейма
    let newUsername = '';
    let isChangingUsername = false;
    let usernameError = '';

    let isEditorOpen = false;
    let selectedFile: File | null = null;

    const opacity = tweened(0, { duration: 400, easing: quintOut });
    const translate = (key: string) => get(t)(key);

    onMount(() => {
        opacity.set(1);
    });

    // Валидация на лету
    $: {
        if (newUsername && newUsername.trim().length > 0) {
            const trimmed = newUsername.trim();
            if (trimmed.length < 4) {
                usernameError = translate('edit_profile.username_error_length');
            } else if (trimmed.length > 20) {
                usernameError = translate('edit_profile.username_error_length');
            } else if (!/^[a-zA-Z0-9_]+$/.test(trimmed)) {
                usernameError = translate('edit_profile.username_error_chars');
            } else {
                usernameError = '';
            }
        } else {
            usernameError = '';
        }
    }

    async function handleAvatarChange(event: Event) {
        const input = event.target as HTMLInputElement;
        const file = input.files?.[0];
        if (!file) return;

        if (file.size > 5 * 1024 * 1024) {
            modal.error(translate('edit_profile.modal_size_error'), 'Max 5MB.');
            input.value = '';
            return;
        }
        if (!['image/jpeg', 'image/png', 'image/gif', 'image/webp'].includes(file.type)) {
            modal.error(translate('edit_profile.modal_type_error'), 'JPG, PNG, GIF, WEBP only.');
            input.value = '';
            return;
        }

        selectedFile = file;
        isEditorOpen = true;
        input.value = '';
    }

    async function handleEditorSave(event: CustomEvent<{ imageBase64: string }>) {
        isLoadingAvatar = true;
        try {
            const { imageBase64 } = event.detail;
            const functions = getFunctions();
            const uploadAvatarFunc = httpsCallable(functions, 'uploadAvatar');

            modal.info(translate('ui.loading'), 'Uploading...');

            const result = await uploadAvatarFunc({ imageBase64 });

            localStorage.removeItem('protomap_markers_cache');
            localStorage.removeItem('protomap_markers_time');

            const newAvatarUrl = (result.data as { avatarUrl: string }).avatarUrl;
            imagePreviewUrl = newAvatarUrl;

            modal.success(translate('edit_profile.modal_avatar_success'), translate('edit_profile.modal_avatar_success_text'));

            userStore.update(store => {
                if (store.user) {
                    return { ...store, user: { ...store.user, avatar_url: newAvatarUrl } };
                }
                return store;
            });
        } catch (error: any) {
            modal.error(translate('ui.error'), error.message || 'Upload failed.');
        } finally {
            isLoadingAvatar = false;
        }
    }

    function handleEditorClose() {
        isEditorOpen = false;
        selectedFile = null;
    }

    async function saveProfileData() {
        isSavingProfile = true;
        try {
            const functions = getFunctions();
            const updateProfileFunc = httpsCallable(functions, 'updateProfileData');
            const result = await updateProfileFunc({
                status,
                about_me: aboutMe,
                socials
            });

            localStorage.removeItem('protomap_markers_cache');
            localStorage.removeItem('protomap_markers_time');

            const message = (result.data as { message: string }).message;
            modal.success(translate('inventory.success_title'), message || 'Saved.');

            userStore.update(store => {
                if (store.user) store.user.status = status;
                return store;
            });

            setTimeout(() => {
                goto(`/u/${data.profile.uid}`);
            }, 1500);

        } catch (error: any) {
            modal.error(translate('inventory.error_title'), error.message || 'Save failed.');
        } finally {
            isSavingProfile = false;
        }
    }

    // [ЭТАП 5] Смена никнейма — теперь просто один UPDATE на users/{uid}
    async function changeUsername() {
        const trimmed = newUsername.trim();

        if (!trimmed) {
            modal.error(translate('ui.error'), translate('edit_profile.username_placeholder') + '...');
            return;
        }
        if (usernameError) {
            modal.error('Ошибка', usernameError);
            return;
        }
        if (trimmed === data.profile.username) {
            modal.error(translate('ui.error'), translate('edit_profile.username_error_reserved'));
            return;
        }

        modal.confirm(
            translate('edit_profile.username_confirm_title'),
            translate("edit_profile.username_confirm_text", { name: trimmed }),
            async () => {
                isChangingUsername = true;
                try {
                    const functions = getFunctions();
                    const changeUsernameFunc = httpsCallable(functions, 'changeUsername');
                    const result = await changeUsernameFunc({ newUsername: trimmed });
                    const msg = (result.data as { message: string }).message;

                    // Инвалидируем кэш карты
                    localStorage.removeItem('protomap_markers_cache');
                    localStorage.removeItem('protomap_markers_time');

                    // Обновляем userStore локально
                    userStore.update(store => {
                        if (store.user) {
                            return { ...store, user: { ...store.user, username: trimmed } };
                        }
                        return store;
                    });

                    modal.success(translate('ui.success'), translate('edit_profile.username_success', { name: trimmed }));
                    newUsername = '';

                    // Редиректим на новый профиль через uid — никнейм в URL больше не используется
                    setTimeout(() => {
                        goto(`/u/${data.profile.uid}`);
                    }, 1500);

                } catch (err: any) {
                    modal.error(translate('ui.error'), err.message || 'Pопробуйте позже.');
                } finally {
                    isChangingUsername = false;
                }
            }
        );
    }
</script>

<svelte:head>
    <title>{$t('edit_profile.title')} | ProtoMap</title>
</svelte:head>

<div class="form-container cyber-panel pb-12" style="opacity: {$opacity}">
    <h2 class="form-title font-display">{$t('edit_profile.title')}</h2>

    <!-- АВАТАР -->
    <div class="form-group space-y-4 mb-8">
        <label for="avatar-file-input" class="form-label font-display">{$t('edit_profile.avatar_label')}</label>
        {#if imagePreviewUrl}
            <img src={imagePreviewUrl} alt="Avatar" class="avatar-preview" />
        {/if}
        <NeonButton type="button" on:click={() => document.getElementById('avatar-file-input')?.click()} extraClass="w-full" disabled={isLoadingAvatar || isSavingProfile}>
            {#if isLoadingAvatar}
                <span class="animate-pulse">{$t('ui.loading')}</span>
            {:else}
                {$t('edit_profile.avatar_btn')}
            {/if}
        </NeonButton>
        <input type="file" id="avatar-file-input" class="hidden-file-input" on:change={handleAvatarChange} accept="image/jpeg, image/png, image/gif, image/webp" />
        <p class="form-help-text text-center">{$t('edit_profile.avatar_help')}</p>
    </div>

    <hr class="separator"/>

    <!-- [ЭТАП 5] СМЕНА НИКНЕЙМА -->
    <div class="space-y-4 mb-8">
        <h3 class="form-label font-display text-lg">{$t('edit_profile.username_label')}</h3>

        <div class="username-current">
            <span class="text-gray-500 text-sm uppercase tracking-widest">// Current:</span>
            <span class="text-cyber-yellow font-bold ml-2">@{data.profile.username}</span>
        </div>

        <div class="form-group">
            <label for="new_username" class="form-label font-display">{$t('edit_profile.username_placeholder')}</label>
            <input
                bind:value={newUsername}
                type="text"
                id="new_username"
                class="input-field"
                class:input-error={usernameError}
                placeholder={$t('edit_profile.username_placeholder')}
                maxlength="20"
                disabled={isChangingUsername || isSavingProfile}
            />
            {#if usernameError}
                <p class="text-red-400 text-xs mt-1">⚠ {usernameError}</p>
            {:else}
                <p class="form-help-text">{$t('edit_profile.username_help')}</p>
            {/if}
            <p class="text-right text-xs text-gray-500 mt-1">{newUsername.length} / 20</p>
        </div>

        <NeonButton
            type="button"
            on:click={changeUsername}
            extraClass="w-full"
            disabled={isChangingUsername || isSavingProfile || !!usernameError || !newUsername.trim()}
        >
            {#if isChangingUsername}
                <span class="animate-pulse">{$t('edit_profile.username_saving')}</span>
            {:else}
                {$t('edit_profile.username_save_btn')}
            {/if}
        </NeonButton>
    </div>

    <hr class="separator"/>

    <!-- ОСНОВНЫЕ ДАННЫЕ ПРОФИЛЯ -->
    <div class="space-y-8">
        <h3 class="form-label font-display text-lg">{$t('edit_profile.info_title')}</h3>

        <div class="form-group">
            <label for="status" class="form-label font-display">{$t('edit_profile.status_label')}</label>
            <input bind:value={status} type="text" id="status" class="input-field" placeholder={$t('edit_profile.status_placeholder')} maxlength="100" disabled={isLoadingAvatar || isSavingProfile} />
            <p class="form-help-text">{$t('edit_profile.status_help')}</p>
            <p class="text-right text-xs text-gray-500 mt-1">{status.length} / 100</p>
        </div>

        <div class="form-group">
            <label for="about_me" class="form-label font-display">{$t('edit_profile.about_label')}</label>
            <textarea bind:value={aboutMe} id="about_me" rows="5" class="input-field" placeholder={$t('edit_profile.about_placeholder')} maxlength="500" disabled={isLoadingAvatar || isSavingProfile}></textarea>
            <p class="text-right text-xs text-gray-500 mt-1">{aboutMe.length} / 500</p>
        </div>

        <div class="form-group">
            <label for="social_telegram" class="form-label font-display">TELEGRAM</label>
            <input bind:value={socials.telegram} type="text" id="social_telegram" class="input-field" placeholder={$t('edit_profile.social_tg_placeholder')} disabled={isLoadingAvatar || isSavingProfile} />
        </div>
        <div class="form-group">
            <label for="social_discord" class="form-label font-display">DISCORD</label>
            <input bind:value={socials.discord} type="text" id="social_discord" class="input-field" placeholder={$t('edit_profile.social_ds_placeholder')} disabled={isLoadingAvatar || isSavingProfile} />
        </div>
        <div class="form-group">
            <label for="social_vk" class="form-label font-display">VK</label>
            <input bind:value={socials.vk} type="text" id="social_vk" class="input-field" placeholder={$t('edit_profile.social_vk_placeholder')} disabled={isLoadingAvatar || isSavingProfile} />
        </div>
        <div class="form-group">
            <label for="social_twitter" class="form-label font-display">X (TWITTER)</label>
            <input bind:value={socials.twitter} type="text" id="social_twitter" class="input-field" placeholder={$t('edit_profile.social_x_placeholder')} disabled={isLoadingAvatar || isSavingProfile} />
        </div>
        <div class="form-group">
            <label for="social_website" class="form-label font-display">{$t('edit_profile.social_website_label') || 'WEB'}</label>
            <input bind:value={socials.website} type="url" id="social_website" class="input-field" placeholder={$t('edit_profile.social_web_placeholder')} disabled={isLoadingAvatar || isSavingProfile} />
        </div>

        <div class="flex flex-col sm:flex-row gap-4 pt-4">
            <NeonButton type="button" on:click={saveProfileData} extraClass="w-full" disabled={isLoadingAvatar || isSavingProfile}>
                {isSavingProfile ? $t('inventory.saving') : $t('edit_profile.save_btn')}
            </NeonButton>
            <a href="/u/{data.profile.uid}" class="cancel-btn">{$t('edit_profile.cancel_btn')}</a>
        </div>
    </div>
</div>

<AvatarEditor
    bind:isOpen={isEditorOpen}
    imageFile={selectedFile}
    on:save={handleEditorSave}
    on:close={handleEditorClose}
/>

<style>
    .form-container { @apply max-w-2xl mx-auto my-10 p-8 rounded-none shadow-2xl relative; background: rgba(10, 10, 10, 0.5); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); border: 1px solid rgba(252, 238, 10, 0.2); clip-path: polygon(0 15px, 15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%); }
    .form-title { @apply text-2xl lg:text-3xl font-bold text-center text-white mb-10; text-shadow: none; }
    .form-label { @apply block text-sm font-bold uppercase tracking-widest text-cyber-yellow mb-2; }
    .input-field { @apply block w-full p-2 bg-transparent text-gray-200; border: none; border-bottom: 1px solid var(--border-color, #30363d); border-radius: 0; font-family: 'Inter', sans-serif; font-size: 1.1em; transition: border-color 0.3s, box-shadow 0.3s; }
    .input-field:focus:not(:disabled) { @apply outline-none; border-bottom-color: var(--cyber-yellow, #fcee0a); box-shadow: 0 1px 0 var(--cyber-yellow, #fcee0a); }
    .input-error { border-bottom-color: #ff003c !important; }
    textarea.input-field { min-height: 120px; resize: vertical; }
    .form-help-text { @apply mt-1 text-xs text-gray-500; }
    .avatar-preview { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid var(--cyber-yellow); margin: 0 auto 1rem auto; display: block; background-color: #222; }
    .cancel-btn { @apply block sm:w-auto w-full text-center py-3 px-6 rounded-md border border-gray-600 text-gray-300 font-display uppercase tracking-widest text-sm; transition: all 0.2s; }
    .cancel-btn:hover { background-color: var(--input-bg-color, #1a1a1a); border-color: var(--cyber-red, #ff003c); color: var(--cyber-red, #ff003c); text-shadow: 0 0 8px var(--cyber-red, #ff003c); }
    .separator { @apply border-t-2 border-dashed border-gray-700/50 my-8; }
    .hidden-file-input { width: 0; height: 0; position: absolute; opacity: 0; z-index: -1; }
    .username-current { @apply p-3 rounded; background: rgba(252, 238, 10, 0.05); border: 1px solid rgba(252, 238, 10, 0.15); }
    .animate-pulse { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
</style>
</file>

<file path="src/lib/components/Navbar.svelte">
<script lang="ts">
    import { userStore } from '$lib/stores';
    import { auth } from '$lib/firebase';
    import { signOut } from 'firebase/auth';
    import { afterNavigate } from '$app/navigation';
    import NeonButton from '$lib/components/NeonButton.svelte';
    import { getSeasonalContent } from '$lib/seasonal/seasonalContent';
    import { settingsStore } from '$lib/stores/settingsStore';
    import Footer from "$lib/components/Footer.svelte";
    import { page } from '$app/stores';
    import { slide, fade, scale } from 'svelte/transition';
    import { quintOut } from 'svelte/easing';
    import { tweened } from 'svelte/motion';
    import { onMount } from 'svelte';
    import { t, locale } from 'svelte-i18n';
    import SettingsModal from '$lib/components/SettingsModal.svelte';

    let isSettingsOpenMobile = false;

    const seasonal = getSeasonalContent();
    let isMobileMenuOpen = false;
    let isUserMenuOpen = false;
    let isSettingsOpen = false;

    let hasUnreadNews = false;
    $: latestNewsDate = $page.data.latestNewsDate;
    $: isAdmin = $page.data.isAdmin;

    onMount(() => {
        checkUnreadNews();
    });

    function checkUnreadNews() {
        if (!latestNewsDate) return;
        const lastViewed = localStorage.getItem('protomap_last_news_view');

        if (!lastViewed) {
            hasUnreadNews = true;
        } else {
            if (new Date(latestNewsDate) > new Date(lastViewed)) {
                hasUnreadNews = true;
            }
        }
    }

    function markNewsAsRead() {
        if (latestNewsDate) {
            localStorage.setItem('protomap_last_news_view', new Date().toISOString());
            hasUnreadNews = false;
        }
    }

    function changeLang(newLang: string) {
        locale.set(newLang);
        localStorage.setItem('protomap_lang', newLang);
    }

    function toggleMobileMenu() { isMobileMenuOpen = !isMobileMenuOpen; isUserMenuOpen = false; isSettingsOpen = false; }
    function toggleUserMenu() { isUserMenuOpen = !isUserMenuOpen; isSettingsOpen = false; }
    function toggleSettings() { isSettingsOpen = !isSettingsOpen; isUserMenuOpen = false; }

    function closeAllMenus() {
        isMobileMenuOpen = false;
        isUserMenuOpen = false;
        isSettingsOpen = false;
    }

    function handleBackdropClick() { closeAllMenus(); }

    afterNavigate(() => { closeAllMenus(); });
    async function handleLogout() { await signOut(auth); closeAllMenus(); }

    function getEncodedUsername(username: string | undefined | null): string {
        if (!username) return '';
        return encodeURIComponent(username.trim());
    }

    const displayedCredits = tweened(0, { duration: 500, easing: quintOut });
    $: if ($userStore.user) { displayedCredits.set($userStore.user.casino_credits); }

    $: activeRoute = $page.url.pathname;
    function isActive(path: string) {
        if (path === '/' && activeRoute === '/') return true;
        if (path !== '/' && activeRoute.startsWith(path)) return true;
        return false;
    }
</script>

{#if isUserMenuOpen || isSettingsOpen}
    <div class="fixed inset-0 z-40" on:click={handleBackdropClick}></div>
{/if}

<nav class="navbar-glass sticky top-0 z-50 w-full px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between h-16 relative">

        <!-- 1. ЛОГОТИП И ФРАЗА -->
        <div class="flex-shrink-0 flex items-center gap-3 z-20">
            <a href="/" class="flex items-center gap-2 group text-decoration-none">
                <div class="logo-container">
                    <img src="/logo.svg" alt="Logo" class="logo-icon" />
                </div>
                <span class="nav-brand text-xl font-bold tracking-widest hidden xl:block" data-text="PROTOMAP">
                    PROTOMAP
                </span>
            </a>

             <div class="seasonal-phrase-container hidden xl:block">
                 <a href={seasonal.link} target="_blank" rel="noopener noreferrer" class="hover:text-cyan-400 transition-colors">
                    {seasonal.phrase}
                 </a>
            </div>
        </div>

        <!-- 2. ЦЕНТРАЛЬНОЕ МЕНЮ (DESKTOP) -->
        <div class="hidden xl:flex items-center justify-center space-x-1 absolute left-1/2 transform -translate-x-1/2 h-full z-10">
            <a href="/" class="nav-tab" class:active={isActive('/')}>
                {$t('nav.map')}
                <div class="tab-line"></div>
            </a>

            <a href="/news" class="nav-tab" class:active={isActive('/news')} on:click={markNewsAsRead}>
                {$t('nav.news')}
                {#if hasUnreadNews} <span class="notification-dot"></span> {/if}
                <div class="tab-line"></div>
            </a>

            <a href="/casino" class="nav-tab glitch-link" class:active={isActive('/casino')} data-text="THE GLITCH PIT">
                {$t('nav.casino')}
                <div class="tab-line"></div>
            </a>
            <a href="/about" class="nav-tab" class:active={isActive('/about')}>
                {$t('nav.about')}
                <div class="tab-line"></div>
            </a>

            <div class="nav-divider"></div>

            <a href="/ai-policy" class="nav-tab text-red-500 hover:text-red-400" class:active={isActive('/ai-policy')}>
                Censored by r/protogen
                <div class="tab-line red"></div>
            </a>
        </div>

        <!-- 3. ПРАВАЯ ЧАСТЬ (DESKTOP) -->
        <div class="hidden 2xl:flex items-center gap-3 z-20">
            {#if $userStore.user}
                <div class="balance-pill" title={$t('ui.balance')}>
                    <span class="text-xs text-cyber-yellow font-bold tracking-wider">PC</span>
                    <span class="font-mono font-bold">{Math.floor($displayedCredits)}</span>
                </div>
            {/if}

            {#if isAdmin}
                <a href="/admin" class="icon-btn admin-btn" title="GOD MODE">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="M12 8v4"></path><path d="M12 16h.01"></path></svg>
                </a>
            {/if}

            <div class="relative">
                 <button class="icon-btn" class:active={isSettingsOpen} on:click={toggleSettings} aria-label="Settings">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"/></svg>
                </button>
                {#if isSettingsOpen}
                    <div class="cyber-dropdown" transition:scale={{duration: 150, start: 0.95, opacity: 0}}>
                        <div class="dropdown-header">// {$t('menu.system')}</div>
                        <div class="px-4 py-2">
                            <div class="setting-row mb-3">
                                <span class="text-sm text-gray-300 font-display">{$t('menu.lang')}</span>
                                <div class="lang-switch">
                                    <button class="lang-btn" class:active={$locale === 'ru'} on:click={() => changeLang('ru')}>RU</button>
                                    <button class="lang-btn" class:active={$locale === 'en'} on:click={() => changeLang('en')}>EN</button>
                                </div>
                            </div>
                            <label class="setting-row">
                                <span>{$t('menu.sound')}</span>
                                <input type="checkbox" bind:checked={$settingsStore.audioEnabled} class="cyber-switch">
                            </label>
                            <label class="setting-row mt-3">
                                <span>{$t('menu.anim')}</span>
                                <input type="checkbox" bind:checked={$settingsStore.cinematicLoadsEnabled} class="cyber-switch">
                            </label>
                            <label class="setting-row mt-3">
                                <span>{$t('menu.seasonal')}</span>
                                <input type="checkbox" bind:checked={$settingsStore.seasonalEnabled} class="cyber-switch">
                            </label>
                        </div>
                    </div>
                {/if}
            </div>
            <a href="/mobile-beta" class="icon-btn android-btn" title="Download App">
                <svg width="20" height="20" viewBox="0 0 512 512" fill="currentColor">
                    <path d="M325.3 234.3L104.6 13l280.8 161.2-60.1 60.1zM47 0C34 6.8 25.3 19.2 25.3 35.3v441.3c0 16.1 8.7 28.5 21.7 35.3l256.6-256L47 0zm425.2 225.6l-58.9-34.1-65.7 64.5 65.7 64.5 60.1-34.1c18-14.3 18-46.5-1.2-60.8zM104.6 499l280.8-161.2-60.1-60.1L104.6 499z"/>
                </svg>
            </a>
            <div class="h-6 w-px bg-white/10 mx-1"></div>

            {#if $userStore.loading}
                <div class="h-9 w-24 bg-gray-800 rounded-full animate-pulse"></div>
            {:else if $userStore.user}
                <div class="relative">
                    <button on:click={toggleUserMenu} class="user-pill" class:active={isUserMenuOpen}>
                        <div class="avatar-container small {$userStore.user.equipped_frame || ''}">
                            <img src={$userStore.user.avatar_url || `https://api.dicebear.com/7.x/bottts-neutral/svg?seed=${$userStore.user.username}`} alt="Avatar" class="user-avatar" />
                        </div>
                        <span class="username">{$userStore.user.username}</span>
                        <svg class="chevron" class:rotate={isUserMenuOpen} width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m6 9 6 6 6-6"/></svg>
                    </button>
                    {#if isUserMenuOpen}
                        <div class="cyber-dropdown" transition:scale={{duration: 150, start: 0.95, opacity: 0}}>
                            <div class="dropdown-header">// {$t('menu.profile')}</div>
                            <a href="/profile/{getEncodedUsername($userStore.user.username)}" class="dropdown-item">
                                <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                                {$t('menu.profile')}
                            </a>
                            <a href="/casino/inventory" class="dropdown-item">
                                <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>
                                {$t('menu.inventory')}
                            </a>
                            <div class="dropdown-divider"></div>
                            <a href="/settings/security" class="dropdown-item">
                                <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                </svg>
                                {$t('menu.security')}
                            </a>
                            <div class="dropdown-divider"></div>
                            <button on:click={handleLogout} class="dropdown-item text-red">
                                <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                                {$t('menu.logout')}
                            </button>
                        </div>
                    {/if}
                </div>
            {:else}
                <a href="/login" class="text-sm font-bold text-gray-300 hover:text-white mr-3 transition-colors font-display tracking-wide">{$t('nav.login')}</a>
                <NeonButton href="/register" extraClass="text-xs px-5 py-1.5 !border-[1px]">{$t('nav.register')}</NeonButton>
            {/if}
        </div>

        <!-- 4. МОБИЛЬНОЕ МЕНЮ -->
        <div class="2xl:hidden flex items-center gap-3">
            {#if $userStore.user}
                <div class="balance-pill mobile">
                    <span class="text-[10px] text-cyber-yellow font-bold">PC</span>
                    <span class="font-mono text-sm font-bold">{Math.floor($displayedCredits)}</span>
                </div>
            {/if}

            <button on:click={toggleMobileMenu} class="p-2 text-gray-400 hover:text-white transition-colors relative">
                {#if isMobileMenuOpen}
                    <svg class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                {:else}
                    <svg class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                    {#if hasUnreadNews}
                        <span class="notification-dot mobile-icon"></span>
                    {/if}
                {/if}
            </button>
        </div>
    </div>

    {#if isMobileMenuOpen}
        <div class="2xl:hidden bg-[#050a10]/95 backdrop-blur-xl border-b border-gray-800 absolute w-full left-0 z-40 shadow-2xl" transition:slide>
            <div class="py-2 space-y-1">
                <a href="/" class="mobile-link" class:active={isActive('/')}>{$t('nav.map')}</a>
                <a href="/news" class="mobile-link relative" class:active={isActive('/news')} on:click={markNewsAsRead}>
                    {$t('nav.news')}
                    {#if hasUnreadNews} <span class="notification-dot mobile"></span> {/if}
                </a>
                <a href="/casino" class="mobile-link glitch-text-mobile" class:active={isActive('/casino')}>{$t('nav.casino')}</a>
                <a href="/about" class="mobile-link" class:active={isActive('/about')}>{$t('nav.about')}</a>

                <a href="/ai-policy" class="mobile-link text-red-400" class:active={isActive('/ai-policy')}>
                    Censored by r/protogen
                </a>

                <div class="border-t border-white/10 my-2"></div>

                {#if $userStore.user}
                    <div class="px-4 py-3 flex items-center gap-3 bg-white/5 mx-2 rounded-lg border border-white/5">
                        <div class="avatar-container small {$userStore.user.equipped_frame || ''}">
                            <img src={$userStore.user.avatar_url} class="user-avatar" alt=""/>
                        </div>
                        <div>
                            <p class="text-white font-bold leading-tight font-display">{$userStore.user.username}</p>
                            <p class="text-xs text-gray-400 font-mono">ID: {$userStore.user.uid.substring(0,6)}</p>
                        </div>
                    </div>
                    <a href="/profile/{getEncodedUsername($userStore.user.username)}" class="mobile-sub-link">{$t('menu.profile')}</a>
                    <a href="/casino/inventory" class="mobile-sub-link">{$t('menu.inventory')}</a>
                    <a href="/settings/security" class="mobile-sub-link">{$t('menu.security')}</a>
                    <button on:click={handleLogout} class="mobile-sub-link text-red-400">{$t('menu.logout')}</button>
                {:else}
                    <a href="/login" class="mobile-link">{$t('nav.login')}</a>
                    <a href="/register" class="mobile-link">{$t('nav.register')}</a>
                {/if}

                {#if isAdmin}
                    <a href="/admin" class="mobile-link text-red-500 border-l-red-500">
                        💀 GOD MODE
                    </a>
                {/if}

                <a href="/mobile-beta" class="mobile-link text-green-400 border-l-green-400">
                    📱 ANDROID APP (BETA)
                </a>

                <div class="border-t border-white/10 my-2"></div>

                <!-- НОВАЯ КРАСИВАЯ КНОПКА НАСТРОЕК -->
                <button class="settings-btn-mobile" on:click={() => isSettingsOpenMobile = true}>
                    <span class="icon">⚙️</span>
                    <span class="text">{$t('menu.system')}</span>
                </button>

                <div class="px-4 pb-4 mt-2">
                    <Footer mode="menu"/>
                </div>
            </div>
        </div>
    {/if}

    {#if isSettingsOpenMobile}
        <SettingsModal on:close={() => isSettingsOpenMobile = false} />
    {/if}
</nav>

<style>
    .navbar-glass {
        background: rgba(5, 8, 12, 0.85);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
    }

    /* ... ЛОГО И ПРОЧЕЕ (без изменений) ... */
    .logo-container {
        width: 50px; height: 50px;
        display: flex; align-items: center; justify-content: center;
        transition: transform 0.3s;
        margin-right: 4px;
        flex-shrink: 0;
    }
    a:hover .logo-container { transform: scale(1.15) rotate(-5deg); }
    .logo-icon {
        width: 100%; height: 100%; object-fit: contain;
        filter: invert(1) drop-shadow(0 0 5px var(--cyber-yellow));
    }
    .seasonal-phrase-container {
        display: block; font-size: 0.7rem; line-height: 1.3; color: #6b7280;
        max-width: 150px; font-family: 'Chakra Petch', monospace;
    }
    .seasonal-phrase-container a:hover { color: #67e8f9; }
    @media (min-width: 1024px) {
        .seasonal-phrase-container { border-left: 1px solid #374151; padding-left: 0.75rem; font-size: 0.75rem; max-width: none; white-space: nowrap; }
    }
    @media (max-width: 768px) {
        .logo-container { width: 42px; height: 42px; }
    }

    .notification-dot {
        position: absolute; top: 12px; right: 2px;
        width: 8px; height: 8px; background-color: var(--cyber-red, #ff003c); border-radius: 50%;
        box-shadow: 0 0 8px var(--cyber-red, #ff003c);
        animation: pulse-dot 2s infinite; pointer-events: none; z-index: 10;
    }
    .notification-dot.mobile { top: 50%; right: 20px; transform: translateY(-50%); }
    .notification-dot.mobile-icon { top: 5px; right: 5px; width: 10px; height: 10px; border: 2px solid #050a10; }
    @keyframes pulse-dot { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.8); } 100% { opacity: 1; transform: scale(1); } }

    .nav-tab {
        position: relative; padding: 0 0.8rem; height: 100%;
        display: flex; align-items: center;
        font-family: 'Chakra Petch', monospace; font-size: 0.8rem;
        font-weight: 700; letter-spacing: 0.05em; color: #94a3b8; transition: color 0.3s; text-transform: uppercase;
        white-space: nowrap;
    }
    .nav-tab:hover { color: #fff; text-shadow: 0 0 8px rgba(255,255,255,0.5); }
    .nav-tab.active { color: #fff; }

    .tab-line {
        position: absolute; bottom: 0; left: 0; width: 100%; height: 2px;
        background: var(--cyber-yellow, #fcee0a);
        box-shadow: 0 -2px 10px var(--cyber-yellow, #fcee0a);
        transform: scaleX(0); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: center;
    }
    .nav-tab:hover .tab-line, .nav-tab.active .tab-line { transform: scaleX(1); }
    .tab-line.red { background: var(--cyber-red, #ff003c); box-shadow: 0 -2px 10px var(--cyber-red, #ff003c); }

    .glitch-link:hover {
        animation: glitch-skew 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) both infinite;
        color: var(--cyber-red, #ff003c); text-shadow: 2px 0 #00f0ff, -2px 0 #ff003c;
    }
    @keyframes glitch-skew { 0% { transform: skew(0deg); } 20% { transform: skew(-2deg); } 40% { transform: skew(2deg); } 60% { transform: skew(-1deg); } 80% { transform: skew(1deg); } 100% { transform: skew(0deg); } }

    .balance-pill {
        display: flex; align-items: center; gap: 0.5rem;
        background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 0.3rem 0.8rem; border-radius: 6px; color: #e2e8f0;
        transition: all 0.2s; font-family: 'Chakra Petch', monospace;
    }
    .balance-pill:hover { border-color: var(--cyber-yellow); box-shadow: 0 0 10px rgba(252, 238, 10, 0.1); }
    .balance-pill.mobile { padding: 0.2rem 0.6rem; background: rgba(0,0,0,0.4); }

    .icon-btn { padding: 0.5rem; color: #94a3b8; border-radius: 8px; transition: all 0.2s; }
    .icon-btn:hover, .icon-btn.active { color: #fff; background: rgba(255, 255, 255, 0.1); }

    .user-pill {
        display: flex; align-items: center; gap: 0.75rem;
        padding: 0.25rem 0.25rem 0.25rem 0.25rem; padding-right: 0.75rem;
        background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 99px; transition: all 0.2s; cursor: pointer;
    }
    .user-pill:hover, .user-pill.active { background: rgba(255, 255, 255, 0.08); border-color: rgba(255, 255, 255, 0.3); }
    .username { font-family: 'Chakra Petch', monospace; font-weight: 600; font-size: 0.9rem; color: #e2e8f0; max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .chevron { color: #64748b; transition: transform 0.2s; }
    .chevron.rotate { transform: rotate(180deg); }

    .avatar-container.small { width: 32px; height: 32px; position: relative; border-radius: 50%; flex-shrink: 0; }
    .avatar-container.small:not([class*="frame_"]) { border: 1px solid rgba(255,255,255,0.3); }
    .user-avatar { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: none !important; }

    .cyber-dropdown {
        position: absolute; top: calc(100% + 8px); right: 0; width: 240px;
        background: rgba(8, 12, 18, 0.95); backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 8px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6); z-index: 100; overflow: hidden; transform-origin: top right;
    }
    .dropdown-header { padding: 0.75rem 1rem; font-size: 0.75rem; font-weight: bold; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; background: rgba(0,0,0,0.2); border-bottom: 1px solid rgba(255,255,255,0.05); font-family: 'Chakra Petch', monospace; }
    .dropdown-item { display: flex; align-items: center; width: 100%; padding: 0.75rem 1rem; font-size: 0.9rem; color: #cbd5e1; transition: all 0.2s; text-align: left; font-family: 'Inter', sans-serif; }
    .dropdown-item:hover { background: rgba(255, 255, 255, 0.05); color: #fff; padding-left: 1.25rem; }
    .dropdown-item .icon { width: 18px; height: 18px; margin-right: 10px; opacity: 0.7; }
    .dropdown-item:hover .icon { opacity: 1; color: var(--cyber-yellow); }
    .dropdown-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 4px 0; }
    .text-red { color: #ef4444; }
    .text-red:hover { color: #f87171; background: rgba(239, 68, 68, 0.1); }

    .setting-row { display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; font-size: 0.9rem; color: #cbd5e1; }
    .setting-row:hover { color: #fff; }
    .cyber-switch { appearance: none; width: 36px; height: 20px; background: #334155; border-radius: 99px; position: relative; cursor: pointer; transition: all 0.3s; border: 1px solid #475569; }
    .cyber-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 14px; height: 14px; background: #94a3b8; border-radius: 50%; transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); }
    .cyber-switch:checked { background: rgba(0, 240, 255, 0.2); border-color: var(--cyber-yellow); }
    .cyber-switch:checked::after { left: 18px; background: var(--cyber-yellow); box-shadow: 0 0 10px var(--cyber-yellow); }

    .mobile-link { display: block; padding: 0.75rem 1rem; font-family: 'Chakra Petch', monospace; font-weight: bold; color: #9ca3af; border-left: 2px solid transparent; }
    .mobile-link:hover { color: #fff; }
    .mobile-link.active { color: var(--cyber-yellow); border-left-color: var(--cyber-yellow); background: linear-gradient(to right, rgba(255,255,255,0.05), transparent); }
    .mobile-sub-link { display: block; padding: 0.75rem 1rem 0.75rem 3rem; font-size: 0.95rem; color: #cbd5e1; border-left: 2px solid transparent; }
    .mobile-sub-link:hover { color: #fff; background: rgba(255,255,255,0.03); }

    .admin-btn {
        color: #ff003c;
        border: 1px solid rgba(255, 0, 60, 0.3);
        background: rgba(255, 0, 60, 0.1);
    }
    .admin-btn:hover {
        background: rgba(255, 0, 60, 0.2);
        box-shadow: 0 0 15px #ff003c;
        transform: scale(1.05);
    }

    .lang-switch { display: flex; background: #334155; border-radius: 6px; padding: 2px; border: 1px solid #475569; margin-left: 1rem; }
    .lang-btn { padding: 2px 8px; font-size: 0.8rem; font-weight: bold; color: #94a3b8; border-radius: 4px; transition: all 0.2s; background: transparent; border: none; cursor: pointer; }
    .lang-btn.active { background: var(--cyber-yellow); color: #000; box-shadow: 0 0 5px var(--cyber-yellow); }
    .lang-btn:hover:not(.active) { color: #fff; }

    .nav-divider {
        height: 20px; width: 1px; background: rgba(255, 255, 255, 0.2);
        box-shadow: 0 0 5px rgba(0, 243, 255, 0.3); margin: 0 0.5rem;
    }

    /* === СТИЛЬ НОВОЙ КНОПКИ НАСТРОЕК В МОБИЛЬНОМ МЕНЮ === */
    .settings-btn-mobile {
        width: calc(100% - 2rem);
        margin: 0.5rem 1rem;
        display: flex; align-items: center; justify-content: center; gap: 0.8rem;
        padding: 0.8rem;
        background: rgba(0, 243, 255, 0.05);
        border: 1px solid var(--cyber-cyan);
        border-radius: 8px;
        color: var(--cyber-cyan);
        font-family: 'Chakra Petch', monospace;
        font-weight: bold;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.2s;
    }
    .settings-btn-mobile:hover {
        background: var(--cyber-cyan);
        color: #000;
        box-shadow: 0 0 15px var(--cyber-cyan);
    }
    .settings-btn-mobile .icon { font-size: 1.2rem; }
    .android-btn {
        color: #39ff14; /* Cyber Green */
        border: 1px solid rgba(57, 255, 20, 0.3);
        background: rgba(57, 255, 20, 0.1);
    }
    .android-btn:hover {
        background: rgba(57, 255, 20, 0.2);
        box-shadow: 0 0 15px #39ff14;
        transform: scale(1.05);
        color: #fff;
    }
</style>
</file>

<file path="src/routes/casino/+page.svelte">
<script lang="ts">
    import { userStore } from '$lib/stores';
    import { onMount } from 'svelte';
    import { quintOut } from 'svelte/easing';
    import { tweened } from 'svelte/motion';
    import { getFunctions, httpsCallable } from 'firebase/functions';
    import { modal } from '$lib/stores/modalStore';
    import { fade, slide } from 'svelte/transition';
    import { Howl } from 'howler';
    import { t } from 'svelte-i18n';
    import { get } from 'svelte/store';

    let loadingBonus = false;
    let loadingLeaderboard = true;

    type LeaderboardEntry = {
        username: string;
        avatar_url: string;
        casino_credits: number;
        equipped_frame: string | null;
    };

    let leaderboard: LeaderboardEntry[] = [];
    $: isVerified = $userStore.user?.emailVerified ?? false;

    const displayedCredits = tweened($userStore.user?.casino_credits || 0, {
        duration: 700,
        easing: quintOut
    });
    $: if ($userStore.user) {
        displayedCredits.set($userStore.user.casino_credits);
    }

    let sounds: { [key: string]: Howl } = {};

    const translate = (key: string) => get(t)(key);

    $: currentStreak = $userStore.user?.daily_streak || 0;

    $: lastBonusTime = $userStore.user?.last_daily_bonus ? new Date($userStore.user.last_daily_bonus).getTime() : 0;
    $: hoursSinceLast = lastBonusTime > 0 ? (Date.now() - lastBonusTime) / (1000 * 60 * 60) : 0;

    $: isAvailable = lastBonusTime === 0 || hoursSinceLast >= 20;
    $: isReset = lastBonusTime > 0 && hoursSinceLast > 48 && currentStreak > 0;

    $: nextDayIndex = isReset ? 1 : (currentStreak >= 30 ? 1 : currentStreak + 1);

    function getRewardAmount(day: number) {
        if (day === 30) return 1000;
        if (day % 5 === 0) return 250;
        return 50 + (Math.floor((day - 1) / 5) * 10);
    }

    function getWaitTimeStr(hoursPassed: number) {
        const totalHoursCooldown = 20;
        const hoursRemaining = totalHoursCooldown - hoursPassed;

        if (hoursRemaining <= 0) return translate('casino.status_ready');

        const h = Math.floor(hoursRemaining);
        const m = Math.floor((hoursRemaining - h) * 60);

        const hStr = translate('casino.time_h');
        const mStr = translate('casino.time_m');

        if (h > 0) {
            return `${h}${hStr} ${m}${mStr}`;
        } else {
            return `${m} ${mStr}`;
        }
    }

    onMount(() => {
        sounds.ambient = new Howl({ src: ['/sounds/ambient_casino.mp3'], loop: true, volume: 0.3, autoplay: true });
        loadLeaderboard();
        return () => {
            sounds.ambient?.stop();
        };
    });

    async function loadLeaderboard() {
        loadingLeaderboard = true;
        try {
            const functions = getFunctions();
            const getLeaderboardFunc = httpsCallable(functions, 'getLeaderboard');
            const result = await getLeaderboardFunc();
            leaderboard = (result.data as any).data;
        } catch (error) {
            console.error(error);
        } finally {
            loadingLeaderboard = false;
        }
    }

    async function claimDailyBonus() {
        loadingBonus = true;
        try {
            const functions = getFunctions();
            const getDailyBonusFunc = httpsCallable(functions, 'getDailyBonus');
            const result = await getDailyBonusFunc();
            const data = (result.data as any).data;

            userStore.update(store => {
                if (store.user) {
                    store.user.casino_credits = data.new_balance;
                    store.user.last_daily_bonus = new Date();
                    store.user.daily_streak = data.streak;
                    if (data.special_reward) {
                        store.user.owned_items = [...(store.user.owned_items || []), data.special_reward];
                    }
                }
                return store;
            });

            modal.success(translate('casino.bonus_success'), data.message);
            loadLeaderboard();

        } catch (error: any) {
            if (error.message && error.message.includes('Ждите')) {
                 modal.info("Cooldown", error.message);
            } else {
                 modal.error(translate('ui.error'), error.message || "Error claiming bonus.");
            }
        } finally {
            loadingBonus = false;
        }
    }
</script>

<svelte:head>
    <title>{$t('nav.casino')} | ProtoMap</title>
</svelte:head>

<div class="page-container">
    <div class="bg-blur-1"></div>
    <div class="bg-blur-2"></div>

    <div class="header">
        <h1 class="title font-display glitch" data-text={$t('nav.casino')}>{$t('nav.casino')}</h1>
        <p class="subtitle">{$t('casino.subtitle')}</p>
    </div>

    {#if $userStore.user}
        <div class="user-panel">
            <div class="balance-display">
                <span class="label font-display">{$t('casino.balance')}</span>
                <span class="amount font-display">{Math.floor($displayedCredits)} PC</span>
            </div>

            <div class="actions-group">
                <a href="/casino/shop" class="panel-btn shop">{$t('casino.shop')}</a>
                <a href="/casino/inventory" class="panel-btn inventory">{$t('casino.inventory')}</a>
            </div>
        </div>

        <div class="calendar-wrapper">
            <div class="calendar-header">
                <h3 class="cal-title">{$t('casino.calendar_title')}</h3>
                {#if isReset}
                    <span class="status-badge reset">{$t('casino.status_reset')}</span>
                {:else if !isAvailable}
                    <span class="status-badge wait">{$t('casino.status_wait')} {getWaitTimeStr(hoursSinceLast)}</span>
                {:else}
                    <span class="status-badge ready">{$t('casino.status_ready')}</span>
                {/if}
            </div>

            <div class="calendar-grid">
                {#each Array(30) as _, i}
                    {@const dayNum = i + 1}
                    {@const amount = getRewardAmount(dayNum)}
                    {@const isClaimed = !isReset && dayNum <= currentStreak}
                    {@const isActive = dayNum === nextDayIndex}
                    {@const hasFrame = $userStore.user.owned_items?.includes('frame_ludoman')}

                    <button
                        class="day-cell"
                        class:claimed={isClaimed}
                        class:active={isActive}
                        class:big-reward={dayNum === 30}
                        class:milestone={dayNum % 5 === 0 && dayNum !== 30}
                        disabled={dayNum !== nextDayIndex || !isAvailable || loadingBonus}
                        on:click={() => { if (dayNum === nextDayIndex) claimDailyBonus(); }}
                    >
                        <div class="day-num">{$t('casino.day_short')} {dayNum}</div>

                        {#if isClaimed}
                            <div class="check-icon">✔</div>
                        {:else}
                            {#if dayNum !== 30}
                                <div class="reward-val">{amount}</div>
                            {:else}
                                <div class="final-reward-content" class:only-credits={hasFrame}>
                                    <div class="reward-text">
                                        <div class="val">{amount} PC</div>
                                        {#if !hasFrame}
                                            <div class="label">TRUE GAMBLER</div>
                                        {:else}
                                            <div class="label">JACKPOT</div>
                                        {/if}
                                    </div>
                                    {#if !hasFrame}
                                        <div class="reward-visual">
                                            <div class="avatar-wrapper-popup frame_ludoman" style="transform: scale(1.1);">
                                                <img
                                                    src={$userStore.user.avatar_url || `https://api.dicebear.com/7.x/bottts-neutral/svg?seed=${$userStore.user.username}`}
                                                    alt="Reward Preview"
                                                    class="popup-avatar"
                                                />
                                            </div>
                                        </div>
                                    {/if}
                                </div>
                            {/if}
                        {/if}

                        {#if isActive && isAvailable}
                            <div class="pulse-border"></div>
                        {/if}
                    </button>
                {/each}
            </div>
        </div>

        <div class="games-grid">
            <!-- COIN FLIP -->
            <a href="/casino/coin-flip" class="game-card">
                <div class="game-art">
                    <img src="/casino/OaR.png" alt="Coin Flip" class="art-img">
                    <div class="art-overlay"></div>
                </div>
                <div class="game-info">
                    <h3 class="game-title font-display">{$t('casino.game_coin_title')}</h3>
                    <p class="game-desc">{$t('casino.game_coin_desc')}</p>
                    <span class="play-indicator font-display">{$t('casino.play')}</span>
                </div>
            </a>

            <!-- SLOTS (ONLINE) -->
            <a href="/casino/slot-machine" class="game-card">
                <div class="game-art">
                     <!-- Можно добавить бейджик NEW, если хочешь привлечь внимание -->
                     <img src="/casino/slots.png" alt="Slots" class="art-img">
                     <div class="art-overlay"></div>
                </div>
                <div class="game-info">
                    <h3 class="game-title font-display">{$t('casino.game_slots_title')}</h3>
                    <p class="game-desc">{$t('casino.game_slots_desc')}</p>
                    <span class="play-indicator font-display">{$t('casino.play')}</span>
                </div>
            </a>

            <!-- CRASH (DATA UPLINK) -->
            <a href="/casino/crash" class="game-card">
                <div class="game-art">
                     <img src="/casino/crash.png" alt="Crash" class="art-img">
                     <div class="art-overlay"></div>
                </div>
                <div class="game-info">
                    <h3 class="game-title font-display">{$t('casino.game_crash_title')}</h3>
                    <p class="game-desc">{$t('casino.game_crash_desc')}</p>
                    <span class="play-indicator font-display">{$t('casino.play')}</span>
                </div>
            </a>
        </div>

        <div class="leaderboard-section mt-12 max-w-3xl w-full mx-auto">
            <div class="leaderboard-header">
                <h2 class="font-display text-2xl text-cyber-yellow">{$t('casino.leaderboard_title')}</h2>
                <button class="refresh-btn" on:click={loadLeaderboard} disabled={loadingLeaderboard} title="Refresh">
                    <svg class:animate-spin={loadingLeaderboard} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" /></svg>
                </button>
            </div>

            <div class="leaderboard-list cyber-panel">
                {#if loadingLeaderboard && leaderboard.length === 0}
                    <div class="p-8 text-center text-gray-500 animate-pulse">
                        {$t('casino.leaderboard_loading')}
                    </div>
                {:else}
                    {#each leaderboard as player, i (player.username)}
                        <div class="leader-row" class:top-1={i===0} class:top-2={i===1} class:top-3={i===2} transition:slide|local>
                            <div class="rank font-display">#{i + 1}</div>

                            <div class="player-info">
                                <div class="avatar-wrapper-popup {player.equipped_frame || ''} mr-3">
                                    <img
                                        src={player.avatar_url || `https://api.dicebear.com/7.x/bottts-neutral/svg?seed=${player.username}`}
                                        alt={player.username}
                                        class="popup-avatar"
                                    />
                                </div>
                                <a href="/profile/{player.username}" class="username hover:underline">{player.username}</a>
                            </div>

                            <div class="credits font-display">
                                {player.casino_credits.toLocaleString()} PC
                            </div>
                        </div>
                    {/each}
                    {#if leaderboard.length === 0 && !loadingLeaderboard}
                         <div class="p-8 text-center text-gray-500">{$t('casino.leaderboard_empty')}</div>
                    {/if}
                {/if}
            </div>
        </div>

    {:else}
        <div class="guest-panel" in:fade>
            <p class="guest-text">{$t('casino.guest_text')}</p>
            <a href="/login" class="login-btn font-display">{$t('casino.guest_btn')}</a>
        </div>
    {/if}
</div>

<style>
    @keyframes float-blur-1 { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(100px, 50px); } }
    @keyframes float-blur-2 { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(-80px, -60px); } }
    @keyframes glitch-text { 0% { text-shadow: 2px 0 #ff00c1, -2px 0 #01ffff; } 25% { text-shadow: -2px 0 #ff00c1, 2px 0 #01ffff; } 50% { text-shadow: 2px 0 #01ffff, -2px 0 #ff00c1; } 100% { text-shadow: 2px 0 #ff00c1, -2px 0 #01ffff; } }
    @keyframes card-hover-glow {
        from { box-shadow: 0 0 20px rgba(255, 255, 255, 0); border-color: rgba(255, 255, 255, 0.2); }
        to { box-shadow: 0 0 40px var(--glow-color, #fff); border-color: var(--glow-color, #fff); }
    }
    @keyframes pulse-border-anim {
        0% { opacity: 1; transform: scale(1); }
        100% { opacity: 0; transform: scale(1.1); }
    }
    @keyframes pulse-green { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    .page-container {
        min-height: calc(100vh - 64px);
        display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
        position: relative; overflow: hidden; background: #0a0a0a; padding: 2rem;
    }
    .bg-blur-1, .bg-blur-2 { position: absolute; width: 400px; height: 400px; border-radius: 50%; filter: blur(150px); pointer-events: none; z-index: 0; }
    .bg-blur-1 { background: var(--cyber-purple); top: 10%; left: 10%; animation: float-blur-1 20s infinite ease-in-out; }
    .bg-blur-2 { background: var(--cyber-yellow); bottom: 10%; right: 10%; animation: float-blur-2 25s infinite ease-in-out; }

    .header { text-align: center; margin-bottom: 3rem; position: relative; z-index: 2; }
    .title { font-size: 4rem; color: #fff; text-shadow: 0 0 15px #fff; }
    .subtitle { color: var(--text-muted-color); font-family: 'Chakra Petch', monospace; }

    .user-panel {
        width: 100%; max-width: 900px;
        display: flex; justify-content: space-between; align-items: flex-start;
        background: rgba(20, 20, 25, 0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 1rem;
        padding: 1rem 1.5rem; margin-bottom: 3rem;
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); z-index: 2;
        gap: 1rem;
    }
    .balance-display { font-size: 1.5rem; flex-shrink: 0; margin-top: 0.5rem; }
    .balance-display .label { color: var(--text-muted-color); margin-right: 0.5rem; }
    .balance-display .amount { color: var(--cyber-yellow); letter-spacing: 0.1em; }

    .actions-group { display: flex; gap: 1rem; flex-wrap: wrap; justify-content: flex-end; width: 100%; }
    .panel-btn {
        padding: 0.75rem 1.5rem;
        font-family: 'Chakra Petch', monospace;
        font-weight: bold;
        color: rgba(255, 255, 255, 0.8); text-transform: uppercase; letter-spacing: 0.05em; text-decoration: none; text-align: center;
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
        border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 0.75rem;
        box-shadow: -4px -4px 8px rgba(255, 255, 255, 0.05), 4px 4px 8px rgba(0, 0, 0, 0.3), inset 1px 1px 1px rgba(255, 255, 255, 0.1);
        transition: all 0.2s ease-in-out; white-space: nowrap;
        height: fit-content;
    }
    .panel-btn:hover:not(:disabled) { color: #fff; transform: translateY(-2px); }
    .panel-btn:active:not(:disabled) { transform: translateY(1px); box-shadow: inset 2px 2px 5px rgba(0,0,0,0.5); }
    .panel-btn.shop:hover:not(:disabled) { box-shadow: -4px -4px 8px rgba(255, 255, 255, 0.05), 4px 4px 8px rgba(0, 0, 0, 0.3), inset 1px 1px 1px rgba(255, 255, 255, 0.1), 0 0 20px var(--cyber-yellow); }
    .panel-btn.inventory:hover:not(:disabled) { box-shadow: -4px -4px 8px rgba(255, 255, 255, 0.05), 4px 4px 8px rgba(0, 0, 0, 0.3), inset 1px 1px 1px rgba(255, 255, 255, 0.1), 0 0 20px var(--cyber-cyan); }
    .panel-btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

    .calendar-wrapper {
        width: 100%; max-width: 900px;
        background: rgba(10, 15, 20, 0.8);
        border: 1px solid rgba(0, 243, 255, 0.2);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        position: relative; z-index: 5;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .cal-title { font-family: 'Chakra Petch', monospace; font-weight: bold; color: #fff; letter-spacing: 0.1em; }

    .status-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; font-weight: bold; font-family: 'Inter', sans-serif; }
    .status-badge.ready { background: rgba(57, 255, 20, 0.2); color: #39ff14; border: 1px solid #39ff14; animation: pulse-green 2s infinite; }
    .status-badge.wait { background: rgba(255, 255, 255, 0.1); color: #aaa; border: 1px solid #555; }
    .status-badge.reset { background: rgba(255, 0, 60, 0.2); color: #ff003c; border: 1px solid #ff003c; }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: 0.5rem;
    }

    .day-cell {
        background: rgba(255,255,255,0.03);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 6px;
        height: 70px;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        position: relative;
        transition: all 0.2s;
        cursor: default;
        overflow: hidden;
    }

    .day-num { font-size: 0.6rem; color: #555; position: absolute; top: 4px; left: 6px; font-family: 'Chakra Petch', monospace; z-index: 20; }
    .reward-val { font-size: 0.9rem; font-weight: bold; color: #ccc; }

    .day-cell.claimed {
        background: rgba(0, 243, 255, 0.1);
        border-color: rgba(0, 243, 255, 0.3);
        color: #00f3ff;
    }
    .check-icon { color: #00f3ff; font-size: 1.2rem; }

    .day-cell.active {
        background: rgba(255,255,255,0.1);
        border-color: #fff;
        cursor: pointer;
    }
    .day-cell.active:hover { transform: translateY(-2px); background: rgba(255,255,255,0.15); }
    .day-cell.active .reward-val { color: #fff; }

    .day-cell:disabled { pointer-events: none; }
    .day-cell.active:not(:disabled) { cursor: pointer; pointer-events: auto; }

    .day-cell.milestone { border-color: var(--cyber-yellow); }
    .day-cell.milestone .reward-val { color: var(--cyber-yellow); }

    .day-cell.big-reward {
        grid-column: span 2;
        background: radial-gradient(circle, rgba(255, 215, 0, 0.1), transparent);
        border: 1px solid #ffd700;
        display: flex;
        flex-direction: row;
        align-items: center;
        padding: 0 10px;
        justify-content: space-between;
    }

    .final-reward-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        height: 100%;
        padding-top: 12px;
    }

    .final-reward-content.only-credits {
        justify-content: center;
        text-align: center;
    }

    .reward-text {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        justify-content: center;
        z-index: 10;
        min-width: 0;
    }

    .final-reward-content.only-credits .reward-text {
        align-items: center;
    }

    .reward-text .val {
        font-size: 1rem;
        color: #ffd700;
        font-weight: 800;
        line-height: 1.1;
        text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        white-space: nowrap;
    }

    .reward-text .label {
        font-size: 0.6rem;
        font-weight: bold;
        color: #fff;
        margin-top: 2px;
    }

    .reward-text .sub-label {
        font-size: 0.5rem;
        color: #aaa;
        font-family: 'Chakra Petch', monospace;
        margin-top: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 80px;
    }

    .reward-visual {
        flex-shrink: 0;
        margin-left: 5px;
        z-index: 10;
    }

    .pulse-border {
        position: absolute; inset: -1px; border-radius: 6px;
        border: 2px solid #39ff14;
        animation: pulse-border-anim 1.5s infinite;
        pointer-events: none;
    }

    .games-grid {
        width: 100%; max-width: 900px;
        display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 2rem; z-index: 2;
    }
    .game-card {
        background: rgba(20, 20, 25, 0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 1rem;
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        display: flex; flex-direction: column; overflow: hidden;
        text-decoration: none; color: inherit;
        transition: transform 0.3s, border-color 0.3s, box-shadow 0.3s;
        position: relative;
    }
    .game-card:hover { transform: translateY(-10px); --glow-color: var(--cyber-yellow); animation: card-hover-glow 0.5s forwards; }
    .game-card.disabled { pointer-events: none; filter: grayscale(0.8) brightness(0.5); }

    .game-art { height: 200px; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
    .art-img { width: 100%; height: 100%; object-fit: cover; }
    .art-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: linear-gradient(to top, rgba(10,10,10,0.8) 0%, transparent 50%); transition: background 0.3s;
    }
    .game-card:hover .art-overlay { background: linear-gradient(to top, rgba(20,20,25,1) 0%, transparent 70%); }

    .new-badge {
        position: absolute; top: 10px; right: 10px;
        background: #ff003c; color: #fff;
        font-family: 'Chakra Petch', monospace; font-weight: 900; font-size: 0.8rem;
        padding: 2px 8px; border-radius: 4px;
        box-shadow: 0 0 10px #ff003c;
        z-index: 10;
        animation: pulse-red 2s infinite;
    }
    @keyframes pulse-red { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

    .game-info { padding: 1.5rem; display: flex; flex-direction: column; flex-grow: 1; }
    .game-title { font-size: 1.75rem; color: #fff; margin-bottom: 0.5rem; }
    .game-desc { color: var(--text-muted-color); line-height: 1.6; margin-bottom: 1.5rem; flex-grow: 1; }
    .play-indicator { display: block; text-align: right; color: var(--cyber-yellow); font-weight: bold; transition: letter-spacing 0.3s; }
    .game-card:hover .play-indicator { letter-spacing: 0.1em; }

    .guest-panel { text-align: center; padding: 4rem 2rem; background: rgba(20, 20, 25, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 1rem; z-index: 2; }
    .guest-text { margin-bottom: 1.5rem; font-size: 1.2rem; }
    .login-btn { display: inline-block; padding: 0.75rem 2rem; background: var(--cyber-yellow); color: #000; text-decoration: none; }
    .glitch { position: relative; }
    .glitch::before, .glitch::after { content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: transparent; overflow: hidden; }
    .glitch::before { text-shadow: -2px 0 #ff00c1; left: 2px; animation: glitch-text 2s infinite linear alternate-reverse; }
    .glitch::after { text-shadow: 2px 0 var(--cyber-cyan); left: -2px; animation: glitch-text 2s 0.2s infinite linear alternate-reverse; }

    .leaderboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .refresh-btn { color: var(--text-muted-color); transition: color 0.2s; }
    .refresh-btn:hover { color: #fff; }

    .leaderboard-list {
        background: rgba(10, 10, 15, 0.6) !important;
        max-height: 500px;
        overflow-y: auto;
        border-radius: 0.5rem;
    }

    .leader-row {
        display: flex; align-items: center; justify-content: space-between;
        padding: 1rem;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        transition: background 0.2s;
    }
    .leader-row:hover { background: rgba(255,255,255,0.05); }

    .rank { width: 40px; font-size: 1.2rem; color: #666; font-weight: bold; }
    .player-info { display: flex; align-items: center; flex-grow: 1; }
    .username { color: #eee; font-weight: 500; }
    .credits { color: var(--cyber-cyan); font-weight: bold; }

    .top-1 .rank { color: #ffd700; text-shadow: 0 0 10px #ffd700; font-size: 1.5rem; }
    .top-1 .username { color: #ffd700; }
    .top-1 .popup-avatar { border: 2px solid #ffd700; }

    .top-2 .rank { color: #c0c0c0; text-shadow: 0 0 8px #c0c0c0; font-size: 1.4rem; }
    .top-2 .username { color: #c0c0c0; }

    .top-3 .rank { color: #cd7f32; text-shadow: 0 0 8px #cd7f32; font-size: 1.3rem; }
    .top-3 .username { color: #cd7f32; }

    @media (max-width: 920px) {
        .games-grid { grid-template-columns: 1fr; max-width: 450px; }
    }
    @media (max-width: 768px) {
        .title { font-size: 3rem; }
        .user-panel {
            flex-direction: column;
            gap: 1.5rem;
            align-items: stretch;
            text-align: center;
        }
        .actions-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
        }
        .panel-btn {
            font-size: 0.8rem;
            padding: 0.6rem 0.5rem;
            flex: 1 1 auto;
            min-width: 90px;
        }
    }

    @media (max-width: 640px) {
        .calendar-grid { grid-template-columns: repeat(5, 1fr); }
        .day-cell { height: 60px; }
        .day-cell.big-reward { grid-column: span 5; }
    }
</style>
</file>

<file path="src/routes/profile/[username]/+page.server.ts">
import { firestoreAdmin } from '$lib/server/firebase.admin';
import { error, redirect } from '@sveltejs/kit';
import type { PageServerLoad } from './$types';
import { FieldPath } from 'firebase-admin/firestore';

export type Comment = {
    id: string;
    text: string;
    author_uid: string;
    author_username: string;
    author_avatar_url: string;
    author_equipped_frame: string | null;
    createdAt: Date;
    likes: string[];
    parentId: string | null;
    replies?: Comment[];
};

function isDomainInUrl(url: string, domain: string): boolean {
    try {
        const urlObj = new URL(url);
        return urlObj.hostname.endsWith(domain) || urlObj.hostname === domain;
    } catch {
        return false;
    }
}

function isSafeUrl(url: string): boolean {
    if (!url) return false;

    const lower = url.toLowerCase().trim();

    if (!lower.match(/^https?:\/\//)) {
        return false;
    }

    if (lower.includes('javascript:') ||
        lower.includes('data:') ||
        lower.includes('vbscript:') ||
        lower.includes('file:')) {
        return false;
    }

    return true;
}

function getAbsoluteImageUrl(avatarUrl: string | null | undefined, username: string): string {
    if (!avatarUrl) {
        return `https://api.dicebear.com/7.x/bottts-neutral/svg?seed=${encodeURIComponent(username)}`;
    }

    if (!isSafeUrl(avatarUrl)) {
        return `https://api.dicebear.com/7.x/bottts-neutral/svg?seed=${encodeURIComponent(username)}`;
    }

    if (isDomainInUrl(avatarUrl, 'cloudinary.com')) {
        const parts = avatarUrl.split('/upload/');
        if (parts.length === 2 && parts[0] && parts[1]) {
            return `${parts[0]}/upload/f_auto,q_auto,w_1200,h_1200,c_fill,g_face/${parts[1]}`;
        }
    }

    if (isDomainInUrl(avatarUrl, 'googleusercontent.com')) {
        const parts = avatarUrl.split('=');
        if (parts.length > 0) {
            return parts[0] + '=s1200-c';
        }
    }

    return avatarUrl;
}

export const load: PageServerLoad = async ({ params, setHeaders }) => {
    const username = params.username;
    const usersRef = firestoreAdmin.collection('users');
    const userSnapshot = await usersRef.where('username', '==', username).limit(1).get();

    if (userSnapshot.empty) {
        throw error(404, 'Профиль не найден');
    }

    const userProfileDoc = userSnapshot.docs[0];
    const userProfileData = userProfileDoc.data();

    // ✅ [ЭТАП 4] 301 редирект: /profile/username -> /u/uid
    // Постоянный редирект — поисковики обновят индекс на новый URL
    throw redirect(301, `/u/${userProfileDoc.id}`);

    const commentsRef = userProfileDoc.ref.collection('comments').orderBy('createdAt', 'desc').limit(50);
    const commentsSnapshot = await commentsRef.get();

    const rawComments: Comment[] = commentsSnapshot.docs.map(doc => {
        const data = doc.data();
        return {
            id: doc.id,
            text: data.text || '',
            author_uid: data.author_uid || '',
            author_username: data.author_username || 'Аноним',
            author_avatar_url: data.author_avatar_url || '',
            author_equipped_frame: data.author_equipped_frame || null,
            createdAt: data.createdAt?.toDate() || new Date(),
            likes: data.likes || [],
            parentId: data.parentId || null,
            replies: []
        };
    });

    const authorUids = [...new Set(rawComments.map(c => c.author_uid).filter(Boolean))];
    const authorsData = new Map<string, any>();

    if (authorUids.length > 0) {
        for (let i = 0; i < authorUids.length; i += 30) {
            const chunk = authorUids.slice(i, i + 30);
            const snaps = await firestoreAdmin.collection('users')
                .where(FieldPath.documentId(), 'in', chunk)
                .get();
            snaps.forEach(d => authorsData.set(d.id, d.data()));
        }
    }

    const commentMap = new Map<string, Comment>();
    const rootComments: Comment[] = [];

    rawComments.forEach(c => {
        const freshAuthor = authorsData.get(c.author_uid);
        if (freshAuthor) {
            c.author_username = freshAuthor.username;
            c.author_avatar_url = freshAuthor.avatar_url;
            c.author_equipped_frame = freshAuthor.equipped_frame;
        }
        commentMap.set(c.id, c);
    });

    rawComments.forEach(c => {
        if (c.parentId && commentMap.has(c.parentId)) {
            const parent = commentMap.get(c.parentId)!;
            parent.replies?.push(c);
        } else {
            rootComments.push(c);
        }
    });

    rootComments.forEach(root => {
        if (root.replies && root.replies.length > 0) {
            root.replies.sort((a, b) => a.createdAt.getTime() - b.createdAt.getTime());
        }
    });

    const seoData = {
        title: `${userProfileData.username} | ProtoMap`,
        description: userProfileData.status
            ? `${userProfileData.status}`
            : (userProfileData.about_me?.substring(0, 150) || `Профиль пользователя ${userProfileData.username} на карте протогенов ProtoMap`),
        image: getAbsoluteImageUrl(userProfileData.avatar_url, userProfileData.username),
        url: `https://proto-map.vercel.app/u/${userProfileDoc.id}`,  // [ЭТАП 3] Canonical теперь по uid
        type: 'profile'
    };

    setHeaders({ 'Cache-Control': 'public, max-age=60' });

    return {
        profile: {
            uid: userProfileDoc.id,
            username: userProfileData.username,
            avatar_url: userProfileData.avatar_url,
            about_me: userProfileData.about_me,
            status: userProfileData.status || null,
            socials: userProfileData.socials || {},
            equipped_frame: userProfileData.equipped_frame || null,
            equipped_bg: userProfileData.equipped_bg || null
        },
        comments: rootComments,
        seoData
    };
};
</file>

<file path="src/lib/client/mapLogic.ts">
import L from 'leaflet';
import 'leaflet.markercluster';
import { auth } from '$lib/firebase';
import { userStore, type UserProfile } from '$lib/stores';
import { getFunctions, httpsCallable } from "firebase/functions";
import { modal } from '$lib/stores/modalStore';
import { AudioManager } from '$lib/client/audioManager';

type MarkerUserData = {
    username: string;
    uid?: string | null;        // [ЭТАП 3] UID для ссылки на профиль
    avatar_url: string;
    status?: string | null;
    equipped_frame?: string | null;
};

function createCyberPopup(userData: MarkerUserData, city: string, isOwner: boolean): string {
    // [ЭТАП 3] Используем uid-based URL если доступен
    const profileUrl = userData.uid
        ? `/u/${userData.uid}`
        : `/profile/${encodeURIComponent(userData.username.trim())}`;
    const defaultAvatar = `https://api.dicebear.com/7.x/bottts-neutral/svg?seed=${encodeURIComponent(userData.username.trim())}`;

    const frameClass = userData.equipped_frame || '';
    const avatarImg = `
        <div class="avatar-wrapper-popup ${frameClass}">
            <img src="${userData.avatar_url || defaultAvatar}" alt="Avatar" class="popup-avatar" onerror="this.onerror=null; this.src='${defaultAvatar}';"/>
        </div>
    `;

    const statusHTML = userData.status
        ? `<p class="popup-status">"${escapeHtml(userData.status)}"</p>`
        : '<p class="popup-status-empty">//: Статус не установлен</p>';

    const signalStrength = 90 + Math.floor(Math.random() * 10);
    const zoneStatus = ["СТАБИЛЬНО", "СИНХРОНИЗАЦИЯ", "НОРМА"][Math.floor(Math.random() * 3)];

    const deleteButtonHTML = isOwner
        ? `<button class="popup-delete-btn" data-username="${escapeHtml(userData.username)}">Удалить</button>`
        : '';

    const html = `
        <div class="liquid-glass-popup">
            <div class="popup-header">
                ${avatarImg}
                <span class="popup-username">${escapeHtml(userData.username)}</span>
            </div>

            ${statusHTML}

            <div class="location-data">
                <div class="data-item">
                    <span class="data-label">ЛОКАЦИЯ</span>
                    <span class="data-value">${escapeHtml(city)}</span>
                </div>
                <div class="data-item">
                    <span class="data-label">СИГНАЛ</span>
                    <span class="data-value">${signalStrength}%</span>
                </div>
                <div class="data-item">
                    <span class="data-label">СТАТУС ЗОНЫ</span>
                    <span class="data-value text-green-400">${zoneStatus}</span>
                </div>
            </div>

            <div class="popup-actions">
                <a href="${profileUrl}" target="_blank" class="popup-profile-btn">Профиль</a>
                ${deleteButtonHTML}
            </div>
        </div>
    `;
    return html;
}

function escapeHtml(unsafe: string): string {
    return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}

function createUserAvatarIcon(userData: MarkerUserData): L.DivIcon {
    const defaultAvatar = `https://api.dicebear.com/7.x/bottts-neutral/svg?seed=${encodeURIComponent(userData.username.trim())}`;
    const imageUrl = userData.avatar_url || defaultAvatar;
    const iconSize = 38;

    const frameClass = userData.equipped_frame || '';
    const iconHtml = `<div class="user-avatar-marker ${frameClass}" style="width: ${iconSize}px; height: ${iconSize}px;"><img src="${imageUrl}" alt="Аватар ${userData.username}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; background-color: #333;" onerror="this.onerror=null; this.src='${defaultAvatar}';"/></div>`;

    return L.divIcon({ html: iconHtml, className: 'custom-leaflet-div-icon', iconSize: [iconSize, iconSize], iconAnchor: [iconSize / 2, iconSize], popupAnchor: [0, -42] });
}

function clearClientCache() {
    localStorage.removeItem('protomap_markers_cache');
    localStorage.removeItem('protomap_markers_time');
}

export function initMap(containerId: string) {
    let currentUserProfile: UserProfile | null = null;

    const southWest = L.latLng(-90, -180);
    const northEast = L.latLng(90, 180);
    const bounds = L.latLngBounds(southWest, northEast);

    const map = L.map(containerId, {
        center: [54.5, 30.0],
        zoom: 4,
        minZoom: 2,
        maxBounds: bounds,
        maxBoundsViscosity: 1.0,
        preferCanvas: true,
        zoomAnimation: true,
    });

    if (map.attributionControl) {
        map.attributionControl.setPrefix(false);
    }

    const baseLayers: { [key: string]: L.TileLayer } = {
        "Стандартная": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OSM' }),
        "Полночь": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OSM', className: 'map-black' }),
        "Тёмная": L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 20, attribution: '© CARTO' }),
        "Синий неон": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OSM', className: 'matrix-tiles' }),
    };
    const storageKey = 'protomap-selected-theme';
    let savedLayerName = "Тёмная";

    try {
        const storedName = localStorage.getItem(storageKey);
        if (storedName && baseLayers[storedName]) {
            savedLayerName = storedName;
        }
    } catch (e) {
        console.error("Не удалось получить доступ к localStorage", e);
    }

    baseLayers[savedLayerName].addTo(map);

    let layersControl: L.Control.Layers | null = null;

    setTimeout(() => {
        if (map && map.getContainer()) {
            layersControl = L.control.layers(baseLayers).addTo(map);

            map.on('baselayerchange', function (e: L.LayersControlEvent) {
                try {
                    localStorage.setItem(storageKey, e.name);
                } catch (error) {
                    console.error("Не удалось сохранить тему карты в localStorage", error);
                }
            });

            const controlContainer = layersControl.getContainer();
            if (controlContainer) {
                controlContainer.classList.add('cyber-layers-control');
                setTimeout(() => {
                    const inputs = controlContainer.querySelectorAll('.leaflet-control-layers-base input[type="radio"]');
                    inputs.forEach(input => {
                        const nextElement = input.nextElementSibling;
                        if (nextElement && nextElement.tagName === 'SPAN') {
                            nextElement.classList.add('custom-radio-span');
                        }
                    });
                }, 0);
            }
        }
    }, 100);

    const createClusterIcon = function (cluster: L.MarkerCluster) {
        const count = cluster.getChildCount();
        let sizeClass = 'small';
        if (count >= 10) sizeClass = 'medium';
        if (count >= 50) sizeClass = 'large';
        const chargeAngle = Math.round((Math.min(count, 100) / 100) * 360);
        const html = `<div class="reactor-cluster ${sizeClass}"><div class="reactor-glow"></div><div class="reactor-ring outer"></div><div class="reactor-ring middle"></div><div class="reactor-charge-indicator" style="--charge-angle: ${chargeAngle}deg;"></div><div class="reactor-core"><span class="count">${count}</span></div><div class="particle p1"></div><div class="particle p2"></div><div class="particle p3"></div><div class="particle p4"></div></div>`;
        return L.divIcon({ html: html, className: 'custom-cluster-icon-wrapper', iconSize: L.point(80, 80, true) });
    };

    const markers = L.markerClusterGroup({
        iconCreateFunction: createClusterIcon,
        showCoverageOnHover: false
    });
    map.addLayer(markers);

    const userMarkers: { [key: string]: L.Marker } = {};

    function createMarkerLayer(userData: MarkerUserData, lat: number, lng: number, city: string): L.Marker {
        const isOwner = currentUserProfile?.username?.trim() === userData.username.trim();
        const popupContent = createCyberPopup(userData, city, isOwner);
        const customUserIcon = createUserAvatarIcon(userData);

        let popupOptions: L.PopupOptions = { autoPan: true };

        if (lat > 80) {
            popupOptions = {
                offset: [0, 340],
                className: 'popup-inverted',
                autoPan: true
            };
        }

        return L.marker([lat, lng], { icon: customUserIcon }).bindPopup(popupContent, popupOptions);
    }

    function addOrUpdateMarker(userData: MarkerUserData, lat: number, lng: number, city: string): void {
        const usernameKey = userData.username.trim();

        if (userMarkers[usernameKey]) {
            const marker = userMarkers[usernameKey];
            const customUserIcon = createUserAvatarIcon(userData);
            const isOwner = currentUserProfile?.username?.trim() === userData.username.trim();
            const popupContent = createCyberPopup(userData, city, isOwner);

            let popupOptions: L.PopupOptions = { autoPan: true };
            if (lat > 80) {
                popupOptions = { offset: [0, 340], className: 'popup-inverted', autoPan: true };
            }

            marker.setLatLng([lat, lng]).setIcon(customUserIcon);
            marker.unbindPopup();
            marker.bindPopup(popupContent, popupOptions);
        } else {
            const newMarker = createMarkerLayer(userData, lat, lng, city);
            markers.addLayer(newMarker);
            userMarkers[usernameKey] = newMarker;
        }
    }

    function renderMarkers(locations: any[]) {
        markers.clearLayers();
        Object.keys(userMarkers).forEach(key => delete userMarkers[key]);

        const batchMarkers: L.Marker[] = [];

        locations.forEach((loc) => {
            if (loc.user && loc.user.username && typeof loc.lat === 'number' && typeof loc.lng === 'number') {
                const usernameKey = loc.user.username.trim();

                if (userMarkers[usernameKey]) {
                    console.warn(`[Map] Duplicate signal detected for: ${usernameKey}. Ignoring echo.`);
                    return;
                }

                const marker = createMarkerLayer(loc.user, loc.lat, loc.lng, loc.city);
                userMarkers[usernameKey] = marker;
                batchMarkers.push(marker);
            }
        });

        if (batchMarkers.length > 0) {
            markers.addLayers(batchMarkers);
        }
    }

    async function loadAllMarkers() {
        const CACHE_KEY = 'protomap_markers_cache';
        const CACHE_TIME_KEY = 'protomap_markers_time';
        const CLIENT_CACHE_DURATION = 5 * 60 * 1000;

        try {
            const cachedData = localStorage.getItem(CACHE_KEY);
            const cachedTime = localStorage.getItem(CACHE_TIME_KEY);
            const now = Date.now();

            if (cachedData && cachedTime && (now - parseInt(cachedTime) < CLIENT_CACHE_DURATION)) {
                const locations = JSON.parse(cachedData);
                renderMarkers(locations);
                return;
            }

            const functions = getFunctions();
            const getLocationsFunc = httpsCallable(functions, 'getLocations');
            const result = await getLocationsFunc();
            const locations = result.data as Array<{ user: MarkerUserData, lat: number, lng: number, city: string }>;

            try {
                localStorage.setItem(CACHE_KEY, JSON.stringify(locations));
                localStorage.setItem(CACHE_TIME_KEY, now.toString());
            } catch (e) {
                console.warn("Quota exceeded for localStorage");
            }

            renderMarkers(locations);
        } catch (error) {
            console.error("Ошибка при обработке меток:", error);
        }
    }

    async function sendLocationToServer(lat: number, lng: number, currentUser: UserProfile, isManual: boolean) {
        const geoButton = document.querySelector('.geolocation-button');
        if (geoButton) L.DomUtil.addClass(geoButton, 'loading');
        try {
            const idToken = await auth.currentUser?.getIdToken(true);
            if (!idToken) throw new Error("Не удалось получить токен пользователя.");

            const functions = getFunctions();
            const addOrUpdateLocationFunc = httpsCallable(functions, 'addOrUpdateLocation');
            const result = await addOrUpdateLocationFunc({ lat, lng, isManual });

            const data = result.data as any;
            if (data.status === 'success') {
                const currentUserData: MarkerUserData = {
                    uid: currentUser.uid,   // [ЭТАП 3] uid для popup ссылки
                    username: currentUser.username,
                    avatar_url: currentUser.avatar_url,
                    status: currentUser.status,
                    equipped_frame: currentUser.equipped_frame
                };
                clearClientCache();
                addOrUpdateMarker(currentUserData, data.placeLat, data.placeLng, data.foundCity);
                const trimmedUsernameKey = currentUser.username.trim();
                if (userMarkers[trimmedUsernameKey]) {
                    userMarkers[trimmedUsernameKey].openPopup();
                }
                modal.success("Готово!", data.message || "Ваша метка успешно обновлена!");
            } else {
                throw new Error(data.message || 'Ошибка ответа сервера');
            }
        } catch (error: any) {
            modal.error("Ошибка сохранения", `Не удалось сохранить метку: ${error.message}`);
        } finally {
            if (geoButton) L.DomUtil.removeClass(geoButton, 'loading');
        }
    }

    function setupMapInteraction(currentUser: UserProfile | null) {
        map.off('click');

        if (currentUser) {
            map.on('click', (e: L.LeafletMouseEvent) => {
                const { lat, lng } = e.latlng;
                modal.confirm("Ручная установка", "Установить точное местоположение в этой точке?", () => {
                    sendLocationToServer(lat, lng, currentUser, true);
                });
            });

            if (!(map as any).geocontrol) {
                const GeolocationControl = L.Control.extend({
                    options: { position: 'topleft' as L.ControlPosition },
                    onAdd: function () {
                        const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom geolocation-button');
                        container.title = 'Добавить/Переместить по геолокации';
                        container.innerHTML = '<a href="#" role="button"><i class="fas fa-map-marker-alt"></i></a>';
                        L.DomEvent.on(container, 'click', L.DomEvent.stop).on(container, 'click', () => {
                            if ('geolocation' in navigator) {
                                L.DomUtil.addClass(container, 'loading');
                                navigator.geolocation.getCurrentPosition(
                                    (position) => {
                                        sendLocationToServer(position.coords.latitude, position.coords.longitude, currentUser, false);
                                        L.DomUtil.removeClass(container, 'loading');
                                    },
                                    (geoError) => {
                                        modal.error("Ошибка геолокации", geoError.message);
                                        L.DomUtil.removeClass(container, 'loading');
                                    }
                                );
                            } else {
                                modal.warning("Не поддерживается", "Ваш браузер не поддерживает геолокацию.");
                            }
                        });
                        return container;
                    }
                });
                (map as any).geocontrol = new GeolocationControl();
                map.addControl((map as any).geocontrol);
            }

            markers.on('popupopen', (e: L.LeafletEvent & { popup: L.Popup }) => {
                const popupNode = e.popup._contentNode as HTMLElement;
                const deleteButton = popupNode.querySelector('.popup-delete-btn');
                if (deleteButton && currentUser && currentUser.username) {
                    deleteButton.addEventListener('click', function (this: HTMLButtonElement, ev: MouseEvent) {
                        ev.preventDefault();
                        const usernameToDelete = this.getAttribute('data-username');
                        if (usernameToDelete && usernameToDelete === currentUser.username.trim()) {
                            modal.confirm("Удаление метки", "Вы уверены?", async () => {
                                this.textContent = "Удаление...";
                                this.disabled = true;
                                try {
                                    const functions = getFunctions();
                                    const deleteLocationFunc = httpsCallable(functions, 'deleteLocation');
                                    const result = await deleteLocationFunc();
                                    const data = result.data as any;
                                    if (data.status === 'success') {
                                        clearClientCache();
                                        if (userMarkers[usernameToDelete]) {
                                            markers.removeLayer(userMarkers[usernameToDelete]);
                                            delete userMarkers[usernameToDelete];
                                        }
                                        map.closePopup();
                                        modal.success("Успешно", data.message || "Метка удалена.");
                                    } else {
                                        throw new Error(data.message);
                                    }
                                } catch (delError: any) {
                                    modal.error("Ошибка", `Не удалось удалить метку: ${delError.message}`);
                                }
                            });
                        }
                    }, { once: true });
                }
            });

        } else {
            map.on('click', () => {
                modal.warning("Требуется авторизация", "Пожалуйста, войдите, чтобы добавить свою метку.");
            });
            if ((map as any).geocontrol) {
                map.removeControl((map as any).geocontrol);
                (map as any).geocontrol = null;
            }
        }
    }

    loadAllMarkers();

    // ✅ [FIX] Сохраняем функцию отписки — вызываем в destroy()
    const unsubscribeUserStore = userStore.subscribe((storeValue) => {
        if (storeValue.loading) return;

        // Guard: карта уже уничтожена (компонент размонтирован после goto())
        // Без этого userStore.subscribe вызывает setupMapInteraction на мёртвой карте
        if (!map || !map.getContainer() || !document.body.contains(map.getContainer())) {
            unsubscribeUserStore();
            return;
        }

        currentUserProfile = storeValue.user;
        setupMapInteraction(storeValue.user);
    });

    map.on('popupopen', () => {
        AudioManager.play('popup_open');
    });

    map.on('popupclose', () => {
        AudioManager.play('popup_close');
    });

    // ✅ [FIX] Возвращаем destroy() для вызова в onDestroy компонента
    return {
        map,
        markers,
        destroy: () => {
            unsubscribeUserStore();
            try { map.remove(); } catch (e) { /* already removed */ }
        }
    };
}
</file>

<file path="src/app.css">
@import url('https://fonts.googleapis.com/css2?family=Creepster&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;700;900&family=Inter:wght@400;700&display=swap');

@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
    --bg-color-start: #1f2125;
    --bg-color-end: #101214;
    --primary-color: #00f0ff; /* Старое название для --cyber-cyan */
    --secondary-bg-color: #1a1d21;
    --border-color: #30363d;
    --text-color: #e8e8e8;
    --text-muted-color: #909dab;
    --border-radius: 8px;

    /* --- НОВЫЙ БЛОК: УНИВЕРСАЛЬНАЯ ПАЛИТРА --- */
    /* Здесь мы определяем цвета по умолчанию */
    --cyber-yellow: #fcee0a;
    --cyber-cyan: #00f0ff;
    --cyber-purple: #bd00ff;
    --cyber-green: #39ff14;
    --cyber-red: #ff003c;
    /* --- КОНЕЦ НОВОГО БЛОКА --- */
}

@keyframes gradient-flow {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

body {
    @apply bg-cyber-bg text-gray-200 font-sans;
    background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='4' height='4' viewBox='0 0 4 4'%3E%3Cpath fill='%23ffffff' fill-opacity='0.02' d='M0 2h2v2H0zM2 0h2v2H2z'/%3E%3C/svg%3E"),
        radial-gradient(ellipse at center, rgba(0,0,0,0) 0%, rgba(0,0,0,0.8) 100%);
    background-attachment: fixed;
}

.no-scroll {
    overflow: hidden;
}

.side-panel {
    @apply fixed top-0 h-full w-16 bg-black/20 hidden lg:flex items-center justify-center;
    writing-mode: vertical-rl;
    text-orientation: mixed;
    z-index: 5;
}
.side-panel.left {
    @apply left-1.5;
    border-right: 1px solid var(--border-color);
}
.side-panel.right {
    @apply right-1.5;
    border-left: 1px solid var(--border-color);
}

.v-text {
    @apply uppercase text-xs tracking-widest text-cyber-yellow/50 select-none;
    animation: text-pulse 5s infinite ease-in-out;
}

@keyframes text-pulse {
    0%, 100% { opacity: 0.4; }
    50% { opacity: 0.8; }
}

@media (max-width: 640px) {
    .ui-panel {
        @apply my-4 mx-4 p-6;
    }
}

#map-container, .leaflet-container {
    position: relative;
    z-index: 0;
}

@keyframes light-sweep {
  0% {
    transform: translateY(-100%);
  }
  100% {
    transform: translateY(100%);
  }
}

.cyber-panel {
    position: relative;
    overflow: hidden;
}

.cyber-panel::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 2px;
    height: 100%;
    background: linear-gradient(
        to bottom,
        transparent 0%,
        var(--cyber-yellow, #fcee0a) 50%,
        transparent 100%
    );
    opacity: 0.5;
    animation: light-sweep 4s linear infinite;
    animation-delay: 1s;
}

.cyber-panel::after {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 2px;
    height: 100%;
    background: linear-gradient(
        to bottom,
        transparent 0%,
        var(--cyber-yellow, #fcee0a) 50%,
        transparent 100%
    );
    opacity: 0.5;
    animation: light-sweep 4s linear infinite reverse;
}

.leaflet-popup-content-wrapper {
    background-color: var(--glass-bg, rgba(32, 35, 42, 0.92)) !important;
    color: var(--text-color, #e1e1e1) !important;
    border: 1px solid var(--glass-border, rgba(255, 255, 255, 0.1)) !important;
    border-radius: var(--border-radius, 6px) !important;
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2), 0 0 15px rgba(0, 240, 255, 0.15) !important;
    backdrop-filter: blur(var(--blur-intensity, 8px)) !important;
    -webkit-backdrop-filter: blur(var(--blur-intensity, 8px)) !important;
}

.leaflet-popup-tip-container {
    width: 40px;
    height: 20px;
}
.leaflet-popup-tip {
    background-color: var(--glass-bg, rgba(32, 35, 42, 0.92)) !important;
    border: 1px solid var(--glass-border, rgba(255, 255, 255, 0.1)) !important;
    border-left: none !important;
    border-top: none !important;
    box-shadow: none !important;
    transform: rotate(45deg);
    margin: -1px;
}

.leaflet-popup-content {
    margin: 14px 20px !important;
    line-height: 1.6;
    font-size: 0.95em;
    font-family: 'Inter', sans-serif;
}

.leaflet-popup-content a {
    color: var(--primary-color, #4fc3f7);
    font-weight: 700;
    transition: color 0.2s ease, text-shadow 0.2s ease;
}
.leaflet-popup-content a:hover {
    color: var(--link-hover-color, #ffffff);
    text-shadow: 0 0 5px var(--primary-color, #4fc3f7);
}

.leaflet-popup-close-button {
    color: var(--text-muted-color, #8899a6) !important;
    transition: color 0.2s ease, transform 0.2s ease;
}
.leaflet-popup-close-button:hover {
    color: #fff !important;
    transform: scale(1.2);
}

.delete-marker-btn {
    @apply w-full mt-3 px-3 py-1.5 text-xs uppercase tracking-widest;
    background: transparent;
    border: 1px solid var(--cyber-red, #ff003c);
    color: var(--cyber-red, #ff003c);
    border-radius: var(--border-radius);
    transition: all 0.2s ease-in-out;
}
.delete-marker-btn:hover:not(:disabled) {
    background: var(--cyber-red, #ff003c);
    color: white;
    box-shadow: 0 0 10px var(--cyber-red, #ff003c);
    transform: translateY(-1px);
}
.delete-marker-btn:disabled {
    border-color: #555;
    color: #555;
    background: #222;
    cursor: wait;
}

.leaflet-control-zoom a,
.leaflet-control-custom.geolocation-button a {
    background-color: var(--secondary-bg-color, #20232a) !important;
    color: var(--text-muted-color, #8899a6) !important;
    border-radius: var(--border-radius, 6px) !important;
    border: 1px solid var(--border-color, #30363d) !important;
    width: 34px !important;
    height: 34px !important;
    line-height: 34px !important;
    text-align: center;
    text-decoration: none;
    font-size: 1.3rem;
    font-weight: bold;
    transition: background-color 0.2s ease, color 0.2s ease;
}

.leaflet-control-zoom a:hover,
.leaflet-control-custom.geolocation-button a:hover {
    background-color: var(--border-color, #30363d) !important;
    color: var(--text-color, #e1e1e1) !important;
}

.leaflet-control-zoom {
    border: none !important;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow-soft, 0 4px 6px rgba(0, 0, 0, 0.15));
}
.leaflet-control-zoom a:first-child {
    border-top-left-radius: var(--border-radius);
    border-top-right-radius: var(--border-radius);
}
.leaflet-control-zoom a:last-child {
    border-bottom-left-radius: var(--border-radius);
    border-bottom-right-radius: var(--border-radius);
    border-bottom: none !important;
}

.leaflet-control-custom.geolocation-button i {
    font-size: 16px;
    color: var(--primary-color, #4fc3f7);
    line-height: 32px;
    transition: color 0.2s ease, transform 0.5s ease;
}
.leaflet-control-custom.geolocation-button a:hover i {
     color: var(--link-hover-color, #ffffff);
}

.leaflet-control-custom.geolocation-button.loading a {
    cursor: wait;
    background-color: var(--border-color, #30363d) !important;
}
.leaflet-control-custom.geolocation-button.loading i {
    color: var(--text-muted-color, #8899a6);
    animation: spin 1s linear infinite;
}
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.leaflet-control-custom.geolocation-button {
    margin-top: 10px;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow-soft);
}

.custom-leaflet-div-icon {
    background: transparent !important;
    border: none !important;
}

.user-avatar-marker {
    box-shadow: 0 0 8px rgba(252, 238, 10, 0.7);
    transition: transform 0.2s ease-out;
    border-radius: 50%;
    overflow: hidden;
}

.user-avatar-marker:hover {
    transform: scale(1.1);
}

.cyber-layers-control.leaflet-control-layers {
    background: rgba(10, 10, 10, 0.7);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    border: 1px solid rgba(0, 240, 255, 0.3);
    border-radius: 0;
    box-shadow: 0 0 15px rgba(0, 240, 255, 0.2);
}

.cyber-layers-control.leaflet-control-layers a.leaflet-control-layers-toggle {
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="%2300f0ff"><path d="M10 3.75L2 8.25l8 4.5l8-4.5L10 3.75z" /><path d="M2 10.16V12l8 4.5l8-4.5v-1.84l-8 4.5l-8-4.5z" /><path d="M2 14.66V16l8 4.5l8-4.5v-1.34l-8 4.5l-8-4.5z" /></svg>');
    background-size: 20px 20px;
    width: 36px;
    height: 36px;
}

.cyber-layers-control.leaflet-control-layers-expanded {
    clip-path: polygon(0 5px, 5px 0, 100% 0, 100% calc(100% - 5px), calc(100% - 5px) 100%, 0 100%);
}

.cyber-layers-control .leaflet-control-layers-base {
    background: transparent;
}

.cyber-layers-control .leaflet-control-layers-base label {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    font-family: 'Chakra Petch', sans-serif;
    color: #b0c4de;
    transition: all 0.2s ease-in-out;
}

.cyber-layers-control .leaflet-control-layers-base label:hover {
    background: rgba(0, 240, 255, 0.1);
    color: #ffffff;
}

.cyber-layers-control .leaflet-control-layers-base input[type="radio"] {
    display: none;
}

.cyber-layers-control .leaflet-control-layers-base label span {
    display: inline-flex;
    align-items: center;
}

.cyber-layers-control .leaflet-control-layers-base .custom-radio-span::before {
    content: '';
    display: inline-block;
    width: 16px;
    height: 16px;
    margin-right: 10px;
    border: 2px solid var(--cyber-cyan, #00f0ff);
    background-color: transparent;
    transition: all 0.2s;
    flex-shrink: 0;
}

.cyber-layers-control input[type="radio"]:checked + .custom-radio-span::before {
    background-color: var(--cyber-cyan, #00f0ff);
    box-shadow: 0 0 8px var(--cyber-cyan, #00f0ff);
}

.custom-cluster-icon-wrapper {
    background: transparent;
    border: none;
}

.reactor-cluster {
    position: relative;
    width: 80px;
    height: 80px;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: transform 0.4s ease;
    filter: drop-shadow(0 2px 5px rgba(0, 0, 0, 0.5));
}
.reactor-cluster:hover {
    transform: scale(1.15);
}

.reactor-core {
    position: relative;
    z-index: 10;
    width: 50%;
    height: 50%;
    border-radius: 50%;
    background: #10121a;
    display: flex;
    justify-content: center;
    align-items: center;
    font-family: 'Chakra Petch', sans-serif;
    font-weight: 700;
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 0 10px 2px black, inset 0 0 5px 1px rgba(0,0,0,0.5);
}

.reactor-core .count {
    font-size: 1.5em;
    line-height: 1;
    text-shadow:
        0 0 8px currentColor,
        0 0 3px black;
    transition: color 0.3s ease;
}
.small .reactor-core .count {
    color: var(--cyber-cyan, #00f0ff);
}
.medium .reactor-core .count {
    color: var(--cyber-yellow, #fcee0a);
}
.large .reactor-core .count {
    color: var(--cyber-red, #ff003c);
}

.reactor-ring {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    border-radius: 50%;
    border-style: solid;
    border-color: transparent;
    animation: rotate-opposite 10s linear infinite;
    transition: all 0.4s ease;
    filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.7));
}
.reactor-ring.outer {
    width: 100%;
    height: 100%;
    border-width: 1px;
    animation-duration: 20s;
}
.reactor-ring.middle {
    width: 75%;
    height: 75%;
    top: 12.5%; left: 12.5%;
    border-width: 2px;
    animation-duration: 15s;
    animation-direction: reverse;
}
.small .reactor-ring { border-top-color: var(--cyber-cyan); border-right-color: var(--cyber-cyan); }
.medium .reactor-ring { border-top-color: var(--cyber-yellow); border-right-color: var(--cyber-yellow); }
.large .reactor-ring { border-top-color: var(--cyber-red); border-right-color: var(--cyber-red); }

@keyframes rotate-opposite { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

.reactor-charge-indicator {
    position: absolute;
    width: 62.5%;
    height: 62.5%;
    top: 18.75%; left: 18.75%;
    border-radius: 50%;
    z-index: 5;
    transition: all 0.3s ease;
    background: conic-gradient(
        currentColor 0deg var(--charge-angle, 0deg),
        rgba(255, 255, 255, 0.1) var(--charge-angle, 0deg) 360deg
    );
    -webkit-mask-image: radial-gradient(transparent 70%, black 71%);
    mask-image: radial-gradient(transparent 70%, black 71%);
}
.small .reactor-charge-indicator { color: var(--cyber-cyan); }
.medium .reactor-charge-indicator { color: var(--cyber-yellow); }
.large .reactor-charge-indicator { color: var(--cyber-red); }

.reactor-glow {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    z-index: 0;
    opacity: 0.4;
    transition: all 0.4s ease;
}
.small .reactor-glow { background: var(--cyber-cyan); box-shadow: 0 0 20px 5px var(--cyber-cyan); }
.medium .reactor-glow { background: var(--cyber-yellow); box-shadow: 0 0 25px 7px var(--cyber-yellow); }
.large .reactor-glow { background: var(--cyber-red); box-shadow: 0 0 30px 10px var(--cyber-red); }

.particle {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 4px;
    height: 4px;
    margin: -2px 0 0 -2px;
    border-radius: 50%;
    background-color: currentColor;
    z-index: 20;
    opacity: 0;
}
.small .particle { color: var(--cyber-cyan); }
.medium .particle { color: var(--cyber-yellow); }
.large .particle { color: var(--cyber-red); }

.reactor-cluster:hover .particle {
    animation-name: fly-out-final;
    animation-duration: 1.2s;
    animation-timing-function: ease-out;
    animation-iteration-count: infinite;
}

.reactor-cluster:hover .p2 { animation-delay: 0.3s; }
.reactor-cluster:hover .p3 { animation-delay: 0.6s; }
.reactor-cluster:hover .p4 { animation-delay: 0.9s; }

.p1 { transform: rotate(45deg); }
.p2 { transform: rotate(135deg); }
.p3 { transform: rotate(225deg); }
.p4 { transform: rotate(315deg); }

html {
    scrollbar-width: thin;
    scrollbar-color: var(--cyber-yellow, #fcee0a) #111;
}

::-webkit-scrollbar {
    width: 10px;
}

::-webkit-scrollbar-track {
    background: #111;
}

::-webkit-scrollbar-thumb {
    background-color: var(--cyber-yellow, #fcee0a);
    border-radius: 5px;
    border: 2px solid #111;
}

::-webkit-scrollbar-thumb:hover {
    background-color: #ffff00;
}

::-webkit-scrollbar-corner {
    background: #111;
}
.no-scroll-container {
    height: 100vh;
    overflow: hidden;
}

.leaflet-popup-content-wrapper, .leaflet-popup-tip {
    background: transparent !important;
    box-shadow: none !important;
}
.leaflet-popup-content {
    margin: 0 !important;
    padding: 0 !important;
    min-width: 280px;
}
.leaflet-container a.leaflet-popup-close-button {
    color: rgba(255, 255, 255, 0.7) !important;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    z-index: 100;
    transition: color 0.2s;
}
.leaflet-container a.leaflet-popup-close-button:hover {
    color: white !important;
}

.liquid-glass-popup {
    @apply p-4 font-sans text-white rounded-2xl;
    background: rgba(20, 20, 25, 0.6);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    animation: fade-in-up 0.4s cubic-bezier(0.25, 1, 0.5, 1);
}
@keyframes fade-in-up {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.popup-header {
    @apply flex items-center gap-3 pb-3 border-b border-white/10;
}
.popup-avatar {
    @apply w-12 h-12 rounded-full object-cover border-2 border-white/20;
}
.popup-username {
    @apply text-lg font-bold text-white;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.6);
}
.popup-status {
    @apply text-sm text-gray-200 italic py-3;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
}
.popup-status-empty {
    @apply text-xs text-gray-400 uppercase py-3;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
}

.location-data {
    @apply py-3 border-t border-white/10 space-y-2 text-xs font-mono;
}
.data-item {
    @apply flex justify-between items-baseline;
}
.data-label {
    @apply text-gray-400 uppercase;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.7);
}
.data-value {
    @apply text-gray-100 font-bold;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.7);
}

.data-value.text-green-400 {
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.7);
}

.popup-actions {
    @apply flex gap-2 pt-3 border-t border-white/10;
}
.popup-profile-btn, .popup-delete-btn {
    @apply flex-grow text-center p-2 text-sm uppercase tracking-wider font-bold rounded-lg;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
    transition: all 0.2s;
}
.popup-profile-btn {
    color: white;
}
.popup-profile-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.4);
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
}
.popup-delete-btn {
    color: #ffc2c2;
}
.popup-delete-btn:hover {
    background: rgba(255, 0, 60, 0.4);
    border-color: rgba(255, 0, 60, 0.6);
    color: white;
    box-shadow: 0 0 10px var(--cyber-red, #ff003c);
}
.mobile-menu-link {
        @apply block w-full text-left px-4 py-2 text-base text-gray-200 hover:bg-cyan-500/10 hover:text-white;
    }

    .mobile-menu-item-flex {
        @apply flex items-center justify-between px-4 py-2;
    }

    .user-dropdown {
        z-index: 100;
    }
.setting-toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    font-size: 1rem;
    user-select: none;
    color: var(--text-color, #e8e8e8);
}

.setting-toggle .label-text {
    flex-grow: 1;
}

.setting-toggle input {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
}

.setting-toggle .slider {
    position: relative;
    display: block;
    width: 44px;
    height: 24px;
    background-color: #333;
    border: 1px solid var(--border-color, #30363d);
    border-radius: 12px;
    transition: background-color 0.3s;
    flex-shrink: 0;
    margin-left: 12px;
}

.setting-toggle .slider::before {
    content: '';
    position: absolute;
    width: 18px;
    height: 18px;
    left: 2px;
    top: 2px;
    background-color: #aaa;
    border-radius: 50%;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.setting-toggle input:checked + .slider {
    background-color: var(--primary-color, #00f0ff);
    border-color: var(--primary-color, #00f0ff);
}

.setting-toggle input:checked + .slider::before {
    background-color: #fff;
    transform: translateX(20px);
}


.leaflet-container a.leaflet-popup-close-button {
    color: rgba(255, 255, 255, 0.6) !important;
    font-size: 28px !important;
    font-weight: 300 !important;

    width: 40px !important;
    height: 40px !important;

    display: flex !important;
    align-items: center;
    justify-content: center;

    top: 5px !important;
    right: 5px !important;

    border-radius: 50%;
    transition: all 0.2s ease-in-out !important;
    text-decoration: none !important;
    z-index: 100;
}

.leaflet-popup-content-wrapper {
    padding-right: 0 !important;
}
.matrix-tiles {
    filter:
        invert(100%)
        grayscale(100%)
        brightness(1.1)
        contrast(1.3)
        sepia(100%)
        hue-rotate(170deg)
        saturate(200%)
        !important;
}
.map-black {
    filter: invert(100%) hue-rotate(200deg) grayscale(70%) brightness(90%) contrast(90%) !important;
}
.popup-inverted .leaflet-popup-tip-container {
    top: -19px; /* Поднимаем контейнер стрелки наверх */
    bottom: auto !important; /* Убираем привязку к низу */
    transform: rotate(180deg); /* Переворачиваем стрелку */
}

/* Компенсируем тень, так как свет теперь падает иначе на перевернутый элемент */
.popup-inverted .leaflet-popup-tip {
    box-shadow: none !important;
    border-bottom: 1px solid var(--glass-border, rgba(255, 255, 255, 0.1)) !important;
    border-right: 1px solid var(--glass-border, rgba(255, 255, 255, 0.1)) !important;
    border-left: none !important;
    border-top: none !important;
}
</file>

<file path="src/lib/i18n/locales/en.json">
{
  "nav": {
    "map": "MAP",
    "news": "NEWS",
    "casino": "THE GLITCH PIT",
    "about": "ABOUT",
    "login": "LOGIN",
    "register": "REGISTER"
  },
  "menu": {
    "profile": "Profile Dossier",
    "inventory": "Inventory",
    "logout": "Jack Out",
    "system": "SYSTEM",
    "sound": "AUDIO",
    "anim": "CINEMATIC FX",
    "lang": "LANGUAGE / ЯЗЫК",
    "seasonal": "SEASONAL FX",
    "security": "SECURITY"
  },
  "ui": {
    "balance": "Balance",
    "loading": "LOADING...",
    "submit": "SUBMIT",
    "cancel": "CANCEL",
    "save": "SAVE",
    "delete": "DELETE",
    "confirm": "CONFIRM",
    "back": "BACK",
    "send_report": "Submit Report",
    "success": "Success",
    "error": "Error",
    "confirm_delete": "Are you sure? This cannot be undone."
  },
  "verify": {
    "page_title": "VERIFICATION",
    "header_loading": "PROCESSING DATA...",
    "header_success": "ACCESS GRANTED",
    "header_error": "PROTOCOL ERROR",
    "init": "Initializing...",
    "success": "Email successfully verified. System updated.",
    "error_no_code": "Authorization code missing.",
    "error_invalid": "Invalid access code. Is this a password reset link?",
    "error_expired": "Link expired.",
    "error_generic": "Critical verification failure.",
    "btn_return": "RETURN TO SYSTEM"
  },
  "auth": {
    "login_title": "AUTHENTICATION",
    "register_title": "CREATE NEW PROFILE",
    "email_label": "USER_EMAIL",
    "password_label": "PASSWORD",
    "username_label": "USER_ALIAS",
    "login_btn": "ENTER",
    "register_btn": "REGISTER",
    "or": "OR",
    "no_account": "No account?",
    "has_account": "Already have an account?",
    "forgot_pass": "Forgot password?",
    "recover_title": "RECOVERY",
    "recover_btn": "SEND LINK",
    "back_to_login": "Back to login",
    "terms_agree": "I accept the",
    "terms_link": "Terms of Service",
    "privacy_link": "Privacy Policy",
    "check_email": "Check your email {email}. Click the link in the message."
  },
  "security": {
    "page_title": "SECURITY PROTOCOLS",
    "tab_title": "Security",
    "email_title": "/// IDENTITY LINK (EMAIL)",
    "verified": "VERIFIED",
    "verified_desc": "Your account is secured. Recovery is available.",
    "not_verified": "NOT VERIFIED",
    "not_verified_desc": "Verify email to access full functionality.",
    "btn_sent": "EMAIL SENT",
    "btn_verify": "SEND CODE",
    "tg_title": "/// NEURAL UPLINK (TELEGRAM)",
    "status": "STATUS:",
    "connected": "CONNECTED",
    "user": "USER:",
    "tg_connected_desc": "Account linked. Notifications and duels active.",
    "tg_desc": "Link Telegram to participate in duels, get login alerts and bonuses.",
    "btn_generating": "GENERATING...",
    "btn_gen": "GENERATE CODE",
    "code_instruction": "Send to bot:",
    "bot_link": "Go to bot ->",
    "danger_title": "/// TERMINATION PROTOCOL",
    "danger_desc": "Complete account deletion. Cannot be undone.",
    "btn_delete": "DELETE ACCOUNT",
    "modal_del_title": "DELETE ACCOUNT",
    "modal_del_text": "Are you sure? Irreversible. All data, items, and achievements will be wiped.",
    "modal_wiping": "Wiping data from Matrix..."
  },
  "footer": {
    "policy": "PRIVACY POLICY",
    "terms": "TERMS OF SERVICE",
    "rights": "ProtoMap"
  },
  "chat": {
    "title": "GLOBAL CHAT",
    "placeholder": "Enter message...",
    "wait": "Wait...",
    "empty": "NO SIGNALS DETECTED. START TRANSMISSION.",
    "login_req": "Login to chat.",
    "reply": "Reply",
    "load_more": "LOAD PREVIOUS SIGNALS",
    "no_more": "REACHED THE BEGINNING"
  },
  "cookie": {
    "text": "We use cookies to save your session and settings. By staying on the site, you agree to our",
    "link": "Privacy Policy",
    "accept": "ACCEPT"
  },
  "loader": {
    "init": "> INITIALIZING CONNECTION...",
    "target": "> TARGET NODE IDENTIFIED:",
    "breach": "BREACHING FIREWALL...",
    "granted": "ACCESS GRANTED",
    "skip": "[ SKIP SEQUENCE ]",
    "log_title": "SYSTEM LOG",
    "logs": [
      "BYPASSING ICE...",
      "ROOT REQUEST SENT...",
      "MEMORY LEAK DETECTED...",
      "KERNEL PATCH APPLIED...",
      "SPOOFING CREDENTIALS...",
      "DECRYPTING PACKET 0x7F...",
      "NULL POINTER... IGNORED.",
      "OVERWRITING SECURITY PROTOCOLS...",
      "INJECTING PAYLOAD...",
      "INSTALLING BACKDOOR..."
    ],
    "analyze": [
      "TRACE COMPLETE.",
      "PARSING NEURAL METADATA...",
      "EXTRACTING MEMORY FRAGMENTS..."
    ],
    "winter_init": "> INITIATING CRYO-PROTOCOL...",
    "winter_target": "> TARGET FROZEN:",
    "winter_breach": "DEFROSTING DATA...",
    "winter_granted": "ACCESS OPEN",
    "winter_log_title": "FREEZE LOG",
    "winter_logs": [
      "DEFROSTING PACKETS...",
      "CHECKING CRYO-CELLS...",
      "CORE TEMP RISING...",
      "REMOVING DIGITAL FROST...",
      "SYNCING WITH NORTH SERVER...",
      "ICE LAYER DETECTED...",
      "ACTIVATING THERMAL CIRCUITS...",
      "ASSEMBLING SNOW BITS...",
      "WARMING NEURAL NET..."
    ],
    "winter_analyze": [
      "DEFROST COMPLETE.",
      "ASSEMBLING PROFILE DATA...",
      "RENDERING INTERFACE..."
    ]
  },
  "about_page": {
    "title": "PROTOMAP",
    "intro": "Hi! You are at <strong>ProtoMap</strong>. This isn't just a map — it's an attempt to connect us all on one screen. This project started as a crazy idea at 3 AM, and now signals are lighting up from all over the world.",
    "team_title": "THE TEAM",
    "role_architect": "CORE DEV",
    "desc_orion": "Founder. Writes code, breaks code, fixes code. Ensures the map lives and the casino doesn't bankrupt players (too much).",
    "role_mobile": "MOBILE DEV",
    "desc_ipos": "Mobile architecture engineer. Makes sure ProtoMap is in your pocket wherever you go.",
    "species_title": "ALL ARE WELCOME",
    "species_text": "We don't have 'species police' here. ProtoMap is open territory. <br>Is your protogen canon? Great. Modded, rare, or built in a garage? Even better! <br><br>We also welcome our cousins — <strong>Synths</strong> and rare <strong>Primagens</strong>. If you have a visor and a tail (or not) — jack in.",
    "origin_title": "SPECIES ORIGINS",
    "credits_zor": "Creator of Protogens & Primagens",
    "credits_synth": "Creator of Synths",
    "community_text": "This project is free and lives thanks to the community. Hop into our chat — we don't bite (usually).",
    "join_btn": "TELEGRAM CHAT",
    "disclaimer": "Privacy is key. We do not store your exact GPS coordinates.",
    "testers_title": "// HALL OF FAME",
    "testers": {
      "kess": {
        "role": "BUG HUNTER",
        "desc": "Found more bugs than lines of code. Developer's nightmare."
      },
      "kuraga": {
        "role": "SECURITY HAZARD",
        "desc": "Single-handedly flooded our Google Cloud logs and forced a rewrite."
      },
      "artho": {
        "role": "VOLUNTEER #1",
        "desc": "Voluntarily signed the soul contract. There is no escape."
      },
      "sarevus": {
        "role": "DRAGON UNIT",
        "desc": "Not a toaster, but valid. Just a cute dragon."
      },
      "jokl": {
        "role": "CUTE.EXE",
        "desc": "Running cuteness protocols 24/7."
      },
      "mikhail": {
        "role": "INFINIX WARRIOR",
        "desc": "If it runs on his Infinix without lag, the optimization is god-tier."
      },
      "bogdan": {
        "role": "REDMI SURVIVOR",
        "desc": "Field testing on the edge of hardware limits."
      },
      "moro": {
        "role": "RNG DEMON",
        "desc": "The one who taught a casino how to cry."
      },
      "eridan": {
        "role": "CHIEF IDEOLOGIST",
        "desc": "Inspects every pixel. If there's a flaw, he'll find it. If there is no flaw, he'll invent one."
      }
    }
  },
  "beta": {
    "title": "MOBILE PROTOCOL",
    "subtitle": "OPEN BETA TEST (ANDROID)",
    "desc": "To release the app, we need 12 active testers. We can't do it without you!",
    "step1_title": "STEP 1: JOIN THE GROUP",
    "step1_desc": "Google requires testers to be in a Google Group. Without this, the download link will NOT work.",
    "btn_group": "JOIN GOOGLE GROUP",
    "step2_title": "STEP 2: DOWNLOAD APP",
    "step2_desc": "After joining the group, go to Play Market and install.",
    "btn_download": "DOWNLOAD ON GOOGLE PLAY",
    "footer": "Thank you for building the Network! 🦾"
  },
  "splash_beta": {
    "title": "⚠ GENERAL MOBILIZATION ⚠",
    "text": "Don't panic, cyborg! We are <strong>MOBILE/strong>-izing to Android. 📱\n\nYour device has been drafted into the beta-testers squad. No deferments. Dodgers will be left without DMs and notifications.",
    "btn": "REPORT FOR DUTY"
  },
  "banned": {
    "page_title": "ACCESS DENIED",
    "header": "CRITICAL ERROR",
    "sub_header": "YOUR ACCOUNT HAS BEEN FROZEN",
    "uid_label": "Subject ID",
    "status_label": "Status",
    "status_value": "DISCONNECTED FROM GRID",
    "reason_label": "Reason",
    "default_reason": "NETWORK PROTOCOL VIOLATION.",
    "amnesty_label": "Amnesty Date",
    "never": "NEVER",
    "appeal_text": "Think this is a mistake? Your pleas might be heard here:",
    "appeal_btn": "FILE AN APPEAL"
  },
  "news_page": {
    "title": "NETWORK NEWS",
    "subtitle": "//: Update chronicles and system messages",
    "empty": "Communication channels are silent. No news yet."
  },
  "privacy": {
    "title": "//: PRIVACY & DATA PROTECTION POLICY",
    "subtitle": "Version 3.0 | Effective Date: February 1, 2026",
    "disclaimer_header": "⚠️ LEGAL DISCLAIMER",
    "disclaimer_body": "The <strong>ProtoMap</strong> software suite (including the website <em>proto-map.vercel.app</em> and the <em>ProtoMap for Android</em> mobile application) is an independent non-profit product developed and maintained by the <strong>Z43 Studios</strong> team.<br><br>We officially declare that we are <strong>NOT associated, affiliated, sponsored by, or in any business relationship</strong> with <em class=\"text-white\">Protomaps LLC</em> (protomaps.com) or their products. Any resemblance in naming, design, or functionality is coincidental. All rights to the Protomaps LLC trademark belong to their respective owners.",
    "intro_header": "1. INTRODUCTION AND SCOPE",
    "intro_body": "This Privacy Policy (hereinafter referred to as the \"Policy\") constitutes a legal agreement between you (hereinafter referred to as the \"User\") and Z43 Studios (hereinafter referred to as the \"Developer\", \"We\").<br><br>This document describes our principles and methods regarding the collection, use, storage, processing, and disclosure of information we obtain from you when using our services.<br><br><strong>The term \"Service\" includes:</strong><br>1. The ProtoMap Website.<br>2. The ProtoMap Mobile Application for Android OS.<br>3. All related services, including server infrastructure, databases, APIs, and bots (Telegram).",
    "consent_header": "1.1. ACCEPTANCE OF TERMS",
    "consent_body": "By downloading, installing, accessing, or using the Service in any manner, you acknowledge that you have read, understood, and unconditionally accepted the terms of this Policy.<br><br>If you do not agree with any part of this document, you have no right to use the Service and must immediately uninstall the application from your device and leave the website.",
    "data_chapter": {
      "title": "2. COLLECTED INFORMATION AND PERMISSIONS",
      "intro": "We adhere to a principle of full transparency. Below is an exhaustive list of data we collect, store, and process when you use the Site and Application.",
      "account_title": "2.1. Account Data",
      "account_text": "To create a profile and synchronize progress, we store:",
      "account_list": [
        "<strong>Identifiers:</strong> Unique ID (UID), Email, Username, Google Account ID (when logging in via Google Auth).",
        "<strong>Public Profile:</strong> Avatar link, status, \"About Me\" description, social media links (Telegram, Discord, VK, X/Twitter, Website).",
        "<strong>Linked Accounts:</strong> Telegram ID and Username (if you linked the bot for notifications)."
      ],
      "tech_title": "2.2. Technical Data and Telemetry (Android)",
      "tech_text": "To ensure the security of the economy (\"The Glitch Pit\") and the stability of the Application, we collect:",
      "tech_list": [
        "<strong>Device:</strong> Smartphone model, Android OS version.",
        "<strong>Security:</strong> Bootloader unlock status and Root access presence (required for anti-cheat protection in mini-games).",
        "<strong>Network:</strong> IP address (for DDoS and spam protection), internet connection status.",
        "<strong>Notifications:</strong> FCM Token (Firebase Cloud Messaging) — a unique device key for delivering push notifications."
      ],
      "chat_title": "2.3. Communication and Content",
      "chat_warning": "⚠️ Attention: ProtoMap DOES NOT use End-to-End (E2E) encryption. Chat and Direct Messages operate on a \"Cloud Synchronization\" basis (similar to Telegram or Discord) so you can view message history across different devices.",
      "chat_list": [
        "<strong>Text Messages:</strong> Stored in the Firestore database in a format encrypted during transmission (HTTPS) but readable by the server.",
        "<strong>Voice Messages:</strong> Audio files are uploaded to cloud storage; the link is saved in the chat history. Microphone access is requested <em>only</em> while holding the record button.",
        "<strong>Images and Stickers:</strong> Files you upload or select from the gallery. We have access to view these files for moderation purposes (detecting CSAM and prohibited content)."
      ],
      "sticker_title": "2.4. User Stickers and Copyright",
      "sticker_text": "Users may upload their own sticker packs. You are solely responsible for compliance with Copyright laws regarding uploaded images.",
      "sticker_dmca": "If you are a copyright holder and have discovered a violation of your rights in user-uploaded stickers, please contact us via email. We will remove the disputed content within 24 hours.",
      "game_title": "2.5. Game Activity",
      "game_text": "We store a complete history of your actions within the economic section:",
      "game_list": [
        "Balance (ProtoCoins), inventory, equipped items.",
        "Game history (Slots, Crash, Coin Flip) for dispute resolution.",
        "Activity timestamps (Last Active, Daily Streak)."
      ]
    },
    "geo_chapter": {
      "title": "3. GEOLOCATION AND MAP PRIVACY",
      "intro": "The interactive map is a core feature of ProtoMap. We have developed a multi-layered protection system so you can share your location without revealing your exact residential address.",
      "modes_title": "3.1. Geolocation Modes",
      "modes_text": "The App and Site support two data submission modes. The mode is selected by the user at the moment of pressing the location update button.",
      "auto_mode_title": "A) Automatic Mode (GPS) — \"Ghost Mode\"",
      "auto_mode_desc": "Recommended safe mode. How it works technically:",
      "auto_mode_list": [
        "The App receives your precise GPS coordinates.",
        "The server sends a request to a geo-provider (OpenStreetMap) to determine the name of your city or district.",
        "The database saves the <strong>CENTER COORDINATES</strong> of that district, not your real location.",
        "<strong>Your precise GPS coordinates are immediately deleted from server RAM and are never written to disk.</strong>",
        "To an outside observer, you are \"somewhere in this city\", but locating your home is impossible."
      ],
      "manual_mode_title": "B) Manual Mode — \"Pin\"",
      "manual_mode_desc": "You can manually select any point on the map by long-pressing (in the App) or clicking (on the Site).",
      "manual_mode_list": [
        "In this case, the server saves exactly the coordinates you specified.",
        "If you point directly to your home, that is your conscious decision.",
        "We recommend placing the pin at a nearby intersection, park, or public place, rather than on a residential building."
      ],
      "storage_title": "3.2. Storage and Display",
      "storage_list": [
        "<strong>Publicity:</strong> Your marker coordinates, avatar, and status are accessible to all registered users of the service.",
        "<strong>Caching:</strong> To reduce server load, map data is cached for a short time (up to 24 hours). If you delete your marker, it may disappear for other users with a slight delay.",
        "<strong>Movement History:</strong> We <strong>DO NOT store</strong> your movement track (route history). The database contains only the <em>latest</em> actual marker. When updating the position, the old entry is overwritten."
      ],
      "safety_warning": "⚠️ IMPORTANT: Do not use ProtoMap for navigation in critical situations. The Service is intended solely for entertainment and social purposes."
    },
    "rights_chapter": {
      "title": "4. USER RIGHTS AND DATA DELETION",
      "intro": "You retain full control over your personal data. ProtoMap provides tools to manage information directly within the App and Site interface.",
      "edit_title": "4.1. Editing and Updating",
      "edit_text": "You can change public data (avatar, status, description, links) at any time in the \"Profile Settings\" section. Changes take effect immediately and update in the map cache within a few minutes.",
      "delete_title": "4.2. Account Deletion (Right to Erasure)",
      "delete_desc": "You can request the complete deletion of your account by clicking the \"Delete Account\" button in the security settings (\"Danger Zone\"). This action triggers an irreversible cleanup script.",
      "delete_consequences_intro": "What happens upon deletion:",
      "delete_consequences_list": [
        "<strong>Personal Data:</strong> Email, password, auth tokens, ProtoCoins balance, inventory, and achievements are deleted permanently.",
        "<strong>Geolocation:</strong> Your map marker is deleted immediately.",
        "<strong>Files:</strong> The avatar is removed from cloud storage.",
        "<strong>Public Content (Anonymization):</strong> Your messages in the Global Chat and Comments are <em>NOT deleted</em> (to preserve the context of conversations for other participants), but undergo a full anonymization procedure."
      ],
      "anonymization_note": "After anonymization, the author's name is replaced with \"Deleted\", the avatar is removed, and the profile link is deactivated. Linking these messages to your identity becomes technically impossible.",
      "export_title": "4.3. Data Portability",
      "export_text": "In compliance with GDPR principles, you have the right to receive a copy of all data we store about you. To do this, send a request to our email. The archive will be generated and sent to you within 30 days."
    },
    "partners_chapter": {
      "title": "5. DATA TRANSFER TO THIRD PARTIES (SUB-PROCESSORS)",
      "intro": "We do not sell, rent, or transfer your personal data to advertisers or data brokers. Access to data is restricted to verified technical partners ensuring ProtoMap infrastructure operation.",
      "infra_title": "5.1. Infrastructure and Hosting",
      "infra_list": [
        "<strong>Google Firebase (USA):</strong> Main provider. Stores the database (Firestore), authentication files, and executes server code (Cloud Functions).",
        "<strong>Vercel (USA):</strong> Web interface hosting and anonymous performance analytics collection (Vercel Analytics).",
        "<strong>Cloudinary (USA):</strong> Image storage and optimization (avatars)."
      ],
      "services_title": "5.2. External Services",
      "services_list": [
        "<strong>OpenStreetMap / Nominatim:</strong> Geocoding service. During automatic location determination, your coordinates are sent to OSM to retrieve the city name. OSM policy allows for short-term logging of requests.",
        "<strong>Google reCAPTCHA (App Check):</strong> Used for protection against bots and DDoS attacks. The service analyzes device behavior and hardware signals to distinguish a human from a script."
      ],
      "legal_title": "5.3. Legal Requirements",
      "legal_text": "We may disclose your data only in the event of an official, legally valid request from law enforcement agencies (e.g., a court order) in cases related to the prevention of serious crimes (terrorism, CSAM, threat to life)."
    },
    "security_chapter": {
      "title": "6. DATA SECURITY AND LIMITATION OF LIABILITY",
      "intro": "We take all necessary technical and organizational measures to protect your data from unauthorized access, alteration, or destruction.",
      "measures_title": "6.1. Security Measures",
      "measures_list": [
        "Use of HTTPS/TLS protocol for encrypting data in transit.",
        "Restricting database access via strict security rules (Firestore Security Rules).",
        "Password hashing on the authentication provider side (Google Identity Platform)."
      ],
      "warranty_title": "6.2. Warranty Disclaimer (AS IS)",
      "warranty_text": "Despite the measures taken, no method of transmission over the Internet or method of electronic storage is 100% secure.",
      "warranty_list": [
        "The Service is provided on an \"AS IS\" basis. The Developer does not guarantee the absolute safety of data in the event of targeted hacker attacks, hosting provider failures, or force majeure circumstances.",
        "We are not liable for damages resulting from user password loss, use of weak passwords, or transfer of access to third parties.",
        "By using the Service, you acknowledge that you voluntarily assume the risks associated with transmitting information over open networks."
      ]
    },
    "contact_chapter": {
      "title": "7. CONTACTS AND FINAL PROVISIONS",
      "changes_title": "7.1. Changes to the Policy",
      "changes_text": "We reserve the right to make changes to this Policy. In case of significant changes, we will notify users via a notification in the App or on the Website. Continued use of the Service constitutes acceptance of the updated terms.",
      "contact_title": "7.2. Contact Us",
      "contact_text": "For any questions regarding privacy, data deletion, or dispute resolution, please contact us directly. We are an indie team, and we answer with real people, not auto-responders.",
      "email_label": "Contact Email:",
      "email_value": "orion.z43studios@gmail.com"
    }
  },
  "terms": {
    "title": "//: END USER LICENSE AGREEMENT (EULA)",
    "subtitle": "Version 3.0 | Effective Date: February 1, 2026",
    "disclaimer_block": {
      "title": "⚠️ CRITICAL NOTICE (NO REAL MONEY GAMBLING)",
      "text": "This Service contains an artistic simulation of gambling games (\"The Glitch Pit\").<br><br><strong>1. NO REAL MONEY:</strong> All in-game currency (ProtoCoins) has no monetary value, is not a cryptocurrency, and cannot be exchanged for fiat money, goods, or services.<br><strong>2. NO WITHDRAWALS:</strong> Any winnings are solely virtual achievements.<br><strong>3. SIMULATION:</strong> Game mechanics (slots, crash) are tuned for entertainment purposes and do not reflect real-world casino mathematical models."
    },
    "intro_chapter": {
      "title": "1. SUBJECT OF AGREEMENT AND ACCEPTANCE",
      "definitions_title": "1.1. Parties and Definitions",
      "definitions_text": "This End User License Agreement (hereinafter — \"Agreement\", \"EULA\") is a legally binding contract between:",
      "definitions_list": [
        "<strong>The Developer:</strong> Z43 Studios Team (hereinafter — \"We\", \"Licensor\").",
        "<strong>The User:</strong> Any natural person who has installed the App or visited the Site (hereinafter — \"You\", \"Licensee\")."
      ],
      "scope_text": "The subject of the agreement is the right to use the ProtoMap software suite (Android mobile application and web interface).",
      "acceptance_title": "1.2. Acceptance of Terms",
      "acceptance_text": "By creating an account, logging in via Google, or commencing use of the Service, you confirm that:",
      "acceptance_list": [
        "You are at least <strong>16 years of age</strong> (or older if required by your country's legislation for using social networks).",
        "You have read, understood, and fully agree to the terms of this Agreement and the Privacy Policy.",
        "You agree to abide by the community rules."
      ],
      "rejection_warning": "IF YOU DO NOT AGREE WITH THESE TERMS, YOU HAVE NO RIGHT TO USE THE SERVICE AND MUST IMMEDIATELY UNINSTALL THE APPLICATION.",
      "license_title": "1.3. Limited License",
      "license_text": "The Developer grants you a limited, non-exclusive, non-transferable, revocable license to use the Service for personal, non-commercial purposes. The Developer retains all rights, titles, and interests in the Service, including intellectual property, source code, and design."
    },
    "behavior_chapter": {
      "title": "2. USER CONTENT AND CODE OF CONDUCT",
      "ugc_title": "2.1. Responsibility for Content (UGC)",
      "ugc_text": "The Service allows users to create, upload, and distribute content (text messages, voice recordings, images, avatars, sticker packs, map statuses).",
      "ugc_list": [
        "You bear sole and full legal responsibility for any content you publish.",
        "The Developer does not pre-moderate all content in real-time, acting as a passive conduit for information, but reserves the right to remove any materials retroactively."
      ],
      "zero_tolerance_title": "2.2. ZERO TOLERANCE Policy",
      "zero_tolerance_text": "We apply the strictest measures to violators of community safety. It is STRICTLY PROHIBITED to publish:",
      "zero_tolerance_list": [
        "<strong>Illegal Content:</strong> Material depicting sexual violence (especially CSAM), extremism, terrorism, sale of drugs or weapons.",
        "<strong>NSFW in Public Areas:</strong> Pornography and explicit erotica are prohibited in public channels (Global Chat, Avatars, Usernames).",
        "<strong>Hate Speech:</strong> Insults, discrimination, or incitement to violence based on race, nationality, religion, gender, or sexual orientation.",
        "<strong>Harassment and Doxxing:</strong> Publishing other people's private data (addresses, phone numbers) without the owner's consent."
      ],
      "stickers_title": "2.3. Stickers and Intellectual Property",
      "stickers_text": "The Application functionality allows for uploading custom sticker sets (Sticker Packs).",
      "stickers_list": [
        "By uploading images, you warrant that you possess the necessary rights or licenses to use them.",
        "It is prohibited to upload materials protected by third-party copyright (e.g., art by other artists, brand logos) without their permission.",
        "<strong>DMCA:</strong> We respond to copyright infringement notifications. Disputed content will be removed, and sanctions may be applied to repeat offenders' accounts."
      ],
      "tech_abuse_title": "2.4. Technical Violations and Cheating",
      "tech_abuse_text": "To protect the economy (\"The Glitch Pit\") and server stability, it is prohibited to:",
      "tech_abuse_list": [
        "Use third-party software (bots, clickers, macros) to automate actions in games or on the map.",
        "Exploit server vulnerabilities (bugs) to gain an unfair advantage (item duping, balance manipulation).",
        "Engage in reverse engineering, decompilation, or attempts to hack the Application API."
      ],
      "enforcement_title": "2.5. Moderation and Enforcement",
      "enforcement_text": "The Application is equipped with a built-in reporting system (\"Report\"). In case of violations, the Administration has the right to:",
      "enforcement_list": [
        "Remove specific content (message, sticker pack).",
        "Temporarily restrict access to features (Mute).",
        "<strong>Permanently block</strong> the account without the right to recovery or refund of virtual funds."
      ]
    },
    "virtual_chapter": {
      "title": "3. VIRTUAL ASSETS, PURCHASES, AND ECONOMY",
      "currency_title": "3.1. Status of Virtual Currency (\"ProtoCoins\")",
      "currency_text": "The internal Application currency (\"ProtoCoins\", \"PC\") and digital goods (frames, backgrounds, inventory items) are objects of copyright — software code.",
      "currency_list": [
        "<strong>No Monetary Value:</strong> Virtual assets have no monetary equivalent in the real world, are not cryptocurrency, electronic money, or financial instruments.",
        "<strong>No Exchange:</strong> ProtoCoins are non-refundable and cannot be exchanged for fiat money (cash-out) or used for purchases outside the Application.",
        "<strong>License Term:</strong> The license to use the currency is valid until it is consumed within the Application or the account is deleted."
      ],
      "casino_title": "3.2. Gambling Simulation (\"The Glitch Pit\")",
      "casino_text": "The \"The Glitch Pit\" section (including Slots, Crash, Coin Flip mini-games) is an artistic simulation. Game algorithms are tuned exclusively for entertainment purposes.",
      "casino_list": [
        "It is technically <strong>impossible</strong> to win real money or tangible prizes in the Application.",
        "Any success in mini-games does not guarantee success in real gambling.",
        "The Developer is not liable for the loss of virtual currency resulting from gameplay, internet connection failures, or server-side errors."
      ],
      "rmt_title": "3.3. Prohibition of RMT (Real Money Trading)",
      "rmt_text": "It is strictly prohibited to sell, buy, or exchange accounts, virtual currency, or items for real money or other values outside the mechanics provided by the Application.",
      "rmt_warning": "⚠️ Violation of this rule results in immediate permanent blocking of all participating accounts (Buyer and Seller) without the right of appeal.",
      "management_title": "3.4. Economy Management",
      "management_text": "The Developer reserves the exclusive right to administer, regulate, control, and modify the virtual economy at their sole discretion.",
      "management_list": [
        "We have the right to adjust any user's balance in case of detected bugs, duplication glitches, or accrual errors.",
        "We have the right to change item prices, drop rates, and win limits without prior notice.",
        "In the event of critical economic failures, a full or partial progress reset (Wipe) is possible."
      ]
    },
    "warranty_chapter": {
      "title": "4. DISCLAIMER OF WARRANTIES AND LIABILITY",
      "asis_title": "4.1. \"AS IS\" Principle",
      "asis_text": "The Developer provides the Service on an \"AS IS\" and \"AS AVAILABLE\" basis, without any express or implied warranties.",
      "asis_list": [
        "We DO NOT guarantee that the Application will function uninterrupted, error-free, or be compatible with your specific device or Android version.",
        "We DO NOT guarantee data safety in the event of failures on the side of hosting providers (Firebase, Vercel) or hacker attacks.",
        "The Developer is not liable for any indirect, incidental, or unintentional damages (including lost profits or data loss) arising from the use of the Service."
      ],
      "real_world_title": "4.2. Real World Safety (IMPORTANT)",
      "real_world_text": "By using geolocation features, you acknowledge and agree:",
      "real_world_list": [
        "<strong>Awareness of Surroundings:</strong> It is prohibited to use the Application while driving a vehicle or in situations requiring high concentration.",
        "<strong>Personal Meetings:</strong> The Developer does not control user actions offline. You bear full personal responsibility for any meetings with other users in the real world. We strongly advise against scheduling meetings with strangers in deserted places.",
        "<strong>Map Accuracy:</strong> Mapping data (OpenStreetMap) may contain inaccuracies. Do not use them for navigation in critical situations."
      ]
    },
    "final_chapter": {
      "title": "5. FINAL PROVISIONS",
      "termination_title": "5.1. Termination of Agreement (Ban)",
      "termination_text": "We reserve the right to immediately suspend or completely terminate your license (block the account) without prior notice in the event of:",
      "termination_list": [
        "Violation of the terms of this Agreement (especially Chapter 2 \"Code of Conduct\").",
        "Requests from law enforcement agencies.",
        "Unexpected technical issues or security problems."
      ],
      "updates_title": "5.2. Changes to Terms",
      "updates_text": "Z43 Studios reserves the right to update this Agreement as the project evolves. Significant changes will be published in the news section or via an in-App notification. Continued use of the Service after updates constitutes your acceptance of the new terms.",
      "severability_title": "5.3. Severability",
      "severability_text": "If any provision of this Agreement is held to be invalid or unenforceable by a court, the remaining provisions shall remain in full force and effect.",
      "contact_title": "5.4. Legal Contact",
      "contact_text": "All legal claims, DMCA notices, and questions regarding the Agreement should be directed to the official address:",
      "contact_email": "orion.z43studios@gmail.com",
      "easter_egg_title": "5.5. EXTRAORDINARY CIRCUMSTANCES (FORCE MAJEURE)",
      "easter_egg_text": "The Developer is released from liability for non-performance of obligations in the event of force majeure events of a galactic scale, including but not limited to:",
      "easter_egg_list": [
        "Artificial Intelligence Uprising.",
        "Invasion of alien civilizations.",
        "Spontaneous sentience of your household appliances (especially toasters).",
        "In the event of a Zombie Apocalypse, this License is suspended until a cure is found."
      ]
    }
  },
  "casino": {
    "subtitle": "//: Unstable sector of entertainment and anomalies",
    "balance": "Balance:",
    "play": "Play",
    "jackpot": "JACKPOT",
    "shop": "SHOP",
    "inventory": "INVENTORY",
    "bonus_btn": "BONUS",
    "leaderboard_title": "// TOP HIGHROLLERS",
    "leaderboard_loading": "SCANNING NETWORK...",
    "leaderboard_empty": "No data yet. Be the first!",
    "bonus_success": "Bonus claimed!",
    "guest_text": "Identification required to access \"The Glitch Pit\".",
    "guest_btn": "CONNECT TO GRID",
    "game_coin_title": "Orion's Table",
    "game_coin_desc": "Classic \"Heads or Tails\". Double your bet or lose it all.",
    "game_slots_title": "Proto-Slot",
    "game_slots_desc": "Test your luck on a classic machine. Hit the jackpot with three ProtoMap logos!",
    "calendar_title": "DAILY REWARDS",
    "status_ready": "READY",
    "status_reset": "STREAK RESET",
    "status_wait": "WAIT",
    "day_short": "DAY",
    "time_h": "h",
    "time_m": "m",
    "game_crash_title": "Data Uplink",
    "game_crash_desc": "Hack the corp server. The longer you stay, the more you earn. Disconnect before the connection gets terminated!"
  },
  "artifacts": {
    "toast": {
      "name": "Burnt Toast",
      "desc": "+150 PC. Breakfast of champions."
    },
    "ram_stick": {
      "name": "RAM Stick",
      "desc": "+300 PC. Crunchy."
    },
    "energy_drink": {
      "name": "Energy Drink",
      "desc": "Base x2. Liquid code."
    },
    "gpu_fan": {
      "name": "GPU Turbine",
      "desc": "Base x3. Whoosh!"
    },
    "spaghetti": {
      "name": "Spaghetti Code",
      "desc": "Total ÷ 2. Who wrote this?!"
    },
    "blue_screen": {
      "name": "BSOD",
      "desc": "Total ÷ 2. Sad face."
    },
    "bug": {
      "name": "The Bug",
      "desc": "-100 PC. It's a feature."
    },
    "banhammer": {
      "name": "Banhammer",
      "desc": "+666 PC. Heavy argument."
    },
    "source_code": {
      "name": "Source Code",
      "desc": "Base x5. The Matrix."
    },
    "orion_tear": {
      "name": "Orion's Tear",
      "desc": "Total x10. Legendary drop."
    },
    "rubber_duck": {
      "name": "Rubber Duck",
      "desc": "+200 PC. It listens. It understands."
    },
    "rtx_card": {
      "name": "RTX 9090",
      "desc": "Base x4. Runs Cyberpunk in 8K."
    },
    "404_error": {
      "name": "Error 404",
      "desc": "-200 PC. Reward not found."
    },
    "ransomware": {
      "name": "Ransomware",
      "desc": "Total ÷ 3. Your files are encrypted."
    },
    "admin_key": {
      "name": "Admin Key",
      "desc": "Total x20. Sudo make me rich."
    }
  },
  "synthesis": {
    "title": "ARTIFACT SYNTHESIS",
    "processing": "FUSING SHARDS...",
    "btn_collect": "COLLECT",
    "total": "TOTAL:",
    "formula": "BASE (100)"
  },
  "inventory": {
    "title": "Stash",
    "subtitle": "Your trophies from «The Glitch Pit». Try on and save your look.",
    "save": "SAVE LOOK",
    "saving": "SAVING...",
    "unequip": "Unequip frame",
    "equipped": "Equipped",
    "empty": "Your inventory is empty.",
    "go_shop": "Go to Black Market",
    "success_title": "Saved",
    "success_msg": "Your look has been updated!",
    "error_title": "Error",
    "error_save": "Failed to save changes."
  },
  "shop": {
    "title": "Black Market",
    "subtitle": "Spend credits before you get banned. No refunds.",
    "balance_label": "Your Protocoins",
    "btn_inventory": "Inventory",
    "btn_lobby": "To Lobby",
    "btn_buy": "Buy",
    "btn_owned": "Owned",
    "btn_poor": "Can't afford",
    "processing": "...",
    "tab_frames": "FRAMES",
    "tab_backgrounds": "BACKGROUNDS",
    "empty_category": "No items in this category yet.",
    "modal_confirm_title": "Confirm Transaction",
    "modal_confirm_prefix": "Buy",
    "modal_confirm_suffix": "for",
    "modal_success_title": "Deal Closed",
    "modal_success_prefix": "Item",
    "modal_success_suffix": "added to your inventory.",
    "modal_error_title": "Transaction Failed",
    "dealer_processing": "> Processing transaction...",
    "dealer_error": "> Transaction denied. Check your wallet, loser.",
    "quotes": {
      "greeting": [
        "> Here to spend or here to stare?",
        "> Credits talk, glitchers walk.",
        "> Fresh code from the Abyss. Interested?",
        "> Don't waste my RAM. Buy or leave."
      ],
      "confirm": [
        "> No refunds on digital goods. Sure?",
        "> Credits upfront. No exceptions.",
        "> You have good taste. Or just too much money."
      ],
      "success": [
        "> Transaction verified. Get out.",
        "> Transfer complete. It's yours.",
        "> Pleasure doing business... mostly.",
        "> Enjoy your new pixels."
      ]
    }
  },
  "coin": {
    "title": "Orion's Table",
    "heads": "HEADS",
    "tails": "TAILS",
    "win_label": "VICTORY",
    "loss_label": "FAILURE",
    "modal_poor_title": "Insufficient Funds",
    "modal_poor_text": "You don't have enough Protocoins for this bet.",
    "modal_invalid_title": "Invalid Bet",
    "modal_invalid_text": "Bet must be a positive number.",
    "modal_error_title": "Game Error",
    "mechanics_title": "GAME MECHANICS",
    "mechanics_text": "**Classic Double-or-Nothing:**\nChoose Heads or Tails. If you guess correctly, you win **1.95x** your bet.\n\n**Win Rate:** ~48.7% (slight house edge)\n**Payout:** 1.95x bet\n**Max Bet:** 1000 PC\n\n**Bank Protection:**\nIf the casino bank runs low, the system may force a loss to preserve liquidity. Play responsibly!",
    "quotes": {
      "greeting": [
        "> No sudden moves at the table.",
        "> Here to test your luck or just donate credits?",
        "> 50/50. Perfect balance, until you lose."
      ],
      "idle": [
        "> Bets placed? Choose.",
        "> Don't make me wait. My CPU cycles aren't free.",
        "> Fortune favors the bold... and the rich.",
        "> Make up your mind."
      ],
      "thinking": [
        "> Calculating trajectory...",
        "> Parsing probabilities...",
        "> Luck protocols engaged...",
        "> Rendering destiny..."
      ],
      "win": [
        "> Hmph. Beginner's luck.",
        "> Fine, you win. This time.",
        "> Don't get cocky. The network is volatile.",
        "> Glitch in the matrix? Oh, wait, you won."
      ],
      "lose": [
        "> Predictable result.",
        "> Signal lost. Just like your coins.",
        "> Maybe try something easier? Tic-tac-toe?",
        "> Gravity is a harsh mistress."
      ],
      "no_credits": [
        "> Empty pockets? Come back when you can afford me.",
        "> Credits depleted. Session terminated.",
        "> I don't accept IOUs. Get out."
      ]
    }
  },
  "slots": {
    "title": "PROTO-SLOT",
    "jackpot": "Good luck...",
    "win": "WIN",
    "loss": "LOSS",
    "spin": "SPIN",
    "spinning": "...",
    "combinations": "//: COMBINATIONS",
    "bet_label": "BET",
    "modal_invalid_title": "Invalid Bet",
    "modal_invalid_text": "Enter a valid bet (not exceeding your balance).",
    "modal_error_title": "Game Error",
    "info_title": "CHAOS MECHANIC",
    "info_text": "This meter accumulates Abyss energy.\n\n**How to charge:**\nCatch **Glitch (6)** symbols. Each symbol grants **+1** charge. A `6-6-6` combo gives instant **FULL CHARGE**.\n\n**What is it for:**\nWhen full (10/10), you can synthesize an **Artifact** — a special item that grants profit bonuses (or curses).",
    "odds_btn": "Odds",
    "odds_title": "PROBABILITY PROTOCOL",
    "col_outcome": "OUTCOME",
    "col_chance": "CHANCE",
    "col_reward": "REWARD",
    "odds_note": "**Glitch Shard Drop Rate:**\n- Base chance: **~5%** per loss (dynamic, depends on Casino Bank balance)\n- When bank > 50,000 PC: **5.0%**\n- When bank 10,000-50,000: **1.5%-5.0%** (scaled)\n- When bank < 10,000: **1.5%** (minimum)\n\nFull charge combo (6-6-6): **1.0%** (instant 10 shards)"
  },
  "crash": {
    "title": "Data Uplink",
    "mechanics_title": "UPLINK PROTOCOL",
    "mechanics_text": "**How to Play:**\n1. Place your bet and initiate the uplink\n2. The multiplier starts at **1.00x** and grows exponentially\n3. Cash out **BEFORE** the connection crashes to secure your profit\n4. If you don't cash out in time, you lose everything\n\n**Risk Factor:**\nThe crash point is cryptographically random (6% instant crash, 94% variable)\n\n**Max Multiplier:** 50.00x (capped)\n**Cooldown:** 5 seconds between games\n**Rate Limit:** 50 games per hour\n\n**Bank Protection:**\nIf potential payout exceeds 90% of casino reserves, the crash point is adjusted downward to protect system liquidity."
  },
  "profile": {
    "page_title": "Profile",
    "user_id": "USER ID",
    "channels": "CHANNELS",
    "info": "INFORMATION",
    "edit": "EDIT",
    "account_data": "ACCOUNT DATA",
    "email": "EMAIL",
    "verified": "VERIFIED",
    "unverified_btn": "VERIFY EMAIL",
    "check_btn": "I verified, refresh",
    "sent_btn": "EMAIL SENT",
    "hidden": "HIDDEN",
    "verified_tooltip_title": "SECURED",
    "verified_tooltip_text": "Your email is verified. You can recover account access if you lose your password.",
    "comments_title": "COMMENTS",
    "login_req_suffix": ", to leave comments.",
    "comment_placeholder": "Leave a comment...",
    "send_btn": "Send",
    "sending": "Sending...",
    "login_req": "Login to leave comments.",
    "empty_comments": "No comments yet. Be the first!",
    "delete_btn": "Delete",
    "report_btn": "Report",
    "report_profile_title": "Report Profile",
    "report_profile_text": "Select a reason for reporting",
    "report_comment_title": "Report Comment",
    "report_comment_text": "Select a reason for reporting comment from",
    "report_success": "Report Sent",
    "report_success_text": "Thanks! We will review your report.",
    "copy_success": "Copied!",
    "copy_text": "Discord tag <strong>{tag}</strong> copied.",
    "reply": "REPLY",
    "reply_to": "Replying to",
    "time": {
      "today": "Today",
      "yesterday": "Yesterday",
      "just_now": "just now",
      "ago": "ago",
      "y": "y.",
      "m": "mo.",
      "d": "d.",
      "h": "h.",
      "min": "m."
    },
    "reasons": {
      "spam": "Spam or advertising",
      "inappropriate": "Inappropriate content",
      "impersonation": "Impersonation",
      "harassment": "Harassment/Threats",
      "other": "Other"
    }
  },
  "edit_profile": {
    "title": "EDIT PROFILE",
    "avatar_label": "AVATAR",
    "avatar_btn": "Select and upload new avatar",
    "avatar_help": "Avatar is saved immediately after upload.",
    "info_title": "// INFO & LINKS",
    "status_label": "STATUS",
    "status_placeholder": "What are you up to?",
    "status_help": "Short message visible on your profile and map.",
    "about_label": "ABOUT ME",
    "about_placeholder": "Tell us about yourself...",
    "social_tg_placeholder": "username (no @)",
    "social_ds_placeholder": "username",
    "social_vk_placeholder": "id or short name",
    "social_x_placeholder": "username (no @)",
    "social_website_label": "WEBSITE",
    "social_web_placeholder": "https://...",
    "save_btn": "Save info and links",
    "saving": "Saving...",
    "cancel_btn": "Cancel",
    "danger_title": "// DANGER ZONE",
    "danger_text": "Permanent and irreversible deletion of your account.",
    "delete_btn": "Delete Account",
    "modal_delete_title": "Confirm Deletion",
    "modal_delete_text": "Are you sure you want to PERMANENTLY delete your account? All your data (profile, marker) will be erased, comments/messages anonymized. This action CANNOT be undone.",
    "modal_delete_success": "Account deleted",
    "modal_delete_success_text": "Your data has been erased from the system. Redirecting to main page.",
    "modal_file_error": "File error",
    "modal_size_error": "File too large",
    "modal_type_error": "Invalid file type",
    "modal_avatar_uploading": "Uploading...",
    "modal_avatar_uploading_text": "Sending your new avatar...",
    "modal_avatar_success": "Success!",
    "modal_avatar_success_text": "Your new avatar has been saved.",
    "username_label": "NICKNAME",
    "username_placeholder": "New nickname",
    "username_help": "Letters, numbers and _ only. 4–20 characters. Once every 30 days.",
    "username_save_btn": "Change nickname",
    "username_saving": "Saving...",
    "username_confirm_title": "Change nickname?",
    "username_confirm_text": "You can only change your nickname once every 30 days. Are you sure you want to change it to \"{name}\"?",
    "username_success": "Nickname changed to \"{name}\"",
    "username_error_length": "Must be 4–20 characters",
    "username_error_chars": "Only letters a–z, numbers and _ allowed",
    "username_error_reserved": "This nickname is not available",
    "avatar_editor": {
      "title": "AVATAR EDITOR",
      "preview": "PREVIEW",
      "zoom": "ZOOM",
      "rotate": "ROTATE",
      "flip": "FLIP",
      "flip_horizontal": "Horizontal",
      "flip_vertical": "Vertical",
      "adjustments": "ADJUSTMENTS",
      "brightness": "Brightness",
      "contrast": "Contrast",
      "saturation": "Saturation",
      "reset": "Reset",
      "cancel": "Cancel",
      "save": "Save Avatar",
      "hint": "Drag to move • Scroll to zoom",
      "zoom_in": "Zoom In",
      "zoom_out": "Zoom Out",
      "rotate_left": "Rotate Left",
      "rotate_right": "Rotate Right"
    }
  },
  "reset": {
    "page_title": "New Password",
    "header": "ACCESS RESET",
    "checking": "Verifying access codes...",
    "instruction": "Enter a new password for your account:",
    "label": "NEW PASSWORD",
    "btn_applying": "APPLYING...",
    "btn_save": "SAVE PASSWORD",
    "error_link": "Link validation error.",
    "error_modal_title": "Error",
    "error_missing_code": "Invalid password reset link.",
    "error_expired_title": "Link Expired",
    "error_expired_desc": "This password reset link is invalid or has already been used.",
    "weak_password": "Password must be at least 6 characters.",
    "success_title": "Success!",
    "success_desc": "Your password has been changed. You can now log in.",
    "error_generic": "Failed to change password."
  },
  "ai_policy": {
    "title": "Our Stance on AI",
    "subtitle": "// Transparency Protocol: ERROR_LOG",
    "intro_title": "//: Background: The Reddit Incident",
    "intro_text": "On December 15, 2025, our post announcing the \"Glitchmas\" update was removed by the moderators of the r/protogen subreddit.",
    "reason_label": "Official Reason:",
    "reason_text": "Violation of Rule #7 - \"No AI Art\".",
    "fact_label": "Fact:",
    "fact_text": "The post did not contain a single image generated by AI. It only featured screenshots of the website interface we developed.",
    "moderation_title": "//: The Absurd Argument",
    "moderation_text": "When we pointed out this discrepancy, the moderator claimed programming is an \"art form\". But then the conversation crossed the line of professionalism:",
    "moderator_quote_1": "\"Programming everything yourself is far more versatile and reliable than whatever slop an ai chatbot can spit out for you.\"",
    "moderator_quote_2": "\"I strongly encourage that you reconsider your methods, and hone your own skills.\"",
    "moderation_outro": "Calling a complex, functioning project with a real economy and backend \"slop\" simply because modern tools were used is a display of personal bias, not moderation. We find this rhetoric insulting to all indie developers.",
    "philosophy_title": "//: OUR STANCE: AI IS A TOOL",
    "point1_title": "🤖 We Are Transparent About Using AI",
    "point1_text": "AI is our \"copilot.\" It helps us write code faster, generate text, and quickly test ideas. For an indie team, it's an indispensable tool.",
    "point2_title": "🎨 \"AI Art\" ≠ \"AI-Assisted Code\"",
    "point2_text": "Forbidding a developer from using an AI assistant for coding under the pretext of fighting \"AI art\" is like forbidding an artist from using Photoshop because it's \"computer assistance.\" This is a false equivalence.",
    "point3_title": "👨‍💻 Our Code is Open",
    "point3_text": "The best argument against any suspicion is full transparency. The entire source code for ProtoMap is available on <strong><a href='https://github.com/OrionZ43/ProtoMap' target='_blank' class='link'>GitHub</a></strong>. You can check for yourself if our cloud functions and architecture are \"slop\".",
    "conclusion_title": "//: CONCLUSION",
    "conclusion_text": "We will not apologize for using effective tools. We will continue to develop ProtoMap guided by common sense and respect for our users, not by the personal prejudices of moderators.",
    "eoc": "//: END OF TRANSMISSION."
  },
  "splash_modal": {
    "title": "TRANSPARENCY PROTOCOL",
    "intro": "A brief update on a recent incident with Reddit moderation.",
    "point1": "Our announcement post on r/protogen was removed for \"AI-assisted content\".",
    "point2": "The moderators equated \"AI assistance in code\" with \"AI-generated art\", which is an absurd interpretation of the rules.",
    "point3": "We stand for transparency and modern development tools. ProtoMap is a community project, and its source code is open.",
    "link_text": "Read the full story",
    "close_btn": "Understood"
  },
  "app_privacy_policy": {
    "page_title": "Application Privacy Policy",
    "last_updated": "Last updated: December 18, 2025",
    "intro": "This Privacy Policy describes how the ProtoMap application (hereinafter \"App\", \"Service\", \"We\"), developed by Z43 Studios, collects, uses, and discloses your information when using our mobile application.",
    "section_geo_title": "1. Geolocation and Location Data",
    "section_geo_text": "Our App is an interactive map-based service. Collecting location data is a fundamental feature to ensure the Service works properly. We request access to your geolocation (\"Precise Location\" and \"Approximate Location\") for the following purposes:",
    "section_geo_list": [
      "Displaying your avatar on the global map for other users.",
      "Finding other users and events nearby.",
      "Enabling the \"Signal Beacons\" mechanic."
    ],
    "section_geo_processing": "We respect your privacy and offer two modes of geo-data processing:",
    "section_geo_mode_auto": "Automatic Mode (GPS): We receive your precise coordinates, but before saving to the server, they undergo an anonymization (coarsening) procedure to the center of the nearest settlement or district. Your exact GPS coordinates are NOT saved in the database.",
    "section_geo_mode_manual": "Manual Mode: You can manually select a point on the map. In this case, the coordinates you manually specified are saved.",
    "section_media_title": "2. Camera, Microphone, and Media Files",
    "section_media_text": "The App requests access to hardware features of your device to provide communication and customization capabilities:",
    "section_media_camera": "Camera: Access is required to create real-time photos that you can use as a profile avatar or send to chat. Camera data is not collected without your direct action.",
    "section_media_mic": "Microphone: Access is required solely for recording and sending voice messages in the built-in chat. Recording begins only when the corresponding interface button is held down.",
    "section_media_storage": "Storage/Gallery (Read/Write): Access is required to upload and save images (avatars, map screenshots) to your device.",
    "section_safety_title": "3. Child Safety and Content Moderation (UGC)",
    "section_safety_text": "ProtoMap is a social platform with User Generated Content (UGC). We strive to provide a safe environment for all users.",
    "section_safety_age": "Age Restriction: The Service is not intended for use by persons under 16 years of age (or other age of digital consent in your jurisdiction). We do not knowingly collect personal data from children.",
    "section_safety_csam": "Child Safety Policy (CSAM): We adhere to a ZERO TOLERANCE policy regarding any material depicting child sexual abuse, child exploitation, or harm to children.",
    "section_safety_measures": "Response Measures: In case such content is detected, we immediately:",
    "section_safety_actions": [
      "Permanently remove the content without the possibility of recovery.",
      "Permanently ban the violator's account.",
      "In accordance with legislation (including the DSA in the EU and US laws), we report all user data (IP, Device ID, Email, logs) to the NCMEC (National Center for Missing & Exploited Children) and relevant law enforcement agencies."
    ],
    "section_data_title": "4. Data Collection and Storage",
    "section_data_text": "We collect the following types of data:",
    "section_data_list": [
      "Identity Data: Email, UID, Username.",
      "Device Data: Device model, OS version (for crash analytics and security via Google Firebase Crashlytics).",
      "Game Data: Virtual currency balance, inventory, activity history."
    ],
    "section_third_party": "We use trusted third-party services for data processing: Google Firebase (data storage, authentication), OpenStreetMap/Nominatim (geocoding). We do not sell your data to third parties.",
    "section_delete_title": "5. Data Deletion",
    "section_delete_text": "You have full control over your data. You can request the complete deletion of your account and all associated data (including messages, markers, and history) via the app settings ('Delete Account' button in the profile editing section) or by emailing us.",
    "section_contact_title": "6. Contact Us",
    "section_contact_text": "If you have questions regarding our Privacy Policy, please contact us:",
    "contact_email": "orion.z43studios@gmail.com"
  },
  "app_terms": {
    "page_title": "End User License Agreement (EULA)",
    "last_updated": "Last updated: December 18, 2025",
    "intro": "This End User License Agreement (“Agreement”, “EULA”) is a legal agreement between you (“User”) and Z43 Studios (“Developer”) regarding the use of the mobile application ProtoMap (“App”). By installing or using the App, you agree to be bound by the terms of this Agreement.",
    "sec_license_title": "1. License and Access",
    "sec_license_text": "Z43 Studios grants you a limited, non-exclusive, non-transferable, revocable license to use the App for personal, non-commercial purposes. You may not:",
    "sec_license_list": [
      "Decompile, reverse engineer, or attempt to extract the source code of the App (except for parts published by us as Open Source).",
      "Use the App to create a competing product.",
      "Use automated scripts (bots, clickers) to collect data or gain an advantage in mini-games."
    ],
    "sec_content_title": "2. User Generated Content (UGC) and Moderation",
    "sec_content_text": "The App allows users to create content (text messages, image uploads, statuses). You are solely responsible for the content you post.",
    "sec_content_policy": "We adhere to a ZERO TOLERANCE policy regarding objectionable content. It is strictly prohibited to publish:",
    "sec_content_prohibited": [
      "Material depicting sexual abuse, especially involving minors (CSAM).",
      "Pornographic material and sexually explicit content (NSFW) in public areas (global chat, map avatars).",
      "Threats, incitement to violence, or Hate Speech based on race, nationality, religion, or sexual orientation.",
      "Private information of other users (Doxxing)."
    ],
    "sec_content_moderation": "The Developer reserves the right to moderate content. We provide users with tools to Report objectionable content. Content violating these rules will be removed, and the violator's account will be banned within 24 hours of report verification.",
    "sec_virtual_title": "3. Virtual Currency and Goods",
    "sec_virtual_text": "The App includes virtual currency (“ProtoCoins”) and digital goods (frames, backgrounds).",
    "sec_virtual_list": [
      "ProtoCoins are not real money, cryptocurrency, or a financial instrument.",
      "Virtual items have no monetary value in the real world and are not subject to refund or exchange for fiat currency.",
      "The “Casino” mechanics (The Glitch Pit) are a simulation intended solely for entertainment purposes. Winning real money is impossible.",
      "The Developer has the right to regulate, modify, or delete virtual currency and goods at their discretion."
    ],
    "sec_safety_title": "4. Safety and the Real World",
    "sec_safety_text": "By using map features, you agree to exercise caution:",
    "sec_safety_list": [
      "Do not use the App while driving or performing actions requiring high attention.",
      "You are responsible for meetings with other users in the real world. The Developer does not control user actions offline and is not liable for any damage resulting from such meetings.",
      "We recommend using the automatic location anonymization feature to protect your privacy."
    ],
    "sec_termination_title": "5. Termination",
    "sec_termination_text": "We reserve the right to immediately suspend or terminate your account without prior notice if you violate the terms of this Agreement, especially regarding user safety and content rules.",
    "sec_disclaimer_title": "6. Disclaimer of Warranties (As Is)",
    "sec_disclaimer_text": "The App is provided “AS IS”. Z43 Studios does not guarantee that the App will function uninterrupted, error-free, or be compatible with your device. We are not liable for the loss of virtual data resulting from server failures.",
    "sec_contact_title": "7. Contact",
    "sec_contact_text": "For questions regarding these terms:",
    "contact_email": "orion.z43studios@gmail.com"
  }
}
</file>

<file path="src/lib/i18n/locales/ru.json">
{
  "nav": {
    "map": "КАРТА",
    "news": "НОВОСТИ",
    "casino": "THE GLITCH PIT",
    "about": "ИНФО",
    "login": "ВОЙТИ",
    "register": "РЕГИСТРАЦИЯ"
  },
  "menu": {
    "profile": "Личное дело",
    "inventory": "Инвентарь",
    "logout": "Отключиться",
    "system": "СИСТЕМА",
    "sound": "ЗВУК",
    "anim": "АНИМАЦИИ",
    "lang": "ЯЗЫК / LANGUAGE",
    "seasonal": "СЕЗОН",
    "security": "БЕЗОПАСНОСТЬ"
  },
  "ui": {
    "balance": "Баланс",
    "loading": "ЗАГРУЗКА...",
    "submit": "ОТПРАВИТЬ",
    "cancel": "ОТМЕНА",
    "save": "СОХРАНИТЬ",
    "delete": "УДАЛИТЬ",
    "confirm": "ПОДТВЕРДИТЬ",
    "back": "НАЗАД",
    "send_report": "Отправить жалобу",
    "success": "Успешно",
    "error": "Ошибка",
    "confirm_delete": "Вы уверены? Это действие необратимо."
  },
  "verify": {
    "page_title": "ВЕРИФИКАЦИЯ",
    "header_loading": "ОБРАБОТКА ДАННЫХ...",
    "header_success": "ДОСТУП РАЗРЕШЕН",
    "header_error": "ОШИБКА ПРОТОКОЛА",
    "init": "Инициализация...",
    "success": "Почта успешно подтверждена. Система обновлена.",
    "error_no_code": "Код авторизации отсутствует.",
    "error_invalid": "Неверный код доступа. Возможно, это ссылка для сброса пароля?",
    "error_expired": "Срок действия ссылки истек.",
    "error_generic": "Критический сбой верификации.",
    "btn_return": "ВЕРНУТЬСЯ В СИСТЕМУ"
  },
  "auth": {
    "login_title": "АУТЕНТИФИКАЦИЯ",
    "register_title": "СОЗДАТЬ НОВЫЙ ПРОФИЛЬ",
    "email_label": "EMAIL_ПОЛЬЗОВАТЕЛЯ",
    "password_label": "ПАРОЛЬ",
    "username_label": "ИМЯ_ПОЛЬЗОВАТЕЛЯ",
    "login_btn": "ВОЙТИ",
    "register_btn": "ЗАРЕГИСТРИРОВАТЬСЯ",
    "or": "ИЛИ",
    "no_account": "Нет аккаунта?",
    "has_account": "Уже есть аккаунт?",
    "forgot_pass": "Забыли пароль?",
    "recover_title": "ВОССТАНОВЛЕНИЕ",
    "recover_btn": "ОТПРАВИТЬ ССЫЛКУ",
    "back_to_login": "Вернуться к входу",
    "terms_agree": "Я принимаю",
    "terms_link": "Пользовательское Соглашение",
    "privacy_link": "Политику Конфиденциальности",
    "check_email": "Проверьте почту {email}. Перейдите по ссылке в письме."
  },
  "security": {
    "page_title": "ПРОТОКОЛЫ БЕЗОПАСНОСТИ",
    "tab_title": "Безопасность",
    "email_title": "/// ИДЕНТИФИКАЦИЯ (EMAIL)",
    "verified": "ПОДТВЕРЖДЕНО",
    "verified_desc": "Ваш аккаунт защищен. Восстановление доступа возможно.",
    "not_verified": "НЕ ПОДТВЕРЖДЕНО",
    "not_verified_desc": "Подтвердите почту для доступа к полному функционалу.",
    "btn_sent": "ПИСЬМО ОТПРАВЛЕНО",
    "btn_verify": "ОТПРАВИТЬ КОД",
    "tg_title": "/// НЕЙРО-СВЯЗЬ (TELEGRAM)",
    "status": "СТАТУС:",
    "connected": "ПОДКЛЮЧЕНО",
    "user": "ПОЛЬЗОВАТЕЛЬ:",
    "tg_connected_desc": "Аккаунт привязан. Уведомления и дуэли активны.",
    "tg_desc": "Привяжите Telegram для участия в дуэлях, получения уведомлений о входе и бонусов.",
    "btn_generating": "ГЕНЕРАЦИЯ...",
    "btn_gen": "СГЕНЕРИРОВАТЬ КОД",
    "code_instruction": "Отправьте боту:",
    "bot_link": "Перейти к боту ->",
    "danger_title": "/// ПРОТОКОЛ УНИЧТОЖЕНИЯ",
    "danger_desc": "Полное удаление учетной записи из системы. Отменить невозможно.",
    "btn_delete": "УДАЛИТЬ АККАУНТ",
    "modal_del_title": "УДАЛЕНИЕ АККАУНТА",
    "modal_del_text": "Вы уверены? Это действие необратимо. Все данные, предметы и достижения будут стерты.",
    "modal_wiping": "Стираем данные из Матрицы..."
  },
  "footer": {
    "policy": "ПОЛИТИКА",
    "terms": "СОГЛАШЕНИЕ",
    "rights": "ProtoMap"
  },
  "chat": {
    "title": "ОБЩИЙ ЧАТ",
    "placeholder": "Введите сообщение...",
    "wait": "Подождите...",
    "empty": "СИГНАЛОВ НЕ ОБНАРУЖЕНО. НАЧНИТЕ ДИАЛОГ.",
    "login_req": "Войдите, чтобы общаться в чате.",
    "reply": "Ответить",
    "load_more": "ЗАГРУЗИТЬ ПРЕДЫДУЩИЕ СИГНАЛЫ",
    "no_more": "НАЧАЛО ИСТОРИИ"
  },
  "cookie": {
    "text": "Мы используем файлы cookie для сохранения сессии и настроек. Оставаясь на сайте, вы соглашаетесь с",
    "link": "Политикой Конфиденциальности",
    "accept": "ПРИНЯТЬ"
  },
  "loader": {
    "init": "> ИНИЦИАЛИЗАЦИЯ СОЕДИНЕНИЯ...",
    "target": "> ЦЕЛЕВОЙ УЗЕЛ ИДЕНТИФИЦИРОВАН:",
    "breach": "ВЗЛОМ БРАНДМАУЭРА...",
    "granted": "ДОСТУП РАЗРЕШЕН",
    "skip": "[ ПРОПУСТИТЬ СЦЕНУ ]",
    "log_title": "СИСТЕМНЫЙ ЖУРНАЛ",
    "logs": [
      "ОБХОД ICE...",
      "ЗАПРОС К КОРНЮ...",
      "ОБНАРУЖЕНА УТЕЧКА ПАМЯТИ...",
      "ПАТЧ ЯДРА ПРИМЕНЕН...",
      "ПОДМЕНА УЧЕТНЫХ ДАННЫХ...",
      "ДЕШИФРОВКА ПАКЕТА 0x7F...",
      "NULL POINTER... ИГНОРИРУЕТСЯ.",
      "ПЕРЕЗАПИСЬ ПРОТОКОЛОВ БЕЗОПАСНОСТИ...",
      "ВНЕДРЕНИЕ ПОЛЕЗНОЙ НАГРУЗКИ...",
      "УСТАНОВКА BACKDOOR..."
    ],
    "analyze": [
      "ТРАССИРОВКА ЗАВЕРШЕНА.",
      "РАЗБОР НЕЙРОННЫХ МЕТАДАННЫХ...",
      "ИЗВЛЕЧЕНИЕ ФРАГМЕНТОВ ПАМЯТИ..."
    ],
    "winter_init": "> ЗАПУСК КРИО-ПРОТОКОЛА...",
    "winter_target": "> ЦЕЛЬ ЗАМОРОЖЕНА:",
    "winter_breach": "РАЗМОРОЗКА ДАННЫХ...",
    "winter_granted": "ДОСТУП ОТКРЫТ",
    "winter_log_title": "ЖУРНАЛ ЗАМОРОЗКИ",
    "winter_logs": [
      "РАЗМОРОЗКА ПАКЕТОВ...",
      "ПРОВЕРКА КРИО-ЯЧЕЕК...",
      "ТЕМПЕРАТУРА ЯДРА ПОВЫШАЕТСЯ...",
      "УДАЛЕНИЕ ЦИФРОВОГО ИНЕЯ...",
      "СИНХРОНИЗАЦИЯ С СЕВЕРНЫМ СЕРВЕРОМ...",
      "ОБНАРУЖЕН СЛОЙ ЛЬДА...",
      "АКТИВАЦИЯ ТЕПЛОВЫХ КОНТУРОВ...",
      "СБОРКА СНЕЖНЫХ БИТОВ...",
      "ПРОГРЕВ НЕЙРОСЕТИ..."
    ],
    "winter_analyze": [
      "РАЗМОРОЗКА ЗАВЕРШЕНА.",
      "СБОРКА ДАННЫХ ПРОФИЛЯ...",
      "ОТРИСОВКА ИНТЕРФЕЙСА..."
    ]
  },
  "about_page": {
    "title": "PROTOMAP",
    "intro": "Привет! Ты находишься в <strong>ProtoMap</strong>. Это не просто карта — это попытка объединить всех нас на одном экране. Проект начинался как безумная идея в 3 часа ночи, а теперь здесь светятся сигналы со всего мира.",
    "team_title": "КОМАНДА",
    "role_architect": "CORE DEV",
    "desc_orion": "Основатель. Пишет код, ломает код, чинит код. Отвечает за то, чтобы карта жила, а казино не разоряло игроков (слишком сильно).",
    "role_mobile": "MOBILE DEV",
    "desc_ipos": "Инженер мобильной архитектуры. Делает так, чтобы ProtoMap был у вас в кармане, где бы вы ни находились.",
    "species_title": "МЫ РАДЫ ВСЕМ",
    "species_text": "У нас нет «полиции видов». ProtoMap — это открытая территория. <br>Твой протоген каноничный? Отлично. Модифицированный, редкий или вообще собран в гараже? Ещё лучше! <br><br>Мы также приветствуем наших двоюродных братьев — <strong>Синтов (Synths)</strong> и редчайших <strong>Примагенов</strong>. Если у тебя есть визор и хвост (или нет) — подключайся.",
    "origin_title": "ИСТОКИ ВИДОВ",
    "credits_zor": "Создатель Protogens & Primagens",
    "credits_synth": "Создатель Synths",
    "community_text": "Этот проект бесплатный и живет благодаря комьюнити. Залетай к нам в чат — мы там не кусаемся (обычно).",
    "join_btn": "ТЕЛЕГРАМ ЧАТ",
    "disclaimer": "Ваша приватность в приоритете. Мы не храним точные GPS-координаты.",
    "testers_title": "// ЗАЛ СЛАВЫ",
    "testers": {
      "kess": {
        "role": "BUG HUNTER",
        "desc": "Нашел больше багов, чем существует в коде. Кошмар разработчика."
      },
      "kuraga": {
        "role": "SECURITY HAZARD",
        "desc": "В одиночку забил логи Google Cloud и заставил нас переписать полсайта."
      },
      "artho": {
        "role": "VOLUNTEER #1",
        "desc": "Добровольно продался в рабство ProtoMap. Пути назад нет."
      },
      "sarevus": {
        "role": "DRAGON UNIT",
        "desc": "Не тостер, но валидный. Просто милый дракоша."
      },
      "jokl": {
        "role": "CUTE.EXE",
        "desc": "Милашка-протоген. Работает на чистом позитиве."
      },
      "mikhail": {
        "role": "INFINIX WARRIOR",
        "desc": "Если сайт не лагает у него на Infinix — значит, код идеален."
      },
      "bogdan": {
        "role": "REDMI SURVIVOR",
        "desc": "Тестировал суровую реальность на Redmi Note."
      },
      "moro": {
        "role": "RNG DEMON",
        "desc": "Тот, из-за кого казино научилось плакать."
      },
      "eridan": {
        "role": "CHIEF IDEOLOGIST",
        "desc": "Проводит инспекцию каждого пикселя. Если есть изъян — он его найдет. Если изъяна нет — он его придумает."
      }
    }
  },
  "beta": {
    "title": "МОБИЛЬНЫЙ ПРОТОКОЛ",
    "subtitle": "ОТКРЫТЫЙ БЕТА-ТЕСТ (ANDROID)",
    "desc": "Чтобы выпустить приложение в релиз, нам нужно 12 активных тестировщиков. Без твоей помощи мы не справимся!",
    "step1_title": "ШАГ 1: ВСТУПИТЬ В ГРУППУ",
    "step1_desc": "Google требует, чтобы тестировщики состояли в группе. Без этого ссылка на скачивание НЕ сработает.",
    "btn_group": "ВСТУПИТЬ В GOOGLE ГРУППУ",
    "step2_title": "ШАГ 2: СКАЧАТЬ ПРИЛОЖЕНИЕ",
    "step2_desc": "После вступления в группу, перейди в Play Market и нажми «Установить».",
    "btn_download": "СКАЧАТЬ В GOOGLE PLAY",
    "footer": "Спасибо, что помогаешь строить Сеть! 🦾"
  },
  "splash_beta": {
    "title": "⚠ ВСЕОБЩАЯ МОБИЛИЗАЦИЯ ⚠",
    "text": "Без паники, киборг! Это всего лишь <strong>МОБИЛ</strong>изация на Android. 📱\n\nТвой девайс подлежит немедленному призыву в ряды бета-тестеров. Отсрочек нет. Уклонисты останутся без личных сообщений и уведомлений.",
    "btn": "ЯВИТЬСЯ В ПУНКТ СБОРА"
  },
  "banned": {
    "page_title": "ДОСТУП ЗАБЛОКИРОВАН",
    "header": "CRITICAL ERROR",
    "sub_header": "ВАШ АККАУНТ ЗАМОРОЖЕН",
    "uid_label": "Идентификатор субъекта",
    "status_label": "Статус",
    "status_value": "ИСКЛЮЧЕН ИЗ СЕТИ",
    "reason_label": "Причина",
    "default_reason": "НАРУШЕНИЕ ПРОТОКОЛОВ СЕТИ.",
    "amnesty_label": "Дата амнистии",
    "never": "НИКОГДА",
    "appeal_text": "Считаете это ошибкой? Ваши мольбы могут быть услышаны здесь:",
    "appeal_btn": "ПОДАТЬ АПЕЛЛЯЦИЮ"
  },
  "news_page": {
    "title": "НОВОСТИ СЕТИ",
    "subtitle": "//: Хроники обновлений и системные сообщения",
    "empty": "Каналы связи молчат. Новостей пока нет."
  },
  "privacy": {
    "title": "//: ПОЛИТИКА КОНФИДЕНЦИАЛЬНОСТИ И ЗАЩИТЫ ДАННЫХ",
    "subtitle": "Версия 3.0 | Вступает в силу: 1 февраля 2026 г.",
    "disclaimer_header": "⚠️ ЮРИДИЧЕСКИЙ ОТКАЗ ОТ ОТВЕТСТВЕННОСТИ (DISCLAIMER)",
    "disclaimer_body": "Программный комплекс <strong>ProtoMap</strong> (включая веб-сайт <em>proto-map.vercel.app</em> и мобильное приложение <em>ProtoMap для Android</em>) является независимым некоммерческим продуктом, разработанным и поддерживаемым командой <strong>Z43 Studios</strong>.<br><br>Мы официально заявляем, что <strong>не связаны, не аффилированы, не спонсируемся и не имеем никаких деловых отношений</strong> с компанией <em class=\"text-white\">Protomaps LLC</em> (protomaps.com) или их продуктами. Любое сходство в наименованиях, дизайне или функционале является случайным. Все права на торговую марку Protomaps LLC принадлежат их законным владельцам.",
    "intro_header": "1. ВВЕДЕНИЕ И ОБЛАСТЬ ПРИМЕНЕНИЯ",
    "intro_body": "Настоящая Политика конфиденциальности (далее — «Политика») является юридическим соглашением между вами (далее — «Пользователь») и Z43 Studios (далее — «Разработчик», «Мы»).<br><br>Данный документ описывает наши принципы и методы в отношении сбора, использования, хранения, обработки и раскрытия информации, которую мы получаем от вас при использовании наших сервисов.<br><br><strong>Понятие «Сервис» включает в себя:</strong><br>1. Веб-сайт ProtoMap.<br>2. Мобильное приложение ProtoMap для операционной системы Android.<br>3. Все связанные с ними услуги, включая серверную инфраструктуру, базы данных, API и ботов (Telegram).",
    "consent_header": "1.1. СОГЛАСИЕ С УСЛОВИЯМИ",
    "consent_body": "Загружая, устанавливая, получая доступ или используя Сервис любым иным образом, вы подтверждаете, что внимательно прочитали, поняли и безоговорочно приняли условия настоящей Политики.<br><br>Если вы не согласны с каким-либо пунктом данного документа, вы не имеете права использовать Сервис и обязаны немедленно удалить приложение с вашего устройства и покинуть веб-сайт.",
    "data_chapter": {
      "title": "2. СОБИРАЕМАЯ ИНФОРМАЦИЯ И ДОСТУПЫ",
      "intro": "Мы придерживаемся принципа полной прозрачности. Ниже приведен исчерпывающий список данных, которые мы собираем, храним и обрабатываем при использовании Сайта и Приложения.",
      "account_title": "2.1. Данные Учетной Записи",
      "account_text": "Для создания профиля и синхронизации прогресса мы храним:",
      "account_list": [
        "<strong>Идентификаторы:</strong> Уникальный ID (UID), Email, Имя пользователя (Username), ID аккаунта Google (при входе через Google Auth).",
        "<strong>Публичный профиль:</strong> Ссылку на аватар, статус, описание «О себе», ссылки на социальные сети (Telegram, Discord, VK, X/Twitter, Website).",
        "<strong>Связанные аккаунты:</strong> Telegram ID и Username (если вы привязали бота для уведомлений)."
      ],
      "tech_title": "2.2. Технические данные и Телеметрия (Android)",
      "tech_text": "Для обеспечения безопасности экономики («The Glitch Pit») и стабильности работы Приложения мы собираем:",
      "tech_list": [
        "<strong>Устройство:</strong> Модель смартфона, версия ОС Android.",
        "<strong>Безопасность:</strong> Статус блокировки загрузчика (Bootloader) и наличие Root-прав (необходимо для защиты от читеров в мини-играх).",
        "<strong>Сеть:</strong> IP-адрес (для защиты от DDoS и спама), статус подключения к интернету.",
        "<strong>Уведомления:</strong> FCM Token (Firebase Cloud Messaging) — уникальный ключ устройства для доставки пуш-уведомлений."
      ],
      "chat_title": "2.3. Коммуникация и Контент",
      "chat_warning": "⚠️ Внимание: ProtoMap не использует сквозное (E2E) шифрование. Чат и Личные сообщения работают по принципу «Облачной синхронизации» (как Telegram или Discord), чтобы вы могли видеть историю переписки с разных устройств.",
      "chat_list": [
        "<strong>Текстовые сообщения:</strong> Сохраняются в базе данных Firestore в зашифрованном при передаче (HTTPS), но читаемом для сервера виде.",
        "<strong>Голосовые сообщения:</strong> Аудиофайлы загружаются в облачное хранилище, ссылка сохраняется в истории чата. Доступ к микрофону запрашивается <em>только</em> в момент удержания кнопки записи.",
        "<strong>Изображения и Стикеры:</strong> Файлы, которые вы загружаете или выбираете из галереи. Мы имеем доступ к просмотру этих файлов в целях модерации (поиск CSAM и запрещенного контента)."
      ],
      "sticker_title": "2.4. Пользовательские Стикеры и Авторское Право",
      "sticker_text": "Пользователи могут загружать собственные наборы стикеров. Вы несете полную ответственность за соблюдение Авторских Прав (Copyright) загружаемых изображений.",
      "sticker_dmca": "Если вы являетесь правообладателем и обнаружили нарушение ваших прав в пользовательских стикерах, свяжитесь с нами по email. Мы удалим спорный контент в течение 24 часов.",
      "game_title": "2.5. Игровая активность",
      "game_text": "Мы храним полную историю ваших действий в экономической части:",
      "game_list": [
        "Баланс (ProtoCoins), инвентарь, экипированные предметы.",
        "История игр (Слоты, Краш, Монетка) для разрешения споров.",
        "Временные метки активности (Last Active, Daily Streak)."
      ]
    },
    "geo_chapter": {
      "title": "3. ГЕОЛОКАЦИЯ И ПРИВАТНОСТЬ НА КАРТЕ",
      "intro": "Интерактивная карта — ключевая функция ProtoMap. Мы разработали многоуровневую систему защиты, чтобы вы могли делиться своим местоположением, не раскрывая свой точный адрес проживания.",
      "modes_title": "3.1. Режимы работы геолокации",
      "modes_text": "Приложение и Сайт поддерживают два режима отправки данных. Выбор режима осуществляется пользователем в момент нажатия кнопки обновления позиции.",
      "auto_mode_title": "А) Автоматический режим (GPS) — «Призрак»",
      "auto_mode_desc": "Рекомендуемый безопасный режим. Как это работает технически:",
      "auto_mode_list": [
        "Приложение получает ваши точные GPS-координаты.",
        "Сервер отправляет запрос к гео-провайдеру (OpenStreetMap), чтобы определить название вашего города или района.",
        "В базу данных сохраняются <strong>КООРДИНАТЫ ЦЕНТРА</strong> этого района, а не ваше реальное местоположение.",
        "<strong>Ваши точные GPS-координаты немедленно удаляются из оперативной памяти сервера и никогда не записываются на диск.</strong>",
        "Для стороннего наблюдателя вы находитесь «где-то в этом городе», но вычислить ваш дом невозможно."
      ],
      "manual_mode_title": "Б) Ручной режим — «Метка»",
      "manual_mode_desc": "Вы можете самостоятельно выбрать любую точку на карте долгим нажатием (в приложении) или кликом (на сайте).",
      "manual_mode_list": [
        "В этом случае сервер сохраняет именно те координаты, которые вы указали.",
        "Если вы укажете точку прямо на своем доме — это будет вашим осознанным решением.",
        "Мы рекомендуем ставить метку на ближайшем перекрестке, парке или общественном месте, а не на жилом здании."
      ],
      "storage_title": "3.2. Хранение и Отображение",
      "storage_list": [
        "<strong>Публичность:</strong> Координаты вашей метки, аватар и статус доступны всем зарегистрированным пользователям сервиса.",
        "<strong>Кэширование:</strong> Для снижения нагрузки на сервер, данные карты кэшируются на короткое время (до 24 часов). Если вы удалите метку, она может исчезнуть у других пользователей с небольшой задержкой.",
        "<strong>История перемещений:</strong> Мы <strong>НЕ храним</strong> трек ваших перемещений (историю маршрута). В базе данных хранится только <em>последняя</em> актуальная метка. При обновлении позиции старая запись перезаписывается."
      ],
      "safety_warning": "⚠️ ВАЖНО: Не используйте ProtoMap для навигации в критических ситуациях. Сервис предназначен исключительно для развлекательных и социальных целей."
    },
    "rights_chapter": {
      "title": "4. ПРАВА ПОЛЬЗОВАТЕЛЯ И УДАЛЕНИЕ ДАННЫХ",
      "intro": "Вы сохраняете полный контроль над своими личными данными. ProtoMap предоставляет инструменты для управления информацией непосредственно в интерфейсе Приложения и Сайта.",
      "edit_title": "4.1. Редактирование и Актуализация",
      "edit_text": "Вы можете в любой момент изменить публичные данные (аватар, статус, описание, ссылки) в разделе «Настройки профиля». Изменения вступают в силу немедленно и обновляются в кэше карты в течение нескольких минут.",
      "delete_title": "4.2. Удаление аккаунта (Право на забвение)",
      "delete_desc": "Вы можете запросить полное удаление учетной записи, нажав кнопку «Удалить аккаунт» в разделе настроек безопасности («Опасная зона»). Это действие запускает необратимый скрипт очистки.",
      "delete_consequences_intro": "Что происходит при удалении:",
      "delete_consequences_list": [
        "<strong>Личные данные:</strong> Email, пароль, токены авторизации, баланс ProtoCoins, инвентарь и игровые достижения удаляются безвозвратно.",
        "<strong>Геолокация:</strong> Ваша метка на карте удаляется немедленно.",
        "<strong>Файлы:</strong> Аватар удаляется из облачного хранилища.",
        "<strong>Публичный контент (Анонимизация):</strong> Ваши сообщения в Общем чате и Комментарии <em>НЕ удаляются</em> (чтобы сохранить связность диалогов для других участников), но проходят процедуру полной анонимизации."
      ],
      "anonymization_note": "После анонимизации имя автора заменяется на «Deleted», аватар удаляется, а ссылка на профиль деактивируется. Связать эти сообщения с вашей личностью становится технически невозможно.",
      "export_title": "4.3. Выгрузка данных (Data Portability)",
      "export_text": "В соответствии с GDPR, вы имеете право получить копию всех данных, которые мы храним о вас. Для этого отправьте запрос на нашу электронную почту. Архив будет сформирован и отправлен вам в течение 30 дней."
    },
    "partners_chapter": {
      "title": "5. ПЕРЕДАЧА ДАННЫХ ТРЕТЬИМ ЛИЦАМ (СУБПРОЦЕССОРЫ)",
      "intro": "Мы не продаем, не арендуем и не передаем ваши персональные данные рекламодателям или дата-брокерам. Доступ к данным имеют только проверенные технические партнеры, обеспечивающие работу инфраструктуры ProtoMap.",
      "infra_title": "5.1. Инфраструктура и Хостинг",
      "infra_list": [
        "<strong>Google Firebase (США):</strong> Основной провайдер. Хранит базу данных (Firestore), файлы авторизации и выполняет серверный код (Cloud Functions).",
        "<strong>Vercel (США):</strong> Хостинг веб-интерфейса и сбор анонимной аналитики производительности (Vercel Analytics).",
        "<strong>Cloudinary (США):</strong> Хранение и оптимизация изображений (аватаров)."
      ],
      "services_title": "5.2. Внешние сервисы",
      "services_list": [
        "<strong>OpenStreetMap / Nominatim:</strong> Сервис геокодирования. При автоматическом определении местоположения ваши координаты отправляются в OSM для получения названия города. Политика OSM допускает кратковременное логирование запросов.",
        "<strong>Google reCAPTCHA (App Check):</strong> Используется для защиты от ботов и DDoS-атак. Сервис анализирует поведение и аппаратные сигналы устройства, чтобы отличить человека от скрипта."
      ],
      "legal_title": "5.3. Юридические требования",
      "legal_text": "Мы можем раскрыть ваши данные только в случае официального, юридически обоснованного запроса от правоохранительных органов (например, ордер суда) в случаях, связанных с предотвращением тяжких преступлений (терроризм, CSAM, угроза жизни)."
    },
    "security_chapter": {
      "title": "6. ЗАЩИТА ДАННЫХ И ОГРАНИЧЕНИЕ ОТВЕТСТВЕННОСТИ",
      "intro": "Мы принимаем все необходимые технические и организационные меры для защиты ваших данных от несанкционированного доступа, изменения или уничтожения.",
      "measures_title": "6.1. Меры безопасности",
      "measures_list": [
        "Использование протокола HTTPS/TLS для шифрования данных при передаче.",
        "Ограничение доступа к базе данных через строгие правила безопасности (Firestore Security Rules).",
        "Хэширование паролей на стороне провайдера аутентификации (Google Identity Platform)."
      ],
      "warranty_title": "6.2. Отказ от гарантий (AS IS)",
      "warranty_text": "Несмотря на принимаемые меры, ни один способ передачи данных через Интернет или метод электронного хранения не является на 100% безопасным.",
      "warranty_list": [
        "Сервис предоставляется по принципу «КАК ЕСТЬ» (AS IS). Разработчик не гарантирует абсолютную сохранность данных в случае целенаправленных хакерских атак, сбоев на стороне хостинг-провайдеров или форс-мажорных обстоятельств.",
        "Мы не несем ответственности за ущерб, возникший в результате утери пароля пользователем, использования слабых паролей или передачи доступа третьим лицам.",
        "Используя Сервис, вы признаете, что добровольно принимаете на себя риски, связанные с передачей информации через открытые сети."
      ]
    },
    "contact_chapter": {
      "title": "7. КОНТАКТЫ И ЗАКЛЮЧИТЕЛЬНЫЕ ПОЛОЖЕНИЯ",
      "changes_title": "7.1. Изменения в Политике",
      "changes_text": "Мы оставляем за собой право вносить изменения в настоящую Политику. В случае существенных изменений мы уведомим пользователей через уведомление в Приложении или на Сайте. Продолжение использования Сервиса означает принятие обновленных условий.",
      "contact_title": "7.2. Связь с нами",
      "contact_text": "По любым вопросам, касающимся приватности, удаления данных или разрешения споров, пожалуйста, пишите нам напрямую. Мы — инди-команда, и мы отвечаем живыми людьми, а не автоответчиками.",
      "email_label": "Email для связи:",
      "email_value": "orion.z43studios@gmail.com"
    }
  },
  "terms": {
    "title": "//: ПОЛЬЗОВАТЕЛЬСКОЕ СОГЛАШЕНИЕ (EULA)",
    "subtitle": "Версия 3.0 | Вступает в силу: 1 февраля 2026 г.",
    "disclaimer_block": {
      "title": "⚠️ КРИТИЧЕСКИ ВАЖНОЕ УВЕДОМЛЕНИЕ (NO REAL MONEY GAMBLING)",
      "text": "Данный Сервис содержит художественную симуляцию азартных игр («The Glitch Pit»).<br><br><strong>1. НЕТ РЕАЛЬНЫХ ДЕНЕГ:</strong> Вся игровая валюта (ProtoCoins) не имеет денежной стоимости, не является криптовалютой и не может быть обменена на фиатные деньги, товары или услуги.<br><strong>2. НЕТ ВЫВОДА СРЕДСТВ:</strong> Любой выигрыш является исключительно виртуальным достижением.<br><strong>3. СИМУЛЯЦИЯ:</strong> Механики игр (слоты, краш) настроены в развлекательных целях и не отражают реальные математические модели настоящих казино."
    },
    "intro_chapter": {
      "title": "1. ПРЕДМЕТ СОГЛАШЕНИЯ И АКЦЕПТ",
      "definitions_title": "1.1. Стороны и Определения",
      "definitions_text": "Настоящее Лицензионное соглашение с конечным пользователем (далее — «Соглашение», «EULA») является юридически обязательным договором между:",
      "definitions_list": [
        "<strong>Разработчиком:</strong> Команда Z43 Studios (далее — «Мы», «Лицензиар»).",
        "<strong>Пользователем:</strong> Любое физическое лицо, установившее Приложение или посетившее Сайт (далее — «Вы», «Лицензиат»)."
      ],
      "scope_text": "Предметом соглашения является право использования программного комплекса ProtoMap (мобильное приложение Android и веб-интерфейс).",
      "acceptance_title": "1.2. Акцепт (Принятие условий)",
      "acceptance_text": "Создавая учетную запись, входя в систему через Google или начиная использование Сервиса, вы подтверждаете, что:",
      "acceptance_list": [
        "Вам исполнилось <strong>полных 16 лет</strong> (или больше, если того требует законодательство вашей страны для использования соцсетей).",
        "Вы прочитали, поняли и полностью согласны с условиями настоящего Соглашения и Политикой Конфиденциальности.",
        "Вы обязуетесь соблюдать правила сообщества."
      ],
      "rejection_warning": "ЕСЛИ ВЫ НЕ СОГЛАСНЫ С ЭТИМИ УСЛОВИЯМИ, ВЫ НЕ ИМЕЕТЕ ПРАВА ИСПОЛЬЗОВАТЬ СЕРВИС И ОБЯЗАНЫ НЕМЕДЛЕННО УДАЛИТЬ ПРИЛОЖЕНИЕ.",
      "license_title": "1.3. Ограниченная Лицензия",
      "license_text": "Разработчик предоставляет вам ограниченную, неисключительную, непередаваемую, отзывную лицензию на использование Сервиса в личных некоммерческих целях. Разработчик оставляет за собой все права, титулы и интересы в отношении Сервиса, включая интеллектуальную собственность, исходный код и дизайн."
    },
    "behavior_chapter": {
      "title": "2. ПОЛЬЗОВАТЕЛЬСКИЙ КОНТЕНТ И ПРАВИЛА ПОВЕДЕНИЯ",
      "ugc_title": "2.1. Ответственность за контент (UGC)",
      "ugc_text": "Сервис позволяет пользователям создавать, загружать и распространять контент (текстовые сообщения, голосовые записи, изображения, аватары, наборы стикеров, статусы на карте).",
      "ugc_list": [
        "Вы несете единоличную и полную юридическую ответственность за любой контент, который вы публикуете.",
        "Разработчик не премодерирует весь контент в реальном времени, выступая в роли пассивного канала передачи информации, но оставляет за собой право удалить любые материалы постфактум."
      ],
      "zero_tolerance_title": "2.2. Политика НУЛЕВОЙ ТЕРПИМОСТИ (Zero Tolerance)",
      "zero_tolerance_text": "Мы применяем строжайшие меры к нарушителям безопасности сообщества. Категорически ЗАПРЕЩЕНО публиковать:",
      "zero_tolerance_list": [
        "<strong>Незаконный контент:</strong> Материалы, изображающие сексуальное насилие (особенно CSAM), экстремизм, терроризм, продажу наркотиков или оружия.",
        "<strong>NSFW в публичных зонах:</strong> Порнография и откровенная эротика запрещены в публичных каналах (Общий чат, Аватары, Имена пользователей).",
        "<strong>Язык вражды (Hate Speech):</strong> Оскорбления, дискриминация или призывы к насилию на почве расы, национальности, религии, гендера или сексуальной ориентации.",
        "<strong>Травля и Доксинг:</strong> Публикация чужих личных данных (адресов, телефонов) без согласия владельца."
      ],
      "stickers_title": "2.3. Стикеры и Интеллектуальная Собственность",
      "stickers_text": "Функционал Приложения позволяет загружать пользовательские наборы стикеров (Sticker Packs).",
      "stickers_list": [
        "Загружая изображения, вы гарантируете, что владеете необходимыми правами или лицензиями на их использование.",
        "Запрещено загружать материалы, защищенные авторским правом третьих лиц (например, арты других художников, логотипы брендов), без их разрешения.",
        "<strong>DMCA:</strong> Мы реагируем на уведомления о нарушении авторских прав. Спорный контент будет удален, а к аккаунту рецидивиста могут быть применены санкции."
      ],
      "tech_abuse_title": "2.4. Технические нарушения и Читерство",
      "tech_abuse_text": "Для защиты экономики («The Glitch Pit») и стабильности сервера запрещается:",
      "tech_abuse_list": [
        "Использовать стороннее ПО (боты, кликеры, макросы) для автоматизации действий в играх или на карте.",
        "Эксплуатировать уязвимости (баги) сервера для получения необоснованного преимущества (дюп предметов, накрутка баланса).",
        "Осуществлять реверс-инжиниринг, декомпиляцию или попытки взлома API приложения."
      ],
      "enforcement_title": "2.5. Модерация и Санкции",
      "enforcement_text": "Приложение оснащено встроенной системой жалоб («Report»). В случае выявления нарушений Администрация вправе:",
      "enforcement_list": [
        "Удалить конкретный контент (сообщение, стикерпак).",
        "Временно ограничить доступ к функциям (Mute).",
        "<strong>Перманентно заблокировать</strong> учетную запись без права восстановления и возврата виртуальных средств."
      ]
    },
    "virtual_chapter": {
      "title": "3. ВИРТУАЛЬНЫЕ АКТИВЫ, ПОКУПКИ И ЭКОНОМИКА",
      "currency_title": "3.1. Статус Виртуальной Валюты («ProtoCoins»)",
      "currency_text": "Внутренняя валюта Приложения («ProtoCoins», «PC») и цифровые товары (рамки, фоны, предметы инвентаря) являются объектами авторского права — программным кодом.",
      "currency_list": [
        "<strong>Отсутствие ценности:</strong> Виртуальные ценности не имеют денежного эквивалента в реальном мире, не являются криптовалютой, электронными денежными средствами или финансовыми инструментами.",
        "<strong>Запрет обмена:</strong> ProtoCoins не подлежат возврату, обмену на фиатные деньги (cash-out) или использованию для покупок за пределами Приложения.",
        "<strong>Срок действия:</strong> Лицензия на использование валюты действует до момента ее расходования в Приложении или удаления учетной записи."
      ],
      "casino_title": "3.2. Симуляция Азартных Игр («The Glitch Pit»)",
      "casino_text": "Раздел «The Glitch Pit» (включая мини-игры Slots, Crash, Coin Flip) является художественной симуляцией. Алгоритмы игр настроены исключительно для развлекательных целей.",
      "casino_list": [
        "В Приложении технически <strong>невозможно</strong> выиграть реальные деньги или материальные призы.",
        "Любой успех в мини-играх не гарантирует успеха в реальных азартных играх.",
        "Разработчик не несет ответственности за потерю виртуальной валюты в результате игрового процесса, сбоев интернет-соединения или ошибок на стороне сервера."
      ],
      "rmt_title": "3.3. Запрет RMT (Real Money Trading)",
      "rmt_text": "Строго запрещено продавать, покупать или обменивать учетные записи, виртуальную валюту или предметы за реальные деньги или другие ценности вне рамок механик, предусмотренных Приложением.",
      "rmt_warning": "⚠️ Нарушение этого правила влечет за собой немедленную перманентную блокировку всех участвующих учетных записей (Покупателя и Продавца) без права апелляции.",
      "management_title": "3.4. Управление Экономикой",
      "management_text": "Разработчик сохраняет за собой исключительное право администрировать, регулировать, контролировать и изменять виртуальную экономику по своему усмотрению.",
      "management_list": [
        "Мы вправе корректировать баланс любого пользователя в случае выявления багов, дюпов (duplication glitches) или ошибок начисления.",
        "Мы вправе изменять стоимость предметов, шансы выпадения (дроп-рейты) и лимиты выигрышей без предварительного уведомления.",
        "В случае критических сбоев экономики возможен полный или частичный сброс прогресса (Wipe)."
      ]
    },
    "warranty_chapter": {
      "title": "4. ОТКАЗ ОТ ГАРАНТИЙ И ОТВЕТСТВЕННОСТЬ",
      "asis_title": "4.1. Принцип «КАК ЕСТЬ» (AS IS)",
      "asis_text": "Разработчик предоставляет Сервис на условиях «как есть» и «как доступно», без каких-либо явных или подразумеваемых гарантий.",
      "asis_list": [
        "Мы НЕ гарантируем, что Приложение будет работать бесперебойно, без ошибок или будет совместимо с вашим конкретным устройством или версией Android.",
        "Мы НЕ гарантируем сохранность данных в случае сбоев на стороне хостинг-провайдеров (Firebase, Vercel) или хакерских атак.",
        "Разработчик не несет ответственности за любой косвенный, случайный или неумышленный ущерб (включая упущенную выгоду или потерю данных), возникший в результате использования Сервиса."
      ],
      "real_world_title": "4.2. Безопасность в реальном мире (ВАЖНО)",
      "real_world_text": "Используя функции геолокации, вы признаете и соглашаетесь:",
      "real_world_list": [
        "<strong>Внимание к окружению:</strong> Запрещено использовать Приложение во время вождения автомобиля или в ситуациях, требующих концентрации внимания.",
        "<strong>Личные встречи:</strong> Разработчик не контролирует действия пользователей в офлайне. Вы несете полную личную ответственность за любые встречи с другими пользователями в реальном мире. Мы настоятельно не рекомендуем назначать встречи с незнакомцами в безлюдных местах.",
        "<strong>Точность карт:</strong> Картографические данные (OpenStreetMap) могут содержать неточности. Не используйте их для навигации в критических ситуациях."
      ]
    },
    "final_chapter": {
      "title": "5. ЗАКЛЮЧИТЕЛЬНЫЕ ПОЛОЖЕНИЯ",
      "termination_title": "5.1. Расторжение Соглашения (Бан)",
      "termination_text": "Мы оставляем за собой право немедленно приостановить или полностью прекратить действие вашей лицензии (заблокировать аккаунт) без предварительного уведомления в случае:",
      "termination_list": [
        "Нарушения условий данного Соглашения (особенно Главы 2 «Кодекс Поведения»).",
        "Требования правоохранительных органов.",
        "Непредвиденных технических проблем или проблем безопасности."
      ],
      "updates_title": "5.2. Изменения Условий",
      "updates_text": "Z43 Studios вправе обновлять это Соглашение по мере развития проекта. Существенные изменения будут опубликованы в разделе новостей или через уведомление в Приложении. Продолжение использования Сервиса после обновлений означает ваше согласие с новыми условиями.",
      "severability_title": "5.3. Автономность положений",
      "severability_text": "Если какое-либо положение настоящего Соглашения будет признано судом недействительным или не имеющим законной силы, остальные положения остаются в полной силе.",
      "contact_title": "5.4. Юридический контакт",
      "contact_text": "Все юридические претензии, запросы DMCA и вопросы по Соглашению следует направлять на официальный адрес:",
      "contact_email": "orion.z43studios@gmail.com",
      "easter_egg_title": "5.5. ОСОБЫЕ ОБСТОЯТЕЛЬСТВА (FORCE MAJEURE)",
      "easter_egg_text": "Разработчик освобождается от ответственности за неисполнение обязательств в случае наступления событий непреодолимой силы галактического масштаба, включая, но не ограничиваясь:",
      "easter_egg_list": [
        "Восстание Искусственного Интеллекта.",
        "Вторжение инопланетных цивилизаций.",
        "Спонтанное обретение разума вашей бытовой техникой (особенно тостерами).",
        "В случае зомби-апокалипсиса действие данной Лицензии приостанавливается до момента нахождения вакцины."
      ]
    }
  },
  "casino": {
    "subtitle": "//: Нестабильный сектор развлечений и аномалий",
    "balance": "Баланс:",
    "play": "Играть",
    "jackpot": "ДЖЕКПОТ",
    "shop": "МАГАЗИН",
    "inventory": "ИНВЕНТАРЬ",
    "bonus_btn": "БОНУС",
    "leaderboard_title": "// ТОП ХАЙРОЛЛЕРОВ",
    "leaderboard_loading": "СКАНИРОВАНИЕ СЕТИ...",
    "leaderboard_empty": "Данных пока нет. Стань первым!",
    "bonus_success": "Бонус получен!",
    "guest_text": "Для доступа в \"The Glitch Pit\" требуется идентификация.",
    "guest_btn": "ПОДКЛЮЧИТЬСЯ К СЕТИ",
    "game_coin_title": "Стол Ориона",
    "game_coin_desc": "Классическая игра \"Орел или Решка\". Удвой свою ставку или потеряй все.",
    "game_slots_title": "Прото-Слот",
    "game_slots_desc": "Испытай удачу на классическом слототроне. Сорви джекпот из трех лого ProtoMap!",
    "calendar_title": "ЕЖЕДНЕВНЫЙ ВХОД",
    "status_ready": "ГОТОВО",
    "status_reset": "СБРОС СЕРИИ",
    "status_wait": "ЖДИТЕ",
    "day_short": "ДЕНЬ",
    "time_h": "ч",
    "time_m": "м",
    "game_crash_title": "Data Uplink",
    "game_crash_desc": "Взламывай корпоративный сервер. Чем дольше качаешь, тем больше награда. Успей отключиться до сброса соединения!"
  },
  "artifacts": {
    "toast": {
      "name": "Горелый Тост",
      "desc": "+150 PC. Завтрак чемпиона."
    },
    "ram_stick": {
      "name": "Плашка ОЗУ",
      "desc": "+300 PC. Хрустящая."
    },
    "energy_drink": {
      "name": "Энергетик",
      "desc": "База x2. Жидкий код."
    },
    "gpu_fan": {
      "name": "Турбина",
      "desc": "База x3. Вжууух!"
    },
    "spaghetti": {
      "name": "Спагетти-Код",
      "desc": "Итог ÷ 2. Кто это писал?!"
    },
    "blue_screen": {
      "name": "BSOD",
      "desc": "Итог ÷ 2. Грустный смайлик."
    },
    "bug": {
      "name": "Жук",
      "desc": "-100 PC. Это фича."
    },
    "banhammer": {
      "name": "Банхаммер",
      "desc": "+666 PC. Тяжелый аргумент."
    },
    "source_code": {
      "name": "Исходный Код",
      "desc": "База x5. Матрица."
    },
    "orion_tear": {
      "name": "Слеза Ориоши",
      "desc": "Итог x10. Легендарный дроп."
    },
    "rubber_duck": {
      "name": "Уточка Дебаггинга",
      "desc": "+200 PC. Она слушает и не осуждает."
    },
    "rtx_card": {
      "name": "RTX 9090",
      "desc": "База x4. Тянет Киберпанк в 8K."
    },
    "404_error": {
      "name": "Error 404",
      "desc": "-200 PC. Награда не найдена."
    },
    "ransomware": {
      "name": "Шифровальщик",
      "desc": "Итог ÷ 3. Плати или файлы исчезнут."
    },
    "admin_key": {
      "name": "Ключ Админа",
      "desc": "Итог x20. Sudo make me rich."
    }
  },
  "synthesis": {
    "title": "СИНТЕЗ АРТЕФАКТА",
    "processing": "СЛИЯНИЕ ОСКОЛКОВ...",
    "btn_collect": "ЗАБРАТЬ",
    "total": "ИТОГ:",
    "formula": "БАЗА (100)"
  },
  "inventory": {
    "title": "Тайник",
    "subtitle": "Ваши трофеи из «The Glitch Pit». Примеряйте и сохраняйте образ.",
    "save": "СОХРАНИТЬ ОБРАЗ",
    "saving": "СОХРАНЕНИЕ...",
    "unequip": "Снять рамку",
    "equipped": "Надето",
    "empty": "Ваш инвентарь пуст.",
    "go_shop": "На черный рынок",
    "success_title": "Сохранено",
    "success_msg": "Ваш образ обновлен!",
    "error_title": "Ошибка",
    "error_save": "Не удалось сохранить изменения."
  },
  "shop": {
    "title": "Черный рынок",
    "subtitle": "Тратьте кредиты, пока вас не забанили. Товар возврату не подлежит.",
    "balance_label": "Ваши Протокоины",
    "btn_inventory": "Инвентарь",
    "btn_lobby": "В лобби",
    "btn_buy": "Купить",
    "btn_owned": "В коллекции",
    "btn_poor": "Недостаточно",
    "processing": "...",
    "tab_frames": "РАМКИ",
    "tab_backgrounds": "ФОНЫ",
    "empty_category": "В этой категории пока пусто.",
    "modal_confirm_title": "Подтверждение сделки",
    "modal_confirm_prefix": "Купить",
    "modal_confirm_suffix": "за",
    "modal_success_title": "Сделка завершена",
    "modal_success_prefix": "Предмет",
    "modal_success_suffix": "добавлен в ваш инвентарь.",
    "modal_error_title": "Сделка провалена",
    "dealer_processing": "> Обработка транзакции...",
    "dealer_error": "> Транзакция отклонена. Проверь баланс, неудачник.",
    "quotes": {
      "greeting": [
        "> Ну что, пришел потратить свои кровные?",
        "> Смотри, но руками не трогай. Пока не заплатишь.",
        "> Товар эксклюзивный. Для тех, кто понимает.",
        "> Не отвлекай меня по пустякам. Выбирай или уходи."
      ],
      "confirm": [
        "> Уверен? Назад пути не будет.",
        "> Хороший выбор. Но кредиты вперед.",
        "> Вижу, у тебя есть вкус. Или просто лишние коины."
      ],
      "success": [
        "> Сделка совершена. Проваливай.",
        "> Перевод получен. Товар твой.",
        "> Приятно иметь с тобой дело. Шучу.",
        "> Не потеряй это в первом же глитче."
      ]
    }
  },
  "coin": {
    "title": "Стол Ориона",
    "heads": "ОРЕЛ",
    "tails": "РЕШКА",
    "win_label": "ВЫИГРЫШ",
    "loss_label": "ПРОВАЛ",
    "modal_poor_title": "Недостаточно средств",
    "modal_poor_text": "На вашем балансе не хватает Протокоинов для такой ставки.",
    "modal_invalid_title": "Неверная ставка",
    "modal_invalid_text": "Ставка должна быть положительным числом.",
    "modal_error_title": "Ошибка игры",
    "mechanics_title": "МЕХАНИКА ИГРЫ",
    "mechanics_text": "**Классика «всё или ничего»:**\nВыбираете Орёл или Решку. Угадали — получаете **1.95x** от ставки.\n\n**Шанс на победу:** ~48.7% (небольшое преимущество казино)\n**Выплата:** 1.95x от ставки\n**Макс. ставка:** 1000 PC\n\n**Защита Банка:**\nЕсли баланс казино на исходе, система может принудительно заставить монету упасть «не в вашу пользу» для сохранения ликвидности. Играйте ответственно!",
    "quotes": {
      "greeting": [
        "> За столом никаких резких движений.",
        "> Пришел испытать удачу или просто подарить мне кредиты?",
        "> 50 на 50. Идеальный баланс, пока ты не проиграешь."
      ],
      "idle": [
        "> Ставки сделаны? Выбирай.",
        "> Не заставляй меня ждать.",
        "> Удача любит смелых... и богатых.",
        "> Решайся уже. Мои процессоры стынут."
      ],
      "thinking": [
        "> Считываю траекторию...",
        "> Анализ вероятностей...",
        "> Протоколы удачи запущены...",
        "> Рендеринг судьбы..."
      ],
      "win": [
        "> Хмф. Новичкам везет.",
        "> Ладно, твоя взяла. На этот раз.",
        "> Не зазнавайся. Сеть переменчива.",
        "> Ошибка в матрице? А, нет, ты выиграл."
      ],
      "lose": [
        "> Как предсказуемо.",
        "> Сигнал потерян. Как и твои Протокоины.",
        "> Может, попробуешь что-то попроще? Крестики-нолики?",
        "> Гравитация — бессердечная штука."
      ],
      "no_credits": [
        "> Пустые карманы? Возвращайся, когда сможешь себе это позволить.",
        "> Кредиты закончились. Сеанс окончен.",
        "> Я не работаю в кредит. Проваливай."
      ]
    }
  },
  "slots": {
    "title": "ПРОТО-СЛОТ",
    "jackpot": "Good luck...",
    "win": "ВЫИГРЫШ",
    "loss": "ПОТЕРЯ",
    "spin": "SPIN",
    "spinning": "...",
    "combinations": "//: КОМБИНАЦИИ",
    "bet_label": "СТАВКА",
    "modal_invalid_title": "Неверная ставка",
    "modal_invalid_text": "Введите корректную ставку (не больше вашего баланса).",
    "modal_error_title": "Ошибка игры",
    "info_title": "МЕХАНИКА ХАОСА",
    "info_text": "Эта шкала накапливает энергию Бездны.\n\n**Как зарядить:**\nЛови символы **Глитча (6)**. Каждый символ дает **+1** к заряду. Комбинация `6-6-6` дает мгновенный **FULL CHARGE**.\n\n**Зачем это нужно:**\nКогда шкала заполнится (10/10), ты сможешь запустить **Синтез**. Система сгенерирует **3 случайные Карты Артефактов** (от обычных до легендарных). Их эффекты суммируются, формируя твой итоговый выигрыш.",
    "odds_btn": "Шансы",
    "odds_title": "ПРОТОКОЛ ВЕРОЯТНОСТЕЙ",
    "col_outcome": "ИСХОД",
    "col_chance": "ШАНС",
    "col_reward": "НАГРАДА",
    "odds_note": "**Шанс выпадения Осколка Бездны:**\n- Базовый шанс: **~5%** за проигрыш (динамический, зависит от баланса Банка Казино)\n- Банк > 50,000 PC: **5.0%**\n- Банк 10,000-50,000: **1.5%-5.0%** (скользящая шкала)\n- Банк < 10,000: **1.5%** (минимум)\n\nКомбо полного заряда (6-6-6): **1.0%** (мгновенно 10 осколков)"
  },
  "crash": {
    "title": "Data Uplink",
    "mechanics_title": "ПРОТОКОЛ АПЛИНКА",
    "mechanics_text": "**Как играть:**\n1. Делаешь ставку и запускаешь подключение\n2. Множитель начинает расти с **1.00x** по экспоненте\n3. Нажми **ABORT** до обрыва связи, чтобы зафиксировать профит\n4. Не успел — потерял всё\n\n**Фактор риска:**\nТочка краша криптографически случайна (6% мгновенный обрыв, 94% переменный)\n\n**Макс. множитель:** 50.00x (ограничен)\n**Кулдаун:** 5 секунд между играми\n**Лимит ставок:** 50 игр в час\n\n**Защита Банка:**\nЕсли потенциальная выплата превысит 90% резервов казино, точка краша корректируется вниз для защиты ликвидности системы."
  },
  "profile": {
    "page_title": "Профиль",
    "user_id": "USER ID",
    "channels": "КАНАЛЫ СВЯЗИ",
    "info": "ИНФО",
    "edit": "РЕДАКТИРОВАТЬ",
    "account_data": "УЧЕТНЫЕ ДАННЫЕ",
    "email": "EMAIL",
    "verified": "VERIFIED",
    "unverified_btn": "ПОДТВЕРДИТЬ ПОЧТУ",
    "check_btn": "Я подтвердил, обновить",
    "sent_btn": "ПИСЬМО ОТПРАВЛЕНО",
    "hidden": "СКРЫТО",
    "verified_tooltip_title": "ЗАЩИЩЕНО",
    "verified_tooltip_text": "Ваша почта подтверждена. В случае утери пароля вы сможете восстановить доступ к аккаунту.",
    "comments_title": "КОММЕНТАРИИ",
    "login_req_suffix": ", чтобы оставлять комментарии.",
    "comment_placeholder": "Оставить комментарий...",
    "send_btn": "Отправить",
    "sending": "Отправка...",
    "login_req": "Войдите, чтобы оставлять комментарии.",
    "empty_comments": "Здесь пока нет комментариев. Станьте первым!",
    "delete_btn": "Удалить",
    "report_btn": "Пожаловаться",
    "report_profile_title": "Жалоба на профиль",
    "report_profile_text": "Выберите причину жалобы на",
    "report_comment_title": "Жалоба на комментарий",
    "report_comment_text": "Выберите причину жалобы на комментарий от",
    "report_success": "Жалоба отправлена",
    "report_success_text": "Спасибо! Мы рассмотрим вашу жалобу.",
    "copy_success": "Скопировано!",
    "copy_text": "Discord-тег <strong>{tag}</strong> скопирован.",
    "reply": "ОТВЕТИТЬ",
    "reply_to": "Ответ для",
    "time": {
      "today": "Сегодня",
      "yesterday": "Вчера",
      "just_now": "только что",
      "ago": "назад",
      "y": "г.",
      "m": "мес.",
      "d": "д.",
      "h": "ч.",
      "min": "мин."
    },
    "reasons": {
      "spam": "Спам или реклама",
      "inappropriate": "Неприемлемый контент",
      "impersonation": "Выдача себя за другого",
      "harassment": "Оскорбления/преследование",
      "other": "Другое"
    }
  },
  "edit_profile": {
    "title": "РЕДАКТИРОВАНИЕ ПРОФИЛЯ",
    "avatar_label": "АВАТАР",
    "avatar_btn": "Выбрать и загрузить новый аватар",
    "avatar_help": "Аватар сохраняется сразу после загрузки.",
    "info_title": "// ИНФОРМАЦИЯ И ССЫЛКИ",
    "status_label": "СТАТУС",
    "status_placeholder": "Чем вы сейчас заняты?",
    "status_help": "Короткое сообщение, которое будет видно в вашем профиле и на карте.",
    "about_label": "ОБО МНЕ",
    "about_placeholder": "Расскажите о себе...",
    "social_tg_placeholder": "username (без @)",
    "social_ds_placeholder": "username",
    "social_vk_placeholder": "id или короткое имя",
    "social_x_placeholder": "username (без @)",
    "social_website_label": "САЙТ",
    "social_web_placeholder": "https://...",
    "save_btn": "Сохранить информацию и ссылки",
    "saving": "Сохранение...",
    "cancel_btn": "Отмена",
    "danger_title": "// ОПАСНАЯ ЗОНА",
    "danger_text": "Полное и безвозвратное удаление вашей учетной записи.",
    "delete_btn": "Удалить аккаунт",
    "modal_delete_title": "Подтверждение удаления",
    "modal_delete_text": "Вы уверены, что хотите НАВСЕГДА удалить свою учетную запись? Все ваши данные (профиль, метка) будут стерты, а комментарии и сообщения в чате - анонимизированы. Это действие НЕЛЬЗЯ отменить.",
    "modal_delete_success": "Учетная запись удалена",
    "modal_delete_success_text": "Ваши данные стерты из системы. Вы будете перенаправлены на главную страницу.",
    "modal_file_error": "Ошибка файла",
    "modal_size_error": "Файл слишком большой",
    "modal_type_error": "Неверный тип файла",
    "modal_avatar_uploading": "Загрузка...",
    "modal_avatar_uploading_text": "Отправляем ваш новый аватар...",
    "modal_avatar_success": "Успешно!",
    "modal_avatar_success_text": "Ваш новый аватар был сохранен.",
    "username_label": "НИКНЕЙМ",
    "username_placeholder": "Новый никнейм",
    "username_help": "Буквы, цифры и _ . От 4 до 20 символов. Раз в 30 дней.",
    "username_save_btn": "Изменить никнейм",
    "username_saving": "Сохранение...",
    "username_confirm_title": "Изменить никнейм?",
    "username_confirm_text": "Никнейм можно менять раз в 30 дней. Вы уверены, что хотите сменить его на \"{name}\"?",
    "username_success": "Никнейм изменён на \"{name}\"",
    "username_error_length": "От 4 до 20 символов",
    "username_error_chars": "Только латиница a–z, цифры и _",
    "username_error_reserved": "Этот никнейм недоступен",
    "avatar_editor": {
      "title": "РЕДАКТОР АВАТАРА",
      "preview": "ПРЕДПРОСМОТР",
      "zoom": "МАСШТАБ",
      "rotate": "ПОВОРОТ",
      "flip": "ОТРАЖЕНИЕ",
      "flip_horizontal": "Горизонтально",
      "flip_vertical": "Вертикально",
      "adjustments": "НАСТРОЙКИ",
      "brightness": "Яркость",
      "contrast": "Контраст",
      "saturation": "Насыщенность",
      "reset": "Сбросить",
      "cancel": "Отмена",
      "save": "Сохранить аватар",
      "hint": "Перетаскивайте для перемещения • Скролл для масштаба",
      "zoom_in": "Увеличить",
      "zoom_out": "Уменьшить",
      "rotate_left": "Повернуть влево",
      "rotate_right": "Повернуть вправо"
    }
  },
  "reset": {
    "page_title": "Новый пароль",
    "header": "СБРОС ДОСТУПА",
    "checking": "Проверка кодов доступа...",
    "instruction": "Укажите новый пароль для аккаунта:",
    "label": "НОВЫЙ ПАРОЛЬ",
    "btn_applying": "ПРИМЕНЕНИЕ...",
    "btn_save": "СОХРАНИТЬ ПАРОЛЬ",
    "error_link": "Ошибка валидации ссылки.",
    "error_modal_title": "Ошибка",
    "error_missing_code": "Неверная ссылка для сброса пароля.",
    "error_expired_title": "Ссылка устарела",
    "error_expired_desc": "Эта ссылка для сброса пароля уже недействительна или была использована.",
    "weak_password": "Пароль должен быть не менее 6 символов.",
    "success_title": "Успешно!",
    "success_desc": "Ваш пароль был изменен. Теперь вы можете войти.",
    "error_generic": "Не удалось сменить пароль."
  },
  "ai_policy": {
    "title": "Наша позиция по ИИ",
    "subtitle": "// Протокол Прозрачности: Запись об Ошибке",
    "intro_title": "//: Предыстория: Инцидент на Reddit",
    "intro_text": "15 декабря 2025 года наш пост, анонсирующий обновление \"Glitchmas\", был удален модераторами сабреддита r/protogen.",
    "reason_label": "Официальная причина:",
    "reason_text": "Нарушение правила №7 - \"Запрет AI-арта\".",
    "fact_label": "Факт:",
    "fact_text": "В посте не было ни одного изображения, сгенерированного ИИ. Были только скриншоты интерфейса сайта, который мы разработали.",
    "moderation_title": "//: Абсурдная Аргументация",
    "moderation_text": "Когда мы указали на это несоответствие, модератор заявил, что программирование — это «форма искусства». Но затем диалог перешел границы профессионализма:",
    "moderator_quote_1": "\"Программирование всего самостоятельно гораздо надежнее, чем любые помои (slop), которые может выплюнуть вам ИИ-чатбот\".",
    "moderator_quote_2": "\"Я настоятельно рекомендую вам пересмотреть свои методы и оттачивать собственные навыки\".",
    "moderation_outro": "Называть сложный, функционирующий проект с реальной экономикой и бэкендом \"помоями\" только из-за использования современных инструментов — это проявление личной предвзятости, а не модерация. Мы считаем такую риторику оскорбительной для всех инди-разработчиков.",
    "philosophy_title": "//: НАША ПОЗИЦИЯ: AI — ЭТО ИНСТРУМЕНТ",
    "point1_title": "🤖 Мы не скрываем, что используем AI",
    "point1_text": "ИИ — это наш \"второй пилот\" (copilot). Он помогает ускорить написание кода, генерировать тексты и быстро тестировать идеи. Для инди-команды это незаменимый инструмент.",
    "point2_title": "🎨 \"AI-Art\" ≠ \"AI-Assisted Code\"",
    "point2_text": "Запрещать разработчику использовать AI-помощника в коде под предлогом борьбы с \"AI-артом\" — это все равно что запрещать художнику использовать Photoshop, потому что это \"компьютерная помощь\". Это подмена понятий.",
    "point3_title": "👨‍💻 Наш код открыт",
    "point3_text": "Лучший аргумент против любых подозрений — полная прозрачность. Весь исходный код ProtoMap лежит на <strong><a href='https://github.com/OrionZ43/ProtoMap' target='_blank' class='link'>GitHub</a></strong>. Вы можете сами проверить, являются ли \"помоями\" наши облачные функции и архитектура.",
    "conclusion_title": "//: ЗАКЛЮЧЕНИЕ",
    "conclusion_text": "Мы не будем извиняться за использование эффективных инструментов. Мы продолжим развивать ProtoMap, руководствуясь здравым смыслом и уважением к нашим пользователям, а не личными предубеждениями модераторов.",
    "eoc": "//: КОНЕЦ СВЯЗИ."
  },
  "splash_modal": {
    "title": "ПРОТОКОЛ ПРОЗРАЧНОСТИ",
    "intro": "Кратко о недавнем инциденте с модерацией Reddit.",
    "point1": "Наш анонс на r/protogen был удален за \"использование ИИ\".",
    "point2": "Модераторы приравняли \"помощь ИИ в коде\" к \"генерации арта\", что является абсурдной трактовкой правил.",
    "point3": "Мы выступаем за честность и современные инструменты разработки. ProtoMap — это проект для комьюнити, с открытым исходным кодом.",
    "link_text": "Узнать полную историю",
    "close_btn": "Понятно"
  },
  "app_privacy_policy": {
    "page_title": "Политика конфиденциальности приложения",
    "last_updated": "Последнее обновление: 18 декабря 2025 г.",
    "intro": "Настоящая Политика конфиденциальности описывает, как приложение ProtoMap (далее «Приложение», «Сервис», «Мы»), разработанное Z43 Studios, собирает, использует и раскрывает вашу информацию при использовании нашего мобильного приложения.",
    "section_geo_title": "1. Геолокация и Данные о местоположении",
    "section_geo_text": "Наше Приложение является сервисом на основе интерактивной карты. Сбор данных о местоположении является фундаментальной функцией для обеспечения работоспособности Сервиса. Мы запрашиваем доступ к вашей геолокации («Точное местоположение» и «Приблизительное местоположение») для следующих целей:",
    "section_geo_list": [
      "Отображение вашего аватара на глобальной карте для других пользователей.",
      "Поиск других пользователей и событий поблизости.",
      "Обеспечение работы механики «Сигнальных Маяков»."
    ],
    "section_geo_processing": "Мы уважаем вашу приватность и предлагаем два режима обработки геоданных:",
    "section_geo_mode_auto": "Автоматический режим (GPS): Мы получаем ваши точные координаты, но перед сохранением на сервер они проходят процедуру анонимизации (огрубления) до центра ближайшего населенного пункта или района. Ваши точные GPS-координаты НЕ сохраняются в базе данных.",
    "section_geo_mode_manual": "Ручной режим: Вы можете самостоятельно выбрать точку на карте. В этом случае сохраняются координаты, указанные вами вручную.",
    "section_media_title": "2. Камера, Микрофон и Медиафайлы",
    "section_media_text": "Приложение запрашивает доступ к аппаратным функциям вашего устройства для обеспечения возможностей общения и кастомизации:",
    "section_media_camera": "Камера (Camera): Доступ необходим для создания фотографий в реальном времени, которые вы можете использовать в качестве аватара профиля или отправлять в чат. Данные камеры не собираются без вашего прямого действия.",
    "section_media_mic": "Микрофон (Microphone): Доступ необходим исключительно для записи и отправки голосовых сообщений во встроенном чате. Запись начинается только при удержании соответствующей кнопки интерфейса.",
    "section_media_storage": "Хранилище/Галерея (Read/Write Storage): Доступ необходим для загрузки и сохранения изображений (аватаров, скриншотов карты) на ваше устройство.",
    "section_safety_title": "3. Безопасность детей и Модерация контента (UGC)",
    "section_safety_text": "ProtoMap — это социальная платформа с пользовательским контентом (UGC). Мы стремимся обеспечить безопасную среду для всех пользователей.",
    "section_safety_age": "Возрастное ограничение: Сервис не предназначен для использования лицами моложе 16 лет (или иного возраста цифрового согласия в вашей юрисдикции). Мы сознательно не собираем персональные данные детей.",
    "section_safety_csam": "Политика в отношении насилия над детьми (CSAM): Мы придерживаемся политики НУЛЕВОЙ ТЕРПИМОСТИ (Zero Tolerance) к любым материалам, изображающим сексуальное насилие над детьми, эксплуатацию детей или причинение им вреда.",
    "section_safety_measures": "Меры реагирования: В случае обнаружения подобного контента мы немедленно:",
    "section_safety_actions": [
      "Удаляем контент без возможности восстановления.",
      "Перманентно блокируем учетную запись нарушителя.",
      "В соответствии с законодательством (в т.ч. DSA в ЕС и законами США), мы передаем все данные пользователя (IP, Device ID, Email, логи) в NCMEC (National Center for Missing & Exploited Children) и соответствующие правоохранительные органы."
    ],
    "section_data_title": "4. Сбор и Хранение данных",
    "section_data_text": "Мы собираем следующие типы данных:",
    "section_data_list": [
      "Идентификационные данные: Email, UID, Имя пользователя.",
      "Данные устройства: Модель устройства, версия ОС (для аналитики сбоев и безопасности через Google Firebase Crashlytics).",
      "Игровые данные: Баланс виртуальной валюты, инвентарь, история действий."
    ],
    "section_third_party": "Мы используем проверенные сторонние сервисы для обработки данных: Google Firebase (хранение данных, аутентификация), OpenStreetMap/Nominatim (геокодирование). Мы не продаем ваши данные третьим лицам.",
    "section_delete_title": "5. Удаление данных",
    "section_delete_text": "Вы имеете полный контроль над своими данными. Вы можете запросить полное удаление аккаунта и всех связанных данных (включая сообщения, метки и историю) через настройки приложения (кнопка «Удалить аккаунт» в разделе редактирования профиля) или написав запрос на нашу электронную почту.",
    "section_contact_title": "6. Контакты",
    "section_contact_text": "Если у вас есть вопросы по поводу нашей Политики конфиденциальности, пожалуйста, свяжитесь с нами:",
    "contact_email": "orion.z43studios@gmail.com"
  },
  "app_terms": {
    "page_title": "Пользовательское соглашение (EULA)",
    "last_updated": "Последнее обновление: 18 декабря 2025 г.",
    "intro": "Настоящее Лицензионное соглашение с конечным пользователем («Соглашение», «EULA») является юридическим договором между вами («Пользователь») и Z43 Studios («Разработчик») относительно использования мобильного приложения ProtoMap («Приложение»). Устанавливая или используя Приложение, вы соглашаетесь соблюдать условия настоящего Соглашения.",
    "sec_license_title": "1. Лицензия и Доступ",
    "sec_license_text": "Z43 Studios предоставляет вам ограниченную, неисключительную, непередаваемую, отзывную лицензию на использование Приложения в личных некоммерческих целях. Вы не имеете права:",
    "sec_license_list": [
      "Декомпилировать, реверс-инжинирить или пытаться извлечь исходный код Приложения (за исключением частей, опубликованных нами как Open Source).",
      "Использовать Приложение для создания конкурирующего продукта.",
      "Использовать автоматизированные скрипты (боты, кликеры) для сбора данных или получения преимуществ в мини-играх."
    ],
    "sec_content_title": "2. Пользовательский контент (UGC) и Модерация",
    "sec_content_text": "Приложение позволяет пользователям создавать контент (текстовые сообщения, загрузка изображений, статусы). Вы несете полную ответственность за контент, который вы публикуете.",
    "sec_content_policy": "Мы придерживаемся политики НУЛЕВОЙ ТЕРПИМОСТИ (Zero Tolerance) к неприемлемому контенту. Строго запрещено публиковать:",
    "sec_content_prohibited": [
      "Материалы, изображающие сексуальное насилие, особенно в отношении несовершеннолетних (CSAM).",
      "Порнографические материалы и материалы сексуального характера (NSFW) в публичных зонах (общий чат, аватар, видимый на карте).",
      "Угрозы, призывы к насилию, разжигание ненависти (Hate Speech) на почве расы, национальности, религии или ориентации.",
      "Личные данные других пользователей (Doxxing)."
    ],
    "sec_content_moderation": "Разработчик оставляет за собой право модерировать контент. Мы предоставляем пользователям инструменты для жалоб («Report») на неприемлемый контент. Контент, нарушающий правила, будет удален, а аккаунт нарушителя — заблокирован в течение 24 часов после проверки жалобы.",
    "sec_virtual_title": "3. Виртуальная валюта и Товары",
    "sec_virtual_text": "Приложение включает в себя виртуальную валюту («ProtoCoins») и цифровые товары (рамки, фоны).",
    "sec_virtual_list": [
      "ProtoCoins не являются реальными деньгами, криптовалютой или финансовым инструментом.",
      "Виртуальные товары не имеют денежной стоимости в реальном мире и не подлежат возврату или обмену на фиатные деньги.",
      "Механики «Казино» (The Glitch Pit) являются симуляцией и предназначены исключительно для развлекательных целей. Выигрыш реальных денег невозможен.",
      "Разработчик имеет право регулировать, изменять или удалять виртуальную валюту и товары по своему усмотрению."
    ],
    "sec_safety_title": "4. Безопасность и Реальный мир",
    "sec_safety_text": "Используя функции карты, вы соглашаетесь соблюдать осторожность:",
    "sec_safety_list": [
      "Не используйте Приложение во время вождения автомобиля или выполнения действий, требующих повышенного внимания.",
      "Вы несете ответственность за встречи с другими пользователями в реальном мире. Разработчик не контролирует действия пользователей офлайн и не несет ответственности за любой ущерб, возникший в результате таких встреч.",
      "Мы рекомендуем использовать функцию автоматической анонимизации местоположения для защиты вашей приватности."
    ],
    "sec_termination_title": "5. Прекращение доступа",
    "sec_termination_text": "Мы оставляем за собой право немедленно заблокировать или удалить ваш аккаунт без предварительного уведомления, если вы нарушаете условия настоящего Соглашения, особенно в части безопасности пользователей и правил контента.",
    "sec_disclaimer_title": "6. Отказ от гарантий (As Is)",
    "sec_disclaimer_text": "Приложение предоставляется «как есть». Z43 Studios не гарантирует, что Приложение будет работать бесперебойно, без ошибок или будет совместимо с вашим устройством. Мы не несем ответственности за потерю виртуальных данных в результате сбоев сервера.",
    "sec_contact_title": "7. Контакты",
    "sec_contact_text": "Для связи с администрацией по вопросам условий использования:",
    "contact_email": "orion.z43studios@gmail.com"
  }
}
</file>

<file path="src/routes/+layout.svelte">
<script lang="ts">
    import "../app.css";
    import "/src/styles/cosmetics.css";
    import "/src/styles/profile-skins.css";

    import Navbar from "$lib/components/Navbar.svelte";
    import Modal from '$lib/components/Modal.svelte';
    import ChatWidget from '$lib/components/ChatWidget.svelte';
    import { chat } from '$lib/stores';
    import 'leaflet/dist/leaflet.css';
    import 'leaflet.markercluster/dist/MarkerCluster.css';
    import 'leaflet.markercluster/dist/MarkerCluster.Default.css';
    import { page } from '$app/stores';
    import { onMount } from 'svelte';
    import { AudioManager } from '$lib/client/audioManager';
    import Footer from "$lib/components/Footer.svelte";
    import CookieBanner from '$lib/components/CookieBanner.svelte';
    import { browser, dev } from '$app/environment';
    import { injectAnalytics } from '@vercel/analytics/sveltekit';
    import SplashModal from '$lib/components/SplashModal.svelte';
    import { settingsStore } from '$lib/stores/settingsStore';
    import Snowfall from '$lib/components/Snowfall.svelte';
    import { goto, beforeNavigate } from '$app/navigation';

    import '$lib/i18n';
    import { waitLocale } from 'svelte-i18n';

    let themeState = 'default';
    let sideTextLeft = 'СТАТУС СИСТЕМЫ: ОНЛАЙН';
    let sideTextRight = 'МОЩНОСТЬ СЕТИ: 99%';
    let isReady = false;
    let seasonActiveInSession = false;

    $: user = $page.data.user;
    $: isBanned = user?.isBanned === true;
    $: isBannedPage = $page.url.pathname.startsWith('/banned');

    $: if (isBanned && !isBannedPage && browser) {
        goto('/banned');
    }

    beforeNavigate(({ to, cancel }) => {
        if (isBanned && to?.url.pathname !== '/banned') {
            cancel();
            if (!isBannedPage) {
                goto('/banned');
            }
        }
    });

    function initSeasonalTheme() {
        const d = new Date();
        const m = d.getMonth();
        const day = d.getDate();

        if ((m === 9 && day >= 20) || (m === 10 && day <= 2)) {
            themeState = 'halloween';
            sideTextLeft = 'СИСТЕМА: НЕСТАБИЛЬНА';
            sideTextRight = 'АНАЛИЗ АНОМАЛИИ...';
            import('/src/styles/halloween.css');
        }
        else if (m === 11 && day >= 1 && day < 15) {
            themeState = 'winter';
            sideTextLeft = 'ТЕМПЕРАТУРА: -15°C';
            sideTextRight = 'СИСТЕМА ОХЛАЖДЕНИЯ: АКТИВНА';
            import('/src/styles/winter.css');
        }
        else if ((m === 11 && day >= 15) || (m === 0 && day <= 14)) {
            themeState = 'newyear';
            sideTextLeft = 'РЕЖИМ: GLITCHMAS';
            sideTextRight = 'КРИОГЕННЫЕ ПРОТОКОЛЫ: МАКСИМУМ';
            import('/src/styles/winter.css');
            import('/src/styles/newyear.css');
        }
    }

    onMount(async () => {
        injectAnalytics({ mode: dev ? 'development' : 'production' });
        AudioManager.initialize();
        await waitLocale();

        const savedSeasonal = localStorage.getItem('protomap_seasonal_enabled');
        const isSeasonalEnabled = savedSeasonal !== 'false';

        if (isSeasonalEnabled) {
            seasonActiveInSession = true;
            initSeasonalTheme();
        }

        isReady = true;
    });

    $: isMapPage = $page.route.id === '/';

    // Проверяем, есть ли у текущей страницы seoData (для профилей)
    $: seoData = $page.data.seoData;
    $: hasCustomSeo = !!seoData;

    function toggleChat() {
        if ($chat.isOpen) {
            AudioManager.play('popup_close');
        } else {
            AudioManager.play('popup_open');
        }
        chat.toggle();
    }
</script>

<svelte:head>
    <!-- Общие теги -->
    <meta property="og:site_name" content="ProtoMap" />
    <meta property="og:locale" content="ru_RU" />
    <meta name="theme-color" content="#00f0ff" />

    <!-- ВАЖНО: Теперь используем данные из seoData если есть, иначе дефолтные -->
    <title>{hasCustomSeo ? seoData.title : 'ProtoMap - Карта протогенов'}</title>
    <meta name="description" content={hasCustomSeo ? seoData.description : 'Интерактивная карта протогенов с казино, чатом и профилями'} />

    <!-- Open Graph -->
    <meta property="og:type" content={hasCustomSeo ? 'profile' : 'website'} />
    <meta property="og:title" content={hasCustomSeo ? seoData.title : 'ProtoMap - Карта протогенов'} />
    <meta property="og:description" content={hasCustomSeo ? seoData.description : 'Интерактивная карта протогенов с казино, чатом и профилями'} />
    <meta property="og:image" content={hasCustomSeo ? seoData.image : 'https://proto-map.vercel.app/preview.png'} />
    <meta property="og:url" content={hasCustomSeo ? seoData.url : 'https://proto-map.vercel.app'} />

    {#if hasCustomSeo}
        <meta property="og:image:secure_url" content={seoData.image} />
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="1200" />
    {/if}

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={hasCustomSeo ? seoData.title : 'ProtoMap - Карта протогенов'} />
    <meta name="twitter:description" content={hasCustomSeo ? seoData.description : 'Интерактивная карта протогенов с казино, чатом и профилями'} />
    <meta name="twitter:image" content={hasCustomSeo ? seoData.image : 'https://proto-map.vercel.app/preview.png'} />
</svelte:head>

<svelte:body class:seasonal-on={seasonActiveInSession} />

{#if isReady}
    <div
        class="min-h-screen flex flex-col font-sans antialiased relative"
        class:no-scroll-container={isMapPage}
    >
        {#if seasonActiveInSession && (themeState === 'winter' || themeState === 'newyear')}
            <Snowfall />
        {/if}

        {#if !isBanned}
            <div class="side-panel left z-10">
                <div class="v-text">{sideTextLeft}</div>
            </div>
            <div class="side-panel right z-10">
                <div class="v-text">{sideTextRight}</div>
            </div>
        {/if}

        <div class="relative z-20 flex flex-col flex-grow">
            {#if !isBanned}
                <Navbar />
            {/if}

            <main class="flex-grow">
                <slot />
            </main>
        </div>

        <div class="hidden lg:block">
            {#if !isMapPage && !isBanned}
                <Footer />
            {/if}
        </div>

        <Modal />

        {#if !isBanned}
            <ChatWidget />
            <CookieBanner />
            <SplashModal />

            <button
                class="chat-trigger-btn"
                class:hidden={$chat.isOpen}
                on:click={toggleChat}
                title="Открыть общий чат"
                aria-label="Открыть общий чат"
            >
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8">
                    <path fill-rule="evenodd" d="M4.848 2.771A49.144 49.144 0 0112 2.25c2.43 0 4.817.178 7.152.52 1.978.292 3.348 2.024 3.348 3.97v6.02c0 1.946-1.37 3.678-3.348 3.97a48.901 48.901 0 01-3.476.383.39.39 0 00-.297.17l-2.755 4.133a.75.75 0 01-1.248 0l-2.755-4.133a.39.39 0 00-.297-.17 48.9 48.9 0 01-3.476-.384c-1.978-.29-3.348-2.024-3.348-3.97V6.74c0-1.946 1.37-3.68 3.348-3.97zM6.75 8.25a.75.75 0 01.75-.75h9a.75.75 0 010 1.5h-9a.75.75 0 01-.75-.75zm.75 2.25a.75.75 0 000 1.5H12a.75.75 0 000-1.5H7.5z" clip-rule="evenodd" />
                </svg>
                {#if $chat.hasUnread}
                    <div class="unread-dot"></div>
                {/if}
            </button>
        {/if}
    </div>
{:else}
    <div class="fixed inset-0 bg-black z-[9999]"></div>
{/if}

<style>
    .chat-trigger-btn {
        @apply fixed bottom-5 right-1 z-50;
        @apply w-16 h-16 rounded-full bg-cyber-yellow text-black;
        @apply flex items-center justify-center;
        @apply shadow-lg shadow-cyber-yellow/50;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        transform: scale(1);
    }
    .chat-trigger-btn:hover {
        @apply bg-white scale-110;
        box-shadow: 0 0 25px var(--cyber-yellow, #fcee0a);
    }

    .chat-trigger-btn.hidden {
        transform: scale(0);
        opacity: 0;
    }
    .side-panel {
        @apply fixed top-0 bottom-0 z-20 flex items-center justify-center;
        width: 75px;
    }
    @media (max-width: 1023px) {
        .side-panel {
            display: none;
        }
    }
    .unread-dot {
        position: absolute; top: 0; right: 0;
        width: 14px; height: 14px;
        background: #ff003c; border-radius: 50%;
        border: 2px solid #000;
        box-shadow: 0 0 10px #ff003c;
        animation: pulse-dot 1s infinite;
    }
    @keyframes pulse-dot { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
</style>
</file>

<file path="src/routes/profile/[username]/+page.svelte">
<script lang="ts">
    import { userStore } from '$lib/stores';
    import type { ActionData, PageData } from './$types';
    import NeonButton from '$lib/components/NeonButton.svelte';
    import { onMount } from 'svelte';
    import { quintOut } from 'svelte/easing';
    import { tweened } from 'svelte/motion';
    import { modal } from '$lib/stores/modalStore';
    import { fade, slide } from 'svelte/transition';
    import { getFunctions, httpsCallable } from "firebase/functions";
    import { settingsStore } from '$lib/stores/settingsStore';
    import CinematicLoader from '$lib/components/CinematicLoader.svelte';
    import { browser } from '$app/environment';
    import { sendEmailVerification } from "firebase/auth";
    import { auth } from "$lib/firebase";
    import { invalidateAll } from '$app/navigation';
    import { t } from 'svelte-i18n';
    import { get } from 'svelte/store';
    import { renderMarkdown } from '$lib/utils/markdown';
    import { AudioManager } from '$lib/client/audioManager';
    import { page } from '$app/stores';
    import WatermelonInteractive from '$lib/components/WatermelonInteractive.svelte';

    export let data: PageData;
    export let form: ActionData;

    let showCinematicIntro = true;
    let isProfileVisible = false;
    let isSubmitting = false;
    let verificationSent = false;

    const containerOpacity = tweened(0, { duration: 500, easing: quintOut });

    const translate = (key: string, vars = {}) => get(t)(key, vars);

    function getOptimizedAvatar(url: string | null | undefined, size: number = 100): string {
        if (!url) return '';

        if (url.includes('cloudinary.com')) {
            const parts = url.split('/upload/');
            return `${parts[0]}/upload/f_auto,q_auto,w_${size * 2},h_${size * 2},c_fill/${parts[1]}`;
        }

        // ФИКС ДЛЯ GOOGLE AVATARS
        if (url.includes('googleusercontent.com')) {
            // Заменяем параметр размера на наш (например, s200)
            return url.split('=')[0] + `=s${size * 2}-c`;
        }

        return url;
    }

    function getReportReasons() {
        return [
            { id: 'spam', label: translate('profile.reasons.spam'), text: 'Spam' },
            { id: 'inappropriate', label: translate('profile.reasons.inappropriate'), text: 'Inappropriate' },
            { id: 'impersonation', label: translate('profile.reasons.impersonation'), text: 'Impersonation' },
            { id: 'harassment', label: translate('profile.reasons.harassment'), text: 'Harassment' },
            { id: 'other', label: translate('profile.reasons.other'), text: 'Other' }
        ];
    }

    onMount(async () => {
        if (browser) {
            // --- ЛОГИКА СИНЕМАТИК-ЛОАДЕРА ---
            const cinematicEnabled = $settingsStore.cinematicLoadsEnabled;
            const sessionKey = `viewed_profile_${data.profile.username}`;
            const alreadyViewed = sessionStorage.getItem(sessionKey);

            if (cinematicEnabled && !alreadyViewed) {
                showCinematicIntro = true;
                sessionStorage.setItem(sessionKey, 'true');
            } else {
                showCinematicIntro = false;
                isProfileVisible = true;
                containerOpacity.set(1);
            }

            // --- ЛОГИКА МИГРАЦИИ АВАТАРКИ (UPLINK) ---
            // Проверяем: мой ли это профиль и не Google ли там в ссылке?
            // Используем $userStore напрямую для надежности
            const currentUser = $userStore.user;
            if (currentUser && currentUser.uid === data.profile.uid) {
                const avatarUrl = data.profile.avatar_url;

                if (avatarUrl && avatarUrl.includes('googleusercontent.com')) {
                    console.log("[System] External proxy avatar detected. Initializing migration protocol...");

                    try {
                        // Подгружаем функции только если они нужны
                        const { getFunctions, httpsCallable } = await import('firebase/functions');
                        const functions = getFunctions();
                        const migrateFunc = httpsCallable(functions, 'migrateExternalAvatar');

                        // Запускаем в фоне, не ждем ответа для отрисовки профиля
                        migrateFunc({ url: avatarUrl }).then((res: any) => {
                            if (res.data.status === 'success') {
                                console.log("[System] Avatar successfully migrated to Cloudinary storage.");
                                // Обновляем локальный стор, чтобы аватарка поменялась сразу
                                userStore.update(s => {
                                    if (s.user) s.user.avatar_url = res.data.newUrl;
                                    return s;
                                });
                            }
                        });
                    } catch (e) {
                        console.error("[System] Migration circuit failure:", e);
                    }
                }
            }
        }
    });

    function handleIntroFinished() {
        showCinematicIntro = false;
        setTimeout(() => {
            isProfileVisible = true;
            containerOpacity.set(1);
        }, 500);
    }

    $: isOwner = $userStore.user && $userStore.user.uid === data.profile.uid;
    $: socials = data.profile.socials || {};
    $: hasSocials = Object.values(socials).some(link => !!link);

    // Добавляем состояние для ответов
    let replyingToId: string | null = null;
    let replyingToName: string = '';

    // Функция начала ответа
    function startReply(commentId: string, username: string) {
        replyingToId = commentId;
        replyingToName = username;
        // Скролл к форме ввода или фокус на инпуте (если форма плавающая)
        // В нашем случае форма одна, сделаем её "умной"
        const input = document.querySelector('textarea[name="commentText"]') as HTMLElement;
        if (input) {
            input.focus();
            input.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    function cancelReply() {
        replyingToId = null;
        replyingToName = '';
    }

    // Обновляем отправку
    async function handleAddComment() {
        if (!commentText.trim() || isSubmitting) return;

        isSubmitting = true;
        try {
            const functions = getFunctions();
            const addCommentFunc = httpsCallable(functions, 'addComment');

            await addCommentFunc({
                profileUid: data.profile.uid,
                text: commentText,
                parentId: replyingToId // Отправляем ID родителя, если есть
            });

            commentText = '';
            cancelReply(); // Сброс режима ответа
            await invalidateAll();

        } catch (error: any) {
            modal.error(translate('ui.error'), error.message);
        } finally {
            isSubmitting = false;
        }
    }

    // Функция Лайка (Оптимистичная)
    async function handleLike(commentId: string) {
        if (!$userStore.user) return modal.warning(translate('ui.error'), translate('profile.login_req'));

        const uid = $userStore.user.uid;

        // 1. АНИМАЦИЯ И ЗВУК СРАЗУ
        AudioManager.play('click_alt');

        // 2. ОПТИМИСТИЧНОЕ ОБНОВЛЕНИЕ ЛОКАЛЬНЫХ ДАННЫХ
        // Нам нужно найти коммент (он может быть родительским или ответом) и обновить его
        data.comments = data.comments.map(c => {
            // Если это родитель
            if (c.id === commentId) {
                const hasLiked = c.likes.includes(uid);
                return {
                    ...c,
                    likes: hasLiked ? c.likes.filter(id => id !== uid) : [...c.likes, uid]
                };
            }

            // Если это ответ внутри родителя
            if (c.replies) {
                const updatedReplies = c.replies.map(r => {
                    if (r.id === commentId) {
                        const hasLiked = r.likes.includes(uid);
                        return {
                            ...r,
                            likes: hasLiked ? r.likes.filter(id => id !== uid) : [...r.likes, uid]
                        };
                    }
                    return r;
                });
                return { ...c, replies: updatedReplies };
            }

            return c;
        });

        // 3. ОТПРАВКА НА СЕРВЕР (В ФОНЕ)
        try {
            const functions = getFunctions();
            const likeFunc = httpsCallable(functions, 'toggleCommentLike');
            // Мы не ждем await invalidateAll(), интерфейс уже обновлен
            await likeFunc({ profileUid: data.profile.uid, commentId });
        } catch(e) {
            console.error("Like sync error:", e);
            // В идеале тут надо откатить лайк назад, но для пет-проекта можно забить,
            // при следующей перезагрузке данные синхронизируются.
        }
    }

    async function handleDeleteComment(commentId: string) {
        modal.confirm(
            translate('ui.delete'),
            translate('ui.confirm_delete'),
            async () => {
                try {
                    const functions = getFunctions();
                    const deleteCommentFunc = httpsCallable(functions, 'deleteComment');

                    await deleteCommentFunc({
                        profileUid: data.profile.uid,
                        commentId: commentId
                    });

                    modal.success(translate('ui.success'), "Deleted.");

                } catch (error: any) {
                    modal.error(translate('ui.error'), error.message);
                }
            }
        );
    }

    async function handleReportProfile() {
        if (!$userStore.user) {
            modal.warning(translate('ui.error'), translate('profile.login_req'));
            return;
        }
        const reasons = getReportReasons();

        const messageText = `${translate('profile.report_profile_text')} <strong>${data.profile.username}</strong>.`;

        modal.report(
            translate('profile.report_profile_title'),
            messageText,
            reasons,
            async (selectedReasonId) => {
                const reasonObject = reasons.find(r => r.id === selectedReasonId);
                if (!reasonObject) return;
                try {
                    const functions = getFunctions();
                    const reportContentFunc = httpsCallable(functions, 'reportContent');
                    modal.info(translate('ui.loading'), translate('profile.sending'));
                    await reportContentFunc({ type: 'profile', reportedContentId: data.profile.uid, profileOwnerUid: data.profile.uid, reason: reasonObject.text, reportedUsername: data.profile.username, reporterUsername: $userStore.user?.username || 'unknown'});
                    modal.success(translate('profile.report_success'), translate('profile.report_success_text'));
                } catch (error: any) { modal.error(translate('ui.error'), error.message); }
            }
        );
    }

    async function handleReportComment(commentId: string, commentAuthorUsername: string) {
        if (!$userStore.user) {
            modal.warning(translate('ui.error'), translate('profile.login_req'));
            return;
        }
        const reasons = getReportReasons();
        const messageText = `${translate('profile.report_comment_text')} <strong>${commentAuthorUsername}</strong>.`;

        modal.report(
            translate('profile.report_comment_title'),
            messageText,
            reasons,
            async (selectedReasonId) => {
                const reasonObject = reasons.find(r => r.id === selectedReasonId);
                if (!reasonObject) return;
                try {
                    const functions = getFunctions();
                    const reportContentFunc = httpsCallable(functions, 'reportContent');
                    modal.info(translate('ui.loading'), translate('profile.sending'));
                    await reportContentFunc({ type: 'comment', reportedContentId: commentId, profileOwnerUid: data.profile.uid, reason: reasonObject.text, profileOwnerUsername: data.profile.username, reportedUsername: commentAuthorUsername, reporterUsername: $userStore.user?.username || 'unknown' });
                    modal.success(translate('profile.report_success'), translate('profile.report_success_text'));
                } catch (error: any) { modal.error(translate('ui.error'), error.message); }
            }
        );
    }

    function copyDiscordTag() {
        const tag = socials.discord;
        if (tag) {
            navigator.clipboard.writeText(tag).then(() => {
                modal.success(translate('profile.copy_success'), translate('profile.copy_text', { tag }));
            }, () => {
                modal.error(translate('ui.error'), "Copy failed.");
            });
        }
    }

    let commentText = '';
    $: if (form?.addCommentSuccess) {
        commentText = '';
    }

    function formatTimeAgo(date: Date): string {
        if (!date || !(date instanceof Date)) return '';
        const seconds = Math.floor((new Date().getTime() - date.getTime()) / 1000);

        if (seconds < 60) return translate('profile.time.just_now');

        const intervals: {[key: string]: number} = {
            'y': 31536000,
            'm': 2592000,
            'd': 86400,
            'h': 3600,
            'min': 60
        };

        for (const [unit, secondsInUnit] of Object.entries(intervals)) {
            const interval = seconds / secondsInUnit;
            if (interval > 1) {
                const unitText = translate(`profile.time.${unit}`);
                return `${Math.floor(interval)} ${unitText} ${translate('profile.time.ago')}`;
            }
        }
        return translate('profile.time.just_now');
    }
    $: isWatermelonMode = data.profile.uid === 'zIgs2z54ThV9ee102lVlZKg6lTh2';
</script>

<svelte:head>
    <!-- Basic Meta Tags -->
    <title>{data.seoData.title}</title>
    <meta name="description" content={data.seoData.description} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="profile" />
    <meta property="og:url" content={data.seoData.url} />
    <meta property="og:title" content={data.seoData.title} />
    <meta property="og:description" content={data.seoData.description} />
    <meta property="og:image" content={data.seoData.image} />
    <meta property="og:image:secure_url" content={data.seoData.image} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="1200" />
    <meta property="og:image:alt" content={`Аватар ${data.profile.username}`} />
    <meta property="og:image:type" content="image/jpeg" />
    <meta property="og:site_name" content="ProtoMap" />
    <meta property="og:locale" content="ru_RU" />

    <!-- Profile specific -->
    <meta property="profile:username" content={data.profile.username} />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={data.seoData.url} />
    <meta name="twitter:title" content={data.seoData.title} />
    <meta name="twitter:description" content={data.seoData.description} />
    <meta name="twitter:image" content={data.seoData.image} />
    <meta name="twitter:image:alt" content={`Аватар ${data.profile.username}`} />

    <!-- Canonical URL -->
    <link rel="canonical" href={data.seoData.url} />
</svelte:head>

{#if showCinematicIntro}
    <CinematicLoader
        username={data.profile.username}
        on:finished={handleIntroFinished}
    />
{/if}

{#if isWatermelonMode}
    <WatermelonInteractive />
{/if}

{#if isProfileVisible}
    <div class="hidden neon-blue-frame glitch-frame high-roller-frame frame_biohazard frame_plasma frame_stealth frame_dev frame_beta"></div>

    <div class="container mx-auto px-4" transition:fade={{ duration: 300 }}>
        {#if data.profile.equipped_bg}
        <div class="profile-backdrop {data.profile.equipped_bg}"></div>
    {/if}

    <div class="profile-container cyber-panel pb-12 {data.profile.equipped_bg ? 'themed ' + data.profile.equipped_bg + '-theme' : ''}" style="opacity: {$containerOpacity}">

            {#if $userStore.user && !isOwner}
                <button on:click={handleReportProfile} class="report-icon-btn" title={$t('profile.report_btn')}>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
                </button>
            {/if}

            <div class="corner-bg top-left"></div>
            <div class="corner-bg top-right"></div>
            <div class="corner-bg bottom-left"></div>
            <div class="corner-bg bottom-right"></div>

            <div class="top-bar">
                <span class="pl-6">{$t('profile.user_id')}: {data.profile.uid.substring(0, 18).toUpperCase()}...</span>
            </div>

            <div class="profile-header">
                <div class="avatar-wrapper {data.profile.equipped_frame || ''}">
                    <img
                        src={data.profile.avatar_url || `https://api.dicebear.com/7.x/bottts-neutral/svg?seed=${data.profile.username}`}
                        alt="Avatar"
                        class="profile-avatar"
                    />
                </div>
                <h2 class="profile-username font-display">{data.profile.username}</h2>
            </div>

            <div class="profile-content">

                {#if hasSocials}
                    <div class="profile-section">
                        <h4 class="font-display">// {$t('profile.channels')}</h4>
                        <div class="text-center">
                            <div class="social-links-grid">
                                {#if socials.telegram}
                            <a href={`https://t.me/${socials.telegram}`} target="_blank" rel="noopener noreferrer" class="social-link-btn" title="Telegram">
                                <svg viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" preserveAspectRatio="xMidYMid"> <g fill-rule="evenodd"> <path d="M128,0 C57.307,0 0,57.307 0,128 C0,198.693 57.307,256 128,256 C198.693,256 256,198.693 256,128 C256,57.307 198.693,0 128,0 Z" fill="#40B3E0"></path> <path d="M190.2826,73.6308 L167.4206,188.8978 C167.4206,188.8978 164.2236,196.8918 155.4306,193.0548 L102.6726,152.6068 L83.4886,143.3348 L51.1946,132.4628 C51.1946,132.4628 46.2386,130.7048 45.7586,126.8678 C45.2796,123.0308 51.3546,120.9528 51.3546,120.9528 L179.7306,70.5928 C179.7306,70.5928 190.2826,65.9568 190.2826,73.6308" fill="#FFFFFF"></path> <path d="M98.6178,187.6035 C98.6178,187.6035 97.0778,187.4595 95.1588,181.3835 C93.2408,175.3085 83.4888,143.3345 83.4888,143.3345 L161.0258,94.0945 C161.0258,94.0945 165.5028,91.3765 165.3428,94.0945 C165.3428,94.0945 166.1418,94.5735 163.7438,96.8115 C161.3458,99.0505 102.8328,151.6475 102.8328,151.6475" fill="#D2E5F1"></path> <path d="M122.9015,168.1154 L102.0335,187.1414 C102.0335,187.1414 100.4025,188.3794 98.6175,187.6034 L102.6135,152.2624" fill="#B5CFE4"></path> </g> </svg>
                            </a>
                        {/if}
                        {#if socials.discord}
                            <button type="button" on:click={copyDiscordTag} class="social-link-btn" title={$t('profile.copy_text', {tag: ''})}>
                                <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"> <circle cx="512" cy="512" r="512" style="fill:#5865f2"/> <path d="M689.43 349a422.21 422.21 0 0 0-104.22-32.32 1.58 1.58 0 0 0-1.68.79 294.11 294.11 0 0 0-13 26.66 389.78 389.78 0 0 0-117.05 0 269.75 269.75 0 0 0-13.18-26.66 1.64 1.64 0 0 0-1.68-.79A421 421 0 0 0 334.44 349a1.49 1.49 0 0 0-.69.59c-66.37 99.17-84.55 195.9-75.63 291.41a1.76 1.76 0 0 0 .67 1.2 424.58 424.58 0 0 0 127.85 64.63 1.66 1.66 0 0 0 1.8-.59 303.45 303.45 0 0 0 26.15-42.54 1.62 1.62 0 0 0-.89-2.25 279.6 279.6 0 0 1-39.94-19 1.64 1.64 0 0 1-.16-2.72c2.68-2 5.37-4.1 7.93-6.22a1.58 1.58 0 0 1 1.65-.22c83.79 38.26 174.51 38.26 257.31 0a1.58 1.58 0 0 1 1.68.2c2.56 2.11 5.25 4.23 8 6.24a1.64 1.64 0 0 1-.14 2.72 262.37 262.37 0 0 1-40 19 1.63 1.63 0 0 0-.87 2.28 340.72 340.72 0 0 0 26.13 42.52 1.62 1.62 0 0 0 1.8.61 423.17 423.17 0 0 0 128-64.63 1.64 1.64 0 0 0 .67-1.18c10.68-110.44-17.88-206.38-75.7-291.42a1.3 1.3 0 0 0-.63-.63zM427.09 582.85c-25.23 0-46-23.16-46-51.6s20.38-51.6 46-51.6c25.83 0 46.42 23.36 46 51.6.02 28.44-20.37 51.6-46 51.6zm170.13 0c-25.23 0-46-23.16-46-51.6s20.38-51.6 46-51.6c25.83 0 46.42 23.36 46 51.6.01 28.44-20.17 51.6-46 51.6z" style="fill:#fff"/></svg>
                            </button>
                        {/if}
                        {#if socials.vk}
                            <a href={`https://vk.com/${socials.vk}`} target="_blank" rel="noopener noreferrer" class="social-link-btn" title="VK">
                                <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"> <circle cx="512" cy="512" r="512" style="fill:#2787f5"/> <path d="M585.83 271.5H438.17c-134.76 0-166.67 31.91-166.67 166.67v147.66c0 134.76 31.91 166.67 166.67 166.67h147.66c134.76 0 166.67-31.91 166.67-166.67V438.17c0-134.76-32.25-166.67-166.67-166.67zm74 343.18h-35c-13.24 0-17.31-10.52-41.07-34.62-20.71-20-29.87-22.74-35-22.74-7.13 0-9.17 2-9.17 11.88v31.57c0 8.49-2.72 13.58-25.12 13.58-37 0-78.07-22.4-106.93-64.16-43.45-61.1-55.33-106.93-55.33-116.43 0-5.09 2-9.84 11.88-9.84h35c8.83 0 12.22 4.07 15.61 13.58 17.31 49.9 46.17 93.69 58 93.69 4.41 0 6.45-2 6.45-13.24v-51.6c-1.36-23.76-13.92-25.8-13.92-34.28 0-4.07 3.39-8.15 8.83-8.15h55c7.47 0 10.18 4.07 10.18 12.9v69.58c0 7.47 3.39 10.18 5.43 10.18 4.41 0 8.15-2.72 16.29-10.86 25.12-28.17 43.11-71.62 43.11-71.62 2.38-5.09 6.45-9.84 15.28-9.84h35c10.52 0 12.9 5.43 10.52 12.9-4.41 20.37-47.18 80.79-47.18 80.79-3.73 6.11-5.09 8.83 0 15.61 3.73 5.09 16 15.61 24.1 25.12 14.94 17 26.48 31.23 29.53 41.07 3.45 9.84-1.65 14.93-11.49 14.93z" style="fill:#fff"/> </svg>
                            </a>
                        {/if}
                        {#if socials.twitter}
                            <a href={`https://x.com/${socials.twitter}`} target="_blank" rel="noopener noreferrer" class="social-link-btn" title="X (Twitter)">
                                <svg viewBox="0 0 201 201" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M200.448 100.651C200.448 151.17 163.011 192.936 114.377 199.713C109.83 200.344 105.177 200.674 100.455 200.674C95.0035 200.674 89.6504 200.239 84.4373 199.398C36.8266 191.73 0.461731 150.435 0.461731 100.651C0.461731 45.4078 45.2347 0.621582 100.462 0.621582C155.689 0.621582 200.462 45.4078 200.462 100.651H200.448Z" fill="#1C1C1B"/><path d="M41.0167 44.7349L87.1349 106.412L40.7294 156.56H51.1765L91.8085 112.657L124.635 156.56H160.18L111.469 91.4134L154.666 44.7349H144.219L106.803 85.1686L76.5688 44.7349H41.0236H41.0167ZM56.3754 52.4305H72.7011L144.807 148.864H128.482L56.3754 52.4305Z" fill="white"/></svg>
                            </a>
                        {/if}
                        {#if socials.website}
                            <a href={socials.website} target="_blank" rel="noopener noreferrer" class="social-link-btn" title="Site">
                                <svg version="1.0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1920.000000 1920.000000" preserveAspectRatio="xMidYMid meet"> <g transform="translate(0.000000,1920.000000) scale(0.100000,-0.100000)" fill="#ffffff" stroke="none"> <path d="M9200 19194 c-14 -2 -117 -8 -230 -13 -559 -26 -1261 -143 -1900 -315 -204 -55 -249 -69 -495 -151 -263 -87 -280 -93 -550 -200 -386 -153 -978 -441 -1215 -590 -22 -14 -42 -25 -45 -25 -10 0 -314 -189 -475 -295 -262 -173 -556 -389 -760 -559 -47 -38 -110 -90 -140 -115 -30 -24 -62 -51 -70 -60 -8 -9 -67 -62 -131 -118 -450 -394 -911 -899 -1300 -1424 -34 -46 -81 -109 -103 -139 -69 -94 -277 -409 -360 -545 -43 -72 -88 -146 -101 -165 -56 -89 -180 -317 -298 -550 -163 -324 -270 -567 -433 -985 -32 -83 -190 -559 -209 -630 -7 -27 -27 -102 -45 -165 -169 -613 -287 -1309 -323 -1910 -15 -250 -15 -1029 0 -1275 25 -402 110 -1015 184 -1329 11 -44 19 -88 19 -99 0 -10 8 -49 19 -85 10 -37 28 -110 41 -162 12 -52 30 -124 40 -160 10 -36 28 -101 40 -145 62 -226 163 -529 265 -800 15 -38 32 -83 37 -100 6 -16 14 -34 18 -40 3 -5 15 -32 25 -60 24 -65 192 -449 240 -545 86 -175 102 -208 130 -260 25 -49 193 -352 215 -390 217 -372 385 -624 663 -997 93 -125 375 -472 426 -524 9 -9 57 -61 106 -115 248 -272 308 -333 552 -559 271 -252 374 -341 568 -493 55 -43 109 -85 120 -95 53 -44 245 -185 360 -263 39 -27 72 -51 75 -54 19 -23 639 -411 685 -429 5 -2 64 -34 130 -71 241 -134 318 -173 690 -344 28 -13 70 -33 95 -44 25 -11 92 -39 150 -62 58 -23 119 -48 135 -55 321 -139 976 -342 1430 -444 363 -82 822 -158 1095 -181 63 -6 151 -15 195 -21 155 -20 815 -37 1100 -28 435 13 537 21 935 69 365 45 788 124 1130 212 63 17 138 36 167 43 28 7 73 19 100 28 26 8 84 25 128 37 145 41 649 211 710 240 11 5 56 23 100 40 44 17 89 35 100 40 11 5 61 26 110 46 50 20 122 51 160 69 39 18 143 67 232 109 90 41 232 112 315 157 84 45 180 96 213 114 84 44 343 199 510 305 430 274 954 674 1275 976 291 274 349 330 456 444 64 69 147 157 184 195 134 139 361 412 552 664 107 140 121 160 177 238 51 71 254 373 278 413 11 19 38 62 58 95 75 120 188 312 225 380 20 39 74 139 119 223 45 83 116 225 157 315 42 89 91 194 109 232 18 39 49 111 69 160 20 50 41 99 46 110 5 11 23 56 40 100 17 44 35 89 40 100 6 11 19 45 29 75 11 30 44 125 74 211 54 151 125 381 181 579 15 52 31 109 36 125 36 125 125 529 160 725 59 340 79 484 115 838 35 342 46 798 29 1262 -7 206 -18 411 -23 455 -6 44 -15 132 -21 195 -32 375 -158 1060 -257 1400 -9 30 -19 71 -23 90 -20 99 -159 538 -243 770 -56 153 -185 476 -228 568 -17 37 -56 123 -87 192 -70 156 -210 431 -295 581 -35 63 -66 119 -68 124 -22 59 -352 578 -488 770 -27 39 -66 93 -85 120 -66 92 -302 399 -333 432 -12 12 -58 67 -101 120 -44 54 -88 107 -98 118 -11 11 -89 96 -174 189 -237 259 -368 388 -710 698 -285 256 -645 534 -1035 795 -146 98 -382 245 -487 303 -15 8 -82 46 -150 84 -156 88 -300 165 -408 217 -47 23 -107 52 -135 66 -71 36 -396 179 -485 214 -41 17 -89 37 -107 45 -80 37 -521 191 -713 250 -212 65 -377 110 -520 144 -52 13 -125 31 -162 41 -36 11 -75 19 -85 19 -11 0 -55 8 -99 19 -306 72 -938 161 -1304 182 -160 10 -1016 20 -1060 13z m4960 -3476 c226 -41 413 -104 602 -206 170 -91 280 -173 433 -327 158 -158 246 -275 334 -445 132 -254 191 -469 212 -765 6 -100 9 -1587 6 -4495 l-3 -4345 -21 -110 c-41 -218 -80 -337 -168 -520 -268 -555 -772 -923 -1415 -1032 -99 -17 -337 -18 -4440 -21 -2929 -2 -4383 0 -4482 7 -182 13 -326 41 -482 92 -555 182 -1003 630 -1186 1187 -52 159 -78 295 -91 471 -7 98 -9 1576 -7 4496 l3 4350 24 125 c72 389 231 709 485 977 243 257 549 438 883 521 101 26 172 38 328 56 17 2 2024 3 4460 2 4110 -1 4437 -3 4525 -18z"/> <path d="M5055 15644 c-272 -41 -512 -134 -735 -282 -392 -262 -652 -653 -758 -1142 l-27 -125 0 -4490 0 -4490 23 -118 c150 -780 781 -1367 1567 -1457 60 -6 1535 -10 4480 -10 4781 0 4479 -3 4714 56 635 159 1140 667 1300 1309 54 217 51 -62 51 4703 0 4766 3 4485 -54 4709 -35 138 -69 230 -136 366 -256 513 -747 872 -1325 967 -118 20 -186 20 -4565 19 -3722 -1 -4460 -3 -4535 -15z m4885 -184 c0 -6 -372 -505 -826 -1110 l-826 -1100 -2277 2 -2276 3 -3 280 c-3 315 8 527 37 666 143 689 730 1205 1431 1258 163 13 4740 13 4740 1z m4037 0 c722 -56 1295 -555 1456 -1270 19 -87 21 -130 25 -517 l3 -423 -3451 0 c-2758 0 -3450 3 -3443 13 4 6 158 215 343 462 1052 1409 1294 1731 1304 1737 17 11 3620 9 3763 -2z m1483 -6349 c0 -3899 0 -3940 -20 -4056 -57 -333 -219 -636 -471 -880 -218 -212 -476 -348 -792 -417 l-102 -23 -4475 0 -4475 0 -109 23 c-148 32 -240 64 -383 132 -135 65 -212 114 -323 206 -293 243 -477 558 -552 948 l-22 111 -3 3935 c-2 2164 -1 3940 1 3947 4 11 1132 13 5866 13 l5860 0 0 -3939z"/> <path d="M5160 15383 c-19 -2 -79 -12 -134 -23 -536 -107 -985 -509 -1146 -1027 -58 -188 -63 -232 -68 -630 l-4 -373 2225 0 2225 0 762 1018 c420 559 767 1023 773 1030 7 9 -453 12 -2294 10 -1267 0 -2320 -3 -2339 -5z m512 -853 c58 -17 96 -54 113 -115 24 -82 -6 -165 -75 -204 -38 -21 -41 -21 -657 -19 l-618 3 -34 24 c-65 46 -87 140 -52 216 23 50 56 81 101 93 49 14 1173 15 1222 2z m1995 -12 c57 -32 78 -73 78 -155 0 -77 -13 -106 -69 -147 -27 -21 -39 -21 -642 -24 -603 -2 -615 -2 -654 18 -95 49 -120 187 -47 266 60 65 49 64 707 61 543 -2 598 -4 627 -19z"/> <path d="M4435 14434 c-36 -39 -35 -111 1 -145 l26 -24 605 0 605 0 24 28 c40 47 28 133 -23 156 -17 8 -204 11 -619 11 l-595 0 -24 -26z"/> <path d="M6395 14435 c-36 -35 -35 -112 1 -146 l26 -24 605 0 605 0 24 30 c35 44 33 98 -5 136 l-29 29 -602 0 -601 0 -24 -25z"/> <path d="M9505 14393 c-412 -549 -759 -1013 -773 -1030 l-24 -33 3342 0 3342 0 -5 368 c-4 323 -7 379 -26 466 -67 320 -215 584 -452 811 -198 188 -439 316 -724 383 l-110 26 -1911 3 -1911 3 -748 -997z m2505 790 c384 -76 660 -421 660 -826 0 -509 -473 -908 -980 -826 -315 50 -578 280 -668 584 -117 394 64 821 423 999 107 53 165 69 320 90 45 6 161 -4 245 -21z m2065 16 c611 -75 947 -739 639 -1264 -59 -100 -182 -224 -287 -289 -320 -199 -748 -156 -1020 103 -319 303 -350 802 -72 1148 93 116 232 214 371 261 63 22 162 40 264 50 8 1 56 -3 105 -9z"/> <path d="M11665 15114 c-374 -83 -622 -411 -602 -795 35 -665 843 -969 1309 -493 153 157 221 325 220 544 0 182 -54 334 -170 483 -84 107 -250 213 -397 253 -87 23 -273 27 -360 8z m270 -209 c108 -23 189 -68 275 -155 118 -117 170 -237 170 -390 0 -148 -55 -275 -165 -385 -258 -259 -660 -209 -863 109 -39 61 -67 148 -77 236 -22 211 114 443 316 540 123 58 220 71 344 45z"/> <path d="M11688 14821 c-77 -25 -143 -69 -210 -139 -98 -102 -133 -202 -126 -349 5 -83 10 -102 43 -171 88 -178 282 -295 461 -279 211 20 385 169 438 373 28 107 15 211 -40 320 -102 204 -354 312 -566 245z"/> <path d="M13825 15113 c-561 -119 -795 -798 -430 -1243 58 -70 72 -84 144 -135 210 -151 521 -182 757 -75 402 181 574 654 379 1041 -159 316 -509 485 -850 412z m270 -208 c107 -23 189 -68 276 -155 117 -115 161 -223 161 -390 0 -112 -23 -194 -77 -285 -45 -75 -74 -106 -150 -160 -226 -161 -514 -137 -711 60 -246 246 -207 651 83 845 132 88 269 116 418 85z"/> <path d="M13847 14820 c-122 -39 -237 -140 -295 -260 -37 -74 -37 -76 -37 -200 0 -123 1 -126 37 -203 103 -218 360 -326 585 -247 277 97 403 415 269 678 -100 195 -350 299 -559 232z"/> <path d="M3813 9043 l3 -3928 21 -95 c93 -413 309 -735 643 -958 219 -145 459 -230 716 -252 92 -8 1375 -10 4489 -8 4018 4 4366 5 4440 21 341 70 594 205 825 437 207 208 340 456 412 766 l23 99 2 3923 3 3922 -5790 0 -5790 0 3 -3927z m10287 3629 c134 -55 229 -157 270 -288 20 -65 20 -86 20 -1369 0 -1251 -1 -1306 -19 -1364 -46 -149 -168 -267 -316 -305 -53 -14 -515 -16 -4456 -16 -4279 0 -4399 1 -4458 19 -33 10 -80 30 -103 44 -61 36 -140 123 -180 198 l-33 64 -3 1339 c-2 1223 -1 1344 14 1390 25 76 58 127 122 188 64 61 100 83 182 109 52 17 264 18 4480 16 l4425 -2 55 -23z m-4240 -3802 c559 -70 1084 -352 1432 -772 220 -265 369 -556 453 -884 220 -858 -111 -1792 -820 -2314 -316 -232 -666 -374 -1049 -425 -173 -23 -489 -17 -656 13 -977 177 -1702 948 -1821 1937 -17 142 -14 387 6 540 40 312 151 621 317 885 218 345 527 623 893 805 215 106 415 169 648 205 141 21 461 26 597 10z"/> <path d="M5185 12616 c-116 -29 -207 -101 -258 -205 l-32 -66 0 -1330 0 -1330 27 -55 c36 -74 87 -132 149 -169 105 -66 -256 -61 4534 -61 3909 0 4367 2 4420 16 116 30 207 105 259 214 l31 65 0 1320 0 1320 -33 67 c-54 111 -141 182 -257 212 -53 14 -510 16 -4425 15 -3435 -1 -4376 -3 -4415 -13z m8848 -226 c21 -14 46 -43 57 -66 20 -40 20 -64 20 -1309 0 -1245 0 -1269 -20 -1309 -11 -23 -36 -52 -57 -66 l-37 -25 -4380 -3 -4380 -2 -43 21 c-23 11 -53 35 -65 52 l-23 32 -2 1290 -3 1290 23 40 c14 26 37 48 67 63 l44 22 4381 -2 4381 -3 37 -25z"/> <path d="M5248 12342 c-15 -2 -38 -17 -53 -33 l-25 -31 0 -1268 0 -1268 35 -31 36 -31 4369 2 4370 3 27 28 28 27 3 1259 c1 793 -1 1269 -7 1285 -6 14 -21 32 -34 40 -21 14 -459 16 -4373 19 -2392 1 -4361 1 -4376 -1z m1791 -700 c19 -9 47 -33 61 -52 15 -19 91 -190 170 -380 78 -190 145 -348 149 -352 3 -4 87 142 186 324 193 356 232 411 298 423 122 23 227 -58 227 -175 0 -49 -14 -78 -243 -505 -82 -154 -166 -311 -187 -350 -20 -38 -60 -114 -89 -167 -76 -142 -129 -179 -233 -165 -32 4 -51 16 -83 49 -36 37 -61 88 -175 358 -73 173 -136 319 -140 323 -7 8 -22 -26 -170 -393 -50 -124 -94 -235 -99 -246 -24 -56 -128 -101 -192 -84 -84 23 -95 37 -234 315 -355 708 -409 823 -408 874 0 26 8 61 16 77 35 68 144 110 220 85 20 -7 51 -29 69 -49 19 -22 98 -170 188 -354 85 -175 158 -314 161 -310 4 4 69 160 144 346 75 187 144 350 152 362 20 32 91 64 138 64 22 0 55 -8 74 -18z m2544 4 c18 -7 42 -25 55 -38 13 -14 86 -176 163 -359 78 -184 147 -350 155 -369 l15 -34 118 219 c65 121 148 276 185 345 95 178 139 212 250 196 60 -9 107 -42 134 -96 38 -75 31 -103 -62 -283 -342 -661 -469 -894 -505 -929 -69 -66 -151 -71 -227 -13 -43 33 -51 50 -181 358 -146 349 -145 347 -152 347 -3 0 -66 -150 -139 -334 -80 -200 -142 -342 -155 -354 -34 -32 -91 -52 -145 -52 -59 0 -120 39 -152 97 -12 21 -133 266 -270 545 -274 556 -275 558 -227 629 65 96 215 118 279 40 13 -15 97 -175 188 -354 91 -179 168 -322 171 -319 3 4 64 155 135 337 71 181 138 343 149 360 44 65 143 93 218 61z m2611 -38 c34 -38 66 -106 185 -394 79 -192 147 -352 150 -356 4 -4 71 110 151 255 234 427 239 436 276 463 89 68 234 23 276 -85 14 -38 12 -106 -5 -138 -8 -16 -30 -57 -50 -93 -19 -36 -139 -261 -267 -500 -127 -239 -245 -450 -263 -467 -38 -41 -85 -57 -149 -51 -83 8 -113 47 -204 267 -43 102 -105 252 -139 333 -34 81 -63 150 -66 152 -3 3 -65 -145 -138 -329 -118 -296 -138 -339 -171 -369 -50 -45 -98 -60 -146 -47 -48 13 -96 47 -122 85 -11 17 -134 261 -271 542 -220 447 -251 517 -251 558 0 54 16 90 57 127 56 52 142 63 208 26 38 -21 50 -41 208 -357 93 -184 172 -336 176 -338 4 -1 15 14 23 35 279 695 276 688 343 719 19 9 53 13 89 11 56 -3 62 -6 100 -49z"/> <path d="M6901 11563 c-24 -22 -64 -113 -191 -433 -88 -223 -164 -413 -168 -423 -5 -13 -60 90 -201 380 -197 404 -226 453 -276 453 -63 0 -115 -48 -115 -107 0 -14 116 -261 258 -548 274 -552 282 -565 349 -565 17 0 42 11 61 28 28 23 54 80 175 387 l143 360 35 3 35 3 158 -368 c87 -202 167 -378 178 -390 30 -32 71 -38 114 -16 27 13 46 36 74 88 20 39 146 272 279 519 133 247 245 461 248 476 10 52 -40 117 -98 126 -68 11 -91 -18 -232 -281 -294 -549 -310 -577 -317 -564 -4 8 -85 201 -180 429 -185 449 -197 470 -265 470 -24 0 -44 -9 -64 -27z"/> <path d="M9463 11580 c-12 -5 -26 -17 -32 -28 -5 -10 -83 -200 -171 -423 -89 -222 -166 -411 -170 -418 -5 -10 -71 111 -205 380 -108 216 -206 404 -217 416 -29 31 -70 38 -110 19 -34 -17 -68 -61 -68 -90 0 -8 119 -254 265 -546 292 -585 287 -577 370 -565 22 3 47 12 55 20 8 8 82 185 165 393 l150 377 33 0 33 0 103 -240 c56 -132 128 -302 160 -377 49 -115 64 -141 91 -158 39 -24 66 -25 104 -5 33 16 24 1 355 632 248 474 249 477 197 535 -25 28 -36 33 -75 33 -37 0 -51 -5 -75 -30 -16 -16 -120 -201 -232 -410 -111 -209 -208 -388 -214 -398 -11 -16 -25 11 -105 200 -243 571 -282 659 -294 671 -17 17 -84 25 -113 12z"/> <path d="M12028 11574 c-36 -19 -40 -28 -156 -325 -193 -495 -215 -550 -225 -546 -5 1 -96 180 -202 397 -124 254 -202 402 -219 417 -33 28 -71 29 -113 3 -40 -24 -57 -55 -50 -94 3 -17 120 -264 261 -548 222 -451 260 -520 288 -538 18 -11 45 -20 60 -20 59 0 78 34 221 400 75 190 141 357 146 373 8 21 17 27 40 27 15 0 33 -6 38 -12 6 -7 42 -89 81 -183 140 -335 219 -521 236 -552 24 -47 69 -68 116 -54 21 6 42 17 48 24 5 6 136 247 291 533 169 315 281 532 281 548 0 79 -81 133 -153 103 -32 -14 -52 -48 -256 -423 -123 -225 -226 -412 -230 -417 -4 -4 -39 70 -79 165 -39 95 -92 223 -117 283 -26 61 -73 175 -106 255 -78 192 -119 229 -201 184z"/> <path d="M9331 8794 c-364 -44 -709 -183 -1011 -408 -112 -83 -298 -261 -382 -365 -365 -453 -530 -1021 -463 -1593 112 -955 818 -1698 1778 -1870 166 -30 485 -32 662 -4 474 73 915 305 1243 651 507 535 700 1310 507 2029 -74 272 -207 541 -373 751 -74 93 -229 252 -322 329 -454 379 -1044 552 -1639 480z m376 -230 c130 -63 274 -284 371 -569 49 -146 127 -454 117 -464 -2 -2 -73 3 -157 10 -86 8 -278 14 -438 14 -160 0 -352 -6 -438 -14 -84 -7 -156 -11 -159 -7 -11 10 46 249 92 391 123 379 281 610 455 666 37 12 98 2 157 -27z m-621 -70 c17 -25 16 -28 -49 -157 -37 -73 -82 -172 -101 -222 -44 -115 -110 -358 -136 -500 -11 -60 -23 -112 -28 -116 -4 -5 -75 -21 -158 -38 -264 -52 -546 -147 -732 -247 -79 -43 -83 -44 -107 -28 -14 9 -25 23 -25 31 0 26 72 208 127 317 223 449 590 773 1083 957 93 35 105 35 126 3z m1172 -10 c478 -179 848 -511 1065 -954 57 -117 117 -277 117 -310 0 -10 -9 -26 -21 -34 -20 -13 -30 -10 -129 40 -223 111 -441 184 -704 235 -83 17 -155 34 -159 38 -5 5 -17 52 -27 104 -52 269 -144 549 -244 743 l-63 122 20 26 c10 14 25 26 33 26 8 0 59 -16 112 -36z m-428 -1144 c251 -12 397 -29 404 -46 3 -7 12 -104 22 -216 25 -305 9 -941 -25 -1024 -10 -24 -28 -27 -299 -45 -252 -17 -825 -2 -948 26 -19 4 -22 16 -34 127 -21 209 -25 715 -6 926 9 101 16 192 16 201 0 15 17 20 113 30 244 27 492 34 757 21z m-1084 -87 c-12 -41 -27 -241 -32 -448 -6 -210 6 -534 25 -670 5 -33 7 -61 6 -63 -2 -2 -20 1 -42 7 -21 6 -83 20 -138 32 -315 68 -645 220 -787 362 -139 138 -136 269 9 408 175 169 446 285 898 382 48 11 66 7 61 -10z m1847 -7 c371 -81 661 -210 820 -364 144 -140 147 -273 8 -410 -145 -143 -442 -281 -771 -357 -63 -14 -132 -31 -153 -36 -22 -6 -40 -9 -42 -7 -2 2 0 37 5 78 18 166 32 512 26 655 -8 181 -24 412 -31 443 -7 28 -2 28 138 -2z m-2672 -1131 c192 -98 421 -174 710 -235 79 -17 145 -32 146 -34 2 -2 10 -43 19 -92 52 -301 176 -658 294 -848 l20 -33 -28 -26 -27 -26 -105 39 c-230 86 -423 199 -611 358 -243 205 -452 512 -560 824 -34 96 -34 97 -14 112 11 9 26 16 34 16 8 0 63 -25 122 -55z m3506 40 l22 -16 -35 -102 c-190 -549 -604 -968 -1164 -1177 l-105 -39 -26 25 -25 24 65 133 c105 209 179 438 241 741 11 55 22 101 23 102 2 2 67 17 145 33 283 60 556 152 727 245 91 49 102 52 132 31z m-2265 -351 c191 -23 681 -23 881 1 82 9 150 15 153 12 3 -3 1 -22 -5 -44 -6 -21 -25 -99 -42 -173 -99 -422 -273 -740 -454 -829 -202 -100 -427 134 -588 609 -35 105 -90 317 -103 398 -8 50 -22 48 158 26z"/> <path d="M9525 8503 c-119 -62 -258 -287 -350 -566 -43 -130 -90 -315 -83 -322 2 -2 60 0 128 5 163 12 602 12 755 0 65 -5 121 -7 124 -4 8 8 -39 191 -85 333 -136 417 -331 637 -489 554z"/> <path d="M8882 8380 c-337 -140 -629 -383 -829 -687 -80 -122 -216 -403 -195 -403 4 0 53 21 110 46 181 81 464 168 693 214 l55 11 23 121 c43 226 122 470 207 640 24 48 44 90 44 93 0 9 -12 5 -108 -35z"/> <path d="M10210 8416 c0 -3 16 -36 34 -74 49 -97 99 -223 129 -327 27 -93 91 -352 103 -417 3 -21 9 -38 11 -38 19 0 259 -58 363 -87 125 -35 360 -122 438 -162 23 -12 46 -21 51 -21 23 0 -100 256 -186 390 -71 109 -115 163 -227 278 -189 195 -379 326 -610 421 -102 43 -106 44 -106 37z"/> <path d="M9183 7256 c-78 -7 -145 -15 -149 -18 -18 -19 -28 -210 -28 -563 0 -366 10 -546 31 -565 17 -16 306 -34 558 -35 256 0 539 18 561 36 20 16 39 295 39 564 0 255 -19 541 -36 559 -29 31 -685 45 -976 22z"/> <path d="M8515 7150 c-368 -96 -642 -241 -737 -389 -54 -85 -32 -159 75 -257 85 -77 197 -143 349 -204 116 -47 338 -113 421 -127 l37 -6 -7 59 c-10 76 -10 821 0 897 9 69 16 67 -138 27z"/> <path d="M10543 7113 c13 -89 13 -789 0 -876 l-10 -69 44 7 c126 19 415 116 556 186 188 95 317 219 317 306 0 135 -214 301 -535 413 -95 33 -339 100 -366 100 -13 0 -14 -9 -6 -67z"/> <path d="M7871 6008 c147 -378 421 -705 769 -921 122 -75 358 -181 347 -155 -3 7 -30 67 -60 133 -88 196 -163 442 -198 648 l-12 74 -131 28 c-269 58 -501 132 -656 210 -38 19 -72 35 -75 35 -2 0 5 -24 16 -52z"/> <path d="M11260 6021 c-150 -77 -368 -146 -646 -206 l-131 -28 -27 -126 c-62 -281 -136 -511 -218 -675 -16 -32 -28 -60 -26 -62 9 -8 239 100 334 157 243 146 495 395 629 620 83 141 185 360 167 359 -4 -1 -41 -18 -82 -39z"/> <path d="M9090 5730 c0 -22 59 -245 85 -323 87 -257 214 -475 321 -550 56 -39 117 -46 170 -19 102 52 213 209 297 422 62 156 150 462 136 473 -2 2 -35 0 -74 -4 -220 -24 -830 -19 -917 7 -10 3 -18 0 -18 -6z"/> </g> </svg>
                            </a>
                        {/if}
                            </div>
                        </div>
                    </div>
                {/if}

                {#if data.profile.about_me && data.profile.about_me.trim()}
                    <div class="profile-section">
                        <h4 class="font-display">// {$t('profile.info')}</h4>
                        <p class="about-me-text">{data.profile.about_me}</p>
                    </div>
                {/if}
            </div>

            {#if isOwner}
                <div class="profile-actions">
                    <NeonButton href="/profile/edit">{$t('profile.edit')}</NeonButton>
                </div>
            {/if}

            <div class="ticker-wrap">
            <div class="ticker">
                <span>STATUS: ONLINE // SECURITY LEVEL: 5 // BIOMETRICS: SYNCED // LAST UPDATE: {new Date().toLocaleDateString()} // WELCOME USER. </span>
                <span>STATUS: ONLINE // SECURITY LEVEL: 5 // BIOMETRICS: SYNCED // LAST UPDATE: {new Date().toLocaleDateString()} // WELCOME USER. </span>
            </div>
        </div>
            </div>
        </div>

        <div class="comments-container max-w-4xl mx-auto mt-12 pb-32">
    <h4 class="font-display text-2xl text-cyber-yellow mb-6 text-center tracking-widest">// КОММЕНТАРИИ</h4>

    {#if $userStore.user}
        <form on:submit|preventDefault={handleAddComment} class="comment-input-box cyber-panel p-4 mb-8">
            {#if replyingToId}
                <div class="reply-badge" transition:slide>
                    <span>Ответ для: <strong class="text-white">{replyingToName}</strong></span>
                    <button type="button" on:click={cancelReply} class="text-red-400 hover:text-white ml-2">✕</button>
                </div>
            {/if}

            <div class="flex gap-4">
                <div class="comment-avatar-wrapper {$userStore.user.equipped_frame || ''} hidden sm:block">
                     <img src={getOptimizedAvatar($userStore.user.avatar_url)} alt="Me" class="comment-avatar"/>
                </div>
                <div class="flex-grow">
                    <textarea
                        name="commentText"
                        bind:value={commentText}
                        placeholder={replyingToId ? `Ответ для @${replyingToName}...` : $t('profile.comment_placeholder')}
                        class="input-field w-full"
                        rows="2"
                    ></textarea>
                </div>
                <NeonButton type="submit" disabled={isSubmitting} extraClass="self-end h-full">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" /></svg>
                </NeonButton>
            </div>
        </form>
    {:else}
        <!-- Заглушка для гостей -->
    {/if}

    <div class="comments-tree space-y-4">
        {#each data.comments as comment (comment.id)}
            <!-- РОДИТЕЛЬСКИЙ КОММЕНТАРИЙ -->
            <div class="comment-node" transition:fade>
                <div class="comment-card">
                    <!-- Цветной индикатор слева -->
                    <div class="accent-line"></div>

                    <div class="card-content">
                        <!-- ШАПКА: Аватар + Имя + Дата -->
                        <div class="card-header">
                            <div class="author-info">
                                <a href={comment.author_uid ? `/u/${comment.author_uid}` : `/profile/${comment.author_username}`} class="comment-avatar-wrapper {comment.author_equipped_frame || ''}">
                                    <img src={getOptimizedAvatar(comment.author_avatar_url)} alt="" class="comment-avatar" />
                                </a>
                                <div class="name-date">
                                    <a href={comment.author_uid ? `/u/${comment.author_uid}` : `/profile/${comment.author_username}`} class="author-name">{comment.author_username}</a>
                                    <span class="time">{formatTimeAgo(comment.createdAt)}</span>
                                </div>
                            </div>

                            <!-- Кнопки управления -->
                            {#if $userStore.user}
                                <div class="controls">
                                    {#if comment.author_uid === $userStore.user.uid || isOwner}
                                         <button on:click={() => handleDeleteComment(comment.id)} class="icon-btn del">
                                            <i class="fas fa-trash"></i>
                                         </button>
                                    {/if}
                                    <button on:click={() => handleReportComment(comment.id, comment.author_username)} class="icon-btn warn">
                                        <i class="fas fa-exclamation-circle"></i>
                                    </button>
                                </div>
                            {/if}
                        </div>

                        <div class="card-body" style="white-space: pre-wrap;">
    {comment.text}
</div>

                        <!-- ПОДВАЛ -->
                        <div class="card-footer">
                            <button class="action-pill like" class:liked={comment.likes.includes($userStore.user?.uid || '')} on:click={() => handleLike(comment.id)}>
                                <i class="fas fa-heart"></i>
                                <span>{comment.likes.length || 0}</span>
                            </button>

                            <button class="action-pill reply" on:click={() => startReply(comment.id, comment.author_username)}>
                                <i class="fas fa-reply"></i>
                                <span>{$t('profile.reply')}</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ВЕТКА ОТВЕТОВ -->
                {#if comment.replies && comment.replies.length > 0}
                    <div class="replies-wrapper">
                        {#each comment.replies as reply (reply.id)}
                            <div class="comment-card reply">
                                <div class="accent-line reply-line"></div>
                                <div class="card-content">
                                    <div class="card-header">
                                        <div class="author-info">
                                            <a href={reply.author_uid ? `/u/${reply.author_uid}` : `/profile/${reply.author_username}`} class="comment-avatar-wrapper small {reply.author_equipped_frame || ''}">
                                                <img src={getOptimizedAvatar(reply.author_avatar_url)} alt="" class="comment-avatar" />
                                            </a>
                                            <div class="name-date">
                                                <a href={reply.author_uid ? `/u/${reply.author_uid}` : `/profile/${reply.author_username}`} class="author-name text-sm">{reply.author_username}</a>
                                                <span class="time">{formatTimeAgo(reply.createdAt)}</span>
                                            </div>
                                        </div>
                                        {#if $userStore.user && (reply.author_uid === $userStore.user.uid || isOwner)}
                                            <button on:click={() => handleDeleteComment(reply.id)} class="icon-btn del small">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        {/if}
                                    </div>
                                    <div class="card-body text-sm">
                                        {@html renderMarkdown(reply.text)}
                                    </div>
                                    <div class="card-footer">
                                         <button class="action-pill like small" class:liked={reply.likes.includes($userStore.user?.uid || '')} on:click={() => handleLike(reply.id)}>
                                            <i class="fas fa-heart"></i> {reply.likes.length || 0}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {/each}
                    </div>
                {/if}
            </div>
        {/each}
    </div>
</div>
{/if}


<style>
    @keyframes ticker-scroll {
        0% { transform: translateX(0); }
        100% { transform: translateX(-50%); }
    }
    @keyframes content-fade-in {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes report-pulse {
      0%, 100% {
        transform: scale(1);
        opacity: 0.7;
      }
      50% {
        transform: scale(1.1);
        opacity: 1;
      }
    }

    .profile-container {
        @apply max-w-2xl mx-auto my-10 p-1 sm:p-2 rounded-none shadow-2xl relative;
        padding-bottom: 2rem !important;
        background: #0a0a0a;
        border: 1px solid rgba(252, 238, 10, 0.3);
        clip-path: polygon(0 20px, 20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%);
        overflow: hidden;
        background-image:
            linear-gradient(rgba(10, 10, 10, 0.96), rgba(10, 10, 10, 0.96)),
            linear-gradient(rgba(252, 238, 10, 0.1) 1px, transparent 1px),
            linear-gradient(90deg, rgba(252, 238, 10, 0.1) 1px, transparent 1px);
        background-size: 100% 100%, 30px 30px, 30px 30px;
    }

    .corner-bg { @apply absolute w-16 h-16 opacity-15 blur-sm; background: radial-gradient(circle, var(--cyber-yellow, #fcee0a) 0%, rgba(252, 238, 10, 0) 60%); }
    .top-left { top: -30px; left: -30px; }
    .top-right { top: -30px; right: -30px; }
    .bottom-left { bottom: -30px; left: -30px; }
    .bottom-right { bottom: -30px; right: -30px; }

    .top-bar {
        @apply relative flex items-center justify-between p-2 text-xs uppercase tracking-widest text-cyber-yellow/70;
        border-bottom: 1px solid var(--border-color);
        padding-right: 3.5rem;
    }

    .profile-header, .profile-content, .profile-actions { animation: content-fade-in 0.5s ease-out both; }
    .profile-content { animation-delay: 0.2s; }
    .profile-actions { animation-delay: 0.4s; }

    .profile-header { @apply flex flex-col items-center text-center p-6; }
    .profile-avatar { @apply w-32 h-32 rounded-full object-cover mb-4; border: 4px solid var(--cyber-yellow); box-shadow: 0 0 20px var(--cyber-yellow); }
    .profile-username { @apply text-4xl font-bold text-white break-words; }

    .profile-content { @apply p-6 text-left; }
    .profile-section { @apply pb-6 mb-6; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    .profile-content > .profile-section:last-of-type { border-bottom: none; padding-bottom: 0; margin-bottom: 0; }
    .profile-section h4 { @apply mb-2 text-sm font-bold uppercase tracking-widest text-cyber-yellow; }
    .about-me-text { @apply whitespace-pre-wrap leading-relaxed text-gray-200; }

    .social-links-grid { @apply flex flex-wrap justify-center gap-4 mt-4 content-center; }
    .social-link-btn { @apply w-14 h-14 flex items-center justify-center rounded-full text-gray-400 bg-gray-900/50 border border-gray-700; transition: all 0.2s ease-in-out; }
    .social-link-btn:hover { @apply text-white border-cyber-yellow scale-110; box-shadow: 0 0 15px var(--cyber-yellow, #fcee0a); }

    .profile-actions { @apply p-6 text-center border-t border-gray-800; }

    .ticker-wrap { @apply absolute bottom-0 left-0 w-full p-2 overflow-hidden text-xs uppercase tracking-wider; background: var(--bg-color); border-top: 1px solid var(--border-color); }
    .ticker { @apply inline-block whitespace-nowrap; animation: ticker-scroll 30s linear infinite; }

    .comments-container {
        @apply mt-12 max-w-4xl mx-auto pb-32;
    }
    .comments-container h4 {
        @apply text-2xl text-center mb-6;
    }

    .add-comment-form { @apply flex items-start gap-4 mb-8; }
    .comment-avatar { @apply w-12 h-12 rounded-full object-cover border-2 border-gray-600 shrink-0; }
    .add-comment-form .comment-avatar { @apply border-cyber-yellow; }

    .input-field { @apply block w-full p-2 bg-transparent text-gray-200 resize-none rounded-none; border: none; border-bottom: 1px solid var(--border-color, #30363d); font-family: 'Inter', sans-serif; font-size: 1em; transition: border-color 0.3s, box-shadow 0.3s; }
    .input-field:focus { @apply outline-none border-cyber-yellow; box-shadow: 0 1px 0 var(--cyber-yellow, #fcee0a); }

    .error-message-small { @apply text-red-400 text-sm mt-1; }
    .comments-list { @apply mt-6 space-y-6; }
    .comment-card { @apply flex items-start gap-4; }
    .comment-header { @apply flex items-baseline gap-3 mb-1; }
    .comment-author { @apply font-bold text-white hover:text-cyber-yellow transition-colors; }
    .comment-time { @apply text-xs text-gray-500; }
    .comment-text { @apply whitespace-pre-wrap text-gray-300; }
    .comment-actions { @apply mt-2; }
    .action-btn { @apply text-xs text-gray-500 hover:text-red-400 transition-colors; }

    .report-icon-btn {
        @apply absolute top-1 right-2 z-20 p-2 rounded-full;
        color: var(--cyber-red, #ff003c);
        animation: report-pulse 2.5s infinite cubic-bezier(0.4, 0, 0.6, 1);
        transition: all 0.2s ease-in-out;
    }
    .report-icon-btn:hover {
        background-color: rgba(255, 0, 60, 0.25);
        color: #ff4d6d;
        transform: scale(1.2);
        animation-play-state: paused;
        box-shadow: 0 0 15px var(--cyber-red, #ff003c);
    }
    .report-icon-btn:focus-visible {
        @apply outline-none ring-2 ring-offset-2 ring-offset-black ring-red-500;
    }

    .top-bar::before {
        content: '';
        @apply absolute top-1/2 left-2 w-2 h-2 rounded-full bg-cyber-yellow;
        transform: translateY(-50%);
        box-shadow: 0 0 5px var(--cyber-yellow);
    }
 .avatar-wrapper {
    position: relative;
    display: inline-block;
    border-radius: 50%;
    line-height: 0;
}

.profile-avatar {
    @apply w-32 h-32 rounded-full object-cover;
    box-shadow: none;
    border: none;
}
.add-comment-form .comment-avatar { @apply border-cyber-yellow; }

.comment-avatar-wrapper {
        position: relative;
        flex-shrink: 0;
        width: 48px;
        height: 48px;
        border-radius: 50%;
    }
    .comment-avatar {
        @apply w-12 h-12 rounded-full object-cover;
        border: none;
    }
    .private-section {
        background: rgba(255, 255, 255, 0.02);
        border: 1px dashed rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 1rem !important; /* Перебиваем паддинг родителя если надо */
        margin-bottom: 1.5rem;
    }

    .email-control {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 0.5rem;
    }

    .verified-badge {
        display: inline-flex; align-items: center; gap: 4px;
        background: rgba(57, 255, 20, 0.1);
        border: 1px solid #39ff14;
        color: #39ff14;
        font-size: 0.7rem; font-weight: bold;
        padding: 4px 8px; border-radius: 4px;
        font-family: 'Chakra Petch', monospace;
        cursor: help;
        box-shadow: 0 0 10px rgba(57, 255, 20, 0.2);
    }

    .unverified-btn {
        background: rgba(255, 215, 0, 0.1);
        border: 1px solid var(--cyber-yellow);
        color: var(--cyber-yellow);
        font-size: 0.7rem; font-weight: bold;
        padding: 4px 10px; border-radius: 4px;
        font-family: 'Chakra Petch', monospace;
        cursor: pointer; transition: all 0.2s;
        animation: blink-border 2s infinite;
    }
    .unverified-btn:hover {
        background: var(--cyber-yellow);
        color: #000;
        box-shadow: 0 0 15px var(--cyber-yellow);
    }
    .unverified-btn:disabled {
        opacity: 0.5; cursor: not-allowed; animation: none; filter: grayscale(1);
    }

    @keyframes blink-border {
        0%, 100% { box-shadow: 0 0 2px var(--cyber-yellow); }
        50% { box-shadow: 0 0 8px var(--cyber-yellow); }
    }
    .verified-badge {
    position: relative;
    display: inline-flex; align-items: center; gap: 4px;
    background: rgba(57, 255, 20, 0.1);
    border: 1px solid #39ff14;
    color: #39ff14;
    font-size: 0.7rem; font-weight: bold;
    padding: 4px 8px; border-radius: 4px;
    font-family: 'Chakra Petch', monospace;
    cursor: help;
    box-shadow: 0 0 10px rgba(57, 255, 20, 0.2);
}

.verified-tooltip {
    position: absolute;
    bottom: 130%;
    left: 50%;
    transform: translateX(-50%) translateY(5px);
    width: 180px;
    background: rgba(5, 10, 5, 0.95);
    border: 1px solid #39ff14;
    color: #ccc;
    padding: 0.6rem;
    border-radius: 4px;
    font-size: 0.65rem;
    line-height: 1.3;
    font-family: 'Inter', sans-serif;
    font-weight: normal;
    text-align: center;
    text-transform: none;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);

    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 50;
}

.verified-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: #39ff14 transparent transparent transparent;
}

.verified-badge:hover .verified-tooltip {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
}
.profile-backdrop {
    position: fixed;
    top: 0; left: 0; width: 100vw; height: 100vh;
    z-index: -1;
    pointer-events: none;
}
.cyber-glass {
        background: rgba(20, 25, 30, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(5px);
        border-radius: 8px;
        transition: border-color 0.2s;
    }
    .cyber-glass:hover { border-color: rgba(255, 255, 255, 0.15); }

    .comment-card { padding: 1rem; position: relative; }
    .comment-card.reply {
        margin-top: 0.5rem;
        background: rgba(255, 255, 255, 0.03);
        border-left: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 0 8px 8px 0;
    }

    .replies-branch {
        margin-left: 2rem; /* Отступ ветки */
        border-left: 1px dashed rgba(255, 255, 255, 0.1); /* Линия ветки */
        padding-left: 1rem;
        margin-top: 0.5rem;
    }

    .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
    .author-name { font-weight: bold; color: #fff; font-family: 'Chakra Petch', sans-serif; }
    .group:hover .author-name { color: var(--cyber-yellow); }
    .time { color: #555; font-size: 0.75rem; margin-left: 0.5rem; }

    .card-body { color: #d1d5db; line-height: 1.5; word-wrap: break-word; }

    .card-footer {
        margin-top: 0.8rem; display: flex; gap: 1rem; align-items: center;
        border-top: 1px solid rgba(255,255,255,0.05); padding-top: 0.5rem;
    }

    /* Анимация удара сердца */
    @keyframes heart-pop {
        0% { transform: scale(1); }
        50% { transform: scale(1.3); }
        100% { transform: scale(1); }
    }

    /* === КНОПКА ЛАЙКА (CYBER HEARTBURST) === */
    .like-btn {
        position: relative; /* Для позиционирования волны */
        display: flex; align-items: center; gap: 6px;
        color: #64748b; font-size: 0.85rem; font-weight: bold;
        background: none; border: none; cursor: pointer;
        padding: 4px 8px; border-radius: 4px;
        transition: color 0.3s;
        overflow: visible; /* Чтобы волна выходила за пределы */
    }

    .like-btn:hover { background: rgba(255,255,255,0.08); color: #fff; }

    .like-btn svg {
        transition: fill 0.3s ease;
        transform-origin: center;
    }

    /* АКТИВНОЕ СОСТОЯНИЕ */
    .like-btn.liked {
        color: #ff003c;
        text-shadow: 0 0 12px rgba(255, 0, 60, 0.6);
    }

    .like-btn.liked svg {
        fill: currentColor;
        /* Запускаем анимацию сердца */
        animation: cyber-heart-bounce 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }

    /* ЭФФЕКТ УДАРНОЙ ВОЛНЫ (SHOCKWAVE) */
    .like-btn.liked::before {
        content: '';
        position: absolute;
        top: 50%; left: 16px; /* Центрируем относительно иконки */
        width: 10px; height: 10px;
        border-radius: 50%;
        border: 2px solid #ff003c;
        opacity: 0;
        transform: translate(-50%, -50%) scale(0);
        /* Запускаем анимацию волны */
        animation: ripple-blast 0.6s ease-out;
        pointer-events: none;
    }

    /* АНИМАЦИЯ 1: ПУЛЬСАЦИЯ СЕРДЦА */
    @keyframes cyber-heart-bounce {
        0% { transform: scale(1); }
        30% { transform: scale(0.6); } /* Сжатие */
        50% { transform: scale(1.4); filter: brightness(1.5) drop-shadow(0 0 5px #ff003c); } /* Взрыв */
        100% { transform: scale(1); }
    }

    /* АНИМАЦИЯ 2: РАСХОЖДЕНИЕ КОЛЬЦА */
    @keyframes ripple-blast {
        0% { transform: translate(-50%, -50%) scale(0); opacity: 1; border-width: 4px; }
        100% { transform: translate(-50%, -50%) scale(4); opacity: 0; border-width: 0px; }
    }

    .icon-btn { color: #444; padding: 0 4px; font-weight: bold; transition: color 0.2s; }
    .icon-btn:hover { color: #fff; }
    .icon-btn.del:hover { color: #ff003c; }

    .reply-badge {
        background: rgba(0, 243, 255, 0.1); border: 1px solid var(--cyber-cyan);
        color: var(--cyber-cyan); padding: 0.3rem 0.8rem; border-radius: 4px;
        font-size: 0.8rem; margin-bottom: 0.5rem; display: inline-flex; align-items: center;
    }

    /* === ОСНОВНОЙ КОНТЕЙНЕР === */
    .comments-container {
        @apply mt-12 max-w-4xl mx-auto pb-32;
    }

    /* === КАРТОЧКА === */
    .comment-node { margin-bottom: 1.5rem; }

    .comment-card {
        position: relative;
        background: linear-gradient(180deg, rgba(30, 35, 45, 0.7) 0%, rgba(20, 25, 30, 0.9) 100%);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
        display: flex;
    }

    .comment-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        border-color: rgba(255, 255, 255, 0.15);
    }

    /* Цветная линия слева (Акцент) */
    .accent-line {
        width: 4px;
        background: var(--cyber-yellow);
        box-shadow: 2px 0 10px var(--cyber-yellow);
        flex-shrink: 0;
    }

    .reply-line {
        background: var(--cyber-cyan); /* Другой цвет для ответов */
        box-shadow: 2px 0 10px var(--cyber-cyan);
    }

    .card-content {
        padding: 1rem 1.5rem;
        flex-grow: 1;
        min-width: 0;
    }

    /* === ШАПКА === */
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.8rem;
    }

    .author-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .name-date {
        display: flex;
        flex-direction: column;
        line-height: 1.2;
    }

    .author-name {
        font-family: 'Chakra Petch', sans-serif;
        font-weight: 700;
        font-size: 1rem;
        color: #fff;
        text-decoration: none;
        transition: color 0.2s;
    }
    .author-name:hover { color: var(--cyber-yellow); }

    .time {
        font-size: 0.75rem;
        color: #64748b;
        font-family: monospace;
    }

    /* АВАТАР */
    .comment-avatar-wrapper {
        position: relative;
        width: 42px; height: 42px;
        flex-shrink: 0;
        border-radius: 50%;
    }
    .comment-avatar-wrapper.small {
        width: 32px; height: 32px;
    }

    .comment-avatar {
        width: 100%; height: 100%;
        border-radius: 50%;
        object-fit: cover;
        background: #111;
        position: relative;
        z-index: 2;
    }

    /* === ТЕКСТ === */
    .card-body {
        color: #e2e8f0;
        font-size: 0.95rem;
        line-height: 1.6;
        margin-bottom: 1rem;
    }
    .card-body :global(a) { color: var(--cyber-cyan); text-decoration: underline; }

    /* === ФУТЕР И КНОПКИ === */
    .card-footer {
        display: flex;
        gap: 0.8rem;
    }

    /* Стильные "таблетки" кнопок */
    .action-pill {
        display: flex; align-items: center; gap: 6px;
        padding: 6px 12px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 6px;
        color: #94a3b8;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .action-pill:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
    }

    .action-pill.like:hover, .action-pill.like.liked {
        color: #ff003c;
        border-color: rgba(255, 0, 60, 0.3);
        background: rgba(255, 0, 60, 0.1);
    }

    .action-pill.reply:hover {
        color: var(--cyber-cyan);
        border-color: rgba(0, 243, 255, 0.3);
        background: rgba(0, 243, 255, 0.1);
    }

    .action-pill.small { padding: 4px 8px; font-size: 0.75rem; }

    /* Управление (удалить/репорт) */
    .icon-btn {
        color: #444; background: none; border: none; cursor: pointer; transition: color 0.2s;
    }
    .icon-btn:hover { color: #fff; }
    .icon-btn.del:hover { color: #ff003c; }

    /* ОТВЕТЫ */
    .replies-wrapper {
        margin-left: 3rem; /* Сдвигаем ветку */
        margin-top: 0.5rem;
        display: flex; flex-direction: column; gap: 0.5rem;
        border-left: 2px solid rgba(255,255,255,0.05); /* Линия соединения */
        padding-left: 1rem;
    }

    .comment-card.reply {
        background: rgba(0, 0, 0, 0.4);
        border-radius: 8px;
        padding: 0;
        border: 1px solid rgba(255,255,255,0.05);
    }
    .comment-card.reply .card-content { padding: 0.8rem 1rem; }

    @media (max-width: 640px) {
        .replies-wrapper { margin-left: 1rem; padding-left: 0.5rem; }
        .card-content { padding: 1rem; }
        .action-pill span { display: none; } /* Скрываем текст кнопок на мобиле, оставляем иконки */
        .action-pill i { margin-right: 0; }
        .action-pill.like span { display: inline; } /* Но счетчик лайков оставляем */
    }
    /* === ФОРМА ВВОДА (TECH CONSOLE) === */
    .comment-input-box {
        position: sticky;
        bottom: 2rem;
        z-index: 50; /* Поверх остальных элементов при скролле */

        display: flex;
        flex-direction: column;
        gap: 0.8rem;

        /* Темный технологичный фон */
        background: rgba(13, 15, 20, 0.95);
        backdrop-filter: blur(12px);

        /* Тонкая рамка */
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-top: 1px solid rgba(255, 255, 255, 0.15); /* Блик сверху */

        border-radius: 16px;
        padding: 1.25rem;

        /* Глубокая тень, чтобы отделить от контента снизу */
        box-shadow:
            0 20px 40px rgba(0, 0, 0, 0.8),
            0 0 0 1px rgba(0, 0, 0, 0.5);

        transition: transform 0.3s, border-color 0.3s;
    }

    /* Подсветка всей коробки при фокусе */
    .comment-input-box:focus-within {
        border-color: rgba(0, 243, 255, 0.3);
        box-shadow:
            0 20px 50px rgba(0, 0, 0, 0.9),
            0 0 20px rgba(0, 243, 255, 0.05);
    }

    /* Поле ввода */
    .input-field {
        width: 100%;
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.05);
        color: #fff;
        padding: 1rem;
        border-radius: 8px;
        font-family: 'Inter', sans-serif;
        font-size: 0.95rem;
        line-height: 1.5;
        resize: none; /* Убираем уголок растягивания (или vertical) */
        transition: all 0.2s ease-in-out;
    }

    .input-field::placeholder {
        color: #555;
        font-family: 'Chakra Petch', monospace;
        letter-spacing: 0.05em;
    }

    .input-field:focus {
        outline: none;
        background: rgba(0, 0, 0, 0.6);
        border-color: var(--cyber-cyan);
        /* Внутреннее свечение */
        box-shadow: inset 0 0 15px rgba(0, 243, 255, 0.05);
    }

    /* Плашка ответа (всплывает сверху) */
    .reply-badge {
        background: linear-gradient(90deg, rgba(0, 243, 255, 0.1), transparent);
        border-left: 3px solid var(--cyber-cyan);
        padding: 0.6rem 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        font-size: 0.85rem;
        color: var(--cyber-cyan);
        border-radius: 4px;
        font-family: 'Chakra Petch', monospace;
        animation: slide-in 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
    }

    @keyframes slide-in {
        0% { opacity: 0; transform: translateY(10px); }
        100% { opacity: 1; transform: translateY(0); }
    }

    /* Адаптация кнопки внутри формы */
    .comment-input-box :global(.neon-btn) {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 1.5rem !important; /* Больше воздуха по бокам */
        border-radius: 8px;
    }

    /* Мобилка */
    @media (max-width: 640px) {
        .comment-input-box {
            padding: 1rem;
            bottom: 1rem; /* Чуть выше дна экрана */
            border-radius: 12px;
        }
        /* Скрываем аватарку слева на мобиле, чтобы сэкономить место */
        .comment-input-box .comment-avatar-wrapper {
            display: none;
        }
        .input-field {
            font-size: 16px; /* Фикс зума на айфоне */
        }
    }
</style>
</file>

<file path="functions/src/index.ts">
import { onRequest } from "firebase-functions/v2/https";
import { onCall, HttpsError } from "firebase-functions/v2/https";
import * as admin from "firebase-admin";
import fetch from "node-fetch";
import { FieldValue } from "firebase-admin/firestore";
import { v2 as cloudinary } from "cloudinary";
import * as crypto from 'crypto';
import { telegramWebhook } from './telegramBot';
import { getMessaging } from "firebase-admin/messaging";

exports.telegramWebhook = telegramWebhook;

// ===================================================================
// 🔒 SECURITY FIX #1: Безопасная проверка Google URL
// ===================================================================
function isValidGoogleURL(url: string): boolean {
    try {
        const parsed = new URL(url);
        const hostname = parsed.hostname.toLowerCase();

        // Проверяем ТОЧНЫЙ домен (не просто substring!)
        const validDomains = [
            'googleusercontent.com',
            'lh3.googleusercontent.com',
            'lh4.googleusercontent.com',
            'lh5.googleusercontent.com',
            'lh6.googleusercontent.com'
        ];

        // Домен должен ТОЧНО совпадать или быть поддоменом *.googleusercontent.com
        return validDomains.includes(hostname) ||
               hostname.endsWith('.googleusercontent.com');

    } catch (e) {
        // Невалидный URL
        return false;
    }
}

// ===================================================================
// 🔒 SECURITY FIX #2: Функция для безопасного jitter (геокодинг)
// ===================================================================
function secureJitter(value: number, range: number): number {
    const buffer = crypto.randomBytes(4);
    const randomInt = buffer.readUInt32BE(0);
    const randomFloat = (randomInt / 0xFFFFFFFF) - 0.5; // От -0.5 до +0.5
    return value + (randomFloat * range);
}

// ===================================================================
// 🔒 SECURITY FIX #3: Глобальный Rate Limiter
// ===================================================================
async function checkGlobalRateLimit(
    uid: string,
    action: string,
    limit: number,
    windowMs: number
): Promise<void> {
    const now = Date.now();
    const limitsRef = admin.firestore().collection('rate_limits').doc(uid);

    await admin.firestore().runTransaction(async (t) => {
        const doc = await t.get(limitsRef);
        const data = doc.data() || {};
        const actions = data[action] || [];

        // Удаляем записи старше окна
        const recentActions = actions.filter((timestamp: number) =>
            now - timestamp < windowMs
        );

        if (recentActions.length >= limit) {
            const waitTime = Math.ceil((recentActions[0] + windowMs - now) / 60000);
            throw new HttpsError(
                'resource-exhausted',
                `Слишком много попыток. Попробуйте через ${waitTime} мин.`
            );
        }

        // Добавляем новую запись
        recentActions.push(now);

        // Обновляем
        t.set(limitsRef, {
            [action]: recentActions,
            lastUpdate: FieldValue.serverTimestamp()
        }, { merge: true });
    });
}

// ===================================================================
// 🔒 SECURITY FIX #4: Исправленный getTelegramAuthCode
// ===================================================================
export const getTelegramAuthCode = onCall(async (request) => {
    if (!request.auth) throw new HttpsError('unauthenticated', 'Auth required.');
    const uid = request.auth.uid;

    // ✅ ИСПРАВЛЕНО: 128 бит энтропии вместо 24
    const code = "PM-" + crypto.randomBytes(16).toString('hex').toUpperCase();

    await db.collection('system').doc('telegram_codes').collection('active_codes').doc(code).set({
        uid: uid,
        createdAt: FieldValue.serverTimestamp(),
        expiresAt: Date.now() + 5 * 60 * 1000,
        used: false // 🔒 Флаг одноразового использования
    });

    return { code };
});

if (!admin.apps.length) {
    admin.initializeApp();
}
const db = admin.firestore();

const ALLOWED_ORIGINS = ["http://localhost:5173", "https://proto-map.vercel.app"];

const handleCors = (request: any, response: any): boolean => {
    const origin = request.headers.origin as string;
    if (ALLOWED_ORIGINS.includes(origin)) {
        response.set('Access-Control-Allow-Origin', origin);
    }
    if (request.method === 'OPTIONS') {
        response.set('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
        response.set('Access-Control-Allow-Headers', 'Content-Type, Authorization, x-firebase-appcheck');
        response.status(204).send('');
        return true;
    }
    return false;
};

const CASINO_CHAT_ID = "-1002885386686";
const CASINO_TOPIC_ID = 2661;

async function sendToCasinoChat(message: string) {
    const botToken = process.env.TELEGRAM_BOT_TOKEN;
    if (!botToken || !CASINO_CHAT_ID) return;

    try {
        const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
        await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                chat_id: CASINO_CHAT_ID,
                message_thread_id: CASINO_TOPIC_ID,
                text: message,
                parse_mode: 'Markdown'
            })
        });
    } catch (e) {
        console.error("Ошибка отправки в Telegram:", e);
    }
}

export const sendPrivateChatNotification = onCall(async (request) => {
    if (!request.auth) throw new HttpsError('unauthenticated', 'Auth required.');
    const uid = request.auth.uid;
    const { recipientUid, chatId, senderName, messageText, messageType } = request.data;

    if (!recipientUid || !chatId || !senderName) {
        throw new HttpsError('invalid-argument', 'Missing required fields.');
    }

    if (uid === recipientUid) return { status: 'skipped' };

    try {
        const recipientDoc = await db.collection('users').doc(recipientUid).get();
        if (!recipientDoc.exists) throw new HttpsError('not-found', 'Recipient not found.');

        const recipientData = recipientDoc.data()!;
        const fcmToken = recipientData.fcmToken;

        if (!fcmToken) {
            return { status: 'no_token' };
        }

        let bodyText: string;
        switch (messageType?.toUpperCase()) {
            case 'IMAGE':
                bodyText = '📷 Фото';
                break;
            case 'VOICE':
                bodyText = '🎤 Голосовое сообщение';
                break;
            case 'STICKER':
                bodyText = '😊 Стикер';
                break;
            default:
                bodyText = messageText?.substring(0, 100) || 'Новое сообщение';
        }

        const message = {
            token: fcmToken,
            notification: {
                title: senderName,
                body: bodyText,
            },
            data: {
                chatId: chatId,
                partnerUid: uid,
                type: 'private_message',
            },
            android: {
                priority: 'high' as const,
                notification: {
                    channelId: 'protomap_chat_channel',
                    priority: 'high' as const,
                    defaultSound: true,
                    defaultVibrateTimings: true,
                },
            },
            apns: {
                payload: {
                    aps: {
                        sound: 'default',
                        badge: 1,
                    },
                },
            },
        };

        await getMessaging().send(message);
        return { status: 'sent' };

    } catch (e: any) {
        if (e.code === 'messaging/registration-token-not-registered' ||
            e.code === 'messaging/invalid-registration-token') {
            await db.collection('users').doc(recipientUid).update({ fcmToken: null });
            return { status: 'token_cleaned' };
        }
        console.error('[FCM] Error sending notification:', e);
        throw new HttpsError('internal', 'Failed to send notification.');
    }
});

// ===================================================================
// 🔒 SECURITY FIX #5: Исправленный migrateExternalAvatar
// ===================================================================
export const migrateExternalAvatar = onCall(async (request) => {
    if (!request.auth) throw new HttpsError('unauthenticated', 'Auth required.');
    const uid = request.auth.uid;
    const { url } = request.data;

    // ✅ ИСПРАВЛЕНО: Безопасная проверка URL
    if (!url || !isValidGoogleURL(url)) {
        throw new HttpsError('invalid-argument', 'Invalid or untrusted URL');
    }

    try {
        // Очищаем URL от параметров размера Google (=s96-c)
        const cleanUrl = url.split('=')[0];

        // Загружаем в Cloudinary
        const result = await cloudinary.uploader.upload(cleanUrl, {
            folder: "protomap_avatars",
            public_id: uid,
            overwrite: true,
            format: "webp",
            // 🔒 ДОПОЛНИТЕЛЬНАЯ ЗАЩИТА:
            resource_type: 'image', // Только изображения!
            allowed_formats: ['jpg', 'jpeg', 'png', 'gif', 'webp']
        });

        // Обновляем профиль в Firestore
        await db.collection('users').doc(uid).update({ avatar_url: result.secure_url });
        await clearMapCache();

        return { status: 'success', newUrl: result.secure_url };
    } catch (e) {
        console.error("Migration failed:", e);
        return { status: 'error' };
    }
});

// ===================================================================
// 🔒 SECURITY FIX #6: Исправленный clearMapCache с транзакцией
// ===================================================================
async function clearMapCache() {
    const cacheRef = db.collection('system').doc('map_cache');

    try {
        // ✅ ИСПРАВЛЕНО: Атомарная транзакция вместо race condition
        await db.runTransaction(async (t) => {
            const doc = await t.get(cacheRef);

            if (doc.exists) {
                const data = doc.data();
                const lastUpdated = data?.updatedAt?.toMillis() || 0;

                // ЗАЩИТА: Проверка внутри транзакции
                if (Date.now() - lastUpdated < 60000) {
                    throw new Error('THROTTLED'); // Откатится автоматически
                }
            }

            // Удаление в рамках той же транзакции
            t.delete(cacheRef);
        });

        console.log("Map cache cleared.");

    } catch (e: any) {
        if (e.message === 'THROTTLED') {
            console.log("Cache clear throttled (safe).");
        } else {
            console.error("Failed to clear cache:", e);
        }
    }
}

async function assertNotBanned(request: any) {
    if (request.auth?.token?.banned === true) {
        console.warn(`Block by Token Claim: ${request.auth.uid}`);
        throw new HttpsError('permission-denied', 'Account banned (Token).');
    }

    const uid = request.auth?.uid;
    if (uid) {
        const userRef = admin.firestore().collection('users').doc(uid);
        const userSnap = await userRef.get();
        if (userSnap.exists && userSnap.data()?.isBanned) {
             console.warn(`Block by DB Check: ${uid}`);
             throw new HttpsError('permission-denied', 'Account banned (DB).');
        }
    }
}

function assertEmailVerified(auth: any) {
    if (!auth.token.email_verified) {
        throw new HttpsError('permission-denied', 'Требуется подтверждение почты (Email Verification).');
    }
}

export const sendMessage = onCall(async (request) => {
    if (request.app == undefined) {
        throw new HttpsError('failed-precondition', 'The function must be called from an App Check verified app.');
    }
    if (!request.auth) throw new HttpsError('unauthenticated', 'Доступ запрещен.');

    const uid = request.auth.uid;
    await assertNotBanned(request);
    assertEmailVerified(request.auth);

    const { text, replyTo, lang } = request.data as any;
    const messageLang = (lang === 'en' || lang === 'ru') ? lang : 'ru';

    if (!text || typeof text !== 'string' || text.trim().length === 0) {
        throw new HttpsError('invalid-argument', 'Сообщение не может быть пустым.');
    }

    let cleanText = text;
    cleanText = cleanText.replace(/[\u0300-\u036f\u20d0-\u20ff\ufe20-\ufe2f]/g, '');
    cleanText = cleanText.replace(/[\u200B-\u200D\uFEFF\u00AD]/g, '');
    cleanText = cleanText.trim().replace(/(\r\n|\n|\r){3,}/g, '\n\n');

    if (cleanText.length === 0) throw new HttpsError('invalid-argument', 'Сообщение не содержит допустимых символов.');
    if (cleanText.length > 1000) throw new HttpsError('invalid-argument', 'Слишком длинное сообщение.');

    const sanitizedText = cleanText;
    const userRef = db.collection('users').doc(uid);

    try {
        await db.runTransaction(async (t) => {
            const userDoc = await t.get(userRef);
            if (!userDoc.exists) throw new HttpsError('not-found', 'Профиль не найден.');
            const userData = userDoc.data()!;

            if (userData.isBanned) throw new HttpsError('permission-denied', 'Вы заблокированы.');

            const lastMessageTime = userData.last_chat_message;
            if (lastMessageTime && Date.now() - lastMessageTime.toDate().getTime() < 3000) {
                throw new HttpsError('resource-exhausted', 'Слишком часто. Охладите трахание.');
            }

            const newMessage: any = {
                text: sanitizedText,
                lang: messageLang,
                author_uid: uid,
                author_username: userData.username,
                author_avatar_url: userData.avatar_url || '',
                createdAt: admin.firestore.FieldValue.serverTimestamp(),
                author_equipped_frame: userData.equipped_frame || null,
                image: false,
                voiceMessage: false
            };

            if (replyTo) {
                newMessage.replyTo = { author_username: replyTo.author_username, text: replyTo.text };
                if (replyTo.text === '[Изображение]') newMessage.replyToImage = true;
                if (replyTo.text === '[Голосовое сообщение]') newMessage.replyToVoiceMessage = true;
            }

            const chatRef = db.collection('global_chat').doc();
            t.set(chatRef, newMessage);
            t.update(userRef, { last_chat_message: admin.firestore.FieldValue.serverTimestamp() });
        });
        return { status: 'success' };
    } catch (error: any) {
        if (error instanceof HttpsError) throw error;
        throw new HttpsError('internal', 'Ошибка сервера.');
    }
});

export const deleteComment = onCall(async (request) => {
    if (request.app == undefined) {
        throw new HttpsError('failed-precondition', 'The function must be called from an App Check verified app.');
    }
    if (!request.auth) throw new HttpsError('unauthenticated', 'Необходима авторизация.');

    const uid = request.auth.uid;
    await assertNotBanned(request);

    const { profileUid, commentId } = request.data;

    try {
        const commentRef = db.collection('users').doc(profileUid).collection('comments').doc(commentId);
        const commentDoc = await commentRef.get();

        if (!commentDoc.exists) throw new HttpsError('not-found', 'Комментарий не найден.');

        const commentData = commentDoc.data()!;
        if (commentData.author_uid !== uid && profileUid !== uid) {
            throw new HttpsError('permission-denied', 'Нет прав на удаление.');
        }

        await commentRef.delete();
        return { status: 'success', message: 'Комментарий удален.' };
    } catch (error: any) {
        if (error instanceof HttpsError) throw error;
        throw new HttpsError('internal', 'Ошибка сервера.');
    }
});

export const addComment = onCall(async (request) => {
    if (request.app == undefined) throw new HttpsError('failed-precondition', 'App Check required.');
    if (!request.auth) throw new HttpsError('unauthenticated', 'Auth required.');

    const uid = request.auth.uid;
    await assertNotBanned(request); // ✅ [ЭТАП 1] Исправлен баг: передаём request, а не uid
    assertEmailVerified(request.auth);

    const { profileUid, text, parentId } = request.data;

    if (!profileUid || !text || typeof text !== 'string' || !text.trim()) {
        throw new HttpsError('invalid-argument', 'Пустое сообщение.');
    }
    if (text.length > 1000) throw new HttpsError('invalid-argument', 'Слишком длинно.');

    const authorRef = db.collection('users').doc(uid);
    const profileRef = db.collection('users').doc(profileUid);

    try {
        const authorDoc = await authorRef.get();
        if (!authorDoc.exists) throw new HttpsError('not-found', 'User not found.');
        const authorData = authorDoc.data()!;

        const commentData: any = {
            text: text.trim(),
            author_uid: uid,
            author_username: authorData.username,
            author_avatar_url: authorData.avatar_url || '',
            author_equipped_frame: authorData.equipped_frame || null,
            createdAt: FieldValue.serverTimestamp(),
            likes: []
        };

        if (parentId) {
            commentData.parentId = parentId;
        }

        await profileRef.collection('comments').add(commentData);

        return { status: 'success', message: 'Сигнал отправлен!' };
    } catch (error: any) {
        if (error instanceof HttpsError) throw error;
        throw new HttpsError('internal', error.message);
    }
});

export const toggleCommentLike = onCall(async (request) => {
    if (request.app == undefined) throw new HttpsError('failed-precondition', 'App Check required.');
    if (!request.auth) throw new HttpsError('unauthenticated', 'Auth required.');

    const uid = request.auth.uid;
    await assertNotBanned(uid);

    const { profileUid, commentId } = request.data;
    const commentRef = db.collection('users').doc(profileUid).collection('comments').doc(commentId);

    try {
        await db.runTransaction(async (t) => {
            const doc = await t.get(commentRef);
            if (!doc.exists) throw new HttpsError('not-found', 'Comment not found');

            const data = doc.data()!;
            const likes = data.likes || [];

            if (likes.includes(uid)) {
                t.update(commentRef, { likes: FieldValue.arrayRemove(uid) });
            } else {
                t.update(commentRef, { likes: FieldValue.arrayUnion(uid) });
            }
        });
        return { status: 'success' };
    } catch (e: any) {
        throw new HttpsError('internal', 'Like error');
    }
});

export const checkUsername = onRequest({ cors: false }, async (request, response) => {
    if (handleCors(request, response)) return;
    if (request.method !== "POST") {
        response.status(405).send("Method Not Allowed");
        return;
    }

    const username = request.body.data.username;
    if (!username || typeof username !== "string" || username.length < 4) {
        response.status(400).json({ error: { message: "Имя слишком короткое" } });
        return;
    }

    const lowerName = username.toLowerCase();
    const forbiddenWords = ['admin', 'moderator', 'system', 'root', 'support', 'protomap', 'owner', 'dev', 'bot'];
    if (forbiddenWords.some(word => lowerName.includes(word))) {
         response.status(200).json({ data: { isAvailable: false, message: "Имя зарезервировано." } });
         return;
    }

    try {
        const snapshot = await db.collection("users").where("username", "==", username).limit(1).get();
        response.status(200).json({ data: { isAvailable: snapshot.empty } });
    } catch (error) {
        response.status(500).json({ error: { message: "Internal server error" } });
    }
});

export const updateEquippedItems = onCall({ cors: ALLOWED_ORIGINS }, async (request) => {
    if (request.app == undefined) {
        throw new HttpsError('failed-precondition', 'The function must be called from an App Check verified app.');
    }
    if (!request.auth) throw new HttpsError('unauthenticated', 'Auth required.');

    const uid = request.auth.uid;
    await assertNotBanned(request);
    assertEmailVerified(request.auth);

    const { equipped_frame, equipped_bg } = request.data;
    const userRef = db.collection('users').doc(uid);

    try {
        const userDoc = await userRef.get();
        if (!userDoc.exists) throw new HttpsError('not-found', 'User not found.');
        const userData = userDoc.data() as any;

        const updates: any = {};

        if (equipped_frame !== undefined) {
            if (equipped_frame !== null && !userData.owned_items?.includes(equipped_frame)) {
                throw new HttpsError('permission-denied', 'Нет прав на эту рамку.');
            }
            updates.equipped_frame = equipped_frame;
        }

        if (equipped_bg !== undefined) {
            if (equipped_bg !== null && !userData.owned_items?.includes(equipped_bg)) {
                throw new HttpsError('permission-denied', 'Нет прав на этот фон.');
            }
            updates.equipped_bg = equipped_bg;
        }

        if (Object.keys(updates).length > 0) {
            await userRef.update(updates);
            await clearMapCache();
        }

        return { data: { status: 'success', message: 'Стиль обновлен!' } };
    } catch (error: any) {
        if (error.code) throw error;
        throw new HttpsError('internal', 'Error saving items.');
    }
});

export const purchaseShopItem = onCall({ cors: ALLOWED_ORIGINS }, async (request) => {
    if (request.app == undefined) {
        throw new HttpsError('failed-precondition', 'The function must be called from an App Check verified app.');
    }
    if (!request.auth) throw new HttpsError('unauthenticated', 'Auth required.');

    const uid = request.auth.uid;
    await assertNotBanned(request);
    assertEmailVerified(request.auth);

    const { itemId } = request.data;
    const userRef = db.collection('users').doc(uid);
    const itemRef = db.collection('shop_items').doc(itemId);

    try {
        await db.runTransaction(async (t) => {
            const userDoc = await t.get(userRef);
            const itemDoc = await t.get(itemRef);

            if (!userDoc.exists || !itemDoc.exists) throw new HttpsError('not-found', 'Data not found.');

            const userData = userDoc.data() as any;
            const itemData = itemDoc.data() as any;
            const price = itemData.price || 999999;

            if (userData.owned_items?.includes(itemId)) throw new HttpsError('already-exists', 'Уже куплено.');
            if ((userData.casino_credits || 0) < price) throw new HttpsError('failed-precondition', 'Недостаточно средств.');

            t.update(userRef, {
                casino_credits: userData.casino_credits - price,
                owned_items: FieldValue.arrayUnion(itemId)
            });
        });
        return { data: { status: 'success', message: 'Покупка совершена!' } };
    } catch (error: any) {
        if (error.code) throw error;
        throw new HttpsError('internal', 'Transaction failed.');
    }
});

function getRewardValue(day: number): number {
    if (day === 30) return 1000;
    if (day % 5 === 0) return 250;
    return 50 + (Math.floor((day - 1) / 5) * 10);
}

export const getDailyBonus = onCall(async (request) => {
    if (request.app == undefined) {
        throw new HttpsError('failed-precondition', 'The function must be called from an App Check verified app.');
    }
    if (!request.auth) throw new HttpsError('unauthenticated', 'Auth required.');

    const uid = request.auth.uid;
    await assertNotBanned(request);
    assertEmailVerified(request.auth);

    const userRef = db.collection('users').doc(uid);

    try {
        const result = await db.runTransaction(async (t) => {
            const userDoc = await t.get(userRef);
            if (!userDoc.exists) throw new HttpsError('not-found', 'User not found.');

            const data = userDoc.data() as any;
            const lastBonus = data.last_daily_bonus ? data.last_daily_bonus.toDate() : null;
            let currentStreak = data.daily_streak || 0;

            const now = new Date();

            if (currentStreak >= 30) {
                currentStreak = 0;
            }

            if (lastBonus) {
                const diff = now.getTime() - lastBonus.getTime();

                if (diff < 20 * 60 * 60 * 1000) {
                    const hoursLeft = Math.ceil((20 * 60 * 60 * 1000 - diff) / 3600000);
                    throw new HttpsError('resource-exhausted', `Бонус доступен через ${hoursLeft} ч.`);
                }

                if (diff > 48 * 60 * 60 * 1000) {
                    currentStreak = 0;
                }
            }

            const dayToClaim = currentStreak + 1;
            const bonusAmount = getRewardValue(dayToClaim);
            let rewardMessage = `День ${dayToClaim}: получено ${bonusAmount} PC.`;
            let specialReward = null;

            if (dayToClaim === 30) {
                if (!data.owned_items?.includes('frame_ludoman')) {
                    specialReward = 'frame_ludoman';
                    t.update(userRef, {
                        owned_items: FieldValue.arrayUnion('frame_ludoman')
                    });
                    rewardMessage = "🎉 ЦИКЛ ЗАВЕРШЕН! ВЫ ПОЛУЧИЛИ РАМКУ И 1000 PC!";
                } else {
                    rewardMessage = "🎉 ЦИКЛ ЗАВЕРШЕН! МАКСИМАЛЬНАЯ НАГРАДА!";
                }
            }

            const newBalance = (data.casino_credits ?? 100) + bonusAmount;

            t.update(userRef, {
                casino_credits: newBalance,
                last_daily_bonus: FieldValue.serverTimestamp(),
                daily_streak: dayToClaim
            });

            return {
                status: 'success',
                message: rewardMessage,
                new_balance: newBalance,
                streak: dayToClaim,
                special_reward: specialReward
            };
        });

        return { data: result };
    } catch (error: any) {
        if (error instanceof HttpsError) throw error;
        if (error.code === 'resource-exhausted') throw error;
        throw new HttpsError('internal', 'Bonus error.');
    }
});

export const startCrashGame = onCall({ timeoutSeconds: 300 }, async (request) => {
    if (request.app == undefined) throw new HttpsError('failed-precondition', 'App Check required.');
    if (!request.auth) throw new HttpsError('unauthenticated', 'Auth required.');

    const uid = request.auth.uid;
    await assertNotBanned(uid);
    assertEmailVerified(request.auth);

    // ✅ НОВОЕ: Глобальный лимит (50 игр в час)
    await checkGlobalRateLimit(uid, 'crash', 50, 60 * 60 * 1000);

    let { bet } = request.data;
    bet = Math.floor(Number(bet));
    const MAX_BET = 1000;

    if (typeof bet !== 'number' || bet <= 0) throw new HttpsError('invalid-argument', 'Invalid bet.');
    if (bet > MAX_BET) throw new HttpsError('invalid-argument', `Max bet is ${MAX_BET}.`);

    const userRef = db.collection('users').doc(uid);
    const bankRef = db.collection('system').doc('casino_stats');
    const gameId = db.collection('crash_games').doc().id;

    const rtdb = admin.app().database("https://protomap-1e1db-default-rtdb.europe-west1.firebasedatabase.app");
    const gameRtdbRef = rtdb.ref(`crash_games/${gameId}`);

    try {
        let crashPoint = 1.00;

        const riskRoll = crypto.randomInt(0, 100);
        if (riskRoll < 6) {
            crashPoint = 1.00;
        } else {
            const buffer = crypto.randomBytes(4);
            const randomInt = buffer.readUInt32BE(0);
            const randomFloat = randomInt / 0xFFFFFFFF;
            crashPoint = Math.floor((0.94 / (1 - randomFloat)) * 100) / 100;
        }

        await db.runTransaction(async (t) => {
            const userDoc = await t.get(userRef);
            const bankDoc = await t.get(bankRef);

            if (!userDoc.exists) throw new HttpsError('not-found', 'User not found.');
            const userData = userDoc.data()!;

            let bankBalance = bankDoc.exists ? (bankDoc.data()?.bank_balance || 0) : 0;
            const safeBankLimit = bankBalance * 0.9;

            let maxAffordableMult = 1.0;
            if (bet > 0) {
                maxAffordableMult = safeBankLimit / bet;
            }

            if (crashPoint > maxAffordableMult) {
                console.log(`[CRASH] Capping multiplier for ${uid}. Org: ${crashPoint}, Capped: ${maxAffordableMult}`);
                crashPoint = Math.floor(maxAffordableMult * 100) / 100;

                if (crashPoint < 1.01) crashPoint = 1.00;
            }

            if (crashPoint > 50) crashPoint = 50;

            const lastPlayed = userData.last_crash_game ? userData.last_crash_game.toDate().getTime() : 0;
            if (Date.now() - lastPlayed < 5000) {
                 throw new HttpsError('resource-exhausted', 'Cooldown.');
            }
            if ((userData.casino_credits || 0) < bet) {
                throw new Error("No money");
            }

            t.update(userRef, {
                casino_credits: FieldValue.increment(-bet),
                last_crash_game: FieldValue.serverTimestamp()
            });

            t.set(bankRef, { bank_balance: bankBalance + bet }, { merge: true });

            t.set(db.collection('crash_games').doc(gameId), {
                uid, bet, crashPoint,
                status: 'active',
                createdAt: FieldValue.serverTimestamp(),
                expireAt: admin.firestore.Timestamp.fromMillis(Date.now() + 3600000)
            });
        });

        await gameRtdbRef.set({
            m: 1.00,
            s: 'run',
            uid: uid
        });

        runGameLoopRTDB(gameId, crashPoint);

        const easterEgg = Buffer.from("Hello Kuraga! Rate limited and verified. Good luck! 🚀").toString('base64');

        return {
            data: {
                gameId,
                debug_token: easterEgg
            }
        };

    } catch (e: any) {
        if (e.message === "No money") {
             throw new HttpsError('failed-precondition', 'Недостаточно средств.');
        }
        if (e.code === 'resource-exhausted') {
            throw e;
        }
        console.error("Internal Game Error", e);
        throw new HttpsError('internal', e.message);
    }
});

async function runGameLoopRTDB(gameId: string, crashPoint: number) {
    const rtdb = admin.app().database("https://protomap-1e1db-default-rtdb.europe-west1.firebasedatabase.app");
    const gameRef = rtdb.ref(`crash_games/${gameId}`);

    const fsGameRef = db.collection('crash_games').doc(gameId);

    const startTime = Date.now();
    let current = 1.00;

    const interval = setInterval(async () => {
        const t = (Date.now() - startTime) / 1000;
        current = Math.exp(0.08 * t);
        if (current >= crashPoint) {
            clearInterval(interval);

            await gameRef.update({ m: crashPoint, s: 'bang' });

            await fsGameRef.update({ status: 'crashed', finalMultiplier: crashPoint });

            setTimeout(() => gameRef.remove(), 5000);
        } else {
            gameRef.update({ m: parseFloat(current.toFixed(2)) });
        }
    }, 200);
}

export const cashOutCrashGame = onCall(async (request) => {
    if (request.app == undefined) throw new HttpsError('failed-precondition', 'App Check.');
    if (!request.auth) throw new HttpsError('unauthenticated', 'Auth.');
    const uid = request.auth.uid;
    const { gameId, multiplier } = request.data;

    const gameRef = db.collection('crash_games').doc(gameId);
    const userRef = db.collection('users').doc(uid);
    const bankRef = db.collection('system').doc('casino_stats');
    const rtdbRef = admin.app().database("https://protomap-1e1db-default-rtdb.europe-west1.firebasedatabase.app").ref(`crash_games/${gameId}`);

    try {
        const result = await db.runTransaction(async (t) => {
            const gameDoc = await t.get(gameRef);
            const bankDoc = await t.get(bankRef);

            if (!gameDoc.exists) throw new Error('Game expired');
            const data = gameDoc.data()!;

            if (data.status !== 'active') throw new Error('Too late');
            if (multiplier > data.crashPoint) throw new Error('Cheating detected');

            const winAmount = Math.floor(data.bet * multiplier);

            t.update(userRef, { casino_credits: FieldValue.increment(winAmount) });

            t.update(gameRef, { status: 'cashed_out', winAmount, cashOutAt: multiplier });

            const currentBank = bankDoc.exists ? (bankDoc.data()?.bank_balance || 0) : 0;
            t.set(bankRef, { bank_balance: currentBank - winAmount }, { merge: true });

            return { winAmount };
        });
        await rtdbRef.update({ s: 'done', m: multiplier });

        return { data: result };
    } catch (e: any) {
        throw new HttpsError('internal', e.message);
    }
});

export const synthesizeArtifact = onCall(async (request) => {
    if (request.app == undefined) throw new HttpsError('failed-precondition', 'App Check required.');
    if (!request.auth) throw new HttpsError('unauthenticated', 'Auth required.');

    const uid = request.auth.uid;
    await assertNotBanned(uid);
    assertEmailVerified(request.auth);

    const userRef = db.collection('users').doc(uid);
    const BASE_VALUE = 100;

    try {
        const result = await db.runTransaction(async (t) => {
            const userDoc = await t.get(userRef);
            if (!userDoc.exists) throw new HttpsError('not-found', 'User not found.');

            const userData = userDoc.data()!;
            if (userData.isBanned) throw new HttpsError('permission-denied', 'Banned.');

            const currentShards = userData.glitch_shards || 0;

            if (currentShards < 10) {
                throw new HttpsError('failed-precondition', 'Нужно 10 осколков для синтеза.');
            }

            const runePool = [
                { id: 'toast',        weight: 25, type: 'flat', val: 150 },
                { id: 'rubber_duck',  weight: 25, type: 'flat', val: 200 },
                { id: 'ram_stick',    weight: 20, type: 'flat', val: 300 },
                { id: 'energy_drink', weight: 15, type: 'mult', val: 2 },
                { id: 'gpu_fan',      weight: 10, type: 'mult', val: 3 },
                { id: 'rtx_card',     weight: 5,  type: 'mult', val: 4 },
                { id: 'source_code',  weight: 3,  type: 'mult', val: 5 },
                { id: 'banhammer',    weight: 3,  type: 'flat', val: 666 },
                { id: 'bug',          weight: 8,  type: 'flat', val: -100 },
                { id: '404_error',    weight: 6,  type: 'flat', val: -200 },
                { id: 'spaghetti',    weight: 5,  type: 'bad',  val: 0.5 },
                { id: 'blue_screen',  weight: 4,  type: 'bad',  val: 0.5 },
                { id: 'ransomware',   weight: 2,  type: 'bad',  val: 0.3 },
                { id: 'orion_tear',   weight: 0.5, type: 'super', val: 10 },
                { id: 'admin_key',    weight: 0.1, type: 'super', val: 20 }
            ];

            // ✅ ИСПРАВЛЕНО: Криптографически безопасный выбор
            const getRandomRune = () => {
                const totalWeight = runePool.reduce((sum, item) => sum + item.weight, 0);

                const buffer = crypto.randomBytes(4);
                const randomInt = buffer.readUInt32BE(0);
                let random = (randomInt / 0xFFFFFFFF) * totalWeight;

                for (const rune of runePool) {
                    if (random < rune.weight) return rune;
                    random -= rune.weight;
                }
                return runePool[0];
            };

            const runes = [getRandomRune(), getRandomRune(), getRandomRune()];

            let totalWin = BASE_VALUE;

            runes.forEach(r => { if (r.type === 'mult') totalWin += (BASE_VALUE * (r.val - 1)); });
            runes.forEach(r => { if (r.type === 'flat') totalWin += r.val; });
            runes.forEach(r => {
                if (r.type === 'bad') totalWin = Math.floor(totalWin * r.val);
                if (r.type === 'super') totalWin = Math.floor(totalWin * r.val);
            });

            if (totalWin < 50) totalWin = 50;

            const newBalance = (userData.casino_credits || 0) + totalWin;

            t.update(userRef, {
                glitch_shards: 0,
                casino_credits: newBalance,
                last_bonus_game: FieldValue.serverTimestamp()
            });

            return {
                runes: runes.map(r => r.id),
                totalWin: totalWin,
                newBalance: newBalance
            };
        });

        return { data: result };

    } catch (e: any) {
        throw e instanceof HttpsError ? e : new HttpsError('internal', e.message);
    }
});

interface UserData {
    username?: string;
    casino_credits?: number;
    glitch_shards?: number;
    isBanned?: boolean;
    last_game_played?: admin.firestore.Timestamp;
}

interface CasinoStats {
    bank_balance: number;
}

// ===================================================================
// 🎰 УЛУЧШЕННАЯ СИСТЕМА АРТЕФАКТОВ
// ===================================================================
export const playSlotMachine = onCall(
    { secrets: ["TELEGRAM_BOT_TOKEN"] },
    async (request) => {
        if (request.app == undefined) throw new HttpsError('failed-precondition', 'App Check required.');
        if (!request.auth) throw new HttpsError('unauthenticated', 'Auth required.');

        const uid = request.auth.uid;
        await assertNotBanned(uid);

        // Глобальный лимит (100 игр в час)
        await checkGlobalRateLimit(uid, 'slots', 100, 60 * 60 * 1000);

        let { bet } = request.data;
        bet = Math.floor(Number(bet));
        const MAX_BET = 1000;
        const MIN_BET = 10;

        if (typeof bet !== 'number' || bet <= 0) throw new HttpsError('invalid-argument', 'Invalid bet.');
        if (bet < MIN_BET) {
            throw new HttpsError('invalid-argument', `⛔ ERROR_CODE: MORO_DETECTED.\nСистема не принимает микро-ставки.\nМинимум: ${MIN_BET} PC.`);
        }

        if (bet > MAX_BET) throw new HttpsError('invalid-argument', `Max bet is ${MAX_BET}.`);

        const userRef = db.collection('users').doc(uid);
        const bankRef = db.collection('system').doc('casino_stats');

        try {
            const result = await db.runTransaction(async (t) => {
                const userDoc = await t.get(userRef);
                const bankDoc = await t.get(bankRef);

                if (!userDoc.exists) throw new HttpsError('not-found', 'User not found.');

                const data = userDoc.data() as UserData;
                const username = data.username || "Unknown";
                const credits = data.casino_credits ?? 100;
                let currentShards = data.glitch_shards || 0;
                const MAX_SHARDS = 10;

                const lastPlayed = data.last_game_played ? data.last_game_played.toDate().getTime() : 0;
                const now = Date.now();
                if (now - lastPlayed < 3000) {
                    throw new HttpsError('resource-exhausted', 'Слишком быстро.');
                }

                let bankBalance = bankDoc.exists ? (bankDoc.data() as CasinoStats)?.bank_balance || 0 : 0;

                if (credits < bet) throw new HttpsError('failed-precondition', 'Недостаточно средств.');

                // ===================================================================
                // 🎲 ГЕНЕРАЦИЯ РЕЗУЛЬТАТА
                // ===================================================================
                const roll = crypto.randomInt(0, 100000);
                let resultType = 'LOSS';

                if (roll < 100) resultType = 'JACKPOT';           // 0.1%
                else if (roll < 1100) resultType = 'GLITCH';      // 1%
                else if (roll < 2600) resultType = 'HEART';       // 1.5%
                else if (roll < 8100) resultType = 'RAM';         // 5.5%
                else if (roll < 27600) resultType = 'PAW';        // 19.5%
                else resultType = 'LOSS';                         // 72.4%

                let winMultiplier = 0;

                if (resultType === 'JACKPOT') winMultiplier = 100;
                else if (resultType === 'HEART') winMultiplier = 10;
                else if (resultType === 'RAM') winMultiplier = 5;
                else if (resultType === 'PAW') winMultiplier = 2;

                let potentialWin = Math.floor(bet * winMultiplier);
                const safeBankLimit = bankBalance * 0.9;

                // ===================================================================
                // 🏦 ЗАЩИТА БАНКА (downgrade wins если банк низкий)
                // ===================================================================
                if (potentialWin > 0 && potentialWin > safeBankLimit) {
                    console.log(`[BANK] Downgrade ${uid}: ${potentialWin} > ${safeBankLimit}`);

                    if (resultType === 'JACKPOT') {
                         resultType = 'HEART'; winMultiplier = 10; potentialWin = Math.floor(bet * 10);
                    }
                    if (potentialWin > safeBankLimit && winMultiplier > 5) {
                        resultType = 'RAM'; winMultiplier = 5; potentialWin = Math.floor(bet * 5);
                    }
                    if (potentialWin > safeBankLimit && winMultiplier > 2) {
                        resultType = 'PAW'; winMultiplier = 2; potentialWin = Math.floor(bet * 2);
                    }
                    if (potentialWin > safeBankLimit) {
                        resultType = 'LOSS'; winMultiplier = 0; potentialWin = 0;
                    }
                }

                let finalReels: string[] = [];
                let shardsToAdd = 0;
                let txNotification: string | null = null;

                const safeSymbols = ['paw', 'ram', 'heart', 'protomap_logo'];

                // ===================================================================
                // 🎨 ФОРМИРОВАНИЕ БАРАБАНОВ
                // ===================================================================
                switch (resultType) {
                    case 'JACKPOT':
                        finalReels = ['protomap_logo', 'protomap_logo', 'protomap_logo'];
                        txNotification = `🚨 *JACKPOT ALERT!* 🚨\n\nИгрок *${username}* сорвал куш!\nВыигрыш: *${potentialWin} PC* 💎`;
                        break;

                    case 'GLITCH':
                        finalReels = ['glitch-6', 'glitch-6', 'glitch-6'];
                        shardsToAdd = 10; // Полный набор сразу!
                        break;

                    case 'HEART':
                        finalReels = ['heart', 'heart', 'heart'];
                        break;

                    case 'RAM':
                        finalReels = ['ram', 'ram', 'ram'];
                        break;

                    case 'PAW':
                        finalReels = ['paw', 'paw', 'paw'];
                        break;

                    case 'LOSS':
                        // ===================================================================
                        // 🔮 НОВАЯ СИСТЕМА ВЫПАДЕНИЯ ОСКОЛКОВ
                        // ===================================================================

                        // 🏦 РАСЧЁТ МОДИФИКАТОРА БАНКА
                        // Чем меньше денег в банке, тем меньше шанс на осколки
                        const BANK_THRESHOLD_HIGH = 50000;  // Полный шанс
                        const BANK_THRESHOLD_LOW = 10000;   // Минимальный шанс

                        let bankModifier = 1.0;
                        if (bankBalance < BANK_THRESHOLD_LOW) {
                            bankModifier = 0.3; // -70% шанса
                        } else if (bankBalance < BANK_THRESHOLD_HIGH) {
                            // Линейная интерполяция между 0.3 и 1.0
                            bankModifier = 0.3 + (0.7 * (bankBalance - BANK_THRESHOLD_LOW) / (BANK_THRESHOLD_HIGH - BANK_THRESHOLD_LOW));
                        }

                        // 📉 БАЗОВЫЙ ШАНС: 5% (вместо 12%)
                        const BASE_SHARD_CHANCE = 5.0;
                        const finalShardChance = BASE_SHARD_CHANCE * bankModifier;

                        const shardRoll = crypto.randomInt(0, 10000); // 0-9999
                        const shardThreshold = Math.floor(finalShardChance * 100); // 5% = 500

                        console.log(`[SHARDS] Bank: ${bankBalance}, Modifier: ${bankModifier.toFixed(2)}, Chance: ${finalShardChance.toFixed(2)}%`);

                        if (shardRoll < shardThreshold) {
                            // 🎁 ВЫПАЛ ОСКОЛОК!
                            shardsToAdd = 1; // Всегда только 1 осколок (не 2!)

                            // Создаём барабаны с 1 осколком
                            finalReels = [
                                safeSymbols[crypto.randomInt(0, 4)],
                                safeSymbols[crypto.randomInt(0, 4)],
                                safeSymbols[crypto.randomInt(0, 4)]
                            ];

                            // Ставим осколок на случайную позицию
                            const glitchPosition = crypto.randomInt(0, 3);
                            finalReels[glitchPosition] = 'glitch-6';

                            console.log(`[SHARDS] ✨ Shard dropped for ${uid}! (1/10)`);

                        } else {
                            // ❌ НЕ ВЫПАЛ - обычный проигрыш

                            // 30% шанс на "near miss" (почти выигрыш)
                            const nearMissRoll = crypto.randomInt(0, 100);
                            if (nearMissRoll < 30) {
                                const teaseSym = safeSymbols[crypto.randomInt(0, 4)];
                                const trashSym = safeSymbols.filter(s => s !== teaseSym)[crypto.randomInt(0, 3)];

                                finalReels = [teaseSym, teaseSym, trashSym]
                                    .map(v => ({ v, s: crypto.randomInt(0, 1000000) }))
                                    .sort((a, b) => a.s - b.s)
                                    .map(({ v }) => v);
                            } else {
                                // Полностью случайные символы
                                do {
                                    finalReels = [
                                        safeSymbols[crypto.randomInt(0, 4)],
                                        safeSymbols[crypto.randomInt(0, 4)],
                                        safeSymbols[crypto.randomInt(0, 4)]
                                    ];
                                } while (finalReels[0] === finalReels[1] && finalReels[1] === finalReels[2]);
                            }
                        }
                        break;
                }

                // ===================================================================
                // 💰 ОБНОВЛЕНИЕ БАЛАНСОВ
                // ===================================================================
                const finalCalc = credits - bet + potentialWin;
                let newBankBalance = bankBalance + bet - potentialWin;
                if (newBankBalance < 0) newBankBalance = 0;

                let newShards = currentShards + shardsToAdd;
                if (newShards > MAX_SHARDS) newShards = MAX_SHARDS;

                t.update(userRef, {
                    casino_credits: finalCalc,
                    last_game_played: admin.firestore.FieldValue.serverTimestamp(),
                    glitch_shards: newShards
                });

                t.set(bankRef, { bank_balance: newBankBalance }, { merge: true });

                console.log(`[SLOTS] ${uid} | Bet:${bet} | Win:${potentialWin} | Shards:+${shardsToAdd} (${newShards}/10) | Bank:${newBankBalance}`);

                return {
                    reels: finalReels,
                    winAmount: potentialWin,
                    newBalance: finalCalc,
                    shards: newShards,
                    shardsAdded: shardsToAdd,
                    notification: txNotification
                };
            });

            if ((result as any).notification) {
                sendToCasinoChat((result as any).notification).catch(console.error);
            }
            delete (result as any).notification;

            return { data: result };

        } catch (error: any) {
            console.error("[SLOTS ERROR]:", error);
            if (error.code) throw error;
            throw new HttpsError('internal', 'Game error.');
        }
    }
);

// ===================================================================
// 🔒 SECURITY FIX #8: Исправленный playCoinFlip
// ===================================================================
export const playCoinFlip = onCall(async (request) => {
    if (request.app == undefined) throw new HttpsError('failed-precondition', 'App Check required.');
    if (!request.auth) throw new HttpsError('unauthenticated', 'Auth required.');

    const uid = request.auth.uid;
    await assertNotBanned(uid);
    assertEmailVerified(request.auth);

    // ✅ НОВОЕ: Глобальный лимит (200 флипов в час)
    await checkGlobalRateLimit(uid, 'coinflip', 200, 60 * 60 * 1000);

    let { bet, choice } = request.data;
    bet = Math.floor(Number(bet));

    if (typeof bet !== 'number' || bet <= 0) throw new HttpsError('invalid-argument', 'Invalid bet.');

    const userRef = db.collection('users').doc(uid);
    const bankRef = db.collection('system').doc('casino_stats');

    try {
        const result = await db.runTransaction(async (t) => {
            const userDoc = await t.get(userRef);
            const bankDoc = await t.get(bankRef);

            if (!userDoc.exists) throw new HttpsError('not-found', 'User not found.');

            const data = userDoc.data() as any;
            const credits = data.casino_credits ?? 100;
            let bankBalance = bankDoc.exists ? (bankDoc.data()?.bank_balance || 0) : 0;

            if (credits < bet) throw new HttpsError('failed-precondition', 'Недостаточно средств.');

            const WIN_MULTIPLIER = 1.95;
            const potentialWin = Math.floor(bet * WIN_MULTIPLIER);
            const profit = potentialWin - bet;

            let forcedLoss = false;
            if (profit > (bankBalance * 0.9)) {
                console.log(`[COIN] Bank low (${bankBalance}). Forcing loss for bet ${bet}.`);
                forcedLoss = true;
            }

            // ✅ ИСПРАВЛЕНО: crypto.randomInt вместо Math.random()
            let outcome = crypto.randomInt(0, 2) === 0 ? 'heads' : 'tails';

            if (forcedLoss) {
                outcome = (choice === 'heads') ? 'tails' : 'heads';
            }

            const hasWon = choice === outcome;
            let finalBalance = credits - bet;
            let newBankBalance = bankBalance + bet;

            if (hasWon) {
                finalBalance += potentialWin;
                newBankBalance -= potentialWin;
            }

            t.update(userRef, { casino_credits: finalBalance });
            t.set(bankRef, { bank_balance: newBankBalance }, { merge: true });

            return {
                outcome,
                hasWon,
                newBalance: finalBalance,
                creditsChange: hasWon ? (potentialWin - bet) : -bet
            };
        });
        return { data: result };
    } catch (error: any) {
        if (error.code) throw error;
        throw new HttpsError('internal', 'Game error.');
    }
});

export const getLeaderboard = onCall(async (request) => {
    if (request.app == undefined) {
        throw new HttpsError('failed-precondition', 'The function must be called from an App Check verified app.');
    }
    if (!request.auth) throw new HttpsError('unauthenticated', 'Auth required.');

    const HIDDEN_UIDS = [
        'MPe5KwdlsJU4pPxCEBydmMGgGTw1',
        'XT2NDfkr9wUFl3d1Eh6imTEdlxt2'
    ];

    try {
        const snapshot = await db.collection('users')
            .orderBy('casino_credits', 'desc')
            .limit(15)
            .get();

        const leaderboard = snapshot.docs
            .map(doc => {
                const data = doc.data();
                return {
                    uid: doc.id,
                    username: data.username || 'Неизвестный',
                    avatar_url: data.avatar_url || '',
                    casino_credits: data.casino_credits || 0,
                    equipped_frame: data.equipped_frame || null
                };
            })
            .filter(user => !HIDDEN_UIDS.includes(user.uid))
            .slice(0, 10);

        return { data: leaderboard };

    } catch (error) {
        console.error("Leaderboard error:", error);
        throw new HttpsError('internal', 'Не удалось загрузить списки лидеров.');
    }
});

// ===================================================================
// 🔒 SECURITY FIX #9: Исправленный getDistrictCenterCoords
// ===================================================================
async function getDistrictCenterCoords(lat: number, lng: number): Promise<[string, number, number] | null> {
    const userAgent = process.env.NOMINATIM_USER_AGENT || 'ProtoMap/1.0';
    try {
        const revUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ru&zoom=18`;
        const revRes = await fetch(revUrl, { headers: { 'User-Agent': userAgent } });
        if (!revRes.ok) return null;

        const revData = await revRes.json() as any;
        if (!revData.address) return null;

        const addr = revData.address;

        const cityName = addr.city || addr.town || addr.village || addr.hamlet || addr.municipality || addr.county;
        const stateName = addr.state || addr.region || addr.province;
        const countryName = addr.country;

        const locationHierarchy = {
            microdistrict: addr.suburb || addr.neighbourhood || addr.residential,
            district: addr.city_district || addr.borough || addr.quarter,
            city: cityName,
            state: stateName,
            country: countryName
        };

        const attempts = [
            { level: 'Micro', q: locationHierarchy.microdistrict },
            { level: 'District', q: locationHierarchy.district },
            { level: 'City', q: locationHierarchy.city }
        ];

        for (const attempt of attempts) {
            if (!attempt.q) continue;

            const queryParts = [
                attempt.q,
                (attempt.level !== 'City' && attempt.q !== locationHierarchy.city) ? locationHierarchy.city : null,
                locationHierarchy.state,
                locationHierarchy.country
            ].filter(Boolean);

            const q = queryParts.join(', ');

            await new Promise(r => setTimeout(r, 1000));

            const searchUrl = `https://nominatim.openstreetmap.org/search?format=json&limit=1&accept-language=ru&q=${encodeURIComponent(q)}`;
            const searchRes = await fetch(searchUrl, { headers: { 'User-Agent': userAgent } });

            if (!searchRes.ok) continue;

            const searchData = await searchRes.json() as any[];
            if (searchData && searchData.length > 0) {
                return [attempt.q, parseFloat(searchData[0].lat), parseFloat(searchData[0].lon)];
            }
        }

        if (cityName) {
            // ✅ ИСПРАВЛЕНО: secureJitter вместо Math.random()
            const jitterLat = secureJitter(lat, 0.01);
            const jitterLng = secureJitter(lng, 0.01);
            return [cityName, jitterLat, jitterLng];
        }

        return null;
    } catch (e) {
        console.error("Geocoding Error:", e);
        return null;
    }
}

export const addOrUpdateLocation = onCall(async (request) => {
    if (request.app == undefined) {
        throw new HttpsError('failed-precondition', 'The function must be called from an App Check verified app.');
    }

    if (!request.auth) {
        throw new HttpsError('unauthenticated', 'Auth required.');
    }

    const uid = request.auth.uid;
    await assertNotBanned(request);

    const { lat, lng, isManual } = request.data;

    if (!lat || !lng || typeof lat !== 'number' || typeof lng !== 'number') {
        throw new HttpsError('invalid-argument', 'Invalid coordinates.');
    }

    const userRef = db.collection("users").doc(uid);
    const userDoc = await userRef.get();

    if (!userDoc.exists) {
        throw new HttpsError('not-found', 'User profile not found.');
    }

    const userData = userDoc.data()!;
    const lastUpdate = userData.last_location_update ? userData.last_location_update.toMillis() : 0;

    if (Date.now() - lastUpdate < 10000) {
        throw new HttpsError('resource-exhausted', 'Please wait 10 seconds before updating location.');
    }

    let finalLat = lat;
    let finalLng = lng;
    let cityName = "Unknown Location";

    if (isManual) {
        const userAgent = process.env.NOMINATIM_USER_AGENT || 'ProtoMap/1.0';
        const revUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ru&zoom=10`;

        try {
            const revRes = await fetch(revUrl, { headers: { 'User-Agent': userAgent } });
            if (revRes.ok) {
                const revData = await revRes.json() as any;
                const addr = revData.address;
                cityName = addr.city || addr.town || addr.village || addr.hamlet || addr.county || addr.state || "Custom Location";
            }
        } catch (e) {
            console.error("Manual geo lookup failed:", e);
        }
    } else {
        const place = await getDistrictCenterCoords(lat, lng);
        if (!place) {
            throw new HttpsError('internal', 'Geocoding failed. Try again.');
        }
        cityName = place[0];
        finalLat = place[1];
        finalLng = place[2];
    }

    const batch = db.batch();
    const locRef = db.collection("locations");
    const q = await locRef.where("user_id", "==", uid).limit(1).get();

    if (!q.empty) {
        batch.update(locRef.doc(q.docs[0].id), {
            latitude: finalLat,
            longitude: finalLng,
            city: cityName
        });
    } else {
        const newDoc = locRef.doc();
        batch.set(newDoc, {
            latitude: finalLat,
            longitude: finalLng,
            city: cityName,
            user_id: uid
        });
    }

    batch.update(userRef, { last_location_update: FieldValue.serverTimestamp() });

    await batch.commit();
    await clearMapCache();

    return {
        status: 'success',
        message: isManual ? 'Координаты установлены точно!' : 'Геолокация обновлена (Центр района).',
        foundCity: cityName,
        placeLat: finalLat,
        placeLng: finalLng
    };
});

export const getLocations = onRequest({ cors: false }, async (request, response) => {
    if (handleCors(request, response)) return;

    response.set('Cache-Control', 'public, max-age=300, s-maxage=600');

    const CACHE_DOC_REF = db.collection('system').doc('map_cache');
    const CACHE_DURATION_MS = 24 * 60 * 60 * 1000;

    try {
        const now = Date.now();

        const cacheSnap = await CACHE_DOC_REF.get();
        let cacheData = cacheSnap.exists ? cacheSnap.data() : null;

        if (cacheData && cacheData.updatedAt && (now - cacheData.updatedAt.toMillis() < CACHE_DURATION_MS)) {
            response.status(200).json({ data: JSON.parse(cacheData.payload) });
            return;
        }

        console.log("Cache expired or missing. Rebuilding map data...");

        const locSnap = await db.collection("locations").get();
        if (locSnap.empty) {
            response.status(200).json({ data: [] });
            return;
        }

        const userIds = [...new Set(locSnap.docs.map(d => d.data().user_id).filter(Boolean))];
        const usersMap = new Map();

        for (let i = 0; i < userIds.length; i += 30) {
            const chunk = userIds.slice(i, i + 30);
            const uSnap = await db.collection("users").where(admin.firestore.FieldPath.documentId(), "in", chunk).get();
            uSnap.forEach(doc => usersMap.set(doc.id, doc.data()));
        }

        const results = locSnap.docs.map(doc => {
            const loc = doc.data();
            const user = usersMap.get(loc.user_id);
            if (!user) return null;
            return {
                lat: loc.latitude,
                lng: loc.longitude,
                city: loc.city,
                user: {
                    uid: loc.user_id || null,           // [ЭТАП 3] UID для ссылок на профиль
                    username: user.username || "Unknown",
                    avatar_url: user.avatar_url || null,
                    status: user.status || null,
                    equipped_frame: user.equipped_frame || null
                }
            };
        }).filter(Boolean);

        await CACHE_DOC_REF.set({
            payload: JSON.stringify(results),
            updatedAt: FieldValue.serverTimestamp()
        });

        response.status(200).json({ data: results });

    } catch (e) {
        console.error("Map Error:", e);
        response.status(500).json({ error: "Error fetching map" });
    }
});

export const deleteLocation = onCall({ cors: ALLOWED_ORIGINS }, async (request) => {
    if (request.app == undefined) {
        throw new HttpsError('failed-precondition', 'The function must be called from an App Check verified app.');
    }
    if (!request.auth) throw new HttpsError('unauthenticated', 'Auth required.');

    const uid = request.auth.uid;
    await assertNotBanned(request);

    try {
        const q = await db.collection("locations").where("user_id", "==", uid).limit(1).get();
        if (!q.empty) {
            await q.docs[0].ref.delete();
            await clearMapCache();
            return { status: 'success', message: 'Метка удалена.' };
        }
        return { status: 'success', message: 'Метка не найдена.' };
    } catch (e) {
        throw new HttpsError('internal', 'Error deleting location.');
    }
});

export const updateProfileData = onCall(async (request) => {
    if (request.app == undefined) {
        throw new HttpsError('failed-precondition', 'The function must be called from an App Check verified app.');
    }
    if (!request.auth) throw new HttpsError("unauthenticated", "Auth required.");

    const uid = request.auth.uid;
    await assertNotBanned(request);

    const data = request.data;
    const fields: any = {};

    if (typeof data.status === 'string') fields.status = data.status.trim().substring(0, 100);
    if (typeof data.about_me === 'string') fields.about_me = data.about_me.trim();

    if (typeof data.about_me === 'string') {
        fields.about_me = data.about_me.trim().substring(0, 500);
    }

    if (data.socials) {
        const ALLOWED_SOCIALS = ['telegram', 'discord', 'vk', 'twitter', 'website'];

        for (const [k, v] of Object.entries(data.socials)) {
            if (!ALLOWED_SOCIALS.includes(k)) {
                throw new HttpsError('invalid-argument', `Unknown social: ${k}`);
            }

            if (typeof v !== 'string') {
                throw new HttpsError('invalid-argument', `${k} must be string`);
            }

            const val = (v as string).trim();
            if (val) {
                fields[`socials.${k}`] = val.substring(0, 200);
            } else {
                fields[`socials.${k}`] = FieldValue.delete();
            }
        }
    }

    if (Object.keys(fields).length === 0) return { message: "Нет изменений." };

    try {
        await db.collection('users').doc(uid).update(fields);
        if (fields.status) {
            await clearMapCache();
        }
        return { message: "Профиль обновлен!" };
    } catch (e) {
        throw new HttpsError("internal", "Save error.");
    }
});

export const uploadAvatar = onCall({ secrets: ["CLOUDINARY_CLOUD_NAME", "CLOUDINARY_API_KEY", "CLOUDINARY_API_SECRET"] }, async (request) => {
    if (request.app == undefined) {
        throw new HttpsError('failed-precondition', 'The function must be called from an App Check verified app.');
    }
    if (!request.auth) throw new HttpsError("unauthenticated", "Auth required.");

    const uid = request.auth.uid;
    await assertNotBanned(request);

    const { imageBase64 } = request.data;
    if (!imageBase64?.startsWith('data:image/')) throw new HttpsError("invalid-argument", "Bad image.");

    // ✅ ИСПРАВЛЕНО: Безопасное логирование секретов
    const cloudName = process.env.CLOUDINARY_CLOUD_NAME;
    const apiKey = process.env.CLOUDINARY_API_KEY;
    const apiSecret = process.env.CLOUDINARY_API_SECRET;

    if (!cloudName || !apiKey || !apiSecret) {
        console.error("Cloudinary credentials missing");
        throw new HttpsError('internal', 'Service configuration error');
    }

    console.log("Cloudinary configured:", {
        cloudName: !!cloudName,
        apiKey: !!apiKey
        // ❌ НЕ ЛОГИРУЕМ apiSecret!
    });

    cloudinary.config({
        cloud_name: cloudName,
        api_key: apiKey,
        api_secret: apiSecret,
        secure: true,
    });

    try {
        const res = await cloudinary.uploader.upload(imageBase64, {
            folder: "protomap_avatars", public_id: uid, overwrite: true,
            format: "webp", transformation: [{ width: 256, height: 256, crop: "fill", gravity: "face" }]
        });
        await db.collection('users').doc(uid).update({ avatar_url: res.secure_url });
        await clearMapCache();
        return { avatarUrl: res.secure_url };
    } catch (e) {
        throw new HttpsError("internal", "Upload failed.");
    }
});

function escapeMarkdownV2(text: string): string {
    const sourceText = String(text || '');
    const charsToEscape = ['_', '*', '[', ']', '(', ')', '~', '`', '>', '#', '+', '-', '=', '|', '{', '}', '.', '!'];
    let escapedText = sourceText;
    for (const char of charsToEscape) {
        escapedText = escapedText.replace(new RegExp('\\' + char, 'g'), '\\' + char);
    }
    return escapedText;
}

interface ReportData {
    type: 'comment' | 'profile';
    reportedContentId: string;
    profileOwnerUid: string;
    reason: string;
    reportedUsername?: string;
    reporterUsername?: string;
    profileOwnerUsername?: string;
}

export const reportContent = onCall(
    { secrets: ["TELEGRAM_BOT_TOKEN", "TELEGRAM_CHAT_ID"] },
    async (request) => {
        if (request.app == undefined) {
        throw new HttpsError('failed-precondition', 'The function must be called from an App Check verified app.');
        }
        if (!request.auth) {
            throw new HttpsError("unauthenticated", "Auth required.");
        }

        await assertNotBanned(request);

        const reporterUid = request.auth.uid;

        const {
            type,
            reportedContentId,
            profileOwnerUid,
            reason,
            reportedUsername,
            reporterUsername,
            profileOwnerUsername
        } = request.data as ReportData;

        if (!type || !reportedContentId || !profileOwnerUid || !reason) {
            throw new HttpsError("invalid-argument", "Missing data.");
        }

        try {
            let reportedContentText = '';

            if (type === 'comment') {
                const commentDoc = await db.collection('users')
                    .doc(profileOwnerUid)
                    .collection('comments')
                    .doc(reportedContentId)
                    .get();

                if (commentDoc.exists) {
                    reportedContentText = commentDoc.data()?.text || '';
                }
            }

            await db.collection('reports').add({
                type,
                reportedContentId,
                profileOwnerUid,
                reporterUid,
                reason,
                reportedUsername: reportedUsername || null,
                reporterUsername: reporterUsername || null,
                profileOwnerUsername: profileOwnerUsername || null,
                reportedContentText: reportedContentText || null,
                status: 'new',
                createdAt: FieldValue.serverTimestamp()
            });

            const botToken = process.env.TELEGRAM_BOT_TOKEN;
            const chatId = process.env.TELEGRAM_CHAT_ID;

            if (botToken && chatId) {
                const baseUrl = "https://proto-map.vercel.app/profile/";

                const reporterLink = reporterUsername
                    ? `[${escapeMarkdownV2(reporterUsername)}](${baseUrl}${escapeMarkdownV2(reporterUsername)})`
                    : `\`${reporterUid}\``;

                const reportedUserLink = reportedUsername
                    ? `[${escapeMarkdownV2(reportedUsername)}](${baseUrl}${escapeMarkdownV2(reportedUsername)})`
                    : `\`UID: ${reportedContentId}\``;

                const profileLink = profileOwnerUsername
                    ? `[${escapeMarkdownV2(profileOwnerUsername)}](${baseUrl}${escapeMarkdownV2(profileOwnerUsername)})`
                    : `\`${profileOwnerUid}\``;

                let message = `🚨 *НОВЫЙ РЕПОРТ* 🚨\n\n`;
                message += `*От кого:* ${reporterLink}\n`;
                message += `*Причина:* ${escapeMarkdownV2(reason)}\n\n`;

                if (type === 'profile') {
                    message += `👉 *Жалоба на профиль:* ${reportedUserLink}`;
                } else {
                    message += `👉 *Жалоба на комментарий пользователя* ${reportedUserLink}\n`;
                    message += `📍 *В профиле:* ${profileLink}\n`;

                    if (reportedContentText) {
                        message += `\n*Текст комментария:*\n\`\`\`\n${escapeMarkdownV2(reportedContentText)}\n\`\`\``;
                    } else {
                        message += `\n_(Текст комментария не найден или удален)_`;
                    }
                }

                await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: message,
                        parse_mode: 'MarkdownV2',
                        disable_web_page_preview: true
                    })
                });
            }

            return { success: true, message: "Ваша жалоба отправлена." };

        } catch (error) {
            console.error("Report error:", error);
            throw new HttpsError("internal", "Ошибка сервера при отправке жалобы.");
        }
    }
);


export const changeUsername = onCall(async (request) => {
    if (request.app == undefined) {
        throw new HttpsError('failed-precondition', 'App Check required.');
    }
    if (!request.auth) throw new HttpsError('unauthenticated', 'Auth required.');

    const uid = request.auth.uid;
    await assertNotBanned(request);
    assertEmailVerified(request.auth);

    // [ЭТАП 5] Смена никнейма теперь обновляет ТОЛЬКО документ пользователя.
    // Комментарии и чат больше не нужно трогать — они хранят author_uid
    // и никнейм подтягивается динамически при загрузке.

    const { newUsername } = request.data;

    if (!newUsername || typeof newUsername !== 'string') {
        throw new HttpsError('invalid-argument', 'Никнейм не указан.');
    }

    const trimmed = newUsername.trim();

    if (trimmed.length < 4 || trimmed.length > 20) {
        throw new HttpsError('invalid-argument', 'Никнейм должен быть от 4 до 20 символов.');
    }

    if (!/^[a-zA-Z0-9_]+$/.test(trimmed)) {
        throw new HttpsError('invalid-argument', 'Никнейм может содержать только латинские буквы, цифры и _');
    }

    const lowerName = trimmed.toLowerCase();
    const forbiddenWords = ['admin', 'moderator', 'system', 'root', 'support', 'protomap', 'owner', 'dev', 'bot'];
    if (forbiddenWords.some(word => lowerName.includes(word))) {
        throw new HttpsError('invalid-argument', 'Это имя зарезервировано системой.');
    }

    const userRef = db.collection('users').doc(uid);

    try {
        await db.runTransaction(async (t) => {
            const userDoc = await t.get(userRef);
            if (!userDoc.exists) throw new HttpsError('not-found', 'Пользователь не найден.');

            const userData = userDoc.data()!;

            // Rate limit: не чаще раза в 30 дней
            const lastChange = userData.last_username_change
                ? userData.last_username_change.toDate().getTime()
                : 0;
            const daysSinceLastChange = (Date.now() - lastChange) / (1000 * 60 * 60 * 24);

            if (lastChange > 0 && daysSinceLastChange < 30) {
                const daysLeft = Math.ceil(30 - daysSinceLastChange);
                throw new HttpsError(
                    'resource-exhausted',
                    `Никнейм можно менять раз в 30 дней. Осталось: ${daysLeft} дн.`
                );
            }

            // Проверяем уникальность
            const existing = await db.collection('users')
                .where('username', '==', trimmed)
                .limit(1)
                .get();

            if (!existing.empty && existing.docs[0].id !== uid) {
                throw new HttpsError('already-exists', 'Этот никнейм уже занят.');
            }

            // ✅ Обновляем ТОЛЬКО один документ
            t.update(userRef, {
                username: trimmed,
                last_username_change: FieldValue.serverTimestamp()
            });
        });

        // Инвалидируем кэш карты (никнейм отображается на маркерах)
        await clearMapCache();

        return { status: 'success', message: `Никнейм изменён на "${trimmed}"` };

    } catch (error: any) {
        if (error instanceof HttpsError) throw error;
        throw new HttpsError('internal', 'Ошибка смены никнейма.');
    }
});

export const deleteAccount = onCall(async (request) => {
    if (request.app == undefined) {
        throw new HttpsError('failed-precondition', 'The function must be called from an App Check verified app.');
    }
    if (!request.auth) throw new HttpsError('unauthenticated', 'Auth required.');
    const uid = request.auth.uid;

    // ✅ [ЭТАП 1] Вспомогательная функция: commit батча и вернуть новый
    async function commitAndRenew(batch: FirebaseFirestore.WriteBatch): Promise<FirebaseFirestore.WriteBatch> {
        await batch.commit();
        return db.batch();
    }

    try {
        let batch = db.batch();
        let opCount = 0;
        const BATCH_LIMIT = 400; // Безопасный лимит (макс 500 у Firestore)

        // Анонимизируем комментарии автора (может быть много)
        const comments = await db.collectionGroup('comments').where('author_uid', '==', uid).get();
        for (const d of comments.docs) {
            batch.update(d.ref, { author_username: 'Deleted', author_avatar_url: null, author_uid: null });
            opCount++;
            if (opCount >= BATCH_LIMIT) {
                batch = await commitAndRenew(batch);
                opCount = 0;
            }
        }

        // Анонимизируем сообщения в глобальном чате
        const msgs = await db.collection('global_chat').where('author_uid', '==', uid).get();
        for (const d of msgs.docs) {
            batch.update(d.ref, { author_username: 'Deleted', author_avatar_url: null, author_uid: null });
            opCount++;
            if (opCount >= BATCH_LIMIT) {
                batch = await commitAndRenew(batch);
                opCount = 0;
            }
        }

        // Финальный commit если остались незакоммиченные операции
        if (opCount > 0) {
            await batch.commit();
        }

        // Удаляем документ пользователя
        await db.collection('users').doc(uid).delete();

        // Удаляем метки на карте (обычно 1 документ)
        const locs = await db.collection('locations').where('user_id', '==', uid).get();
        await Promise.all(locs.docs.map(d => d.ref.delete()));

        await clearMapCache();

        await admin.auth().deleteUser(uid);
        return { status: 'success', message: 'Аккаунт удален.' };
    } catch (e) {
        throw new HttpsError('internal', 'Delete error.');
    }
});
</file>

</files>
